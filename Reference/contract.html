<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Freelancer Contracts | Cochran Films</title>

  <!-- Meta SEO -->
  <meta name="description" content="Access and sign your freelancer contract with Cochran Films. Secure, easy-to-use contract portal for approved creative collaborators." />
  <meta name="keywords" content="Cochran Films, Freelancer Contract, Sign Contract Online, Media Production Contractor, Creative Job Agreement, Freelance Videographer Contract, Onboarding, Contractor Portal" />
  <meta name="author" content="Cochran Films" />

  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="Freelancer Contract Portal | Cochran Films" />
  <meta property="og:description" content="Freelancers and creatives working with Cochran Films can securely access and sign their official contracts here." />
  <meta property="og:image" content="https://static.wixstatic.com/media/aeef42_6176e450dd04427abe0bccd0a26e887e~mv2.jpg" />
  <meta property="og:url" content="https://collaborate.cochranfilms.com" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Freelancer Contract Portal | Cochran Films" />
  <meta name="twitter:description" content="Freelancers and creatives working with Cochran Films can securely access and sign their official contracts here." />
  <meta name="twitter:image" content="https://static.wixstatic.com/media/aeef42_6176e450dd04427abe0bccd0a26e887e~mv2.jpg" />

  <!-- Favicon -->
      <link rel="icon" href="https://static.wixstatic.com/media/aeef42_570164eee75f4394a4fc1cf9c62ceae0~mv2.png" type="image/png" />

  <!-- Schema Markup -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Freelancer Contracts | Cochran Films",
    "description": "Access and sign your freelancer contract with Cochran Films. Secure, easy-to-use contract portal for approved creative collaborators.",
    "url": "https://collaborate.cochranfilms.com",
    "publisher": {
      "@type": "Organization",
      "name": "Cochran Films",
      "url": "https://www.cochranfilms.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://static.wixstatic.com/media/aeef42_6176e450dd04427abe0bccd0a26e887e~mv2.jpg"
      }
    }
  }
  </script>

    <!-- Fonts -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Project Firebase config + Firestore Data Manager -->
    <script src="/firebase-config.js"></script>
    <script>window.PUBLIC_READ_ONLY = true;</script>
    <script src="/firestore-data-manager.js"></script>
    <script src="/storage-utils.js"></script>
    
    <style>
        :root {
            --primary: #FFB200;
            --primary-dark: #FF9000;
            --gold: #FFD700;
            --black: #000000;
            --white: #ffffff;
            --gray-light: #f8f9fa;
            --gray-medium: #6c757d;
            --gray-dark: #343a40;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FFB200, #22c55e);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FF8C00, #16a34a);
        }

        /* Fix browser autofill styling */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #0a0a0a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Login Screen Styles */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .login-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(255,178,0,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .container {
            background: rgba(0, 0, 0, 0.8);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.5),
                0 0 0 1px rgba(255,178,0,0.2);
            text-align: center;
            max-width: 450px;
            width: 100%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,178,0,0.3);
            position: relative;
            z-index: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Expanded state for contract view */
        .login-screen.expanded {
            align-items: flex-start;
            padding: 2rem 1rem;
        }
        
        .container.expanded {
            max-width: 1200px;
            width: 100%;
            margin-top: 2rem;
        }
        
        /* Ensure login elements are COMPLETELY hidden when expanded */
        .container.expanded .login-elements,
        .login-screen.expanded .login-elements {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        .logo {
            margin-bottom: 2rem;
        }
        
        .logo img {
            width: 140px;
            height: auto;
            filter: 
                drop-shadow(0 0 3px #FFB200)
                drop-shadow(0 0 6px #FFB200)
                drop-shadow(2px 2px 0px #000000);
            animation: logoGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes logoGlow {
            0% {
                filter: 
                    drop-shadow(0 0 3px #FFB200)
                    drop-shadow(0 0 6px #FFB200)
                    drop-shadow(2px 2px 0px #000000);
            }
            100% {
                filter: 
                    drop-shadow(0 0 5px #FFB200)
                    drop-shadow(0 0 8px #FFB200)
                    drop-shadow(2px 2px 0px #000000);
            }
        }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #FFB200;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(255,178,0,0.3);
        }
        
        .subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 2rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #FFB200;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            color: #fff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.6);
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
        }
        
        .btn {
            width: 100%;
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFB200;
            z-index: -1;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn:hover::before {
            transform: scaleX(1);
        }
        
        .btn:hover {
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,178,0,0.4);
        }
        
        .message {
            background: rgba(0, 0, 0, 0.8);
            padding: 2rem;
            border-radius: 16px;
            margin-top: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,178,0,0.2);
            position: relative;
            z-index: 2;
            text-align: left;
        }
        
        .message h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #FFB200;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(255,178,0,0.3);
        }
        
        .success {
            border-left: 4px solid #22c55e;
        }
        
        .error {
            border-left: 4px solid #ef4444;
        }
        
        .error h2 {
            color: #ef4444;
        }
        
        .contract-link {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            margin-right: 1rem;
            margin-top: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: inline-block;
            text-decoration: none;
        }
        
        .contract-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFB200;
            z-index: -1;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .contract-link:hover::before {
            transform: scaleX(1);
        }
        
        .contract-link:hover {
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,178,0,0.4);
        }
        
        .hidden {
            display: none;
        }
        
        /* Aggressively prevent ALL browser overlays and loading indicators */
        .login-form {
            position: relative;
        }
        
        .login-form::before,
        .login-form::after {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* Disable ALL browser form validation and autocomplete overlays */
        input:invalid,
        input:valid,
        input:focus,
        input:hover,
        input:active {
            box-shadow: none !important;
            outline: none !important;
        }
        
        /* Force disable any loading spinners or overlays */
        *::before,
        *::after {
            animation: none !important;
        }
        
        /* Prevent browser autocomplete overlays */
        input[type="text"],
        input[type="email"] {
            -webkit-appearance: none !important;
            appearance: none !important;
        }
        
        /* Kill any potential modal overlays or loading screens */
        body > .loading-overlay,
        body > .modal-overlay,
        body > .spinner-overlay {
            display: none !important;
        }
        
        /* Disable any potential loading states */
        body.loading,
        html.loading,
        *.loading {
            pointer-events: auto !important;
            opacity: 1 !important;
        }
        

        
        .login-header {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .security-note {
            background: rgba(255,178,0,0.1);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
            border: 1px solid rgba(255,178,0,0.3);
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }
        
        /* Login elements transition */
        .login-elements {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Hide login elements when contract is accessed */
        .login-elements.hidden {
            display: none !important;
            opacity: 0 !important;
            transform: translateY(-20px) !important;
            pointer-events: none !important;
            height: 0 !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
            visibility: hidden !important;
        }
        
        /* Success message starts hidden and fades in */
        .message.success {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .message.success:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Contract Details Styling */
        .contract-section {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 178, 0, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .contract-section:hover {
            border-color: #FFB200;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,178,0,0.2);
        }
        
        .contract-section h4 {
            color: var(--primary);
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-family: 'Cinzel', serif;
            font-weight: 600;
        }
        
        .project-info {
            background: rgba(255, 178, 0, 0.15);
            border: 1px solid rgba(255, 178, 0, 0.3);
        }
        
        .signature-section {
            background: rgba(255, 178, 0, 0.1);
            border: 2px solid rgba(255, 178, 0, 0.3);
        }
        
        .workflow-info {
            background: rgba(255,178,0,0.1);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,178,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .download-instructions {
            background: rgba(255, 178, 0, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255, 178, 0, 0.2);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .login-screen {
                padding: 1rem;
            }
            
            .container {
                padding: 2rem;
            }
            
            .container.expanded {
                padding: 1.5rem;
                margin-top: 1rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .message {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
            }
            
            .container.expanded {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .contract-section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="container" id="mainContainer">
            <div class="logo">
                <img src="https://static.wixstatic.com/media/aeef42_d31420a75a164d2cb4508bdd7d99ca88~mv2.png" alt="Cochran Films Logo">
            </div>
            
            <!-- Login Elements - will be hidden after access -->
            <div id="loginElements" class="login-elements">
                <h1><i class="fas fa-lock"></i> Contract Access</h1>
                <p class="subtitle">Enter your details to access your personalized contract if you've been approved to join our team.</p>
                
                <div id="contractForm" class="login-form">
                    <div class="form-group">
                        <label for="freelancerName"><i class="fas fa-user"></i> Full Name</label>
                        <input type="text" id="freelancerName" placeholder="Enter your full name" autocomplete="off" spellcheck="false">
                    </div>
                    
                    <div class="form-group">
                        <label for="freelancerEmail"><i class="fas fa-envelope"></i> Email Address</label>
                        <input type="email" id="freelancerEmail" placeholder="Enter your email address" autocomplete="off" spellcheck="false">
                    </div>
                    
                    <button type="button" class="btn" onclick="performAccessCheck()">
                        <i class="fas fa-search"></i> Verify Access
                    </button>
                </div>
                
                <div class="security-note">
                    <strong><i class="fas fa-shield-alt"></i> Security Note:</strong> This system verifies your identity against our approved freelancer database. Your information is secure and will not be stored.
                </div>
                

            </div>
            
            <div id="success-message" class="message success hidden">
                <!-- Contract Header -->
                <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(255, 178, 0, 0.3);">
                    <h1 style="font-family: 'Cinzel', serif; font-size: 2.2rem; color: #FFB200; margin-bottom: 0.5rem;">
                        <i class="fas fa-file-contract"></i> Your Freelance Contract
                    </h1>
                    <p style="color: rgba(255,255,255,0.8); font-size: 1.1rem; margin: 0;">
                        Cochran Films â€¢ Digital Agreement
                    </p>
                </div>
                
                <div class="workflow-info">
                    <h3 style="color: #22c55e; margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Access Granted!</h3>
                    <p><strong>Welcome to the Cochran Films team!</strong> Your contract is ready for review and signing.</p>
                    <p>Please review all contract details carefully before proceeding with digital signature.</p>
                </div>
                
                <!-- Contract Review Section -->
                <div id="contractReview">
                    <div class="contract-section" id="contractDetailsSection">
                        <h4><i class="fas fa-file-contract"></i> Contract Details</h4>
                        <div id="contractDetails">
                            <!-- Contract details will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Digital Signature Section -->
                    <div class="contract-section signature-section" id="signatureSection">
                        <h4><i class="fas fa-signature"></i> Digital Signature</h4>
                        
                        <div class="form-group">
                            <label for="digitalSignature"><i class="fas fa-pen"></i> Type your full name to sign the contract</label>
                            <input type="text" id="digitalSignature" placeholder="Enter your full name" style="font-family: cursive; font-size: 16px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="signatureDate"><i class="fas fa-calendar"></i> Signature Date</label>
                            <input type="date" id="signatureDate">
                        </div>
                        
                        <!-- Portal Password Section -->
                        <div id="portalPasswordSection" class="contract-section" style="background: rgba(255, 178, 0, 0.05); border: 1px solid rgba(255, 178, 0, 0.2); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
                            <h4 style="color: #FFB200; margin-bottom: 1rem;"><i class="fas fa-key"></i> Set Portal Password</h4>
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; font-size: 0.9rem;">
                                Create a password for your freelancer portal access. This will allow you to view your contracts, job details, and project timeline.
                            </p>
                            
                            <div class="form-group">
                                <label for="portalPassword"><i class="fas fa-lock"></i> Portal Password</label>
                                <input type="password" id="portalPassword" placeholder="Create a secure password" minlength="6">
                                <small style="color: rgba(255,255,255,0.6); font-size: 0.8rem; margin-top: 0.25rem; display: block;">
                                    Minimum 6 characters. This password will be sent to admin for account activation.
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword"><i class="fas fa-check-circle"></i> Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm your password">
                            </div>
                        </div>
                        
                        <button id="signContractBtn" class="btn" onclick="signContract()" disabled>
                            <i class="fas fa-signature"></i> Sign Contract
                        </button>
                        
                        <button id="downloadSignedBtn" class="contract-link" onclick="downloadSignedContract()" style="display: none;">
                            <i class="fas fa-download"></i> Download Signed Contract
                        </button>
                        
                        <button id="downloadPreviewBtn" class="contract-link" onclick="downloadContractPreview()" style="margin-left: 1rem;">
                            <i class="fas fa-eye"></i> Preview Contract PDF
                        </button>
                        
                        <div id="downloadInstructions" class="download-instructions" style="display: none;">
                            <strong><i class="fas fa-info-circle"></i> How to Download:</strong> Click the button above to open a print dialog. Choose "Save as PDF" as your destination instead of printing to a physical printer. This will save the signed contract to your computer.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contract Signed Successfully -->
            <div id="signed-message" class="success-screen" style="display: none;">
                <div class="success-icon">âœ…</div>
                <h2>Contract Signed Successfully!</h2>
                <p>Your contract has been digitally signed and is now legally binding.</p>
                
                <div style="text-align: left; margin: 2rem 0;">
                <div class="contract-section" style="background: rgba(34, 197, 94, 0.1); border-color: #22c55e;">
                    <h4 style="color: #22c55e;"><i class="fas fa-clipboard-check"></i> Next Steps</h4>
                        <ul style="list-style: none; padding: 0; color: rgba(255,255,255,0.9);">
                            <li style="margin-bottom: 0.5rem;">âœ… Your digital signature has been recorded</li>
                            <li style="margin-bottom: 0.5rem;">âœ… Contract data has been saved securely</li>
                            <li style="margin-bottom: 0.5rem;">âœ… You will receive a confirmation email shortly</li>
                            <li style="margin-bottom: 0.5rem;">âœ… Admin has been notified with your signed contract</li>
                            <li>ðŸ“‹ We have you scheduled for the job - thank you!</li>
                    </ul>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(34, 197, 94, 0.3);">
                        <h4 style="color: #22c55e; margin-bottom: 1rem;"><i class="fas fa-user-circle"></i> Access Your Portal</h4>
                        <p style="margin-bottom: 1rem; color: rgba(255,255,255,0.9);">
                            You can download your contract PDF directly to your device, or view it anytime in your personal freelancer portal along with job details and project timeline.
                        </p>
                        <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
                            <a href="https://collaborate.cochranfilms.com/user-portal.html" class="contract-link" style="margin: 0;">
                                <i class="fas fa-external-link-alt"></i> Open Creator Portal
                            </a>
                            <button onclick="downloadContractPDF(signedContractData)" class="contract-link" style="margin: 0;">
                                <i class="fas fa-download"></i> Download Contract PDF
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            
            <div id="error-message" class="message error hidden">
                <h2><i class="fas fa-exclamation-triangle"></i> Access Not Granted</h2>
                <p>We couldn't verify your access at this time. Please check your information and try again, or contact us if you believe this is an error.</p>
                <div class="workflow-info" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                    <p><strong>Common Issues:</strong></p>
                    <ul>
                        <li>Name spelling must match exactly as provided to us</li>
                        <li>Email address must match your application</li>
                        <li>You may not be in our approved freelancer database yet</li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>



    <!-- Using browser's built-in print-to-PDF instead of html2pdf.js -->
    <!-- EmailJS for sending notifications -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Approved users database - loaded from JSON file
        let approvedUsers = {};
        let currentFreelancerData = null; // Store current user's data for PDF generation
        let contractSigned = false; // Track if contract has been signed
        let signatureData = null; // Store signature information
        let signedContractData = null; // Store signed contract data for download
        let hasPreviouslySignedContract = false; // Allow multiple contracts by not hard-blocking
        
        // Firebase is initialized via firebase-config.js (single source)
        
        // EmailJS Configuration
        const EMAILJS_CONFIG = {
            publicKey: 'p4pF3OWvh-DXtae4c',
            serviceId: 'service_t11yvru',
            templateId: 'template_6izinct', // Admin notification template
            userTemplateId: 'template_user_confirm' // User confirmation template - UPDATE THIS IN EMAILJS
        };

        // Contract flow flags
        let requirePasswordForSignature = true; // Default: original apply flow requires setting a password

        // Resolve the primary job key from a user's jobs map when not explicitly set
        function resolvePrimaryJobKey(userLike){
            try {
                const jobs = (userLike && userLike.jobs) || {};
                const docPrimary = userLike && userLike.primaryJob;
                if (docPrimary && jobs[docPrimary]) return docPrimary;
                const keys = Object.keys(jobs || {});
                if (!keys.length) return null;
                // Prefer approved status
                const approvedKey = keys.find(k => (jobs[k] && (jobs[k].status === 'approved' || jobs[k].projectStatus === 'approved')));
                if (approvedKey) return approvedKey;
                // Prefer most recent assignedDate
                const dated = [...keys].sort((a,b)=>{
                    const da = Date.parse(jobs[a]?.assignedDate || jobs[a]?.date || '');
                    const db = Date.parse(jobs[b]?.assignedDate || jobs[b]?.date || '');
                    return (isNaN(db)?0:db) - (isNaN(da)?0:da);
                });
                return dated[0] || keys[0];
            } catch(_) { return userLike && userLike.primaryJob ? userLike.primaryJob : null; }
        }

        // Build a unique, descriptive contract filename for multi-job users
        function buildContractFileName(contractData){
            const clean = (s) => (s || '')
                .toString()
                .replace(/[^a-zA-Z0-9\s\-]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            const name = clean(contractData.freelancerName);
            const role = clean(contractData.role || getCurrentJobTitle());
            const id = (contractData.contractId || '').toString().trim();
            const base = [name, role, id].filter(Boolean).join(' - ');
            return `${base}.pdf`;
        }
        
        // Global GitHub configuration
        let GITHUB_CONFIG = {
            token: null,
            owner: 'cochranfilms',
            repo: 'cochran-job-listings',
            repoOwner: 'cochranfilms',
            repoName: 'cochran-job-listings',
            branch: 'main'
        };
        
        // Load GitHub configuration from server
        async function loadGitHubConfig() {
            try {
                const response = await fetch('/api/github/info');
                if (response.ok) {
                    const config = await response.json();
                    GITHUB_CONFIG = {
                        owner: config.owner || 'cochranfilms',
                        repo: config.repo || 'cochran-job-listings',
                        repoOwner: config.owner || 'cochranfilms',
                        repoName: config.repo || 'cochran-job-listings',
                        branch: config.branch || 'main'
                    };
                    console.log('âœ… GitHub configuration loaded successfully');
                    return config.tokenConfigured;
                } else {
                    console.warn('âš ï¸ Could not load GitHub config from server');
                    return false;
                }
            } catch (error) {
                console.warn('âš ï¸ Error loading GitHub config:', error);
                return false;
            }
        }
        
        function getGitHubToken() {
            // Token is handled server-side, client doesn't need it
            return 'server-handled';
        }
        
        function setGitHubToken(newToken) {
            localStorage.setItem('github_token', newToken);
            console.log('âœ… GitHub token updated securely');
        }
        

        
        // Initialize EmailJS and GitHub config
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof emailjs !== 'undefined') {
                emailjs.init(EMAILJS_CONFIG.publicKey);
                console.log('âœ… EmailJS initialized successfully');
            } else {
                console.warn('âš ï¸ EmailJS library not loaded');
            }
            
            // Load GitHub configuration
            await loadGitHubConfig();
        });
        
        // Update JSON file on GitHub via server API
        async function updateGitHubFile(filename, content, commitMessage, retryCount = 0) {
            try {
                console.log(`ðŸ”„ Updating ${filename} on GitHub via server... (attempt ${retryCount + 1})`);
                
                // First, get the current file to retrieve its SHA (required for updates)
                let currentSha = null;
                try {
                    console.log(`ðŸ” Getting current SHA for ${filename}...`);
                    const getResponse = await fetch(`/api/github/file/${filename}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const currentFile = await getResponse.json();
                        currentSha = currentFile.sha;
                        console.log(`âœ… Retrieved current SHA: ${currentSha.substring(0, 7)}`);
                    } else if (getResponse.status === 404) {
                        console.log(`ðŸ“„ File ${filename} doesn't exist yet, creating new file`);
                        // File doesn't exist, so we don't need SHA for creation
                    } else {
                        console.warn(`âš ï¸ Could not get current SHA for ${filename}, status: ${getResponse.status}`);
                    }
                } catch (shaError) {
                    console.warn(`âš ï¸ Error getting SHA for ${filename}:`, shaError);
                    // Continue without SHA - might be a new file
                }
                
                // Now update the file
                const requestBody = {
                    content: content,
                    message: commitMessage
                };
                
                // Include SHA if we have it (for existing files)
                if (currentSha) {
                    requestBody.sha = currentSha;
                    console.log(`ðŸ”— Including SHA in update request`);
                }
                
                const response = await fetch(`/api/github/file/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`âœ… File updated successfully:`, result.commit.sha);
                    return result;
                } else {
                    const error = await response.json();
                    throw new Error(`Server API error: ${error.error}`);
                }
            } catch (error) {
                console.error(`âŒ Error updating ${filename}:`, error);
                throw error;
            }
        }
        
        // ==================== PDF GENERATION & GITHUB UPLOAD ====================
        
        // Generate professional PDF contract content - FIXED VERSION WITH PROPER SPACING
        function generateContractPDF(contractData) {
            try {
                console.log('ðŸ“„ Starting PDF generation for contract:', contractData.contractId);
                
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const doc = new jsPDF();
                
                // ==================== HEADER ====================
                
                // Professional header with gold background
                doc.setFillColor(255, 178, 0);
                doc.rect(0, 0, 210, 25, 'F');
                
                // Company name and title in header
                doc.setFontSize(20);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS', 105, 12, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FREELANCE CONTRACT AGREEMENT', 105, 20, { align: 'center' });
                
                // ==================== CONTRACT METADATA ====================
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`Contract ID: ${contractData.contractId}`, 20, 35);
                doc.text(`Effective Date: ${contractData.effectiveDate}`, 20, 40);
                
                // ==================== CONTRACTOR INFORMATION ====================
                
                // Professional section header with background
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 50, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFORMATION', 105, 56, { align: 'center' });
                
                // Two separate info boxes for better organization
                // Left box - Contractor Info
                doc.setFillColor(248, 249, 250);
                doc.rect(20, 65, 80, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, 65, 80, 25, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFO', 25, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Name: ${contractData.freelancerName || 'Not specified'}`, 25, 78);
                doc.text(`Role: ${contractData.role || 'Not specified'}`, 25, 82);
                doc.text(`Location: ${contractData.location || 'Not specified'}`, 25, 86);
                
                // Right box - Project Details
                doc.setFillColor(248, 249, 250);
                doc.rect(110, 65, 80, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(110, 65, 80, 25, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('PROJECT DETAILS', 115, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Email: ${contractData.freelancerEmail || 'Not specified'}`, 115, 78);
                doc.text(`Start: ${contractData.projectStart || 'Not specified'}`, 115, 82);
                doc.text(`Rate: ${contractData.rate || 'Not specified'}`, 115, 86);
                
                // ==================== CONTRACT TERMS - FIXED SPACING ====================
                
                // Professional section header with background
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 100, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT TERMS & CONDITIONS', 105, 106, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                // Professional compact terms list - FIXED SPACING
                const compactTerms = [
                    'INDEPENDENT CONTRACTOR: Not an employee of\nCochran Films.',
                    'SERVICES: Provide professional services as specified.',
                    'COMPENSATION: Payment within 24 hours of completion.',
                    'STANDARDS: All work must meet Cochran Films quality.',
                    'ATTIRE: Professional attire (all black) required.',
                    'PUNCTUALITY: Arrive 15 minutes before start time.',
                    'DOCUMENTATION: Bring valid ID and signed contract.',
                    'EQUIPMENT: Use provided Cochran Films equipment.',
                    'CONDUCT: Maintain professional demeanor at all times.',
                    'SAFETY: Follow all safety protocols provided.',
                    'CONFIDENTIALITY: Respect project confidentiality.',
                    'BTS CONTENT: May freely take and share behind-the-scenes.',
                    'TAX OBLIGATIONS: Contractor responsible for personal taxes.',
                    'TRANSPORTATION: Contractor responsible for own transport.'
                ];
                
                // FIXED: Proper spacing to prevent text overlap
                let currentYPos = 120;
                const lineHeight = 10; // INCREASED from 6 to 10 for proper spacing
                
                // Process each term with TWO-COLUMN layout to save vertical space
                compactTerms.forEach((term, index) => {
                    // Split into two columns: left column (0-6) and right column (7-13)
                    const isLeftColumn = index < 7;
                    const columnIndex = isLeftColumn ? index : index - 7;
                    const xPos = isLeftColumn ? 20 : 110; // Left column at x=20, right column at x=110
                    const fixedYPos = 120 + (columnIndex * 8);
                    
                    // FIXED: Render each term with two-column layout and text wrapping
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    // Handle multi-line terms (like term #1)
                    if (term.includes('\n')) {
                        const lines = term.split('\n');
                        lines.forEach((line, lineIndex) => {
                            doc.text(line, xPos, fixedYPos + (lineIndex * 4));
                        });
                    } else {
                        doc.text(term, xPos, fixedYPos);
                    }
                });
                
                // Calculate signature position AFTER all terms are rendered (two-column layout)
                const maxColumnHeight = Math.ceil(compactTerms.length / 2) * 8; // Height of tallest column
                const lastTermY = 120 + maxColumnHeight;
                const signatureY = lastTermY + 20; // Add 20px spacing after last term
                
                // ==================== SIGNATURES ====================
                
                // Signature header with professional styling
                doc.setFillColor(255, 178, 0);
                doc.rect(20, signatureY - 5, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT SIGNATURES', 105, signatureY + 2, { align: 'center' });
                
                // Company signature (pre-signed) - Professional styling
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS (COMPANY)', 20, signatureY + 15);
                
                // Company signature box with professional border
                doc.setFillColor(248, 249, 250);
                doc.rect(20, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Authorized Signature:', 25, signatureY + 26);
                
                // CURSIVE SIGNATURE FOR CODY COCHRAN
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic'); // Use italic for cursive effect
                doc.text('Cody Cochran', 25, signatureY + 32);
                
                // Add signature line for authenticity
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(25, signatureY + 34, 85, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Title: Founder & CEO', 25, signatureY + 38);
                doc.text('Date: ' + contractData.effectiveDate, 25, signatureY + 42);
                
                // Contractor signature - Professional styling
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR SIGNATURE', 105, signatureY + 15);
                
                // Contractor signature box with professional border
                doc.setFillColor(248, 249, 250);
                doc.rect(105, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(105, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Contractor:', 115, signatureY + 26);
                
                // CURSIVE SIGNATURE FOR CONTRACTOR
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic'); // Use italic for cursive effect
                doc.text(contractData.freelancerName || 'Contractor Name', 115, signatureY + 32);
                
                // Add signature line for authenticity
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(115, signatureY + 34, 175, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Signature: ' + contractData.signature, 115, signatureY + 38);
                doc.text('Date: ' + contractData.signatureDate, 115, signatureY + 42);
                
                // ==================== PROFESSIONAL LEGAL FOOTER ====================
                
                // Footer - positioned with proper spacing to fit in container
                const footerY = 260; // MOVED DOWN from 240 to 260 to avoid overlapping signature boxes
                
                doc.setFillColor(248, 249, 250);
                doc.rect(20, footerY - 5, 170, 20, 'F'); // Increased height to 20mm
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.3);
                doc.rect(20, footerY - 5, 170, 20, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('This contract was digitally signed and is legally binding under Georgia law.', 105, footerY + 3, { align: 'center' });
                doc.text('Generated by Cochran Films Contract Portal â€¢ ' + new Date().toLocaleDateString(), 105, footerY + 8, { align: 'center' });
                doc.text('Contract ID: ' + contractData.contractId, 105, footerY + 13, { align: 'center' });
                
                return doc;
            } catch (error) {
                console.error('âŒ Error generating PDF:', error);
                throw error;
            }
        }
        
        // Advanced PDF generation with FIXED text handling
        function generateAdvancedContractPDF(contractData) {
            try {
                console.log('ðŸ“„ Starting advanced PDF generation for contract:', contractData.contractId);
                
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const doc = new jsPDF();
                
                // ==================== ADVANCED HEADER ====================
                
                // Professional header with gradient effect
                doc.setFillColor(255, 178, 0);
                doc.rect(0, 0, 210, 25, 'F');
                
                // Company name and title with better typography
                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS', 105, 12, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('FREELANCE CONTRACT AGREEMENT', 105, 20, { align: 'center' });
                
                // ==================== CONTRACT METADATA ====================
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`Contract ID: ${contractData.contractId}`, 20, 35);
                doc.text(`Effective Date: ${contractData.effectiveDate}`, 20, 40);
                
                // ==================== CONTRACTOR INFORMATION ====================
                
                // Professional section header
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 50, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFORMATION', 105, 56, { align: 'center' });
                
                // Two separate info boxes with better spacing
                // Left box - Contractor Info
                doc.setFillColor(248, 249, 250);
                doc.rect(20, 65, 80, 30, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, 65, 80, 30, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFO', 25, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Name: ${contractData.freelancerName || 'Not specified'}`, 25, 78);
                doc.text(`Role: ${contractData.role || 'Not specified'}`, 25, 82);
                doc.text(`Location: ${contractData.location || 'Not specified'}`, 25, 86);
                doc.text(`Email: ${contractData.freelancerEmail || 'Not specified'}`, 25, 90);
                
                // Right box - Project Details
                doc.setFillColor(248, 249, 250);
                doc.rect(110, 65, 80, 30, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(110, 65, 80, 30, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('PROJECT DETAILS', 115, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Start: ${contractData.projectStart || 'Not specified'}`, 115, 78);
                doc.text(`Rate: ${contractData.rate || 'Not specified'}`, 115, 82);
                doc.text(`Date: ${contractData.effectiveDate}`, 115, 86);
                doc.text(`Status: Active`, 115, 90);
                
                // ==================== ADVANCED CONTRACT TERMS - FIXED ====================
                
                // Professional section header
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 105, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT TERMS & CONDITIONS', 105, 111, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                // Compact terms for single page - FIXED SPACING
                const compactTerms = [
                    '1. INDEPENDENT CONTRACTOR: Not an employee of Cochran Films.',
                    '2. SERVICES: Provide professional services as specified.',
                    '3. COMPENSATION: Payment within 24 hours of completion.',
                    '4. STANDARDS: All work must meet Cochran Films quality.',
                    '5. ATTIRE: Professional attire (all black) required.',
                    '6. PUNCTUALITY: Arrive 15 minutes before start time.',
                    '7. DOCUMENTATION: Bring valid ID and signed contract.',
                    '8. EQUIPMENT: Use provided Cochran Films equipment.',
                    '9. CONDUCT: Maintain professional demeanor at all times.',
                    '10. SAFETY: Follow all safety protocols provided.',
                    '11. CONFIDENTIALITY: Respect project confidentiality.',
                    '12. BTS CONTENT: May freely take and share behind-the-scenes.',
                    '13. TAX OBLIGATIONS: Contractor responsible for personal taxes.',
                    '14. TRANSPORTATION: Contractor responsible for own transport.'
                ];
                
                // FIXED: Proper spacing to prevent text overlap
                let currentYPos = 125;
                const lineHeight = 10; // INCREASED from 6 to 10 for proper spacing
                
                // Process each term with TWO-COLUMN layout to save vertical space
                compactTerms.forEach((term, index) => {
                    // Split into two columns: left column (0-6) and right column (7-13)
                    const isLeftColumn = index < 7;
                    const columnIndex = isLeftColumn ? index : index - 7;
                    const xPos = isLeftColumn ? 20 : 110; // Left column at x=20, right column at x=110
                    const fixedYPos = 125 + (columnIndex * 8);
                    
                    // FIXED: Render each term with two-column layout and text wrapping
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    // Handle multi-line terms (like term #1)
                    if (term.includes('\n')) {
                        const lines = term.split('\n');
                        lines.forEach((line, lineIndex) => {
                            doc.text(line, xPos, fixedYPos + (lineIndex * 4));
                        });
                    } else {
                        doc.text(term, xPos, fixedYPos);
                    }
                });
                
                // ==================== ADVANCED SIGNATURES ====================
                
                // Calculate signature position AFTER all terms are rendered (two-column layout)
                const maxColumnHeight = Math.ceil(compactTerms.length / 2) * 8; // Height of tallest column
                const lastTermY = 125 + maxColumnHeight;
                const signatureY = lastTermY + 20; // Add 20px spacing after last term
                
                // Signature header
                doc.setFillColor(255, 178, 0);
                doc.rect(20, signatureY - 5, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT SIGNATURES', 105, signatureY + 2, { align: 'center' });
                
                // Company signature
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS (COMPANY)', 20, signatureY + 15);
                
                doc.setFillColor(248, 249, 250);
                doc.rect(20, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Authorized Signature:', 25, signatureY + 26);
                
                // CURSIVE SIGNATURE FOR CODY COCHRAN
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic'); // Use italic for cursive effect
                doc.text('Cody Cochran', 25, signatureY + 32);
                
                // Add signature line for authenticity
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(25, signatureY + 34, 85, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Title: Founder & CEO', 25, signatureY + 38);
                doc.text('Date: ' + contractData.effectiveDate, 25, signatureY + 42);
                
                // Contractor signature
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR SIGNATURE', 105, signatureY + 15);
                
                doc.setFillColor(248, 249, 250);
                doc.rect(105, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(105, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Contractor:', 115, signatureY + 26);
                
                // CURSIVE SIGNATURE FOR CONTRACTOR
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic'); // Use italic for cursive effect
                doc.text(contractData.freelancerName || 'Contractor Name', 115, signatureY + 32);
                
                // Add signature line for authenticity
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(115, signatureY + 34, 175, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Signature: ' + contractData.signature, 115, signatureY + 38);
                doc.text('Date: ' + contractData.signatureDate, 115, signatureY + 42);
                
                // Footer - positioned with proper spacing to fit in container
                const footerY = 260; // MOVED DOWN from 240 to 260 to avoid overlapping signature boxes
                
                doc.setFillColor(248, 249, 250);
                doc.rect(20, footerY - 5, 170, 20, 'F'); // Increased height to 20mm
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.3);
                doc.rect(20, footerY - 5, 170, 20, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('This contract was digitally signed and is legally binding under Georgia law.', 105, footerY + 3, { align: 'center' });
                doc.text('Generated by Cochran Films Contract Portal â€¢ ' + new Date().toLocaleDateString(), 105, footerY + 8, { align: 'center' });
                doc.text('Contract ID: ' + contractData.contractId, 105, footerY + 13, { align: 'center' });
                
                return doc;
            } catch (error) {
                console.error('âŒ Error generating advanced PDF:', error);
                throw error;
            }
        }
        
        // Upload PDF to Firestore Storage organized by user name
        async function uploadPDFToFirestoreStorage(contractData) {
            try {
                console.log('ðŸ“„ Generating PDF for contract:', contractData.contractId);
                
                // Generate PDF using HTML-based method for maximum styling control
                let doc;
                try {
                    doc = generateHTMLBasedPDF(contractData);
                } catch (htmlError) {
                    console.warn('âš ï¸ HTML-based PDF generation failed, trying advanced method:', htmlError);
                    try {
                        doc = generateAdvancedContractPDF(contractData);
                    } catch (advancedError) {
                        console.warn('âš ï¸ Advanced PDF generation failed, falling back to standard method:', advancedError);
                        doc = generateContractPDF(contractData);
                    }
                }
                
                // Convert PDF to blob for Firestore Storage
                const pdfBlob = doc.output('blob');
                
                console.log('ðŸ“¤ Uploading PDF to Firestore Storage...');
                
                // Try multiple upload methods to handle CORS issues
                let uploadResult = null;
                
                // Method 1: Try StorageUtils (preferred)
                try {
                    if (window.StorageUtils) {
                        const storageUtils = window.StorageUtils;
                        const fileName = buildContractFileName(contractData);
                        
                        uploadResult = await storageUtils.uploadFile(pdfBlob, {
                            ownerEmail: contractData.freelancerEmail,
                            folder: 'contracts',
                            filename: fileName,
                            contentType: 'application/pdf'
                        });
                        
                        console.log(`âœ… PDF uploaded via StorageUtils:`, uploadResult.downloadURL);
                    }
                } catch (storageError) {
                    console.warn('âš ï¸ StorageUtils upload failed (CORS issue):', storageError);
                    uploadResult = null;
                }
                
                // Method 2: Try direct Firebase Storage upload with retry
                if (!uploadResult) {
                    try {
                        await window.FirebaseConfig.waitForInit();
                        const storage = firebase.storage();
                        const fileName = buildContractFileName(contractData);
                        const safeEmail = contractData.freelancerEmail.replace(/[^a-zA-Z0-9@._-]/g, '_');
                        const path = `contracts/${safeEmail}/${fileName}`;
                        
                        // Use put method with proper metadata
                        const ref = storage.ref().child(path);
                        const metadata = {
                            contentType: 'application/pdf',
                            customMetadata: {
                                'contractId': contractData.contractId,
                                'uploaderEmail': contractData.freelancerEmail,
                                'uploadSource': 'contract-signing'
                            }
                        };
                        
                        const snapshot = await ref.put(pdfBlob, metadata);
                        const downloadURL = await snapshot.ref.getDownloadURL();
                        
                        uploadResult = {
                            downloadURL: downloadURL,
                            path: path,
                            fullPath: snapshot.ref.fullPath
                        };
                        
                        console.log(`âœ… PDF uploaded via direct Firebase Storage:`, uploadResult.downloadURL);
                    } catch (firebaseError) {
                        console.warn('âš ï¸ Direct Firebase Storage upload failed:', firebaseError);
                        uploadResult = null;
                    }
                }
                
                // Method 3: Fallback - create a mock result for contract completion
                if (!uploadResult) {
                    console.warn('âš ï¸ All upload methods failed, creating fallback result');
                    const fileName = buildContractFileName(contractData);
                    uploadResult = {
                        downloadURL: null, // Will be handled by admin later
                        path: `contracts/${contractData.freelancerEmail}/${fileName}`,
                        uploadFailed: true,
                        error: 'CORS policy prevented automatic upload - admin will need to upload manually'
                    };
                }
                
                // Update uploaded contracts tracking
                const uploadedContract = {
                    contractId: contractData.contractId,
                    freelancerName: contractData.freelancerName,
                    freelancerEmail: contractData.freelancerEmail,
                    role: contractData.role,
                    rate: contractData.rate,
                    location: contractData.location,
                    fileName: buildContractFileName(contractData),
                    fileSize: pdfBlob.size,
                    uploadDate: new Date().toISOString(),
                    status: uploadResult.uploadFailed ? 'pending_upload' : 'uploaded',
                    fileUrl: uploadResult.downloadURL,
                    storagePath: uploadResult.path,
                    notes: uploadResult.uploadFailed ? 
                        'Upload failed due to CORS - admin manual upload required' : 
                        'Automatically uploaded via contract signing to Firestore Storage'
                };
                
                console.log('âœ… Contract upload processed (may need admin follow-up)');
                return uploadedContract;
                
            } catch (error) {
                console.error('âŒ Error in PDF upload process:', error);
                
                // Don't fail the contract signing - create fallback result
                const fileName = buildContractFileName(contractData);
                return {
                    contractId: contractData.contractId,
                    freelancerName: contractData.freelancerName,
                    freelancerEmail: contractData.freelancerEmail,
                    role: contractData.role,
                    rate: contractData.rate,
                    location: contractData.location,
                    fileName: fileName,
                    fileSize: 0,
                    uploadDate: new Date().toISOString(),
                    status: 'upload_failed',
                    fileUrl: null,
                    storagePath: `contracts/${contractData.freelancerEmail}/${fileName}`,
                    notes: `Upload failed: ${error.message} - admin manual upload required`,
                    error: error.message
                };
            }
        }
        
        // Generate PDF from HTML template for maximum styling control
        function generateHTMLBasedPDF(contractData) {
            try {
                console.log('ðŸ“„ Starting HTML-based PDF generation for contract:', contractData.contractId);
                
                // For now, fall back to the advanced PDF method since html2canvas has issues
                // We'll use the reliable advanced method that works well
                return generateAdvancedContractPDF(contractData);
                
            } catch (error) {
                console.error('âŒ Error in HTML-based PDF generation:', error);
                throw error;
            }
        }
        
        // Download PDF directly to user's device
        function downloadContractPDF(contractData) {
            try {
                console.log('ðŸ“„ Generating PDF for direct download...');
                
                // Check if contractData is available
                if (!contractData) {
                    console.error('âŒ No contract data available for download');
                    alert('âŒ No contract data available. Please sign the contract first.');
                    return;
                }
                
                // Generate PDF using the best available method
                let doc;
                try {
                    doc = generateHTMLBasedPDF(contractData);
                } catch (htmlError) {
                    console.warn('âš ï¸ HTML-based PDF generation failed, trying advanced method:', htmlError);
                    try {
                        doc = generateAdvancedContractPDF(contractData);
                    } catch (advancedError) {
                        console.warn('âš ï¸ Advanced PDF generation failed, falling back to standard method:', advancedError);
                        doc = generateContractPDF(contractData);
                    }
                }
                
                // Save PDF to user's device using user name instead of contract ID
                const safeFileName = buildContractFileName(contractData);
                doc.save(safeFileName);
                
                console.log('âœ… PDF downloaded successfully:', safeFileName);
                
                // Show success message
                setTimeout(() => {
                    const signedMessage = document.getElementById('signed-message');
                    if (signedMessage) {
                        const downloadStatus = document.createElement('div');
                        downloadStatus.style.cssText = 'margin-top: 15px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;';
                        downloadStatus.innerHTML = 'ðŸ“„ <strong>PDF Downloaded!</strong> Your contract has been saved to your device.';
                        signedMessage.appendChild(downloadStatus);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Error downloading PDF:', error);
                alert('âŒ There was an error downloading your contract. Please try again or contact support.');
            }
        }
        
        // Download contract preview PDF
        function downloadContractPreview() {
            if (!currentFreelancerData) {
                alert('âŒ Contract data not available. Please refresh and try again.');
                return;
            }
            
            // Create preview contract data
            const previewData = {
                contractId: 'PREVIEW-' + Date.now(),
                freelancerName: currentFreelancerData.name,
                freelancerEmail: currentFreelancerData.email,
                role: currentFreelancerData.role || 'Contractor',
                location: currentFreelancerData.location || 'Atlanta Area',
                projectStart: (currentFreelancerData.application?.eventDate || currentFreelancerData.jobs?.[currentFreelancerData.primaryJob]?.date || currentFreelancerData.projectStart) || 'TBD',
                rate: currentFreelancerData.rate || 'Not specified',
                effectiveDate: currentFreelancerData.approvedDate || new Date().toISOString().split('T')[0],
                signatureDate: new Date().toISOString().split('T')[0],
                signature: '[PREVIEW - NOT SIGNED]'
            };
            
            try {
                downloadContractPDF(previewData);
            } catch (error) {
                console.error('âŒ Error downloading preview PDF:', error);
                alert('âŒ There was an error generating the preview. Please try again.');
            }
        }
        
        // Download signed contract function
        async function downloadSignedContract() {
            try {
                console.log('ðŸ“„ Attempting to download signed contract...');
                
                if (!signedContractData) {
                    console.log('âŒ No signed contract data available');
                    alert('âŒ No signed contract data available. Please sign the contract first.');
                    return;
                }
                
                // Use the existing downloadContractPDF function with signed data
                downloadContractPDF(signedContractData);
                
            } catch (error) {
                console.error('âŒ Error downloading signed contract:', error);
                alert('âŒ There was an error downloading your signed contract. Please try again or contact support.');
            }
        }
        
        // Load users data from JSON file
        async function loadUsersData() {
            try {
                // Prefer Firestore single source of truth (only if DataManager is initialized)
                await window.FirebaseConfig.waitForInit();
                try {
                    if (window.FirestoreDataManager &&
                        typeof window.FirestoreDataManager.getUsers === 'function' &&
                        window.FirestoreDataManager.isInitialized === true) {
                        const fsUsers = await window.FirestoreDataManager.getUsers();
                        if (fsUsers && Object.keys(fsUsers).length > 0) {
                            approvedUsers = fsUsers;
                            console.log('âœ… Users data loaded from Firestore:', Object.keys(approvedUsers).length);
                            return;
                        }
                    } else {
                        throw new Error('FirestoreDataManager not initialized on PUBLIC_READ_ONLY page');
                    }
                } catch (fsErr) {
                    console.warn('âš ï¸ Firestore users load skipped/fallback:', fsErr?.message || fsErr);
                }

                // Fallback to JSON API
                const response = await fetch('/api/users');
                if (response.ok) {
                    const data = await response.json();
                    approvedUsers = data.users || {};
                    console.log('âœ… Users data loaded from API:', Object.keys(approvedUsers).length);
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            } catch (error) {
                console.error('âŒ Error loading users data:', error);
                console.log('ðŸ“‹ Using fallback users data for testing');
                // Fallback to hardcoded data if both Firestore and API fail
                approvedUsers = {
                    "Francisco Flores": {
                        email: "ciscocinema@gmail.com",
                        contractUrl: "contract.html",
                        role: "Backdrop Photographer",
                        location: "6695 Church Street, Douglasville, GA 30134",
                        projectStart: "November 8, 2025 at 3:15 PM",
                        rate: "$400.00 USD (Flat)",
                        approvedDate: "2025-11-08"
                    },
                    "Test User": {
                        email: "test@example.com",
                        contractUrl: "contract.html",
                        role: "Test Role",
                        location: "Test Location",
                        projectStart: "TBD",
                        rate: "$150/day",
                        approvedDate: "2025-01-01"
                    }
                };
            }
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any old local contract data from localStorage
            localStorage.removeItem('uploadedContracts');
            localStorage.removeItem('signedContracts');
            console.log('ðŸ§¹ Cleared old local contract data from localStorage');
            
            loadUsersData();
            
            // Ensure main containers are visible on page load
            const loginScreen = document.getElementById('loginScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loginScreen) {
                loginScreen.style.display = 'flex';
                loginScreen.style.visibility = 'visible';
                console.log('âœ… Login screen initialized as visible');
            }
            
            if (mainContainer) {
                mainContainer.style.display = 'block';
                mainContainer.style.visibility = 'visible';
                console.log('âœ… Main container initialized as visible');
            }
            
            // Ensure form inputs are ready for user interaction
            const nameInput = document.getElementById('freelancerName');
            const emailInput = document.getElementById('freelancerEmail');
            const contractForm = document.getElementById('contractForm');
            
            if (contractForm) {
                contractForm.style.pointerEvents = 'auto';
                contractForm.style.display = 'block';
                contractForm.style.visibility = 'visible';
                console.log('âœ… Contract form initialized as interactive');
            }
            
            if (nameInput) {
                nameInput.disabled = false;
                nameInput.style.pointerEvents = 'auto';
                nameInput.readOnly = false;
                console.log('âœ… Name input enabled');
            }
            
            if (emailInput) {
                emailInput.disabled = false;
                emailInput.style.pointerEvents = 'auto';
                emailInput.readOnly = false;
                console.log('âœ… Email input enabled');
            }
            
            // Aggressively disable any browser loading overlays (but not main containers)
            forceClearLoadingStates();
            
            // Prevent ANY form submission or navigation
            preventAllNavigation();
        });
        
        // Prevent form submission but allow normal page navigation
        function preventAllNavigation() {
            // Catch any form submission attempts
            document.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸš« Blocked form submission attempt');
                return false;
            }, true);
            
            // Override form submission methods globally
            const originalSubmit = HTMLFormElement.prototype.submit;
            HTMLFormElement.prototype.submit = function() {
                console.log('ðŸš« Blocked programmatic form submission');
                return false;
            };
            
            // Note: Removed beforeunload prevention to allow normal page refresh
            console.log('âœ… Form submission blocked, but page navigation allowed');
        }
        
        // Force clear any loading states or overlays
        function forceClearLoadingStates() {
            // Remove any potential loading classes from document
            document.body.classList.remove('loading', 'spinner', 'overlay');
            document.documentElement.classList.remove('loading', 'spinner', 'overlay');
            
            // Hide any potential loading overlays (but NEVER main containers)
            const potentialOverlays = document.querySelectorAll('.loading, .spinner, .overlay, .modal, [class*="loading"], [class*="spinner"]');
            potentialOverlays.forEach(el => {
                // Never hide main containers or login screen
                if (el && 
                    !el.classList.contains('login-screen') && 
                    el.id !== 'loginScreen' && 
                    el.id !== 'mainContainer' &&
                    !el.closest('#loginScreen') &&
                    !el.closest('#mainContainer')) {
                    el.style.display = 'none';
                    el.style.visibility = 'hidden';
                    el.style.opacity = '0';
                }
            });
            
            // ALSO check for any duplicate/stuck login form elements (not main container)
            const stuckLoginElements = document.querySelectorAll('.login-elements:not(.hidden)');
            if (stuckLoginElements.length > 1) {
                console.log('ðŸš¨ Found multiple visible login form elements, hiding extras:', stuckLoginElements.length);
                stuckLoginElements.forEach((el, index) => {
                    // Never hide the main containers or the active form
                    if (!el.classList.contains('login-screen') && 
                        el.id !== 'loginScreen' && 
                        el.id !== 'mainContainer' &&
                        el.id !== 'contractForm' && 
                        el.id !== 'loginElements') {
                        if (index > 0) { // Keep only the first one
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            console.log('ðŸ”¨ Hidden duplicate login form element:', index);
                        }
                    }
                });
            }
            
            // Clear any loading states on form container and ensure inputs are enabled
            const formContainer = document.getElementById('contractForm');
            if (formContainer) {
                formContainer.classList.remove('loading', 'processing', 'submitting');
                formContainer.style.pointerEvents = 'auto';
                formContainer.style.display = 'block';
                formContainer.style.visibility = 'visible';
                
                // Ensure input fields are enabled and interactive
                const nameInput = document.getElementById('freelancerName');
                const emailInput = document.getElementById('freelancerEmail');
                
                if (nameInput) {
                    nameInput.disabled = false;
                    nameInput.style.pointerEvents = 'auto';
                    nameInput.style.opacity = '1';
                }
                
                if (emailInput) {
                    emailInput.disabled = false;
                    emailInput.style.pointerEvents = 'auto';
                    emailInput.style.opacity = '1';
                }
            }
        }

        function checkAccess(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('ðŸ” Starting access verification...');
            
            // Immediately proceed with validation - no loading screen
            performAccessCheck();
        }
        
        async function performAccessCheck() {
            const name = document.getElementById("freelancerName").value.trim();
            const email = document.getElementById("freelancerEmail").value.trim().toLowerCase();
            
            console.log('ðŸ“ Input data:', { name, email });
            
            // First, try approved application lookup by email (public path)
            try {
                await window.FirebaseConfig.waitForInit();
                const db = firebase.firestore();
                try {
                    const appsColl = db.collection('applications');
                    let appsSnap = null;
                    // First try root-level email field
                    try {
                        appsSnap = await appsColl
                            .where('email', '==', email)
                            .where('status', '==', 'approved')
                            .limit(1)
                            .get();
                    } catch (_) {}
                    // If empty, try nested applicant.email
                    if (!appsSnap || appsSnap.empty) {
                        try {
                            appsSnap = await appsColl
                                .where('applicant.email', '==', email)
                                .where('status', '==', 'approved')
                                .limit(1)
                                .get();
                        } catch (_) {}
                    }
                    if (appsSnap && !appsSnap.empty) {
                        const appDoc = appsSnap.docs[0];
                        const a = appDoc.data() || {};
                        const applicant = a.applicant || {};
                        const approvedName = (a.name || a.fullName || applicant.name || name || '').toString().trim();
                        const approvedEmail = (a.email || applicant.email || email || '').toString().trim().toLowerCase();
                        // Seed a minimal user-like object so downstream code works unchanged
                        approvedUsers = {
                            [approvedName]: {
                                profile: {
                                    name: approvedName,
                                    email: approvedEmail,
                                    role: a.role || a.jobTitle || applicant.role || 'Contractor',
                                    location: a.location || applicant.location || 'Atlanta Area',
                                    rate: a.rate || a.payDisplay || applicant.rate || '$150/day',
                                    approvedDate: (a.updatedAt || a.createdAt || new Date().toISOString()).slice(0,10)
                                },
                                jobs: {
                                    [a.jobId || 'approved-application'] : {
                                        title: a.jobTitle || applicant.role || 'Contractor',
                                        location: a.location || applicant.location || 'Atlanta Area',
                                        date: a.jobDate || a.projectDate || 'TBD',
                                        rate: a.rate || a.payDisplay || applicant.rate || '$150/day',
                                        pay: a.payDisplay || a.rate || applicant.rate,
                                        status: 'approved'
                                    }
                                },
                                primaryJob: a.jobId || 'approved-application',
                                application: {
                                    source: a.source || 'apply_html',
                                    portfolio: a.portfolio || applicant.portfolio || '',
                                    description: a.description || ''
                                },
                                contract: {}
                            }
                        };
                        console.log('âœ… Approved application found; granting access via applications:', { docId: appDoc.id });
                    }
                } catch (appErr) {
                    console.warn('âš ï¸ Applications lookup failed:', appErr?.message || appErr);
                }
                
                // If no approved application matched, fall back to direct user doc by exact name (public GET if approved)
                if (!approvedUsers || Object.keys(approvedUsers).length === 0) {
                    try {
                        const userSnap = await db.collection('users').doc(name).get();
                        if (userSnap && userSnap.exists) {
                            const data = userSnap.data() || {};
                            approvedUsers = { [name]: data };
                            console.log('âœ… Loaded user from Firestore by name:', name);
                        } else {
                            console.warn('âš ï¸ No Firestore doc for name:', name);
                        }
                    } catch (fsErr) {
                        console.warn('âš ï¸ Firestore direct read failed:', fsErr?.message || fsErr);
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ Could not initialize Firebase/Firestore:', error);
            }
            
            console.log('ðŸ‘¥ Available users:', Object.keys(approvedUsers));
            
            const successDiv = document.getElementById("success-message");
            const errorDiv = document.getElementById("error-message");
            
            if (!successDiv || !errorDiv) {
                console.error('âŒ Could not find success or error message divs');
                return;
            }
            
            // Hide previous messages
            successDiv.classList.add("hidden");
            errorDiv.classList.add("hidden");
            
            // Check if user exists and email matches (case-insensitive for both name and email)
            const normalizedName = name.toLowerCase();
            const matchingUser = Object.keys(approvedUsers).find(key => 
                key.toLowerCase() === normalizedName
            );
            
            console.log('ðŸ” Matching logic:', { 
                normalizedName, 
                matchingUser,
                expectedEmail: matchingUser ? approvedUsers[matchingUser].profile?.email?.toLowerCase?.() : 'N/A',
                inputEmail: email
            });
            
            if (matchingUser && (approvedUsers[matchingUser].profile?.email || '').toLowerCase() === email) {
                const userData = approvedUsers[matchingUser];
                
                // Store freelancer data for both signed and unsigned contracts
                // Get job-specific details from resolved primary job (for Quick Apply users)
                const resolvedKey = resolvePrimaryJobKey(userData);
                const primaryJob = userData.jobs?.[resolvedKey];
                currentFreelancerData = {
                    name: matchingUser,
                    email: userData.profile?.email,
                    role: primaryJob?.title || userData.profile?.role,
                    location: primaryJob?.location || userData.profile?.location,
                    projectStart: (primaryJob?.date || userData.application?.eventDate || userData.profile?.projectDate || userData.profile?.projectStart) || 'TBD',
                    rate: primaryJob?.pay || primaryJob?.rate || userData.profile?.rate,
                    approvedDate: userData.profile?.approvedDate,
                    contractStatus: userData.contract?.contractStatus,
                    contractSignedDate: userData.contract?.contractSignedDate,
                    contractUploadedDate: userData.contract?.contractUploadedDate,
                    contractId: userData.contract?.contractId,
                    previousContractFileUrl: userData.contract?.fileUrl,
                    primaryJob: resolvedKey || userData.primaryJob,
                    jobs: userData.jobs,
                    paymentMethod: userData.paymentMethod
                };
                
                // If a previous contract exists, show a banner but DO NOT block new signing
                hasPreviouslySignedContract = (userData.contract?.contractStatus === 'signed' || userData.contract?.contractStatus === 'uploaded');
                if (hasPreviouslySignedContract) {
                    console.log('â„¹ï¸ Previous contract on file. Allowing new contract for additional job.');
                }
                
                console.log('âœ… Access granted for:', matchingUser);
                
                // Determine if user is already authenticated with this email â†’ skip password entry
                try {
                    await window.FirebaseConfig.waitForInit();
                    const auth = window.FirebaseConfig.auth || (window.firebase && window.firebase.auth && window.firebase.auth());
                    const authUser = auth && auth.currentUser;
                    if (authUser && (authUser.email || '').toLowerCase() === email) {
                        requirePasswordForSignature = false;
                        const section = document.getElementById('portalPasswordSection');
                        if (section) { section.style.display = 'none'; }
                    } else {
                        requirePasswordForSignature = true;
                    }
                } catch (_) { /* keep default */ }

                // Populate contract details
                populateContractDetails();
                
                // If previously signed, surface an informational banner and prior download link
                try {
                    if (hasPreviouslySignedContract) {
                        const detailsDiv = document.getElementById('contractDetails');
                        if (detailsDiv) {
                            const banner = document.createElement('div');
                            banner.className = 'contract-section';
                            banner.style.background = 'rgba(34,197,94,0.08)';
                            banner.style.borderColor = '#22c55e';
                            const linkHtml = currentFreelancerData?.previousContractFileUrl ? `<a href="${currentFreelancerData.previousContractFileUrl}" target="_blank" class="contract-link" style="display:inline-block;margin-top:.75rem;">ðŸ“„ Download previous signed contract</a>` : '';
                            banner.innerHTML = `<h4><i class="fas fa-info-circle"></i> Previous Contract On File</h4><p style="margin-top:.5rem; color: rgba(255,255,255,0.9);">We found a previously signed contract. You can continue to sign a new contract for another job below.</p>${linkHtml}`;
                            detailsDiv.parentNode && detailsDiv.parentNode.insertBefore(banner, detailsDiv);
                        }
                    }
                } catch(_) {}
                
                // Set default signature date to today in user's local timezone
                const today = new Date();
                const localDate = today.toLocaleDateString('en-CA'); // 'en-CA' gives YYYY-MM-DD format
                document.getElementById('signatureDate').value = localDate;
                
                // Set up signature validation now that elements exist
                setupSignatureValidation();
                
                // AGGRESSIVELY hide login elements to prevent duplication
                const loginElements = document.getElementById('loginElements');
                if (loginElements) {
                    console.log('ðŸ”¨ Hiding login elements to prevent duplication');
                    loginElements.classList.add('hidden');
                    loginElements.style.display = 'none';
                    loginElements.style.visibility = 'hidden';
                    loginElements.style.opacity = '0';
                    loginElements.style.height = '0';
                    loginElements.style.overflow = 'hidden';
                    console.log('âœ… Login elements hidden successfully');
                }
                
                // Show success message after a brief delay for smooth transition
                setTimeout(() => {
                    // Debug: Check ONLY the login form elements (not the main container)
                    const loginFormElements = document.querySelectorAll('#loginElements, .login-form, #contractForm');
                    loginFormElements.forEach((el, index) => {
                        console.log(`Login form element ${index}:`, {
                            id: el.id,
                            className: el.className,
                            display: window.getComputedStyle(el).display,
                            visibility: window.getComputedStyle(el).visibility,
                            opacity: window.getComputedStyle(el).opacity
                        });
                        // Only hide form elements, NOT the main login screen container
                        if (el.id !== 'loginScreen' && el.id !== 'mainContainer' && !el.classList.contains('login-screen')) {
                            if (window.getComputedStyle(el).display !== 'none') {
                                console.log('ðŸ”¨ Hiding login form element:', el.id);
                                el.style.display = 'none';
                                el.style.visibility = 'hidden';
                            }
                        }
                    });
                    
                    successDiv.classList.remove("hidden");
                    
                    // Expand to show more content comfortably and ensure main containers are visible
                    const loginScreen = document.getElementById('loginScreen');
                    const mainContainer = document.getElementById('mainContainer');
                    
                    if (loginScreen) {
                        loginScreen.classList.add('expanded');
                        loginScreen.style.display = 'flex'; // Ensure it's visible
                        loginScreen.style.visibility = 'visible';
                        console.log('âœ… Login screen expanded and visible');
                    }
                    
                    if (mainContainer) {
                        mainContainer.classList.add('expanded');
                        mainContainer.style.display = 'block'; // Ensure it's visible
                        mainContainer.style.visibility = 'visible';
                        console.log('âœ… Main container expanded and visible');
                    }
                    
                    // Scroll to the very top of the page to show the logo
                    // Users will start at the top and can scroll down manually
                    window.scrollTo({ 
                        top: 0, 
                        behavior: 'smooth' 
                    });
                }, 400); // Wait for login elements to finish hiding
            } else {
                console.log('âŒ Access denied for:', { name, email });
                
                // Access denied
                errorDiv.classList.remove("hidden");
                
                // Scroll to error message
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Populate contract details in the UI
        function populateContractDetails() {
            if (!currentFreelancerData) return;
            
            const data = currentFreelancerData;
            const effectiveDate = data.profile?.approvedDate || new Date().toISOString().split('T')[0];
            
            // Get job-specific details from primary job (for Quick Apply users)
            const primaryJob = data.jobs?.[data.primaryJob || resolvePrimaryJobKey(data)];
            const role = primaryJob?.title || data.profile?.role || 'Contractor';
            const location = primaryJob?.location || data.profile?.location || 'Atlanta Area';
            const projectStart = primaryJob?.date || data.application?.eventDate || data.profile?.projectDate || data.profile?.projectStart || 'TBD';
            const rate = primaryJob?.pay || primaryJob?.rate || data.profile?.rate || '$150/day';
            
            const contractDetailsDiv = document.getElementById('contractDetails');
            contractDetailsDiv.innerHTML = `
                <!-- Basic Contract Info -->
                <div class="contract-section project-info">
                    <h4><i class="fas fa-info-circle"></i> Project Information</h4>
                    <div style="display: grid; gap: 0.75rem; margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-user" style="color: #FFB200; width: 20px;"></i> <strong>Name:</strong> ${data.name}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-envelope" style="color: #FFB200; width: 20px;"></i> <strong>Email:</strong> ${data.email}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-briefcase" style="color: #FFB200; width: 20px;"></i> <strong>Role:</strong> ${role}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-map-marker-alt" style="color: #FFB200; width: 20px;"></i> <strong>Location:</strong> ${location}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-clock" style="color: #FFB200; width: 20px;"></i> <strong>Project Start:</strong> ${projectStart}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-dollar-sign" style="color: #FFB200; width: 20px;"></i> <strong>Rate:</strong> ${rate}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-calendar" style="color: #FFB200; width: 20px;"></i> <strong>Effective Date:</strong> ${effectiveDate}</div>
                    </div>
                </div>

                <!-- Contract Terms -->
                <div class="contract-section">
                    <h4><i class="fas fa-tasks"></i> Your Responsibilities</h4>
                    <ul style="margin: 1rem 0 0 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Arrive at the project location on time</li>
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Professionally manage your assigned role and responsibilities</li>
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Complete the job to professional standards</li>
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Use personal equipment unless otherwise arranged</li>
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Maintain a respectful demeanor with staff and clients</li>
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Wear company-branded gear provided (no charge)</li>
                        <li><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 0.5rem;"></i>Wear all black regardless of branded gear provided</li>
                    </ul>
                </div>

                <!-- BTS Content Policy -->
                <div class="contract-section">
                    <h4><i class="fas fa-camera"></i> BTS Content & Ownership</h4>
                    <p style="margin: 1rem 0 0 0; line-height: 1.8; color: rgba(255,255,255,0.9);">
                        <i class="fas fa-info-circle" style="color: #3B82F6; margin-right: 0.5rem;"></i>
                        You may freely take and share behind-the-scenes content. Cochran Films may repost with credit. 
                        Content ownership remains with you.
                    </p>
                </div>

                <!-- Payment Terms -->
                <div class="contract-section">
                    <h4><i class="fas fa-credit-card"></i> Payment Terms</h4>
                    <p style="margin: 1rem 0 0 0; line-height: 1.8; color: rgba(255,255,255,0.9);">
                        <i class="fas fa-money-bill-wave" style="color: #10B981; margin-right: 0.5rem;"></i>
                        Payment of <strong style="color: #FFB200;">${rate}</strong> will be made no later than 24 hours after the event 
                        by the agreed method (Zelle, PayPal, etc.).
                    </p>
                </div>

                <!-- Independent Contractor -->
                <div class="contract-section">
                    <h4><i class="fas fa-shield-alt"></i> Independent Contractor</h4>
                    <p style="margin: 1rem 0 0 0; line-height: 1.8; color: rgba(255,255,255,0.9);">
                        <i class="fas fa-exclamation-triangle" style="color: #F59E0B; margin-right: 0.5rem;"></i>
                        You are not an employee. No taxes or benefits will be withheld. You handle all personal 
                        tax obligations and transportation.
                    </p>
                </div>

                <!-- Agreement -->
                <div class="contract-section signature-section">
                    <h4><i class="fas fa-handshake"></i> Agreement</h4>
                    <p style="margin: 1rem 0 0 0; line-height: 1.8; color: rgba(255,255,255,0.9);">
                        <i class="fas fa-pen-nib" style="color: #FFB200; margin-right: 0.5rem;"></i>
                        By signing below, both parties agree to the above terms and conditions. This creates a 
                        legally binding freelance agreement between you and Cochran Films.
                    </p>
                </div>
            `;
        }
        
        // Digital signature validation - set up when elements exist
        function setupSignatureValidation() {
            const signatureInput = document.getElementById('digitalSignature');
            const passwordInput = document.getElementById('portalPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const signButton = document.getElementById('signContractBtn');
            
            if (signatureInput && signButton) {
                // Function to validate all inputs
                function validateAllInputs() {
                    const signature = signatureInput.value.trim();
                    const password = passwordInput ? passwordInput.value : '';
                    const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
                    const expectedName = currentFreelancerData ? currentFreelancerData.name.toLowerCase() : '';
                    
                    // Check signature
                    const signatureValid = signature.length >= 3 && signature.toLowerCase() === expectedName;
                    
                    // Check password (only when required)
                    const passwordValid = requirePasswordForSignature ? (password.length >= 6) : true;
                    const passwordsMatch = requirePasswordForSignature ? (password === confirmPassword) : true;
                    
                    // Update signature input styling
                    if (signatureValid) {
                        signatureInput.style.borderColor = '#22c55e';
                    } else {
                        signatureInput.style.borderColor = signature.length >= 3 ? '#ef4444' : 'rgba(255, 178, 0, 0.5)';
                    }
                    
                    // Update password input styling
                    if (passwordInput) {
                        if (password.length >= 6) {
                            passwordInput.style.borderColor = passwordsMatch ? '#22c55e' : '#ef4444';
                        } else {
                            passwordInput.style.borderColor = 'rgba(255, 178, 0, 0.5)';
                        }
                    }
                    
                    if (confirmPasswordInput) {
                        if (confirmPassword.length > 0) {
                            confirmPasswordInput.style.borderColor = passwordsMatch ? '#22c55e' : '#ef4444';
                        } else {
                            confirmPasswordInput.style.borderColor = 'rgba(255, 178, 0, 0.5)';
                        }
                    }
                    
                    // Enable button if all validations pass
                    if (signatureValid && passwordValid && passwordsMatch) {
                        signButton.disabled = false;
                        signButton.style.opacity = '1';
                    } else {
                        signButton.disabled = true; 
                        signButton.style.opacity = '0.5';
                    }
                }
                
                // Add event listeners
                signatureInput.addEventListener('input', validateAllInputs);
                if (passwordInput) passwordInput.addEventListener('input', validateAllInputs);
                if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', validateAllInputs);
                
                // Initial validation
                validateAllInputs();
            }
        }

        // Show message when contract is already signed
        function showAlreadySignedMessage(userData) {
            const loginElements = document.getElementById('loginElements');
            if (loginElements) {
                loginElements.classList.add('hidden');
                loginElements.style.display = 'none';
            }
            
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <div class="logo">
                    <img src="https://static.wixstatic.com/media/aeef42_d31420a75a164d2cb4508bdd7d99ca88~mv2.png" alt="Cochran Films Logo">
                </div>
                
                <div class="message success">
                    <div class="message-header">
                        <h2><i class="fas fa-check-circle"></i> Contract Already Signed</h2>
                    </div>
                    
                    <div class="message-content">
                        <p><strong>Hi ${userData.profile?.name || 'User'},</strong></p>
                        <p>Your contract has already been signed and processed!</p>
                        
                        <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; border: 1px solid rgba(255,178,0,0.3);">
                            <h4 style="color: #FFB200; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Contract Status</h4>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; color: rgba(255,255,255,0.9);">
                                <div><strong>Status:</strong> ${userData.contract?.contractStatus === 'uploaded' ? 'Signed & Uploaded' : 'Digitally Signed'}</div>
                                ${userData.contract?.contractSignedDate ? `<div><strong>Signed Date:</strong> ${userData.contract.contractSignedDate}</div>` : ''}
                                ${userData.contract?.contractUploadedDate ? `<div><strong>Processed Date:</strong> ${userData.contract.contractUploadedDate}</div>` : ''}
                                ${userData.contract?.contractId ? `<div><strong>Contract ID:</strong> ${userData.contract.contractId}</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(34, 197, 94, 0.3);">
                            <h4 style="color: #22c55e; margin-bottom: 1rem;"><i class="fas fa-user-circle"></i> Access Your Portal</h4>
                            <p style="margin-bottom: 1rem; color: rgba(255,255,255,0.9);">
                                You can download your contract PDF directly to your device, or view it anytime in your personal freelancer portal along with job details and project timeline.
                            </p>
                            <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
                                <a href="https://collaborate.cochranfilms.com/user-portal.html" class="contract-link" style="margin: 0;">
                                    <i class="fas fa-external-link-alt"></i> Open Creator Portal
                                </a>
                                <button onclick="downloadContractPDF({contractId: userData.contract?.contractId, freelancerName: userData.profile?.name, freelancerEmail: userData.profile?.email, role: userData.profile?.role, location: userData.profile?.location, projectStart: (userData.application?.eventDate || userData.jobs?.[userData.primaryJob]?.date || userData.profile?.projectDate || userData.profile?.projectStart) || 'TBD', rate: userData.jobs?.[userData.primaryJob]?.rate || userData.profile?.rate, effectiveDate: userData.profile?.approvedDate, signatureDate: userData.contract?.contractSignedDate, signature: userData.profile?.name})" class="contract-link" style="margin: 0;">
                                    <i class="fas fa-download"></i> Download Contract PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Sign contract function
        async function signContract() {
            const signature = document.getElementById('digitalSignature').value.trim();
            const signatureDate = document.getElementById('signatureDate').value;
            const password = document.getElementById('portalPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!signature || !signatureDate) {
                alert('âŒ Please enter your signature and date to sign the contract.');
                return;
            }
            
            if (requirePasswordForSignature) {
                if (!password || password.length < 6) {
                    alert('âŒ Please enter a password with at least 6 characters.');
                    return;
                }
                if (password !== confirmPassword) {
                    alert('âŒ Passwords do not match. Please check your password confirmation.');
                    return;
                }
            }
            
            if (!currentFreelancerData) {
                alert('âŒ Contract data not available. Please refresh and try again.');
                return;
            }
            
            // Validate signature matches name
            if (signature.toLowerCase() !== currentFreelancerData.name.toLowerCase()) {
                alert('âŒ Your signature must match your full name exactly.');
                return;
            }
            
            // Show beautiful loading notification immediately
            showContractSigningNotification();
            
            const signButton = document.getElementById('signContractBtn');
            const originalText = signButton.textContent;
            signButton.textContent = 'ðŸ“ Signing Contract...';
            signButton.disabled = true;
            
            try {
                // Store signature data
                signatureData = {
                    signature: signature,
                    date: signatureDate,
                    timestamp: new Date().toISOString(),
                    freelancerName: currentFreelancerData.name,
                    freelancerEmail: currentFreelancerData.email,
                    portalPassword: password
                };
                // Persist recent signature identity in session for portal backfill
                try {
                    sessionStorage.setItem('recentSignatureName', signatureData.freelancerName || '');
                    sessionStorage.setItem('recentSignatureEmail', (signatureData.freelancerEmail || '').toLowerCase());
                } catch(_) {}
                
                contractSigned = true;
                
                // Update notification with progress
                updateNotificationProgress('Validating your signature...', 20);
                
                // Save signed contract data and send emails
                await saveSignedContractData();
                
                // Show final success notification
                showFinalSuccessNotification();
                
                console.log('Contract signed successfully!', signatureData);
                
            } catch (error) {
                console.error('Error signing contract:', error);
                signButton.textContent = originalText;
                signButton.disabled = false;
                showErrorNotification('There was an error processing your signature. Please try again or contact support.');
            }
        }
        
        // Show beautiful contract signing notification
        function showContractSigningNotification() {
            // Add background blur overlay
            const overlay = document.createElement('div');
            overlay.id = 'contract-signing-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(8px);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            document.body.appendChild(overlay);
            
            // Create notification container
            const notification = document.createElement('div');
            notification.id = 'contract-signing-notification';
            notification.style.cssText = `
                position: relative;
                background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
                border: 2px solid #FFB200;
                border-radius: 16px;
                padding: 2rem;
                max-width: 500px;
                width: 90%;
                z-index: 10000;
                box-shadow: 0 20px 60px rgba(0,0,0,0.8);
                backdrop-filter: blur(20px);
                color: white;
                text-align: center;
                font-family: 'Inter', sans-serif;
            `;
            
            notification.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“</div>
                    <h2 style="color: #FFB200; font-family: 'Cinzel', serif; margin-bottom: 0.5rem;">Signing Your Contract</h2>
                    <p style="color: rgba(255,255,255,0.8); margin: 0;">Please wait while we process your digital signature...</p>
                </div>
                
                <div id="notification-progress" style="margin-bottom: 1.5rem;">
                    <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                        <div id="progress-bar" style="background: linear-gradient(90deg, #FFB200, #FFD700); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <p id="progress-text" style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-top: 0.5rem;">Preparing your contract...</p>
                </div>
                
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                    This process is secure and encrypted
                </div>
            `;
            
            overlay.appendChild(notification);
        }
        
        // Update notification progress
        function updateNotificationProgress(message, percentage) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = message;
            }
        }
        
        // Show final success notification
        function showFinalSuccessNotification() {
            const notification = document.getElementById('contract-signing-notification');
            if (notification) {
                notification.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
                        <h2 style="color: #22c55e; font-family: 'Cinzel', serif; margin-bottom: 0.5rem;">Contract Signed Successfully!</h2>
                        <p style="color: rgba(255,255,255,0.8); margin: 0;">Your digital signature has been recorded and your contract is now legally binding.</p>
                    </div>
                    
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: left;">
                        <h3 style="color: #22c55e; margin-bottom: 1rem; font-size: 1.1rem;">What happens next:</h3>
                        <ul style="list-style: none; padding: 0; margin: 0; color: rgba(255,255,255,0.9);">
                            <li style="margin-bottom: 0.5rem;">âœ… Your contract has been saved securely</li>
                            <li style="margin-bottom: 0.5rem;">âœ… You'll receive a confirmation email shortly</li>
                            <li style="margin-bottom: 0.5rem;">âœ… Your portal access is now active</li>
                            <li style="margin-bottom: 0.5rem;">âœ… Admin has been notified automatically</li>
                            <li>ðŸ“‹ You're scheduled for the job - thank you!</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="downloadContractPDF(signedContractData)" style="background: linear-gradient(135deg, #FFB200, #FFD700); color: #000; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                            ðŸ“„ Download Contract PDF
                        </button>
                        <a href="https://collaborate.cochranfilms.com/user-portal.html" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 700; transition: all 0.3s ease;">
                            ðŸšª Open Creator Portal
                        </a>
                    </div>
                    
                    <button onclick="closeNotification()" style="background: none; border: none; color: rgba(255,255,255,0.6); margin-top: 1rem; cursor: pointer; font-size: 0.9rem;">
                        Close
                    </button>
                `;
            }
            
            // Hide the old success message - don't show it anymore
            document.getElementById('success-message').classList.add('hidden');
            // Don't show the old signed-message either
            // document.getElementById('signed-message').style.display = 'block';
        }
        
        // Show error notification
        function showErrorNotification(message) {
            const notification = document.getElementById('contract-signing-notification');
            if (notification) {
                notification.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                        <h2 style="color: #ef4444; font-family: 'Cinzel', serif; margin-bottom: 0.5rem;">Something went wrong</h2>
                        <p style="color: rgba(255,255,255,0.8); margin: 0;">${message}</p>
                    </div>
                    
                    <button onclick="closeNotification()" style="background: linear-gradient(135deg, #FFB200, #FFD700); color: #000; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer;">
                        Try Again
                    </button>
                `;
            }
        }

        // Lightweight toast utility for quick admin-visible feedback
        function showToast(message, type = 'info', duration = 3500) {
            try {
                const colors = { success: '#22c55e', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
                const el = document.createElement('div');
                el.style.cssText = `position: fixed; right: 16px; bottom: 16px; z-index: 9999; background: ${colors[type] || colors.info}; color: #fff; padding: 10px 14px; border-radius: 10px; box-shadow: 0 6px 24px rgba(0,0,0,.35); font-size: 14px; font-weight: 600; max-width: 90vw;`;
                el.textContent = message;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), duration);
            } catch (_) {}
        }
        
        // Close notification
        function closeNotification() {
            const notification = document.getElementById('contract-signing-notification');
            const overlay = document.getElementById('contract-signing-overlay');
            if (notification) {
                notification.remove();
            }
            if (overlay) {
                overlay.remove();
            }
        }
        
        // Update Firebase password for user
        async function updateFirebasePassword(email, newPassword) {
            // Prefer secure server-side admin update (does not require old password)
            try {
                const res = await fetch('/api/firebase', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, newPassword, admin: true })
                });
                if (res.ok) {
                    const json = await res.json();
                    if (json && json.success) return { success: true, updated: true, admin: true };
                }
            } catch (e) {
                console.warn('âš ï¸ Admin password update failed, trying client if signed in:', e?.message || e);
            }
            // Client-side update if the user is currently signed in
            try {
                await window.FirebaseConfig.waitForInit();
                const auth = (window.firebase && window.firebase.auth && window.firebase.auth());
                if (auth && auth.currentUser) {
                    await auth.currentUser.updatePassword(newPassword);
                    return { success: true, updated: true };
                }
            } catch (error) {
                console.warn('âš ï¸ Client password update failed:', error?.message || error);
            }
            return { success: false, error: 'Password update not applied' };
        }

        // Ensure a Firebase account exists and set password
        async function ensureFirebaseAccount(email, password) {
            try {
                await window.FirebaseConfig.waitForInit();
                const auth = (window.firebase && window.firebase.auth && window.firebase.auth());
                if (!auth) throw new Error('Auth not initialized');

                // 1) Try create (client)
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    return { success: true, created: true };
                } catch (e) {
                    const emailExists = e && (e.code === 'auth/email-already-in-use' || /EMAIL_EXISTS/i.test(e.message || ''));
                    if (emailExists) {
                        // 2) Account exists â†’ set password via admin endpoint, then (best-effort) sign in
                        try {
                            const resp = await fetch('/api/firebase', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email, newPassword: password, admin: true })
                            });
                            const json = await resp.json();
                            if (resp.ok && json && json.success) {
                                try { await auth.signInWithEmailAndPassword(email, password); } catch (_) {}
                                return { success: true, exists: true, passwordSet: true };
                            }
                        } catch (adminErr) {
                            console.warn('âš ï¸ Admin password set failed:', adminErr?.message || adminErr);
                        }
                        // 3) As a last resort, send reset email
                        try {
                            await auth.sendPasswordResetEmail(email);
                            return { success: false, resetSent: true, error: 'Existing account; password reset email sent' };
                        } catch (resetErr) {
                            console.warn('âš ï¸ Password reset email failed:', resetErr?.message || resetErr);
                        }
                    } else {
                        console.warn('âš ï¸ Auth create failed:', e?.code || e?.message || e);
                    }
                }

                // 4) Server create fallback
                try {
                    const createRes = await fetch('/api/firebase', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    if (createRes.ok) {
                        const createJson = await createRes.json();
                        if (createJson && createJson.success) return createJson;
                    }
                } catch (_) {}

                return { success: false, error: 'Could not create or validate account' };
            } catch (err) {
                return { success: false, error: err?.message || 'Unknown error' };
            }
        }
        
        // Add notification function for contract signing
        async function addNotification(title, message, type = 'info', data = {}) {
            try {
                const notification = {
                    id: Math.floor(Date.now() + Math.random() * 1000),
                    title: title,
                    message: message,
                    type: type,
                    data: data,
                    timestamp: new Date().toISOString(),
                    read: false,
                    actionRequired: data.actionRequired || false,
                    priority: data.priority || 'normal'
                };
                
                // Save to notifications.json via API
                const response = await fetch('/api/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notifications: [notification]
                    })
                });
                
                if (response.ok) {
                    console.log('ðŸ”” Contract signing notification added:', notification);
                } else {
                    console.warn('âš ï¸ Could not save notification to server');
                }
                
                return notification.id;
            } catch (error) {
                console.error('âŒ Error adding notification:', error);
            }
        }
        
        // Save signed contract data and send emails
        async function saveSignedContractData() {
            try {
                // Generate unique contract ID for tracking
                const contractId = 'CF-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
                
                updateNotificationProgress('Creating your contract...', 30);
                
                signedContractData = {
                    contractId: contractId,
                    freelancerName: signatureData.freelancerName,
                    freelancerEmail: signatureData.freelancerEmail,
                    role: currentFreelancerData.role || 'Contractor',
                    location: currentFreelancerData.location || 'Atlanta Area',
                    projectStart: currentFreelancerData.projectStart || 'TBD',
                    rate: currentFreelancerData.rate || 'Not specified',
                    effectiveDate: currentFreelancerData.approvedDate || new Date().toISOString().split('T')[0],
                    signatureDate: signatureData.date,
                    signedTimestamp: signatureData.timestamp,
                    signature: signatureData.signature,
                    portalPassword: document.getElementById('portalPassword').value,
                    status: 'SIGNED',
                    signedDateTime: new Date().toLocaleString(),
                    // JOB-SPECIFIC CONTRACT LINKING
                    jobId: currentFreelancerData.primaryJob || 'legacy-job',
                    jobRole: currentFreelancerData.role || 'Contractor',
                    jobDescription: currentFreelancerData.projectStart !== 'TBD' ? `Project starting ${currentFreelancerData.projectStart}` : 'Contractor position',
                    deviceInfo: {
                        userAgent: navigator.userAgent.substring(0, 200),
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    }
                };

                updateNotificationProgress('Securing your data...', 50);
                
                // Ensure Firebase account exists only when we required a password in this flow
                if (requirePasswordForSignature) {
                    const newPassword = document.getElementById('portalPassword').value;
                    const firebaseResult = await ensureFirebaseAccount(signatureData.freelancerEmail, newPassword);
                    if (firebaseResult.success) {
                        console.log('âœ… Firebase account ready for:', signatureData.freelancerEmail);
                        try { showToast('âœ… Portal password set successfully', 'success'); } catch (e) {}
                    } else {
                        console.warn('âš ï¸ Could not set Firebase password:', firebaseResult.error);
                        try { showToast(`âš ï¸ Password not saved: ${firebaseResult.error || 'Unknown error'}`, 'warning'); } catch (e) {}
                    }
                }
                
                // Update freelancer data status to "signed" (not fully processed until admin uploads)
                // Note: This will be temporary until admin uploads the signed PDF
                try {
                    // Mark as signed in local tracking
                    const signedTrackingData = {
                        [signatureData.freelancerEmail]: {
                            contractId: contractId,
                            signedDate: signatureData.date,
                            signedTimestamp: signatureData.timestamp,
                            status: 'signed'
                        }
                    };
                    
                    const existingTracking = JSON.parse(localStorage.getItem('contractSigningTracking') || '{}');
                    Object.assign(existingTracking, signedTrackingData);
                    localStorage.setItem('contractSigningTracking', JSON.stringify(existingTracking));
                    
                    console.log('ðŸ“‹ Contract signing tracked for admin upload workflow');
                } catch (trackingError) {
                    console.warn('âš ï¸ Could not update signing tracking:', trackingError);
                }
                
                console.log('âœ… Signed contract data prepared:', signedContractData);
                
                // Add notification for contract signing
                try {
                    await addNotification(
                        'Contract Signed Successfully',
                        `Your contract has been signed and is being processed by admin`,
                        'contract_signed',
                        {
                            userEmail: signatureData.freelancerEmail,
                            userName: signatureData.freelancerName,
                            contractId: contractId,
                            actionRequired: false,
                            priority: 'normal'
                        }
                    );
                } catch (notificationError) {
                    console.warn('âš ï¸ Could not add notification:', notificationError);
                }
                
                updateNotificationProgress('Generating your contract PDF...', 70);
                
                // ==================== AUTOMATIC PDF UPLOAD ====================
                try {
                    console.log('ðŸ“„ Starting automatic PDF generation and upload...');
                    
                    // Add a small delay before PDF upload to ensure GitHub API is ready
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Upload PDF to Firestore Storage FIRST
                    const uploadedContract = await uploadPDFToFirestoreStorage(signedContractData);
                    
                    // Update contract status to uploaded
                    signedContractData.status = 'UPLOADED';
                    signedContractData.uploadedContract = uploadedContract;
                    
                    console.log('âœ… PDF automatically uploaded to Firestore Storage:', uploadedContract.fileUrl);
                    
                    updateNotificationProgress('Finalizing your contract...', 85);
                    
                    // WAIT 5 seconds before updating JSON files to avoid conflicts
                    console.log('â³ Waiting 5 seconds before updating JSON files...');
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    
                } catch (uploadError) {
                    console.warn('âš ï¸ PDF upload failed (contract still signed):', uploadError);
                }
                
                // Persist contract to Firestore users collection first, then JSON backup
                try {
                    // Find user by email and update their contract status in Firestore
                    await window.FirebaseConfig.waitForInit();
                    try {
                        const fsUsers = await window.FirestoreDataManager.getUsers();
                        const userKey = Object.keys(fsUsers || {}).find(k => (fsUsers[k]?.profile?.email || '').toLowerCase() === (signedContractData.freelancerEmail || '').toLowerCase());
                        if (userKey) {
                            const fileUrl = signedContractData?.uploadedContract?.fileUrl || null;
                            await window.FirestoreDataManager.setUser(userKey, {
                                profile: { ...(fsUsers[userKey].profile||{}), name: signatureData.freelancerName, approvedDate: fsUsers[userKey].profile?.approvedDate || new Date().toISOString().split('T')[0] },
                                contract: {
                                    ...(fsUsers[userKey].contract||{}),
                                    contractStatus: fileUrl ? 'uploaded' : 'signed',
                                    contractSignedDate: signedContractData.signedDateTime,
                                    ...(fileUrl ? { contractUploadedDate: new Date().toISOString(), fileUrl } : {}),
                                    contractId: signedContractData.contractId
                                }
                            });
                            console.log('âœ… Firestore user contract status updated');
                        } else {
                            console.warn('âš ï¸ Firestore user not found for contract update');
                        }
                    } catch (errFsUpdate) {
                        console.warn('âš ï¸ Firestore setUser failed:', errFsUpdate?.message || errFsUpdate);
                    }
                } catch (_) {}

                // Persist contract status to users.json (includes file URL when available)
                try {
                    await updateUsersJsonWithPassword(signedContractData);
                } catch (jsonUpdateErr) {
                    console.warn('âš ï¸ Could not update users.json with contract status:', jsonUpdateErr);
                }

                updateNotificationProgress('Sending confirmation emails...', 90);
                
                // Contract data saved to GitHub (no local backup needed)
                
                // Password will be saved to users.json for admin reference
                
                // WAIT 3 seconds between JSON updates to avoid conflicts
                console.log('â³ Waiting 3 seconds before updating uploaded-contracts.json...');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Update uploaded-contracts.json with the new contract
                await updateUploadedContractsJson(signedContractData);
                
                // Generate PDF content for email attachment
                const pdfContent = generatePDFContent(signedContractData);
                
                // Send emails (user confirmation + admin notification)
                console.log('ðŸ“§ Sending emails...');
                try {
                    // Try to send user confirmation email (optional)
                    try {
                        await sendUserConfirmationEmail(signedContractData);
                        console.log('âœ… User confirmation email sent');
                        showToast('âœ… Email sent to user', 'success');
                    } catch (userEmailError) {
                        console.warn('âš ï¸ User confirmation email failed (this is OK if template not set up yet):', userEmailError);
                        showToast(`âš ï¸ User email failed: ${userEmailError?.message || userEmailError}`, 'error');
                        // Don't fail the whole process for user email
                    }
                    
                    // Send admin notification (required)
                    await sendAdminNotificationEmail(signedContractData, pdfContent);
                    console.log('âœ… Admin notification email sent');
                    showToast('âœ… Email sent to admin', 'success');
                    
                } catch (emailError) {
                    console.warn('âš ï¸ Email sending failed:', emailError);
                    showToast(`âš ï¸ Email sending failed: ${emailError?.message || emailError}`, 'error');
                }
                
                updateNotificationProgress('Contract signed successfully!', 100);
                
                // Legacy notification for compatibility
                localStorage.setItem('contractSignedNotification', JSON.stringify({
                    timestamp: new Date().toISOString(),
                    contractId: contractId,
                    action: 'NEW_CONTRACT_SIGNED',
                    emailSent: true
                }));
                
            } catch (error) {
                console.error('âŒ Error saving signed contract data:', error);
                throw error;
            }
        }
        
        // Update users.json with password when contract is signed
        async function updateUsersJsonWithPassword(contractData) {
            try {
                console.log('ðŸ”„ Updating users.json with contract status...');
                
                // Add a small delay to ensure GitHub API is ready
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Load current users.json with retry logic
                let response;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch('/api/users');
                        if (response.ok) break;
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.log(`âš ï¸ Retry ${retryCount} loading users.json...`);
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    } catch (fetchError) {
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.log(`âš ï¸ Fetch error, retry ${retryCount}...`);
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Could not load users.json after retries');
                }
                
                const usersData = await response.json();
                const users = usersData.users || {};
                
                console.log('ðŸ” Available users in JSON:', Object.keys(users));
                console.log('ðŸ” Looking for email:', contractData.freelancerEmail);
                
                // Find the user by email (case-insensitive)
                const userKey = Object.keys(users).find(key => {
                    const user = users[key];
                    const userEmail = user?.profile?.email;
                    const contractEmail = contractData.freelancerEmail;
                    
                    if (!userEmail || !contractEmail) {
                        console.log(`âš ï¸ Missing email data - User email: ${userEmail}, Contract email: ${contractEmail}`);
                        return false;
                    }
                    
                    return userEmail.toLowerCase() === contractEmail.toLowerCase();
                });
                
                if (userKey) {
                    console.log('âœ… Found user in JSON:', userKey);
                    
                    // Ensure user structure exists
                    if (!users[userKey].profile) {
                        users[userKey].profile = {};
                    }
                    if (!users[userKey].contract) {
                        users[userKey].contract = {};
                    }
                    
                // Update contract status metadata and save password when provided
                const fileUrl = contractData?.uploadedContract?.fileUrl || null;
                users[userKey].contract.contractStatus = fileUrl ? 'uploaded' : 'signed';
                users[userKey].contract.contractSignedDate = contractData.signedDateTime;
                if (fileUrl) {
                    users[userKey].contract.contractUploadedDate = new Date().toISOString();
                    users[userKey].contract.fileUrl = fileUrl;
                }
                users[userKey].contract.contractId = contractData.contractId;
                
                // Save portal password when provided (for admin reference)
                if (contractData.portalPassword && contractData.portalPassword.length >= 6) {
                    users[userKey].portalPassword = contractData.portalPassword;
                    console.log('âœ… Portal password saved for:', contractData.freelancerEmail);
                }
                
                // Ensure profile basics exist for downstream emails
                users[userKey].profile.approvedDate = users[userKey].profile.approvedDate || new Date().toISOString().split('T')[0];
                    
                    // Update the JSON structure
                    const updatedUsersData = {
                        ...usersData,
                        users: users,
                        lastUpdated: new Date().toISOString().split('T')[0],
                        totalUsers: Object.keys(users).length
                    };
                    
                    // Update users.json on GitHub directly
                    const commitMsg = fileUrl
                        ? `Update users.json - Contract uploaded for ${contractData.freelancerName} (password saved)`
                        : `Update users.json - Contract signed by ${contractData.freelancerName} (password saved)`;
                    await updateGitHubFile('users.json', JSON.stringify(updatedUsersData, null, 2), `${commitMsg} - ${new Date().toLocaleString()}`);
                    
                    console.log('âœ… Users.json updated on GitHub with password and contract status');
                    
                } else {
                    console.warn('âš ï¸ User not found in users.json:', contractData.freelancerEmail);
                    console.warn('âš ï¸ Available emails:', Object.values(users).map(u => u.profile?.email).filter(Boolean));
                    console.warn('âš ï¸ Contract data:', contractData);
                }
                
            } catch (error) {
                console.error('âŒ Error updating users.json on GitHub:', error);
                
                // Show error notification
                setTimeout(() => {
                    const signedMessage = document.getElementById('signed-message');
                    if (signedMessage) {
                        const updateStatus = document.createElement('div');
                        updateStatus.style.cssText = 'margin-top: 10px; padding: 8px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24; font-size: 0.9rem;';
                        updateStatus.innerHTML = 'âŒ <strong>Error:</strong> Could not update password on GitHub. Please contact admin.';
                        signedMessage.appendChild(updateStatus);
                    }
                }, 2000);
                
                // Don't fail the contract signing process for this
            }
        }
        
        // Update uploaded-contracts.json with new contract
        async function updateUploadedContractsJson(contractData) {
            try {
                console.log('ðŸ”„ Updating uploaded-contracts.json with new contract...');
                
                // Load current uploaded-contracts.json
                const response = await fetch('uploaded-contracts.json');
                let uploadedContractsData = { uploadedContracts: [], lastUpdated: new Date().toISOString(), totalContracts: 0 };
                
                if (response.ok) {
                    uploadedContractsData = await response.json();
                    // Ensure the structure is correct
                    if (!uploadedContractsData.uploadedContracts) {
                        uploadedContractsData.uploadedContracts = [];
                    }
                }
                
                // Create new contract entry
                const newContract = {
                    contractId: contractData.contractId,
                    freelancerName: contractData.freelancerName,
                    freelancerEmail: contractData.freelancerEmail,
                    role: contractData.role,
                    rate: contractData.rate,
                    location: contractData.location,
                    fileName: buildContractFileName(contractData),
                    fileSize: contractData?.uploadedContract?.fileSize || 0,
                    uploadDate: new Date().toISOString(),
                    status: 'uploaded',
                    fileUrl: contractData?.uploadedContract?.fileUrl || null,
                    storagePath: contractData?.uploadedContract?.storagePath || null,
                    notes: 'Automatically uploaded via contract signing to Firestore Storage',
                    contractDate: contractData.effectiveDate,
                    signedDate: contractData.signatureDate
                };
                
                // Add to uploadedContracts array
                uploadedContractsData.uploadedContracts.push(newContract);
                uploadedContractsData.totalContracts = uploadedContractsData.uploadedContracts.length;
                uploadedContractsData.lastUpdated = new Date().toISOString();
                
                // Update uploaded-contracts.json on GitHub
                await updateGitHubFile('uploaded-contracts.json', JSON.stringify(uploadedContractsData, null, 2), `Add signed contract: ${contractData.contractId} - ${contractData.freelancerName}`);
                
                console.log('âœ… Uploaded-contracts.json updated on GitHub');

                // Mirror contract record to Firestore contracts collection
                try {
                    await window.FirebaseConfig.waitForInit();
                    const record = {
                        contractId: contractData.contractId,
                        freelancerName: contractData.freelancerName,
                        freelancerEmail: contractData.freelancerEmail,
                        role: contractData.role,
                        rate: contractData.rate,
                        location: contractData.location,
                        fileName: buildContractFileName(contractData),
                        uploadDate: new Date().toISOString(),
                        status: 'uploaded',
                        fileUrl: contractData?.uploadedContract?.fileUrl || null,
                        storagePath: contractData?.uploadedContract?.storagePath || null,
                        notes: 'Automatically uploaded via contract signing to Firestore Storage',
                        contractDate: contractData.effectiveDate,
                        signedDate: contractData.signatureDate
                    };
                    await window.FirestoreDataManager.setContract(contractData.contractId, record);
                    console.log('âœ… Contract recorded in Firestore');
                } catch (fsErr) {
                    console.warn('âš ï¸ Firestore contract save failed:', fsErr?.message || fsErr);
                }
                
            } catch (error) {
                console.error('âŒ Error updating uploaded-contracts.json:', error);
                // Don't fail the contract signing process for this
            }
        }
        
        // Send user confirmation email
        function getCurrentJobTitle() {
            try {
                const primaryKey = currentFreelancerData?.primaryJob;
                const jobObj = currentFreelancerData?.jobs?.[primaryKey];
                return jobObj?.title || jobObj?.jobTitle || currentFreelancerData?.role || 'Assigned Role';
            } catch (_) { return currentFreelancerData?.role || 'Assigned Role'; }
        }

        async function sendUserConfirmationEmail(contractData) {
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS not available');
            }
            
            const userEmailParams = {
                to_email: contractData.freelancerEmail,
                freelancer_name: contractData.freelancerName,
                job: getCurrentJobTitle(),
                role: contractData.role,
                location: contractData.location,
                rate: contractData.rate,
                project_start: contractData.projectStart,
                contract_id: contractData.contractId,
                // New: Firestore Storage download link for EmailJS templates
                download_link: contractData?.uploadedContract?.fileUrl || 'Contract will be available in your portal'
            };
            
            console.log('ðŸ“§ Sending user confirmation email with template:', EMAILJS_CONFIG.userTemplateId);
            console.log('ðŸ“§ User email params:', userEmailParams);
            
            return emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.userTemplateId, userEmailParams);
        }
        
        // Send admin notification email with PDF content
        async function sendAdminNotificationEmail(contractData, pdfContent) {
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS not available');
            }
            
            const adminEmailParams = {
                // Email destination
                to_email: 'info@cochranfilms.com',
                
                // Contract basic info
                user_name: contractData.freelancerName,
                user_email: contractData.freelancerEmail,
                contract_id: contractData.contractId,
                role: contractData.role,
                location: contractData.location,
                rate: contractData.rate,
                signed_timestamp: new Date(contractData.signedTimestamp).toLocaleString(),
                portal_password_reference: `Password set for ${contractData.freelancerEmail} - Check admin dashboard for secure access`,
                
                // Contract PDF download link for admin (Firestore Storage)
                download_link: contractData?.uploadedContract?.fileUrl || 'Contract will be available in admin dashboard'
            };
            
            console.log('ðŸ“§ Sending admin notification email with template:', EMAILJS_CONFIG.templateId);
            console.log('ðŸ“§ Admin email params:', adminEmailParams);
            
            return emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, adminEmailParams);
        }
        
        // Generate PDF content 
        function generatePDFContent(contractData) {
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COCHRAN FILMS - ${contractData.freelancerName} Contract</title>
    <style>
        @page {
            margin: 0.5in;
            size: letter;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
        
        body {
            font-family: 'Georgia', serif;
            line-height: 1.4;
            color: #000000;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            padding: 0;
        }
        
        .header-banner {
            background: #FFB200;
            color: #000000;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header-banner h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .header-banner h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 5px 0 0 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .contract-details {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        
        .contract-id {
            font-size: 14px;
            color: #666666;
            margin-bottom: 10px;
        }
        
        .contractor-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 25px;
        }
        
        .info-column {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #FFB200;
        }
        
        .info-column h3 {
            font-size: 16px;
            color: #000000;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .info-item {
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: 600;
            color: #333333;
        }
        
        .info-value {
            color: #000000;
            font-weight: 500;
        }
        
        .terms-section {
            padding: 0 20px;
            margin-bottom: 25px;
        }
        
        .terms-section h3 {
            font-size: 20px;
            color: #000000;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .terms-list {
            list-style: decimal;
            padding-left: 20px;
            margin-bottom: 20px;
        }
        
        .terms-list li {
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .terms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .terms-column {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .terms-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        .separator-banner {
            background: #FFB200;
            color: #000000;
            padding: 15px;
            text-align: center;
            margin: 25px 0;
        }
        
        .separator-banner h3 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .signatures-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        
        .signatures-section h3 {
            font-size: 20px;
            color: #000000;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .signature-banner {
            background: #FFB200;
            color: #000000;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .signature-banner h3 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .signature-blocks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .signature-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .signature-block h4 {
            font-size: 16px;
            color: #000000;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .signature-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .signature-info strong {
            color: #333333;
        }
        
        .signature-line {
            border-bottom: 2px solid #FFB200;
            height: 30px;
            margin: 15px 0 10px 0;
        }
        
        @media (max-width: 600px) {
            .contractor-info {
                grid-template-columns: 1fr;
            }
            
            .signature-blocks {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Banner -->
        <div class="header-banner">
            <h1>COCHRAN FILMS</h1>
            <h2>FREELANCE CONTRACT AGREEMENT</h2>
        </div>
        
        <!-- Contract Details -->
        <div class="contract-details">
            <div class="contract-id">
                <strong>Contract ID:</strong> ${contractData.contractId} | <strong>Effective Date:</strong> ${contractData.effectiveDate}
            </div>
            
            <!-- Contractor Information -->
            <div class="contractor-info">
                <div class="info-column">
                    <h3>CONTRACTOR INFORMATION</h3>
                    <div class="info-item">
                        <span class="info-label">Name:</span>
                        <span class="info-value">${contractData.freelancerName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Role:</span>
                        <span class="info-value">${contractData.role}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Location:</span>
                        <span class="info-value">${contractData.location}</span>
                    </div>
                </div>
                
                <div class="info-column">
                    <h3>PROJECT DETAILS</h3>
                    <div class="info-item">
                        <span class="info-label">Email:</span>
                        <span class="info-value">${contractData.freelancerEmail}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Start Date:</span>
                        <span class="info-value">${contractData.projectStart}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rate:</span>
                        <span class="info-value">${contractData.rate}</span>
                    </div>
                </div>
            </div>
            
            <!-- Contract Terms -->
            <div class="terms-section">
                <h3>CONTRACT TERMS & CONDITIONS</h3>
                <div class="terms-grid">
                    <div class="terms-column">
                        <ol class="terms-list">
                            <li><strong>INDEPENDENT CONTRACTOR:</strong> Contractor is not an employee of Cochran Films.</li>
                            <li><strong>SERVICES:</strong> Provide professional ${contractData.role} services as specified.</li>
                            <li><strong>COMPENSATION:</strong> Payment within 24 hours of project completion.</li>
                            <li><strong>PROFESSIONAL STANDARDS:</strong> All work must meet Cochran Films quality standards.</li>
                            <li><strong>ATTIRE:</strong> Professional attire (all black) required on set.</li>
                            <li><strong>PUNCTUALITY:</strong> Arrive 15 minutes before scheduled start time.</li>
                            <li><strong>DOCUMENTATION:</strong> Bring valid ID and signed contract to all projects.</li>
                        </ol>
                    </div>
                    <div class="terms-column">
                        <ol class="terms-list" start="8">
                            <li><strong>EQUIPMENT:</strong> Use provided Cochran Films branded equipment when available.</li>
                            <li><strong>CONDUCT:</strong> Maintain professional demeanor and respect at all times.</li>
                            <li><strong>SAFETY:</strong> Follow all safety protocols and guidelines provided.</li>
                            <li><strong>CONFIDENTIALITY:</strong> Respect and maintain confidentiality of project details.</li>
                            <li><strong>TAX OBLIGATIONS:</strong> Contractor is responsible for all personal tax obligations.</li>
                            <li><strong>TRANSPORTATION:</strong> Contractor is responsible for their own transportation.</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <!-- Signatures Section -->
            <div class="signatures-section">
                <div class="signature-blocks">
                    <div class="signature-block">
                        <h4>COCHRAN FILMS (COMPANY)</h4>
                        <div class="signature-info">
                            <strong>Authorized Signature:</strong> Cody Cochran
                        </div>
                        <div class="signature-info">
                            <strong>Title:</strong> Founder & CEO
                        </div>
                        <div class="signature-info">
                            <strong>Date:</strong> ${contractData.effectiveDate}
                        </div>
                        <div class="signature-info">
                            <strong>Email:</strong> info@cochranfilms.com
                        </div>
                    </div>
                    
                    <div class="signature-block">
                        <h4>CONTRACTOR SIGNATURE</h4>
                        <div class="signature-info">
                            <strong>Contractor:</strong> ${contractData.freelancerName}
                        </div>
                        <div class="signature-info">
                            <strong>Signature:</strong> ${contractData.signature}
                        </div>
                        <div class="signature-info">
                            <strong>Date:</strong> ${contractData.signatureDate}
                        </div>
                        <div class="signature-info">
                            <strong>ID:</strong> ${contractData.contractId}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
            `.trim();
        }

        // Add enter key support for input fields only
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('freelancerName');
            const emailInput = document.getElementById('freelancerEmail');
            
            function handleEnterKey(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    // Small delay to prevent any race conditions
                    setTimeout(() => {
                        performAccessCheck();
                    }, 10);
                    return false;
                }
            }
            
            function handleInputChange(event) {
                // Only clear loading states occasionally, not on every keystroke
                // This prevents interference with normal typing
                clearTimeout(window.inputDebounceTimer);
                window.inputDebounceTimer = setTimeout(() => {
                    forceClearLoadingStates();
                }, 500); // Only run after user stops typing for 500ms
            }
            
            if (nameInput) {
                nameInput.addEventListener('keypress', handleEnterKey);
                // Only add input listener for debounced cleanup, not keyup
                nameInput.addEventListener('input', handleInputChange);
            }
            if (emailInput) {
                emailInput.addEventListener('keypress', handleEnterKey);
                // Only add input listener for debounced cleanup, not keyup
                emailInput.addEventListener('input', handleInputChange);
            }
        });




    </script>
</body>
</html> 

