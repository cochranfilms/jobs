<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Modular System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-result.success { background: #d4edda; color: #155724; }
        .test-result.error { background: #f8d7da; color: #721c24; }
        .test-result.warning { background: #fff3cd; color: #856404; }
        .test-result.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.success { background: #28a745; }
        .status-indicator.error { background: #dc3545; }
        .status-indicator.warning { background: #ffc107; }
        .status-indicator.info { background: #17a2b8; }
        .loading {
            color: #6c757d;
            font-style: italic;
        }
        .module-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .module-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        .module-card.success { border-color: #28a745; background: #d4edda; }
        .module-card.error { border-color: #dc3545; background: #f8d7da; }
        .module-card.warning { border-color: #ffc107; background: #fff3cd; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Complete Modular System Test</h1>
    <p>This page directly includes and tests all modular system components to verify the fixes work correctly.</p>

    <div class="test-section">
        <h2>ğŸ“‹ Test Controls</h2>
        <button onclick="runAllTests()">ğŸ§ª Run All Tests</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
        <button onclick="testSafetyTimeout()">â° Test Safety Timeout</button>
        <button onclick="testEmailJS()">ğŸ“§ Test EmailJS</button>
        <button onclick="testFirebaseConfig()">ğŸ”¥ Test Firebase Config</button>
        <button onclick="testAuthManager()">ğŸ” Test Auth Manager</button>
        <button onclick="checkDuplicateListeners()">ğŸ‘‚ Check Duplicate Listeners</button>
        <button onclick="testModularSystemInit()">ğŸš€ Test Modular System Init</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Module Status</h2>
        <div id="moduleStatus" class="module-status">
            <div class="module-card">
                <h4>Firebase Config</h4>
                <p id="firebaseStatus" class="loading">Loading...</p>
            </div>
            <div class="module-card">
                <h4>Auth Manager</h4>
                <p id="authStatus" class="loading">Loading...</p>
            </div>
            <div class="module-card">
                <h4>Admin Dashboard App</h4>
                <p id="appStatus" class="loading">Loading...</p>
            </div>
            <div class="module-card">
                <h4>Error Handler</h4>
                <p id="errorStatus" class="loading">Loading...</p>
            </div>
            <div class="module-card">
                <h4>Loading Manager</h4>
                <p id="loadingStatus" class="loading">Loading...</p>
            </div>
            <div class="module-card">
                <h4>Notification Manager</h4>
                <p id="notificationStatus" class="loading">Loading...</p>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ Console Output</h2>
        <div id="consoleOutput" class="console-output"></div>
    </div>

    <!-- Load Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- Load EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Load Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <!-- Load Modular System Components -->
    <script src="admin-dashboard-modular/js/utils/error-handler.js"></script>
    <script src="admin-dashboard-modular/js/utils/loading-manager.js"></script>
    <script src="admin-dashboard-modular/js/utils/notification-manager.js"></script>
    <script src="admin-dashboard-modular/js/config/firebase-config.js"></script>
    <script src="admin-dashboard-modular/js/auth/auth-manager.js"></script>
    <script src="admin-dashboard-modular/js/app.js"></script>

    <script>
        // Capture console output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalInfo = console.info;

        function captureConsole(type, ...args) {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const message = `[${timestamp}] ${type.toUpperCase()}: ${args.join(' ')}\n`;
            output.textContent += message;
            output.scrollTop = output.scrollHeight;
        }

        console.log = (...args) => {
            captureConsole('log', ...args);
            originalLog.apply(console, args);
        };

        console.error = (...args) => {
            captureConsole('error', ...args);
            originalError.apply(console, args);
        };

        console.warn = (...args) => {
            captureConsole('warn', ...args);
            originalWarn.apply(console, args);
        };

        console.info = (...args) => {
            captureConsole('info', ...args);
            originalInfo.apply(console, args);
        };

        // Test functions
        function addTestResult(testName, status, message) {
            const results = document.getElementById('testResults');
            const statusClass = status === 'success' ? 'success' : 
                              status === 'error' ? 'error' : 
                              status === 'warning' ? 'warning' : 'info';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${statusClass}`;
            resultDiv.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                <strong>${testName}:</strong> ${message}
            `;
            results.appendChild(resultDiv);
        }

        function updateModuleStatus(moduleId, message, type = 'info') {
            const statusElement = document.getElementById(moduleId);
            if (statusElement) {
                const statusClass = type === 'success' ? 'success' : 
                                  type === 'error' ? 'error' : 
                                  type === 'warning' ? 'warning' : 'info';
                
                statusElement.textContent = message;
                statusElement.className = statusClass;
                
                // Update parent card styling
                const card = statusElement.closest('.module-card');
                if (card) {
                    card.className = `module-card ${statusClass}`;
                }
            }
        }

        function testSafetyTimeout() {
            console.log('ğŸ§ª Testing Safety Timeout Fix...');
            
            try {
                if (typeof AdminDashboardApp !== 'undefined') {
                    console.log('âœ… AdminDashboardApp found');
                    if (AdminDashboardApp.safetyTimeout !== undefined) {
                        console.log('âœ… safetyTimeout property exists');
                        addTestResult('Safety Timeout', 'success', 'AdminDashboardApp.safetyTimeout property exists and is properly defined');
                    } else {
                        console.log('âŒ safetyTimeout property missing');
                        addTestResult('Safety Timeout', 'error', 'safetyTimeout property missing from AdminDashboardApp');
                    }
                } else {
                    console.log('âŒ AdminDashboardApp not found');
                    addTestResult('Safety Timeout', 'error', 'AdminDashboardApp not found - modular system failed to load');
                }
            } catch (error) {
                console.error('âŒ Safety timeout test failed:', error);
                addTestResult('Safety Timeout', 'error', `Test failed with error: ${error.message}`);
            }
        }

        function testEmailJS() {
            console.log('ğŸ§ª Testing EmailJS Test Function...');
            
            try {
                if (typeof testEmailJS === 'function') {
                    console.log('âœ… testEmailJS function exists');
                    
                    // Check if testParams is properly defined in the function
                    const functionStr = testEmailJS.toString();
                    if (functionStr.includes('const testParams = {')) {
                        console.log('âœ… testParams properly defined in function');
                        addTestResult('EmailJS Test Function', 'success', 'testEmailJS function exists with properly defined testParams');
                    } else {
                        console.log('âŒ testParams not properly defined');
                        addTestResult('EmailJS Test Function', 'error', 'testParams not properly defined in testEmailJS function');
                    }
                } else {
                    console.log('âš ï¸ testEmailJS function not found (may not be loaded yet)');
                    addTestResult('EmailJS Test Function', 'warning', 'testEmailJS function not found - may need to wait for page load');
                }
            } catch (error) {
                console.error('âŒ EmailJS test function check failed:', error);
                addTestResult('EmailJS Test Function', 'error', `Test failed with error: ${error.message}`);
            }
        }

        function testFirebaseConfig() {
            console.log('ğŸ§ª Testing Firebase Configuration...');
            
            try {
                if (window.FirebaseConfig) {
                    console.log('âœ… FirebaseConfig found');
                    
                    if (typeof window.FirebaseConfig.waitForInit === 'function') {
                        console.log('âœ… waitForInit method exists');
                        addTestResult('Firebase Configuration', 'success', 'FirebaseConfig found with waitForInit method');
                    } else {
                        console.log('âŒ waitForInit method missing');
                        addTestResult('Firebase Configuration', 'error', 'waitForInit method missing from FirebaseConfig');
                    }
                    
                    if (window.FirebaseConfig.isInitialized) {
                        console.log('âœ… Firebase is initialized');
                        addTestResult('Firebase Status', 'success', 'Firebase is properly initialized');
                    } else {
                        console.log('âš ï¸ Firebase not yet initialized');
                        addTestResult('Firebase Status', 'warning', 'Firebase not yet initialized - may need to wait');
                    }
                } else {
                    console.log('âŒ FirebaseConfig not found');
                    addTestResult('Firebase Configuration', 'error', 'FirebaseConfig not found - modular system failed to load');
                }
            } catch (error) {
                console.error('âŒ Firebase configuration check failed:', error);
                addTestResult('Firebase Configuration', 'error', `Test failed with error: ${error.message}`);
            }
        }

        function testAuthManager() {
            console.log('ğŸ§ª Testing Auth Manager Configuration...');
            
            try {
                if (window.AuthManager) {
                    console.log('âœ… AuthManager found');
                    
                    if (window.AuthManager.isHandlingAuth !== undefined) {
                        console.log('âœ… isHandlingAuth property exists');
                        addTestResult('Auth Manager', 'success', 'AuthManager found with isHandlingAuth property');
                    } else {
                        console.log('âŒ isHandlingAuth property missing');
                        addTestResult('Auth Manager', 'error', 'isHandlingAuth property missing from AuthManager');
                    }
                } else {
                    console.log('âŒ AuthManager not found');
                    addTestResult('Auth Manager', 'error', 'AuthManager not found - modular system failed to load');
                }
            } catch (error) {
                console.error('âŒ AuthManager check failed:', error);
                addTestResult('Auth Manager', 'error', `Test failed with error: ${error.message}`);
            }
        }

        function checkDuplicateListeners() {
            console.log('ğŸ” Checking for Duplicate Auth Listeners...');
            
            // This is a manual check - look for multiple onAuthStateChanged calls in console
            console.log('ğŸ” Check console for multiple "Firebase auth state observer setup complete" messages');
            console.log('ğŸ” Should see only one auth setup message per component');
            
            addTestResult('Duplicate Listeners', 'info', 'Manual check required - monitor console for multiple auth setup messages');
        }

        function testModularSystemInit() {
            console.log('ğŸš€ Testing Modular System Initialization...');
            
            try {
                if (typeof AdminDashboardApp !== 'undefined' && typeof AdminDashboardApp.init === 'function') {
                    console.log('âœ… AdminDashboardApp.init method found');
                    
                    // Try to initialize (but don't wait for completion to avoid blocking)
                    try {
                        AdminDashboardApp.init().catch(error => {
                            console.warn('âš ï¸ AdminDashboardApp.init had issues (this may be expected):', error);
                        });
                        addTestResult('Modular System Init', 'success', 'AdminDashboardApp.init method called successfully');
                    } catch (error) {
                        console.warn('âš ï¸ AdminDashboardApp.init threw error (this may be expected):', error);
                        addTestResult('Modular System Init', 'warning', `Init method called but had issues: ${error.message}`);
                    }
                } else {
                    console.log('âŒ AdminDashboardApp.init method not found');
                    addTestResult('Modular System Init', 'error', 'AdminDashboardApp.init method not found');
                }
            } catch (error) {
                console.error('âŒ Modular system init test failed:', error);
                addTestResult('Modular System Init', 'error', `Test failed with error: ${error.message}`);
            }
        }

        function runAllTests() {
            console.log('ğŸš€ Running All Tests...');
            clearResults();
            
            // Run tests with slight delays to ensure proper loading
            setTimeout(testSafetyTimeout, 100);
            setTimeout(testEmailJS, 200);
            setTimeout(testFirebaseConfig, 300);
            setTimeout(testAuthManager, 400);
            setTimeout(checkDuplicateListeners, 500);
            setTimeout(testModularSystemInit, 600);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('consoleOutput').textContent = '';
        }

        function checkModuleStatus() {
            console.log('ğŸ” Checking module status...');
            
            // Check Firebase Config
            if (window.FirebaseConfig) {
                updateModuleStatus('firebaseStatus', 'âœ… Loaded', 'success');
            } else {
                updateModuleStatus('firebaseStatus', 'âŒ Not found', 'error');
            }
            
            // Check Auth Manager
            if (window.AuthManager) {
                updateModuleStatus('authStatus', 'âœ… Loaded', 'success');
            } else {
                updateModuleStatus('authStatus', 'âŒ Not found', 'error');
            }
            
            // Check Admin Dashboard App
            if (typeof AdminDashboardApp !== 'undefined') {
                updateModuleStatus('appStatus', 'âœ… Loaded', 'success');
            } else {
                updateModuleStatus('appStatus', 'âŒ Not found', 'error');
            }
            
            // Check Error Handler
            if (window.ErrorHandler) {
                updateModuleStatus('errorStatus', 'âœ… Loaded', 'success');
            } else {
                updateModuleStatus('errorStatus', 'âŒ Not found', 'error');
            }
            
            // Check Loading Manager
            if (window.LoadingManager) {
                updateModuleStatus('loadingStatus', 'âœ… Loaded', 'success');
            } else {
                updateModuleStatus('loadingStatus', 'âŒ Not found', 'error');
            }
            
            // Check Notification Manager
            if (window.NotificationManager) {
                updateModuleStatus('notificationStatus', 'âœ… Loaded', 'success');
            } else {
                updateModuleStatus('notificationStatus', 'âŒ Not found', 'error');
            }
        }

        // Auto-check module status when page loads
        window.addEventListener('load', () => {
            console.log('ğŸ§ª Page loaded, checking module status...');
            setTimeout(checkModuleStatus, 1000);
            setTimeout(runAllTests, 2000);
        });
    </script>
</body>
</html>
