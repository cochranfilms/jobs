<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Cochran Films</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://static.wixstatic.com/media/aeef42_570164eee75f4394a4fc1cf9c62ceae0~mv2.png" type="image/png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" referrerpolicy="no-referrer">
    
    <!-- EmailJS for automated emails -->
    <script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- JSZip for contract file generation (remove if unused) -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration and Data Manager -->
    <script defer src="firebase-config.js"></script>
    <script defer src="firestore-data-manager.js"></script>
    <script defer src="firestore-integration.js"></script>
    
    <!-- Secure Bank Storage -->
    <script defer src="secure-bank-storage.js"></script>
    <script defer src="admin-bank-viewer.js"></script>
    
    <!-- Messaging Service -->
    <script defer src="messaging-service.js"></script>
    
    <!-- Modular System CSS -->
    <link rel="stylesheet" href="admin-dashboard-modular/css/main.css">
    <link rel="stylesheet" href="admin-dashboard-modular/css/components.css">
    
    <style>
        :root {
            --primary: #ffbf34;               /* modern gold */
            --primary-dark: #ff9900;
            --gold: #ffd76a;
            --accent: #7dd3fc;                /* subtle neon blue accent */
            --black: #000000;
            --white: #ffffff;
            --gray-light: #f8f9fa;
            --gray-medium: #9ca3af;
            --gray-dark: #1f2937;
            --border-radius: 14px;
            --card-bg: rgba(0,0,0,0.78);
            --glass: rgba(255,255,255,0.04);
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
            --shadow-hover: 0 18px 48px rgba(0,0,0,0.45);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            position: relative;
        }
        
        .login-container {
            background: rgba(0, 0, 0, 0.8);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 450px;
            width: 100%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,178,0,0.3);
        }
        
        .login-logo {
            width: 140px;
            height: auto;
            margin-bottom: 2rem;
            filter: drop-shadow(0 0 3px #FFB200);
        }
        
        .login-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #FFB200;
            margin-bottom: 1rem;
        }
        
        .login-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #FFB200;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,178,0,0.4);
        }
        

        
        /* Dashboard Layout */
        .dashboard {
            display: none;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .dashboard-header {
            background: linear-gradient(180deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.6) 100%);
            padding: 2rem;
            border-radius: 18px;
            margin-bottom: 2rem;
            text-align: center;
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255,178,0,0.25);
            box-shadow: var(--shadow);
        }
        
        .dashboard-header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFB200;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-header p {
            color: rgba(255,255,255,0.8);
            font-size: 1.1rem;
        }
        
        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: #FFB200;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255,178,0,0.25);
            box-shadow: var(--shadow);
            transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-hover);
            border-color: rgba(255,178,0,0.45);
        }
        
        .stat-icon {
            font-size: 3rem;
            color: #FFB200;
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFB200;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.8);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Main Content Grid */
        .content-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .content-row {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .content-card {
            flex: 1;
            min-width: 400px;
        }
        
        .content-card {
            background: var(--card-bg);
            border-radius: 18px;
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255,178,0,0.22);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            background: linear-gradient(180deg, rgba(255,178,0,0.14) 0%, rgba(255,178,0,0.06) 100%);
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,178,0,0.28);
        }

        /* ==================== PERFORMANCE MANAGEMENT STYLES ==================== */
        .performance-overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-mini {
            background: rgba(255, 178, 0, 0.1);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-mini-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFB200;
            font-family: 'Cinzel', serif;
        }

        .stat-mini-label {
            display: block;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.25rem;
        }

        .performance-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .performance-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Community Management Styles */
        .community-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .moderation-tools,
        .showcase-management,
        .event-management,
        .success-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .setting-item label {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .setting-item input,
        .setting-item select {
            padding: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .moderation-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .community-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .tool-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .tool-item h4 {
            color: #FFB200;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .tool-item p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .application-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .application-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .application-filters select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 6px;
            color: white;
            padding: 0.5rem;
            font-size: 0.9rem;
            flex: 1;
        }

        .application-filters select:focus {
            outline: none;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
        }

        .applications-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .application-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .application-info h4 {
            color: white;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .application-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .application-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-accepted {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Mobile Responsive for Performance Management */
        @media (max-width: 768px) {
            .performance-overview-stats,
            .application-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .performance-tools {
                grid-template-columns: 1fr;
            }

            .application-filters {
                flex-direction: column;
            }

            .performance-actions {
                flex-direction: column;
            }
        }
        
        .card-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: #FFB200;
            margin: 0;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        /* Form Styles */
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h3 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--gold));
            color: #0b0b0b;
            border: none;
            padding: 0.9rem 1.6rem;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            margin-right: 0.75rem;
            transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
            text-transform: uppercase;
            letter-spacing: .9px;
            box-shadow: 0 8px 20px rgba(255,191,52,0.25);
        }
        
        .btn:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 12px 26px rgba(255,191,52,0.35);
        }
        
        .btn-secondary {
            background: rgba(255,178,0,0.12);
            color: var(--primary);
            border: 1px solid rgba(255,178,0,0.35);
        }
        
        /* List Styles */
        .item-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .item-card {
            border: 1px solid rgba(255,178,0,0.3);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        
        .item-card:hover {
            border-color: #FFB200;
            transform: translateY(-2px);
        }
        
        .item-card h4 {
            color: #FFB200;
            margin-bottom: 0.5rem;
        }
        
        .item-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            flex-wrap: wrap;
        }
        
        .item-actions {
            margin-top: 1rem;
        }
        
        .item-description {
            margin: 1rem 0;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
            font-size: 0.9rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Command Palette */
        .cmdk-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(4px); z-index: 11000; display: none; }
        .cmdk { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: 680px; max-width: calc(100% - 32px); background: rgba(12,12,12,0.9); border: 1px solid rgba(255,178,0,0.25); border-radius: 14px; box-shadow: var(--shadow-hover); z-index: 11001; display: none; }
        .cmdk-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,178,0,0.2); display: flex; gap: 8px; align-items: center; }
        .cmdk-header input { flex: 1; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,178,0,0.24); color: #fff; border-radius: 8px; outline: none; }
        .cmdk-list { max-height: 360px; overflow: auto; }
        .cmdk-item { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cmdk-item:hover { background: rgba(255,178,0,0.08); }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .login-container {
                margin: 1rem;
                padding: 2rem;
            }
        }
        
        /* Loading Indicator Styles */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 178, 0, 0.3);
            border-top: 4px solid #FFB200;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        .loading-text {
            color: #FFB200;
            font-weight: 600;
            text-align: center;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==================== MESSAGING SYSTEM STYLES ==================== */
        .messaging-container {
            display: flex;
            height: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: visible; /* allow inline popups to render fully */
        }

        .conversations-panel {
            width: 350px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            position: relative; /* anchor for inline popup */
        }

        .conversations-header {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px; /* ensure space when items get close */
            flex-wrap: wrap;
        }

        .conversations-header h3 {
            margin: 0;
            color: var(--white);
            font-size: 1.1rem;
        }

        /* Refine new message button sizing and padding */
        .conversations-header .btn.btn-primary {
            padding: 0.6rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            box-shadow: 0 10px 24px rgba(34,211,238,0.12), 0 4px 10px rgba(167,139,250,0.12);
        }

        /* Inline user picker (AI theme) */
        .user-picker {
            position: absolute;
            top: 70px;
            left: 12px;
            width: 340px;
            max-height: 420px;
            background: rgba(17,24,39,0.92);
            border: 1px solid rgba(99,102,241,0.30);
            border-radius: 14px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.45), 0 0 0 1px rgba(99,102,241,0.10) inset;
            overflow: hidden;
            z-index: 12000;
        }
        .user-picker.hidden { display: none; }
        .user-picker .up-header { display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid rgba(255,255,255,0.08); }
        .user-picker .up-header input { flex:1; height:40px; border-radius:12px; border:1px solid rgba(99,102,241,0.25); background: rgba(12,18,32,0.65); color:#e5e7eb; padding:0 12px; }
        .user-picker .up-list { max-height: 340px; overflow:auto; }
        .user-picker .up-item { display:flex; align-items:center; gap:12px; padding:12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.06); }
        .user-picker .up-item:hover { background: rgba(99,102,241,0.10); }
        .user-picker .up-avatar { width:32px; height:32px; border-radius:50%; display:grid; place-items:center; background: linear-gradient(135deg,#22d3ee,#a78bfa); color:#0b1020; font-weight:800; font-size:.9rem; }
        .user-picker .up-meta { display:flex; flex-direction:column; }
        .user-picker .up-meta .name { color:#eef2ff; font-weight:700; font-size:.92rem; }
        .user-picker .up-meta .email { color:#c7d2fe; opacity:.85; font-size:.82rem; }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .conversation-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,178,0,0.3);
        }

        .conversation-item.active {
            background: rgba(255,178,0,0.1);
            border-color: var(--primary);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .conversation-participant {
            font-weight: 600;
            color: var(--white);
            font-size: 0.9rem;
        }

        .conversation-time {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .conversation-preview {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-job {
            font-size: 0.75rem;
            color: var(--primary);
            background: rgba(255,178,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .unread-badge {
            background: var(--primary);
            color: var(--black);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.2);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
        }

        .chat-participant-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--black);
            font-size: 1.1rem;
        }

        .participant-details h4 {
            margin: 0;
            color: var(--white);
            font-size: 1rem;
        }

        .status-online {
            font-size: 0.8rem;
            color: #4ade80;
        }

        .status-offline {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255,255,255,0.5);
            text-align: center;
        }

        .empty-chat i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: messageSlideIn 0.3s ease;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: var(--primary);
            color: var(--black);
            border-bottom-right-radius: 4px;
        }

        .message.received .message-content {
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .message-text {
            line-height: 1.4;
        }

        .message-attachments {
            margin-top: 0.5rem;
        }

        .attachment-item {
            display: inline-block;
            margin: 0.25rem 0.25rem 0 0;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .attachment-item img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
        }

        .attachment-item a {
            color: var(--primary);
            text-decoration: none;
        }

        .message-status {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.25rem;
            font-size: 0.7rem;
        }

        .status-sent { color: rgba(255,255,255,0.5); }
        .status-delivered { color: rgba(255,255,255,0.7); }
        .status-read { color: var(--primary); }

        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            position: relative;
        }

        .attachment-btn {
            padding: 0.75rem;
            border-radius: 50%;
            min-width: auto;
        }

        .attachment-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .attachment-menu button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--white);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .attachment-menu button:hover {
            background: rgba(255,255,255,0.1);
        }

        .message-input-container {
            flex: 1;
            display: flex;
            align-items: flex-end;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 0.5rem;
        }

        #adminMessageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--white);
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 120px;
        }

        #adminMessageInput::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .send-btn {
            padding: 0.75rem;
            border-radius: 50%;
            min-width: auto;
            margin-left: 0.5rem;
        }

        .attachments-preview {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .attachment-preview {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .attachment-preview img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .attachment-preview button {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Animations */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .messaging-container {
                height: 500px;
            }
            
            .conversations-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            
            .chat-panel {
                display: none;
            }
            
            .chat-panel.active {
                display: flex;
            }
        }
    </style>
    <script>
        // Lightweight AI theme layer (scoped to .ai-theme to avoid breaking existing styles)
        (function(){
            try {
                document.documentElement.classList.add('ai-theme');
                document.body.classList.add('ai-theme');
            } catch(_) {}
        })();
    </script>
    <style>
        .ai-theme body {
            background: radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,0.15), transparent 60%),
                        radial-gradient(1000px 500px at 100% 0%, rgba(167,139,250,0.12), transparent 60%),
                        #0b1020;
        }
        .ai-theme .dashboard-header h1,
        .ai-theme .dashboard-header p { color: #eaf0ff; }
        .ai-theme .card,
        .ai-theme .messaging-container,
        .ai-theme .conversations-panel,
        .ai-theme .chat-panel { 
            background: rgba(17,24,39,0.78) !important; 
            border: 1px solid rgba(99,102,241,0.28) !important;
            box-shadow: 0 30px 80px rgba(0,0,0,0.45), 0 0 0 1px rgba(99,102,241,0.10) inset !important;
        }
        .ai-theme .btn.btn-primary { 
            background: linear-gradient(135deg, #22d3ee, #a78bfa) !important; 
            color: #0b1020 !important; 
            border: 0 !important;
        }
        .ai-theme .btn.btn-secondary { 
            background: rgba(99,102,241,0.16) !important; 
            color: #c7d2fe !important; 
            border: 1px solid rgba(99,102,241,0.35) !important; 
        }
        .ai-theme .message-input-container { 
            background: rgba(12,18,32,0.55) !important; 
            border: 1px solid rgba(99,102,241,0.25) !important; 
        }
        .ai-theme .conversation-item.active { 
            background: rgba(99,102,241,0.18) !important; 
            border-color: rgba(99,102,241,0.35) !important; 
        }
    </style>
</head>
<body>
    <!-- Global Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <img src="Logo.png" alt="Cochran Films" class="login-logo" width="140" height="140" loading="lazy" decoding="async">
            <h1 class="login-title">‚öôÔ∏è Admin Dashboard</h1>
            <p class="login-subtitle">Manage jobs and contracts from one central location</p>
            

            
            <form class="login-form" id="mainDashboardLoginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">üîê Login</button>
                
                
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="dashboard-header" style="position: relative;">
            <a href="#" class="logout-btn" onclick="logout()">üö™ Logout</a>
            <h1>‚öôÔ∏è Admin Dashboard</h1>
            <p>Cochran Films - Central Management System</p>
            
            <!-- Manual refresh button for troubleshooting -->
            <!-- Removed manual refresh button per new UX -->
            
            <!-- Modular System Status -->
            <div id="modularSystemStatus" style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,178,0,0.1); border-radius: 8px; border: 1px solid rgba(255,178,0,0.3);">
                <span style="color: #FFB200; font-weight: 600;">
                    <i class="fas fa-cube"></i> Modular System: 
                    <span id="modularStatusText">Loading...</span>
                </span>
            </div>
            <!-- Notifications Bell -->
            <div id="notificationBell" style="position:absolute; top:1rem; left:1rem; cursor:pointer;">
                <span style="position:relative; display:inline-block; padding:8px 10px; border:1px solid rgba(255,178,0,0.3); border-radius:8px; background:rgba(0,0,0,0.3);">
                    <i class="fas fa-bell" style="color:#FFB200; font-size:18px;"></i>
                    <span id="notificationBadge" style="position:absolute; top:-6px; right:-6px; background:#ef4444; color:#fff; border-radius:999px; padding:2px 6px; font-size:10px; font-weight:700; display:none;">0</span>
                </span>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalCreators">0</div>
                <div class="stat-label">Total Creators</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-number" id="activeJobs">0</div>
                <div class="stat-label">Active Jobs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üóÇÔ∏è</div>
                <div class="stat-number" id="totalJobs">0</div>
                <div class="stat-label">All Jobs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÑ</div>
                <div class="stat-number" id="pendingReviews">0</div>
                <div class="stat-label">Pending Reviews</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-number" id="totalContracts">0</div>
                <div class="stat-label">Signed Contracts</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Row 1: User Management and Job Management -->
            <div class="content-row">
                <!-- Unified User & Contract Management -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üë• User & Contract Management</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Add New User</h3>
                            <form id="contractForm">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <input type="text" id="freelancerName" name="name" placeholder="Full Name" required>
                                    <input type="email" id="freelancerEmail" name="email" placeholder="Email Address" required>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <input type="text" id="freelancerRole" name="role" placeholder="Role" required>
                                    <select id="freelancerLocation" name="location" required>
                                        <option value="">Select Location...</option>
                                        <!-- Populated with locations from dropdown-options.json -->
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                                    <select id="freelancerJob" name="jobSelection">
                                        <option value="">Select Job (from Firestore)...</option>
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                                    <select id="freelancerProjectType" name="projectType">
                                        <option value="">Select Project Type...</option>
                                        <!-- Populated with projectTypes from dropdown-options.json -->
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <select id="freelancerRate" name="rate" required>
                                        <option value="">Select Rate...</option>
                                        <!-- Populated with rates from dropdown-options.json -->
                                    </select>
                                    <div>
                                        <label for="approvedDate" style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Approved Date</label>
                                        <input type="date" id="approvedDate" name="approvedDate" placeholder="Approved Date">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label for="projectDate" style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Project Start Date</label>
                                        <input type="date" id="projectDate" name="projectDate" placeholder="Project Start Date">
                                    </div>
                                    <div>
                                        <label for="contractUrl" style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Contract URL</label>
                                        <input type="text" id="contractUrl" name="contractUrl" placeholder="contract.html" value="contract.html" readonly style="background: rgba(255,255,255,0.1);">
                                        <small style="color: rgba(255,255,255,0.7); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                            üìù All creators use the same contract.html portal. No individual files needed!
                                        </small>
                                    </div>
                                </div>
                                <button type="submit" class="btn">Save User</button>
                                <button type="button" class="btn btn-secondary" onclick="clearContractForm()">Clear</button>
                            </form>
                        </div>
                        
                        
                        
                        <div class="form-section">
                            <h3>Current Users & Contracts</h3>
                            <div class="item-list" id="usersList">
                                <!-- Users will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Contract Management</h3>
                            <div class="item-list" id="contractsList">
                                <!-- Contracts will be loaded here -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Archived Applicants</h3>
                            <div class="item-list" id="archivedUsersList">
                                <!-- Archived users will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Job Management -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üìã Job Management</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Add New Job</h3>
                            <form id="jobForm">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <input type="text" id="jobTitle" name="title" placeholder="Job Title‚Ä¶" required>
                                    <input type="date" id="jobDate" name="date" placeholder="Event Date">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <select id="jobLocation" name="location">
                                        <option value="">Select Location‚Ä¶</option>
                                    </select>
                                    <select id="jobPay" name="pay">
                                        <option value="">Select Rate‚Ä¶</option>
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <select id="jobType" name="type">
                                        <option value="">Select Project Type‚Ä¶</option>
                                    </select>
                                    <select id="jobStatus" name="status">
                                        <option value="Active">Active</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="jobExclusive" name="exclusive" style="transform: scale(1.2);">
                                        <label for="jobExclusive" style="color: #FFB200; font-weight: 600; cursor: pointer;">
                                            <i class="fas fa-crown"></i> Exclusive Job (Priority Contractors Only)
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="jobPriority" name="priority" checked style="transform: scale(1.2);">
                                        <label for="jobPriority" style="color: #FFB200; font-weight: 600; cursor: pointer;">
                                            <i class="fas fa-star"></i> Priority Job (Show in User Portal)
                                        </label>
                                    </div>
                                </div>
                                <textarea id="jobDescription" name="description" placeholder="Job Description" rows="3"></textarea>
                                <div class="form-actions">
                                    <button type="submit" class="btn">‚ûï Add Job</button>
                                    <button type="button" class="btn btn-secondary" onclick="clearJobForm()">üîÑ Clear</button>
                                    <button type="button" class="btn btn-secondary" onclick="assignJobsToUsers()">üéØ Assign to Users</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="form-section">
                            <h3>Job Management Tools</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <!-- Removed colorful legacy tools per new UX; minimal surface here -->
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Current Jobs</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select id="jobFilter" onchange="filterJobs()" style="width: auto; margin: 0;">
                                        <option value="all">All Jobs</option>
                                        <option value="Active">Active</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                    <!-- Refresh buttons removed; realtime Firestore updates handle changes -->
                                </div>
                            </div>
                            <div class="item-list" id="jobsList">
                                <!-- Jobs will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Dropdown Management -->
            <div class="content-row">
                <!-- Dropdown Management -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è Dropdown Management</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Manage Dropdown Options</h3>
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;">
                                Add or remove options for roles, locations, rates, and project types used throughout the system.
                            </p>
                            
                            <!-- Roles Management removed by design: roles are free-text per user and not centrally managed -->
                            
                            <!-- Locations Management -->
                            <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                                <h4 style="color: #FFB200; margin-bottom: 0.5rem;">üìç Locations</h4>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="text" id="newLocation" placeholder="Add new location" style="flex: 1;">
                                    <button onclick="addDropdownOption('locations', 'newLocation')" style="background: #22c55e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                                <div id="locationsList" style="max-height: 150px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Rates Management -->
                            <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                                <h4 style="color: #FFB200; margin-bottom: 0.5rem;">üí∞ Rates</h4>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="text" id="newRate" placeholder="Add new rate" style="flex: 1;">
                                    <button onclick="addDropdownOption('rates', 'newRate')" style="background: #22c55e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                                <div id="ratesList" style="max-height: 150px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Project Types Management -->
                            <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                                <h4 style="color: #FFB200; margin-bottom: 0.5rem;">üé¨ Project Types</h4>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="text" id="newProjectType" placeholder="Add new project type" style="flex: 1;">
                                    <button onclick="addDropdownOption('projectTypes', 'newProjectType')" style="background: #22c55e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                                <div id="projectTypesList" style="max-height: 150px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Save Button -->
                            <div style="text-align: center; margin-top: 1.5rem;">
                                <button onclick="saveDropdownOptions()" style="background: linear-gradient(135deg, #FFB200, #FF8C00); color: #1a1a1a; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                                    <i class="fas fa-save"></i> Save All Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Portfolio Builder Entry -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üß∞ Portfolio Builder</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Create and Manage Creator Portfolios</h3>
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;">
                                Launch the Portfolio Builder to upload work samples, generate AI-driven themes, and publish professional creator galleries.
                            </p>
                            <div class="form-actions">
                                <a class="btn" href="/portfolio-builder.html" target="_blank" rel="noopener">
                                    üöÄ Open Portfolio Builder
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Performance Management -->
            <div class="content-row">
                <!-- Performance Analytics -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üìä Performance Analytics</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Contractor Performance Overview</h3>
                            <div class="performance-overview-stats">
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalContractors">0</span>
                                    <span class="stat-mini-label">Total Contractors</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="activeContractors">0</span>
                                    <span class="stat-mini-label">Active</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="avgRating">0.0</span>
                                    <span class="stat-mini-label">Avg Rating</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalEarnings">$0</span>
                                    <span class="stat-mini-label">Total Paid</span>
                                </div>
                            </div>
                            
                            <div class="performance-actions">
                                <button onclick="refreshPerformanceData()" class="btn">
                                    <i class="fas fa-sync-alt"></i> Refresh Data
                                </button>
                                <button onclick="exportPerformanceReport()" class="btn btn-secondary">
                                    <i class="fas fa-download"></i> Export Report
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Performance Management Tools</h3>
                            <div class="performance-tools">
                                <div class="tool-item">
                                    <h4>Rate Contractor</h4>
                                    <p>Add performance reviews and ratings</p>
                                    <button onclick="openRatingModal()" class="btn btn-small">
                                        <i class="fas fa-star"></i> Rate Contractor
                                    </button>
                                </div>
                                <div class="tool-item">
                                    <h4>View Performance</h4>
                                    <p>Review detailed performance analytics</p>
                                    <button onclick="viewPerformanceDetails()" class="btn btn-small">
                                        <i class="fas fa-chart-line"></i> View Details
                                    </button>
                                </div>
                                <div class="tool-item">
                                    <h4>Performance Alerts</h4>
                                    <p>Set up performance monitoring</p>
                                    <button onclick="setupPerformanceAlerts()" class="btn btn-small">
                                        <i class="fas fa-bell"></i> Setup Alerts
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Management -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üìù Application Management</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Job Applications Overview</h3>
                            <div class="application-stats">
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalApplications">0</span>
                                    <span class="stat-mini-label">Total Applications</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="pendingApplications">0</span>
                                    <span class="stat-mini-label">Pending Review</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="acceptedApplications">0</span>
                                    <span class="stat-mini-label">Accepted</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="rejectedApplications">0</span>
                                    <span class="stat-mini-label">Rejected</span>
                                </div>
                            </div>
                            
                            <div class="application-filters">
                                <select id="applicationStatusFilter" onchange="filterApplications()">
                                    <option value="">All Applications</option>
                                    <option value="pending">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <select id="applicationJobFilter" onchange="filterApplications()">
                                    <option value="">All Jobs</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Recent Applications</h3>
                            <div class="applications-list" id="adminApplicationsList">
                                <!-- Applications will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 4: Equipment & Resource Center (Admin) -->
            <div class="content-row">
                <!-- Equipment Inventory -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üéí Equipment Inventory</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Add / Update Equipment</h3>
                            <form id="adminEquipmentForm" onsubmit="return adminSaveEquipment(event)">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                    <input type="text" id="equipName" placeholder="Name" required>
                                    <input type="text" id="equipCategory" placeholder="Category (Camera, Light, etc.)">
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                    <input type="text" id="equipSerial" placeholder="Serial Number">
                                    <select id="equipStatus">
                                        <option value="available">Available</option>
                                        <option value="checked_out">Checked Out</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="retired">Retired</option>
                                    </select>
                                </div>
                                <input type="text" id="equipTags" placeholder="Tags (comma separated)">
                                <input type="text" id="equipLocation" placeholder="Location (e.g., Warehouse)">
                                <textarea id="equipNotes" rows="2" placeholder="Notes"></textarea>
                                <input type="hidden" id="equipId">
                                <div class="form-actions">
                                    <button type="submit" class="btn">üíæ Save</button>
                                    <button type="button" class="btn btn-secondary" onclick="adminClearEquipmentForm()">üîÑ Clear</button>
                                </div>
                            </form>
                        </div>
                        <div class="form-section">
                            <h3>Inventory</h3>
                            <div class="item-list" id="adminEquipmentList"></div>
                        </div>
                    </div>
                </div>

                <!-- Resource Downloads -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üìö Resource Downloads</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Add Resource</h3>
                            <form id="adminResourceForm" onsubmit="return adminSaveResource(event)">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                    <input type="text" id="resourceTitle" placeholder="Title" required>
                                    <input type="text" id="resourceType" placeholder="Type (template, style guide, etc.)">
                                </div>
                                <input type="url" id="resourceUrl" placeholder="URL (https://...)" required>
                                <input type="text" id="resourceTags" placeholder="Tags (comma separated)">
                                <input type="text" id="resourceVersion" placeholder="Version (e.g., 1.0.0)">
                                <input type="hidden" id="resourceId">
                                <div class="form-actions">
                                    <button type="submit" class="btn">‚ûï Add / Save</button>
                                    <button type="button" class="btn btn-secondary" onclick="adminClearResourceForm()">üîÑ Clear</button>
                                </div>
                            </form>
                        </div>
                        <div class="form-section">
                            <h3>Resources</h3>
                            <div class="item-list" id="adminResourceList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-row">
                <!-- Equipment Requests -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üìù Equipment Requests</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Pending / Recent Requests</h3>
                            <div class="item-list" id="adminEquipmentRequests"></div>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Schedule -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üõ†Ô∏è Maintenance</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Schedule Maintenance</h3>
                            <form id="adminMaintenanceForm" onsubmit="return adminScheduleMaintenance(event)">
                                <input type="text" id="maintTitle" placeholder="Title" required>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                    <input type="date" id="maintDate" required>
                                    <input type="text" id="maintEquipmentId" placeholder="Equipment ID (optional)">
                                </div>
                                <input type="text" id="maintAssignee" placeholder="Assignee Email (optional)">
                                <textarea id="maintNotes" rows="2" placeholder="Notes"></textarea>
                                <div class="form-actions">
                                    <button type="submit" class="btn">üìÖ Schedule</button>
                                    <button type="button" class="btn btn-secondary" onclick="adminClearMaintenanceForm()">üîÑ Clear</button>
                                </div>
                            </form>
                        </div>
                        <div class="form-section">
                            <h3>Upcoming / Recent</h3>
                            <div class="item-list" id="adminMaintenanceList"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 4: Community Management -->
            <div class="content-row">
                <!-- Community Management -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>üë• Community Management</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Community Analytics</h3>
                            <div class="community-stats">
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalMessages">0</span>
                                    <span class="stat-mini-label">Messages</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalShowcases">0</span>
                                    <span class="stat-mini-label">Showcases</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalEvents">0</span>
                                    <span class="stat-mini-label">Events</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini-number" id="totalSuccessStories">0</span>
                                    <span class="stat-mini-label">Success Stories</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Message Moderation</h3>
                            <div class="moderation-tools">
                                <div class="tool-item">
                                    <h4>Recent Messages</h4>
                                    <p>Review and moderate team messages</p>
                                    <button onclick="viewMessages()" class="btn btn-small">
                                        <i class="fas fa-comments"></i> View Messages
                                    </button>
                                </div>
                                <div class="tool-item">
                                    <h4>Content Filter</h4>
                                    <p>Set up automated content filtering</p>
                                    <button onclick="setupContentFilter()" class="btn btn-small">
                                        <i class="fas fa-filter"></i> Setup Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Showcase Management</h3>
                            <div class="showcase-management">
                                <div class="tool-item">
                                    <h4>Featured Showcases</h4>
                                    <p>Manage featured project showcases</p>
                                    <button onclick="manageShowcases()" class="btn btn-small">
                                        <i class="fas fa-images"></i> Manage Showcases
                                    </button>
                                </div>
                                <div class="tool-item">
                                    <h4>Content Approval</h4>
                                    <p>Review and approve showcase content</p>
                                    <button onclick="reviewShowcases()" class="btn btn-small">
                                        <i class="fas fa-check-circle"></i> Review Content
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Event Management</h3>
                            <div class="event-management">
                                <div class="tool-item">
                                    <h4>Create Event</h4>
                                    <p>Add new company events and training sessions</p>
                                    <button onclick="openEventManager('create')" class="btn btn-small">
                                        <i class="fas fa-calendar-plus"></i> Create Event
                                    </button>
                                </div>
                                <div class="tool-item">
                                    <h4>Event Calendar</h4>
                                    <p>Manage upcoming events and schedules</p>
                                    <button onclick="manageEvents()" class="btn btn-small">
                                        <i class="fas fa-calendar-alt"></i> Manage Events
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Success Stories Management</h3>
                            <div class="success-management">
                                <div class="tool-item">
                                    <h4>Add Success Story</h4>
                                    <p>Highlight team member achievements</p>
                                    <button onclick="addSuccessStory()" class="btn btn-small">
                                        <i class="fas fa-trophy"></i> Add Story
                                    </button>
                                </div>
                                <div class="tool-item">
                                    <h4>Manage Stories</h4>
                                    <p>Edit and organize success stories</p>
                                    <button onclick="manageSuccessStories()" class="btn btn-small">
                                        <i class="fas fa-edit"></i> Manage Stories
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Community Settings -->
                <div class="content-card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è Community Settings</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-section">
                            <h3>Community Configuration</h3>
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="enableMessaging" checked>
                                        Enable Team Messaging
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="enableShowcases" checked>
                                        Enable Project Showcases
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="enableEvents" checked>
                                        Enable Event Calendar
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="enableSuccessStories" checked>
                                        Enable Success Stories
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Moderation Settings</h3>
                            <div class="moderation-settings">
                                <div class="setting-item">
                                    <label for="messageLengthLimit">Message Length Limit</label>
                                    <input type="number" id="messageLengthLimit" value="500" min="100" max="2000">
                                </div>
                                <div class="setting-item">
                                    <label for="showcaseImageLimit">Showcase Image Limit</label>
                                    <input type="number" id="showcaseImageLimit" value="10" min="1" max="20">
                                </div>
                                <div class="setting-item">
                                    <label for="autoModeration">Auto-Moderation</label>
                                    <select id="autoModeration">
                                        <option value="off">Off</option>
                                        <option value="basic">Basic</option>
                                        <option value="strict">Strict</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Community Actions</h3>
                            <div class="community-actions">
                                <button onclick="exportCommunityData()" class="btn">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                                <button onclick="clearOldMessages()" class="btn btn-secondary">
                                    <i class="fas fa-trash"></i> Clear Old Messages
                                </button>
                                <button onclick="resetCommunitySettings()" class="btn btn-danger">
                                    <i class="fas fa-undo"></i> Reset Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 5: Messaging System -->
            <div class="content-row">
                <!-- Admin Messaging -->
                <div class="content-card" style="min-width: 800px;">
                    <div class="card-header">
                        <h2>üí¨ Admin Messaging</h2>
                    </div>
                    <div class="card-content">
                        <div class="messaging-container" style="height: 600px;">
                            <!-- Conversations List -->
                            <div class="conversations-panel">
                                <div class="conversations-header">
                                    <h3><i class="fas fa-inbox"></i> All Conversations</h3>
                                    <button class="btn btn-primary" onclick="adminStartNewConversation()">
                                        <i class="fas fa-plus"></i> New Message
                                    </button>
                                </div>
                                <!-- Inline user picker (hidden) -->
                                <div id="adminUserPicker" class="user-picker hidden">
                                    <div class="up-header">
                                        <input id="adminUserPickerSearch" type="text" placeholder="Search users by name or email" oninput="adminFilterUserPicker()" />
                                        <button class="btn btn-secondary" onclick="adminHideUserPicker()">Close</button>
                                    </div>
                                    <div id="adminUserPickerList" class="up-list"></div>
                                </div>
                                <!-- Inline new-conversation composer (hidden by default) -->
                                <div id="adminNewMessageInline" style="display:none; margin:8px 12px 0 12px;">
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <input type="email" id="adminNewMessageEmail" placeholder="Recipient email" 
                                            style="flex:1; padding:.55rem .7rem; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); color:var(--white);" />
                                        <button class="btn btn-primary" onclick="adminSubmitNewMessageInline()">Start</button>
                                        <button class="btn btn-secondary" onclick="adminCancelNewMessageInline()">Cancel</button>
                                    </div>
                                </div>
                                <div class="conversations-list" id="adminConversationsList">
                                    <!-- Conversations will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Chat Panel -->
                            <div class="chat-panel">
                                <div class="chat-header" id="adminChatHeader" style="display: flex;">
                                    <div class="chat-participant-info">
                                        <div class="participant-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="participant-details">
                                            <h4 id="adminChatParticipantName">User</h4>
                                            <span id="adminChatParticipantStatus" class="status-online">Online</span>
                                        </div>
                                    </div>
                                    <div class="chat-actions">
                                        <button class="btn btn-secondary" onclick="adminSearchMessages()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button class="btn btn-secondary" onclick="adminToggleChatSettings()">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                        <button class="btn btn-secondary" onclick="adminBroadcastMessage()">
                                            <i class="fas fa-bullhorn"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="chat-messages" id="adminChatMessages">
                                    <div class="empty-chat">
                                        <i class="fas fa-comments"></i>
                                        <h3>Select a conversation</h3>
                                        <p>Choose a conversation from the list to start messaging</p>
                                    </div>
                                </div>
                                
                                <!-- Inline broadcast composer for admins (hidden by default) -->
                                <div id="adminBroadcastInline" style="display:none; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.03);">
                                    <div style="display:flex; gap:8px; align-items:flex-end;">
                                        <textarea id="adminBroadcastInput" rows="1" placeholder="Broadcast message to all users..." 
                                            oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';"
                                            style="flex:1; padding:.55rem .7rem; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); color:var(--white);"></textarea>
                                        <button class="btn btn-primary" onclick="adminSendBroadcast()">Send</button>
                                        <button class="btn btn-secondary" onclick="adminToggleBroadcast()">Cancel</button>
                                    </div>
                                </div>

                                <div class="chat-input-container" id="adminChatInputContainer" style="display: none;">
                                    <div class="chat-input-wrapper">
                                        <button class="btn btn-secondary attachment-btn" onclick="adminToggleAttachmentMenu()">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <div class="attachment-menu" id="adminAttachmentMenu" style="display: none;">
                                            <button onclick="adminSelectFile('image')">
                                                <i class="fas fa-image"></i> Image
                                            </button>
                                            <button onclick="adminSelectFile('document')">
                                                <i class="fas fa-file"></i> Document
                                            </button>
                                        </div>
                                        <input type="file" id="adminFileInput" style="display: none;" multiple accept="image/*,.pdf,.doc,.docx">
                                        <div class="message-input-container">
                                            <textarea 
                                                id="adminMessageInput" 
                                                placeholder="Type your message..." 
                                                rows="1"
                                                onkeydown="adminHandleMessageKeydown(event)"
                                                oninput="adminAutoResizeTextarea(this)"
                                            ></textarea>
                                            <button class="btn btn-primary send-btn" onclick="adminSendMessage()">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="attachments-preview" id="adminAttachmentsPreview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div class="cmdk-backdrop" id="cmdkBackdrop"></div>
    <div class="cmdk" id="cmdk">
        <div class="cmdk-header">
            <span style="color:var(--primary);font-weight:800;">‚åòK</span>
            <input id="cmdkInput" type="text" placeholder="Type a command‚Ä¶ (New Job, Add User, Assign Job, Refresh)" />
        </div>
        <div class="cmdk-list" id="cmdkList"></div>
    </div>

    <script>
        // EmailJS Configuration for Admin Dashboard
        const EMAILJS_CONFIG = {
            publicKey: 'p4pF3OWvh-DXtae4c',
            serviceId: 'service_t11yvru',
            // Use the correct template IDs now that domain restrictions are resolved
            jobAcceptanceTemplateId: 'template_job_acceptance', // Correct template for job acceptance
            jobClosedTemplateId: 'template_jobs_closed' // Correct template for job denial
        };

        // Initialize EmailJS
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof emailjs !== 'undefined') {
                try {
                    emailjs.init(EMAILJS_CONFIG.publicKey);
                    console.log('‚úÖ EmailJS initialized for admin dashboard');
                } catch (e) {
                    console.warn('‚ö†Ô∏è EmailJS init error:', e.message);
                }
            } else {
                console.warn('‚ö†Ô∏è EmailJS library not loaded');
            }
        });
        // Firebase Configuration (secure) - Now handled by firebase-config.js
        // Firebase is automatically initialized by firebase-config.js
        
        // Get Firebase instances from the config
        let auth = null;
        let firestore = null;
        
        // Initialize Firebase when config is ready
        async function initializeAdminFirebase() {
            try {
                if (window.FirebaseConfig) {
                    // Initialize default app for admin context
                    await window.FirebaseConfig.init('admin-dashboard');
                    auth = window.FirebaseConfig.auth;
                    firestore = window.FirebaseConfig.getFirestore();
                    console.log('‚úÖ Firebase initialized in admin dashboard');

                    // Add auth state listener to avoid hydration race causing false logouts
                    if (auth && typeof auth.onAuthStateChanged === 'function') {
                        let authNullDebounceTimer = null;
                        // mark when we've received the first auth state
                        window._ADMIN_AUTH_SEEN = false;
                        auth.onAuthStateChanged((user) => {
                            if (!window._ADMIN_AUTH_SEEN) { window._ADMIN_AUTH_SEEN = true; }
                            if (authNullDebounceTimer) { clearTimeout(authNullDebounceTimer); authNullDebounceTimer = null; }

                            if (user && user.email) {
                                // Persist admin session and show dashboard
                                if (isAdminUser(user.email)) {
                                    try {
                                        sessionStorage.setItem('adminDashboardAuthenticated', 'true');
                                        sessionStorage.setItem('adminUser', JSON.stringify({ email: user.email, uid: user.uid }));
                                    } catch(_) {}
                                    setAdminSession(30);
                                    isAuthenticated = true;
                                    showDashboard();
                                } else {
                                    // If a non-admin user is observed but we have an active admin session, preserve dashboard
                                    const session = sessionStorage.getItem('adminDashboardAuthenticated');
                                    const notExpired = Date.now() < getAdminSessionExpiry();
                                    if ((session === 'true' || notExpired) && isAuthenticated === true) {
                                        setAdminSession(30);
                                        return;
                                    }
                                    if (typeof showNotification === 'function') {
                                        showNotification('Access denied. Admin privileges required.', 'error');
                                    }
                                    showLoginScreen();
                                }
                                return;
                            }

                            // Debounce null user during hydration instead of immediately flipping UI
                            authNullDebounceTimer = setTimeout(() => {
                                const notExpired = Date.now() < getAdminSessionExpiry();
                                const cachedEmail = (function(){ try { return localStorage.getItem('adminDashboardAuthEmail') || ''; } catch(_) { return ''; } })();
                                if (notExpired && cachedEmail) {
                                    // Keep dashboard while hydration completes
                                    return;
                                }
                                showLoginScreen();
                            }, 1500);
                        });
                    }
                }
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
            }
        }

        // Admin role management
        const ADMIN_EMAILS = [
            'info@cochranfilms.com',
            'admin@cochranfilms.com',
            'cody@cochranfilms.com'
        ];

        // Check if user has admin privileges
        function isAdminUser(email) {
            return ADMIN_EMAILS.includes(email.toLowerCase());
        }

        // Create Firebase account for new user
        async function createFirebaseAccount(email, password) {
            try {
                // Create via server API (does not sign out admin)
                const res = await fetch('/api/firebase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const json = await res.json();
                if (res.ok && json.success) {
                    console.log('‚úÖ Firebase account created for:', email);
                    return { success: true, uid: json.localId };
                }
                return { success: false, error: json.error || 'Failed to create user' };
            } catch (error) {
                console.error('‚ùå Error creating Firebase account:', error);
                
                // Handle specific errors
                let errorMessage = 'Failed to create account.';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email already exists in Firebase.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email format.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak.';
                        break;
                }
                
                return { success: false, error: errorMessage };
            }
        }

        // Create Firebase accounts for existing users
        async function createFirebaseAccountsForExistingUsers() {
            try {
                await loadUsers();
                
                let createdCount = 0;
                let errorCount = 0;
                
                for (const [userName, userData] of Object.entries(window.users || {})) {
                    const email = userData.profile?.email;
                    const password = userData.profile?.password;
                    
                    if (email && password) {
                        console.log(`üîÑ Creating Firebase account for: ${email}`);
                        
                        const result = await createFirebaseAccount(email, password);
                        
                        if (result.success) {
                            createdCount++;
                            showAdminNotification(
                                'Firebase Account Created',
                                `‚úÖ Created Firebase account for ${email}`,
                                'success',
                                { action: 'firebase_account_created', email: email }
                            );
                        } else {
                            errorCount++;
                            showAdminNotification(
                                'Firebase Account Creation Failed',
                                `‚ùå Failed to create account for ${email}: ${result.error}`,
                                'error',
                                { action: 'firebase_account_failed', email: email, error: result.error }
                            );
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                showAdminNotification(
                    'Firebase Account Creation Complete',
                    `üéâ Firebase account creation complete! Created: ${createdCount}, Errors: ${errorCount}`,
                    'success',
                    { action: 'firebase_accounts_complete', created: createdCount, errors: errorCount }
                );
                
            } catch (error) {
                console.error('‚ùå Error creating Firebase accounts:', error);
                showAdminNotification(
                    'Firebase Account Creation Error',
                    '‚ùå Error creating Firebase accounts. Please try again.',
                    'error',
                    { action: 'firebase_accounts_error', error: error.message }
                );
            }
                }
        
        // Session management - Make these global
        window.isAuthenticated = false;
        window.jobs = [];
        window.users = {};

        // 30-minute admin session grace across tabs (localStorage)
        const ADMIN_SESSION_KEY = 'adminDashboardSessionExpiry';
        const ADMIN_EMAIL_KEY = 'adminDashboardAuthEmail';
        function setAdminSession(minutes = 30) {
            try {
                localStorage.setItem(ADMIN_SESSION_KEY, String(Date.now() + minutes * 60000));
                if (auth && auth.currentUser && auth.currentUser.email) {
                    localStorage.setItem(ADMIN_EMAIL_KEY, auth.currentUser.email);
                }
            } catch(_) {}
        }
        function getAdminSessionExpiry() {
            try { return Number(localStorage.getItem(ADMIN_SESSION_KEY) || '0'); } catch(_) { return 0; }
        }
        window.addEventListener('focus', () => {
            if (auth && auth.currentUser && auth.currentUser.email) setAdminSession(30);
        });

        // Check if already authenticated
        function checkAuth() {
            console.log('üîê Main dashboard checkAuth called');
            console.log('üîç Session storage value:', sessionStorage.getItem('adminDashboardAuthenticated'));
            console.log('üîç Current isAuthenticated state:', isAuthenticated);
            
            // If auth event not seen yet, suppress initial UI flips briefly
            if (!window._ADMIN_AUTH_SEEN) {
                window.ADMIN_SUPPRESS_LOGIN_FLIP = true;
                setTimeout(() => { window.ADMIN_SUPPRESS_LOGIN_FLIP = false; }, 4000);
            }

            const session = sessionStorage.getItem('adminDashboardAuthenticated');
            if (session === 'true' || Date.now() < getAdminSessionExpiry() || (auth && auth.currentUser && auth.currentUser.email)) {
                isAuthenticated = true;
                showDashboard();
                console.log('‚úÖ Main dashboard authentication restored from session');
            } else {
                showLoginScreen();
                console.log('‚úÖ Main dashboard showing login screen');
            }
        }

        // Show login screen
        function showLoginScreen() {
            console.log('üîê Main dashboard showLoginScreen called');
            
            // Avoid UI flip while auth is still resolving
            if (window.ADMIN_SUPPRESS_LOGIN_FLIP) {
                console.log('‚è≥ Suppressing login screen during auth hydration');
                return;
            }

            // Always show login screen when not authenticated
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            
            console.log('‚úÖ Main dashboard login screen displayed');
        }

        // Show dashboard
        function showDashboard() {
            console.log('üîê Main dashboard showDashboard called');
            
            // Always show the main dashboard when authenticated
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Force load data using main dashboard functions
            console.log('üîÑ Forcing main dashboard data load...');
            loadData();
            updateStats();
            
            // Ensure user display is updated
            setTimeout(() => {
                if (window.users && Object.keys(window.users).length > 0) {
                    console.log('‚úÖ Users loaded, updating display...');
                    displayUsers();
                    displayArchivedUsers();
                } else {
                    console.log('‚ö†Ô∏è No users found, attempting to reload...');
                    loadUsers();
                }
            }, 500);
            
            // Ensure jobs are displayed
            setTimeout(() => {
                console.log('üîÑ Ensuring jobs are displayed...');
                if (window.jobs && window.jobs.length > 0) {
                    console.log('‚úÖ Jobs already loaded, updating display...');
                    displayJobs();
                } else {
                    console.log('‚ö†Ô∏è No jobs found, attempting to reload...');
                    loadJobs();
                }
            }, 1000);

            // Ensure contracts are displayed
            setTimeout(() => {
                console.log('üîÑ Ensuring contracts are displayed...');
                if (window.contracts && window.contracts.length > 0) {
                    console.log('‚úÖ Contracts already loaded, updating display...');
                    displayContracts();
                } else {
                    console.log('‚ö†Ô∏è No contracts found, attempting to reload...');
                    loadContracts();
                }
            }, 1200);
            
            console.log('‚úÖ Main dashboard displayed successfully');
            // Initialize Equipment & Resource Center admin views
            setTimeout(() => {
                try { adminLoadEquipment(); } catch(_) {}
                try { adminLoadResources(); } catch(_) {}
                try { adminLoadEquipmentRequests(); } catch(_) {}
                try { adminLoadMaintenance(); } catch(_) {}
            }, 250);
        }

        // Handle login with Firebase
        document.getElementById('mainDashboardLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('üîê Main dashboard login form submitted!');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log('üîê Main dashboard login attempt:', { email, password: password ? '***' : 'empty' });
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            // Show global loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'flex';
            }
            
            try {
                // Ensure Firebase auth is ready
                if (!auth || typeof auth.signInWithEmailAndPassword !== 'function') {
                    try { await initializeAdminFirebase(); } catch (_) {}
                }
                // Firebase authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Check if user has admin privileges
                if (isAdminUser(userCredential.user.email)) {
                    sessionStorage.setItem('adminDashboardAuthenticated', 'true');
                    sessionStorage.setItem('adminUser', JSON.stringify({
                        email: userCredential.user.email,
                        uid: userCredential.user.uid
                    }));
                    isAuthenticated = true;
                    setAdminSession(30);
                    showDashboard();
                    document.getElementById('password').value = '';
                    console.log('‚úÖ Main dashboard Firebase authentication successful');
                } else {
                    // For non-admin users, show access denied
                    showNotification('Access denied. Admin privileges required.', 'error');
                    document.getElementById('password').value = '';
                    console.log('‚ùå Main dashboard access denied for non-admin user');
                }
                
            } catch (error) {
                console.error('‚ùå Main dashboard Firebase login error:', error);
                
                // Try fallback authentication with ADMIN_PASSWORD
                console.log('üîÑ Trying fallback authentication...');
                console.log('üîç window.ADMIN_PASSWORD:', window.ADMIN_PASSWORD);
                console.log('üîç password === window.ADMIN_PASSWORD:', password === window.ADMIN_PASSWORD);
                
                if (window.ADMIN_PASSWORD && password === window.ADMIN_PASSWORD) {
                    console.log('‚úÖ Fallback authentication successful');
                    sessionStorage.setItem('adminDashboardAuthenticated', 'true');
                    sessionStorage.setItem('adminUser', JSON.stringify({
                        email: email || 'admin@cochranfilms.com',
                        uid: 'fallback-admin-' + Date.now()
                    }));
                    isAuthenticated = true;
                    setAdminSession(30);
                    showDashboard();
                    document.getElementById('password').value = '';
                    showNotification('‚úÖ Login successful (fallback auth)', 'success');
                    return;
                }
                
                // Handle specific Firebase errors
                let errorMessage = 'Login failed. Please try again.';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'User not found. Please check your email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email format.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                }
                
                showNotification(errorMessage, 'error');
                document.getElementById('password').value = '';
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                // Hide global loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        });

        // Logout with Firebase
        async function logout() {
            try {
                // Sign out from Firebase
                await auth.signOut();
                console.log('‚úÖ Successfully signed out from Firebase');
            } catch (error) {
                console.error('‚ùå Error signing out from Firebase:', error);
            }
            
            isAuthenticated = false;
            sessionStorage.removeItem('adminDashboardAuthenticated');
            sessionStorage.removeItem('adminUser');
            showLoginScreen();
        }

        // Load data with Firestore integration
        async function loadData() {
            console.log('üîÑ Main dashboard loadData called');
            console.log('üîç Starting to load all data...');
            
            try {
                // Initialize Firebase if not already done
                if (!auth || !firestore) {
                    await initializeAdminFirebase();
                }
                
                // Ensure Firestore is initialized, then load from Firestore only
                console.log('üî• Ensuring Firestore is initialized...');
                if (window.FirestoreIntegration && typeof window.FirestoreIntegration.init === 'function') {
                    await window.FirestoreIntegration.init();
                } else if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    await window.FirestoreDataManager.init();
                }

                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    console.log('üî• Loading data from Firestore (no JSON fallbacks)...');

                    // Users (kept as-is for now; Firestore is source, no fallback)
                    try {
                        window.users = await window.FirestoreDataManager.getUsers();
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Users load failed from Firestore:', e?.message || e);
                        window.users = {};
                    }

                    // Jobs (Firestore only)
                    try {
                        window.jobs = await window.FirestoreDataManager.getJobListings();
                        // Normalize any migrated docs that stored data under a single nested key like 'jobs.<id>'
                        window.jobs = (window.jobs || []).map(j => normalizeJobRecord(j));
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Jobs load failed from Firestore:', e?.message || e);
                        window.jobs = [];
                    }

                    // Contracts (Firestore only)
                    try {
                        window.contracts = await window.FirestoreDataManager.getContracts();
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Contracts load failed from Firestore:', e?.message || e);
                        window.contracts = [];
                    }

                    // Dropdown options (prefer Firestore; if missing, leave empty)
                    try {
                        window.dropdownOptions = await window.FirestoreDataManager.getDropdownOptions();
                        // Populate UI immediately when loaded from Firestore
                        try {
                            populateDropdownManagementInterface();
                            populateUserCreationDropdowns();
                            populateJobAssignmentDropdowns();
                        } catch (_) {}
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Dropdown options load failed from Firestore:', e?.message || e);
                        window.dropdownOptions = {};
                    }

                } else {
                    console.log('üìÅ Firestore not available; skipping legacy JSON fallbacks');
                }
                
                console.log('üîÑ Updating stats after data load...');
                updateStats();
                
                // Initialize Performance Management
                initializePerformanceManagement();
                
                // Initialize Community Management
                initializeCommunityManagement();
                
                console.log('‚úÖ Main dashboard loadData complete');
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                // Fallback to JSON loading
                console.log('üîÑ Falling back to JSON loading...');
                await loadDataFromJSON();
                updateStats();
            }
        }
        
        // Legacy JSON fallback removed; Firestore is single source of truth

        // Update stats
        function updateStats() {
            console.log('üîÑ updateStats called');
            console.log('üîç window.users:', window.users);
            console.log('üîç window.jobs:', window.jobs);
            
            // Only count active users (exclude `_archived` and any underscore-prefixed keys)
            const activeUserNames = Object.keys(window.users || {})
                .filter(name => name !== '_archived' && !name.startsWith('_'));
            const activeUsers = activeUserNames.map(name => window.users[name]);
            
            console.log('üîç Active user names:', activeUserNames);
            console.log('üîç Active users count:', activeUserNames.length);

            // Total creators = active users only
            const totalCreatorsElement = document.getElementById('totalCreators');
            if (totalCreatorsElement) {
                totalCreatorsElement.textContent = activeUserNames.length;
                console.log('‚úÖ Updated totalCreators:', activeUserNames.length);
            } else {
                console.error('‚ùå totalCreators element not found');
            }

            // All jobs
            const totalJobsCount = Array.isArray(window.jobs) ? window.jobs.length : 0;
            const totalJobsElement = document.getElementById('totalJobs');
            if (totalJobsElement) {
                totalJobsElement.textContent = totalJobsCount;
                console.log('‚úÖ Updated totalJobs:', totalJobsCount);
            } else {
                console.error('‚ùå totalJobs element not found');
            }

            // Active jobs from jobs dataset (treat missing status as Active)
            const activeJobsCount = (window.jobs || []).filter(job => String(job.status || 'active').toLowerCase() === 'active').length;
            const activeJobsElement = document.getElementById('activeJobs');
            if (activeJobsElement) {
                activeJobsElement.textContent = activeJobsCount;
                console.log('‚úÖ Updated activeJobs:', activeJobsCount);
            } else {
                console.error('‚ùå activeJobs element not found');
            }
            
            // Count pending reviews using paid+completed condition and absence of Firestore-backed performance
            const pendingReviews = activeUsers.filter(user => shouldShowPerformanceReview(user)).length;
            const pendingReviewsElement = document.getElementById('pendingReviews');
            if (pendingReviewsElement) {
                pendingReviewsElement.textContent = pendingReviews;
                console.log('‚úÖ Updated pendingReviews:', pendingReviews);
            } else {
                console.error('‚ùå pendingReviews element not found');
            }

            // Signed contracts (treat "uploaded" as signed since uploaded PDFs are completed)
            let signedContracts = 0;
            if (Array.isArray(window.contracts)) {
                signedContracts = window.contracts.filter(c => {
                    const s = String(c.status || '').toLowerCase();
                    return s === 'signed' || s === 'uploaded';
                }).length;
            } else {
                signedContracts = activeUsers.filter(user => {
                    const s = String(user?.contract?.contractStatus || '').toLowerCase();
                    return s === 'signed' || s === 'uploaded';
                }).length;
            }
            const totalContractsElement = document.getElementById('totalContracts');
            if (totalContractsElement) {
                totalContractsElement.textContent = signedContracts;
                console.log('‚úÖ Updated totalContracts:', signedContracts);
            } else {
                console.error('‚ùå totalContracts element not found');
            }
            
            console.log('‚úÖ updateStats complete');
        }

        // Load existing jobs
        async function loadJobs() {
            try {
                console.log('üîÑ loadJobs called (Firestore)');
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    window.jobs = await window.FirestoreDataManager.getJobListings();
                    window.jobs = (window.jobs || []).map(j => normalizeJobRecord(j));
                    console.log(`‚úÖ Loaded ${window.jobs.length} jobs from Firestore`);
                } else {
                    console.warn('‚ö†Ô∏è Firestore not available; jobs set to empty');
                    window.jobs = [];
                }
            } catch (error) {
                console.error('‚ùå Error loading jobs from Firestore:', error);
                window.jobs = [];
            }
            
            console.log('üîÑ Calling displayJobs after loading...');
            displayJobs();
            console.log('‚úÖ loadJobs complete');
        }

        // Normalize a Firestore job doc that may have nested data under a single key like 'jobs.<id>'
        function normalizeJobRecord(jobDoc) {
            if (!jobDoc || typeof jobDoc !== 'object') return jobDoc;
            const keys = Object.keys(jobDoc).filter(k => k.startsWith('jobs.'));
            if (keys.length === 1 && typeof jobDoc[keys[0]] === 'object') {
                const inner = jobDoc[keys[0]] || {};
                // Preserve id and overlay top-level fields
                return {
                    id: jobDoc.id || jobDoc.contractId || jobDoc._id || keys[0].slice(5),
                    ...inner,
                    // prefer explicit status if present
                    status: inner.status || jobDoc.status || 'Active'
                };
            }
            return jobDoc;
        }

        // Load contracts from Firestore and render
        async function loadContracts() {
            try {
                console.log('üîÑ loadContracts called (Firestore)');
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    window.contracts = await window.FirestoreDataManager.getContracts();
                    console.log(`‚úÖ Loaded ${window.contracts.length} contracts from Firestore`);
                } else {
                    console.warn('‚ö†Ô∏è Firestore not available; contracts set to empty');
                    window.contracts = [];
                }
            } catch (error) {
                console.error('‚ùå Error loading contracts from Firestore:', error);
                window.contracts = [];
            }
            displayContracts();
        }

        // Display contracts
        function displayContracts() {
            const list = document.getElementById('contractsList');
            if (!list) {
                console.warn('‚ö†Ô∏è contractsList element not found');
                return;
            }

            const contracts = Array.isArray(window.contracts) ? window.contracts : [];
            if (contracts.length === 0) {
                list.innerHTML = '<div class="item-card"><p style="text-align:center;color:rgba(255,255,255,0.7);">No contracts available</p></div>';
                return;
            }

            // Sort newest first by any available date
            contracts.sort((a, b) => new Date(b.signedDate || b.contractDate || b.uploadDate || b.createdAt || 0) - new Date(a.signedDate || a.contractDate || a.uploadDate || a.createdAt || 0));
            list.innerHTML = '';

            const statusColors = {
                signed: '#22c55e',
                uploaded: '#64748b',
                pending: '#f59e0b',
                draft: '#6b7280',
                expired: '#ef4444',
                cancelled: '#ef4444'
            };

            contracts.forEach((c, index) => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const status = (c.status || 'draft').toLowerCase();
                const createdIso = c.signedDate || c.contractDate || c.uploadDate || c.createdAt;
                const created = createdIso ? new Date(createdIso).toLocaleDateString() : '‚Äî';
                const id = c.id || c.contractId || `contract-${index}`;
                const name = c.userName || c.freelancerName || (c.fileName ? c.fileName.replace(/\.pdf$/i,'') : 'Unknown User');
                const email = c.userEmail || c.freelancerEmail || 'N/A';

                const makeDownload = () => {
                    if (c.fileUrl || c.githubUrl) {
                        window.open(c.fileUrl || c.githubUrl, '_blank');
                        return;
                    }
                    const filename = c.fileName || `${(name || 'Contract').replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, ' ').trim()}.pdf`;
                    const url = `${API_BASE}/api/contracts?filename=${encodeURIComponent(filename)}`;
                    window.open(url, '_blank');
                };
                const makeDelete = async () => {
                    if (!confirm(`Permanently delete contract for ${name}? This removes Firestore doc and tries to remove the PDF.`)) return;
                    try {
                        // 1) Delete from Firestore contracts collection
                        if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                            const contractId = id;
                            try { await window.FirestoreDataManager.deleteContract(contractId); } catch(_){}
                        }

                        // 2) Remove contract reference from associated user (best-effort)
                        try {
                            // Find a matching user by email or name
                            const users = window.users || {};
                            let matchedKey = null;
                            for (const [k, u] of Object.entries(users)) {
                                const uEmail = (u.profile && u.profile.email) ? String(u.profile.email).toLowerCase() : '';
                                const cEmail = String(email || '').toLowerCase();
                                if (cEmail && uEmail && uEmail === cEmail) { matchedKey = k; break; }
                                if (!matchedKey && k === name) { matchedKey = k; }
                            }
                            if (matchedKey) {
                                const userCopy = { ...(users[matchedKey] || {}) };
                                userCopy.contract = {
                                    contractId: null,
                                    fileName: null,
                                    contractStatus: 'pending',
                                    contractSignedDate: null,
                                    uploadDate: null,
                                    githubUrl: null
                                };
                                try { await window.FirestoreDataManager.setUser(matchedKey, userCopy); } catch(_){}
                                window.users[matchedKey] = userCopy;
                            }
                        } catch(_){}

                        // 3) Attempt to delete local/GitHub PDF via API
                        try {
                            const filename = c.fileName || `${(name || 'Contract').replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, ' ').trim()}.pdf`;
                            await fetch(`${API_BASE}/api/delete-pdf`, {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ fileName: filename, contractId: id })
                            });
                        } catch(_){}

                        // Reload contracts and users UI
                        try { await loadContracts(); } catch(_){}
                        try { await loadUsers(); } catch(_){}
                        updateStats();
                        showNotification('‚úÖ Contract deleted', 'success');
                    } catch (err) {
                        console.error('Contract delete failed:', err);
                        showNotification('‚ùå Failed to delete contract', 'error');
                    }
                };

                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;">
                        <h4 style="margin:0;">${name}</h4>
                        <span style="background:${statusColors[status] || '#6b7280'};color:#fff;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.8rem;text-transform:capitalize;">${status}</span>
                    </div>
                    <div class="item-meta">
                        <span>üìß ${email}</span>
                        <span>üÜî ${id}</span>
                        <span>üóìÔ∏è ${created}</span>
                    </div>
                    <div class="item-actions" style="display:flex;gap:.5rem;flex-wrap:wrap;">
                        <button class="btn btn-small" id="dl-${id}">‚¨áÔ∏è Download</button>
                        <button class="btn btn-small btn-danger" id="del-${id}">üóëÔ∏è Delete</button>
                    </div>
                `;

                list.appendChild(card);
                const btn = card.querySelector(`#dl-${CSS.escape(id)}`);
                if (btn) btn.onclick = makeDownload;
                const delBtn = card.querySelector(`#del-${CSS.escape(id)}`);
                if (delBtn) delBtn.onclick = makeDelete;
            });
        }

        // Display jobs
        function displayJobs() {
            console.log('üîÑ displayJobs called');
            console.log('üîç window.jobs:', window.jobs);
            console.log('üîç Jobs count:', window.jobs ? window.jobs.length : 'undefined');
            
            const jobsList = document.getElementById('jobsList');
            if (!jobsList) {
                console.error('‚ùå jobsList element not found');
                return;
            }
            
            if (!window.jobs || !Array.isArray(window.jobs) || window.jobs.length === 0) {
                console.log('‚ö†Ô∏è No jobs to display');
                jobsList.innerHTML = '<div class="item-card"><p style="text-align: center; color: rgba(255,255,255,0.7);">No jobs available</p></div>';
                return;
            }
            
            console.log(`‚úÖ Displaying ${window.jobs.length} jobs`);
            jobsList.innerHTML = '';

            window.jobs.forEach((job, index) => {
                const statusColors = {
                    'Active': '#22c55e',
                    'Pending': '#f59e0b',
                    'Completed': '#3b82f6',
                    'Cancelled': '#ef4444',
                    'Inactive': '#6b7280'
                };
                
                const jobDiv = document.createElement('div');
                jobDiv.className = 'item-card';
                // Resolve id for actions without mutating dataset
                const jobId = job.id || job.contractId || job._id || `temp-${index}`;
                jobDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">${job.title || 'Untitled Job'}</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap;">
                            <span class="job-status" style="background: ${statusColors[job.status] || '#6b7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                ${job.status || 'Active'}
                            </span>
                            ${job.exclusive ? `
                                <span style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    <i class="fas fa-crown"></i> Exclusive
                                </span>
                            ` : ''}
                            ${job.priority ? `
                                <span style="background: linear-gradient(135deg, #FFB200, #FFD700); color: #1a1a1a; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    <i class="fas fa-star"></i> Priority
                                </span>
                            ` : ''}
                            ${job.type ? `
                                <span style="background: rgba(255, 178, 0, 0.2); color: #FFB200; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                    ${job.type}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="item-meta">
                        <span>üìÖ ${job.date || 'TBD'}</span>
                        <span>üìç ${job.location || 'Location TBD'}</span>
                        <span>üí∞ ${job.pay || 'Pay TBD'}</span>
                        ${job.type ? `<span>üéØ ${job.type}</span>` : ''}
                    </div>
                    <div class="item-description">
                        ${job.description || 'No description provided'}
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small" onclick="editJob(${index})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-small" onclick="duplicateJob(${index})">üìã Duplicate</button>
                        <button class="btn btn-small btn-danger" onclick="deleteJob(${index})">üóëÔ∏è Delete</button>
                    </div>
                `;
                jobsList.appendChild(jobDiv);
            });
            
            console.log('‚úÖ Jobs display complete');
        }

        // Add/Edit job
        document.getElementById('jobForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('üìù Job form submitted');
            
            const formData = new FormData(e.target);
            const job = {
                title: formData.get('title'),
                date: formData.get('date'),
                location: formData.get('location'),
                pay: formData.get('pay'),
                type: formData.get('type'),
                description: formData.get('description'),
                status: formData.get('status'),
                exclusive: formData.get('exclusive') === 'on',
                priority: formData.get('priority') === 'on'
            };

            // Normalize placeholder defaults so we don't store UI prompts as values
            if (!job.location || job.location === 'Select Location‚Ä¶' || job.location === 'Select Location...') job.location = '';
            if (!job.pay || job.pay === 'Select Rate‚Ä¶' || job.pay === 'Select Rate...') job.pay = '';
            if (!job.type || job.type === 'Select Project Type‚Ä¶' || job.type === 'Select Project Type...') job.type = '';
            
            console.log('üìù Job data collected:', job);

            const editIndex = e.target.dataset.editIndex;
            // Ensure a persistent id exists for Firestore writes/deletes
            if (editIndex !== undefined && window.jobs && window.jobs[editIndex] && window.jobs[editIndex].id) {
                job.id = window.jobs[editIndex].id;
                console.log('üìù Using existing job ID:', job.id);
            } else {
                job.id = job.id || `job-${(job.title||'job').toLowerCase().replace(/\s+/g,'-')}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
                console.log('üìù Generated new job ID:', job.id);
            }
            const actionType = (editIndex !== undefined) ? 'update' : 'create';
            console.log('üìù Action type:', actionType);
            if (editIndex !== undefined) {
                window.jobs[editIndex] = job;
                delete e.target.dataset.editIndex;
            } else {
                window.jobs.push(job);
            }

            displayJobs();
            updateStats();
            clearJobForm();

            // Persist jobs to Firestore
            try {
                console.log('üíæ Attempting to save job to Firestore...');
                console.log('üíæ FirestoreDataManager available:', !!(window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()));
                await updateJobsOnGitHub(actionType, job.title, job);
                console.log('‚úÖ Job save completed successfully');
            } catch (persistErr) {
                console.error('‚ùå Failed to persist jobs to Firestore:', persistErr);
                showNotification('‚ùå Could not save jobs to Firestore: ' + persistErr.message, 'error');
            }
        });

        // Edit job ‚Üí open modal editor for consistency with Edit User
        function editJob(index) {
            const job = (Array.isArray(window.jobs) ? window.jobs[index] : null);
            if (!job) { showNotification('Job not found', 'error'); return; }
            openJobEditModal(job);
        }

        // Duplicate job
        async function duplicateJob(index) {
            const originalJob = window.jobs[index];
            const newJob = {
                ...originalJob,
                title: `${originalJob.title} (Copy)`,
                status: 'Active',
                id: `job-${(originalJob.title||'job').toLowerCase().replace(/[^a-z0-9\s-]/gi,'').replace(/\s+/g,'-')}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`
            };
            
            window.jobs.push(newJob);
            displayJobs();
            updateStats();
            showNotification('Job duplicated successfully', 'success');

            try { await updateJobsOnGitHub('duplicate', newJob.title); } catch {}
        }

        // Delete job
        async function deleteJob(index) {
            if (confirm('Are you sure you want to delete this job?')) {
                const removed = window.jobs[index];

                // Attempt Firestore delete by document id (single source of truth)
                try {
                    if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                        const jobId = removed && (removed.id || removed.contractId || removed._id);
                        if (jobId) {
                            await window.FirestoreDataManager.deleteJobListing(jobId);
                            console.log('‚úÖ Deleted job from Firestore:', jobId);
                        } else {
                            console.warn('‚ö†Ô∏è No job id available for Firestore delete; attempting field-match lookup');
                            try {
                                const latestJobs = await window.FirestoreDataManager.getJobListings();
                                const match = (latestJobs || []).find(j => {
                                    const t1 = (j.title||'').toLowerCase().trim();
                                    const t2 = (removed.title||'').toLowerCase().trim();
                                    const d1 = (j.date||'').trim();
                                    const d2 = (removed.date||'').trim();
                                    const l1 = (j.location||'').toLowerCase().trim();
                                    const l2 = (removed.location||'').toLowerCase().trim();
                                    const p1 = String(j.pay||'').trim();
                                    const p2 = String(removed.pay||'').trim();
                                    return t1 === t2 && d1 === d2 && l1 === l2 && p1 === p2;
                                });
                                if (match && match.id) {
                                    await window.FirestoreDataManager.deleteJobListing(match.id);
                                    console.log('‚úÖ Deleted matched job from Firestore by fields:', match.id);
                                } else {
                                    console.warn('‚ö†Ô∏è Could not locate matching Firestore doc to delete');
                                }
                            } catch (lookupErr) {
                                console.warn('‚ö†Ô∏è Firestore lookup delete failed:', lookupErr?.message || lookupErr);
                            }
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Firestore delete failed:', err?.message || err);
                }

                // Update local UI immediately; realtime listener will refresh from Firestore
                window.jobs.splice(index, 1);
                displayJobs();
                updateStats();

                // Optional archival sync
                try { await updateJobsOnGitHub('delete', removed?.title || 'job'); } catch {}
            }
        }

        // Clear job form
        function clearJobForm() {
            document.getElementById('jobForm').reset();
            document.getElementById('jobLocation').value = 'Atlanta Area';
            delete document.getElementById('jobForm').dataset.editIndex;
        }

        // Filter jobs by status
        function filterJobs() {
            const filterValue = document.getElementById('jobFilter').value;
            const jobCards = document.querySelectorAll('#jobsList .item-card');
            
            jobCards.forEach(card => {
                const statusElement = card.querySelector('.job-status');
                if (statusElement) {
                    const status = statusElement.textContent.trim();
                    if (filterValue === 'all' || status === filterValue) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }

        // Refresh jobs list (kept minimal; Firestore realtime handles updates)
        function refreshJobs() { displayJobs(); }
        
        // Force refresh removed (Firestore realtime handles updates)
        
                // Debug function to check current jobs state
        function debugJobsState() {
            console.log('üêõ DEBUG: Current Jobs State');
            console.log('üîç window.jobs:', window.jobs);
            console.log('üîç window.jobs type:', typeof window.jobs);
            console.log('üîç window.jobs length:', window.jobs ? window.jobs.length : 'undefined');
            console.log('üîç window.jobs isArray:', Array.isArray(window.jobs));
            
            if (window.jobs && Array.isArray(window.jobs)) {
                console.log('üîç Jobs details:');
                window.jobs.forEach((job, index) => {
                    console.log(`  Job ${index}:`, job);
                });
            }
            
            // Check DOM elements
            const jobsList = document.getElementById('jobsList');
            console.log('üîç jobsList element:', jobsList);
            console.log('üîç jobsList innerHTML length:', jobsList ? jobsList.innerHTML.length : 'undefined');
            
            // Check stats
            const activeJobsElement = document.getElementById('activeJobs');
            console.log('üîç activeJobs element:', activeJobsElement);
            console.log('üîç activeJobs textContent:', activeJobsElement ? activeJobsElement.textContent : 'undefined');
            
            // Show debug info in notification
            const debugInfo = `Jobs: ${window.jobs ? window.jobs.length : 0}, Type: ${typeof window.jobs}, Array: ${Array.isArray(window.jobs)}`;
            showNotification(`üêõ Debug: ${debugInfo}`, 'info');
        }

        // Test EmailJS function
        async function testEmailJS() {
            console.log('üß™ Testing EmailJS configuration...');
            
            if (typeof emailjs === 'undefined') {
                showNotification('‚ùå EmailJS library not loaded', 'error');
                return;
            }
            
            try {
                // Initialize EmailJS
                emailjs.init(EMAILJS_CONFIG.publicKey);
                console.log('‚úÖ EmailJS initialized');
                
                // Test parameters
                const testParams = {
                    freelancer_name: 'Test User',
                    role: 'Test Role',
                    location: 'Test Location',
                    rate: 'Test Rate',
                    project_start: 'Test Date',
                    job: 'Test Job',
                    contract_id: 'Test Contract ID'
                };
                
                console.log('üìß Testing with parameters:', testParams);
                
                // Try main template
                const response = await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.jobAcceptanceTemplateId,
                    testParams
                );
                
                console.log('‚úÖ Test email sent successfully:', response);
                showNotification('‚úÖ EmailJS test successful!', 'success');
                
            } catch (error) {
                console.error('‚ùå EmailJS test failed:', error);
                
                let errorMessage = 'Test failed';
                if (error.status === 422) {
                    errorMessage = '422 Error - Template variables or configuration issue';
                } else if (error.status === 403) {
                    errorMessage = '403 Error - Domain restrictions';
                } else if (error.status === 400) {
                    errorMessage = '400 Error - Bad request';
                } else if (error.status === 401) {
                    errorMessage = '401 Error - Authentication issue';
                } else {
                    errorMessage = `Error ${error.status}: ${error.message}`;
                }
                
                showNotification(`‚ùå EmailJS test failed: ${errorMessage}`, 'error');
                
                // Try alternative template
                if (error.status === 422) {
                    console.log('üîÑ Trying alternative template...');
                    try {
                        const altResponse = await emailjs.send(
                            EMAILJS_CONFIG.serviceId,
                            EMAILJS_CONFIG.jobClosedTemplateId,
                            testParams
                        );
                        console.log('‚úÖ Alternative template worked:', altResponse);
                        showNotification('‚úÖ Alternative template test successful!', 'success');
                    } catch (altError) {
                        console.error('‚ùå Alternative template also failed:', altError);
                        showNotification('‚ùå Both templates failed', 'error');
                    }
                }
            }
        }

        // Update jobs-data.json on GitHub
        async function updateJobsOnGitHub(action = 'update', jobTitle = '', singleJob = null) {
            try {
                console.log('üîÑ updateJobsOnGitHub called:', { action, jobTitle, singleJob: singleJob ? singleJob.id : 'none' });
                
                // Always save to Firestore (single source of truth)
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    console.log('‚úÖ FirestoreDataManager is available');
                    if (singleJob && singleJob.id) {
                        console.log('üíæ Saving single job to Firestore:', singleJob.id);
                        await window.FirestoreDataManager.setJobListing(singleJob.id, singleJob);
                        console.log('‚úÖ Single job saved successfully');
                    } else {
                        console.log('üíæ Saving all jobs to Firestore');
                        const writes = (window.jobs || []).map(j => j && j.id ? window.FirestoreDataManager.setJobListing(j.id, j) : null).filter(Boolean);
                        await Promise.allSettled(writes);
                        console.log('‚úÖ All jobs saved successfully');
                    }
                    showNotification('‚úÖ Jobs saved to Firestore', 'success');
                    try { 
                        console.log('üîÑ Reloading jobs after save...');
                        await loadJobs(); 
                        console.log('‚úÖ Jobs reloaded successfully');
                    } catch(reloadErr) {
                        console.error('‚ùå Error reloading jobs:', reloadErr);
                    }
                } else {
                    console.error('‚ùå FirestoreDataManager not available');
                    showNotification('‚ùå Firestore not available', 'error');
                }

                // Optionally sync to GitHub for archival if enabled
                if (!SYNC_TO_GITHUB) return true;

                const jobsPayload = {
                    jobs: window.jobs || [],
                    lastUpdated: new Date().toISOString().split('T')[0],
                    totalJobs: (window.jobs || []).length
                };
                let sha = null;
                try {
                    const getRes = await fetch('/api/github/file/jobs-data.json');
                    if (getRes.ok) { const j = await getRes.json(); sha = j.sha || null; }
                } catch (_) {}
                const body = { content: JSON.stringify(jobsPayload, null, 2), message: `Archive jobs-data.json - ${action} ${jobTitle} - ${new Date().toLocaleString()}` };
                if (sha) body.sha = sha;
                await fetch('/api/github/file/jobs-data.json', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                return true;
            } catch (e) {
                console.error('‚ùå Error updating jobs-data:', e);
                return false;
            }
        }

        // Show job statistics
        function showJobStats() {
            const stats = {
                total: window.jobs.length,
                active: window.jobs.filter(job => job.status === 'Active').length,
                pending: window.jobs.filter(job => job.status === 'Pending').length,
                completed: window.jobs.filter(job => job.status === 'Completed').length,
                cancelled: window.jobs.filter(job => job.status === 'Cancelled').length
            };
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid #FFB200; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; color: white;">
                    <h3 style="color: #FFB200; margin-bottom: 1rem;">üìà Job Statistics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: rgba(255, 178, 0, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #FFB200;">${stats.total}</div>
                            <div>Total Jobs</div>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #22c55e;">${stats.active}</div>
                            <div>Active Jobs</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #f59e0b;">${stats.pending}</div>
                            <div>Pending Jobs</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #3b82f6;">${stats.completed}</div>
                            <div>Completed Jobs</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Bulk job actions
        function bulkJobActions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid #FFB200; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; color: white;">
                    <h3 style="color: #FFB200; margin-bottom: 1rem;">‚ö° Bulk Job Actions</h3>
                    <div style="margin-bottom: 1rem;">
                        <p>Select jobs and perform bulk actions:</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn btn-small" onclick="bulkUpdateStatus('Active')">‚úÖ Mark Active</button>
                            <button class="btn btn-small" onclick="bulkUpdateStatus('Completed')">‚úÖ Mark Completed</button>
                            <button class="btn btn-small" onclick="bulkUpdateStatus('Cancelled')">‚ùå Mark Cancelled</button>
                            <button class="btn btn-small btn-danger" onclick="bulkDeleteJobs()">üóëÔ∏è Delete Selected</button>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Bulk update job status
        function bulkUpdateStatus(newStatus) {
            const selectedJobs = window.jobs.filter((job, index) => {
                const checkbox = document.querySelector(`#job-${index}`);
                return checkbox && checkbox.checked;
            });
            
            if (selectedJobs.length === 0) {
                showNotification('Please select jobs to update', 'warning');
                return;
            }
            
            selectedJobs.forEach(job => {
                job.status = newStatus;
            });
            
            displayJobs();
            updateStats();
            showNotification(`${selectedJobs.length} jobs updated to ${newStatus}`, 'success');
        }

        // Bulk delete jobs
        function bulkDeleteJobs() {
            const selectedJobs = window.jobs.filter((job, index) => {
                const checkbox = document.querySelector(`#job-${index}`);
                return checkbox && checkbox.checked;
            });
            
            if (selectedJobs.length === 0) {
                showNotification('Please select jobs to delete', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedJobs.length} jobs?`)) {
                window.jobs = window.jobs.filter((job, index) => {
                    const checkbox = document.querySelector(`#job-${index}`);
                    return !checkbox || !checkbox.checked;
                });
                
                displayJobs();
                updateStats();
                showNotification(`${selectedJobs.length} jobs deleted`, 'success');
            }
        }

        // Export job data (legacy download UI removed)

        // Download job JSON (removed)

        // Load existing users with improved caching and persistence
        async function loadUsers() {
            if (window.MAIN_DASHBOARD_USER_DISPLAY_OVERRIDE === true) {
                console.log('‚ö†Ô∏è Modular system trying to override user loading - blocked');
                return;
            }
            console.log('üîÑ Main dashboard loadUsers (Firestore)');
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    window.users = await window.FirestoreDataManager.getUsers();
                    console.log('‚úÖ Users loaded from Firestore:', Object.keys(window.users || {}).length);

                    // Augment each user‚Äôs jobs from normalized sources (applications + contracts)
                    try {
                        const [contracts, qapps, apps] = await Promise.all([
                            window.FirestoreDataManager.getContracts().catch(()=>[]),
                            window.FirestoreDataManager.getQuickApplications().catch(()=>[]),
                            (window.FirestoreDataManager.getApplications ? window.FirestoreDataManager.getApplications().catch(()=>[]) : Promise.resolve([]))
                        ]);
                        const byEmail = (email) => String(email||'').toLowerCase();
                        const normalize = (r)=>({
                            title: r.jobTitle || r.title || r.role || 'Project',
                            location: r.location || '',
                            date: r.jobDate || r.date || '',
                            rate: r.payDisplay || r.rate || r.pay || '',
                            status: (String(r.status||r.decision||'pending').toLowerCase()==='approved')?'accepted':'pending'
                        });
                        Object.keys(window.users||{}).forEach(name=>{
                            if (name.startsWith('_')) return;
                            const u = window.users[name];
                            const email = byEmail(u?.profile?.email);
                            const src = [];
                            (qapps||[]).forEach(a=>{ if (byEmail(a?.applicant?.email)===email) src.push(normalize(a)); });
                            (apps||[]).forEach(a=>{ if (byEmail(a?.applicant?.email||a?.email)===email) src.push(normalize(a)); });
                            (contracts||[]).forEach(c=>{ if (byEmail(c?.freelancerEmail||c?.userEmail)===email) src.push({ title:c.role||c.title||'Project', location:c.location||'', date:c.signedDate||c.uploadDate||'', rate:c.rate||'', status:'accepted' }); });
                            const existing = Object.values(u.jobs||{});
                            const all = [...existing, ...src];
                            // de-dup by title+date+location
                            const seen = new Set();
                            const uniq = [];
                            const k = (j)=>[(j.title||'').toLowerCase().trim(), (j.date||'').toString(), (j.location||'').toLowerCase().trim()].join('|');
                            all.forEach(j=>{ const key=k(j); if(!seen.has(key)){ seen.add(key); uniq.push(j);} });
                            u.jobs = uniq.reduce((acc, j, i)=>{ acc['j'+i]=j; return acc; }, {});
                        });
                    } catch(augmentErr) { console.warn('‚ö†Ô∏è Could not augment users with applications/contracts:', augmentErr?.message||augmentErr); }
                } else {
                    console.warn('‚ö†Ô∏è Firestore not available; users set to empty');
                    window.users = {};
                }
            } catch (error) {
                console.error('‚ùå Error loading users from Firestore:', error);
                window.users = {};
            }
            displayUsers();
            displayArchivedUsers();
        }

        // Display active users (exclude archived/meta keys)
        function displayUsers() {
            // Prevent modular system from overriding this function
            if (window.MAIN_DASHBOARD_USER_DISPLAY_OVERRIDE === true) {
                console.log('‚ö†Ô∏è Modular system trying to override user display - blocked');
                return;
            }
            
            console.log('üîÑ Main dashboard displayUsers called');
            console.log('üîç window.users:', window.users);
            console.log('üîç User count:', Object.keys(window.users || {}).length);
            
            const usersList = document.getElementById('usersList');
            console.log('üîç usersList element:', usersList);
            
            if (usersList) {
                usersList.innerHTML = '';
                console.log('‚úÖ usersList cleared');
            } else {
                console.error('‚ùå usersList element not found');
                return;
            }

            const activeUsers = Object.keys(window.users || {})
                .filter(name => name !== '_archived' && !name.startsWith('_'));
            
            console.log('üîç Active users:', activeUsers);
            console.log('üîç Active user count:', activeUsers.length);

            activeUsers.forEach((name, index) => {
                const user = window.users[name];
                
                const userDiv = document.createElement('div');
                userDiv.className = 'item-card';
                const showApproval = (user.application?.status === 'pending' && ['apply-form','apply-html','apply'].includes((user.application?.source||'').toLowerCase()));
                userDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">${name}</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap;">
                            <span style="background: ${user.application?.status === 'pending' ? '#f59e0b' : (user.contract?.contractStatus === 'signed' ? '#22c55e' : '#6b7280')}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                ${user.application?.status === 'pending' ? 'üïí Pending' : (user.contract?.contractStatus === 'signed' ? '‚úÖ Contract Signed' : '‚Äî')}
                            </span>
                            <span style="background: ${user.paymentMethod ? '#22c55e' : '#6b7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                ${user.paymentMethod ? 'üí≥ Payment Set' : 'üí≥ No Payment'}
                            </span>
                            ${user.jobs && Object.keys(user.jobs).length > 0 ? `
                                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                    üéØ ${Object.keys(user.jobs).length} Job${Object.keys(user.jobs).length === 1 ? '' : 's'}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="item-meta">
                        <span>üìß ${user.profile?.email || 'Email not specified'}</span>
                        <span>üé≠ ${user.profile?.role || 'Role not set'}</span>
                        <span>üìç ${user.profile?.location || 'Location not specified'}</span>
                        <span>üíº ${user.jobs ? Object.keys(user.jobs).length : 0} job${user.jobs && Object.keys(user.jobs).length === 1 ? '' : 's'}</span>
                    </div>
                    <div class="item-description">
                        ${user.application?.jobTitle ? `<div><strong>Applied For:</strong> ${user.application.jobTitle}</div>` : ''}
                        ${user.jobs && Object.keys(user.jobs).length ? `<div><strong>Current Jobs:</strong><div style="margin-top:.35rem; display:flex; gap:.35rem; flex-wrap:wrap;">${Object.values(user.jobs).map(j => '<span style="background:#111827;border:1px solid #374151;color:#e5e7eb;padding:.25rem .5rem;border-radius:9999px;font-size:.8rem;">'+(j.title||'Untitled')+(j.date?' ¬∑ '+j.date:'')+(j.location?' ¬∑ '+j.location:'')+(j.rate?' ¬∑ '+j.rate:'')+(j.status?' ¬∑ '+j.status:'')+'</span>').join('')}</div></div>` : '<div><strong>Current Jobs:</strong> None</div>'}
                        <strong>Payment Method:</strong> ${user.paymentMethod || 'Not specified'}<br>
                        <strong>Contract Status:</strong> ${user.contract?.contractStatus || 'Not specified'}
                    </div>
                    <div class="item-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-small" onclick="viewUserDetails('${name}')">üë§ View Details</button>
                        <button class="btn btn-small" onclick="editUser('${name}')">‚úèÔ∏è Edit User</button>
                        <button class="btn btn-small" onclick="downloadUserContract('${name}')">üìÑ Download Contract</button>
                        <button class="btn btn-small" onclick="showBankDetails('${name}')">üè¶ Bank Details</button>
                        <button class="btn btn-small" onclick="showPerformanceReview('${name}')">‚≠ê Performance</button>
                        ${showApproval ? `<button class=\"btn btn-small\" onclick=\"approveUser('${name}')\">‚úÖ Approve</button>` : ''}
                        ${showApproval ? `<button class=\"btn btn-small btn-danger\" onclick=\"denyUser('${name}')\">‚õî Deny</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deleteUser('${name}')">üóëÔ∏è Delete</button>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }

        // Display archived users
        function displayArchivedUsers() {
            const archivedList = document.getElementById('archivedUsersList');
            if (!archivedList) return;
            archivedList.innerHTML = '';

            const archivedUsers = (window.users && window.users._archived) ? window.users._archived : {};
            const names = Object.keys(archivedUsers);

            if (names.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'item-card';
                empty.innerHTML = '<div class="item-description">No archived applicants</div>';
                archivedList.appendChild(empty);
                return;
            }

            names.forEach((name) => {
                const user = archivedUsers[name] || {};
                const userDiv = document.createElement('div');
                userDiv.className = 'item-card';
                userDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">${name}</h4>
                        <span style="background:#6b7280;color:#fff;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.8rem;">Archived</span>
                    </div>
                    <div class="item-meta">
                        <span>üìß ${user.profile?.email || 'Email not specified'}</span>
                        <span>üé≠ ${user.profile?.role || 'Role not set'}</span>
                        <span>üìç ${user.profile?.location || 'Location not specified'}</span>
                        <span>üïí ${user.application?.updatedAt ? new Date(user.application.updatedAt).toLocaleString() : '‚Äî'}</span>
                    </div>
                    <div class="item-actions" style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="btn btn-small" onclick="viewArchivedUserDetails('${name}')">üë§ View Details</button>
                        <button class="btn btn-small" onclick="restoreUser('${name}')">‚Ü©Ô∏è Restore</button>
                        <button class="btn btn-small btn-danger" onclick="deleteUser('${name}', true)">üóëÔ∏è Delete</button>
                    </div>
                `;
                archivedList.appendChild(userDiv);
            });
        }

        function viewArchivedUserDetails(userName) {
            const user = (window.users && window.users._archived) ? window.users._archived[userName] : null;
            if (!user) return showNotification('Archived user not found', 'error');
            alert(`Archived Applicant\n\nName: ${userName}\nEmail: ${user.profile?.email || 'N/A'}\nRole: ${user.profile?.role || 'N/A'}\nStatus: ${user.application?.status || 'denied'}`);
        }

        async function restoreUser(userName) {
            try {
                if (!window.users || !window.users._archived || !window.users._archived[userName]) {
                    return showNotification('Archived user not found', 'error');
                }
                const archived = window.users._archived[userName];
                // Restore to active users
                window.users[userName] = archived;
                // Ensure restored applicants return to pending state for review
                window.users[userName].application = {
                    ...(window.users[userName].application || {}),
                    status: 'pending',
                    updatedAt: new Date().toISOString(),
                };
                delete window.users._archived[userName];
                // Optionally reset status back to pending
                window.users[userName].application = window.users[userName].application || {};
                if (window.users[userName].application.status === 'denied') {
                    window.users[userName].application.status = 'pending';
                    window.users[userName].application.updatedAt = new Date().toISOString();
                }
                await updateUsersOnGitHub('restore', userName);
                displayUsers();
                displayArchivedUsers();
                updateStats();
                showNotification(`‚úÖ Restored ${userName} to active users`, 'success');
            } catch (e) {
                console.error(e);
                showNotification('Failed to restore user', 'error');
            }
        }

        // Add/Edit user
        document.getElementById('contractForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                profile: {
                    email: formData.get('email'),
                    role: formData.get('role'),
                    location: formData.get('location'),
                    rate: formData.get('rate'),
                    approvedDate: formData.get('approvedDate'),
                    projectDate: formData.get('projectDate')
                },
                contract: {
                    contractUrl: formData.get('contractUrl'),
                    contractStatus: 'pending'
                }
            };

            const name = formData.get('name');
            const editName = e.target.dataset.editName;
            
            if (editName && editName !== name) {
                delete window.users[editName];
            }
            
            // If a specific job was selected, attach it as primary
            const jobIndex = formData.get('jobSelection');
            if (jobIndex !== null && jobIndex !== '') {
                const idx = parseInt(jobIndex, 10);
                const job = Array.isArray(window.jobs) ? window.jobs[idx] : null;
                if (job) {
                    const jobId = `job-${job.title.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
                    userData.jobs = userData.jobs || {};
                    userData.jobs[jobId] = {
                        id: jobId,
                        title: job.title,
                        date: job.date,
                        location: job.location,
                        rate: job.pay,
                        description: job.description,
                        // listingStatus reflects the public job board state; do not affect user progression
                        listingStatus: job.status,
                        status: 'upcoming',
                        projectStatus: 'upcoming',
                        projectType: job.type || '',
                        paymentStatus: 'pending',
                        assignedDate: new Date().toISOString().split('T')[0],
                        projectStart: job.date || 'TBD',
                        jobRef: { source: 'jobs-data', index: idx, key: `${job.title}|${job.date}` }
                    };
                }
            }

            window.users[name] = userData;
            
            // Persist to Firestore (single source of truth)
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    // Map to existing document by email when present to avoid duplicates
                    try {
                        const existingId = await window.FirestoreDataManager.findUserIdByEmail(window.users[name]?.profile?.email || '');
                        const targetId = existingId || name;
                        await window.FirestoreDataManager.setUser(targetId, window.users[name]);
                    } catch(_){
                        await window.FirestoreDataManager.setUser(name, window.users[name]);
                    }
                    showNotification(`‚úÖ User "${name}" saved to Firestore`, 'success');
                    await loadUsers();
                } else {
                    showNotification('‚ùå Firestore not available. User not saved.', 'error');
                }
            } catch (persistError) {
                console.error('‚ùå Error saving user to Firestore:', persistError);
                showNotification('‚ùå Error saving user. Please try again.', 'error');
            }

            // Create Firebase auth account for the new user with a temp password
            try {
                const tempPassword = generateTempPassword();
                const fb = await createFirebaseAccount(userData.profile.email, tempPassword);
                if (fb.success) {
                    showNotification(`‚úÖ Firebase account created for ${userData.profile.email}`, 'success');
                } else {
                    showNotification(`‚ö†Ô∏è Firebase account not created: ${fb.error}`, 'warning');
                }
            } catch (fbErr) {
                console.warn('‚ö†Ô∏è Firebase create account failed:', fbErr?.message || fbErr);
            }

            // Send job acceptance email automatically after save
            try {
                await sendJobAcceptanceEmail(name, window.users[name]);
            } catch (emailErr) {
                console.warn('‚ö†Ô∏è Could not send job acceptance email:', emailErr?.message || emailErr);
            }

            delete e.target.dataset.editName;

            displayUsers();
            updateStats();
            clearContractForm();
        });

        // Edit user
        function editUser(name) {
            const user = window.users[name];
            if (!user) return;
            openUserEditModal(name, user);
        }

        // Lightweight modal for editing a user
        function openUserEditModal(name, user) {
            const modal = document.createElement('div');
            // Add safe-area padding and allow vertical scroll on the overlay to avoid clipping on small screens
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);z-index:12000;display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top,16px) 12px env(safe-area-inset-bottom,16px);overflow:auto;';
            modal.innerHTML = `
                <div style="background:#0f1115;border:1px solid rgba(255,178,0,0.25);border-radius:14px;width:min(560px,92%);max-height:calc(100vh - 48px);display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.5);">
                    <div style="padding:16px 18px;border-bottom:1px solid rgba(255,178,0,0.2);display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;color:#FFB200;font-family:Cinzel,serif;">Edit User</h3>
                        <button id="ue-close" class="btn btn-secondary" style="margin:0;">‚úñ</button>
                    </div>
                    <div style="padding:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px;overflow:auto;">
                        <div style="grid-column:span 2;">
                            <label>Name</label>
                            <input id="ue-name" type="text" value="${name}">
                        </div>
                        <div>
                            <label>Email</label>
                            <input id="ue-email" type="email" value="${user.profile?.email || ''}">
                        </div>
                        <div>
                            <label>Role</label>
                            <input id="ue-role" type="text" value="${user.profile?.role || ''}">
                        </div>
                        <div>
                            <label>Location</label>
                            <select id="ue-location"></select>
                        </div>
                        <div>
                            <label>Rate</label>
                            <select id="ue-rate"></select>
                        </div>
                        <div>
                            <label>Project Type</label>
                            <select id="ue-projectType"></select>
                        </div>
                        <div>
                            <label>Approved Date</label>
                            <input id="ue-approved" type="date" value="${user.profile?.approvedDate || ''}">
                        </div>
                        <div>
                            <label>Project Start</label>
                            <input id="ue-project" type="date" value="${user.profile?.projectDate || ''}">
                        </div>
                        <div>
                            <label>Project Status</label>
                            <select id="ue-projectStatus"></select>
                        </div>
                        <div>
                            <label>Payment Status</label>
                            <select id="ue-paymentStatus">
                                <option value="">Select‚Ä¶</option>
                                <option value="pending">pending</option>
                                <option value="processing">processing</option>
                                <option value="paid">paid</option>
                                <option value="overdue">overdue</option>
                            </select>
                        </div>
                    </div>
                    <div style="padding:14px 18px;border-top:1px solid rgba(255,178,0,0.2);display:flex;justify-content:flex-end;gap:10px;">
                        <button id="ue-cancel" class="btn btn-secondary">Cancel</button>
                        <button id="ue-save" class="btn">Save</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            // Populate dropdowns
            function fillSelect(id, items, value, label = 'Select‚Ä¶') {
                const el = modal.querySelector(id);
                if (!el) return;
                const opts = Array.isArray(items) ? items.slice() : [];
                if (value && !opts.includes(value)) {
                    opts.unshift(value);
                }
                el.innerHTML = `<option value="">${label}</option>` + opts.map(v=>`<option value="${v}">${v}</option>`).join('');
                if (value) el.value = value;
            }
            // Prefer primaryJob if present; allow multiple jobs
            const currentJob = (user && user.jobs && user.primaryJob && user.jobs[user.primaryJob]) ? user.jobs[user.primaryJob] : null;
            const roleValue = user?.profile?.role || user?.application?.jobTitle || '';
            const locationValue = user?.profile?.location || currentJob?.location || '';
            const rateValue = currentJob?.rate || user?.profile?.rate || '';
            const projectTypeValue = user?.profile?.projectType || currentJob?.type || '';
            const currentProjectStatus = (currentJob && (currentJob.projectStatus || currentJob.status)) || user?.profile?.projectStatus || 'upcoming';
            const currentPaymentStatus = (currentJob && currentJob.paymentStatus) || user?.paymentStatus || 'pending';
            // role is now a free-text input; no select population
            fillSelect('#ue-location', (window.dropdownOptions?.locations)||[], locationValue, 'Select‚Ä¶');
            fillSelect('#ue-rate', (window.dropdownOptions?.rates)||[], rateValue, 'Select‚Ä¶');
            fillSelect('#ue-projectType', (window.dropdownOptions?.projectTypes)||[], projectTypeValue, 'Select‚Ä¶');
            fillSelect('#ue-projectStatus', ['upcoming','in-progress','active','completed','on-hold','cancelled'], currentProjectStatus, 'Select‚Ä¶');
            fillSelect('#ue-paymentStatus', ['pending','processing','paid','overdue'], currentPaymentStatus, 'Select‚Ä¶');

            const close = () => modal.remove();
            modal.querySelector('#ue-close').onclick = close;
            modal.querySelector('#ue-cancel').onclick = close;
            modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });

            modal.querySelector('#ue-save').onclick = async () => {
                const newName = modal.querySelector('#ue-name').value.trim();
                const selectedProjectStatus = modal.querySelector('#ue-projectStatus').value || 'upcoming';
                const updated = {
                    profile: {
                        ...(user.profile||{}),
                        email: modal.querySelector('#ue-email').value.trim(),
                        role: modal.querySelector('#ue-role').value,
                        location: modal.querySelector('#ue-location').value,
                        approvedDate: modal.querySelector('#ue-approved').value,
                        projectDate: modal.querySelector('#ue-project').value,
                        projectStatus: selectedProjectStatus
                    }
                };
                // Merge or add job entry; do not collapse to single job
                const existingJobId = (user.primaryJob && user.jobs && user.jobs[user.primaryJob]) ? user.primaryJob : `job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
                const jobsCopy = { ...(user.jobs || {}) };
                jobsCopy[existingJobId] = {
                    ...(user.jobs && user.jobs[existingJobId] ? user.jobs[existingJobId] : {}),
                    id: existingJobId,
                    title: modal.querySelector('#ue-role').value || 'Assignment',
                    location: modal.querySelector('#ue-location').value || '',
                    rate: modal.querySelector('#ue-rate').value || '',
                    projectType: modal.querySelector('#ue-projectType').value || '',
                    status: selectedProjectStatus,
                    projectStatus: selectedProjectStatus,
                    projectStart: modal.querySelector('#ue-project').value || '',
                    paymentStatus: modal.querySelector('#ue-paymentStatus').value || (user.jobs && user.jobs[existingJobId]?.paymentStatus) || 'pending',
                    updatedAt: new Date().toISOString()
                };
                // Also allow top-level paymentStatus for backward compatibility
                updated.paymentStatus = modal.querySelector('#ue-paymentStatus').value || user.paymentStatus || '';
                updated.jobs = jobsCopy;
                updated.primaryJob = existingJobId;
                // Save to Firestore
                try {
                    if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                        try {
                            const existingId = await window.FirestoreDataManager.findUserIdByEmail((updated.profile||{}).email || (user.profile||{}).email || '');
                            const targetId = existingId || newName;
                            await window.FirestoreDataManager.setUser(targetId, { ...user, ...updated });
                        } catch(_) {
                            await window.FirestoreDataManager.setUser(newName, { ...user, ...updated });
                        }
                        // Assignments subcollection deprecated; do not write to a separate assignments path
                        // if name changed, remove old key in local state
                        if (newName !== name) { delete window.users[name]; }
                        window.users[newName] = { ...(user||{}), ...updated };
                        showNotification('‚úÖ User updated', 'success');
                        displayUsers();
                        updateStats();

                        // Removed admin auto-notify on payment=paid to reduce confusion.
                    }
                } catch (e) {
                    console.error(e);
                    showNotification('‚ùå Failed to save user', 'error');
                }
                close();
            };
        }

        // Assign jobs to users
        function assignJobsToUsers() {
            if (!window.jobs || window.jobs.length === 0) {
                showNotification('No jobs available to assign', 'warning');
                return;
            }
            
            if (!window.users || Object.keys(window.users).length === 0) {
                showNotification('No users available to assign jobs to', 'warning');
                return;
            }
            
            // Create modal for job assignment
            const modal = document.createElement('div');
            modal.id = 'jobAssignmentModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            const jobsHTML = window.jobs.map((job, index) => `
                <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                    <h4 style="color: #FFB200; margin-bottom: 0.5rem;">${job.title}</h4>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 1rem;">
                        <div>üìÖ ${job.date || 'No date'}</div>
                        <div>üìç ${job.location || 'No location'}</div>
                        <div>üí∞ ${job.pay || 'No pay rate'}</div>
                    </div>
                    <select id="job-${index}-user" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,178,0,0.3); border-radius: 4px; color: white;">
                        <option value="">Select a user...</option>
                        ${Object.keys(window.users).map(userName => `
                            <option value="${userName}">${userName}</option>
                        `).join('')}
                    </select>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    border: 1px solid #FFB200;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <button onclick="this.closest('#jobAssignmentModal').remove()" 
                            style="
                                position: absolute;
                                top: 1rem;
                                right: 1rem;
                                background: #ef4444;
                                color: white;
                                border: none;
                                padding: 0.5rem;
                                border-radius: 50%;
                                cursor: pointer;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">√ó</button>
                    
                    <h3 style="color: #FFB200; margin-bottom: 1.5rem; text-align: center; font-family: 'Cinzel', serif;">
                        üë• ASSIGN JOBS TO USERS
                    </h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;">
                            Select users for each job below. Users will be assigned to jobs based on their roles and availability.
                        </p>
                        ${jobsHTML}
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="processJobAssignments()" 
                                style="
                                    background: linear-gradient(135deg, #22c55e, #16a34a);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            ‚úÖ Assign Jobs
                        </button>
                        <button onclick="this.closest('#jobAssignmentModal').remove()" 
                                style="
                                    background: linear-gradient(135deg, #6b7280, #4b5563);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Assign jobs helper (legacy /api/jobs-data dependency removed; prefer UI selection or Firestore listing pickers)

        // Process job assignments
        async function processJobAssignments() {
            const assignments = [];
            let assignedCount = 0;
            
            window.jobs.forEach((job, index) => {
                const selectElement = document.getElementById(`job-${index}-user`);
                const selectedUser = selectElement.value;
                
                if (selectedUser) {
                    assignments.push({ job, jobIndex: index, user: selectedUser });
                    assignedCount++;
                }
            });
            
            if (assignedCount === 0) {
                showNotification('Please select at least one user for job assignment', 'warning');
                return;
            }
            
            // Process assignments
            assignments.forEach(assignment => {
                const userName = assignment.user;
                const job = assignment.job;
                const jobIndex = assignment.jobIndex;
                
                if (!window.users[userName].jobs) {
                    window.users[userName].jobs = {};
                }
                
                const jobId = `job-${job.title.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
                window.users[userName].jobs[jobId] = {
                    id: jobId,
                    title: job.title,
                    date: job.date,
                    location: job.location,
                    rate: job.pay,
                    description: job.description,
                    listingStatus: job.status,
                    status: 'upcoming',
                    projectStatus: 'upcoming',
                    paymentStatus: 'pending',
                    assignedDate: new Date().toISOString().split('T')[0],
                    jobRef: { source: 'jobs-data', index: jobIndex, key: `${job.title}|${job.date}` }
                };
                
                // Set as primary job if user doesn't have one
                // overwrite single current job by key
            });
            
            // Update display
            displayUsers();
            
            // Close modal
            document.getElementById('jobAssignmentModal').remove();
            
            showNotification(`Successfully assigned ${assignedCount} job(s) to users`, 'success');
            try {
                await updateUsersOnGitHub('update');
                showNotification('‚úÖ users.json updated on GitHub', 'success');
            } catch (e) {
                showNotification('‚ö†Ô∏è Failed to persist users.json to GitHub', 'warning');
            }
        }

        // Delete user (unified - handles active or archived)
        async function deleteUser(userName, isArchived = false) {
            if (!confirm(`Are you sure you want to permanently delete ${userName}? This cannot be undone.`)) return false;
            
            try {
                // Show loading state
                showNotification('Deleting user...', 'info');
                
                // Determine if user is archived
                const isArchivedUser = isArchived || !!(window.users && window.users._archived && window.users._archived[userName]);
                const userData = isArchivedUser ? window.users._archived[userName] : window.users[userName];
                
                if (!userData) {
                    throw new Error(`User ${userName} not found`);
                }

                console.log(`üóëÔ∏è Deleting user: ${userName} (archived: ${isArchivedUser})`);

                // 1. Attempt PDF + contract cleanup
                try {
                    const contract = userData.contract || {};
                    // 1a) Firestore contracts collection
                    if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                        const contractId = contract.contractId || userName;
                        try { await window.FirestoreDataManager.deleteContract(contractId); } catch(_){}
                    }
                    // 1b) Delete physical/archived PDF via API
                    if (contract.fileName || contract.contractId) {
                        const fileName = contract.fileName || `${userName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, ' ').trim()}.pdf`;
                        console.log('üóëÔ∏è Cleaning up contract PDF...');
                        const deletePdfResponse = await fetch(`${API_BASE}/api/delete-pdf`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fileName, contractId: contract.contractId || userName })
                        });
                        if (deletePdfResponse.ok) { console.log('‚úÖ PDF cleanup complete'); } else { console.warn('‚ö†Ô∏è PDF cleanup failed:', deletePdfResponse.status); }
                    }
                } catch (pdfError) {
                    console.warn('‚ö†Ô∏è PDF cleanup error:', pdfError.message);
                }

                // 2. Attempt Firebase deletion
                try {
                    const email = userData.profile?.email;
                    if (email) {
                        console.log('üóëÔ∏è Deleting Firebase account...');
                        const firebaseResult = await deleteFirebaseAccount(email);
                        if (firebaseResult.success) {
                            console.log('‚úÖ Firebase account deleted successfully');
                        } else {
                            console.warn('‚ö†Ô∏è Firebase deletion failed:', firebaseResult.error);
                        }
                    }
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Firebase deletion error:', firebaseError.message);
                }

                // 3. Remove from Firestore first (single source of truth)
                try {
                    if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                        await window.FirestoreDataManager.deleteUser(userName);
                        console.log('‚úÖ User deleted from Firestore');
                    }
                } catch (fsErr) {
                    console.warn('‚ö†Ô∏è Firestore user delete failed:', fsErr?.message || fsErr);
                }

                // 4. Remove from in-memory object
                if (isArchivedUser) {
                    if (window.users._archived) {
                        delete window.users._archived[userName];
                        console.log(`üóëÔ∏è Removed ${userName} from archived users`);
                    }
                } else {
                    delete window.users[userName];
                    console.log(`üóëÔ∏è Removed ${userName} from active users`);
                }

                // 5. Refresh display and stats from Firestore
                await loadUsers();
                updateStats();
                showNotification(`üóëÔ∏è Deleted ${userName} permanently`, 'success');
                showAdminNotification(
                    'User Deleted Successfully',
                    `‚úÖ ${userName} has been permanently deleted`,
                    'success',
                    { action: 'user_deleted', userName: userName }
                );
                return true;

            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                
                // Show error notification
                showNotification(`Failed to delete user: ${error.message}`, 'error');
                
                showAdminNotification(
                    'User Deletion Failed',
                    `‚ùå Failed to delete ${userName}: ${error.message}`,
                    'error',
                    { action: 'user_deletion_failed', userName: userName, error: error.message }
                );
                
                return false;
            }
        }

        // Clear contract form
        function clearContractForm() {
            document.getElementById('contractForm').reset();
            document.getElementById('freelancerLocation').value = 'Atlanta Area';
            document.getElementById('contractUrl').value = 'contract.html';
            delete document.getElementById('contractForm').dataset.editName;
        }

        

        // Update users with Firestore integration
        async function updateUsersOnGitHub(action = 'update', userName = '') {
            try {
                console.log('üîÑ Updating users data (Firestore first)...');
                
                // Count performance reviews in users
                let totalReviews = 0;
                for (const user of Object.values(window.users)) {
                    if (user.performance) {
                        totalReviews++;
                    }
                }
                
                const usersData = {
                    users: window.users,
                    statusOptions: {
                        projectStatus: ["upcoming", "in-progress", "completed", "cancelled"],
                        paymentStatus: ["pending", "processing", "paid", "overdue"]
                    },
                    lastUpdated: new Date().toISOString().split('T')[0],
                    totalUsers: Object.keys(window.users).length,
                    system: {
                        totalReviews: totalReviews,
                        lastUpdated: new Date().toISOString().split('T')[0]
                    }
                };
                
                // Try to save to Firestore first
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    try {
                        console.log('üî• Saving users to Firestore...');
                        
                        // Save individual user documents to Firestore
                        for (const [userId, userData] of Object.entries(window.users || {})) {
                            if (userId !== '_archived') {
                                await window.FirestoreDataManager.syncUserToFirestore(userId, userData);
                            }
                        }
                        console.log('‚úÖ Individual users saved to Firestore');
                        
                    } catch (firestoreError) {
                        console.warn('‚ö†Ô∏è Firestore save failed, falling back to GitHub:', firestoreError);
                    }
                }
                
                // Optional archival to GitHub
                if (!SYNC_TO_GITHUB) {
                    console.log('üì¶ Skipping GitHub users.json archival (SYNC_TO_GITHUB=false)');
                    try { await loadUsers(); } catch(_){}
                    return true;
                }
                console.log('üîÑ Archiving users.json to GitHub...');
                
                // First, get the current file SHA
                const getResponse = await fetch('/api/github/file/users.json');
                let sha = null;
                
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    console.log('üìÑ Got current file SHA:', sha.substring(0, 7));
                } else if (getResponse.status === 404) {
                    console.log('üìÑ File does not exist, will create new file');
                } else {
                    console.warn('‚ö†Ô∏è Could not get current file SHA, proceeding without it');
                }
                
                const updateBody = {
                    content: JSON.stringify(usersData, null, 2),
                    message: `Update users.json - ${action} ${userName} - ${new Date().toLocaleString()}`
                };
                
                // Include SHA if we have it (for updates)
                if (sha) {
                    updateBody.sha = sha;
                }
                
                const response = await fetch('/api/github/file/users.json', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateBody)
                });
                
                if (response.ok) {
                    console.log('‚úÖ users.json updated on GitHub successfully');
                    showNotification('‚úÖ Users data updated successfully and pushed to GitHub', 'success');
                    try { await loadUsers(); } catch(_){}
                    return true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Failed to update users.json on GitHub:', response.status, errorData);
                    showNotification('‚ùå Failed to update users data', 'error');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Error updating users data:', error);
                showNotification('‚ùå Error updating users data', 'error');
                return false;
            }
        }

        // Delete Firebase account
        async function deleteFirebaseAccount(email) {
            try {
                console.log(`üóëÔ∏è Attempting to delete Firebase account: ${email}`);
                
                const response = await fetch(`${API_BASE}/api/firebase`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Firebase deletion response:', result);
                    return result;
                } else {
                    const error = await response.json();
                    console.error('‚ùå Firebase deletion failed:', error);
                    return { success: false, error: error.message };
                }
                
            } catch (error) {
                console.error('‚ùå Error calling Firebase API:', error);
                return { success: false, error: error.message };
            }
        }

        // ==================== ENVIRONMENT DETECTION ====================
        
        // Auto-detect environment and set API base URL
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE = isLocal ? '' : `https://${window.location.hostname}`; // Use current domain dynamically
        
        // Admin password for testing purposes (Firebase auth is used in production)
        const ADMIN_PASSWORD = 'admin123';
        // Source of truth: Firestore. Disable JSON/GitHub file writes by default
        const SYNC_TO_GITHUB = false;
        
        console.log(`üåç Environment detected: ${isLocal ? 'Local Development' : 'Live Site'}`);
        console.log(`üîó API Base URL: ${API_BASE || 'Local (localhost:8000)'}`);
        
        // ==================== PROFESSIONAL NOTIFICATION SYSTEM ====================
        
        // (Duplicate showNotification implementation removed; primary version below)
        
        function getNotificationIcon(type) {
            const iconMap = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            return iconMap[type] || '‚ÑπÔ∏è';
        }
        
        function getNotificationColors(type) {
            const colors = {
                success: { background: '#22c55e', border: '#16a34a' },
                error: { background: '#ef4444', border: '#dc2626' },
                warning: { background: '#f59e0b', border: '#d97706' },
                info: { background: '#3b82f6', border: '#2563eb' }
            };
            return colors[type] || colors.info;
        }
        
        // Admin-specific notification system for admin actions
        function showAdminNotification(title, message, type = 'info', data = {}) {
            showNotification(message, type);
            
            // Add to notification system
            addNotification(
                title,
                message,
                type,
                {
                    ...data,
                    priority: 'normal',
                    adminSpecific: true
                }
            );
        }

        // ==================== SOPHISTICATED NOTIFICATION SYSTEM ====================
        
        // Centralized notification system with real-time updates
        let notifications = [];
        let notificationUpdateInterval;
        
        // Initialize notification system
        async function initializeNotificationSystem() {
            console.log('üîî Initializing admin-specific notification system...');
            await loadNotifications();
            startNotificationPolling();
            startAdminNotificationSystem();
            updateNotificationBadge();
            updateNotificationList();
        }
        
        // Admin-specific notification system for admin actions
        function startAdminNotificationSystem() {
            console.log('üîî Starting admin-specific notification system...');
            // Admins get notifications for admin actions like user management, job assignments, etc.
            // No automatic JSON file monitoring for admins
        }
        
        // Load notifications from centralized storage
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/api/notifications`);
                if (response.ok) {
                    const data = await response.json();
                    notifications = data.notifications || [];
                    console.log('‚úÖ Loaded notifications from API:', notifications.length);
                } else {
                    // Fallback to localStorage
                    notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    console.log('‚ö†Ô∏è Using localStorage fallback for notifications');
                }
            } catch (error) {
                console.error('‚ùå Error loading notifications:', error);
                notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            }
        }
        
        // Save notifications to centralized storage
        async function saveNotifications() {
            try {
                const response = await fetch(`${API_BASE}/api/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notifications: notifications,
                        lastUpdated: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Notifications saved to centralized storage');
                } else {
                    // Fallback to localStorage
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    console.log('‚ö†Ô∏è Using localStorage fallback for notifications');
                }
            } catch (error) {
                console.error('‚ùå Error saving notifications:', error);
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }
        }
        
        // Add notification with rich data
        async function addNotification(title, message, type = 'info', data = {}) {
            const notification = {
                id: Math.floor(Date.now() + Math.random() * 1000),
                title: title,
                message: message,
                type: type,
                data: data,
                timestamp: new Date().toISOString(),
                read: false,
                actionRequired: data.actionRequired || false,
                priority: data.priority || 'normal'
            };
            
            notifications.unshift(notification);
            await saveNotifications();
            updateNotificationBadge();
            updateNotificationList();
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Update notification list
        function updateNotificationList() {
            const container = document.getElementById('notificationList');
            if (!container) return;
            
            container.innerHTML = '';
            notifications.slice(0, 10).forEach(notification => {
                const item = document.createElement('div');
                item.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                item.innerHTML = `
                    <div class="notification-header">
                        <strong>${notification.title}</strong>
                        <span class="notification-time">${new Date(notification.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                `;
                container.appendChild(item);
            });
        }

        // Build a simple notifications panel
        document.addEventListener('DOMContentLoaded', () => {
            const bell = document.getElementById('notificationBell');
            if (!bell) return;
            let panel;
            bell.addEventListener('click', () => {
                if (panel) {
                    panel.remove();
                    panel = null;
                    return;
                }
                panel = document.createElement('div');
                panel.id = 'notificationPanel';
                panel.style.cssText = 'position:absolute; top:60px; left:16px; width:340px; max-height:380px; overflow:auto; background:rgba(0,0,0,0.9); border:1px solid rgba(255,178,0,0.3); border-radius:8px; z-index:10000; padding:10px; backdrop-filter: blur(10px);';
                panel.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <strong style="color:#FFB200;">Notifications</strong>
                        <button id="markAllReadBtn" style="background:rgba(255,178,0,0.15); color:#FFB200; border:1px solid rgba(255,178,0,0.3); padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px;">Mark all read</button>
                    </div>
                    <div id="notificationList"></div>
                `;
                document.querySelector('.dashboard-header').appendChild(panel);
                updateNotificationList();
                document.getElementById('markAllReadBtn').onclick = async () => {
                    notifications = notifications.map(n => ({ ...n, read: true }));
                    await saveNotifications();
                    updateNotificationBadge();
                    updateNotificationList();
                };
            });
            // Kick off notifications
            initializeNotificationSystem();
        });
        
        // Start notification polling
        function startNotificationPolling() {
            // Less frequent now; Firestore covers app realtime
            notificationUpdateInterval = setInterval(async () => {
                await loadNotifications();
                updateNotificationBadge();
                updateNotificationList();
            }, 60000);
        }
        
        // Stop notification polling
        function stopNotificationPolling() {
            if (notificationUpdateInterval) {
                clearInterval(notificationUpdateInterval);
            }
        }

        // ==================== DATA SOURCE ARCHITECTURE ====================
        
        /*
        DATA SOURCE CLARIFICATION:
        
        üìã dropdown-options.json (MASTER SOURCE)
        - Purpose: Centralized source for ALL dropdown options
        - Controls: roles, locations, rates, projectTypes
        - Managed by: Admin Dashboard Dropdown Management
        - Structure:
          {
            "roles": ["Photographer", "Videographer", "Editor", ...],
            "locations": ["Atlanta, GA", "Los Angeles, CA", "New York, NY", ...],
            "rates": ["$50/hour", "$100/hour", "$200/hour", ...],
            "projectTypes": ["Wedding", "Commercial", "Corporate Event", ...]
          }
        
        /*
        üë• users.json (USER DATA)
        - Purpose: Stores user profile data (references dropdown options)
        - References: dropdown-options.json for role, location, rate
        - Structure: Contains user profiles with role, location, rate from dropdown options
        
        üìã jobs-data.json (JOB DATA)
        - Purpose: Stores job listings (references dropdown options)
        - References: dropdown-options.json for location, projectType
        - Structure: Contains job listings with location, projectType, pay from dropdown options
        
        DATA FLOW:
        dropdown-options.json (Master) 
            ‚Üì (provides options)
        users.json (User Profiles) ‚Üê‚Üí jobs-data.json (Job Listings)
            ‚Üì (uses options)
        Admin Dashboard & User Portal
        
        BENEFITS:
        ‚úÖ Single source of truth for all dropdown options
        ‚úÖ Consistent data across user and job systems
        ‚úÖ Easy management from one interface
        ‚úÖ No data conflicts or inconsistencies
        ‚úÖ Scalable architecture for future additions
        
        ROLE vs PROJECT TYPE CLARIFICATION:
        
        üé≠ ROLES (User-Specific):
        - Definition: User's professional role/career
        - Examples: Photographer, Videographer, Editor, Producer, Director
        - Stored in: users.json under user.profile.role
        - Used in: User creation form, user profiles
        - Purpose: Defines what the user does professionally
        
        üé¨ PROJECT TYPES (Job-Specific):
        - Definition: Types of projects/jobs available
        - Examples: Wedding Photography, Corporate Event, Commercial Video, Product Photography
        - Stored in: jobs-data.json under job.projectType
        - Used in: Job creation form, job listings
        - Purpose: Defines what type of project the job is
        
        KEY DIFFERENCES:
        ‚úÖ Roles are user-specific (what they do professionally)
        ‚úÖ Project Types are job-specific (what type of project it is)
        ‚úÖ User creation form only needs Role field (not Project Type)
        ‚úÖ Job creation form needs Project Type field (not Role)
        ‚úÖ Clear separation prevents confusion between career and project type
        */
        
        // ==================== CORE FUNCTION RESTORATION ====================
        
        // Firebase Management Functions
        function showFirebaseManagement() {
            const container = document.getElementById('firebase-tab');
            if (!container) {
                console.error('‚ùå Firebase tab container not found');
                showNotification('Error: Firebase tab not found', 'error');
                return;
            }
            
            container.innerHTML = `
                <div class="form-section">
                    <h2><i class="fas fa-fire"></i> Firebase Authentication Management</h2>
                    <div class="firebase-management">
                        <div class="info-card">
                            <h3><i class="fas fa-info-circle"></i> Current Authentication Setup</h3>
                            <p><strong>Admin Dashboard:</strong> Uses Firebase Authentication with role-based access</p>
                            <p><strong>User Portal:</strong> Now uses Firebase Authentication (updated)</p>
                            <p><strong>Security:</strong> Only admin emails can access admin dashboard</p>
                        </div>
                        
                        <div class="action-card">
                            <h3><i class="fas fa-users"></i> Create Firebase Accounts</h3>
                            <p>Create Firebase authentication accounts for all existing users in the system.</p>
                            <button onclick="createFirebaseAccountsForExistingUsers()" class="action-btn">
                                <i class="fas fa-plus"></i> Create Firebase Accounts
                            </button>
                        </div>
                        
                        <div class="info-card">
                            <h3><i class="fas fa-shield-alt"></i> Security Notes</h3>
                            <ul>
                                <li>Admin emails: ${ADMIN_EMAILS.join(', ')}</li>
                                <li>Users can only access their own portal</li>
                                <li>Admins can access both admin dashboard and user portal</li>
                                <li>Firebase handles password security and authentication</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update existing users with missing job data
        async function updateExistingUsersWithJobData() {
            try {
                console.log('üîÑ Updating existing users with missing job data...');
                
                let updatedCount = 0;
                
                for (const [userName, userData] of Object.entries(window.users || {})) {
                    // Check if user has empty jobs object or null primaryJob
                    if (!userData.jobs || Object.keys(userData.jobs).length === 0) {
                        console.log(`üîÑ Updating job data for user: ${userName}`);
                        
                        const role = userData.profile?.role || 'Producer';
                        const location = userData.profile?.location || 'Atlanta, GA';
                        
                        // Assign job data
                        const assignedJobs = await assignJobsToUser(role, location);
                        
                        // Update user data
                        window.users[userName].jobs = assignedJobs.jobs;
                        
                        updatedCount++;
                        console.log(`‚úÖ Updated job data for ${userName}`);
                    }
                }
                
                if (updatedCount > 0) {
                    // Update localStorage
                    localStorage.setItem('users', JSON.stringify(window.users));
                    
                    // Update GitHub repository
                    await updateUsersOnGitHub();
                    
                    showNotification(`‚úÖ Updated job data for ${updatedCount} existing users`, 'success');
                } else {
                    console.log('‚úÖ All users already have job data');
                }
                
            } catch (error) {
                console.error('‚ùå Error updating existing users with job data:', error);
                showNotification('‚ùå Error updating existing users with job data', 'error');
            }
        }

        // Manual refresh removed from UI; data is realtime via Firestore listeners
        
        
        
        

        

        
        
        // Check if performance review should be shown for a user
        function shouldShowPerformanceReview(userData) {
            // consider either payment paid OR project completed
            let hasCompletedOrPaid = false;
            if (userData && userData.jobs && Object.keys(userData.jobs).length > 0) {
                const jobsArr = Object.values(userData.jobs);
                hasCompletedOrPaid = jobsArr.some(job => 
                    String(job.paymentStatus || '').toLowerCase() === 'paid' ||
                    String(job.projectStatus || '').toLowerCase() === 'completed'
                );
            }
            // also consider top-level paymentStatus when present
            if (!hasCompletedOrPaid && String(userData?.paymentStatus || '').toLowerCase() === 'paid') {
                hasCompletedOrPaid = true;
            }
            const existingReview = userData?.performance || null;
            return hasCompletedOrPaid && (!existingReview || existingReview.status === 'pending');
        }
        
        // Check for performance review alerts
        function checkPerformanceReviewAlerts() {
            const pendingReviews = Object.values(window.users || {}).filter(userData => shouldShowPerformanceReview(userData));
            
            if (pendingReviews.length > 0) {
                const alertContainer = document.createElement('div');
                alertContainer.id = 'performanceReviewAlert';
                alertContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    max-width: 300px;
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                
                alertContainer.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; color: white;"><i class="fas fa-star"></i> Performance Reviews Due</h4>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">√ó</button>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">
                        ${pendingReviews.length} user${pendingReviews.length > 1 ? 's' : ''} need${pendingReviews.length > 1 ? '' : 's'} performance review.
                    </p>
                    <div style="margin-top: 0.5rem;">
                        <button onclick="showPerformanceReviewList()" 
                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            View All
                        </button>
                    </div>
                `;
                
                document.body.appendChild(alertContainer);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    const alert = document.getElementById('performanceReviewAlert');
                    if (alert) alert.remove();
                }, 10000);
            }
        }

        // Show performance review list
        function showPerformanceReviewList() {
            const pendingReviews = Object.values(window.users || {}).filter(userData => shouldShowPerformanceReview(userData));
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a1a; padding: 2rem; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,178,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #FFB200; margin: 0;"><i class="fas fa-star"></i> Performance Reviews Due</h2>
                        <button onclick="closeModal(this)" 
                                style="background: none; border: none; color: #FFB200; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;">
                            The following users have completed paid projects and need performance reviews:
                        </p>
                        ${pendingReviews.map(userData => `
                            <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="color: #FFB200; margin: 0 0 0.5rem 0;">${Object.keys(window.users || {}).find(key => window.users[key] === userData)}</h4>
                                        <p style="color: rgba(255,255,255,0.8); margin: 0; font-size: 0.9rem;">${userData.profile?.email || 'No email'}</p>
                                    </div>
                                    <button onclick="showPerformanceReviewModal('${Object.keys(window.users || {}).find(key => window.users[key] === userData)}'); closeModal(this);" 
                                            style="background: #FFB200; color: #000; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Review Now
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,178,0,0.2);">
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Performance reviews help improve collaboration and future opportunities.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Get performance review status badge
        function getPerformanceReviewStatus(userData) {
            // Try multiple ways to get the email
            const userEmail = userData.profile?.email || userData.email || userData.profile?.userEmail;
            const userName = userData.profile?.name || userData.name || 'Unknown User';
            console.log('üîç Checking performance review for user:', userName, 'Email:', userEmail);
            console.log('üîç Available performance reviews:', Object.keys(performanceReviews));
            
            const existingReview = performanceReviews[userEmail];
            
            if (existingReview) {
                return `<span style="background: #22c55e; color: white; padding: 0.3rem 0.8rem; border-radius: 6px; font-weight: bold; font-size: 0.9rem;">COMPLETED</span>`;
            } else {
                return `<span style="background: #f59e0b; color: white; padding: 0.3rem 0.8rem; border-radius: 6px; font-weight: bold; font-size: 0.9rem;">PENDING</span>`;
            }
        }
        
        // Generate temporary password for Firebase account
        function generateTempPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }
        
        // Send job acceptance email
        async function sendJobAcceptanceEmail(userName, userData, options = {}) {
            try {
                // Debug: Log the user data structure to understand what's available
                console.log('üîç Debug: User data for email:', {
                    userName,
                    userData,
                    jobs: userData?.jobs,
                    jobRate: (userData?.jobs && Object.values(userData.jobs)[0]?.rate),
                    applicationJobTitle: userData?.application?.jobTitle
                });

                // Prepare email parameters (no contract ID until user actually signs)
                const preferredJob = (options && options.jobKey && userData?.jobs?.[options.jobKey])
                    || (userData?.primaryJob && userData?.jobs?.[userData.primaryJob])
                    || (userData?.jobs && Object.values(userData.jobs)[0])
                    || null;

                const projectStart = userData?.application?.eventDate 
                    || (preferredJob && preferredJob.date)
                    || userData?.profile?.projectDate
                    || userData?.profile?.projectStart
                    || 'TBD';
                const jobTitle = (preferredJob && (preferredJob.title || preferredJob.jobTitle))
                    || userData?.application?.jobTitle
                    || userData?.application?.job
                    || userData?.profile?.role
                    || 'Contractor';
                // Get rate ONLY from the job they're assigned to (no more personal rates)
                let rate = 'Rate to be determined';
                if (preferredJob && preferredJob.rate) {
                    rate = preferredJob.rate;
                    console.log('‚úÖ Rate from selected job:', rate);
                } else if (preferredJob && preferredJob.pay) {
                    rate = preferredJob.pay;
                    console.log('‚ÑπÔ∏è Using pay as rate for email:', rate);
                } else if (userData?.jobs && Object.keys(userData.jobs).length > 0) {
                    // Fallback: get rate from any available job
                    const firstJob = Object.values(userData.jobs)[0];
                    if (firstJob?.rate) {
                        rate = firstJob.rate;
                        console.log('‚úÖ Rate from available job:', rate);
                    }
                }
                
                console.log('üéØ Final rate for email:', rate);

                // Debug: Log the extracted values
                console.log('üîç Debug: Extracted email values:', {
                    projectStart,
                    jobTitle,
                    rate,
                    primaryJobRate: userData?.jobs?.[userData?.primaryJob]?.rate
                });

                // Additional debugging for job data structure
                if (userData?.jobs) {
                    console.log('üîç Debug: Job lookup details:', {
                        availableJobKeys: Object.keys(userData.jobs),
                        jobData: Object.values(userData.jobs)[0],
                        directRateAccess: Object.values(userData.jobs)[0]?.rate
                    });
                }

                // Map our data to the template_job_acceptance format
                const emailParams = {
                    // destination
                    to_email: userData.profile.email,
                    // template_job_acceptance expects these specific variable names
                    freelancer_name: userName || 'User',
                    role: userData.profile.role || jobTitle || 'Contractor',
                    location: userData.profile.location || 'Atlanta Area',
                    rate: rate || 'Rate to be determined',
                    project_start: projectStart || 'TBD',
                    job: jobTitle || 'Contractor Position',
                    contract_id: 'Will be generated when you sign the contract',
                    // helpful extras commonly used by templates
                    to_name: userName || 'User',
                    reply_to: 'info@cochranfilms.com',
                    from_name: 'Cochran Films Admin'
                };

                // Validate email parameters to prevent 422 errors
                const requiredParams = ['freelancer_name', 'role', 'location', 'rate', 'project_start', 'job', 'contract_id'];
                const missingParams = requiredParams.filter(param => !emailParams[param] || emailParams[param].toString().trim() === '');
                
                if (missingParams.length > 0) {
                    console.warn('‚ö†Ô∏è Missing or empty email parameters:', missingParams);
                    console.warn('üìß Email params before validation:', emailParams);
                    
                    // Fill in missing parameters with defaults
                    missingParams.forEach(param => {
                        if (!emailParams[param] || emailParams[param].toString().trim() === '') {
                            switch (param) {
                                case 'freelancer_name':
                                    emailParams[param] = 'User';
                                    break;
                                case 'role':
                                    emailParams[param] = 'Contractor';
                                    break;
                                case 'location':
                                    emailParams[param] = 'Atlanta Area';
                                    break;
                                case 'rate':
                                    emailParams[param] = 'Rate to be determined';
                                    break;
                                case 'project_start':
                                    emailParams[param] = 'TBD';
                                    break;
                                case 'job':
                                    emailParams[param] = 'Contractor Position';
                                    break;
                                case 'contract_id':
                                    emailParams[param] = 'Will be generated when you sign the contract';
                                    break;
                            }
                        }
                    });
                    
                    console.log('üìß Email params after validation:', emailParams);
                }

                console.log('üìß Sending job acceptance email to:', userData.profile.email);
                console.log('üìß Using template:', EMAILJS_CONFIG.jobAcceptanceTemplateId);
                console.log('üìß Email parameters:', emailParams);

                // Send email using EmailJS
                if (typeof emailjs !== 'undefined') {
                    try {
                        console.log('üîÑ Attempting to send email via EmailJS...');
                        
                        const response = await emailjs.send(
                            EMAILJS_CONFIG.serviceId,
                            EMAILJS_CONFIG.jobAcceptanceTemplateId,
                            emailParams
                        );
                        
                        console.log('‚úÖ Job acceptance email sent successfully:', response);
                        showNotification(`‚úÖ Email sent to ${userData.profile.email}`, 'success');
                        
                        // Show success message
                        setTimeout(() => {
                            showNotification(`üéâ User approved and email sent!\n\nüìß Email sent to: ${userData.profile.email}\n\n‚úÖ The user will receive the job acceptance email with contract signing instructions.`, 'success');
                        }, 1000);
                        
                    } catch (emailError) {
                        console.error('‚ùå EmailJS error details:', {
                            message: emailError.message,
                            status: emailError.status,
                            response: emailError.response,
                            stack: emailError.stack
                        });
                        
                        // Provide more specific error information
                        let errorMessage = 'Email failed';
                        if (emailError.status === 422) {
                            errorMessage = 'EmailJS unprocessable entity (422) - check template variables match exactly and template is published';
                        } else if (emailError.status === 403) {
                            errorMessage = 'EmailJS access denied (403) - check domain restrictions and service configuration';
                        } else if (emailError.status === 400) {
                            errorMessage = 'EmailJS bad request (400) - check template variables and service configuration';
                        } else if (emailError.status === 401) {
                            errorMessage = 'EmailJS unauthorized (401) - check service authentication';
                        } else {
                            errorMessage = `EmailJS error: ${emailError.message}`;
                        }
                        
                        showNotification(`‚ö†Ô∏è ${errorMessage}`, 'error');
                        
                        // Try alternative template if main template fails
                        if (emailError.status === 422) {
                            console.log('üîÑ Attempting to send with alternative template...');
                            try {
                                const alternativeResponse = await emailjs.send(
                                    EMAILJS_CONFIG.serviceId,
                                    EMAILJS_CONFIG.jobClosedTemplateId,
                                    emailParams
                                );
                                console.log('‚úÖ Alternative template worked:', alternativeResponse);
                                showNotification(`‚úÖ Email sent via alternative template to ${userData.profile.email}`, 'success');
                                return; // Success with alternative template
                            } catch (altError) {
                                console.error('‚ùå Alternative template also failed:', altError);
                                showNotification(`‚ö†Ô∏è Both templates failed. Please check EmailJS configuration.`, 'error');
                            }
                        }
                        
                        // Log detailed error for debugging
                        console.error('‚ùå Full EmailJS error object:', emailError);
                    }
                    
                } else {
                    console.warn('‚ö†Ô∏è EmailJS library not loaded');
                    showNotification('‚úÖ User saved successfully!\n\n‚ö†Ô∏è EmailJS not configured - please set up EmailJS to send automatic job acceptance emails.', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Error sending job acceptance email:', error);
                showNotification('‚úÖ User saved successfully!\n\n‚ö†Ô∏è Email sending failed. Please check EmailJS configuration.', 'warning');
            }
        }

        // Validate user data
        function validateUserData(userName, userData) {
            if (!userName.trim() || !userData.profile.email.trim() || !userData.profile.role.trim()) {
                showNotification('Name, email, and role are required', 'error');
                return false;
            }
            return true;
        }

        // Approve existing user (for users already in the system)
        async function approveUser(userName) {
            const userData = window.users[userName];
            if (!userData) {
                showNotification('User not found', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to approve ${userName}?\n\nThis will send them a job acceptance email with contract signing instructions.`)) {
                // Update approval date if not set and set application status to approved
                userData.profile = userData.profile || {};
                if (!userData.profile.approvedDate) {
                    userData.profile.approvedDate = new Date().toISOString().split('T')[0];
                }
                userData.application = { ...(userData.application || {}), status: 'approved', updatedAt: new Date().toISOString() };
                
                // Normalize role defaults for email params (no more personal rates)
                if (!userData.profile.role) {
                    const inferredRole = userData.application?.jobTitle || userData.application?.role || 'Contractor';
                    userData.profile.role = inferredRole;
                }
                // Rate is now ONLY determined by the job they're assigned to

                // Persist to Firestore (single source of truth)
                try {
                    await window.FirebaseConfig.waitForInit();
                    await window.FirestoreDataManager.setUser(userName, userData);
                } catch (e) { console.warn('‚ö†Ô∏è Firestore setUser failed on approve:', e?.message || e); }

                // Attach job by Firestore listing title as single current job; inactivate listing
                try {
                    // Ensure jobs are loaded from Firestore
                    if (!Array.isArray(window.jobs) || window.jobs.length === 0) {
                        try { window.jobs = await window.FirestoreDataManager.getJobListings(); } catch(_) {}
                    }
                    const desiredTitle = (userData.application?.jobTitle || userData.application?.job || userData.application?.title || '').trim();
                    if (desiredTitle && Array.isArray(window.jobs)) {
                        const t = desiredTitle.toLowerCase();
                        const jobPublic = window.jobs.find(j => String(j.title||'').toLowerCase() === t) ||
                                          window.jobs.find(j => String(j.title||'').toLowerCase().includes(t) || t.includes(String(j.title||'').toLowerCase()));
                        if (jobPublic) {
                            const jobId = jobPublic.id || `job-${(jobPublic.title||'').toLowerCase().replace(/[^a-z0-9\s-]/gi,'').replace(/\s+/g,'-')}`;
                            userData.jobs = userData.jobs || {};
                            userData.jobs[jobId] = {
                                id: jobId,
                                title: jobPublic.title,
                                date: jobPublic.date || userData.application?.eventDate || '',
                                location: jobPublic.location || userData.profile?.location || 'Atlanta Area',
                                rate: jobPublic.pay || jobPublic.rate || '',
                                description: jobPublic.description || userData.application?.description || '',
                                type: jobPublic.type || '',
                                listingStatus: jobPublic.status || 'Active',
                                status: 'upcoming',
                                projectStatus: 'upcoming',
                                paymentStatus: 'pending',
                                assignedDate: new Date().toISOString().split('T')[0],
                                jobRef: { source: 'firestore', id: jobId }
                            };
                            // Map job details directly into user.profile for portal/profile editing surfaces
                            userData.profile = userData.profile || {};
                            userData.profile.role = jobPublic.title || userData.profile.role || 'Contractor';
                            userData.profile.location = jobPublic.location || userData.profile.location || 'Atlanta Area';
                            userData.profile.rate = jobPublic.pay || userData.profile.rate || '';
                            userData.profile.projectDate = jobPublic.date || userData.profile.projectDate || '';
                            // no profile.projectType field anymore
                            try { await window.FirestoreDataManager.setUser(userName, userData); } catch(_) {}
                            try { jobPublic.status = 'Inactive'; await window.FirestoreDataManager.setJobListing(jobId, jobPublic); displayJobs(); } catch(_) {}
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Could not attach job or set inactive on approval:', err);
                }

                // Send job acceptance email
                sendJobAcceptanceEmail(userName, userData);

                // Save updated user data
                localStorage.setItem('users', JSON.stringify(window.users));
                await updateUsersOnGitHub();
                displayUsers();
                
                showNotification(`‚úÖ ${userName} approved successfully!`, 'success');
            }
        }

        // Deny user application and send job-closed email (move to archive)
        async function denyUser(userName) {
            const userData = window.users[userName];
            if (!userData) {
                showNotification('User not found', 'error');
                return;
            }
            if (!confirm(`Deny application for ${userName}?`)) return;

            try {
                // Prepare job reference/details if any
                const job = (userData.jobs && Object.values(userData.jobs)[0]) || null;
                const jobTitle = userData?.application?.jobTitle || job?.title || 'a Cochran Films role';
                const projectStart = job?.date || userData?.profile?.projectDate || 'TBD';

                // Send EmailJS template for jobs closed (using template_jobs_closed)
                if (typeof emailjs !== 'undefined') {
                    const params = {
                        // Map to template_jobs_closed variables
                        to_email: userData.profile.email,
                        freelancer_name: userName,
                        job: jobTitle,
                        project_start: projectStart,
                        // Helpful extras commonly used by EmailJS
                        to_name: userName,
                        reply_to: 'info@cochranfilms.com',
                        from_name: 'Cochran Films Admin'
                    };
                    try {
                        console.log('üìß Sending denial email via EmailJS:', {
                            service: EMAILJS_CONFIG.serviceId,
                            template: EMAILJS_CONFIG.jobClosedTemplateId,
                            to: params.email,
                            job: params.job,
                            project_start: params.project_start
                        });
                        await emailjs.send(
                            EMAILJS_CONFIG.serviceId,
                            EMAILJS_CONFIG.jobClosedTemplateId,
                            params
                        );
                        showNotification(`‚úÖ Denial email sent to ${userData.profile.email}`, 'success');
                    } catch (e) {
                        console.error('‚ùå EmailJS deny error:', e);
                        showNotification(`‚ö†Ô∏è Denial email failed: ${e.message}`, 'warning');
                    }
                } else {
                    console.warn('‚ö†Ô∏è EmailJS not available, skipping denial email');
                }

                // Move denied user to archive
                window.users._archived = window.users._archived || {};
                const archivedCopy = { ...userData };
                archivedCopy.application = { ...(archivedCopy.application || {}), status: 'denied', updatedAt: new Date().toISOString() };
                archivedCopy.archived = true;
                window.users._archived[userName] = archivedCopy;
                delete window.users[userName];

                // Persist denial state to Firestore
                try { await window.FirebaseConfig.waitForInit(); await window.FirestoreDataManager.setUser(userName, archivedCopy); } catch(e){ console.warn('‚ö†Ô∏è Firestore setUser failed on deny:', e?.message || e); }

                await updateUsersOnGitHub('deny->archive', userName);
                displayUsers();
                displayArchivedUsers();
                updateStats();
                showNotification(`‚õî ${userName} denied and moved to archive`, 'info');
            } catch (err) {
                console.error(err);
                showNotification('‚ùå Failed to process denial', 'error');
            }
        }
        
        // Populate user dropdowns
        function populateUserDropdowns() {
            // Populate contract upload user dropdown
            const uploadUserSelect = document.getElementById('uploadFreelancerName');
            if (uploadUserSelect) {
                uploadUserSelect.innerHTML = '<option value="">Select a user...</option>';
                Object.keys(window.users || {}).forEach(userName => {
                    const option = document.createElement('option');
                    option.value = userName;
                    option.textContent = userName;
                    uploadUserSelect.appendChild(option);
                });
            }
            
            // Populate job assignment user dropdown
            const jobAssignmentSelect = document.getElementById('jobAssignmentFreelancer');
            if (jobAssignmentSelect) {
                jobAssignmentSelect.innerHTML = '<option value="">Choose a user...</option>';
                Object.keys(window.users || {}).forEach(userName => {
                    const option = document.createElement('option');
                    option.value = userName;
                    option.textContent = userName;
                    jobAssignmentSelect.appendChild(option);
                });
            }
            
            console.log('üë• Populated user dropdowns with', Object.keys(window.users || {}).length, 'options');
        }

        // Load dropdown options from API or use defaults
        async function loadDropdownOptions() {
            try {
                console.log('üîÑ Loading dropdown options...');
                
                const response = await fetch(`${API_BASE}/api/dropdown-options`);
                
                if (response.ok) {
                    window.dropdownOptions = await response.json();
                    console.log('üìã Loaded dropdown options from API:', window.dropdownOptions);
                } else {
                    console.warn(`‚ö†Ô∏è API returned status ${response.status}, using defaults`);
                    // Initialize with default options if API fails
                    window.dropdownOptions = {
                        roles: ['Backdrop Photographer', 'Editor', 'Videographer', 'Photographer', 'Full Stack Designer', 'Video Editor', 'Corporate Videographer'],
                        locations: ['6695 Church Street, Douglasville, GA 30134', 'Sandy Springs, GA', 'Douglasville, GA', 'Atlanta, GA', 'Atlanta Area'],
                        rates: ['$400.00 USD (Flat)', '$450.00 USD (Flat)', '$500.00 USD (Flat)', '$750.00 USD (Flat)', '$900.00 USD (Flat)', '$150/day', '$200/day'],
                        projectTypes: ['Photography', 'Video', 'Editor Project', 'Corporate Video', 'Event Coverage', 'Product Photography', 'Real Estate', 'Wedding', 'Commercial'],
                        paymentMethods: ['Cash', 'Check', 'Zelle', 'PayPal', 'Invoice Request'],
                        projectStatuses: ['upcoming', 'in-progress', 'completed', 'cancelled'],
                        paymentStatuses: ['pending', 'processing', 'paid', 'overdue']
                    };
                    console.log('üìã Initialized default dropdown options (API failed):', window.dropdownOptions);
                }
            } catch (error) {
                console.error('‚ùå Error loading dropdown options from API:', error);
                
                // Initialize with default options
                window.dropdownOptions = {
                    roles: ['Backdrop Photographer', 'Editor', 'Videographer', 'Photographer', 'Full Stack Designer', 'Video Editor', 'Corporate Videographer'],
                    locations: ['6695 Church Street, Douglasville, GA 30134', 'Sandy Springs, GA', 'Douglasville, GA', 'Atlanta, GA', 'Atlanta Area'],
                    rates: ['$400.00 USD (Flat)', '$450.00 USD (Flat)', '$500.00 USD (Flat)', '$750.00 USD (Flat)', '$900.00 USD (Flat)', '$150/day', '$200/day'],
                    projectTypes: ['Photography', 'Video', 'Editor Project', 'Corporate Video', 'Event Coverage', 'Product Photography', 'Real Estate', 'Wedding', 'Commercial'],
                    paymentMethods: ['Cash', 'Check', 'Zelle', 'PayPal', 'Invoice Request'],
                    projectStatuses: ['upcoming', 'in-progress', 'completed', 'cancelled'],
                    paymentStatuses: ['pending', 'processing', 'paid', 'overdue']
                };
                console.log('üìã Initialized default dropdown options (error):', window.dropdownOptions);
            }
            
            // Populate the management interface
            populateDropdownManagementInterface();
            
            // Populate user creation dropdowns
            populateUserCreationDropdowns();
            
            // Populate job assignment dropdowns
            populateJobAssignmentDropdowns();
        }
        
        // Populate dropdown management interface
        function populateDropdownManagementInterface() {
            if (!window.dropdownOptions) return;
            
            // Populate roles list
            const rolesList = document.getElementById('rolesList');
            if (rolesList) {
                rolesList.innerHTML = window.dropdownOptions.roles.map(role => `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem;">
                        <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">${role}</span>
                        <button onclick="removeDropdownOption('roles', '${role}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
            
            // Populate locations list
            const locationsList = document.getElementById('locationsList');
            if (locationsList) {
                locationsList.innerHTML = window.dropdownOptions.locations.map(location => `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem;">
                        <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">${location}</span>
                        <button onclick="removeDropdownOption('locations', '${location}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
            
            // Populate rates list
            const ratesList = document.getElementById('ratesList');
            if (ratesList) {
                ratesList.innerHTML = window.dropdownOptions.rates.map(rate => `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem;">
                        <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">${rate}</span>
                        <button onclick="removeDropdownOption('rates', '${rate}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
            
            // Populate project types list
            const projectTypesList = document.getElementById('projectTypesList');
            if (projectTypesList) {
                projectTypesList.innerHTML = window.dropdownOptions.projectTypes.map(type => `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem;">
                        <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">${type}</span>
                        <button onclick="removeDropdownOption('projectTypes', '${type}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
            
            console.log('üìã Populated dropdown management interface');
        }
        
        // Add dropdown option
        async function addDropdownOption(category, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!value) {
                showNotification('Please enter a value to add.', 'error');
                return;
            }
            
            // Safety check for dropdownOptions
            if (!window.dropdownOptions) {
                console.error('‚ùå Dropdown options not loaded yet');
                showNotification('Dropdown options are still loading. Please try again.', 'error');
                return;
            }
            
            if (!window.dropdownOptions[category]) {
                window.dropdownOptions[category] = [];
            }
            
            if (window.dropdownOptions[category].includes(value)) {
                showNotification('This option already exists.', 'warning');
                return;
            }
            
            window.dropdownOptions[category].push(value);
            input.value = '';
            
            // Update the management interface
            populateDropdownManagementInterface();
            
            // Update job assignment dropdowns
            populateJobAssignmentDropdowns();
            
            console.log(`‚úÖ Added ${value} to ${category}`);
            
            // Automatically save to GitHub
            try {
                console.log('üîÑ Saving dropdown options to GitHub...');
                await saveDropdownOptions();
                showNotification(`‚úÖ Added "${value}" to ${category} and saved to GitHub`, 'success');
            } catch (error) {
                console.error('‚ùå Error saving dropdown options:', error);
                showNotification(`‚ùå Added "${value}" to ${category} but failed to save to GitHub: ${error.message}`, 'error');
            }
        }
        
        // Remove dropdown option
        async function removeDropdownOption(category, value) {
            // Safety check for dropdownOptions
            if (!window.dropdownOptions) {
                console.error('‚ùå Dropdown options not loaded yet');
                showNotification('Dropdown options are still loading. Please try again.', 'error');
                return;
            }
            
            if (window.dropdownOptions[category]) {
                window.dropdownOptions[category] = window.dropdownOptions[category].filter(item => item !== value);
                populateDropdownManagementInterface();
                populateJobAssignmentDropdowns();
                console.log(`‚úÖ Removed ${value} from ${category}`);
                
                // Automatically save to GitHub
                try {
                    console.log('üîÑ Saving dropdown options to GitHub...');
                    await saveDropdownOptions();
                    showNotification(`‚úÖ Removed "${value}" from ${category} and saved to GitHub`, 'success');
                } catch (error) {
                    console.error('‚ùå Error saving dropdown options:', error);
                    showNotification(`‚ùå Removed "${value}" from ${category} but failed to save to GitHub: ${error.message}`, 'error');
                }
            }
        }
        
        // Save dropdown options to GitHub API
        async function saveDropdownOptions() {
            if (!window.dropdownOptions) {
                showNotification('‚ùå No dropdown options to save.', 'error');
                return;
            }
            
            try {
                // Always save dropdown options to Firestore first
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    await window.FirestoreDataManager.setDropdownOptions(window.dropdownOptions);
                    showNotification('‚úÖ Dropdown options saved to Firestore', 'success');
                }

                // Optional archival sync to GitHub
                if (!SYNC_TO_GITHUB) return;
                const getResponse = await fetch('/api/github/file/dropdown-options.json');
                let sha = null;
                if (getResponse.ok) { const fileData = await getResponse.json(); sha = fileData.sha; }
                const updateBody = { content: btoa(JSON.stringify(window.dropdownOptions, null, 2)), message: `Archive dropdown options - ${new Date().toLocaleString()}` };
                if (sha) updateBody.sha = sha;
                await fetch('/api/github/file/dropdown-options.json', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updateBody) });
            } catch (error) {
                console.error('‚ùå Error saving dropdown options:', error);
                showNotification(`‚ùå Failed to save dropdown options: ${error.message}`, 'error');
            }
        }

        // Populate user creation dropdowns
        function populateUserCreationDropdowns() {
            if (!window.dropdownOptions) return;
            
            // Roles are now free-text; do not populate role or jobTitle as dropdowns
            const jobTitleEl = document.getElementById('jobTitle');
            if (jobTitleEl && jobTitleEl.tagName === 'SELECT') {
                // Backward compatibility if an older layout is loaded
                jobTitleEl.innerHTML = '<option value="">Select Title...</option>';
            }
            
            // Populate location dropdown
            const locationSelect = document.getElementById('freelancerLocation');
            const jobLocationSelect = document.getElementById('jobLocation');
            if (locationSelect) {
                locationSelect.innerHTML = '<option value="">Select Location...</option>';
                window.dropdownOptions.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            }
            if (jobLocationSelect) {
                jobLocationSelect.innerHTML = '<option value="">Select Location...</option>';
                window.dropdownOptions.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    jobLocationSelect.appendChild(option);
                });
                if (!jobLocationSelect.value) jobLocationSelect.value = 'Atlanta Area';
            }
            
            // Populate rate dropdown
            const rateSelect = document.getElementById('freelancerRate');
            const jobRateSelect = document.getElementById('jobPay');
            if (rateSelect) {
                rateSelect.innerHTML = '<option value="">Select Rate...</option>';
                window.dropdownOptions.rates.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate;
                    option.textContent = rate;
                    rateSelect.appendChild(option);
                });
            }
            if (jobRateSelect) {
                jobRateSelect.innerHTML = '<option value="">Select Rate...</option>';
                window.dropdownOptions.rates.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate;
                    option.textContent = rate;
                    jobRateSelect.appendChild(option);
                });
                if (!jobRateSelect.value) jobRateSelect.value = '';
            }
            
            // Populate job type dropdown in Add New Job from dropdownOptions
            const jobTypeSelect = document.getElementById('jobType');
            if (jobTypeSelect) {
                jobTypeSelect.innerHTML = '<option value="">Select Project Type...</option>';
                (window.dropdownOptions.projectTypes || []).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    jobTypeSelect.appendChild(option);
                });
            }
            
            // Populate job selection dropdown from jobs-data
            const jobSelect = document.getElementById('freelancerJob');
            if (jobSelect) {
                jobSelect.innerHTML = '<option value="">Select Job (from jobs-data)...</option>';
                (window.jobs || []).forEach((job, idx) => {
                    const option = document.createElement('option');
                    option.value = String(idx);
                    option.textContent = job.title || 'Untitled Job';
                    jobSelect.appendChild(option);
                });
            }
            
            console.log('üìã Populated user creation dropdowns');
        }

        // Populate job assignment dropdowns
        function populateJobAssignmentDropdowns() {
            if (!window.dropdownOptions) return;
            
            // Populate project types dropdown
            const projectTypesSelect = document.getElementById('projectTypeSelect');
            if (projectTypesSelect) {
                projectTypesSelect.innerHTML = '<option value="">Select Project Type...</option>';
                window.dropdownOptions.projectTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    projectTypesSelect.appendChild(option);
                });
            }
            
            // Populate payment methods dropdown
            const paymentMethodsSelect = document.getElementById('paymentMethodSelect');
            if (paymentMethodsSelect) {
                paymentMethodsSelect.innerHTML = '<option value="">Select Payment Method...</option>';
                window.dropdownOptions.paymentMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    paymentMethodsSelect.appendChild(option);
                });
            }
            
            console.log('üìã Populated job assignment dropdowns');
        }

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            const icon = getNotificationIcon(type);
            const colors = getNotificationColors(type);
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors.background};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                border: 1px solid ${colors.border};
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                font-size: 0.9rem;
                max-width: 400px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                backdrop-filter: blur(10px);
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.2rem;">${icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${type.toUpperCase()}</div>
                        <div style="opacity: 0.9; line-height: 1.4;">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return '‚úÖ';
                case 'error': return '‚ùå';
                case 'warning': return '‚ö†Ô∏è';
                case 'info': return '‚ÑπÔ∏è';
                default: return 'üîî';
            }
        }
        
        function getNotificationColors(type) {
            switch (type) {
                case 'success': return { background: 'linear-gradient(135deg, #22c55e, #16a34a)', border: '#16a34a' };
                case 'error': return { background: 'linear-gradient(135deg, #ef4444, #dc2626)', border: '#dc2626' };
                case 'warning': return { background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: '#d97706' };
                case 'info': return { background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: '#2563eb' };
                default: return { background: 'linear-gradient(135deg, #6b7280, #4b5563)', border: '#4b5563' };
            }
        }

        // View user details with sophisticated modal
        function viewUserDetails(userName) {
            const user = window.users[userName];
            if (!user) return;
            
            // Create sophisticated modal
            const modal = document.createElement('div');
            modal.id = 'userDetailsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    border: 1px solid #FFB200;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <button onclick="this.closest('#userDetailsModal').remove()" 
                            style="
                                position: absolute;
                                top: 1rem;
                                right: 1rem;
                                background: #ef4444;
                                color: white;
                                border: none;
                                padding: 0.5rem;
                                border-radius: 50%;
                                cursor: pointer;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">√ó</button>
                    
                    <h3 style="color: #FFB200; margin-bottom: 1.5rem; text-align: center; font-family: 'Cinzel', serif;">
                        üë§ USER DETAILS - ${userName.toUpperCase()}
                    </h3>
                    
                    <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                        <h4 style="color: #FFB200; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìã Profile Information
                        </h4>
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Email:</strong> 
                                <span style="color: #FFB200;">${user.profile?.email || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Role:</strong> 
                                <span style="color: #FFB200;">${user.profile?.role || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Location:</strong> 
                                <span style="color: #FFB200;">${user.profile?.location || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Approved Date:</strong> 
                                <span style="color: #FFB200;">${user.profile?.approvedDate || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                        <h4 style="color: #FFB200; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìù Contract Information
                        </h4>
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Contract Status:</strong> 
                                <span style="color: ${user.contract?.contractStatus === 'signed' ? '#22c55e' : '#f59e0b'};">
                                    ${user.contract?.contractStatus || 'Not specified'}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Contract ID:</strong> 
                                <span style="color: #FFB200; font-family: monospace;">${user.contract?.contractId || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Signed Date:</strong> 
                                <span style="color: #FFB200;">${user.contract?.contractSignedDate || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                        <h4 style="color: #FFB200; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üíº Job Information
                        </h4>
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Current Jobs:</strong> 
                                <span style="color: #FFB200;">${(user.jobs && Object.keys(user.jobs).length) ? Object.values(user.jobs).map(j=>j.title||'Untitled').join(', ') : 'None'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Payment Method:</strong> 
                                <span style="color: #FFB200;">${user.paymentMethod || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="showBankDetails('${userName}')" 
                                style="
                                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üè¶ View Bank Details
                        </button>
                        <button onclick="showPerformanceReview('${userName}')" 
                                style="
                                    background: linear-gradient(135deg, #f59e0b, #d97706);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üìä Performance Review
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // This duplicate deleteUser function has been removed - using the unified version above

        // Show bank details with encryption
        function showBankDetails(userName) {
            const user = window.users[userName];
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            const existing = user.performance || null;

            // Use the proper admin bank viewer system
            if (window.adminBankViewer) {
                window.adminBankViewer.showUserBankDetails(userName, user);
            } else {
                // Fallback to simple modal if admin bank viewer is not available
                showSimpleBankModal(userName, user);
            }
        }

        // Fallback simple bank modal
        function showSimpleBankModal(userName, user) {
            const modal = document.createElement('div');
            modal.id = 'bankDetailsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            // Check if user has bank data
            const hasBankData = user.bankData && Object.keys(user.bankData).length > 0;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    border: 1px solid #FFB200;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <button onclick="this.closest('#bankDetailsModal').remove()" 
                            style="
                                position: absolute;
                                top: 1rem;
                                right: 1rem;
                                background: #ef4444;
                                color: white;
                                border: none;
                                padding: 0.5rem;
                                border-radius: 50%;
                                cursor: pointer;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">√ó</button>
                    
                    <h3 style="color: #FFB200; margin-bottom: 1.5rem; text-align: center; font-family: 'Cinzel', serif;">
                        üè¶ BANK DETAILS - ${userName.toUpperCase()}
                    </h3>
                    
                    ${hasBankData ? `
                        <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                            <h4 style="color: #FFB200; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üîê Secure Banking Information
                            </h4>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>Bank Name:</strong> 
                                    <span style="color: #FFB200;">${user.bankData.bankName || 'Not specified'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>Account Type:</strong> 
                                    <span style="color: #FFB200;">${user.bankData.accountType || 'Not specified'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>Last 4 Digits:</strong> 
                                    <span style="color: #FFB200;">****${user.bankData.lastFour || '****'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>Encryption Status:</strong> 
                                    <span style="color: #22c55e;">üîí End-to-End Encrypted</span>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div style="background: rgba(59,130,246,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(59,130,246,0.3);">
                            <h4 style="color: #3b82f6; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                ‚ÑπÔ∏è No Bank Data Available
                            </h4>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.6;">
                                <strong>${userName}</strong> has not set up bank transfer details yet.
                                <br><br>
                                Bank details will appear here once the user selects "Bank Transfer" as their payment method and completes the secure setup process.
                            </div>
                        </div>
                    `}
                    
                    <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,178,0,0.3);">
                        <h4 style="color: #FFB200; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üí≥ Payment Method
                        </h4>
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Current Method:</strong> 
                                <span style="color: #FFB200;">${user.paymentMethod || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Security Level:</strong> 
                                <span style="color: #22c55e;">Maximum</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="this.closest('#bankDetailsModal').remove()" 
                                style="
                                    background: linear-gradient(135deg, #6b7280, #4b5563);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Show performance review
        function showPerformanceReview(userName) {
            const user = window.users[userName];
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            const existing = user.performance || null;

            // Create sophisticated performance review modal
            const modal = document.createElement('div');
            modal.id = 'performanceReviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    border: 1px solid #FFB200;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <button onclick="this.closest('#performanceReviewModal').remove()" 
                            style="
                                position: absolute;
                                top: 1rem;
                                right: 1rem;
                                background: #ef4444;
                                color: white;
                                border: none;
                                padding: 0.5rem;
                                border-radius: 50%;
                                cursor: pointer;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">√ó</button>
                    
                    <h3 style="color: #FFB200; margin-bottom: 1.5rem; text-align: center; font-family: 'Cinzel', serif;">
                        üìä PERFORMANCE REVIEW - ${userName.toUpperCase()}
                    </h3>
                    
                    <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,178,0,0.3);">
                        <h4 style="color: #FFB200; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìã Review Status
                        </h4>
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Review Status:</strong> 
                                <span style="color: ${existing ? '#22c55e' : '#f59e0b'};">${existing ? 'Completed' : 'Pending'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Last Review:</strong> 
                                <span style="color: #FFB200;">${existing?.reviewDate ? new Date(existing.reviewDate).toLocaleDateString() : 'Not yet reviewed'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Performance Level:</strong> 
                                <span style="color: #22c55e;">${existing ? 'Rated ' + (existing.overallRating || '-') + '/5' : 'New'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(59,130,246,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59,130,246,0.3);">
                        <h4 style="color: #3b82f6; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìù Review Details
                        </h4>
                        ${existing ? `
                        <div style="background: rgba(0,0,0,0.35);border:1px solid rgba(255,178,0,.25);border-radius:8px;padding:12px;margin-bottom:12px;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.95rem;">
                                <div><strong>Overall:</strong> ${existing.overallRating || '-'}/5</div>
                                <div><strong>Professionalism:</strong> ${existing.professionalism || '-'}</div>
                                <div><strong>Communication:</strong> ${existing.communication || '-'}</div>
                                <div><strong>Timeliness:</strong> ${existing.timeliness || '-'}</div>
                            </div>
                            ${Array.isArray(existing.strengths) && existing.strengths.length ? `<div style="margin-top:8px;"><strong>Strengths:</strong> ${existing.strengths.join(', ')}</div>` : ''}
                            ${Array.isArray(existing.areasForImprovement) && existing.areasForImprovement.length ? `<div style="margin-top:8px;"><strong>Improvements:</strong> ${existing.areasForImprovement.join(', ')}</div>` : ''}
                            ${Array.isArray(existing.goals) && existing.goals.length ? `<div style="margin-top:8px;"><strong>Goals:</strong> ${existing.goals.join(', ')}</div>` : ''}
                            ${existing.notes ? `<div style="margin-top:8px;"><strong>Notes:</strong> ${existing.notes}</div>` : ''}
                        </div>
                        ` : ''}
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div>
                                <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Overall Rating</label>
                                <select id="pr-overall" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;">
                                    <option value="">Select‚Ä¶</option>
                                    <option value="1">1 - Poor</option>
                                    <option value="2">2 - Fair</option>
                                    <option value="3">3 - Good</option>
                                    <option value="4">4 - Very Good</option>
                                    <option value="5">5 - Excellent</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Professionalism</label>
                                <select id="pr-professionalism" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;">
                                    <option value="">Select‚Ä¶</option>
                                    <option>Excellent</option>
                                    <option>Good</option>
                                    <option>Average</option>
                                    <option>Needs Improvement</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Communication</label>
                                <select id="pr-communication" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;">
                                    <option value="">Select‚Ä¶</option>
                                    <option>Excellent</option>
                                    <option>Good</option>
                                    <option>Average</option>
                                    <option>Needs Improvement</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Timeliness</label>
                                <select id="pr-timeliness" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;">
                                    <option value="">Select‚Ä¶</option>
                                    <option>Excellent</option>
                                    <option>Good</option>
                                    <option>Average</option>
                                    <option>Needs Improvement</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div>
                                <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Strengths (comma separated)</label>
                                <input id="pr-strengths" type="text" placeholder="e.g., Fast turnaround, Great lighting" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;"/>
                            </div>
                            <div>
                                <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Areas for Improvement</label>
                                <input id="pr-improvements" type="text" placeholder="e.g., Audio levels" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;"/>
                            </div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Goals for Next Project</label>
                            <input id="pr-goals" type="text" placeholder="e.g., Lead a small unit shoot" style="width:100%;padding:.6rem;background:rgba(0,0,0,.4);border:1px solid rgba(255,178,0,.3);border-radius:8px;color:white;"/>
                        </div>
                        <div>
                            <label style="display:block;color:#9ca3af;font-size:.9rem;margin-bottom:6px;">Review Notes</label>
                            <textarea id="pr-notes" placeholder="Enter performance review notes here..." style="width: 100%; min-height: 100px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,178,0,0.3); border-radius: 8px; color: white; padding: 0.75rem; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="submitPerformanceReview('${userName}')" 
                                style="
                                    background: linear-gradient(135deg, #22c55e, #16a34a);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            ${existing ? '‚úÖ Update Review' : '‚úÖ Submit Review'}
                        </button>
                        <button onclick="this.closest('#performanceReviewModal').remove()" 
                                style="
                                    background: linear-gradient(135deg, #6b7280, #4b5563);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Submit performance review
        async function submitPerformanceReview(userName) {
            const modal = document.getElementById('performanceReviewModal');
            if (!modal) return;
            const overall = modal.querySelector('#pr-overall')?.value || '';
            const professionalism = modal.querySelector('#pr-professionalism')?.value || '';
            const communication = modal.querySelector('#pr-communication')?.value || '';
            const timeliness = modal.querySelector('#pr-timeliness')?.value || '';
            const strengths = (modal.querySelector('#pr-strengths')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
            const improvements = (modal.querySelector('#pr-improvements')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
            const goals = (modal.querySelector('#pr-goals')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
            const notes = modal.querySelector('#pr-notes')?.value.trim() || '';

            if (!overall) { showNotification('Please select an overall rating', 'warning'); return; }

            try {
                // Save to Firestore under users/{userName}.performance
                const userData = window.users[userName] || {};
                const email = userData?.profile?.email || '';
                const review = {
                    status: 'completed',
                    overallRating: Number(overall),
                    professionalism,
                    communication,
                    timeliness,
                    strengths,
                    areasForImprovement: improvements,
                    goals,
                    notes,
                    reviewer: (window.adminUser && window.adminUser.email) || 'Admin',
                    reviewDate: new Date().toISOString()
                };

                const updatedUser = { ...userData, performance: review };
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    await window.FirestoreDataManager.setUser(userName, updatedUser);
                }
                window.users[userName] = updatedUser;

                // Notify the creator immediately
                try {
                    await addNotification(
                        'New Performance Review',
                        `Your performance review is available.`,
                        'info',
                        {
                            actionRequired: false,
                            priority: 'high',
                            userEmail: email,
                            event: 'performance_review_created'
                        }
                    );
                } catch(_) {}

                showNotification(`‚úÖ Performance review submitted for ${userName}`, 'success');
                modal.remove();
            } catch (e) {
                console.error('‚ùå Failed to submit review:', e);
                showNotification('‚ùå Failed to submit review', 'error');
            }
        }

        // Download user contract - Prefer stored PDF from /contracts when available, fallback to PDF generation
        async function downloadUserContract(userName) {
            console.log('üîç downloadUserContract function called with:', userName);
            
                    // Force refresh users data from centralized source
        try {
            console.log('üîÑ Refreshing users data from centralized source...');
            const response = await fetch(`${API_BASE}/api/users`);
            if (response.ok) {
                const freshData = await response.json();
                window.users = freshData.users;
                console.log('‚úÖ Users data refreshed from centralized source');
            } else {
                console.warn('‚ö†Ô∏è Could not refresh users data');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error refreshing users data:', error);
        }
            
            const userData = window.users[userName];
            if (!userData) {
                console.log('‚ùå User not found:', userName);
                showNotification('User not found', 'error');
                return;
            }

            console.log('üìÑ Attempting to generate contract for:', userName);
            console.log('üìÑ User data:', userData);
            
            // Check if user has contract data in centralized system
            if (!userData.contract) {
                console.log('‚ùå No contract data found for user:', userName);
                showNotification('No contract data found for user', 'error');
                return;
            }
            
            const userContract = userData.contract;
            console.log('üìÑ Contract data from centralized system:', userContract);
            
            // If a fileUrl exists (uploaded), download directly from API
            if (userContract.fileUrl || userContract.contractStatus === 'uploaded') {
                try {
                    const guessedFile = `${userName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, ' ').trim()}.pdf`;
                    const dlUrl = `/api/contracts?filename=${encodeURIComponent(guessedFile)}`;
                    window.open(dlUrl, '_blank');
                    showNotification('‚¨áÔ∏è Downloading signed contract PDF...', 'success');
                    return;
                } catch (openErr) {
                    console.warn('‚ö†Ô∏è Could not open direct contract download, falling back to PDF generation:', openErr);
                }
            }
            // Otherwise require a signed status before generating
            if (userContract.contractStatus !== 'signed') {
                console.log('‚ùå Contract not signed or uploaded yet for user:', userName);
                showNotification('Contract not signed yet for user', 'error');
                return;
            }
            
            // Create contract data for PDF generation
            const primaryJob = (userData.jobs && Object.values(userData.jobs)[0]) || null;
            const contractData = {
                contractId: userContract.contractId || userName,
                freelancerName: userName,
                freelancerEmail: userData.profile?.email || 'Not specified',
                role: primaryJob?.title || primaryJob?.role || userData.profile?.role || 'Contractor',
                location: primaryJob?.location || userData.profile?.location || 'Atlanta Area',
                projectStart: primaryJob?.date || primaryJob?.projectStart || userData.profile?.projectStart || 'TBD',
                rate: primaryJob?.rate || primaryJob?.pay || 'Not specified',
                effectiveDate: userData.profile?.approvedDate || new Date().toISOString().split('T')[0],
                signatureDate: userContract.contractSignedDate || new Date().toISOString().split('T')[0],
                signature: userContract.contractStatus === 'signed' ? 'Digital Signature' : 'Not Signed'
            };
            
            try {
                console.log('üìÑ Generating PDF with contract data:', contractData);
                
                // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const doc = new jsPDF();
                
                // Professional header with gold background
                doc.setFillColor(255, 178, 0);
                doc.rect(0, 0, 210, 25, 'F');
                
                // Company name and title in header
                doc.setFontSize(20);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS', 105, 12, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FREELANCE CONTRACT AGREEMENT', 105, 20, { align: 'center' });
                
                // Contract metadata
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`Contract ID: ${contractData.contractId}`, 20, 35);
                doc.text(`Effective Date: ${contractData.effectiveDate}`, 20, 40);
                
                // Contractor information
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 50, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFORMATION', 105, 56, { align: 'center' });
                
                // Contractor details
                doc.setFillColor(248, 249, 250);
                doc.rect(20, 65, 80, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, 65, 80, 25, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFO', 25, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Name: ${contractData.freelancerName}`, 25, 78);
                doc.text(`Role: ${contractData.role}`, 25, 82);
                doc.text(`Location: ${contractData.location}`, 25, 86);
                
                // Project details
                doc.setFillColor(248, 249, 250);
                doc.rect(110, 65, 80, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(110, 65, 80, 25, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('PROJECT DETAILS', 115, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Email: ${contractData.freelancerEmail}`, 115, 78);
                doc.text(`Start: ${contractData.projectStart}`, 115, 82);
                doc.text(`Rate: ${contractData.rate}`, 115, 86);
                
                // Contract terms
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 100, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT TERMS & CONDITIONS', 105, 106, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                const terms = [
                    'INDEPENDENT CONTRACTOR: Not an employee of Cochran Films.',
                    'SERVICES: Provide professional services as specified.',
                    'COMPENSATION: Payment within 24 hours of completion.',
                    'STANDARDS: All work must meet Cochran Films quality.',
                    'ATTIRE: Professional attire (all black) required.',
                    'PUNCTUALITY: Arrive 15 minutes before start time.',
                    'DOCUMENTATION: Bring valid ID and signed contract.',
                    'EQUIPMENT: Use provided Cochran Films equipment.',
                    'CONDUCT: Maintain professional demeanor at all times.',
                    'SAFETY: Follow all safety protocols provided.',
                    'CONFIDENTIALITY: Respect project confidentiality.',
                    'BTS CONTENT: May freely take and share behind-the-scenes.',
                    'TAX OBLIGATIONS: Contractor responsible for personal taxes.',
                    'TRANSPORTATION: Contractor responsible for own transport.'
                ];
                
                let currentY = 120;
                terms.forEach((term, index) => {
                    const isLeftColumn = index < 7;
                    const columnIndex = isLeftColumn ? index : index - 7;
                    const xPos = isLeftColumn ? 20 : 110;
                    const yPos = 120 + (columnIndex * 8);
                    
                    if (term.includes('\n')) {
                        const lines = term.split('\n');
                        lines.forEach((line, lineIndex) => {
                            doc.text(line, xPos, yPos + (lineIndex * 4));
                        });
                    } else {
                        doc.text(term, xPos, yPos);
                    }
                });
                
                // Signatures
                const signatureY = 200;
                doc.setFillColor(255, 178, 0);
                doc.rect(20, signatureY - 5, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT SIGNATURES', 105, signatureY + 2, { align: 'center' });
                
                // Company signature
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS (COMPANY)', 20, signatureY + 15);
                
                doc.setFillColor(248, 249, 250);
                doc.rect(20, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.text('Authorized Signature:', 25, signatureY + 26);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic');
                doc.text('Cody Cochran', 25, signatureY + 32);
                
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(25, signatureY + 34, 85, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Title: Founder & CEO', 25, signatureY + 38);
                doc.text('Date: ' + contractData.effectiveDate, 25, signatureY + 42);
                
                // Contractor signature
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR SIGNATURE', 105, signatureY + 15);
                
                doc.setFillColor(248, 249, 250);
                doc.rect(105, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(105, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.text('Contractor:', 115, signatureY + 26);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic');
                doc.text(contractData.freelancerName, 115, signatureY + 32);
                
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(115, signatureY + 34, 175, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Signature: ' + contractData.signature, 115, signatureY + 38);
                doc.text('Date: ' + contractData.signatureDate, 115, signatureY + 42);
                
                // Footer
                const footerY = 260;
                doc.setFillColor(248, 249, 250);
                doc.rect(20, footerY - 5, 170, 20, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.3);
                doc.rect(20, footerY - 5, 170, 20, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('This contract was digitally signed and is legally binding under Georgia law.', 105, footerY + 3, { align: 'center' });
                doc.text('Generated by Cochran Films Contract Portal ‚Ä¢ ' + new Date().toLocaleDateString(), 105, footerY + 8, { align: 'center' });
                doc.text('Contract ID: ' + contractData.contractId, 105, footerY + 13, { align: 'center' });
                
                // Save PDF to user's device
                const safeFileName = userName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, ' ').trim() + '.pdf';
                doc.save(safeFileName);
                
                console.log('‚úÖ PDF generated and downloaded successfully:', safeFileName);
                showNotification('‚úÖ Contract downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                showNotification('‚ùå Error generating contract PDF. Please try again.', 'error');
            }
        }

        

        // ==================== MODULAR SYSTEM INTEGRATION ====================
        
        // Load all modular system scripts
        async function loadModularSystem() {
            console.log('üöÄ Loading Modular Admin Dashboard System...');
            updateModularSystemStatus('loading', 'Loading modules...');
            
            try {
                // Load core modules
                await loadScript('admin-dashboard-modular/js/utils/error-handler.js');
                await loadScript('admin-dashboard-modular/js/utils/loading-manager.js');
                await loadScript('admin-dashboard-modular/js/utils/notification-manager.js');
                
                // Load authentication
                await loadScript('admin-dashboard-modular/js/auth/auth-manager.js');
                await loadScript('admin-dashboard-modular/js/auth/login-component.js');
                
                // Load dashboard
                await loadScript('admin-dashboard-modular/js/dashboard/dashboard-manager.js');
                
                // Load user management
                await loadScript('admin-dashboard-modular/js/users/user-manager.js');
                await loadScript('admin-dashboard-modular/js/users/user-form.js');
                await loadScript('admin-dashboard-modular/js/users/user-list.js');
                
                // Load job management
                await loadScript('admin-dashboard-modular/js/jobs/job-manager.js');
                await loadScript('admin-dashboard-modular/js/jobs/job-form.js');
                await loadScript('admin-dashboard-modular/js/jobs/job-list.js');
                
                // Load contract management
                await loadScript('admin-dashboard-modular/js/contracts/contract-manager.js');
                await loadScript('admin-dashboard-modular/js/contracts/contract-generator.js');
                
                // Load dropdown management
                await loadScript('admin-dashboard-modular/js/dropdowns/dropdown-manager.js');
                
                // Load component library
                await loadScript('admin-dashboard-modular/js/components/ui/Button.js');
                await loadScript('admin-dashboard-modular/js/components/ui/Form.js');
                await loadScript('admin-dashboard-modular/js/components/ui/Modal.js');
                await loadScript('admin-dashboard-modular/js/components/ui/Notification.js');
                await loadScript('admin-dashboard-modular/js/components/index.js');
                
                // Load main app
                await loadScript('admin-dashboard-modular/js/app.js');
                
                console.log('‚úÖ Modular system loaded successfully!');
                updateModularSystemStatus('success', 'All modules loaded!');
                
                // Initialize the modular system but keep it separate
                if (window.AdminDashboardApp) {
                    // Set flags to prevent modular system from overriding main dashboard
                    window.MAIN_DASHBOARD_AUTH_OVERRIDE = false;
                    window.MAIN_DASHBOARD_USER_DISPLAY_OVERRIDE = false;
                    window.MAIN_DASHBOARD_JOB_DISPLAY_OVERRIDE = false;
                    
                    try {
                        await window.AdminDashboardApp.init();
                        console.log('‚úÖ Modular system initialized!');
                        updateModularSystemStatus('success', 'System ready!');
                        
                        // Ensure main dashboard still has control
                        console.log('‚úÖ Main dashboard maintains control over user display');
                    } catch (initError) {
                        console.warn('‚ö†Ô∏è Modular system initialization failed, continuing with main dashboard:', initError);
                        updateModularSystemStatus('warning', 'Partial initialization');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error loading modular system:', error);
                updateModularSystemStatus('error', 'Load failed');
                
                // Don't crash the main dashboard if modular system fails
                console.log('üîÑ Continuing with main dashboard functionality only');
            }
        }
        
        // Helper function to load scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ==================== END MODULAR SYSTEM INTEGRATION ====================
        
        // Update modular system status
        function updateModularSystemStatus(status, message) {
            const statusElement = document.getElementById('modularStatusText');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = status === 'success' ? '#22c55e' : 
                                          status === 'error' ? '#ef4444' : 
                                          status === 'loading' ? '#f59e0b' : '#FFB200';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Mark this context as admin for FirestoreDataManager behaviors
            window.IS_ADMIN_DASHBOARD = true;
            // Explicitly disable Firestore auto-migration to prevent repopulation from JSON backups
            window.FIRESTORE_AUTO_MIGRATION = false;
            // Set ADMIN_PASSWORD for the main dashboard authentication
            window.ADMIN_PASSWORD = 'Cochranfilms2@';
            console.log('‚úÖ Main dashboard ADMIN_PASSWORD set:', window.ADMIN_PASSWORD);
            
            // Set flags to prevent modular system from interfering with main dashboard
            window.MAIN_DASHBOARD_AUTH_OVERRIDE = false;
            window.MAIN_DASHBOARD_USER_DISPLAY_OVERRIDE = false;
            window.MAIN_DASHBOARD_JOB_DISPLAY_OVERRIDE = false;
            window.MAIN_DASHBOARD_LOGIN_FORM_OVERRIDE = false;
            window.MAIN_DASHBOARD_LOADING_OVERRIDE = false;
            
            // Initialize Firebase (use admin-scoped initializer to avoid name collision with global helper)
            initializeAdminFirebase().then(() => {
                console.log('‚úÖ Firebase initialized in admin dashboard');
            }).catch(error => {
                console.error('‚ùå Firebase initialization failed:', error);
            });
            
            checkAuth();

            // React to Firestore realtime updates to keep UI in sync
            if (window.FirestoreIntegration) {
                const debounceMap = { jobs: null, users: null, dropdownOptions: null };
                const schedule = (key, fn) => {
                    if (debounceMap[key]) clearTimeout(debounceMap[key]);
                    debounceMap[key] = setTimeout(fn, 200);
                };
                window.FirestoreIntegration.setupListeners(async (evt) => {
                    const { collection } = evt.detail || {};
                    if (collection === 'jobs') {
                        schedule('jobs', async () => {
                            try { window.jobs = await window.FirestoreDataManager.getJobListings(); await enforceUniqueJobs(); displayJobs(); updateStats(); } catch(_){}
                        });
                    } else if (collection === 'users') {
                        schedule('users', async () => {
                            try { window.users = await window.FirestoreDataManager.getUsers(); displayUsers(); displayArchivedUsers(); updateStats(); } catch(_){}
                        });
                    } else if (collection === 'dropdownOptions') {
                        schedule('dropdownOptions', async () => {
                            try { window.dropdownOptions = await window.FirestoreDataManager.getDropdownOptions(); populateDropdownManagementInterface(); populateUserCreationDropdowns(); populateJobAssignmentDropdowns(); } catch(_){}
                        });
                    }
                });
            }
            
            
            
            // Initialize admin bank viewer
            if (typeof AdminBankViewer !== 'undefined') {
                window.adminBankViewer = new AdminBankViewer();
                console.log('‚úÖ Admin Bank Viewer initialized');
            } else {
                console.log('‚ö†Ô∏è Admin Bank Viewer not available, using fallback');
            }
            
            // Load the modular system but don't let it override authentication OR user display
            // Add flags to prevent modular system from overriding main dashboard functionality
            window.MAIN_DASHBOARD_AUTH_OVERRIDE = false;
            window.MAIN_DASHBOARD_USER_DISPLAY_OVERRIDE = false;
            window.MAIN_DASHBOARD_JOB_DISPLAY_OVERRIDE = false;
            
            // Load modular system but keep it completely separate from main dashboard
            // This prevents any interference with the main dashboard functionality
            setTimeout(() => {
                loadModularSystem();
            }, 2000); // Increased delay to ensure main dashboard is fully loaded first
            
            // Command palette bindings
            initCommandPalette();
            
        });
        // ==================== COMMAND PALETTE ====================
        function initCommandPalette() {
            const palette = document.getElementById('cmdk');
            const backdrop = document.getElementById('cmdkBackdrop');
            const input = document.getElementById('cmdkInput');
            const list = document.getElementById('cmdkList');

            if (!palette || !backdrop || !input || !list) return;

            const hide = () => { palette.style.display = 'none'; backdrop.style.display = 'none'; };
            const show = () => { palette.style.display = 'block'; backdrop.style.display = 'block'; input.value=''; renderList(''); input.focus(); };

            const commands = [
                { id: 'new-job', label: 'New Job', action: () => document.getElementById('jobTitle')?.focus() },
                { id: 'add-user', label: 'Add User', action: () => document.getElementById('freelancerName')?.focus() },
                { id: 'assign-job', label: 'Assign Job', action: () => assignJobsToUsers() },
                { id: 'refresh', label: 'Refresh Data', action: async () => { await loadData(); updateStats(); } }
            ];

            function renderList(q) {
                const ql = (q||'').toLowerCase();
                const items = commands.filter(c => c.label.toLowerCase().includes(ql));
                list.innerHTML = '';
                items.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'cmdk-item';
                    el.innerHTML = `<span>${c.label}</span><span style="opacity:.65">‚Ü©Ô∏é</span>`;
                    el.onclick = () => { hide(); setTimeout(c.action, 0); };
                    list.appendChild(el);
                });
                if (items.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'cmdk-item';
                    empty.innerHTML = '<span>No results</span>';
                    list.appendChild(empty);
                }
            }

            // Global key handler for ‚åòK / Ctrl+K
            window.addEventListener('keydown', (e) => {
                const isMac = navigator.platform.toUpperCase().includes('MAC');
                if ((isMac && e.metaKey && e.key.toLowerCase() === 'k') || (!isMac && e.ctrlKey && e.key.toLowerCase() === 'k')) {
                    e.preventDefault();
                    if (palette.style.display === 'block') hide(); else show();
                } else if (e.key === 'Escape') {
                    hide();
                }
            });

            input.addEventListener('input', (e) => renderList(e.target.value));
            backdrop.addEventListener('click', hide);
        }

        
        // Test function to run all dashboard tests
        async function runAutomaticDashboardTests() {
            console.log('üöÄ Starting Automatic Dashboard Tests...\n');
            
            // Test 1: Check if dashboard elements exist
            console.log('üìã Test 1: Dashboard Elements');
            const elements = ['loginScreen', 'dashboard', 'totalCreators', 'activeJobs', 'pendingReviews', 'totalContracts', 'jobForm', 'contractForm', 'jobsList', 'contractsList'];
            let passed = 0;
            let failed = 0;
            
            elements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`‚úÖ ${elementId} - Found`);
                    passed++;
                } else {
                    console.log(`‚ùå ${elementId} - Missing`);
                    failed++;
                }
            });
            console.log(`üìä Results: ${passed} passed, ${failed} failed`);
            
            // Test 2: Check authentication system
            console.log('\nüìã Test 2: Authentication System');
            if (typeof ADMIN_PASSWORD !== 'undefined') {
                console.log('‚úÖ ADMIN_PASSWORD - Configured');
            } else {
                console.log('‚ùå ADMIN_PASSWORD - Missing');
            }
            
            // Test 3: Check API endpoints
            console.log('\nüìã Test 3: API Endpoints');
            // JSON API deprecated; Firestore is primary. Test is retained for reference only.
            
            try {
                const usersResponse = await fetch(`${API_BASE}/api/users`);
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    console.log(`‚úÖ users API - Working (${Object.keys(usersData.users || {}).length} users)`);
                } else {
                    console.log(`‚ùå users API - Status: ${usersResponse.status}`);
                }
            } catch (error) {
                console.log('‚ùå users API - Error:', error.message);
            }
            
            // Test 4: Check functions
            console.log('\nüìã Test 4: Core Functions');
            const functions = ['loadJobs', 'displayJobs', 'loadUsers', 'displayUsers', 'updateStats'];
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`‚úÖ ${funcName}() - Available`);
                } else {
                    console.log(`‚ùå ${funcName}() - Missing`);
                }
            });
            
            // Test 5: Check global variables
            console.log('\nüìã Test 5: Global Variables');
            const variables = ['jobs', 'users', 'isAuthenticated'];
            variables.forEach(varName => {
                if (typeof window[varName] !== 'undefined') {
                    console.log(`‚úÖ ${varName} - Available`);
                } else {
                    console.log(`‚ùå ${varName} - Missing`);
                }
            });
            
            // Test 6: Check login status
            console.log('\nüìã Test 6: Login Status');
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboard');
            if (loginScreen && dashboard) {
                const loginDisplay = loginScreen.style.display;
                const dashboardDisplay = dashboard.style.display;
                console.log(`Login screen: ${loginDisplay}, Dashboard: ${dashboardDisplay}`);
                
                if (loginDisplay === 'flex' && dashboardDisplay === 'none') {
                    console.log('‚úÖ Login screen visible (expected)');
                } else if (loginDisplay === 'none' && dashboardDisplay === 'block') {
                    console.log('‚úÖ Dashboard visible (logged in)');
                } else {
                    console.log('‚ö†Ô∏è Unexpected display states');
                }
            }
            
            console.log('\nüìä AUTOMATIC TEST COMPLETE');
            console.log('üí° Check console for detailed results');
        }
        
        // Test function to verify main dashboard login form is working
        function testMainDashboardLoginForm() {
            console.log('üß™ Testing Main Dashboard Login Form...');
            
            const loginForm = document.getElementById('mainDashboardLoginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            if (loginForm) {
                console.log('‚úÖ Main dashboard login form found');
                console.log('üîç Form ID:', loginForm.id);
                console.log('üîç Email input:', emailInput ? 'Found' : 'Missing');
                console.log('üîç Password input:', passwordInput ? 'Found' : 'Missing');
                
                // Test if the form has event listeners
                const events = loginForm._events || loginForm.onclick || 'No events detected';
                console.log('üîç Form events:', events);
                
                return true;
            } else {
                console.log('‚ùå Main dashboard login form not found');
                return false;
            }
        }
        
        // Test function to verify main dashboard authentication works
        async function testMainDashboardAuthentication() {
            console.log('üß™ Testing Main Dashboard Authentication...');
            
            try {
                // Test fallback authentication
                const testPassword = window.ADMIN_PASSWORD;
                if (testPassword) {
                    console.log('‚úÖ Testing with admin password:', testPassword ? 'Set' : 'Not set');
                    
                    // Simulate successful authentication
                    sessionStorage.setItem('adminDashboardAuthenticated', 'true');
                    sessionStorage.setItem('adminUser', JSON.stringify({
                        email: 'test@cochranfilms.com',
                        uid: 'test-admin-' + Date.now()
                    }));
                    window.isAuthenticated = true;
                    
                    console.log('‚úÖ Test authentication successful');
                    showDashboard();
                    return true;
                } else {
                    console.log('‚ùå Admin password not set');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Test authentication failed:', error);
                return false;
            }
        }
        
        // Manual refresh function for troubleshooting stats
        async function manualRefreshStats() {
            console.log('üîÑ Manual stats refresh requested...');
            
            try {
                // Reload data
                await loadData();
                
                // Force update stats
                updateStats();
                
                // Show success message
                showNotification('‚úÖ Stats refreshed manually', 'success');
                
            } catch (error) {
                console.error('‚ùå Manual stats refresh failed:', error);
                showNotification('‚ùå Failed to refresh stats', 'error');
            }
        }

        // Helpers to resolve job index by id for safe actions
        function getJobIndexById(jobId) {
            if (!jobId || !Array.isArray(window.jobs)) return -1;
            return window.jobs.findIndex(j => j && (j.id === jobId));
        }
        function editJobById(jobId) {
            const idx = getJobIndexById(jobId);
            if (idx < 0) { showNotification('Job not found', 'error'); return; }
            const job = window.jobs[idx];
            return openJobEditModal(job);
        }
        function duplicateJobById(jobId) {
            const idx = getJobIndexById(jobId);
            if (idx < 0) { showNotification('Job not found', 'error'); return; }
            return duplicateJob(idx);
        }
        function deleteJobById(jobId) {
            const idx = getJobIndexById(jobId);
            if (idx < 0) { showNotification('Job not found', 'error'); return; }
            return deleteJob(idx);
        }
        // Modal editor for jobs (single-source Firestore write)
        function openJobEditModal(job) {
            if (!job) { showNotification('Job not found', 'error'); return; }
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);z-index:12000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#0f1115;border:1px solid rgba(255,178,0,0.25);border-radius:14px;width:min(620px,92%);box-shadow:0 24px 64px rgba(0,0,0,.5);">
                    <div style="padding:16px 18px;border-bottom:1px solid rgba(255,178,0,0.2);display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;color:#FFB200;font-family:Cinzel,serif;">Edit Job</h3>
                        <button id="je-close" class="btn btn-secondary" style="margin:0;">‚úñ</button>
                    </div>
                    <div style="padding:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div style="grid-column:span 2;">
                            <label>Title</label>
                            <input id="je-title" type="text" value="${job.title || ''}">
                        </div>
                        <div>
                            <label>Date</label>
                            <input id="je-date" type="date" value="${job.date || ''}">
                        </div>
                        <div>
                            <label>Location</label>
                            <input id="je-location" type="text" value="${job.location || ''}">
                        </div>
                        <div>
                            <label>Pay</label>
                            <input id="je-pay" type="text" value="${job.pay || ''}">
                        </div>
                        <div>
                            <label>Type</label>
                            <input id="je-type" type="text" value="${job.type || ''}">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="je-status">
                                <option ${String(job.status||'Active')==='Active'?'selected':''}>Active</option>
                                <option ${String(job.status||'')==='Inactive'?'selected':''}>Inactive</option>
                                <option ${String(job.status||'')==='Pending'?'selected':''}>Pending</option>
                                <option ${String(job.status||'')==='Completed'?'selected':''}>Completed</option>
                                <option ${String(job.status||'')==='Cancelled'?'selected':''}>Cancelled</option>
                            </select>
                        </div>
                        <div style="grid-column:span 2;">
                            <label>Description</label>
                            <textarea id="je-desc" rows="3">${job.description || ''}</textarea>
                        </div>
                    </div>
                    <div style="padding:14px 18px;border-top:1px solid rgba(255,178,0,0.2);display:flex;justify-content:flex-end;gap:10px;">
                        <button id="je-cancel" class="btn btn-secondary">Cancel</button>
                        <button id="je-save" class="btn">Save</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            const close = () => modal.remove();
            modal.querySelector('#je-close').onclick = close;
            modal.querySelector('#je-cancel').onclick = close;
            modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
            modal.querySelector('#je-save').onclick = async () => {
                const updated = {
                    id: job.id,
                    title: modal.querySelector('#je-title').value.trim() || job.title,
                    date: modal.querySelector('#je-date').value || job.date,
                    location: modal.querySelector('#je-location').value.trim() || job.location,
                    pay: modal.querySelector('#je-pay').value.trim() || job.pay,
                    type: modal.querySelector('#je-type').value.trim() || job.type,
                    status: modal.querySelector('#je-status').value || job.status,
                    description: modal.querySelector('#je-desc').value.trim() || job.description
                };
                try {
                    if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                        await window.FirestoreDataManager.setJobListing(updated.id, updated);
                        // refresh local state minimally
                        const idx = getJobIndexById(updated.id);
                        if (idx >= 0) { window.jobs[idx] = { ...window.jobs[idx], ...updated }; }
                        displayJobs();
                        updateStats();
                        showNotification('‚úÖ Job saved', 'success');
                        // single-job archival (no repo re-seed)
                        try { await updateJobsOnGitHub('update', updated.title, updated); } catch(_){ }
                    } else {
                        showNotification('‚ùå Firestore unavailable', 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showNotification('‚ùå Failed to save job', 'error');
                }
                close();
            };
        }
        function displayJobs() {
            console.log('üîÑ displayJobs called');
            console.log('üîç window.jobs:', window.jobs);
            console.log('üîç Jobs count:', window.jobs ? window.jobs.length : 'undefined');
            
            const jobsList = document.getElementById('jobsList');
            if (!jobsList) {
                console.error('‚ùå jobsList element not found');
                return;
            }
            
            if (!window.jobs || !Array.isArray(window.jobs) || window.jobs.length === 0) {
                console.log('‚ö†Ô∏è No jobs to display');
                jobsList.innerHTML = '<div class="item-card"><p style="text-align: center; color: rgba(255,255,255,0.7);">No jobs available</p></div>';
                return;
            }
            
            console.log(`‚úÖ Displaying ${window.jobs.length} jobs`);
            jobsList.innerHTML = '';

            window.jobs.forEach((job, index) => {
                const statusColors = {
                    'Active': '#22c55e',
                    'Pending': '#f59e0b',
                    'Completed': '#3b82f6',
                    'Cancelled': '#ef4444',
                    'Inactive': '#6b7280'
                };
                
                const jobDiv = document.createElement('div');
                jobDiv.className = 'item-card';
                jobDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">${job.title || 'Untitled Job'}</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap;">
                            <span class="job-status" style="background: ${statusColors[job.status] || '#6b7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                ${job.status || 'Active'}
                            </span>
                            ${job.exclusive ? `
                                <span style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    <i class="fas fa-crown"></i> Exclusive
                                </span>
                            ` : ''}
                            ${job.priority ? `
                                <span style="background: linear-gradient(135deg, #FFB200, #FFD700); color: #1a1a1a; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    <i class="fas fa-star"></i> Priority
                                </span>
                            ` : ''}
                            ${job.type ? `
                                <span style="background: rgba(255, 178, 0, 0.2); color: #FFB200; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                    ${job.type}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="item-meta">
                        <span>üìÖ ${job.date || 'TBD'}</span>
                        <span>üìç ${job.location || 'Location TBD'}</span>
                        <span>üí∞ ${job.pay || 'Pay TBD'}</span>
                        ${job.type ? `<span>üéØ ${job.type}</span>` : ''}
                    </div>
                    <div class="item-description">
                        ${job.description || 'No description provided'}
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small" onclick="editJob(${index})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-small" onclick="duplicateJob(${index})">üìã Duplicate</button>
                        <button class="btn btn-small btn-danger" onclick="deleteJob(${index})">üóëÔ∏è Delete</button>
                    </div>
                `;
                jobsList.appendChild(jobDiv);
            });
            
            console.log('‚úÖ Jobs display complete');
        }

        // Enforce only one of each allowed job remains
        async function enforceUniqueJobs() {
            try {
                const allowed = new Set(['backdrop photographer base','backdrop photographer spotlight']);
                const keep = new Map();
                const purge = [];
                for (const j of (window.jobs || [])) {
                    const t = String(j.title||'').toLowerCase().trim();
                    if (!allowed.has(t)) { if (j.id) purge.push(j.id); continue; }
                    if (!keep.has(t)) { keep.set(t, j); }
                    else {
                        const a = keep.get(t); const tA = Date.parse(a.updatedAt||0); const tB = Date.parse(j.updatedAt||0);
                        if (tB > tA) { if (a.id) purge.push(a.id); keep.set(t, j); } else { if (j.id) purge.push(j.id); }
                    }
                }
                for (const id of purge) { try { await window.FirestoreDataManager.deleteJobListing(id); } catch(_){} }
                if (purge.length) { try { window.jobs = await window.FirestoreDataManager.getJobListings(); } catch(_){} }
            } catch (e) { console.warn('enforceUniqueJobs skipped:', e?.message||e); }
        }

        // ==================== PERFORMANCE MANAGEMENT FUNCTIONS ====================
        
        // Refresh Performance Data
        function refreshPerformanceData() {
            console.log('üîÑ Refreshing performance data...');
            updatePerformanceStats();
            updateApplicationStats();
            showNotification('Performance data refreshed!', 'success');
        }

        // Update Performance Stats
        function updatePerformanceStats() {
            if (!window.users || !Array.isArray(window.users)) return;

            const totalContractors = window.users.length;
            const activeContractors = window.users.filter(user => 
                user.contractStatus === 'signed' || user.contractStatus === 'active'
            ).length;

            // Calculate average rating
            let totalRating = 0;
            let ratingCount = 0;
            window.users.forEach(user => {
                if (user.performanceReviews && Array.isArray(user.performanceReviews)) {
                    user.performanceReviews.forEach(review => {
                        if (review.rating) {
                            totalRating += parseFloat(review.rating);
                            ratingCount++;
                        }
                    });
                }
            });
            const avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : '0.0';

            // Calculate total earnings
            let totalEarnings = 0;
            window.users.forEach(user => {
                if (user.jobs) {
                    Object.values(user.jobs).forEach(job => {
                        if (job.status === 'completed' && job.pay) {
                            const payAmount = parseFloat(job.pay.replace(/[^0-9.-]/g, '')) || 0;
                            totalEarnings += payAmount;
                        }
                    });
                }
            });

            // Update UI
            const totalEl = document.getElementById('totalContractors');
            const activeEl = document.getElementById('activeContractors');
            const ratingEl = document.getElementById('avgRating');
            const earningsEl = document.getElementById('totalEarnings');

            if (totalEl) totalEl.textContent = totalContractors;
            if (activeEl) activeEl.textContent = activeContractors;
            if (ratingEl) ratingEl.textContent = avgRating;
            if (earningsEl) earningsEl.textContent = `$${totalEarnings.toLocaleString()}`;
        }

        // Update Application Stats (Firestore-backed)
        async function updateApplicationStats() {
            try {
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }
                let applications = [];
                let quickApps = [];
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    applications = await window.FirestoreDataManager.getApplications();
                    try { quickApps = await window.FirestoreDataManager.getQuickApplications(); } catch(_) { quickApps = []; }
                }
                // Merge queues but tag source for clarity
                const merged = [].concat(
                    (applications||[]).map(a => ({...a, __source:'applications'})),
                    (quickApps||[]).map(a => ({...a, __source:'quickApplications'}))
                );
                try {
                    const jobFilter = document.getElementById('applicationJobFilter');
                    if (jobFilter) {
                        const existing = new Set();
                        applications.forEach(a => existing.add(a.jobTitle || ''));
                        const options = ['<option value="">All Jobs</option>'].concat(Array.from(existing).filter(Boolean).map(t => `<option value="${t}">${t}</option>`));
                        jobFilter.innerHTML = options.join('');
                    }
                } catch (_) {}
                const stats = {
                    total: merged.length,
                    pending: merged.filter(app => (app.status || 'new') === 'new' || app.status === 'pending').length,
                    accepted: merged.filter(app => app.status === 'approved' || app.status === 'accepted').length,
                    rejected: merged.filter(app => app.status === 'denied' || app.status === 'rejected').length
                };
                const totalEl = document.getElementById('totalApplications');
                const pendingEl = document.getElementById('pendingApplications');
                const acceptedEl = document.getElementById('acceptedApplications');
                const rejectedEl = document.getElementById('rejectedApplications');
                if (totalEl) totalEl.textContent = String(stats.total);
                if (pendingEl) pendingEl.textContent = String(stats.pending);
                if (acceptedEl) acceptedEl.textContent = String(stats.accepted);
                if (rejectedEl) rejectedEl.textContent = String(stats.rejected);
                loadApplicationsList(merged);
            } catch (err) {
                console.error('‚ùå Failed to update application stats:', err);
                showNotification('Failed to load applications', 'error');
            }
        }

        // Load Applications List with Approve/Deny
        function loadApplicationsList(applications) {
            const container = document.getElementById('adminApplicationsList');
            if (!container) return;
            const html = applications.map(app => {
                const created = app.createdAt ? new Date(app.createdAt) : (app.date ? new Date(app.date) : new Date());
                const status = (app.status || 'new');
                const statusClass = status === 'approved' || status === 'accepted' ? 'accepted' : (status === 'denied' || status === 'rejected' ? 'rejected' : 'pending');
                return `
                <div class="application-item">
                    <div class="application-info">
                        <h4>${app.jobTitle || 'Untitled Role'} ${app.__source==='quickApplications' ? '<span style="font-size:.75rem;color:#FFB200">(Quick)</span>' : ''}</h4>
                        <p>${(app.applicant && app.applicant.email) ? app.applicant.email : ''} ‚Ä¢ ${created.toLocaleDateString()}</p>
                    </div>
                    <div class="application-status status-${statusClass}">${status}</div>
                    <div style="display:flex; gap:.5rem; align-items:center;">
                        <button class="btn btn-small" onclick="approveApplication('${app.id}','${app.__source||'applications'}')">Approve</button>
                        <button class="btn btn-small" onclick="denyApplication('${app.id}','${app.__source||'applications'}')">Deny</button>
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = html;
        }

        async function approveApplication(appId, source) {
            try {
                if (!(window.FirestoreDataManager && window.FirestoreDataManager.isAvailable())) throw new Error('Firestore unavailable');
                const s = source || 'applications';
                if (s === 'quickApplications') {
                    await window.FirestoreDataManager.setQuickApplicationStatus(appId, 'approved');
                    await processQuickApplicationApproval(appId);
                } else {
                    await window.FirestoreDataManager.setApplicationStatus(appId, 'approved');
                    await processStandardApplicationApproval(appId);
                }
                showNotification('Application approved', 'success');
                updateApplicationStats();
            } catch (e) {
                console.error('‚ùå approveApplication failed:', e);
                showNotification('Failed to approve application', 'error');
            }
        }

        async function denyApplication(appId, source) {
            try {
                if (!(window.FirestoreDataManager && window.FirestoreDataManager.isAvailable())) throw new Error('Firestore unavailable');
                const s = source || 'applications';
                if (s === 'quickApplications') {
                    await window.FirestoreDataManager.setQuickApplicationStatus(appId, 'denied');
                } else {
                    await window.FirestoreDataManager.setApplicationStatus(appId, 'denied');
                }
                showNotification('Application denied', 'warning');
                updateApplicationStats();
            } catch (e) {
                console.error('‚ùå denyApplication failed:', e);
                showNotification('Failed to deny application', 'error');
            }
        }

        // Process approvals to follow same onboarding pipeline
        async function processStandardApplicationApproval(appId){
            // For now, rely on existing approveUser path once user is attached
            try {
                const apps = await window.FirestoreDataManager.getApplications();
                const app = (apps||[]).find(a=>a.id===appId);
                if (!app) return;
                await attachJobAndSendOnboarding(app);
            } catch(_) {}
        }

        async function processQuickApplicationApproval(appId){
            try {
                const qapps = await window.FirestoreDataManager.getQuickApplications();
                const app = (qapps||[]).find(a=>a.id===appId);
                if (!app) return;
                await attachJobAndSendOnboarding(app);
            } catch(e) { console.warn('‚ö†Ô∏è processQuickApplicationApproval:', e?.message||e); }
        }

        // Shared function: map job to user profile and trigger email+contract
        async function attachJobAndSendOnboarding(app){
            try {
                await window.FirebaseConfig.waitForInit();
            } catch(_) {}
            const email = (app.applicant && app.applicant.email)||'';
            const uid = app.applicant && app.applicant.uid;
            let userId = uid || await window.FirestoreDataManager.findUserIdByEmail(email);
            if (!userId) {
                // Create a minimal user entry if not found (email is required for EmailJS)
                userId = email || (uid || 'unknown');
            }
            // Load existing user data
            let users = {};
            try { users = await window.FirestoreDataManager.getUsers(); } catch(_){ users = window.users||{}; }
            const userData = users[userId] || { profile: { email }, application: {}, jobs: {} };

            // Build job object
            const jobKey = app.jobId || (`slug-${(app.jobTitle||'').replace(/\s+/g,'-').toLowerCase()}`);
            const jobObj = {
                id: app.jobId || null,
                title: app.jobTitle || 'Contractor',
                location: app.location || (userData.profile && userData.profile.location) || 'Atlanta Area',
                date: app.jobDate || null,
                // Store rate explicitly for email/template compatibility; keep pay for backward-compat
                rate: app.payDisplay || app.rate || app.pay || 'TBD',
                pay: app.payDisplay || app.rate || app.pay || 'TBD',
                status: 'approved'
            };
            // Duplicate guard on jobs
            const jobs = { ...(userData.jobs||{}) };
            if (!jobs[jobKey]) {
                jobs[jobKey] = jobObj;
            }
            // Update application status
            const application = { ...(userData.application||{}), status: 'approved', updatedAt: new Date().toISOString(), jobTitle: app.jobTitle };
            
            // Set primaryJob to the newly approved job for contract display
            // Auto-fill profile.name from application if missing
            const inferredName = (app.applicant && (app.applicant.name || app.applicant.fullName)) || userData.profile?.name || '';
            const updatedUser = { ...userData, profile: { ...(userData.profile||{}), email, ...(inferredName ? { name: inferredName } : {}) }, application, jobs, primaryJob: jobKey };

            try { await window.FirestoreDataManager.setUser(userId, updatedUser); } catch(e){ console.warn('‚ö†Ô∏è setUser on approval:', e?.message||e); }

            // If there is a corresponding public job listing, mark it Inactive so it no longer appears on index.html
            try {
                const jobId = app.jobId;
                if (jobId && window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const listing = await window.FirestoreDataManager.getJobListing(jobId);
                    if (listing) {
                        listing.status = 'Inactive';
                        await window.FirestoreDataManager.setJobListing(jobId, listing);
                        console.log('‚úÖ Marked job listing inactive after approval:', jobId);
                    }
                }
            } catch (inactiveErr) { console.warn('‚ö†Ô∏è Could not set job inactive:', inactiveErr?.message||inactiveErr); }

            // Ensure a Firebase Auth account exists for approved applicants (so they can log in)
            try {
                const tempPwd = (typeof generateTempPassword === 'function') ? generateTempPassword() : Math.random().toString(36).slice(2,10) + 'Aa1!';
                if (email) {
                    // Guard: check if an auth account already exists via API lookup
                    try {
                        const check = await fetch(`/api/firebase?email=${encodeURIComponent(email)}`);
                        const cj = await check.json();
                        if (cj && cj.success && cj.exists) {
                            console.log('‚ÑπÔ∏è Firebase auth already exists for', email);
                        } else if (typeof createFirebaseAccount === 'function') {
                            const res = await createFirebaseAccount(email, tempPwd);
                            if (res && res.success) {
                                console.log('‚úÖ Firebase auth account ensured for', email);
                            } else {
                                console.log('‚ÑπÔ∏è Firebase account may already exist or was not created:', res);
                            }
                        }
                    } catch (lookupErr) {
                        console.warn('‚ö†Ô∏è Auth existence check failed; attempting create anyway');
                        if (typeof createFirebaseAccount === 'function') {
                            const res = await createFirebaseAccount(email, tempPwd);
                            console.log('‚ÑπÔ∏è Fallback create result:', res);
                        }
                    }
                }
            } catch (authErr) {
                console.warn('‚ö†Ô∏è Could not ensure Firebase auth account:', authErr?.message || authErr);
            }

            // Trigger email + contract onboarding for the specific job that was just approved
            try { sendJobAcceptanceEmail(userId, updatedUser, { jobKey }); } catch(e){ console.warn('‚ö†Ô∏è sendJobAcceptanceEmail unavailable:', e?.message||e); }
        }

        // Export Performance Report
        function exportPerformanceReport() {
            console.log('üìä Exporting performance report...');
            // This would generate and download a CSV/PDF report
            showNotification('Performance report exported!', 'success');
        }

        // Open Rating Modal
        function openRatingModal() {
            console.log('‚≠ê Opening rating modal...');
            // This would open a modal to rate contractors
            showNotification('Rating modal opened!', 'info');
        }

        // View Performance Details
        function viewPerformanceDetails() {
            console.log('üìà Viewing performance details...');
            // This would open detailed performance analytics
            showNotification('Performance details opened!', 'info');
        }

        // Setup Performance Alerts
        function setupPerformanceAlerts() {
            console.log('üîî Setting up performance alerts...');
            // This would open alert configuration
            showNotification('Performance alerts setup opened!', 'info');
        }

        // Filter Applications
        function filterApplications() {
            const statusFilter = document.getElementById('applicationStatusFilter')?.value || '';
            const jobFilter = document.getElementById('applicationJobFilter')?.value || '';
            
            console.log('üîç Filtering applications:', { statusFilter, jobFilter });
            // This would filter the applications list
            showNotification('Applications filtered!', 'info');
        }

        // Initialize Performance Management
        function initializePerformanceManagement() {
            updatePerformanceStats();
            updateApplicationStats();
        }

        // ==================== COMMUNITY MANAGEMENT FUNCTIONS ====================
        
        // Community Analytics
        async function updateCommunityStats() {
            try {
                // Prefer Firestore live counts; fallback to localStorage if unavailable
                let messages = [];
                let showcases = [];
                let events = [];
                let successStories = [];

                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }

                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    try {
                        const db = window.FirestoreDataManager.db;
                        const [msgSnap, showSnap, evtSnap, sucSnap] = await Promise.all([
                            db.collection(window.FirestoreDataManager.collections.messages).get(),
                            db.collection(window.FirestoreDataManager.collections.showcases).get(),
                            db.collection(window.FirestoreDataManager.collections.events).get(),
                            db.collection(window.FirestoreDataManager.collections.successStories).get()
                        ]);
                        messages = msgSnap.docs;
                        showcases = showSnap.docs;
                        events = evtSnap.docs;
                        successStories = sucSnap.docs;
                    } catch (e) {
                        // Silent fallback to local cache below
                    }
                }

                if (!messages.length) messages = JSON.parse(localStorage.getItem('cochranMessages') || '[]');
                if (!showcases.length) showcases = JSON.parse(localStorage.getItem('cochranShowcases') || '[]');
                if (!events.length) events = JSON.parse(localStorage.getItem('cochranEvents') || '[]');
                if (!successStories.length) successStories = JSON.parse(localStorage.getItem('cochranSuccessStories') || '[]');

                document.getElementById('totalMessages').textContent = messages.length || messages.size || 0;
                document.getElementById('totalShowcases').textContent = showcases.length || showcases.size || 0;
                document.getElementById('totalEvents').textContent = events.length || events.size || 0;
                document.getElementById('totalSuccessStories').textContent = successStories.length || successStories.size || 0;
            } catch (error) {
                console.error('Error updating community stats:', error);
            }
        }
        
        // Message Management
        function viewMessages() {
            console.log('üì± Opening message viewer...');
            showNotification('Message viewer opened!', 'info');
            // This would open a modal to view and moderate messages
        }
        
        function setupContentFilter() {
            console.log('üîç Setting up content filter...');
            showNotification('Content filter setup opened!', 'info');
            // This would open a modal to configure content filtering
        }
        
        // Showcase Management
        async function manageShowcases() {
            try {
                await ensureFirestoreReady();
                const list = await window.FirestoreDataManager.getShowcases();
                if (!Array.isArray(list) || !list.length) { showAdminNotification('Info','No showcases submitted yet','info'); return; }
                const pending = list.filter(s => (s.status || 'pending') === 'pending');
                const choices = (pending.length ? pending : list).map((s, i) => `${i+1}) ${s.title} ‚Äî ${s.author || s.ownerEmail || ''} [${s.status||'pending'}]`).join('\n');
                const pick = prompt(`Select a showcase to approve/deny/delete:\n${choices}\nEnter number:`);
                const idx = Math.max(1, Number(pick||'1')) - 1;
                const item = (pending.length ? pending : list)[idx];
                if (!item) return;
                const action = prompt('Type "approve", "deny", "edit", or "delete":', 'approve');
                if (action === 'delete') {
                    await window.FirestoreDataManager.deleteShowcase(item.id);
                    showAdminNotification('Deleted','Showcase removed','success');
                } else if (action === 'approve') {
                    await window.FirestoreDataManager.updateShowcase(item.id, { status: 'approved', approvedAt: new Date().toISOString() });
                    showAdminNotification('Approved','Showcase approved','success');
                } else if (action === 'deny') {
                    const reason = prompt('Reason for denial (optional)') || '';
                    await window.FirestoreDataManager.updateShowcase(item.id, { status: 'denied', denialReason: reason, reviewedAt: new Date().toISOString() });
                    showAdminNotification('Updated','Showcase denied','success');
                } else if (action === 'edit') {
                    const newTitle = prompt('New title', item.title || '') || item.title;
                    const newDesc = prompt('New description', item.description || '') || item.description;
                    await window.FirestoreDataManager.updateShowcase(item.id, { title: newTitle, description: newDesc });
                    showAdminNotification('Updated','Showcase updated','success');
                }
                await updateCommunityStats();
            } catch (e) {
                console.error(e);
                showAdminNotification('Error','Failed to manage showcases','error');
            }
        }
        
        function reviewShowcases() {
            console.log('‚úÖ Reviewing showcases...');
            showNotification('Showcase review opened!', 'info');
            // This would open a modal to review showcase content
        }
        
        // Event Management (Modern Modal UI)
        function openEventManager(mode = 'manage', existing = null) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:12000;display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top,16px) 12px env(safe-area-inset-bottom,16px);overflow:auto;';
            modal.innerHTML = `
                <div style="background:#0f1115;border:1px solid rgba(255,178,0,0.25);border-radius:14px;width:min(880px,96%);max-height:calc(100vh - 48px);display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.5);color:#fff;">
                    <div style="padding:14px 16px;border-bottom:1px solid rgba(255,178,0,0.2);display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <i class="fas fa-calendar-alt" style="color:#FFB200;"></i>
                            <h3 style="margin:0;color:#FFB200;font-weight:800;">Event Manager</h3>
                        </div>
                        <div>
                            <button id="em-close" class="btn btn-secondary" style="padding:.4rem .8rem;">Close</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;padding:16px;">
                        <div>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <h4 style="margin:0;color:#FFB200;">Upcoming Events</h4>
                                <div style="display:flex;gap:8px;">
                                    <button id="em-refresh" class="btn btn-secondary" style="padding:.35rem .7rem;">Refresh</button>
                                    <button id="em-new" class="btn" style="padding:.35rem .7rem;">New Event</button>
                                </div>
                            </div>
                            <div id="em-list" style="display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto;"></div>
                        </div>
                        <div>
                            <h4 style="margin:0 0 8px 0;color:#FFB200;">${mode==='create'?'Create Event':'Edit Event'}</h4>
                            <form id="em-form" style="display:grid;gap:10px;">
                                <input type="hidden" id="em-id" />
                                <label style="display:flex;flex-direction:column;gap:6px;">
                                    <span>Title</span>
                                    <input id="em-title" type="text" placeholder="Company Town Hall" style="padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;" />
                                </label>
                                <div style="display:grid;grid-template-columns: 1fr 1fr; gap:10px;">
                                    <label style="display:flex;flex-direction:column;gap:6px;">
                                        <span>Date</span>
                                        <input id="em-date" type="date" style="padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;" />
                                    </label>
                                    <label style="display:flex;flex-direction:column;gap:6px;">
                                        <span>Status</span>
                                        <select id="em-status" style="padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;">
                                            <option value="scheduled">scheduled</option>
                                            <option value="cancelled">cancelled</option>
                                            <option value="completed">completed</option>
                                        </select>
                                    </label>
                                </div>
                                <label style="display:flex;flex-direction:column;gap:6px;">
                                    <span>Location</span>
                                    <input id="em-location" type="text" placeholder="Atlanta HQ" style="padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;" />
                                </label>
                                <label style="display:flex;flex-direction:column;gap:6px;">
                                    <span>Description</span>
                                    <textarea id="em-description" rows="5" placeholder="Details for the team‚Ä¶" style="padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;resize:vertical;"></textarea>
                                </label>
                                <div style="display:flex;gap:8px;justify-content:flex-end;">
                                    <button type="button" id="em-clear" class="btn btn-secondary">Clear</button>
                                    <button type="submit" class="btn">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            const listEl = modal.querySelector('#em-list');
            const form = modal.querySelector('#em-form');
            const close = () => modal.remove();
            modal.querySelector('#em-close').onclick = close;
            modal.addEventListener('click', (e) => { if (e.target === modal) close(); });

            function fillForm(ev) {
                modal.querySelector('#em-id').value = ev?.id || '';
                modal.querySelector('#em-title').value = ev?.title || '';
                modal.querySelector('#em-date').value = (ev?.date || '').slice(0,10);
                modal.querySelector('#em-status').value = ev?.status || 'scheduled';
                modal.querySelector('#em-location').value = ev?.location || '';
                modal.querySelector('#em-description').value = ev?.description || '';
            }

            async function loadEvents() {
                try {
                    await ensureFirestoreReady();
                    const events = await window.FirestoreDataManager.getEvents();
                    if (!listEl) return;
                    if (!Array.isArray(events) || !events.length) {
                        listEl.innerHTML = `<div style="text-align:center;color:#9ca3af;padding:1rem;border:1px dashed rgba(255,178,0,0.25);border-radius:10px;">No events yet</div>`;
                        return;
                    }
                    listEl.innerHTML = events.map(ev => `
                        <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;gap:12px;padding:.8rem;border:1px solid rgba(255,178,0,0.2);border-radius:10px;">
                            <div>
                                <div style="font-weight:700;color:#FFB200;">${ev.title || 'Untitled'}</div>
                                <div style="color:#9ca3af;font-size:.9rem;">${ev.date ? new Date(ev.date).toLocaleDateString() : ''} ‚Ä¢ <span class="status-${ev.status||'scheduled'}">${ev.status||'scheduled'}</span>${ev.location?` ‚Ä¢ ${ev.location}`:''}</div>
                            </div>
                            <div style="display:flex;gap:6px;">
                                <button class="btn btn-secondary" data-action="edit" data-id="${ev.id}">Edit</button>
                                <button class="btn btn-danger" data-action="delete" data-id="${ev.id}">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('loadEvents error', e);
                }
            }

            listEl?.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');
                await ensureFirestoreReady();
                const all = await window.FirestoreDataManager.getEvents();
                const ev = (all||[]).find(x => x.id === id);
                if (!ev) return;
                if (action === 'edit') {
                    fillForm(ev);
                } else if (action === 'delete') {
                    if (confirm('Delete this event?')) {
                        await window.FirestoreDataManager.deleteEvent(id);
                        await loadEvents();
                        await updateCommunityStats();
                        showAdminNotification('Deleted','Event removed','success');
                        // Clear form if it was showing this event
                        if (modal.querySelector('#em-id').value === id) fillForm(null);
                    }
                }
            });

            modal.querySelector('#em-refresh')?.addEventListener('click', loadEvents);
            modal.querySelector('#em-new')?.addEventListener('click', () => fillForm(null));
            modal.querySelector('#em-clear')?.addEventListener('click', () => fillForm(null));

            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await ensureFirestoreReady();
                    const id = modal.querySelector('#em-id').value.trim();
                    const payload = {
                        title: modal.querySelector('#em-title').value.trim(),
                        date: modal.querySelector('#em-date').value,
                        status: modal.querySelector('#em-status').value || 'scheduled',
                        location: modal.querySelector('#em-location').value.trim(),
                        description: modal.querySelector('#em-description').value.trim()
                    };
                    if (!payload.title) { showAdminNotification('Missing','Title is required','error'); return; }
                    if (!payload.date) { showAdminNotification('Missing','Date is required','error'); return; }
                    if (id) {
                        await window.FirestoreDataManager.updateEvent(id, payload);
                        showAdminNotification('Saved','Event updated','success');
                    } else {
                        await window.FirestoreDataManager.addEvent(payload);
                        showAdminNotification('Added','Event created','success');
                    }
                    await loadEvents();
                    await updateCommunityStats();
                } catch (err) {
                    console.error(err);
                    showAdminNotification('Error','Failed to save event','error');
                }
            });

            // Prefill when invoked from Create button
            if (mode === 'create') fillForm(existing);
            loadEvents();
        }

        // Backward-compatible handlers
        async function createEvent() { openEventManager('create'); }
        async function manageEvents() { openEventManager('manage'); }
        
        // Success Stories Management (Modern Modal UI)
        function openSuccessStoryManager(mode = 'manage', existing = null) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:12000;display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top,16px) 12px env(safe-area-inset-bottom,16px);overflow:auto;';
            modal.innerHTML = `
                <div style="background:#0f1115;border:1px solid rgba(255,178,0,0.25);border-radius:14px;width:min(980px,96%);max-height:calc(100vh - 48px);display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.5);color:#fff;">
                    <div style=\"padding:14px 16px;border-bottom:1px solid rgba(255,178,0,0.2);display:flex;justify-content:space-between;align-items:center;\">
                        <div style=\"display:flex;align-items:center;gap:10px;\">
                            <i class=\"fas fa-trophy\" style=\"color:#FFB200;\"></i>
                            <h3 style=\"margin:0;color:#FFB200;font-weight:800;\">Success Story Manager</h3>
                        </div>
                        <div>
                            <button id=\"ss-close\" class=\"btn btn-secondary\" style=\"padding:.4rem .8rem;\">Close</button>
                        </div>
                    </div>
                    <div style=\"display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;padding:16px;\">
                        <div>
                            <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;\">
                                <h4 style=\"margin:0;color:#FFB200;\">Stories</h4>
                                <div style=\"display:flex;gap:8px;\">
                                    <button id=\"ss-refresh\" class=\"btn btn-secondary\" style=\"padding:.35rem .7rem;\">Refresh</button>
                                    <button id=\"ss-new\" class=\"btn\" style=\"padding:.35rem .7rem;\">New Story</button>
                                </div>
                            </div>
                            <div id=\"ss-list\" style=\"display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto;\"></div>
                        </div>
                        <div>
                            <h4 style=\"margin:0 0 8px 0;color:#FFB200;\">${mode==='create'?'Create Story':'Edit Story'}</h4>
                            <form id=\"ss-form\" style=\"display:grid;gap:10px;\">
                                <input type=\"hidden\" id=\"ss-id\" />
                                <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:10px;\">
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Author</span>
                                        <input id=\"ss-author\" type=\"text\" placeholder=\"Jane Doe\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Author Email</span>
                                        <input id=\"ss-email\" type=\"email\" placeholder=\"jane@example.com\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                </div>
                                <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:10px;\">
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Role</span>
                                        <input id=\"ss-role\" type=\"text\" placeholder=\"Photographer\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Achievement Badge</span>
                                        <input id=\"ss-achievement\" type=\"text\" placeholder=\"Top Performer\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                </div>
                                <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                    <span>Title</span>
                                    <input id=\"ss-title\" type=\"text\" placeholder=\"Crushed a multi-day production\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                </label>
                                <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                    <span>Description</span>
                                    <textarea id=\"ss-description\" rows=\"5\" placeholder=\"Short description‚Ä¶\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;resize:vertical;\"></textarea>
                                </label>
                                <div style=\"display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;\">
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Projects Completed</span>
                                        <input id=\"ss-projects\" type=\"number\" min=\"0\" step=\"1\" placeholder=\"0\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Client Rating</span>
                                        <input id=\"ss-rating\" type=\"number\" min=\"0\" max=\"5\" step=\"0.1\" placeholder=\"4.9\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                    <label style=\"display:flex;flex-direction:column;gap:6px;\">
                                        <span>Earnings</span>
                                        <input id=\"ss-earnings\" type=\"text\" placeholder=\"$2,400\" style=\"padding:.6rem;border-radius:8px;border:1px solid rgba(255,178,0,0.3);background:#0b0d11;color:#fff;\" />
                                    </label>
                                </div>
                                <div style=\"display:flex;gap:8px;justify-content:flex-end;\">
                                    <button type=\"button\" id=\"ss-clear\" class=\"btn btn-secondary\">Clear</button>
                                    <button type=\"submit\" class=\"btn\">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            const listEl = modal.querySelector('#ss-list');
            const form = modal.querySelector('#ss-form');
            const close = () => modal.remove();
            modal.querySelector('#ss-close').onclick = close;
            modal.addEventListener('click', (e) => { if (e.target === modal) close(); });

            function fillForm(story) {
                modal.querySelector('#ss-id').value = story?.id || '';
                modal.querySelector('#ss-author').value = story?.author || '';
                modal.querySelector('#ss-email').value = story?.authorEmail || '';
                modal.querySelector('#ss-role').value = story?.role || '';
                modal.querySelector('#ss-achievement').value = story?.achievement || '';
                modal.querySelector('#ss-title').value = story?.title || '';
                modal.querySelector('#ss-description').value = story?.description || '';
                modal.querySelector('#ss-projects').value = story?.stats?.projectsCompleted || '';
                modal.querySelector('#ss-rating').value = story?.stats?.clientRating || '';
                modal.querySelector('#ss-earnings').value = story?.stats?.earnings || '';
            }

            async function loadStories() {
                try {
                    await ensureFirestoreReady();
                    const stories = await window.FirestoreDataManager.getSuccessStories();
                    if (!listEl) return;
                    if (!Array.isArray(stories) || !stories.length) {
                        listEl.innerHTML = `<div style=\"text-align:center;color:#9ca3af;padding:1rem;border:1px dashed rgba(255,178,0,0.25);border-radius:10px;\">No stories yet</div>`;
                        return;
                    }
                    listEl.innerHTML = stories.map(s => `
                        <div class=\"list-item\" style=\"display:flex;justify-content:space-between;align-items:center;gap:12px;padding:.8rem;border:1px solid rgba(255,178,0,0.2);border-radius:10px;\">
                            <div>
                                <div style=\"font-weight:700;color:#FFB200;\">${s.title || 'Untitled'}</div>
                                <div style=\"color:#9ca3af;font-size:.9rem;\">${s.author || ''}${s.role?` ‚Ä¢ ${s.role}`:''}</div>
                            </div>
                            <div style=\"display:flex;gap:6px;\">
                                <button class=\"btn btn-secondary\" data-action=\"edit\" data-id=\"${s.id}\">Edit</button>
                                <button class=\"btn btn-danger\" data-action=\"delete\" data-id=\"${s.id}\">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('loadStories error', e);
                }
            }

            listEl?.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');
                await ensureFirestoreReady();
                const all = await window.FirestoreDataManager.getSuccessStories();
                const story = (all||[]).find(x => x.id === id);
                if (!story) return;
                if (action === 'edit') {
                    fillForm(story);
                } else if (action === 'delete') {
                    if (confirm('Delete this story?')) {
                        await window.FirestoreDataManager.deleteSuccessStory(id);
                        await loadStories();
                        await updateCommunityStats();
                        showAdminNotification('Deleted','Success story removed','success');
                        if (modal.querySelector('#ss-id').value === id) fillForm(null);
                    }
                }
            });

            modal.querySelector('#ss-refresh')?.addEventListener('click', loadStories);
            modal.querySelector('#ss-new')?.addEventListener('click', () => fillForm(null));
            modal.querySelector('#ss-clear')?.addEventListener('click', () => fillForm(null));

            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await ensureFirestoreReady();
                    const id = modal.querySelector('#ss-id').value.trim();
                    const payload = {
                        author: modal.querySelector('#ss-author').value.trim(),
                        authorEmail: modal.querySelector('#ss-email').value.trim().toLowerCase(),
                        role: modal.querySelector('#ss-role').value.trim() || 'Team Member',
                        achievement: modal.querySelector('#ss-achievement').value.trim(),
                        title: modal.querySelector('#ss-title').value.trim(),
                        description: modal.querySelector('#ss-description').value.trim(),
                        stats: {
                            projectsCompleted: Number(modal.querySelector('#ss-projects').value || 0),
                            clientRating: Number(modal.querySelector('#ss-rating').value || 0),
                            earnings: modal.querySelector('#ss-earnings').value.trim() || '$0'
                        },
                        congratulations: 0,
                        timestamp: new Date().toISOString()
                    };
                    if (!payload.author) { showAdminNotification('Missing','Author is required','error'); return; }
                    if (!payload.title) { showAdminNotification('Missing','Title is required','error'); return; }
                    if (id) {
                        await window.FirestoreDataManager.updateSuccessStory(id, payload);
                        showAdminNotification('Saved','Success story updated','success');
                    } else {
                        await window.FirestoreDataManager.addSuccessStory(payload);
                        showAdminNotification('Added','Success story created','success');
                    }
                    await loadStories();
                    await updateCommunityStats();
                } catch (err) {
                    console.error(err);
                    showAdminNotification('Error','Failed to save success story','error');
                }
            });

            if (mode === 'create') fillForm(existing);
            loadStories();
        }

        async function addSuccessStory(){ openSuccessStoryManager('create'); }
        async function manageSuccessStories(){ openSuccessStoryManager('manage'); }
        
        // Community Actions
        function exportCommunityData() {
            console.log('üìä Exporting community data...');
            try {
                const data = {
                    messages: JSON.parse(localStorage.getItem('cochranMessages') || '[]'),
                    showcases: JSON.parse(localStorage.getItem('cochranShowcases') || '[]'),
                    events: JSON.parse(localStorage.getItem('cochranEvents') || '[]'),
                    successStories: JSON.parse(localStorage.getItem('cochranSuccessStories') || '[]'),
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cochran-community-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('Community data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting community data:', error);
                showNotification('Failed to export community data', 'error');
            }
        }
        
        function clearOldMessages() {
            console.log('üóëÔ∏è Clearing old messages...');
            if (confirm('Are you sure you want to clear messages older than 30 days?')) {
                try {
                    const messages = JSON.parse(localStorage.getItem('cochranMessages') || '[]');
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const filteredMessages = messages.filter(msg => 
                        new Date(msg.timestamp) > thirtyDaysAgo
                    );
                    
                    localStorage.setItem('cochranMessages', JSON.stringify(filteredMessages));
                    updateCommunityStats();
                    showNotification(`Cleared ${messages.length - filteredMessages.length} old messages`, 'success');
                } catch (error) {
                    console.error('Error clearing old messages:', error);
                    showNotification('Failed to clear old messages', 'error');
                }
            }
        }
        
        function resetCommunitySettings() {
            console.log('üîÑ Resetting community settings...');
            if (confirm('Are you sure you want to reset all community settings to default?')) {
                try {
                    // Reset settings to default values
                    document.getElementById('enableMessaging').checked = true;
                    document.getElementById('enableShowcases').checked = true;
                    document.getElementById('enableEvents').checked = true;
                    document.getElementById('enableSuccessStories').checked = true;
                    document.getElementById('messageLengthLimit').value = 500;
                    document.getElementById('showcaseImageLimit').value = 10;
                    document.getElementById('autoModeration').value = 'off';
                    
                    showNotification('Community settings reset to default', 'success');
                } catch (error) {
                    console.error('Error resetting community settings:', error);
                    showNotification('Failed to reset community settings', 'error');
                }
            }
        }
        
        // Initialize community management
        function initializeCommunityManagement() {
            updateCommunityStats();
            
            // Add event listeners for settings changes
            const settings = ['enableMessaging', 'enableShowcases', 'enableEvents', 'enableSuccessStories'];
            settings.forEach(settingId => {
                const element = document.getElementById(settingId);
                if (element) {
                    element.addEventListener('change', function() {
                        console.log(`Setting ${settingId} changed to:`, this.checked);
                        showNotification(`Setting ${settingId} updated`, 'info');
                    });
                }
            });
            
            // Add event listeners for moderation settings
            const moderationSettings = ['messageLengthLimit', 'showcaseImageLimit', 'autoModeration'];
            moderationSettings.forEach(settingId => {
                const element = document.getElementById(settingId);
                if (element) {
                    element.addEventListener('change', function() {
                        console.log(`Moderation setting ${settingId} changed to:`, this.value);
                        showNotification(`Moderation setting ${settingId} updated`, 'info');
                    });
                }
            });
        }

        // Make functions globally accessible
        window.refreshPerformanceData = refreshPerformanceData;
        window.exportPerformanceReport = exportPerformanceReport;
        window.openRatingModal = openRatingModal;
        window.viewPerformanceDetails = viewPerformanceDetails;
        window.setupPerformanceAlerts = setupPerformanceAlerts;
        window.filterApplications = filterApplications;
        window.initializePerformanceManagement = initializePerformanceManagement;
        
        // Community management functions
        window.viewMessages = viewMessages;
        window.setupContentFilter = setupContentFilter;
        window.manageShowcases = manageShowcases;
        window.reviewShowcases = reviewShowcases;
        window.createEvent = createEvent;
        window.manageEvents = manageEvents;
        window.addSuccessStory = addSuccessStory;
        window.manageSuccessStories = manageSuccessStories;
        window.exportCommunityData = exportCommunityData;
        window.clearOldMessages = clearOldMessages;
        window.resetCommunitySettings = resetCommunitySettings;
        window.initializeCommunityManagement = initializeCommunityManagement;
    </script>

    <script>
        // ============ Equipment & Resource Center (Admin) Scripts ============
        async function ensureFirestoreReady() {
            if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                try { await window.FirestoreDataManager.init(); } catch(_) {}
            }
        }

        // Equipment
        async function adminLoadEquipment() {
            try {
                await ensureFirestoreReady();
                const list = await window.FirestoreDataManager.getEquipment();
                const container = document.getElementById('adminEquipmentList');
                if (!container) return;
                container.innerHTML = (list||[]).map(item => `
                    <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 1rem; border: 1px solid rgba(255,178,0,0.2); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight:700; color:#FFB200;">${item.name||'Unnamed'}</div>
                            <div style="color:#9ca3af; font-size:.9rem;">
                                ${item.category||'General'} ‚Ä¢ 
                                <span class="status-${item.status||'available'}">${item.status||'available'}</span>
                                ${item.serialNumber?`‚Ä¢ SN: ${item.serialNumber}`:''}
                            </div>
                            
                            ${item.reservation ? `
                                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px;">
                                    <div style="color: #f59e0b; font-weight: 600; font-size: 0.85rem; margin-bottom: 4px;">
                                        <i class="fas fa-clock"></i> RESERVED
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.8rem;">
                                        <div>Reserved for: ${item.reservation.userEmail||''}</div>
                                        ${item.reservation.neededFrom?`<div>From: ${item.reservation.neededFrom}</div>`:''}
                                        ${item.reservation.neededTo?`<div>To: ${item.reservation.neededTo}</div>`:''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${item.rental ? `
                                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px;">
                                    <div style="color: #22c55e; font-weight: 600; font-size: 0.85rem; margin-bottom: 4px;">
                                        <i class="fas fa-user"></i> RENTED TO: ${item.rental.userName || item.rental.userEmail || 'Unknown'}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.8rem;">
                                        <div>Checked out: ${new Date(item.rental.checkedOutAt).toLocaleString()}</div>
                                        <div>Due back: ${new Date(item.rental.dueBackAt).toLocaleString()}</div>
                                        ${item.rental.notes ? `<div>Notes: ${item.rental.notes}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="display:flex; gap:8px; flex-direction: column;">
                            <div style="display:flex; gap:4px;">
                                <button class="btn btn-secondary" onclick="adminEditEquipment('${item.id}')" style="font-size: 0.8rem; padding: 4px 8px;">Edit</button>
                                <button class="btn btn-danger" onclick="adminDeleteEquipment('${item.id}')" style="font-size: 0.8rem; padding: 4px 8px;">Delete</button>
                            </div>
                            ${item.status==='reserved'?`<button class='btn btn-secondary' onclick=\"adminCheckOutEquipment('${item.id}')\" style="font-size: 0.8rem; padding: 4px 8px;">Check Out</button>`:''}
                            ${item.status==='checked_out'?`<button class='btn btn-secondary' onclick=\"adminCheckInEquipment('${item.id}')\" style="font-size: 0.8rem; padding: 4px 8px;">Check In</button>`:''}
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.warn('adminLoadEquipment error', e); }
        }
        function adminClearEquipmentForm(){ try { document.getElementById('adminEquipmentForm').reset(); document.getElementById('equipId').value=''; } catch(_) {} }
        function adminEditEquipment(id){
            try {
                document.getElementById('equipId').value = id;
            } catch(_) {}
        }
        async function adminDeleteEquipment(id){
            try { await ensureFirestoreReady(); await window.FirestoreDataManager.deleteEquipment(id); await adminLoadEquipment(); showAdminNotification('Deleted','Equipment removed','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to delete','error'); }
        }
        async function adminSaveEquipment(e){
            e.preventDefault();
            try {
                await ensureFirestoreReady();
                const payload = {
                    name: document.getElementById('equipName').value.trim(),
                    category: document.getElementById('equipCategory').value.trim(),
                    status: document.getElementById('equipStatus').value,
                    serialNumber: document.getElementById('equipSerial').value.trim(),
                    tags: (document.getElementById('equipTags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
                    location: document.getElementById('equipLocation').value.trim(),
                    notes: document.getElementById('equipNotes').value.trim()
                };
                const id = document.getElementById('equipId').value.trim();
                if (id) await window.FirestoreDataManager.updateEquipment(id, payload);
                else await window.FirestoreDataManager.addEquipment(payload);
                adminClearEquipmentForm();
                await adminLoadEquipment();
                showAdminNotification('Saved','Equipment saved','success');
            } catch(e){ console.error(e); showAdminNotification('Error','Failed to save equipment','error'); }
            return false;
        }

        // Resources
        async function adminLoadResources(){
            try { await ensureFirestoreReady(); const list = await window.FirestoreDataManager.getResources(); const container = document.getElementById('adminResourceList'); if(!container) return; container.innerHTML = (list||[]).map(r=>`
                <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div>
                        <div style=\"font-weight:700; color:#FFB200;\">${r.title||'Untitled'}</div>
                        <div style=\"color:#9ca3af; font-size:.9rem;\">${r.type||'document'} ${r.version?`‚Ä¢ v${r.version}`:''}</div>
                    </div>
                    <div style=\"display:flex; gap:8px;\">
                        ${r.url?`<a class='btn btn-secondary' href='${r.url}' target='_blank' rel='noopener'>Open</a>`:''}
                        <button class="btn btn-danger" onclick="adminDeleteResource('${r.id}')">Delete</button>
                    </div>
                </div>
            `).join(''); } catch(e){ console.warn('adminLoadResources error', e); }
        }
        function adminClearResourceForm(){ try { document.getElementById('adminResourceForm').reset(); document.getElementById('resourceId').value=''; } catch(_) {} }
        async function adminDeleteResource(id){ try { await ensureFirestoreReady(); await window.FirestoreDataManager.deleteResource(id); await adminLoadResources(); showAdminNotification('Deleted','Resource removed','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to delete resource','error'); } }
        async function adminSaveResource(e){
            e.preventDefault();
            try {
                await ensureFirestoreReady();
                const payload = {
                    title: document.getElementById('resourceTitle').value.trim(),
                    type: document.getElementById('resourceType').value.trim(),
                    url: document.getElementById('resourceUrl').value.trim(),
                    tags: (document.getElementById('resourceTags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
                    version: document.getElementById('resourceVersion').value.trim()
                };
                const id = document.getElementById('resourceId').value.trim();
                if (id) await window.FirestoreDataManager.updateResource(id, payload);
                else await window.FirestoreDataManager.addResource(payload);
                adminClearResourceForm();
                await adminLoadResources();
                showAdminNotification('Saved','Resource saved','success');
            } catch(e){ console.error(e); showAdminNotification('Error','Failed to save resource','error'); }
            return false;
        }

        // Equipment Requests
        async function adminLoadEquipmentRequests(){
            try { 
                console.log('üîÑ Admin loading equipment requests...');
                await ensureFirestoreReady(); 
                const list = await window.FirestoreDataManager.getEquipmentRequests(); 
                console.log('üìã Admin loaded equipment requests:', list);
                const container = document.getElementById('adminEquipmentRequests'); 
                if(!container) {
                    console.warn('‚ö†Ô∏è adminEquipmentRequests container not found');
                    return;
                }
                
                if (!list || list.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                            <i class="fas fa-list" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>No equipment requests found</p>
                            <small>Requests will appear here when users submit them</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = (list||[]).map(req=>{
                    const isApproved = req.status === 'approved';
                    const isDenied = req.status === 'denied';
                    const isConflict = req.status === 'conflict';
                    
                    return `
                        <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 1rem; border: 1px solid rgba(255,178,0,0.2); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight:700; color:#FFB200;">${(req.items||[]).join(', ')}</div>
                                <div style="color:#9ca3af; font-size:.9rem;">
                                    ${req.userEmail||req.requestedBy||''} ‚Ä¢ 
                                    <span class="status-${req.status||'pending'}">${req.status||'pending'}</span>
                                    ${req.neededFrom?`‚Ä¢ From ${req.neededFrom}`:''} 
                                    ${req.neededTo?`‚Ä¢ To ${req.neededTo}`:''}
                                </div>
                                ${req.notes ? `<div style="color:#9ca3af; font-size:0.8rem; margin-top:4px;">${req.notes}</div>` : ''}
                                
                                ${isApproved && req.rentalDetails ? `
                                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px;">
                                        <div style="color: #22c55e; font-weight: 600; font-size: 0.85rem; margin-bottom: 4px;">
                                            <i class="fas fa-check-circle"></i> CHECKED OUT
                                        </div>
                                        <div style="color: #9ca3af; font-size: 0.8rem;">
                                            <div>Checked out: ${new Date(req.rentalDetails.checkedOutAt).toLocaleString()}</div>
                                            <div>Due back: ${new Date(req.rentalDetails.dueBackAt).toLocaleString()}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${isDenied ? `
                                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px;">
                                        <div style="color: #ef4444; font-weight: 600; font-size: 0.85rem;">
                                            <i class="fas fa-times-circle"></i> REQUEST DENIED
                                        </div>
                                        <div style="color: #9ca3af; font-size: 0.8rem;">
                                            Processed: ${req.processedAt ? new Date(req.processedAt).toLocaleString() : 'Unknown'}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${isConflict ? `
                                    <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px;">
                                        <div style="color: #a855f7; font-weight: 600; font-size: 0.85rem;">
                                            <i class="fas fa-exclamation-triangle"></i> CONFLICT
                                        </div>
                                        <div style="color: #9ca3af; font-size: 0.8rem;">
                                            Some items unavailable or not found
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${!isApproved && !isDenied && !isConflict ? `
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-secondary" onclick="adminUpdateRequestStatus('${req.id}','approved')">Approve</button>
                                    <button class="btn btn-danger" onclick="adminUpdateRequestStatus('${req.id}','denied')">Deny</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join(''); 
                console.log('‚úÖ Admin equipment requests rendered successfully');
            } catch(e){ 
                console.error('‚ùå adminLoadEquipmentRequests error', e); 
                const container = document.getElementById('adminEquipmentRequests');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 2rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>Error loading equipment requests</p>
                            <small>${e.message || 'Unknown error'}</small>
                        </div>
                    `;
                }
            }
        }
        async function adminUpdateRequestStatus(id, status){
            try {
                await ensureFirestoreReady();
                if (status === 'approved') {
                    await adminApproveRequest(id);
                } else {
                    await window.FirestoreDataManager.updateEquipmentRequest(id, { 
                        status,
                        processedAt: new Date().toISOString(),
                        processedBy: 'admin'
                    });
                }
                await Promise.all([adminLoadEquipmentRequests(), adminLoadEquipment()]);
                showAdminNotification('Updated',`Request ${status}`,'success');
            } catch(e){ console.error(e); showAdminNotification('Error','Failed to update request','error'); }
        }

        function datesOverlap(aStart, aEnd, bStart, bEnd){
            if (!aStart || !aEnd || !bStart || !bEnd) return true;
            const A1 = new Date(aStart).getTime();
            const A2 = new Date(aEnd).getTime();
            const B1 = new Date(bStart).getTime();
            const B2 = new Date(bEnd).getTime();
            return Math.max(A1,B1) <= Math.min(A2,B2);
        }

        async function adminApproveRequest(requestId){
            console.log('üîÑ Admin approving request:', requestId);
            const [requests, equipment] = await Promise.all([
                window.FirestoreDataManager.getEquipmentRequests(),
                window.FirestoreDataManager.getEquipment()
            ]);
            const req = (requests||[]).find(r => r.id === requestId);
            if (!req) throw new Error('Request not found');
            
            const neededFrom = req.neededFrom || new Date().toISOString().split('T')[0];
            const neededTo = req.neededTo || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // Default 7 days
            const items = Array.isArray(req.items) ? req.items : [];
            const checkedOutIds = [];
            const conflicts = [];

            console.log('üìã Processing approval for items:', items);

            for (const name of items){
                const match = (equipment||[]).find(e =>
                    (e.name||'').toLowerCase() === String(name).toLowerCase() ||
                    (e.name||'').toLowerCase().includes(String(name).toLowerCase())
                );
                if (!match){ 
                    conflicts.push({ item:name, reason:'not_found' }); 
                    continue; 
                }
                
                const hasConflict = (match.status==='checked_out') ||
                    (match.status==='reserved' && match.reservation && datesOverlap(neededFrom, neededTo, match.reservation.neededFrom, match.reservation.neededTo));
                if (hasConflict){
                    conflicts.push({ item:name, reason:'unavailable', equipmentId: match.id, status: match.status });
                    continue;
                }
                
                // Check out the equipment with rental details
                const rentalDetails = {
                    requestId,
                    userEmail: req.userEmail || req.requestedBy || '',
                    userName: req.userName || req.requestedByName || '',
                    checkedOutAt: new Date().toISOString(),
                    dueBackAt: neededTo,
                    neededFrom: neededFrom,
                    neededTo: neededTo,
                    notes: req.notes || `Approved request for ${name}`
                };
                
                await window.FirestoreDataManager.updateEquipment(match.id, { 
                    status: 'checked_out', 
                    rental: rentalDetails,
                    reservation: null // Clear any previous reservation
                });
                checkedOutIds.push(match.id);
                console.log('‚úÖ Checked out equipment:', match.name, 'to:', rentalDetails.userEmail);
            }

            if (conflicts.length){
                await window.FirestoreDataManager.updateEquipmentRequest(requestId, { 
                    status: 'conflict', 
                    conflicts, 
                    checkedOutItems: checkedOutIds,
                    processedAt: new Date().toISOString(),
                    processedBy: 'admin'
                });
                console.log('‚ö†Ô∏è Request has conflicts:', conflicts);
            } else {
                await window.FirestoreDataManager.updateEquipmentRequest(requestId, { 
                    status: 'approved', 
                    checkedOutItems: checkedOutIds,
                    processedAt: new Date().toISOString(),
                    processedBy: 'admin',
                    rentalDetails: {
                        checkedOutAt: new Date().toISOString(),
                        dueBackAt: neededTo,
                        items: items
                    }
                });
                console.log('‚úÖ Request approved and equipment checked out');
            }
        }

        async function adminCheckOutEquipment(equipmentId){
            try { await ensureFirestoreReady(); await window.FirestoreDataManager.updateEquipment(equipmentId, { status:'checked_out', checkedOutAt: new Date().toISOString() }); await adminLoadEquipment(); showAdminNotification('Checked Out','Equipment marked as checked out','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to check out','error'); }
        }
        async function adminCheckInEquipment(equipmentId){
            try { await ensureFirestoreReady(); await window.FirestoreDataManager.updateEquipment(equipmentId, { status:'available', reservation: null, checkedOutAt: null, checkedInAt: new Date().toISOString() }); await adminLoadEquipment(); showAdminNotification('Checked In','Equipment returned and available','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to check in','error'); }
        }

        // Maintenance
        async function adminLoadMaintenance(){
            try { await ensureFirestoreReady(); const list = await window.FirestoreDataManager.getMaintenance(); const container = document.getElementById('adminMaintenanceList'); if(!container) return; container.innerHTML = (list||[]).map(m=>`
                <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div>
                        <div style=\"font-weight:700; color:#FFB200;\">${m.title||'Maintenance'}</div>
                        <div style=\"color:#9ca3af; font-size:.9rem;\">${m.scheduledDate?new Date(m.scheduledDate).toLocaleDateString():''} ‚Ä¢ ${m.status||'scheduled'} ${m.equipmentId?`‚Ä¢ Item ${m.equipmentId}`:''}</div>
                    </div>
                    <div style=\"display:flex; gap:8px;\">
                        <button class=\"btn btn-secondary\" onclick=\"adminUpdateMaintenanceStatus('${m.id}','completed')\">Mark Completed</button>
                        <button class=\"btn btn-danger\" onclick=\"adminDeleteMaintenance('${m.id}')\">Delete</button>
                    </div>
                </div>
            `).join(''); } catch(e){ console.warn('adminLoadMaintenance error', e); }
        }
        async function adminScheduleMaintenance(e){
            e.preventDefault();
            try { await ensureFirestoreReady(); const payload = { title: document.getElementById('maintTitle').value.trim(), scheduledDate: document.getElementById('maintDate').value, equipmentId: document.getElementById('maintEquipmentId').value.trim()||null, assignee: document.getElementById('maintAssignee').value.trim()||null, notes: document.getElementById('maintNotes').value.trim()||'' }; await window.FirestoreDataManager.scheduleMaintenance(payload); adminClearMaintenanceForm(); await adminLoadMaintenance(); showAdminNotification('Scheduled','Maintenance added','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to schedule maintenance','error'); }
            return false;
        }
        async function adminUpdateMaintenanceStatus(id, status){ try { await ensureFirestoreReady(); await window.FirestoreDataManager.updateMaintenance(id, { status }); await adminLoadMaintenance(); showAdminNotification('Updated','Maintenance updated','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to update maintenance','error'); } }
        async function adminDeleteMaintenance(id){ try { await ensureFirestoreReady(); await window.FirestoreDataManager.deleteMaintenance(id); await adminLoadMaintenance(); showAdminNotification('Deleted','Maintenance removed','success'); } catch(e){ console.error(e); showAdminNotification('Error','Failed to delete maintenance','error'); } }
        function adminClearMaintenanceForm(){ try { document.getElementById('adminMaintenanceForm').reset(); } catch(_) {} }

        // ==================== ADMIN MESSAGING SYSTEM FUNCTIONS ====================
        let adminCurrentConversationId = null;
        let adminMessagingService = null;
        let adminSelectedFiles = [];

        // Initialize admin messaging
        async function initializeAdminMessaging() {
            if (!adminMessagingService) {
                // Ensure FirebaseConfig is initialized before constructing service
                try { await window.FirebaseConfig.waitForInit(); } catch(_) {}
                adminMessagingService = new MessagingService();
            }
            try { await adminMessagingService.readyPromise; } catch(_) {}
            // Initial load
            await loadAdminConversations();
            // Real-time updates
            try { adminMessagingService.listenToConversations((list) => {
                try {
                    const conversationsList = document.getElementById('adminConversationsList');
                    if (!conversationsList) return;
                    if (!Array.isArray(list) || list.length === 0) {
                        conversationsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-comments"></i>
                                <h3>No conversations yet</h3>
                                <p>Users will appear here when they start conversations</p>
                            </div>
                        `;
                        return;
                    }

                    conversationsList.innerHTML = list.map(conv => `
                        <div class="conversation-item" data-conversation-id="${conv.id}" onclick="adminSelectConversation('${conv.id}', event)">
                            <div class="conversation-header">
                                <span class="conversation-participant">${getAdminParticipantName(conv)}</span>
                                <span class="conversation-time">${adminMessagingService.formatTimestamp(conv.lastMessageTime)}</span>
                            </div>
                            <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                            <div class="conversation-meta">
                                ${conv.jobId ? `<span class=\"conversation-job\">Job: ${conv.jobId}</span>` : ''}
                                ${conv.unreadCount > 0 ? `<span class=\"unread-badge\">${conv.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('‚ùå Failed to render conversation list (rt):', e);
                }
            }); } catch(e) { console.error('‚ùå Conversations listener setup failed:', e); }
        }

        // Load all conversations for admin
        async function loadAdminConversations() {
            try {
                if (!adminMessagingService) return;
                
                const conversations = await adminMessagingService.loadUserConversations();
                const conversationsList = document.getElementById('adminConversationsList');
                
                if (!conversations || conversations.length === 0) {
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Users will appear here when they start conversations</p>
                        </div>
                    `;
                    return;
                }

                conversationsList.innerHTML = conversations.map(conv => `
                    <div class="conversation-item" data-conversation-id="${conv.id}" onclick="adminSelectConversation('${conv.id}', event)">
                        <div class="conversation-header">
                            <span class="conversation-participant">${getAdminParticipantName(conv)}</span>
                            <span class="conversation-time">${adminMessagingService.formatTimestamp(conv.lastMessageTime)}</span>
                        </div>
                        <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                        <div class="conversation-meta">
                            ${conv.jobId ? `<span class="conversation-job">Job: ${conv.jobId}</span>` : ''}
                            ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Failed to load admin conversations:', error);
            }
        }

        // Get participant name for admin display
        function getAdminParticipantName(conversation) {
            const adminEmails = window.FirebaseConfig?.getAdminUsers() || [];
            const others = (conversation.participants || []).filter(email => !adminEmails.includes(email));
            // Dedicated broadcast thread label
            if (others.length === 1 && String(others[0]).toLowerCase() === 'broadcasts') {
                return 'Creator Broadcast';
            }
            if (others.length === 0) return 'System';
            return others[0].split('@')[0];
        }

        // Select a conversation (admin)
        async function adminSelectConversation(conversationId, ev) {
            try {
                adminCurrentConversationId = conversationId;
                
                // Update UI
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (ev && ev.currentTarget) {
                    ev.currentTarget.classList.add('active');
                } else {
                    const el = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
                    if (el) el.classList.add('active');
                }
                
                // Show chat panel
                document.getElementById('adminChatHeader').style.display = 'flex';
                document.getElementById('adminChatInputContainer').style.display = 'block';
                
                // Load messages
                await adminLoadMessages(conversationId);
                
                // Set up real-time listener
                adminMessagingService.listenToMessages(conversationId, (messages) => {
                    adminDisplayMessages(messages);
                });
                
            } catch (error) {
                console.error('‚ùå Failed to select admin conversation:', error);
            }
        }

        // Load messages for admin
        async function adminLoadMessages(conversationId) {
            try {
                const messages = await adminMessagingService.loadMessages(conversationId);
                adminDisplayMessages(messages);
            } catch (error) {
                console.error('‚ùå Failed to load admin messages:', error);
            }
        }

        // Display messages in admin chat
        function adminDisplayMessages(messages) {
            const chatMessages = document.getElementById('adminChatMessages');
            const currentUserEmail = adminMessagingService?.currentUser?.email;
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="empty-chat">
                        <i class="fas fa-comments"></i>
                        <h3>No messages yet</h3>
                        <p>Start the conversation by sending a message</p>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(message => {
                const isSent = message.senderId === currentUserEmail;
                const timestamp = adminMessagingService.formatTimestamp(message.timestamp);
                
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${isSent ? 'You' : getAdminParticipantName({participants: [message.senderId]})}</span>
                                <span class="message-time">${timestamp}</span>
                            </div>
                            <div class="message-text">${message.content}</div>
                            ${message.attachments && message.attachments.length > 0 ? `
                                <div class="message-attachments">
                                    ${message.attachments.map(attachment => `
                                        <div class="attachment-item">
                                            ${attachment.type && attachment.type.startsWith('image/') ? 
                                                `<img src="${attachment.url}" alt="${attachment.name}" onclick="adminOpenImageModal('${attachment.url}')">` :
                                                `<a href="${attachment.url}" target="_blank">${attachment.name}</a>`
                                            }
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${isSent ? `
                                <div class="message-status">
                                    <span class="status-${message.status || 'sent'}">
                                        ${message.status === 'read' ? '‚úì‚úì' : message.status === 'delivered' ? '‚úì' : '‚óã'}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Start new conversation with user
        async function adminStartNewConversation() {
            // Reveal inline composer instead of prompt
            try {
                // Prefer user picker instead of email input
                await adminShowUserPicker();
            } catch(_) {}
        }

        async function adminSubmitNewMessageInline() {
            try {
                const input = document.getElementById('adminNewMessageEmail');
                const userEmail = (input && input.value || '').trim();
                if (!userEmail) { showAdminNotification('New Message','Enter a valid email','error'); return; }
                if (!adminMessagingService) {
                    adminMessagingService = new MessagingService();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                const conversationId = await adminMessagingService.getOrCreateUserConversation(userEmail);
                await adminSelectConversation(conversationId);
                if (input) { input.value = ''; }
                const box = document.getElementById('adminNewMessageInline');
                if (box) { box.style.display = 'none'; }
                document.getElementById('adminMessageInput').focus();
            } catch (error) {
                console.error('‚ùå Failed to start admin conversation:', error);
                showAdminNotification('New Message','Failed to start conversation','error');
            }
        }

        function adminCancelNewMessageInline(){
            try {
                const box = document.getElementById('adminNewMessageInline');
                const input = document.getElementById('adminNewMessageEmail');
                if (input) input.value = '';
                if (box) box.style.display = 'none';
                adminHideUserPicker();
            } catch(_) {}
        }

        // Send message (admin)
        async function adminSendMessage() {
            try {
                const messageInput = document.getElementById('adminMessageInput');
                const content = messageInput.value.trim();
                
                if (!content && adminSelectedFiles.length === 0) return;
                if (!adminCurrentConversationId) {
                    // Try to create/select a conversation with the first user from users list
                    const users = (window.users && Object.values(window.users)) || [];
                    const firstUser = users.find(u => u && u.profile && u.profile.email);
                    if (firstUser) {
                        const convId = await adminMessagingService.getOrCreateUserConversation(firstUser.profile.email);
                        await adminSelectConversation(convId);
                    } else {
                        alert('No user selected. Click New Message and enter a recipient email.');
                        return;
                    }
                }
                
                // Upload attachments if any
                let attachments = [];
                if (adminSelectedFiles.length > 0) {
                    for (const file of adminSelectedFiles) {
                        const attachment = await adminMessagingService.uploadAttachment(adminCurrentConversationId, 'temp', file);
                        attachments.push(attachment);
                    }
                    adminSelectedFiles = [];
                    adminUpdateAttachmentsPreview();
                }
                
                // Send message
                await adminMessagingService.sendMessage(adminCurrentConversationId, content, attachments);
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
            } catch (error) {
                console.error('‚ùå Failed to send admin message:', error?.message || error, error);
                alert('Failed to send message. Please try again.');
            }
        }

        // Handle message input keydown (admin)
        function adminHandleMessageKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                adminSendMessage();
            }
        }

        // Auto-resize textarea (admin)
        function adminAutoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Toggle attachment menu (admin)
        function adminToggleAttachmentMenu() {
            const menu = document.getElementById('adminAttachmentMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Select file for attachment (admin)
        function adminSelectFile(type) {
            const fileInput = document.getElementById('adminFileInput');
            fileInput.accept = type === 'image' ? 'image/*' : '.pdf,.doc,.docx,.txt';
            fileInput.click();
            
            fileInput.onchange = function(event) {
                const files = Array.from(event.target.files);
                adminSelectedFiles = [...adminSelectedFiles, ...files];
                adminUpdateAttachmentsPreview();
                adminToggleAttachmentMenu();
            };
        }

        // Update attachments preview (admin)
        function adminUpdateAttachmentsPreview() {
            const preview = document.getElementById('adminAttachmentsPreview');
            
            if (adminSelectedFiles.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            preview.innerHTML = adminSelectedFiles.map((file, index) => `
                <div class="attachment-preview">
                    ${file.type.startsWith('image/') ? 
                        `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` :
                        `<i class="fas fa-file"></i>`
                    }
                    <span>${file.name}</span>
                    <button onclick="adminRemoveAttachment(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Remove attachment (admin)
        function adminRemoveAttachment(index) {
            adminSelectedFiles.splice(index, 1);
            adminUpdateAttachmentsPreview();
        }

        // Search messages (admin)
        function adminSearchMessages() {
            const query = prompt('Search messages:');
            if (!query) return;
            (async () => {
                try {
                    // If a conversation is selected, search within it for better signal
                    if (adminCurrentConversationId && adminMessagingService && adminMessagingService.searchMessages) {
                        const results = await adminMessagingService.searchMessages(query, adminCurrentConversationId);
                        if (!results || results.length === 0) { showAdminNotification('Search', 'No matches found', 'info'); return; }
                        // Scroll to the last matching message in the current chat if visible
                        const chat = document.getElementById('adminChatMessages');
                        if (chat && chat.querySelectorAll) {
                            const indices = [];
                            Array.from(chat.querySelectorAll('.message-text')).forEach((el, idx) => {
                                if (String(el.textContent || '').toLowerCase().includes(query.toLowerCase())) indices.push(idx);
                            });
                            if (indices.length) {
                                const lastIdx = indices[indices.length - 1];
                                const target = chat.querySelectorAll('.message')[lastIdx];
                                if (target && target.scrollIntoView) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                        showAdminNotification('Search', `Found ${results.length} message(s)`, 'success');
                    } else {
                        showAdminNotification('Search', 'Open a conversation to search within it', 'info');
                    }
                } catch (e) {
                    console.error('Search failed:', e);
                    showAdminNotification('Search', 'Search failed', 'error');
                }
            })();
        }

        // Toggle chat settings (admin)
        function adminToggleChatSettings() {
            // Implement chat settings
            console.log('Admin toggle chat settings');
        }

        // Simple image modal for admin chat
        function adminOpenImageModal(imageUrl) {
            try {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:12000;display:flex;align-items:center;justify-content:center;padding:16px;';
                overlay.innerHTML = `
                    <div style="position:relative;max-width:90vw;max-height:90vh;">
                        <img src="${imageUrl}" alt="Image" style="max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.5)"/>
                        <button aria-label="Close" style="position:absolute;top:-12px;right:-12px;background:#0b1020;color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:8px 10px;cursor:pointer">‚úï</button>
                    </div>
                `;
                overlay.addEventListener('click', (e) => { if (e.target === overlay || e.target.tagName === 'BUTTON') overlay.remove(); });
                document.body.appendChild(overlay);
            } catch (e) { window.open(imageUrl, '_blank'); }
        }

        // Broadcast message to all users
        function adminBroadcastMessage() {
            // Toggle inline broadcast composer
            adminToggleBroadcast(true);
        }

        function adminToggleBroadcast(forceShow){
            const el = document.getElementById('adminBroadcastInline');
            if (!el) return;
            if (forceShow === true) { el.style.display = 'block'; return; }
            if (forceShow === false) { el.style.display = 'none'; return; }
            el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
        }

        function adminSendBroadcast(){
            const input = document.getElementById('adminBroadcastInput');
            const message = (input && input.value || '').trim();
            if (!message) { showAdminNotification('Broadcast','Enter a message','error'); return; }
            (async () => {
                try {
                    await ensureFirestoreReady();
                    if (!adminMessagingService) {
                        adminMessagingService = new MessagingService();
                        await adminMessagingService.readyPromise;
                    }
                    const usersMap = await window.FirestoreDataManager.getUsers();
                    const users = Object.values(usersMap || {}).filter(u => u && u.profile && u.profile.email);
                    const adminEmails = (window.FirebaseConfig && window.FirebaseConfig.getAdminUsers) ? window.FirebaseConfig.getAdminUsers() : [];
                    const recipients = users.map(u => u.profile.email).filter(e => e && !adminEmails.includes(String(e).toLowerCase()));
                    if (!recipients.length) { showAdminNotification('Broadcast','No recipients found','info'); return; }
                    // ensure dedicated broadcast thread exists and is selected
                    let broadcastsConvId = null;
                    try { broadcastsConvId = await adminMessagingService.createConversation(['broadcasts']); } catch(_) {}
                    if (broadcastsConvId) { try { await adminSelectConversation(broadcastsConvId); } catch(_) {} }
                    let sentCount = 0;
                    for (const email of recipients) {
                        try {
                            const convId = await adminMessagingService.getOrCreateUserConversation(email);
                            await adminMessagingService.sendMessage(convId, message, []);
                            sentCount++;
                        } catch (e) {
                            console.warn('Broadcast send failed for', email, e);
                        }
                    }
                    // Log to broadcast thread
                    if (broadcastsConvId) { try { await adminMessagingService.sendMessage(broadcastsConvId, `[Broadcast] ${message}`, []); } catch(_) {} }
                    if (input) input.value = '';
                    adminToggleBroadcast(false);
                    showAdminNotification('Broadcast', `Message sent to ${sentCount} users`, 'success');
                } catch (e) {
                    console.error('Broadcast failed:', e);
                    showAdminNotification('Broadcast', 'Failed to send broadcast', 'error');
                }
            })();
        }

        // ==================== USER PICKER (AI THEME) ====================
        async function adminShowUserPicker(){
            try {
                const picker = document.getElementById('adminUserPicker');
                const listEl = document.getElementById('adminUserPickerList');
                if (!picker || !listEl) return;
                picker.classList.remove('hidden');
                // Load users if list is empty
                if (!listEl.dataset.loaded) {
                    await ensureFirestoreReady();
                    const usersMap = await window.FirestoreDataManager.getUsers();
                    const users = Object.values(usersMap || {}).filter(u => u && u.profile && u.profile.email);
                    // Render
                    listEl.innerHTML = users.map(u => {
                        const name = (u.profile.fullName || u.profile.name || u.profile.firstName || u.profile.email.split('@')[0] || 'User');
                        const email = u.profile.email;
                        const initials = String(name).trim().slice(0,2).toUpperCase();
                        return `
                            <div class="up-item" data-email="${email}" onclick="adminPickUser('${email.replace(/'/g,"&#39;")}')">
                                <div class="up-avatar">${initials}</div>
                                <div class="up-meta">
                                    <span class="name">${name}</span>
                                    <span class="email">${email}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    listEl.dataset.loaded = '1';
                }
                const search = document.getElementById('adminUserPickerSearch');
                if (search) { search.value = ''; search.focus(); }
            } catch(e) { console.warn('user picker error', e); }
        }

        function adminHideUserPicker(){
            const picker = document.getElementById('adminUserPicker');
            if (picker) picker.classList.add('hidden');
        }

        function adminFilterUserPicker(){
            const q = (document.getElementById('adminUserPickerSearch')?.value || '').toLowerCase();
            const items = Array.from(document.querySelectorAll('#adminUserPickerList .up-item'));
            items.forEach(it => {
                const email = (it.getAttribute('data-email')||'').toLowerCase();
                const name = (it.querySelector('.name')?.textContent || '').toLowerCase();
                it.style.display = (!q || name.includes(q) || email.includes(q)) ? 'flex' : 'none';
            });
        }

        async function adminPickUser(email){
            try {
                if (!email) return;
                if (!adminMessagingService) {
                    adminMessagingService = new MessagingService();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                const conversationId = await adminMessagingService.getOrCreateUserConversation(email);
                adminHideUserPicker();
                await adminSelectConversation(conversationId);
                document.getElementById('adminMessageInput').focus();
            } catch (e) {
                console.error('pick user error', e);
                showAdminNotification('New Message','Could not open conversation','error');
            }
        }

        // Initialize admin messaging when dashboard loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize messaging after a short delay to ensure Firebase is ready
            setTimeout(() => {
                initializeAdminMessaging();
            }, 2000);
        });

        // Expose to window
        window.adminLoadEquipment = adminLoadEquipment;
        window.adminSaveEquipment = adminSaveEquipment;
        window.adminEditEquipment = adminEditEquipment;
        window.adminDeleteEquipment = adminDeleteEquipment;
        window.adminLoadResources = adminLoadResources;
        window.adminSaveResource = adminSaveResource;
        window.adminDeleteResource = adminDeleteResource;
        window.adminLoadEquipmentRequests = adminLoadEquipmentRequests;
        window.adminUpdateRequestStatus = adminUpdateRequestStatus;
        window.adminLoadMaintenance = adminLoadMaintenance;
        window.adminScheduleMaintenance = adminScheduleMaintenance;
        window.adminUpdateMaintenanceStatus = adminUpdateMaintenanceStatus;
        window.adminDeleteMaintenance = adminDeleteMaintenance;
        
        // Admin messaging functions
        window.adminStartNewConversation = adminStartNewConversation;
        window.adminSelectConversation = adminSelectConversation;
        window.adminSendMessage = adminSendMessage;
        window.adminHandleMessageKeydown = adminHandleMessageKeydown;
        window.adminAutoResizeTextarea = adminAutoResizeTextarea;
        window.adminToggleAttachmentMenu = adminToggleAttachmentMenu;
        window.adminSelectFile = adminSelectFile;
        window.adminRemoveAttachment = adminRemoveAttachment;
        window.adminSearchMessages = adminSearchMessages;
        window.adminToggleChatSettings = adminToggleChatSettings;
        window.adminBroadcastMessage = adminBroadcastMessage;
    </script>
</body>
</html> 