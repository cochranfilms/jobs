<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Portal | Cochran Films</title>
    <!-- Favicon -->
    <link rel="icon" href="https://static.wixstatic.com/media/aeef42_570164eee75f4394a4fc1cf9c62ceae0~mv2.png" type="image/png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" referrerpolicy="no-referrer">
    

    
    <!-- Performance Data Script -->

    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration and Data Manager -->
    <script defer src="firebase-config.js"></script>
    <script defer src="firestore-data-manager.js"></script>
    <script defer src="firestore-integration.js"></script>
    <script defer src="/storage-utils.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Secure Bank Storage -->
    <script defer src="secure-bank-storage.js"></script>
    <script defer src="bank-details-modal.js"></script>
    
    <!-- Messaging Service -->
    <script defer src="messaging-service.js"></script>
    
    <script>
        // Environment detection and API configuration
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isProduction = window.location.hostname === 'collaborate.cochranfilms.com';
        const API_BASE = isLocalhost ? 'http://localhost:8000' : '';
        
        console.log('ðŸ”§ Environment detected:', {
            hostname: window.location.hostname,
            isLocalhost: isLocalhost,
            isProduction: isProduction,
            apiBase: API_BASE
        });

        let currentUser = null;
        let users = [];
        let uploadedContracts = [];
        let projectStatus = [];
        let jobsData = [];
        let performanceReviews = {};
        // Auth state management flags
        let isManualSignOut = false;
        let authNullDebounceTimer = null;
        // 30-minute session grace across tabs (localStorage)
        const USER_PORTAL_SESSION_KEY = 'userPortalSessionExpiry';
        const USER_PORTAL_EMAIL_KEY = 'userPortalAuthEmail';
        function setPortalSession(minutes = 30) {
            try {
                localStorage.setItem(USER_PORTAL_SESSION_KEY, String(Date.now() + minutes * 60000));
                if (auth && auth.currentUser && auth.currentUser.email) {
                    localStorage.setItem(USER_PORTAL_EMAIL_KEY, auth.currentUser.email);
                }
            } catch(_) {}
        }
        function getPortalSessionExpiry() {
            try { return Number(localStorage.getItem(USER_PORTAL_SESSION_KEY) || '0'); } catch(_) { return 0; }
        }
        function refreshPortalSessionIfAuthenticated() {
            if (auth && auth.currentUser && auth.currentUser.email) setPortalSession(30);
        }
        window.addEventListener('focus', refreshPortalSessionIfAuthenticated);
        // In-flight guards to prevent duplicate loads
        let usersLoadInFlight = null;
        let contractsLoadInFlight = null;

        // Firebase Configuration - Now handled by firebase-config.js
        let auth = null;
        let firestore = null;
        // Allow safe auto-provision after Firebase auth so new accounts can enter the portal
        window.ALLOW_PORTAL_AUTOPROVISION = true;
        
        // Initialize Firebase when config is ready
        async function initializeFirebase() {
            try {
                if (window.FirebaseConfig) {
                    // Reuse the default app/session to avoid auth fragmentation across tabs/pages
                    await window.FirebaseConfig.waitForInit();
                    auth = window.FirebaseConfig.auth;
                    firestore = window.FirebaseConfig.getFirestore();
                    // Proactively initialize FirestoreDataManager so data loads are ready post-login
                    try { if (window.FirestoreDataManager) { await window.FirestoreDataManager.init(); } } catch(_) {}
                    console.log('âœ… Firebase initialized in user portal');
                    
                    // Set up auth state observer after Firebase is ready
                    setupAuthStateObserver();
                    // Load Community Hub stats from Firestore
                    try { await loadCommunityHubStats(); } catch(_) {}
                }
            } catch (error) {
                console.error('âŒ Firebase initialization failed:', error);
                // Fallback to basic auth setup
                setupAuthStateObserver();
            }
        }
        
        // Initialize Firebase on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure both views start visible; AI theme handles flicker visually
            try {
                const loginScreen = document.getElementById('loginScreen');
                const userPortal = document.getElementById('userPortal');
                if (loginScreen) loginScreen.style.display = 'grid';
                if (userPortal) userPortal.style.display = 'none';
            } catch(_) {}
            initializeFirebase();
        });

        // Utility: show quick toast
        function toast(msg, type='info'){
            try{ const el=document.createElement('div'); el.style.cssText=`position:fixed;right:16px;bottom:16px;z-index:9999;padding:10px 14px;border-radius:10px;color:#fff;background:${type==='error'?'#ef4444':type==='success'?'#22c55e':'#3b82f6'};box-shadow:0 6px 24px rgba(0,0,0,.35);font-weight:600`; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000);}catch(_){}}

        // Inline banner helper for login screen
        function showLoginBanner(message, variant){
            try{
                const host = document.getElementById('loginError');
                if (!host) return;
                host.textContent = message || '';
                host.style.display = message ? 'block' : 'none';
                if (variant === 'success') host.style.color = '#22c55e';
                else if (variant === 'error') host.style.color = '#ef4444';
                else host.style.color = '#fff';
            }catch(_){ }
        }

        // Setup authentication state observer
        function setupAuthStateObserver() {
            // mark first auth event to coordinate UI flips
            window._USER_PORTAL_AUTH_SEEN = false;
            window._USER_PORTAL_LAST_USER_EMAIL = '';
            auth.onAuthStateChanged(function(user) {
                if (!window._USER_PORTAL_AUTH_SEEN) { window._USER_PORTAL_AUTH_SEEN = true; }
                // Clear any pending debounce when we receive a user
                if (authNullDebounceTimer) {
                    clearTimeout(authNullDebounceTimer);
                    authNullDebounceTimer = null;
                }

                if (user && user.email) {
                    isManualSignOut = false; // reset manual sign-out flag on valid auth
                    console.log('âœ… User authenticated:', user.email);
                    try { window._USER_PORTAL_LAST_USER_EMAIL = user.email || ''; } catch(_) {}
                    // User is signed in, check if they exist in our system
                    checkUserInSystem(user.email);
                    // Persist lightweight session snapshot to mitigate reload kicks (both stores)
                    try { sessionStorage.setItem('userPortalAuthEmail', user.email); } catch(_) {}
                    try { localStorage.setItem('userPortalAuthEmail', user.email); } catch(_) {}
                    // Start/refresh 30-minute cross-tab session
                    setPortalSession(30);
                    try { loadCommunityHubStats(); } catch(_) {}
                    // Show a subtle banner if email is verified
                    try { if (user.emailVerified === true) { showLoginBanner('Email verified. Welcome back!', 'success'); setTimeout(()=>showLoginBanner('', 'info'), 2000); } } catch(_){ }
                    return;
                }

                // Handle null user with debounce to avoid bounce during init/network blips
                authNullDebounceTimer = setTimeout(() => {
                    const stillNoUser = !(auth && auth.currentUser && auth.currentUser.email);
                    if (stillNoUser) {
                        const cachedEmailLS = (function(){ try { return localStorage.getItem('userPortalAuthEmail') || ''; } catch(_) { return ''; } })();
                        const cachedEmailSS = (function(){ try { return sessionStorage.getItem('userPortalAuthEmail') || ''; } catch(_) { return ''; } })();
                        const hasSessionSnapshot = !!(cachedEmailLS || cachedEmailSS);
                        const portalVisible = (document.getElementById('userPortal')?.style.display === 'block');
                        const notExpired = Date.now() < getPortalSessionExpiry();
                        if (isManualSignOut) {
                            console.log('â„¹ï¸ Manual sign-out: showing login');
                            showLoginScreen();
                            return;
                        } else if (!window.FirebaseConfig || !window.FirebaseConfig.isInitialized) {
                            // Do not flip UI while Firebase is still initializing
                            return;
                        } else if (notExpired || hasSessionSnapshot || currentUser || portalVisible || window._USER_PORTAL_LAST_USER_EMAIL) {
                            // Hold UI steady; try to recover with cached email shortly
                            setTimeout(() => { try { checkUserInSystem(cachedEmailLS || cachedEmailSS || window._USER_PORTAL_LAST_USER_EMAIL || ''); } catch(_) {} }, 2000);
                            return;
                        } else {
                            // As a last resort, only show login if we have absolutely no recent session/email
                            const lastErr = sessionStorage.getItem('lastSignInError');
                            console.log('âŒ No active session detected; showing login');
                            showLoginScreen();
                            if (lastErr) {
                                showLoginBanner('If you requested a reset, check your email for the link.', 'info');
                                sessionStorage.removeItem('lastSignInError');
                            }
                        }
                    }
                }, 6000);
            });
        }

        // Community Hub: read counts from Firestore
        async function loadCommunityHubStats() {
            try {
                // Ensure manager is ready
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }
                if (!window.FirestoreDataManager || !window.FirestoreDataManager.isAvailable()) return;

                const [usersObj, messages, showcases] = await Promise.all([
                    window.FirestoreDataManager.getUsers().catch(() => ({})),
                    window.FirestoreDataManager.getMessages().catch(() => ([])),
                    window.FirestoreDataManager.getShowcases().catch(() => ([]))
                ]);

                const teamMembers = Object.keys(usersObj || {}).length;
                const tmEl = document.getElementById('teamMemberCount');
                if (tmEl) tmEl.textContent = teamMembers ? `${teamMembers} ${teamMembers === 1 ? 'Member' : 'Members'}` : '0 Members';

                const activeProjects = Array.isArray(showcases) ? showcases.length : 0;
                const apEl = document.getElementById('activeProjectCount');
                if (apEl) apEl.textContent = activeProjects ? `${activeProjects} ${activeProjects === 1 ? 'Project' : 'Projects'}` : '0 Projects';

                // Messages + replies count
                const msgCount = Array.isArray(messages) ? messages.length : 0;
                const umEl = document.getElementById('unreadMessageCount');
                if (umEl) umEl.textContent = `${msgCount} ${msgCount === 1 ? 'Message' : 'Messages'}`;
            } catch (e) {
                console.warn('âš ï¸ Community Hub stats load failed:', e?.message || e);
                try {
                    const tmEl = document.getElementById('teamMemberCount'); if (tmEl) tmEl.textContent = 'â€”';
                    const apEl = document.getElementById('activeProjectCount'); if (apEl) apEl.textContent = 'â€”';
                } catch(_) {}
            }
        }

        // Update card in realtime on Firestore changes
        window.addEventListener('firestore:dataChange', function(e){
            try {
                const c = (e && e.detail && e.detail.collection) || '';
                if (c === 'users' || c === 'messages' || c === 'showcases') {
                    loadCommunityHubStats();
                }
            } catch(_) {}
        });

        // Load performance reviews from Firestore only (no JSON fallback)
        async function loadPerformanceReviews() {
            try {
                performanceReviews = {};
                // Ensure Firestore is ready
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const fsUsersObj = await window.FirestoreDataManager.getUsers();
                    for (const userData of Object.values(fsUsersObj || {})) {
                        const email = userData?.profile?.email;
                        const review = userData?.performance;
                        if (email && review) {
                            performanceReviews[email] = review;
                        }
                    }
                    if (!sessionStorage.getItem('performanceReviewsLogged')) {
                        console.log('âœ… Performance reviews loaded from Firestore:', Object.keys(performanceReviews).length, 'reviews');
                        sessionStorage.setItem('performanceReviewsLogged', 'true');
                    }
                } else {
                    console.warn('âš ï¸ Firestore unavailable; performance reviews disabled');
                }
            } catch (error) {
                console.error('âŒ Error loading performance reviews (Firestore):', error);
                performanceReviews = {};
            }
        }

        // Get user's performance review
        function getUserPerformanceReview(userEmail) {
            // Validate input
            if (!userEmail) {
                console.warn('âš ï¸ No user email provided');
                return null;
            }
            
            // Try exact match first
            let review = performanceReviews[userEmail] || null;
            
            // If no exact match, try case-insensitive match
            if (!review && userEmail) {
                const availableEmails = Object.keys(performanceReviews);
                const matchingEmail = availableEmails.find(email => 
                    email.toLowerCase() === userEmail.toLowerCase()
                );
                if (matchingEmail) {
                    review = performanceReviews[matchingEmail];
                }
            }
            
            // If still no match, log for debugging (but only once per session per email)
            if (!review && !sessionStorage.getItem(`performanceReviewNotFound_${userEmail}`)) {
                console.warn('âš ï¸ No performance review found for email:', userEmail);
                sessionStorage.setItem(`performanceReviewNotFound_${userEmail}`, 'true');
            }
            
            return review;
        }

        // ==================== PHASE 3: ADVANCED NOTIFICATION SYSTEM ====================
        
        // Enhanced notification system with Phase 3 features
        let notificationPermission = 'default';
        let notificationSettings = {
            pushEnabled: false,
            soundEnabled: true,
            categories: {
                payment: true,
                contract: true,
                job: true,
                system: true,
                performance: true
            },
            quietHours: {
                enabled: false,
                start: '22:00',
                end: '08:00'
            }
        };

        // Initialize advanced notification system
        async function initializeAdvancedNotificationSystem() {
            console.log('ðŸ”” Initializing Phase 3 Advanced Notification System...');
            
            // Load notification settings
            await loadNotificationSettings();
            
            // Request notification permission
            await requestNotificationPermission();
            
            // Initialize push notification service worker
            await initializePushNotifications();
            
            // Start enhanced notification polling
            startEnhancedNotificationPolling();
            
            console.log('âœ… Phase 3 Advanced Notification System initialized');
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                try {
                    const permission = await Notification.requestPermission();
                    notificationPermission = permission;
                    notificationSettings.pushEnabled = permission === 'granted';
                    console.log('ðŸ”” Notification permission:', permission);
                } catch (error) {
                    console.error('âŒ Error requesting notification permission:', error);
                }
            }
        }

        // Initialize push notifications with service worker
        async function initializePushNotifications() {
            if ('serviceWorker' in navigator && notificationSettings.pushEnabled) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw-notifications.js');
                    console.log('ðŸ”” Service Worker registered for notifications');
                } catch (error) {
                    console.log('âš ï¸ Service Worker registration failed, using fallback notifications');
                }
            }
        }

        // Enhanced notification display with rich content
        function showNotification(message, type = 'info', options = {}) {
            const {
                title = 'Cochran Films',
                duration = 5000,
                category = 'system',
                actions = [],
                persistent = false,
                sound = true,
                priority = 'normal'
            } = options;

            // Check if notification should be shown based on settings
            if (!shouldShowNotification(category)) {
                console.log(`ðŸ”” Notification filtered by category: ${category}`);
                return;
            }

            // Check quiet hours
            if (isQuietHours() && !options.urgent) {
                console.log('ðŸ”” Notification suppressed during quiet hours');
                return;
            }

            // Show browser notification if permission granted
            if (notificationSettings.pushEnabled && !document.hasFocus()) {
                showBrowserNotification(title, message, type, actions);
            }

            // Show in-app notification
            showInAppNotification(message, type, { title, duration, actions, persistent, priority });

            // Play sound if enabled
            if (sound && notificationSettings.soundEnabled) {
                playNotificationSound(type);
            }

            // Add to notification history
            addNotificationToHistory(title, message, type, category, options);
        }

        // Show browser push notification
        function showBrowserNotification(title, message, type, actions = []) {
            if (notificationPermission === 'granted') {
                const notification = new Notification(title, {
                    body: message,
                    icon: '/Favicon.png',
                    badge: '/Favicon.png',
                    tag: `cochran-${type}`,
                    requireInteraction: false,
                    actions: actions.map(action => ({
                        action: action.id,
                        title: action.title,
                        icon: action.icon || '/Favicon.png'
                    }))
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };

                // Auto-close after 5 seconds
                setTimeout(() => notification.close(), 5000);
            }
        }

        // Show in-app notification with rich content
        function showInAppNotification(message, type = 'info', options = {}) {
            const {
                title = 'Cochran Films',
                duration = 5000,
                actions = [],
                persistent = false,
                priority = 'normal'
            } = options;

            const colors = getNotificationColors(type);
            const icon = getNotificationIcon(type);

            const toast = document.createElement('div');
            toast.className = `notification-toast notification-${type} notification-${priority}`;
            toast.style.cssText = `
                position: fixed; right: 20px; bottom: 20px;
                background: ${colors.background}; color: white;
                padding: 16px; border-radius: 12px; margin-top: 8px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.35);
                z-index: 10000; font-family: Inter, system-ui, -apple-system, sans-serif;
                max-width: 400px; line-height: 1.4; font-size: 14px;
                transform: translateY(20px); opacity: 0; transition: all .3s ease;
                border-left: 4px solid ${colors.border};
                backdrop-filter: blur(10px);
            `;

            // Create notification content
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="font-size: 18px; margin-top: 2px;">${icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 15px;">${title}</div>
                        <div style="opacity: 0.9;">${message}</div>
                        ${actions.length > 0 ? `
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                ${actions.map(action => `
                                    <button onclick="${action.handler}" 
                                            style="background: rgba(255,255,255,0.2); border: none; color: white; 
                                                   padding: 6px 12px; border-radius: 6px; font-size: 12px; 
                                                   cursor: pointer; transition: background 0.2s;">
                                        ${action.icon ? `<i class="${action.icon}" style="margin-right: 4px;"></i>` : ''}
                                        ${action.title}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: white; opacity: 0.7; 
                                   cursor: pointer; padding: 4px; font-size: 16px; line-height: 1;">
                        Ã—
                    </button>
                </div>
            `;

            // Container
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column-reverse; gap: 8px; z-index: 9999;';
                document.body.appendChild(container);
            }
            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            });

            // Auto remove (unless persistent)
            if (!persistent) {
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                    setTimeout(() => toast.remove(), 300);
            }, duration);
            }
        }

        // Check if notification should be shown based on category settings
        function shouldShowNotification(category) {
            return notificationSettings.categories[category] !== false;
        }

        // Check if current time is within quiet hours
        function isQuietHours() {
            if (!notificationSettings.quietHours.enabled) return false;
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const startTime = timeToMinutes(notificationSettings.quietHours.start);
            const endTime = timeToMinutes(notificationSettings.quietHours.end);
            
            if (startTime <= endTime) {
                return currentTime >= startTime && currentTime <= endTime;
            } else {
                // Quiet hours span midnight
                return currentTime >= startTime || currentTime <= endTime;
            }
        }

        // Convert time string to minutes
        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Play notification sound
        function playNotificationSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Different frequencies for different types
                const frequencies = {
                    success: 800,
                    error: 400,
                    warning: 600,
                    info: 500,
                    payment: 700,
                    contract: 750,
                    job: 650
                };
                
                oscillator.frequency.setValueAtTime(frequencies[type] || 500, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('ðŸ”” Audio notification not available');
            }
        }

        // Add notification to history for analytics
        function addNotificationToHistory(title, message, type, category, options) {
            const notification = {
                id: Date.now() + Math.random(),
                title,
                message,
                type,
                category,
                timestamp: new Date().toISOString(),
                read: false,
                priority: options.priority || 'normal',
                actions: options.actions || [],
                persistent: options.persistent || false
            };
            
            // Add to notifications array
            notifications.unshift(notification);
            
            // Keep only last 100 notifications
            if (notifications.length > 100) {
                notifications = notifications.slice(0, 100);
            }
            
            // Save to localStorage
            saveNotifications();
            
            // Update UI
            updateNotificationBadge();
            updateNotificationList();
        }

        // Load notification settings
        async function loadNotificationSettings() {
            try {
                const saved = localStorage.getItem('notificationSettings');
                if (saved) {
                    notificationSettings = { ...notificationSettings, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.error('âŒ Error loading notification settings:', error);
            }
        }

        // Save notification settings
        async function saveNotificationSettings() {
            try {
                localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            } catch (error) {
                console.error('âŒ Error saving notification settings:', error);
            }
        }

        // Start enhanced notification polling
        function startEnhancedNotificationPolling() {
            // Poll every 30 seconds for new notifications
            setInterval(async () => {
                if (currentUser) {
                    await checkForNewNotifications();
                }
            }, 30000);
        }

        // Check for new notifications from server
        async function checkForNewNotifications() {
            try {
                // This would typically check with a server endpoint
                // For now, we'll use the existing smart notification triggers
                await triggerSmartNotifications();
            } catch (error) {
                console.error('âŒ Error checking for new notifications:', error);
            }
        }

        // ==================== NOTIFICATION SETTINGS FUNCTIONS ====================

        // Toggle notification settings panel
        function toggleNotificationSettings() {
            const panel = document.getElementById('notificationSettingsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadNotificationSettingsUI();
            } else {
                panel.style.display = 'none';
            }
        }

        // Load notification settings into UI
        function loadNotificationSettingsUI() {
            // Push notifications
            document.getElementById('pushNotifications').checked = notificationSettings.pushEnabled;
            
            // Sound notifications
            document.getElementById('soundNotifications').checked = notificationSettings.soundEnabled;
            
            // Quiet hours
            document.getElementById('quietHours').checked = notificationSettings.quietHours.enabled;
            document.getElementById('quietStart').value = notificationSettings.quietHours.start;
            document.getElementById('quietEnd').value = notificationSettings.quietHours.end;
            
            // Show/hide quiet hours controls
            const controls = document.getElementById('quietHoursControls');
            controls.style.display = notificationSettings.quietHours.enabled ? 'block' : 'none';
            
            // Categories
            document.getElementById('catPayment').checked = notificationSettings.categories.payment;
            document.getElementById('catContract').checked = notificationSettings.categories.contract;
            document.getElementById('catJob').checked = notificationSettings.categories.job;
            document.getElementById('catPerformance').checked = notificationSettings.categories.performance;
            document.getElementById('catSystem').checked = notificationSettings.categories.system;
        }

        // Toggle push notifications
        async function togglePushNotifications() {
            const enabled = document.getElementById('pushNotifications').checked;
            notificationSettings.pushEnabled = enabled;
            
            if (enabled) {
                await requestNotificationPermission();
            }
            
            await saveNotificationSettings();
        }

        // Toggle sound notifications
        async function toggleSoundNotifications() {
            notificationSettings.soundEnabled = document.getElementById('soundNotifications').checked;
            await saveNotificationSettings();
        }

        // Toggle quiet hours
        function toggleQuietHours() {
            const enabled = document.getElementById('quietHours').checked;
            notificationSettings.quietHours.enabled = enabled;
            
            const controls = document.getElementById('quietHoursControls');
            controls.style.display = enabled ? 'block' : 'none';
        }

        // Update quiet hours
        async function updateQuietHours() {
            notificationSettings.quietHours.start = document.getElementById('quietStart').value;
            notificationSettings.quietHours.end = document.getElementById('quietEnd').value;
            await saveNotificationSettings();
        }

        // Update notification categories
        async function updateNotificationCategories() {
            notificationSettings.categories.payment = document.getElementById('catPayment').checked;
            notificationSettings.categories.contract = document.getElementById('catContract').checked;
            notificationSettings.categories.job = document.getElementById('catJob').checked;
            notificationSettings.categories.performance = document.getElementById('catPerformance').checked;
            notificationSettings.categories.system = document.getElementById('catSystem').checked;
            await saveNotificationSettings();
        }

        // Save notification settings
        async function saveNotificationSettings() {
            try {
                localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
                showNotification('Notification settings saved!', 'success', {
                    category: 'system',
                    duration: 3000
                });
            } catch (error) {
                console.error('âŒ Error saving notification settings:', error);
            }
        }

        // Reset notification settings
        async function resetNotificationSettings() {
            if (confirm('Reset all notification settings to default?')) {
                notificationSettings = {
                    pushEnabled: false,
                    soundEnabled: true,
                    categories: {
                        payment: true,
                        contract: true,
                        job: true,
                        system: true,
                        performance: true
                    },
                    quietHours: {
                        enabled: false,
                        start: '22:00',
                        end: '08:00'
                    }
                };
                
                await saveNotificationSettings();
                loadNotificationSettingsUI();
                
                showNotification('Notification settings reset to default!', 'info', {
                    category: 'system',
                    duration: 3000
                });
            }
        }
        
        function getNotificationIcon(type) {
            const iconMap = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            return iconMap[type] || 'â„¹ï¸';
        }
        
        function getNotificationColors(type) {
            const colors = {
                success: { background: '#22c55e', border: '#16a34a' },
                error: { background: '#ef4444', border: '#dc2626' },
                warning: { background: '#f59e0b', border: '#d97706' },
                info: { background: '#3b82f6', border: '#2563eb' }
            };
            return colors[type] || colors.info;
        }
        // User-specific notification system for user actions
        function showUserNotification(title, message, type = 'info', data = {}) {
            showNotification(message, type);
            
            // Add to notification system
            addNotification(
                title,
                message,
                type,
                {
                    ...data,
                    priority: 'normal',
                    userSpecific: true
                }
            );
        }

        // ==================== SOPHISTICATED NOTIFICATION SYSTEM ====================
        
        // Centralized notification system with real-time updates
        let notifications = [];
        let notificationUpdateInterval;
        
        // Initialize notification system (user-scoped; no global polling)
        async function initializeNotificationSystem() {
            console.log('ðŸ”” Initializing user-specific notification system...');
            await loadNotifications();
            startUserNotificationSystem();
            updateNotificationBadge();
            updateNotificationList();
            
            // Initialize Phase 3 advanced notification system
            await initializeAdvancedNotificationSystem();
        }
        
        // User-specific notification system (no JSON file monitoring)
        function startUserNotificationSystem() {
            console.log('ðŸ”” Starting user-specific notification system...');
            // Users only get notifications for their own actions and status changes
            // No automatic JSON file monitoring for users
        }
        
        // Load notifications (user-local only)
        async function loadNotifications() {
            try {
                const key = currentUser && currentUser.email ? `notifications:${currentUser.email.toLowerCase()}` : 'notifications:anonymous';
                notifications = JSON.parse(localStorage.getItem(key) || '[]');
                console.log('âœ… Loaded user-local notifications');
            } catch (error) {
                console.error('âŒ Error loading notifications:', error);
                const key = currentUser && currentUser.email ? `notifications:${currentUser.email.toLowerCase()}` : 'notifications:anonymous';
                notifications = JSON.parse(localStorage.getItem(key) || '[]');
            }
        }
        
        // Save notifications (localStorage placeholder)
        async function saveNotifications() {
            try {
                const key = currentUser && currentUser.email ? `notifications:${currentUser.email.toLowerCase()}` : 'notifications:anonymous';
                localStorage.setItem(key, JSON.stringify(notifications));
                console.log('âœ… Notifications saved locally (user-scoped)');
            } catch (error) {
                console.error('âŒ Error saving notifications:', error);
                const key = currentUser && currentUser.email ? `notifications:${currentUser.email.toLowerCase()}` : 'notifications:anonymous';
                localStorage.setItem(key, JSON.stringify(notifications));
            }
        }
        
        // Add notification with rich data
        async function addNotification(title, message, type = 'info', data = {}) {
            const notification = {
                id: Math.floor(Date.now() + Math.random() * 1000),
                title: title,
                message: message,
                type: type,
                data: data,
                timestamp: new Date().toISOString(),
                read: false,
                actionRequired: data.actionRequired || false,
                priority: data.priority || 'normal'
            };
            
            notifications.unshift(notification);
            await saveNotifications();
            updateNotificationBadge();
            updateNotificationList();
            
            console.log('ðŸ”” Added notification:', notification);
            return notification.id;
        }
        
        // Smart notification triggers for user portal
        async function triggerSmartNotifications() {
            console.log('ðŸ” Checking for smart notification triggers...');
            
            if (!currentUser) return;
            
            await checkPaymentMethodNotifications();
            await checkContractStatusNotifications();
            await checkJobStatusNotifications();
        }
        
        // Check for payment method notifications
        async function checkPaymentMethodNotifications() {
            try {
                if (!currentUser || !currentUser.paymentMethod) return;
                
                // Check if we've already shown this notification for this user
                const notificationKey = `payment_method_${currentUser.email}_${currentUser.paymentMethod}`;
                const alreadyShown = sessionStorage.getItem(notificationKey);
                
                if (!alreadyShown) {
                    const existingNotification = notifications.find(n =>
                        n.data.notificationKey === notificationKey
                    );
                    
                    if (!existingNotification) {
                        await addNotification(
                            'Payment Method Updated',
                            `Your payment method has been set to ${currentUser.paymentMethod.toUpperCase()}. You'll receive payments via this method.`,
                            'payment',
                            {
                                notificationKey: notificationKey,
                                actionRequired: false,
                                priority: 'normal'
                            }
                        );
                    }
                    
                    // Mark this notification as shown
                    sessionStorage.setItem(notificationKey, 'true');
                }
            } catch (error) {
                console.error('âŒ Error checking payment method notifications:', error);
            }
        }
        
        // Check for contract status notifications
        async function checkContractStatusNotifications() {
            try {
                if (!currentUser) return;
                
                const contract = getUserContractStatus(currentUser.email);
                if (contract && contract.contractStatus === 'signed') {
                    // Check if we've already shown this notification for this user
                    const notificationKey = `contract_signed_${currentUser.email}_${contract.contractId}`;
                    const alreadyShown = sessionStorage.getItem(notificationKey);
                    
                    if (!alreadyShown) {
                        const existingNotification = notifications.find(n =>
                            n.data.notificationKey === notificationKey
                        );
                        
                        if (!existingNotification) {
                            showUserNotification(
                                'Contract Signed',
                                `ðŸ“„ Your contract ${contract.contractId} has been signed and is ready for download!`,
                                'success',
                                {
                                    notificationKey: notificationKey,
                                    actionRequired: false,
                                    contractId: contract.contractId,
                                    priority: 'high'
                                }
                            );
                        }
                        
                        // Mark this notification as shown
                        sessionStorage.setItem(notificationKey, 'true');
                    }
                }
            } catch (error) {
                console.error('âŒ Error checking contract status notifications:', error);
            }
        }
        
        // Check for job status notifications
        async function checkJobStatusNotifications() {
            try {
                if (!currentUser || !currentUser.jobs) return;
                
                for (const [jobId, job] of Object.entries(currentUser.jobs)) {
                    if (job.projectStatus === 'completed') {
                        // Check if we've already shown this notification for this job
                        const notificationKey = `job_completed_${currentUser.email}_${jobId}`;
                        const alreadyShown = sessionStorage.getItem(notificationKey);
                        
                        if (!alreadyShown) {
                            const existingNotification = notifications.find(n =>
                                n.data.notificationKey === notificationKey
                            );
                            
                            if (!existingNotification) {
                                showUserNotification(
                                    'Job Completed',
                                    `ðŸŽ‰ Your job "${job.title || job.role}" has been marked as completed!`,
                                    'success',
                                    {
                                        notificationKey: notificationKey,
                                        actionRequired: false,
                                        jobId: jobId,
                                        jobTitle: job.title || job.role
                                    }
                                );
                            }
                            
                            // Mark this notification as shown
                            sessionStorage.setItem(notificationKey, 'true');
                        }
                    }
                }
            } catch (error) {
                console.error('âŒ Error checking job status notifications:', error);
            }
        }
        
        // Disable global polling to avoid duplicate/cross-user notifications in the user portal
        function startNotificationPolling() { /* no-op: user portal uses local user-scoped notifications only */ }
        
        // Stop notification polling (kept for API parity; no-op)
        function stopNotificationPolling() { notificationUpdateInterval = null; }
        
        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        // Update notification list
        function updateNotificationList() {
            const list = document.getElementById('notificationList');
            if (!list) return;
            
            const unreadNotifications = notifications.filter(n => !n.read);
            
            if (unreadNotifications.length === 0) {
                list.innerHTML = `
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = unreadNotifications.map(notification => `
                <div class="notification-item" data-id="${notification.id}">
                    <div class="notification-icon">
                        <i class="fas fa-${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                    </div>
                    <div class="notification-actions">
                        <button class="notification-action" data-id="${notification.id}" data-action="mark-read">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="notification-action" data-id="${notification.id}" data-action="remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Delegate notification action clicks (mark-read/remove) so items disappear immediately
        (function bindNotificationActionDelegation(){
            if (window._UP_NOTIF_DELEGATE_BOUND) return;
            document.addEventListener('click', (evt) => {
                const btn = evt.target.closest && evt.target.closest('.notification-action');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');
                if (id && action) {
                    evt.preventDefault();
                    handleNotificationAction(id, action);
                }
            });
            window._UP_NOTIF_DELEGATE_BOUND = true;
        })();
        
        // Handle notification click
        async function handleNotificationClick(notificationId) {
            const notification = notifications.find(n => n.id == notificationId);
            if (!notification) return;
            
            // Mark as read
            notification.read = true;
            await saveNotifications();
            updateNotificationBadge();
            updateNotificationList();
            
            // Handle specific notification actions
            if (notification.data.actionRequired) {
                if (notification.type === 'contract') {
                    // Open contract download
                    downloadUserContract();
                }
            }
        }
        
        // Handle notification action
        async function handleNotificationAction(notificationId, action) {
            if (action === 'mark-read') {
                const notification = notifications.find(n => n.id == notificationId);
                if (notification) {
                    notification.read = true;
                    await saveNotifications();
                    updateNotificationBadge();
                    updateNotificationList();
                }
            } else if (action === 'remove') {
                await removeNotification(notificationId);
            }
        }
        
        // Remove notification
        async function removeNotification(notificationId) {
            notifications = notifications.filter(n => n.id != notificationId);
            await saveNotifications();
            updateNotificationBadge();
            updateNotificationList();
        }
        
        // Mark notification as read
        async function markAsRead(notificationId) {
            const notification = notifications.find(n => n.id == notificationId);
            if (notification) {
                notification.read = true;
                await saveNotifications();
                updateNotificationBadge();
                updateNotificationList();
            }
        }
        
        // Clear all notifications
        async function clearAllNotifications() {
            notifications = [];
            await saveNotifications();
            updateNotificationBadge();
            updateNotificationList();
        }
        
        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (!dropdown) return;
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                updateNotificationList();
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Get notification icon for list
        function getNotificationIcon(type) {
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle',
                contract: 'file-contract',
                payment: 'credit-card',
                performance: 'star',
                job: 'briefcase',
                freelancer: 'user'
            };
            return iconMap[type] || 'info-circle';
        }
        
        // Format notification time
        function formatNotificationTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                const minutes = Math.floor(diff / 60000);
                return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else if (diff < 86400000) { // Less than 1 day
                const hours = Math.floor(diff / 3600000);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        // Notify user of JSON updates
        function notifyUserJSONUpdate(fileName, action, details = '') {
            const message = `JSON file "${fileName}" has been ${action}. ${details}`;
            showNotification(message, 'info');
            
            // Also add to notification system
            addNotification(
                'Data Updated',
                message,
                'info',
                {
                    fileName: fileName,
                    action: action,
                    details: details
                }
            );
        }

        // ==================== MODAL MANAGEMENT ====================
        
        // Universal modal close function
        function closeModal(button) {
            const modal = button.closest('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }
        // Load freelancer data (Firestore only - JSON/API removed)
        async function loadUsersData() {
            try {
                console.log('ðŸ”„ Loading users data...');
                if (usersLoadInFlight) { return usersLoadInFlight; }
                // Ensure Firestore is ready first
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    usersLoadInFlight = (async () => {
                    const fsUsersObj = await window.FirestoreDataManager.getUsers();
                    users = Object.entries(fsUsersObj || {}).map(([docId, user]) => ({
                        name: (user && user.profile && user.profile.name) ? user.profile.name : docId,
                        email: user.profile?.email,
                        password: null,
                        approvedDate: user.profile?.approvedDate,
                        contractUrl: user.contract?.contractUrl || 'contract.html',
                        // CONTRACT STATUS FIELDS - CRITICAL!
                        contractStatus: user.contract?.contractStatus || 'pending',
                        contractSignedDate: user.contract?.contractSignedDate,
                        contractUploadedDate: user.contract?.contractUploadedDate,
                        contractId: user.contract?.contractId,
                        // PAYMENT FIELDS - CRITICAL!
                        paymentMethod: user.paymentMethod || null,
                        paymentStatus: user.paymentStatus || 'pending',
                        // Handle both old single job format and new multiple jobs format
                        jobs: user.jobs && Object.keys(user.jobs).length ? user.jobs : {
                            'legacy-job': {
                                id: 'legacy-job',
                                role: user.profile?.role,
                                location: user.profile?.location,
                                // Prefer approvedDate or application.eventDate as start if present
                                projectStart: user.profile?.approvedDate || user.application?.eventDate || user.profile?.projectStart || '',
                                rate: user.profile?.rate,
                                status: 'upcoming',
                                description: `${user.profile?.role} position`
                            }
                        },
                        primaryJob: user.primaryJob || Object.keys(user.jobs || {})[0] || 'legacy-job'
                    ,
                        // Surface avatar for persistence across refresh
                        profilePicture: (user.profilePicture !== undefined && user.profilePicture !== null)
                            ? user.profilePicture
                            : (user.profile && user.profile.profilePicture) ? user.profile.profilePicture : null
                    }));
                    console.log('âœ… Users data loaded from Firestore:', users.length, 'users');
                    console.log('ðŸ” Available users with jobs and contract status:', users.map(u => ({ 
                        name: u.name, 
                        email: u.email, 
                        jobCount: Object.keys(u.jobs || {}).length,
                        contractStatus: u.contractStatus,
                        contractId: u.contractId
                    })));
                    await mergeUsersDataWithUploadedContracts();
                    })();
                    await usersLoadInFlight;
                } else {
                    // Keep existing users model if any to avoid wiping UI while Firestore warms up
                    console.warn('âš ï¸ Firestore unavailable; no JSON fallback (disabled). Preserving current users snapshot.');
                    return users;
                }
            } catch (error) {
                console.error('âŒ Error loading users data:', error);
                // Preserve current users on error to avoid jarring UI resets
                return users;
            } finally {
                usersLoadInFlight = null;
            }
        }

        // Merge users data with uploaded contracts to get the most up-to-date contract information
        async function mergeUsersDataWithUploadedContracts() {
            try {
                console.log('ðŸ”„ Merging users data with uploaded contracts...');
                
                // Load uploaded contracts if not already loaded
                if (uploadedContracts.length === 0) {
                    await loadUploadedContracts();
                }
                
                // Update users data with contract information from uploaded-contracts.json
                users.forEach(user => {
                    const userEmailLower = (user && user.email ? String(user.email).toLowerCase() : '');
                    if (!userEmailLower) {
                        return; // skip users without valid email
                    }

                    // Find ALL contracts for this user (support multiple email field shapes)
                    const userContracts = uploadedContracts.filter(contract => {
                        const contractEmailLower = (contract && (contract.freelancerEmail || contract.userEmail)
                            ? String(contract.freelancerEmail || contract.userEmail).toLowerCase()
                            : '');
                        return contractEmailLower && contractEmailLower === userEmailLower;
                    });
                    
                    if (userContracts.length > 0) {
                        // Sort by upload date to get the most recent contract
                        userContracts.sort((a, b) => {
                            const dateA = new Date(a.uploadDate || a.signedDate || 0);
                            const dateB = new Date(b.uploadDate || b.signedDate || 0);
                            return dateB - dateA; // Most recent first
                        });
                        
                        const mostRecentContract = userContracts[0];
                        console.log(`âœ… Found ${userContracts.length} uploaded contract(s) for ${user.name}:`, userContracts.map(c => c.contractId));
                        console.log(`âœ… Using most recent contract: ${mostRecentContract.contractId}`);
                        
                        // Update user with contract data from uploaded-contracts.json
                        user.contractStatus = mostRecentContract.status || 'uploaded';
                        user.contractId = mostRecentContract.contractId;
                        // Preserve original contractSignedDate from users.json if available
                        user.contractSignedDate = user.contractSignedDate || mostRecentContract.signedDate || mostRecentContract.uploadDate;
                        user.contractUploadedDate = mostRecentContract.uploadDate;
                        
                        // Update job information if available
                        // Best-effort job detail sync (supports object map shape)
                        if (user.jobs && typeof user.jobs === 'object') {
                            const firstJobKey = Object.keys(user.jobs)[0];
                            const firstJob = firstJobKey ? user.jobs[firstJobKey] : null;
                            if (firstJob) {
                                if (mostRecentContract.role) firstJob.role = mostRecentContract.role;
                                if (mostRecentContract.rate) firstJob.rate = mostRecentContract.rate;
                                if (mostRecentContract.location) firstJob.location = mostRecentContract.location;
                            }
                        }
                        
                        console.log(`âœ… Updated ${user.name} with most recent contract ID: ${mostRecentContract.contractId}`);
                    } else {
                        console.log(`âš ï¸ No uploaded contract found for ${user.name} (${user.email})`);
                    }
                });
                
                console.log('âœ… Users data merged with uploaded contracts');
            } catch (error) {
                console.error('âŒ Error merging freelancer data with uploaded contracts:', error);
            }
        }

        // Validate that the current authenticated user still exists in the loaded users list
        async function validateUserSession(userCandidate) {
            try {
                if (!userCandidate || !userCandidate.email) return false;
                const target = String(userCandidate.email).toLowerCase();
                // Ensure we have the latest users snapshot
                if (!Array.isArray(users) || users.length === 0) {
                    await loadUsersData();
                }
                return Array.isArray(users) && users.some(u => (u.email ? String(u.email).toLowerCase() : '') === target);
            } catch (_) {
                // If uncertain, do not force sign-out
                return true;
            }
        }

        // Load uploaded contracts (Firestore only)
        async function loadUploadedContracts() {
            try {
                console.log('ðŸ”„ Loading uploaded contracts from Firestore (contracts collection)...');
                if (contractsLoadInFlight) { return contractsLoadInFlight; }
                // Ensure Firestore is ready
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    contractsLoadInFlight = window.FirestoreDataManager.getContracts();
                    uploadedContracts = await contractsLoadInFlight;
                    contractsLoadInFlight = null;
                    console.log('âœ… Uploaded contracts loaded from Firestore:', uploadedContracts.length, 'contracts');
                } else {
                    // Preserve existing contracts list if any to avoid drops
                    console.warn('âš ï¸ Firestore unavailable; leaving existing contracts list intact');
                    return uploadedContracts;
                }
            } catch (error) {
                console.error('âŒ Error loading contracts from Firestore:', error);
                // Preserve current list on error
                return uploadedContracts;
            } finally {
                contractsLoadInFlight = null;
            }
        }



        // Load jobs data from JSON file
        async function loadJobsData() {
            try {
                // Use Firestore as source of truth via window.FirestoreDataManager
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    jobsData = await window.FirestoreDataManager.getJobListings();
                    console.log('âœ… Jobs data loaded from Firestore:', jobsData.length, 'jobs');
                } else {
                    // Firestore unavailable; do not fall back to legacy JSON
                    console.warn('âš ï¸ Firestore unavailable; preserving existing jobsData');
                    return jobsData;
                }
            } catch (error) {
                console.error('âŒ Error loading jobs data:', error);
                // Preserve current jobs on error
                return jobsData;
            }
        }

        // Fix timezone issues with dates
        function fixTimezone(dateString) {
            if (!dateString) return null;
            
            try {
                // Handle different date formats
                let date;
                
                // Handle "8/5/2025, 10:37:09 PM" format
                if (dateString.includes(',') && dateString.includes('PM') || dateString.includes('AM')) {
                    date = new Date(dateString);
                } else if (dateString.includes('T')) {
                    // ISO format
                    date = new Date(dateString);
                } else if (dateString.includes('/')) {
                    // MM/DD/YYYY format
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        date = new Date(parts[2], parts[0] - 1, parts[1]);
                    } else {
                        // Try parsing as is
                        date = new Date(dateString);
                    }
                } else {
                    // YYYY-MM-DD format
                    date = new Date(dateString + 'T00:00:00');
                }
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.warn('âš ï¸ Invalid date:', dateString);
                    return null;
                }
                
                // Adjust for timezone (assuming EST/EDT)
                const timezoneOffset = date.getTimezoneOffset();
                date.setMinutes(date.getMinutes() + timezoneOffset);
                
                return date.toISOString().split('T')[0];
            } catch (error) {
                console.warn('âš ï¸ Could not parse date:', dateString, error);
                return null;
            }
        }

        // Helper function to format contract signed date
        function formatContractSignedDate(dateString) {
            if (!dateString) return 'Processing...';
            
            try {
                // Handle the specific format "8/6/2025, 5:23:17 AM"
                let date;
                if (dateString.includes(',')) {
                    // Parse the specific format
                    const parts = dateString.split(',');
                    const datePart = parts[0].trim();
                    const timePart = parts[1].trim();
                    date = new Date(`${datePart} ${timePart}`);
                } else {
                    date = new Date(dateString);
                }
                
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString();
                } else {
                    console.warn('âš ï¸ Invalid contract signed date:', dateString);
                    return dateString; // Display as is
                }
            } catch (error) {
                console.warn('âš ï¸ Error formatting contract signed date:', error);
                return dateString; // Display as is
            }
        }
        // ==================== PDF GENERATION FUNCTIONS ====================
        // Generate professional PDF contract content - from contract.html
        function generateContractPDF(contractData) {
            try {
                console.log('ðŸ“„ Starting PDF generation for contract:', contractData.contractId);
                
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const doc = new jsPDF();
                
                // ==================== HEADER ====================
                
                // Professional header with gold background
                doc.setFillColor(255, 178, 0);
                doc.rect(0, 0, 210, 25, 'F');
                
                // Company name and title in header
                doc.setFontSize(20);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS', 105, 12, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FREELANCE CONTRACT AGREEMENT', 105, 20, { align: 'center' });
                
                // ==================== CONTRACT METADATA ====================
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`Contract ID: ${contractData.contractId}`, 20, 35);
                doc.text(`Effective Date: ${contractData.effectiveDate}`, 20, 40);
                
                // ==================== CONTRACTOR INFORMATION ====================
                
                // Professional section header with background
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 50, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFORMATION', 105, 56, { align: 'center' });
                
                // Two separate info boxes for better organization
                // Left box - Contractor Info
                doc.setFillColor(248, 249, 250);
                doc.rect(20, 65, 80, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, 65, 80, 25, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR INFO', 25, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Name: ${contractData.freelancerName || 'Not specified'}`, 25, 78);
                doc.text(`Role: ${contractData.role || 'Not specified'}`, 25, 82);
                doc.text(`Location: ${contractData.location || 'Not specified'}`, 25, 86);
                
                // Right box - Project Details
                doc.setFillColor(248, 249, 250);
                doc.rect(110, 65, 80, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(110, 65, 80, 25, 'S');
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('PROJECT DETAILS', 115, 72);
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Email: ${contractData.freelancerEmail || 'Not specified'}`, 115, 78);
                doc.text(`Start: ${contractData.projectStart || 'Not specified'}`, 115, 82);
                doc.text(`Rate: ${contractData.rate || 'Not specified'}`, 115, 86);
                
                // ==================== CONTRACT TERMS ====================
                
                // Professional section header with background
                doc.setFillColor(255, 178, 0);
                doc.rect(20, 100, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT TERMS & CONDITIONS', 105, 106, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                // Professional compact terms list
                const compactTerms = [
                    'INDEPENDENT CONTRACTOR: Not an employee of\nCochran Films.',
                    'SERVICES: Provide professional services as specified.',
                    'COMPENSATION: Payment within 24 hours of completion.',
                    'STANDARDS: All work must meet Cochran Films quality.',
                    'ATTIRE: Professional attire (all black) required.',
                    'PUNCTUALITY: Arrive 15 minutes before start time.',
                    'DOCUMENTATION: Bring valid ID and signed contract.',
                    'EQUIPMENT: Use provided Cochran Films equipment.',
                    'CONDUCT: Maintain professional demeanor at all times.',
                    'SAFETY: Follow all safety protocols provided.',
                    'CONFIDENTIALITY: Respect project confidentiality.',
                    'BTS CONTENT: May freely take and share behind-the-scenes.',
                    'TAX OBLIGATIONS: Contractor responsible for personal taxes.',
                    'TRANSPORTATION: Contractor responsible for own transport.'
                ];
                
                // Proper spacing to prevent text overlap
                let currentYPos = 120;
                const lineHeight = 10;
                
                // Process each term with TWO-COLUMN layout to save vertical space
                compactTerms.forEach((term, index) => {
                    // Split into two columns: left column (0-6) and right column (7-13)
                    const isLeftColumn = index < 7;
                    const columnIndex = isLeftColumn ? index : index - 7;
                    const xPos = isLeftColumn ? 20 : 110; // Left column at x=20, right column at x=110
                    const fixedYPos = 120 + (columnIndex * 8);
                    
                    // Render each term with two-column layout and text wrapping
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    // Handle multi-line terms (like term #1)
                    if (term.includes('\n')) {
                        const lines = term.split('\n');
                        lines.forEach((line, lineIndex) => {
                            doc.text(line, xPos, fixedYPos + (lineIndex * 4));
                        });
                    } else {
                        doc.text(term, xPos, fixedYPos);
                    }
                });
                
                // Calculate signature position AFTER all terms are rendered (two-column layout)
                const maxColumnHeight = Math.ceil(compactTerms.length / 2) * 8; // Height of tallest column
                const lastTermY = 120 + maxColumnHeight;
                const signatureY = lastTermY + 20; // Add 20px spacing after last term
                
                // ==================== SIGNATURES ====================
                
                // Signature header with professional styling
                doc.setFillColor(255, 178, 0);
                doc.rect(20, signatureY - 5, 170, 8, 'F');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACT SIGNATURES', 105, signatureY + 2, { align: 'center' });
                
                // Company signature (pre-signed) - Professional styling
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('COCHRAN FILMS (COMPANY)', 20, signatureY + 15);
                
                // Company signature box with professional border
                doc.setFillColor(248, 249, 250);
                doc.rect(20, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Authorized Signature:', 25, signatureY + 26);
                
                // CURSIVE SIGNATURE FOR CODY COCHRAN
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic'); // Use italic for cursive effect
                doc.text('Cody Cochran', 25, signatureY + 32);
                
                // Add signature line for authenticity
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(25, signatureY + 34, 85, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Title: Founder & CEO', 25, signatureY + 38);
                doc.text('Date: ' + contractData.effectiveDate, 25, signatureY + 42);
                
                // Contractor signature - Professional styling
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('CONTRACTOR SIGNATURE', 105, signatureY + 15);
                
                // Contractor signature box with professional border
                doc.setFillColor(248, 249, 250);
                doc.rect(105, signatureY + 20, 75, 25, 'F');
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.5);
                doc.rect(105, signatureY + 20, 75, 25, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                doc.text('Contractor:', 115, signatureY + 26);
                
                // CURSIVE SIGNATURE FOR CONTRACTOR
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'italic'); // Use italic for cursive effect
                doc.text(contractData.freelancerName || 'Contractor Name', 115, signatureY + 32);
                
                // Add signature line for authenticity
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.line(115, signatureY + 34, 175, signatureY + 34);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Signature: ' + (contractData.signature || 'Digital Signature'), 115, signatureY + 38);
                doc.text('Date: ' + (contractData.signatureDate || contractData.effectiveDate), 115, signatureY + 42);
                
                // ==================== PROFESSIONAL LEGAL FOOTER ====================
                
                // Footer - positioned with proper spacing to fit in container
                const footerY = 260; // MOVED DOWN from 240 to 260 to avoid overlapping signature boxes
                
                doc.setFillColor(248, 249, 250);
                doc.rect(20, footerY - 5, 170, 20, 'F'); // Increased height to 20mm
                doc.setDrawColor(255, 178, 0);
                doc.setLineWidth(0.3);
                doc.rect(20, footerY - 5, 170, 20, 'S');
                
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text('This contract was digitally signed and is legally binding under Georgia law.', 105, footerY + 3, { align: 'center' });
                doc.text('Generated by Cochran Films Contract Portal â€¢ ' + new Date().toLocaleDateString(), 105, footerY + 8, { align: 'center' });
                doc.text('Contract ID: ' + contractData.contractId, 105, footerY + 13, { align: 'center' });
                
                return doc;
            } catch (error) {
                console.error('âŒ Error generating PDF:', error);
                throw error;
            }
        }

        // Get user's contract status from centralized system
        function getUserContractStatus(userEmail, jobId = null) {
            console.log('ðŸ” Getting contract status for user:', currentUser?.name);
            console.log('ðŸ“„ Current user structure:', currentUser);
            
            // Check if current user has contract data in centralized system
            if (!currentUser) {
                console.log('âŒ No current user found');
                return null;
            }
            
            // The contract data is flattened on currentUser (not nested)
            // Based on the data loading process, contract data is flattened like this:
            // contractStatus, contractSignedDate, contractUploadedDate, contractId
            if (currentUser.contractStatus) {
                const userContract = {
                    contractStatus: currentUser.contractStatus,
                    contractSignedDate: currentUser.contractSignedDate,
                    contractId: currentUser.contractId || currentUser.name,
                    contractUploadedDate: currentUser.contractUploadedDate
                };
                console.log('âœ… Found flattened contract data on currentUser:', userContract);
                
                // Return contract data in the expected format
                return {
                    status: userContract.contractStatus,
                    contractId: userContract.contractId,
                    signedDate: userContract.contractSignedDate,
                    fileName: `${currentUser.name}.pdf`,
                    notes: null,
                    githubUrl: null,
                    role: currentUser.profile?.role || getSelectedJob()?.role,
                    rate: currentUser.profile?.rate || getSelectedJob()?.rate,
                    location: currentUser.profile?.location || getSelectedJob()?.location,
                    jobId: jobId || 'legacy-job',
                    jobRole: getSelectedJob()?.role || currentUser.profile?.role,
                    jobDescription: currentUser.description || currentUser.profile?.description
                };
            } else {
                if (!sessionStorage.getItem('noContractDataLogged')) {
                    console.log('âŒ No contract data found for user in centralized system');
                    sessionStorage.setItem('noContractDataLogged', 'true');
                }
                return null;
            }
        }



        // Handle login via Firebase authentication
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            try {
                // Ensure Firebase is fully initialized and auth is available
                if ((!auth || !auth.signInWithEmailAndPassword) && window.FirebaseConfig) {
                    try {
                        await window.FirebaseConfig.waitForInit();
                        auth = window.FirebaseConfig.auth;
                        firestore = window.FirebaseConfig.getFirestore();
                    } catch (e) {
                        console.warn('Firebase waitForInit failed in handleLogin:', e?.message || e);
                    }
                }
                // Last-resort fallback to global firebase if available
                if ((!auth || !auth.signInWithEmailAndPassword) && window.firebase && typeof window.firebase.auth === 'function') {
                    try { auth = window.firebase.auth(); } catch(_) {}
                }

                if (!auth || !auth.signInWithEmailAndPassword) {
                    throw new Error('auth/not-ready');
                }

                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const fbUser = userCredential && userCredential.user;
                if (!fbUser || !fbUser.email) {
                    throw new Error('auth/user-not-found');
                }
                // After Firebase auth, ensure the user exists in our centralized system
                await checkUserInSystem(fbUser.email);
            } catch (error) {
                console.error('Login error:', error);
                let code = error && (error.code || error.message) || '';
                let errorMessage = 'Login failed. Please try again.';
                switch (code) {
                    case 'auth/not-ready':
                        errorMessage = 'Initializing secure sign-in. Please wait a moment and try again.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'User not found. Please check your email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage = 'Invalid email or password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email format.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Please wait a moment and try again.';
                        break;
                    default:
                        // Fallback for prior custom errors
                        if (code === 'User not found') errorMessage = 'User not found. Please check your email.';
                        if (code === 'Invalid credentials') errorMessage = 'Invalid email or password. Please try again.';
                        break;
                }
                // Persist a hint flag so the UI can suggest password reset on next load
                try { sessionStorage.setItem('lastSignInError', code || 'error'); } catch(_) {}
                const errorElement = document.getElementById('loginError');
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Quick user validation without heavy data loading
        async function validateUserQuickly(email, password) {
            // Deprecated: JSON-based quick validation removed. Always use Firebase Auth.
            return null;
        }

        // Check or provision authenticated user in Firestore, then enter portal
        async function checkUserInSystem(email) {
            console.log('ðŸ” Checking user in system:', email);
            if (!email || !email.trim()) {
                console.warn('âš ï¸ Invalid email provided');
                return;
            }

            // Always pull latest users from Firestore
            await loadUsersData();

            // Find user by email (case-insensitive). Support both flat email and profile.email
            let user = users.find(u => {
                const e1 = (u && typeof u.email === 'string') ? u.email.toLowerCase() : '';
                const e2 = (u && u.profile && typeof u.profile.email === 'string') ? u.profile.email.toLowerCase() : '';
                const target = email.toLowerCase();
                return e1 === target || e2 === target;
            });

            // If not found, optionally auto-provision
            if (!user && window.ALLOW_PORTAL_AUTOPROVISION === true && window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                try {
                    const nameFromEmail = email.split('@')[0].replace(/[._-]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    // Always resolve to an existing doc id by email across all shapes
                    let userDocId = email;
                    try {
                        const existingId = await window.FirestoreDataManager.findUserIdByEmail(email);
                        if (existingId) {
                            userDocId = existingId;
                        }
                    } catch(_) {}
                    await window.FirestoreDataManager.setUser(userDocId, {
                        profile: { email, name: nameFromEmail },
                        contract: {},
                        jobs: {},
                        primaryJob: '',
                        paymentMethod: '',
                        paymentStatus: 'pending'
                    });
                    // Reload to include the newly created user
                    await loadUsersData();
                    user = users.find(u => {
                        const e1 = (u && typeof u.email === 'string') ? u.email.toLowerCase() : '';
                        const e2 = (u && u.profile && typeof u.profile.email === 'string') ? u.profile.email.toLowerCase() : '';
                        const target = email.toLowerCase();
                        return e1 === target || e2 === target;
                    });
                    // If still not found due to eventual consistency, wait briefly and try once more
                    if (!user) {
                        await new Promise(r => setTimeout(r, 600));
                        await loadUsersData();
                        user = users.find(u => {
                            const e1 = (u && typeof u.email === 'string') ? u.email.toLowerCase() : '';
                            const e2 = (u && u.profile && typeof u.profile.email === 'string') ? u.profile.email.toLowerCase() : '';
                            const target = email.toLowerCase();
                            return e1 === target || e2 === target;
                        });
                    }
                    console.log('âœ… Auto-provisioned user in Firestore:', userDocId);
                } catch (e) {
                    console.warn('âš ï¸ Auto-provision failed (continuing if purely auth-based access is acceptable):', e?.message || e);
                }
            }

            if (user) {
                console.log('âœ… User found in system:', user.name || email);
                // First-login backfill: if name missing, try to persist from recent signature cache
                try {
                    const hasName = !!(user && user.profile && user.profile.name) || !!user.name;
                    const cachedName = (sessionStorage.getItem('recentSignatureName') || '').trim();
                    const cachedEmail = (sessionStorage.getItem('recentSignatureEmail') || '').toLowerCase();
                    if (!hasName && cachedName && cachedEmail && cachedEmail === String(email).toLowerCase() && window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                        const userId = await window.FirestoreDataManager.findUserIdByEmail(email);
                        if (userId) {
                            await window.FirestoreDataManager.setUser(userId, { profile: { name: cachedName, email: email } });
                            console.log('âœ… Backfilled profile.name from recent signature cache');
                            try { sessionStorage.removeItem('recentSignatureName'); sessionStorage.removeItem('recentSignatureEmail'); } catch(_) {}
                            // refresh
                            await loadUsersData();
                            user = users.find(u => (u.email||'').toLowerCase() === String(email).toLowerCase()) || user;
                        }
                    }
                } catch (bfErr) { console.warn('âš ï¸ Name backfill skipped:', bfErr?.message || bfErr); }
                currentUser = user;
                sessionStorage.setItem('userPortalAuthenticated', JSON.stringify(user));
                console.log('ðŸ” About to call showUserPortal()');
                showUserPortal();
                console.log('ðŸ” showUserPortal() called');
            } else {
                // As a last resort, allow viewing portal with auth-only session if design permits
                if (auth && auth.currentUser && auth.currentUser.email && auth.currentUser.email.toLowerCase() === email.toLowerCase()) {
                    console.warn('âš ï¸ No Firestore profile yet; proceeding with auth-only session');
                    currentUser = { name: email.split('@')[0], email, jobs: {}, primaryJob: '', paymentStatus: 'pending' };
                    sessionStorage.setItem('userPortalAuthenticated', JSON.stringify(currentUser));
                    showUserPortal();
                    return;
                }
                console.warn('âš ï¸ User not found in system and cannot provision:', email);
                console.log('ðŸ“‹ Available users:', users.map(u => ({ name: u.name, email: u.email })));
                if (document.getElementById('userPortal').style.display !== 'block') {
                    showNotification('Account not found. Please contact support.', 'error');
                }
            }
        }

        // Minimal auth gate to show login or portal
        async function checkAuth() {
            try {
                // Avoid UI flips until Firebase is ready; rely on auth observer to drive UI
                if (!window.FirebaseConfig || !window.FirebaseConfig.isInitialized) {
                    return;
                }
                // Prefer Firebase auth state if available
                if (typeof auth !== 'undefined' && auth && auth.currentUser && auth.currentUser.email) {
                    await checkUserInSystem(auth.currentUser.email);
                    return;
                }
                // Fallback to cached email snapshot if auth takes time to hydrate
                const cachedEmail = sessionStorage.getItem('userPortalAuthEmail');
                if (cachedEmail) {
                    await checkUserInSystem(cachedEmail);
                    return;
                }
                // Fallback to session cache payload
                const session = sessionStorage.getItem('userPortalAuthenticated');
                if (session) {
                    const user = JSON.parse(session);
                    if (user && user.email) {
                        await checkUserInSystem(user.email);
                        return;
                    }
                }
                // Default to login screen
                showLoginScreen();
            } catch (e) {
                console.warn('checkAuth error:', e?.message || e);
                showLoginScreen();
            }
        }
        // Show user portal
        async function showUserPortal() {
            const loginScreen = document.getElementById('loginScreen');
            const userPortal = document.getElementById('userPortal');
            
            if (loginScreen && userPortal) {
                console.log('ðŸ” Hiding login screen and showing user portal');
                // Show portal when authenticated
                loginScreen.style.display = 'none';
                userPortal.style.display = 'block';
                console.log('âœ… Display properties updated');
            } else {
                console.error('âŒ Elements not found:', { loginScreen: !!loginScreen, userPortal: !!userPortal });
            }
            
            // Ensure Firestore is ready, then load
            try { if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) { await window.FirestoreDataManager.init(); } } catch(_) {}
            await loadUserData();
            
            // Initialize creative features after portal is shown
            setTimeout(() => {
                initializeCreativeFeatures();
            }, 500);
        }

        // Show login screen
        function showLoginScreen() {
            const loginScreen = document.getElementById('loginScreen');
            const userPortal = document.getElementById('userPortal');
            
            if (loginScreen && userPortal) {
                console.log('ðŸ” Showing login screen and hiding user portal');
                // Show login when unauthenticated
                loginScreen.style.display = 'grid';
                userPortal.style.display = 'none';
                // Ensure AI card is visible
                const card = loginScreen.querySelector('.ai-login-card');
                if (card) {
                    card.style.visibility = 'visible';
                    card.style.opacity = '1';
                    card.style.margin = '0 auto';
                }
                const submitBtn = loginScreen.querySelector('button[type="submit"]');
                if (submitBtn) { submitBtn.textContent = 'Sign In'; submitBtn.disabled = false; }
                console.log('âœ… Display properties updated');
            } else {
                console.error('âŒ Elements not found:', { loginScreen: !!loginScreen, userPortal: !!userPortal });
            }
            
            currentUser = null;
            sessionStorage.removeItem('userPortalAuthenticated');
        }

        // Logout with Firebase (robust with fallbacks and full session cleanup)
        async function logout() {
            try {
                isManualSignOut = true;
                // Attempt sign-out via centralized config first, then fall back
                try {
                    if (window.FirebaseConfig && typeof window.FirebaseConfig.signOut === 'function') {
                        await window.FirebaseConfig.signOut();
                    } else if (auth && typeof auth.signOut === 'function') {
                        await auth.signOut();
                    } else if (window.firebase && typeof window.firebase.auth === 'function') {
                        await window.firebase.auth().signOut();
                    }
                } catch (signOutErr) {
                    console.warn('âš ï¸ Sign out fallback path encountered:', signOutErr?.message || signOutErr);
                }

                // Clear session and cached snapshots across stores
                try { sessionStorage.removeItem('userPortalAuthenticated'); } catch(_) {}
                try { sessionStorage.removeItem(USER_PORTAL_EMAIL_KEY); } catch(_) {}
                try { localStorage.removeItem(USER_PORTAL_EMAIL_KEY); } catch(_) {}
                try { localStorage.removeItem(USER_PORTAL_SESSION_KEY); } catch(_) {}

                currentUser = null;
                showLoginScreen();
                const err = document.getElementById('loginError');
                if (err) { err.textContent = ''; err.style.display = 'none'; err.className = 'ai-error'; }
                showNotification('Successfully signed out!', 'info');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error signing out. Please try again.', 'error');
            }
        }
        // Load user-specific data
        async function loadUserData() {
            // Snapshot the email to avoid race conditions during async awaits
            const emailSnapshot = (currentUser && currentUser.email) ? currentUser.email : null;
            if (!emailSnapshot) return;

            // Clear cache to ensure fresh data for payment updates
            sessionStorage.removeItem('cachedUsersData');
            sessionStorage.removeItem('cachedUsersDataTimestamp');
            
            // Refresh data from server to get latest updates
            await loadUsersData();
            await loadPerformanceReviews(); // Ensure performance reviews are loaded
            
            // If user signed out or switched during awaits, abort safely
            if (!currentUser || !currentUser.email || currentUser.email !== emailSnapshot) {
                return;
            }
            
            // Find the current user with updated data
            const updatedUser = Array.isArray(users) ? users.find(u => u && u.email === emailSnapshot) : null;
            if (updatedUser) {
                currentUser = updatedUser;
                try { sessionStorage.setItem('userPortalAuthenticated', JSON.stringify(currentUser)); } catch(_) {}
                // Merge Firestore assignments into currentUser.jobs to reflect admin updates
                try {
                    if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable() && currentUser && currentUser.name) {
                        const assignments = await window.FirestoreDataManager.getUserAssignments(currentUser.name);
                        if (assignments && typeof assignments === 'object') {
                            if (!currentUser.jobs) currentUser.jobs = {};
                            Object.entries(assignments).forEach(([assignmentId, assignmentData]) => {
                                const existing = currentUser.jobs[assignmentId] || {};
                                currentUser.jobs[assignmentId] = { ...existing, ...assignmentData };
                            });
                            console.log('ðŸ”„ Merged Firestore assignments into user jobs:', Object.keys(assignments).length);
                        }
                    }
                } catch (mergeErr) {
                    console.warn('âš ï¸ Could not merge assignments:', mergeErr?.message || mergeErr);
                }
                console.log('âœ… Updated current user data:', {
                    name: currentUser.name,
                    email: currentUser.email,
                    paymentMethod: currentUser.paymentMethod,
                    paymentStatus: currentUser.paymentStatus,
                    jobs: currentUser.jobs,
                    primaryJob: currentUser.primaryJob
                });
            } else {
                console.warn('âš ï¸ Could not find updated user data for:', emailSnapshot);
                if (Array.isArray(users)) {
                    console.log('ðŸ“‹ Available users:', users.map(u => ({ name: u.name, email: u.email })));
                }
                // If we cannot resolve the user, abort to prevent null access below
                return;
            }

            // Check for automatic project status updates
            await checkAutomaticProjectStatusUpdates();

            // Update welcome message (re-validate session before UI update)
            if (!currentUser || !currentUser.email || currentUser.email !== emailSnapshot) {
                return;
            }
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = currentUser.name;
            } else {
                // Try multiple selectors and retry with delay
                const alternativeSelectors = [
                    '#userName',
                    '.user-name',
                    '[data-user-name]',
                    'h1 span'
                ];
                
                let found = false;
                for (const selector of alternativeSelectors) {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.textContent = currentUser.name;
                        found = true;
                        break;
                    }
                }
                
                if (!found) {
                    console.warn('âš ï¸ userName element not found in DOM');
                    // Try again after a short delay in case DOM isn't ready
                    setTimeout(() => {
                        const retryElement = document.getElementById('userName');
                        if (retryElement) {
                            retryElement.textContent = currentUser.name;
                            console.log('âœ… userName element updated on retry');
                        }
                    }, 100);
                }
            }
            
            // Display user info (ensure avatar and payment persist across refresh)
            try {
                if (currentUser && currentUser.profilePicture) {
                    displayProfilePicture(currentUser.profilePicture);
                }
            } catch(_) {}
            // Display user info
            displayUserInfo();
            displayContracts();
            displayUserJobs();
            displayUserPerformanceReviews();
            
            // Load Priority Jobs
            loadPriorityJobs();
            
            // Initialize Performance Analytics
            initializePerformanceAnalytics();
        }

        // Refresh user data manually
        async function refreshUserData() {
            if (!currentUser) return;
            
            showNotification('ðŸ”„ Refreshing data...', 'info');
            await loadUserData();
                            console.log('âœ… Data refreshed successfully!');
        }

        // Display user information for modern layout
        function displayUserInfo() {
            const container = document.getElementById('userInfo');
            if (!container) {
                console.warn('âš ï¸ userInfo container not found in DOM');
                return;
            }
            
            // Debug current user data
            console.log('ðŸ” Displaying user info for:', currentUser.name);
            console.log('ðŸ’° Payment data:', {
                paymentMethod: currentUser.paymentMethod,
                paymentStatus: currentUser.paymentStatus
            });
            
            // Fix timezone issues with approved date
            const fixedApprovedDate = fixTimezone(currentUser.approvedDate);
            let displayApprovedDate = 'Pending';
            if (fixedApprovedDate) {
                try {
                    const date = new Date(fixedApprovedDate);
                    if (!isNaN(date.getTime())) {
                        displayApprovedDate = date.toLocaleDateString();
                    } else {
                        console.warn('âš ï¸ Invalid approved date after fixTimezone:', fixedApprovedDate);
                    }
                } catch (error) {
                        console.warn('âš ï¸ Error formatting approved date:', error);
                }
            }
            
            // Get the selected job for role, location, and rate information
            const selectedJob = getSelectedJob();
            
            // Debug the selected job data
            console.log('ðŸ” Selected job data:', selectedJob);
            
            // Get role, location, and rate with fallbacks to profile data
            // Note: jobs may have 'title' instead of 'role', and we need to handle both
            const role = selectedJob?.role || selectedJob?.title || 'Creator';
            const location = selectedJob?.location || 'N/A';
            const rate = selectedJob?.rate || 'N/A';
            
            console.log('ðŸ“Š Profile display values:', { role, location, rate });
            
            container.innerHTML = `
                <div class="profile-info">
                    <div class="info-item">
                        <span class="label">Full Name</span>
                        <span class="value">${currentUser.name}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Email Address</span>
                        <span class="value">${currentUser.email}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Approved Date</span>
                        <span class="value">${displayApprovedDate}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Role</span>
                        <span class="value">${role}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Location</span>
                        <span class="value">${location}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Rate</span>
                        <span class="value highlight">${rate}</span>
                    </div>
                </div>
            `;
            
            // Update project info
            displayProjectInfo();
            
            // Update payment info
            displayPaymentInfo();
        }
        // Display project information for modern layout
        function displayProjectInfo() {
            const container = document.getElementById('projectInfo');
            if (!container) return;
            
            const userJobs = Object.values(currentUser.jobs || {});
            const selectedJob = getSelectedJob();
            
            if (selectedJob) {
                const projectProgress = getProjectProgress();
                
                container.innerHTML = `
                    <div class="project-info">
                        <h3>${selectedJob.title || selectedJob.role || 'Current Position'}</h3>
                        <div class="project-status">
                            <span class="status-badge status-${selectedJob.projectStatus || 'upcoming'}">
                                ${selectedJob.projectStatus || 'upcoming'}
                            </span>
                        </div>
                        <div class="project-progress">
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${projectProgress}%"></div>
                            </div>
                            <span class="progress-text">${projectProgress}% Complete</span>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-project">
                        <i class="fas fa-calendar-plus"></i>
                        <p>No active project assigned</p>
                    </div>
                `;
            }
        }

        // Display payment information for modern layout
        function displayPaymentInfo() {
            const container = document.getElementById('paymentMethodSection');
            if (!container) return;
            
            if (currentUser.paymentMethod) {
                container.innerHTML = `
                    <div class="payment-info">
                        <div class="payment-method">
                            <i class="fas fa-check-circle"></i>
                            <span>${currentUser.paymentMethod.toUpperCase()}</span>
                        </div>
                        <button onclick="showPaymentModal()" class="btn btn-secondary">
                            <i class="fas fa-edit"></i>
                            Update Payment Method
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-payment">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Payment method not configured</p>
                        <button onclick="showPaymentModal()" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Set Payment Method
                        </button>
                    </div>
                `;
            }
        }

        // Helper function to get selected job (use unified display cache if present)
        function getSelectedJob() {
            if (window.__displayJobsCache && window.__displayJobsCache.primary) {
                return window.__displayJobsCache.primary;
            }
            if (!currentUser || !currentUser.jobs) return null;
            const userJobs = Object.values(currentUser.jobs);
            if (userJobs.length === 0) return null;
            const getStartFor = (job) => parseDateFlexible(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate());
            const inProgress = userJobs.filter(j => getJobStatus(getStartFor(j)) === 'in-progress');
            const upcoming = userJobs.filter(j => getJobStatus(getStartFor(j)) === 'upcoming').sort((a,b) => getStartFor(a) - getStartFor(b));
            const primary = inProgress[0] || upcoming[0] || userJobs[0];
            if (primary) {
                primary.title = primary.title || primary.role || 'Project';
                primary.projectStart = primary.projectStart || primary.date || currentUser.application?.eventDate || '';
                primary.location = primary.location || currentUser.profile?.location || '';
                primary.rate = primary.rate || currentUser.profile?.rate || '';
            }
            return primary;
        }
        // Resolve a job's start date from Firestore listing first (per-job)
        function getListingStartDateFor(job){
            try {
                if (!job) return '';
                if (Array.isArray(jobsData) && jobsData.length){
                    const byId = jobsData.find(j => j && (j.id === job.id));
                    const byTitle = !byId ? jobsData.find(j => String(j.title||j.role||'').toLowerCase() === String(job.title||job.role||'').toLowerCase()) : null;
                    const listing = byId || byTitle;
                    return listing?.date || listing?.projectStart || '';
                }
            } catch(_) {}
            return '';
        }
        // Helper function to get project progress
        function getProjectProgress() {
            const job = getSelectedJob();
            if (!job) return 0;
            
            const status = job.projectStatus || 'upcoming';
            switch (status) {
                case 'upcoming': return 0;
                case 'in-progress': return 50;
                case 'completed': return 100;
                default: return 0;
            }
        }

        // Normalize any raw job/application into a consistent job object
        function normalizeJobRecord(raw, sourceHint = ''){
            const safe = raw || {};
            const id = (safe.jobId || safe.id || safe.__userJobKey || '').toString().trim();
            const createdAt = safe.createdAt || safe.approvedAt || safe.approvedDate || safe.updatedAt || new Date().toISOString();
            const projectStart = safe.projectStart || safe.jobDate || safe.date || '';
            const decisionRaw = (safe.decision || safe.status || safe.applicationStatus || '').toString().toLowerCase();
            let decision = 'pending';
            if (decisionRaw === 'approved' || decisionRaw === 'accepted') decision = 'accepted';
            else if (/denied|rejected|declined/.test(decisionRaw)) decision = 'declined';
            const normalized = {
                id: id,
                title: safe.jobTitle || safe.title || safe.role || 'Project',
                role: safe.role || safe.jobTitle || safe.title || 'Project',
                location: safe.location || '',
                rate: safe.payDisplay || safe.rate || safe.pay || '',
                projectStart: projectStart,
                date: projectStart,
                createdAt: createdAt,
                source: sourceHint || safe.source || '',
                decision: decision,
                projectStatus: safe.projectStatus || safe.status || 'upcoming',
                paymentStatus: safe.paymentStatus || 'pending'
            };
            return normalized;
        }

        // Build unified jobs array for the signed-in user from multiple sources
        async function getDisplayJobsForCurrentUser() {
            const localJobs = Object.entries(currentUser?.jobs || {}).map(([key, job]) => ({ ...job, __userJobKey: key }));
            let merged = localJobs.map(j => normalizeJobRecord({ ...j, id: j.id || j.__userJobKey }, 'assignment'));

            // Pull Quick Apply docs for this user's email and fold them in (dedup by jobId/title/date/location)
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable() && currentUser?.email) {
                    const [allQuick, allApps] = await Promise.all([
                        window.FirestoreDataManager.getQuickApplications(),
                        (window.FirestoreDataManager.getApplications ? window.FirestoreDataManager.getApplications() : Promise.resolve([]))
                    ]);
                    const emailLower = String(currentUser.email).toLowerCase();
                    const mineQuick = (allQuick || []).filter(q => String(q?.applicant?.email || '').toLowerCase() === emailLower);
                    const mineApps  = (allApps  || []).filter(a => String(a?.applicant?.email || a?.email || '').toLowerCase() === emailLower);
                    const mappedQuick = mineQuick.map(q => normalizeJobRecord(q, 'quickApply'));
                    const mappedApps  = mineApps.map(a => normalizeJobRecord(a, 'applyPage'));
                    const byKey = new Map();
                    const makeKey = (j) => {
                        const id = (j.id || '').toString().trim();
                        if (id) return 'id:' + id;
                        const title = (j.title || j.role || '').toString().trim().toLowerCase();
                        const date = (j.projectStart || j.date || '').toString().trim();
                        const loc = (j.location || '').toString().trim().toLowerCase();
                        return 'composite:' + [title, date, loc].join('|');
                    };
                    [...merged, ...mappedQuick, ...mappedApps].forEach(j => { const k = makeKey(j); if (!byKey.has(k)) byKey.set(k, j); });
                    merged = Array.from(byKey.values());
                }
            } catch (mergeErr) { console.warn('âš ï¸ Could not merge quick applications into jobs:', mergeErr?.message || mergeErr); }

            // Include any signed contracts as normalized accepted jobs
            try {
                const userEmailLower = (currentUser && currentUser.email) ? String(currentUser.email).toLowerCase() : '';
                if (userEmailLower && Array.isArray(uploadedContracts) && uploadedContracts.length) {
                    const myContracts = uploadedContracts.filter(c => String((c.freelancerEmail||c.userEmail)||'').toLowerCase() === userEmailLower);
                    const mappedContracts = myContracts.map(c => {
                        const title = c.role || c.jobTitle || c.title || 'Project';
                        // Try to align contract with listing date
                        let listingDate = '';
                        try {
                            if (Array.isArray(jobsData) && jobsData.length) {
                                const norm = (s) => String(s||'').trim().toLowerCase();
                                const m = jobsData.find(j => norm(j.title) === norm(title));
                                listingDate = m?.date || m?.projectStart || '';
                            }
                        } catch(_) {}
                        return normalizeJobRecord({
                            jobTitle: title,
                            role: title,
                            location: c.location || '',
                            payDisplay: c.rate || '',
                            jobDate: listingDate || currentUser?.profile?.projectDate || currentUser?.projectDate || '',
                            status: 'accepted'
                        }, 'contract');
                    });
                    const byKey = new Map();
                    const makeKey = (j) => {
                        const id = (j.id || '').toString().trim();
                        if (id) return 'id:' + id;
                        const title = (j.title || j.role || '').toString().trim().toLowerCase();
                        const date = (j.projectStart || j.date || '').toString().trim();
                        const loc = (j.location || '').toString().trim().toLowerCase();
                        return 'composite:' + [title, date, loc].join('|');
                    };
                    [...merged, ...mappedContracts].forEach(j => { const k = makeKey(j); if (!byKey.has(k)) byKey.set(k, j); });
                    merged = Array.from(byKey.values());
                }
            } catch (contractErr) { console.warn('âš ï¸ Could not merge contracts into jobs:', contractErr?.message || contractErr); }

            // Always consider adding a synthesized profile job (so OBS Tech Assistant can appear)
            try {
                const profileRole = currentUser?.profile?.role || currentUser?.role;
                if (profileRole) {
                    const profileDate = currentUser?.profile?.projectDate || currentUser?.projectDate || '';
                    const profileLoc = currentUser?.profile?.location || currentUser?.location || '';
                    const profileRate = currentUser?.profile?.rate || currentUser?.rate || '';
                    let listing = null;
                    try {
                        if (Array.isArray(jobsData)) {
                            const norm = (s) => String(s || '').trim().toLowerCase();
                            listing = jobsData.find(j => norm(j.title) === norm(profileRole));
                        }
                    } catch(_) { listing = null; }
                    const profileJob = normalizeJobRecord({
                        id: (listing && listing.id) || undefined,
                        jobTitle: profileRole,
                        role: profileRole,
                        location: profileLoc || (listing && listing.location) || '',
                        payDisplay: profileRate || (listing && listing.pay) || '',
                        jobDate: profileDate || (listing && listing.date) || ''
                    }, 'profile');
                    profileJob.decision = 'accepted';
                    const byKey = new Map();
                    const makeKey = (j) => {
                        const id = (j.id || '').toString().trim();
                        if (id) return 'id:' + id;
                        const title = (j.title || j.role || '').toString().trim().toLowerCase();
                        const date = (j.projectStart || j.date || '').toString().trim();
                        const loc = (j.location || '').toString().trim().toLowerCase();
                        return 'composite:' + [title, date, loc].join('|');
                    };
                    merged.forEach(j => { const k = makeKey(j); if (!byKey.has(k)) byKey.set(k, j); });
                    const k = makeKey(profileJob);
                    if (!byKey.has(k)) merged.unshift(profileJob);
                }
            } catch(_) {}

            // Final cross-key de-duplication (id OR normalized title+date+location)
            const normalizeDateKey = (d) => {
                try { const dt = parseDateFlexible(d); if (dt && !isNaN(dt)) { const m = (n)=> String(n).padStart(2,'0'); return `${dt.getFullYear()}-${m(dt.getMonth()+1)}-${m(dt.getDate())}`; } } catch(_) {}
                return String(d||'').trim();
            };
            const finalMap = new Map();
            const finalKey = (j) => {
                const id = (j.id||'').toString().trim();
                if (id) return 'id:'+id;
                const title = (j.title||j.role||'').toString().trim().toLowerCase();
                const effectiveDate = getListingStartDateFor(j) || j.projectStart || j.date;
                const date = normalizeDateKey(effectiveDate);
                const loc = (j.location||'').toString().trim().toLowerCase();
                return 'k:'+[title,date,loc].join('|');
            };
            merged.forEach(j => { const k = finalKey(j); if (!finalMap.has(k)) finalMap.set(k, j); });
            merged = Array.from(finalMap.values());

            // Sort jobs: current (in-progress/accepted) first by start date, then upcoming by start date, then completed
            const getStartFor = (job) => parseDateFlexible(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate());
            const statusOrder = (j) => {
                const s = getJobStatus(getStartFor(j));
                if (s === 'in-progress') return 0;
                if ((j.decision || '').toLowerCase() === 'accepted' && s !== 'completed') return 1;
                if (s === 'upcoming') return 2;
                if (s === 'completed') return 3;
                return 4;
            };
            merged.sort((a,b)=>{
                const ao = statusOrder(a), bo = statusOrder(b);
                if (ao !== bo) return ao - bo;
                const ad = getStartFor(a)?.getTime?.() || 0;
                const bd = getStartFor(b)?.getTime?.() || 0;
                if (ad && bd && ad !== bd) return ad - bd;
                return String(a.createdAt||'').localeCompare(String(b.createdAt||''));
            });

            // Ensure only one job flagged as current
            let currentMarked = false;
            merged = merged.map(j => {
                const s = getJobStatus(getStartFor(j));
                const isCandidate = s === 'in-progress' || ((j.decision||'').toLowerCase()==='accepted' && s !== 'completed');
                const isCurrent = !currentMarked && isCandidate;
                if (isCurrent) currentMarked = true;
                return { ...j, isCurrent };
            });

            return merged;
        }

        // Fetch application decisions for a user (accepted/pending/declined)
        async function getApplicationDecisionsForUser(email) {
            const decisions = new Map();
            if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                try {
                    const [apps, qapps] = await Promise.all([
                        window.FirestoreDataManager.getApplications().catch(() => []),
                        window.FirestoreDataManager.getQuickApplications().catch(() => [])
                    ]);
                    const emailLower = String(email || '').toLowerCase();
                    const addFrom = (list) => {
                        (list || []).forEach(a => {
                            const ae = String(a?.applicant?.email || a?.email || '').toLowerCase();
                            if (ae !== emailLower) return;
                            const raw = (a?.status || a?.applicationStatus || a?.decision || 'pending').toLowerCase();
                            let d = 'pending';
                            if (raw === 'approved' || raw === 'accepted') d = 'accepted';
                            else if (raw === 'denied' || raw === 'rejected' || raw === 'declined') d = 'declined';
                            const jobId = (a?.jobId || a?.id || '').toString().trim();
                            if (jobId) decisions.set(jobId, d);
                            const title = (a?.jobTitle || a?.title || '').toString().trim().toLowerCase();
                            if (title) decisions.set('title:' + title, d);
                        });
                    };
                    addFrom(apps);
                    addFrom(qapps);
                } catch(_) {}
            }
            return decisions;
        }

        // Display current jobs for modern layout (multi-job aware)
        async function displayCurrentJobs() {
            const container = document.getElementById('jobsContent');
            if (!container) return;
            
            const userJobs = await getDisplayJobsForCurrentUser();
            // Classify by application decision
            const __decisions = await getApplicationDecisionsForUser(currentUser?.email);
            const __getDecision = (j) => {
                // Trust normalized decision when present
                if (j && j.decision) return String(j.decision).toLowerCase();
                if (j && j.__userJobKey) return 'accepted';
                const id = (j && j.id ? String(j.id).trim() : '');
                const titleKey = 'title:' + String(j?.title || j?.role || '').toLowerCase().trim();
                return __decisions.get(id) || __decisions.get(titleKey) || 'pending';
            };
            const accepted = userJobs.filter(j => __getDecision(j) === 'accepted');
            const pending = userJobs.filter(j => __getDecision(j) === 'pending');
            const declined = userJobs.filter(j => __getDecision(j) === 'declined');
            if (!userJobs.length) {
                container.innerHTML = `
                    <div class="card no-jobs-card">
                        <div class="no-jobs-content">
                            <i class="fas fa-calendar-times"></i>
                            <h3>No Jobs Assigned</h3>
                            <p>You don't have any active jobs at the moment.</p>
                            <p>New assignments will appear here automatically.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Helper: compute start date and status for a job
            const getStartFor = (job) => parseDateFlexible(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate());
            const now = new Date();

            // Determine primary (active or nearest upcoming), next-up, and others within accepted
            const inProgress = accepted.filter(j => getJobStatus(getStartFor(j)) === 'in-progress');
            const upcoming = accepted.filter(j => getJobStatus(getStartFor(j)) === 'upcoming')
                .sort((a,b) => getStartFor(a) - getStartFor(b));
            const completed = accepted.filter(j => getJobStatus(getStartFor(j)) === 'completed')
                .sort((a,b) => getStartFor(b) - getStartFor(a));

            // For Current & Upcoming, only accepted jobs that are not completed
            const currentAndUpcomingJobs = accepted.filter(j => getJobStatus(getStartFor(j)) !== 'completed');
            
            const primary = inProgress[0] || upcoming[0] || currentAndUpcomingJobs[0] || pending[0] || accepted[0] || userJobs[0];
            const nextUp = upcoming.find(j => j !== primary) || null;
            const others = accepted.filter(j => j !== primary && j !== nextUp);
            
            // Debug logging
            console.log('ðŸ” Job filtering debug:', {
                totalJobs: userJobs.length,
                inProgress: inProgress.length,
                upcoming: upcoming.length,
                completed: completed.length,
                currentAndUpcoming: currentAndUpcomingJobs.length,
                primary: primary?.title || primary?.role || 'none',
                nextUp: nextUp?.title || nextUp?.role || 'none'
            });

            // Build UI with tabs for better organization
            const parts = [];

            // Add standalone tab navigation (no background container)
            parts.push(`
                <div class="jobs-tabs-standalone">
                    <button class="tab-button${(window.__jobsActiveTab||'current')==='current'?' active':''}" onclick="switchJobsTab('current')" id="currentTab">
                        <i class="fas fa-star"></i> Current & Upcoming
                    </button>
                    <button class="tab-button${(window.__jobsActiveTab||'current')==='all'?' active':''}" onclick="switchJobsTab('all')" id="allTab">
                        <i class="fas fa-list"></i> All Jobs (${(() => { const seen=new Set(); const key=(j)=>{ const t=(j.title||j.role||'').toLowerCase().trim(); const eff=(getListingStartDateFor(j)||j.projectStart||j.date||'').toString(); const l=(j.location||'').toLowerCase().trim(); return t+'|'+eff+'|'+l; }; (userJobs||[]).forEach(j=>seen.add(key(j))); return seen.size; })()})
                    </button>
                </div>
            `);

            // Current & Upcoming tab content - shows primary job and other non-completed jobs
            parts.push(`
                <div id="currentJobsContent" class="tab-content">
                    ${primary ? renderFullJobCard(primary, 'Current Assignment') : ''}
                    ${nextUp ? `
                        <div class="card job-card" style="margin-top: 1rem;">
                            ${renderCompactJobCard(nextUp, 'Next Up')}
                        </div>
                    ` : ''}
                    ${(() => { const o = others.filter(j => getJobStatus(getStartFor(j)) !== 'completed'); const nk = (x)=>{ const t=(x.title||x.role||'').toLowerCase().trim(); const d=(x.projectStart||x.date||'').toString(); const l=(x.location||'').toLowerCase().trim(); return t+'|'+d+'|'+l; }; const nextKey = nextUp ? nk(nextUp) : null; const uniq = []; const seen=new Set(); o.forEach(j=>{ const k=nk(j); if (k!==nextKey && !seen.has(k)) { seen.add(k); uniq.push(j);} }); return uniq.length ? `
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header"><h3 class="card-title">Other Jobs</h3></div>
                            <div class="job-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;padding:1rem;">
                                ${uniq.map(j => `<div class="job-card">${renderCompactJobCard(j)}</div>`).join('')}
                            </div>
                        </div>
                    ` : '' })()}
                    ${currentAndUpcomingJobs.length === 0 ? `
                        <div class="card no-jobs-card">
                            <div class="no-jobs-content">
                                <i class="fas fa-calendar-times"></i>
                                <h3>No Current Jobs</h3>
                                <p>You don't have any active or upcoming jobs at the moment.</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `);

            // All Jobs tab content - organized by status
            parts.push(`
                <div id="allJobsContent" class="tab-content" style="display: none;">
                    <div class="all-jobs-container">
                        ${inProgress.length > 0 ? `
                            <div class="job-section">
                                <h3 class="section-title"><i class="fas fa-play-circle"></i> In Progress (${inProgress.length})</h3>
                                <div class="job-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-bottom:1.5rem;">
                                    ${inProgress.map(job => renderJobCardForAllJobs(job, getStartFor(job))).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${upcoming.length > 0 ? `
                            <div class="job-section">
                                <h3 class="section-title"><i class="fas fa-clock"></i> Upcoming (${upcoming.length})</h3>
                                <div class="job-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-bottom:1.5rem;">
                                    ${upcoming.map(job => renderJobCardForAllJobs(job, getStartFor(job))).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${completed.length > 0 ? `
                            <div class="job-section">
                                <h3 class="section-title"><i class="fas fa-check-circle"></i> Completed (${completed.length})</h3>
                                <div class="job-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-bottom:1.5rem;">
                                    ${completed.map(job => renderJobCardForAllJobs(job, getStartFor(job))).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${userJobs.length === 0 ? `
                            <div class="card no-jobs-card">
                                <div class="no-jobs-content">
                                    <i class="fas fa-calendar-times"></i>
                                    <h3>No Jobs Found</h3>
                                    <p>You don't have any job assignments yet.</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);

            container.innerHTML = parts.join('');
            // cache for profile/timeline consumers
            window.__displayJobsCache = { userJobs, primary };
            // Restore active tab selection after re-render
            switchJobsTab(window.__jobsActiveTab || 'current');
        }

        // Render job card for All Jobs tab
        function renderJobCardForAllJobs(job, startDate) {
            const status = getJobStatus(startDate);
            const statusClass = status === 'completed' ? 'completed' : status === 'in-progress' ? 'in-progress' : 'upcoming';
            return `
                <div class="job-card ${statusClass}">
                    <div class="card-header">
                        <h4>${job.title || job.role || 'Project'}</h4>
                        <span class="status-badge status-${statusClass}">${status}</span>
                    </div>
                    <div class="job-info">
                        <div class="info-item"><span class="label">Date:</span><span class="value">${formatDisplayDate(startDate)}</span></div>
                        <div class="info-item"><span class="label">Location:</span><span class="value">${job.location || 'N/A'}</span></div>
                        <div class="info-item"><span class="label">Rate:</span><span class="value highlight">${job.rate || 'N/A'}</span></div>
                    </div>
                </div>
            `;
        }

        // Switch between job tabs
        function switchJobsTab(tabName) {
            window.__jobsActiveTab = tabName;
            const currentTab = document.getElementById('currentTab');
            const allTab = document.getElementById('allTab');
            const currentContent = document.getElementById('currentJobsContent');
            const allContent = document.getElementById('allJobsContent');

            if (!currentTab || !allTab || !currentContent || !allContent) return;

            // Update tab buttons
            currentTab.classList.toggle('active', tabName === 'current');
            allTab.classList.toggle('active', tabName === 'all');

            // Update content visibility
            currentContent.style.display = tabName === 'current' ? 'block' : 'none';
            allContent.style.display = tabName === 'all' ? 'block' : 'none';
        }

        // Render a full timeline card for a specific job
        function renderFullJobCard(job, label) {
            const status = getJobStatus(parseDateFlexible(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate()));
            return `
                <div class="card job-card" data-job-id="${job.id || ''}">
                    <div class="card-header">
                        <h3 class="card-title">${job.title || job.role || 'Project'}${label ? ` <small style="opacity:.7;font-weight:400">â€¢ ${label}</small>` : ''}</h3>
                        <span class="status-badge status-${status}">${status}</span>
                    </div>
                    <!-- Job Info Section - Compact horizontal layout -->
                    <div class="job-info-compact">
                        <div class="info-item"><span class="label">Location:</span><span class="value">${job.location || 'N/A'}</span></div>
                        <div class="info-item"><span class="label">Rate:</span><span class="value highlight">${job.rate || 'N/A'}</span></div>
                        <div class="info-item"><span class="label">Start Date:</span><span class="value">${formatDisplayDate(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate())}</span></div>
                        <div class="info-item payment-status">
                            ${currentUser.paymentMethod ? `
                                <span class="label">Payment:</span><span class="value"><i class="fas fa-check-circle" style="color: #10b981;"></i> ${currentUser.paymentMethod.toUpperCase()}</span>
                            ` : `
                                <span class="label">Payment:</span><span class="value warning"><i class="fas fa-exclamation-circle"></i> Not configured</span>
                            `}
                        </div>
                    </div>
                    
                    <!-- Full-width Timeline Section -->
                    <div class="job-timeline-fullwidth">
                        <div class="timeline-header-fullwidth">
                            <div class="timeline-title">
                                <h4><i class="fas fa-route"></i> Project Timeline</h4>
                            </div>
                            <div class="timeline-actions">
                                <button class="btn-small" title="View job details" aria-label="View job details" onclick="showJobDetails && showJobDetails('${job.id||''}')"><i class="fas fa-eye"></i></button>
                                <button class="btn-small" title="Download contract" aria-label="Download contract" onclick="downloadContractForJob && downloadContractForJob('${job.id||''}')"><i class="fas fa-file-download"></i></button>
                                <button class="btn-small" title="Open messages" aria-label="Open messages" onclick="openMessagesForJob && openMessagesForJob('${job.id||''}')"><i class="fas fa-comments"></i></button>
                                ${!currentUser.paymentMethod ? `<button class="btn-small btn-payment" title="Set payment method" onclick="showPaymentModal()"><i class="fas fa-credit-card"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="timeline-horizontal-fullwidth" id="timeline-${(job.id||'').replace(/[^a-zA-Z0-9_-]/g,'')}">${renderTimelineSteps(job, true)}</div>
                    </div>
                </div>
            `;
        }

        // Render a compact job card (no full timeline)
        function renderCompactJobCard(job, badgeLabel) {
            const status = getJobStatus(parseDateFlexible(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate()));
            return `
                <div class="card-header">
                    <h3 class="card-title">${job.title || job.role || 'Project'}</h3>
                    <span class="status-badge status-${status}">${badgeLabel || status}</span>
                </div>
                <div class="job-details">
                    <div class="job-info">
                        <div class="info-item"><span class="label">Location:</span><span class="value">${job.location || 'N/A'}</span></div>
                        <div class="info-item"><span class="label">Rate:</span><span class="value highlight">${job.rate || 'N/A'}</span></div>
                        <div class="info-item"><span class="label">Start Date:</span><span class="value">${formatDisplayDate(getListingStartDateFor(job) || job.projectStart || job.date || getEffectiveProjectStartDate())}</span></div>
                    </div>
                    <div style="padding:1rem 0 0.25rem">
                        <div class="progress-bar" style="height:8px; background:rgba(255,255,255,0.08); border-radius:6px; overflow:hidden;">
                            <div class="progress-fill" style="height:100%; width:${getProjectProgressForJob(job)}%; background:linear-gradient(90deg,#00d4ff,#00ffa3);"></div>
                        </div>
                        <small style="opacity:.8">${getProjectProgressForJob(job)}% Complete</small>
                    </div>
                </div>
            `;
        }

        function getProjectProgressForJob(job){
            const status = (job && (job.projectStatus || job.status)) || 'upcoming';
            switch (status) {
                case 'upcoming': return 0;
                case 'in-progress': return 50;
                case 'completed': return 100;
                default: return 0;
            }
        }

        // Render timeline steps for jobs (use Firestore listing date when available)
        function renderTimelineSteps(job, horizontal = false) {
            const listingStart = getListingStartDateFor(job) || job?.projectStart || job?.date || getEffectiveProjectStartDate();
            const computedStatus = getJobStatus(listingStart);
            const decision = (job.decision || '').toLowerCase();
            const paymentComplete = (job.paymentStatus === 'configured') || (currentUser?.paymentStatus === 'configured') || (currentUser?.paymentMethod && currentUser.paymentMethod !== 'pending');
            const steps = [
                { key: 'application', title: 'Application Approved', status: decision === 'accepted' ? 'completed' : (decision === 'pending' ? 'current' : 'upcoming') },
                { key: 'payment', title: 'Payment Setup', status: decision !== 'accepted' ? 'upcoming' : (paymentComplete ? 'completed' : 'current') },
                { key: 'inprogress', title: 'In Progress', status: (computedStatus === 'in-progress') ? 'current' : (computedStatus === 'completed' ? 'completed' : 'upcoming') },
                { key: 'completed', title: 'Completed', status: computedStatus === 'completed' ? 'completed' : 'upcoming' }
            ];
            return steps.map(step => {
                if (horizontal) {
                    return `
                <div class="step ${step.status}" data-step="${step.key}" tabindex="0" ${step.status==='current' ? 'aria-current="step"' : ''} title="${step.title} - ${step.status==='completed' ? 'Completed' : step.status==='current' ? 'In progress' : 'Pending'}">
                    <div class="dot" role="img" aria-label="${step.title}"></div>
                    <div class="label">${step.title}</div>
                </div>`;
                }
                return `
                <div class="timeline-item ${step.status}" data-step="${step.key}">
                    <div class="timeline-content">
                        <h4>${step.title}</h4>
                        <p>${step.status === 'completed' ? 'Step completed' : step.status === 'current' ? 'In progress' : 'Pending'}</p>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Display contracts for modern layout
        function displayContracts() {
            const container = document.getElementById('contractsContent');
            if (!container) return;
            
            // Show ALL uploaded contracts for this user (not just latest)
            const userEmailLower = (currentUser && currentUser.email) ? currentUser.email.toLowerCase() : '';
            const allUserContracts = (uploadedContracts || []).filter(c => {
                const ce = (c && (c.freelancerEmail || c.userEmail)) ? String(c.freelancerEmail || c.userEmail).toLowerCase() : '';
                return ce && ce === userEmailLower;
            }).sort((a,b)=> new Date(b.signedDate||b.uploadDate||0) - new Date(a.signedDate||a.uploadDate||0));

            if (allUserContracts.length === 0) {
                container.innerHTML = `
                    <div class="card no-contract-card">
                        <div class="no-contract-content">
                            <i class="fas fa-file-signature"></i>
                            <h3>No Contracts Found</h3>
                            <p>You don't have any signed contracts yet.</p>
                            <p>Contracts will appear here once they're signed and uploaded.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = allUserContracts.map(c => `
                <div class="card contract-card">
                    <div class="card-header">
                        <h2 class="card-title">${c.role || 'Contract'}</h2>
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="contract-info">
                        <div class="contract-details">
                            <div class="info-item"><span class="label">Contract ID:</span><span class="value">${c.contractId}</span></div>
                            <div class="info-item"><span class="label">Signed Date:</span><span class="value">${c.signedDate ? new Date(c.signedDate).toLocaleDateString() : 'N/A'}</span></div>
                            <div class="info-item"><span class="label">Rate:</span><span class="value">${c.rate || 'N/A'}</span></div>
                            <div class="info-item"><span class="label">Location:</span><span class="value">${c.location || 'N/A'}</span></div>
                        </div>
                        <div class="contract-actions">
                            <button onclick="downloadContractById('${encodeURIComponent(c.contractId || c.id || '')}', '${encodeURIComponent(c.fileName || '')}', '${encodeURIComponent(c.githubUrl || '')}', '${encodeURIComponent(c.fileUrl || '')}')" class="btn btn-primary">
                                <i class="fas fa-download"></i>
                                Download Contract
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Download contract by an explicit file reference (supports multiple)
        function downloadUserContractByFile(fileNameEnc, githubUrlEnc, fileUrlEnc = '') {
            const fileName = decodeURIComponent(fileNameEnc);
            const githubUrl = decodeURIComponent(githubUrlEnc || '');
            const fileUrl = decodeURIComponent(fileUrlEnc || '');
            
            // Look for the contract in uploadedContracts to get the fileUrl
            const list = Array.isArray(uploadedContracts) ? uploadedContracts : [];
            const match = list.find(c => c.fileName === fileName);
            
            const candidates = [];
            // Prioritize Firestore Storage URLs
            if (match && match.fileUrl) candidates.push(match.fileUrl);
            if (fileUrl) candidates.push(fileUrl);
            // Keep GitHub URLs as fallback for legacy contracts
            if (githubUrl) candidates.push(githubUrl);
            candidates.push(`/contracts/${encodeURIComponent(fileName)}`);
            candidates.push(`/api/contracts?filename=${encodeURIComponent(fileName)}`);
            
            (async () => {
                for (const url of candidates) {
                    try {
                        // Cross-origin HEAD often fails due to CORS; allow direct open when cross-origin
                        const u = new URL(url, window.location.href);
                        const isCross = u.origin !== window.location.origin;
                        let ok = true;
                        if (!isCross) {
                            const resp = await fetch(url, { method: 'HEAD' });
                            ok = resp.ok;
                        }
                        if (ok) {
                            const link = document.createElement('a'); link.href = url; link.download = fileName; link.target = '_blank'; document.body.appendChild(link); link.click(); document.body.removeChild(link); return;
                        }
                    } catch(_) { /* continue trying next candidate */ }
                }
                showNotification('Contract file is not available yet. Please try again later or contact support.', 'error');
            })();
        }

        // Download a specific contract by its contractId, with robust fallbacks
        function downloadContractById(contractIdEnc, fileNameEnc = '', githubUrlEnc = '', fileUrlEnc = '') {
            try {
                const contractId = decodeURIComponent(contractIdEnc || '');
                const fileNameOverride = decodeURIComponent(fileNameEnc || '');
                const githubUrl = decodeURIComponent(githubUrlEnc || '');
                const fileUrl = decodeURIComponent(fileUrlEnc || '');

                const list = Array.isArray(uploadedContracts) ? uploadedContracts : [];
                const match = list.find(c => String(c.contractId || c.id || '').trim() === contractId);

                const fileName = (match && match.fileName) || fileNameOverride || (currentUser && currentUser.name ? `${currentUser.name}.pdf` : 'contract.pdf');
                const candidates = [];
                if (match && match.fileUrl) candidates.push(match.fileUrl);
                if (fileUrl) candidates.push(fileUrl);
                if (match && match.githubUrl) candidates.push(match.githubUrl);
                if (githubUrl) candidates.push(githubUrl);
                candidates.push(`/contracts/${encodeURIComponent(fileName)}`);
                candidates.push(`/api/contracts?filename=${encodeURIComponent(fileName)}`);

                const tryHead = async (u) => {
                    try {
                        const urlObj = new URL(u, window.location.href);
                        // Skip HEAD for cross-origin URLs to avoid CORS failures
                        if (urlObj.origin !== window.location.origin) return true;
                        const r = await fetch(u, { method: 'HEAD' });
                        return r.ok;
                    } catch(_) { return true; }
                };

                (async () => {
                    for (const u of candidates) {
                        const ok = await tryHead(u);
                        if (ok) {
                            const a = document.createElement('a'); a.href = u; a.download = fileName; a.target = '_blank'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                            return;
                        }
                    }
                    showNotification('Contract file is not available yet. Please try again later or contact support.', 'error');
                })();
            } catch (e) {
                console.warn('âš ï¸ downloadContractById failed:', e);
                showNotification('Unable to download contract due to an unexpected error.', 'error');
            }
        }
        // Display performance reviews for modern layout
        function displayPerformanceReviews() {
            const container = document.getElementById('performanceContent');
            if (!container) return;
            
            const userEmail = currentUser.email;
            let performance = getUserPerformanceReview(userEmail);
            // fallback: if not found by email, try currentUser.performance directly when users API returns flattened doc
            if (!performance && currentUser && currentUser.performance) {
                performance = currentUser.performance;
            }
            
            if (performance) {
                container.innerHTML = `
                    <div class="card performance-card">
                        <div class="card-header">
                            <h2 class="card-title">Latest Review</h2>
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="performance-info">
                            <div class="performance-rating">
                                <h3>Overall Rating</h3>
                                <div class="rating-stars">
                                    ${generateStars(performance.overallRating || 0)}
                                </div>
                                <span class="rating-text">${performance.overallRating || 0}/5</span>
                            </div>
                            <div class="performance-details">
                                <div class="info-item">
                                    <span class="label">Review Date:</span>
                                    <span class="value">${performance.reviewDate ? new Date(performance.reviewDate).toLocaleDateString() : 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">Reviewer:</span>
                                    <span class="value">${performance.reviewer || 'Admin Team'}</span>
                                </div>
                                ${performance.professionalism ? `<div class="info-item"><span class="label">Professionalism:</span><span class="value">${performance.professionalism}</span></div>` : ''}
                                ${performance.communication ? `<div class="info-item"><span class="label">Communication:</span><span class="value">${performance.communication}</span></div>` : ''}
                                ${performance.timeliness ? `<div class="info-item"><span class="label">Timeliness:</span><span class="value">${performance.timeliness}</span></div>` : ''}
                            </div>
                            ${performance.strengths && performance.strengths.length ? `
                                <div class="performance-comments">
                                    <h4>Strengths</h4>
                                    <p>${performance.strengths.join(', ')}</p>
                                </div>
                            ` : ''}
                            ${performance.areasForImprovement && performance.areasForImprovement.length ? `
                                <div class="performance-comments">
                                    <h4>Areas for Improvement</h4>
                                    <p>${performance.areasForImprovement.join(', ')}</p>
                                </div>
                            ` : ''}
                            ${performance.goals && performance.goals.length ? `
                                <div class="performance-comments">
                                    <h4>Goals</h4>
                                    <p>${performance.goals.join(', ')}</p>
                                </div>
                            ` : ''}
                            ${performance.notes ? `
                                <div class="performance-comments">
                                    <h4>Notes</h4>
                                    <p>${performance.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="card no-performance-card">
                        <div class="no-performance-content">
                            <i class="fas fa-chart-line"></i>
                            <h3>No Performance Review</h3>
                            <p>You don't have any performance reviews yet.</p>
                            <p>Reviews will appear here after project completion.</p>
                        </div>
                    </div>
                `;
            }
        }

        // Generate star rating display
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            let stars = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            
            return stars;
        }

        // ==================== CREATIVE POWERHOUSE FEATURES ====================
        
        // Animated welcome message
        function animateWelcomeMessage() {
            const welcomeElement = document.querySelector('.dashboard-header h1');
            if (welcomeElement) {
                welcomeElement.style.opacity = '0';
                welcomeElement.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    welcomeElement.style.transition = 'all 0.8s ease';
                    welcomeElement.style.opacity = '1';
                    welcomeElement.style.transform = 'translateY(0)';
                }, 300);
            }
        }

        // Particle background effect
        function createParticleBackground() {
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;
            
            // Create particle container
            const particleContainer = document.createElement('div');
            particleContainer.className = 'particle-container';
            particleContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: -1;
                overflow: hidden;
            `;
            
            // Add particles
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.cssText = `
                    position: absolute;
                    width: 2px;
                    height: 2px;
                    background: var(--primary);
                    border-radius: 50%;
                    opacity: 0.3;
                    animation: float ${3 + Math.random() * 4}s infinite ease-in-out;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                `;
                particleContainer.appendChild(particle);
            }
            
            mainContent.appendChild(particleContainer);
        }

        // Add floating animation to CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes float {
                0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
                50% { transform: translateY(-20px) rotate(180deg); opacity: 0.6; }
            }
            
            .card {
                position: relative;
                overflow: hidden;
            }
            
            .card::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(45deg, transparent, rgba(255,178,0,0.1), transparent);
                transform: rotate(45deg);
                transition: all 0.6s ease;
                opacity: 0;
            }
            
            .card:hover::before {
                opacity: 1;
                transform: rotate(45deg) translateX(100%);
            }
            
            .status-badge {
                position: relative;
                overflow: hidden;
            }
            
            .status-badge::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                transition: left 0.5s ease;
            }
            
            .status-badge:hover::after {
                left: 100%;
            }
        `;
        document.head.appendChild(style);

        // Interactive timeline with hover effects
        function enhanceTimelineInteractivity() {
            const timelineItems = document.querySelectorAll('.timeline-item');
            timelineItems.forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.transition = 'transform 0.3s ease';
                });
                
                item.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        }

        // Dynamic progress bar animation
        function animateProgressBars() {
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                
                setTimeout(() => {
                    bar.style.transition = 'width 1.5s ease-out';
                    bar.style.width = width;
                }, 500);
            });
        }

        // Enhanced notification system - SILENT VERSION (notifications disabled)
        function showEnhancedNotification(message, type = 'info', duration = 5000) {
            // Silent enhanced notification - only log to console
            console.log(`ðŸ”‡ Suppressed enhanced notification: ${message} (${type})`);
            // No popup display - notifications are handled by sophisticated system
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }
        // Initialize creative features
        function initializeCreativeFeatures() {
            // Animate welcome message
            animateWelcomeMessage();
            
            // Create particle background
            createParticleBackground();
            
            // Enhance timeline interactivity
            setTimeout(enhanceTimelineInteractivity, 1000);
            
            // Animate progress bars
            setTimeout(animateProgressBars, 1500);
            
            // Add card hover effects
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
            
            // Add sidebar navigation effects
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // Add ripple effect
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    ripple.style.cssText = `
                        position: absolute;
                        border-radius: 50%;
                        background: rgba(255,178,0,0.3);
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        pointer-events: none;
                    `;
                    this.appendChild(ripple);
                    
                    setTimeout(() => ripple.remove(), 600);
                });
            });
            
            // Add typing effect to welcome message
            typeWelcomeMessage();
        }

        // Typing effect for welcome message - OPTIMIZED
        function typeWelcomeMessage() {
            const welcomeElement = document.querySelector('.dashboard-header h1');
            if (!welcomeElement) return;
            
            // Get the current user name for dynamic welcome message
            const userName = currentUser ? currentUser.name : 'User';
            const welcomeText = `Welcome back, ${userName}!`;
            
            // Set the welcome message directly without typing animation to avoid conflicts
            welcomeElement.textContent = welcomeText;
        }
        // Add cursor animation to CSS - IMPROVED
        const cursorStyle = document.createElement('style');
        cursorStyle.textContent = `
            .typing-cursor {
                animation: blink 1.2s infinite;
                color: #FFB200;
                font-weight: bold;
                text-shadow: 0 0 5px #FFB200;
            }
            
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
            
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
            
            .nav-link {
                position: relative;
                overflow: hidden;
            }
            
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255,178,0,0.3);
                transform: scale(0);
                animation: ripple 0.6s linear;
                pointer-events: none;
            }
            
            /* IMPROVED INPUT STYLING FOR BETTER CURSOR VISIBILITY */
            input[type="text"], input[type="email"], input[type="password"] {
                caret-color: #FFB200 !important;
                color: #FFFFFF !important;
                font-size: 16px !important;
                line-height: 1.5 !important;
                padding: 12px 16px !important;
                background: rgba(255, 255, 255, 0.1) !important;
                border: 2px solid rgba(255, 255, 255, 0.2) !important;
                border-radius: 8px !important;
                transition: all 0.3s ease !important;
                outline: none !important;
                -webkit-appearance: none !important;
                appearance: none !important;
            }
            
            input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
                border-color: #FFB200 !important;
                box-shadow: 
                    0 0 0 3px rgba(255, 178, 0, 0.2),
                    0 4px 12px rgba(0, 0, 0, 0.3) !important;
                background: rgba(255, 255, 255, 0.15) !important;
                transform: translateY(-1px) !important;
            }
            
            input[type="text"]::placeholder, input[type="email"]::placeholder, input[type="password"]::placeholder {
                color: rgba(255, 255, 255, 0.6) !important;
                font-weight: 300 !important;
            }
            
            /* Prevent zoom on mobile */
            @media screen and (max-width: 768px) {
                input[type="text"], input[type="email"], input[type="password"] {
                    font-size: 16px !important;
                }
            }
        `;
        document.head.appendChild(cursorStyle);

        // Enhanced data refresh with loading animation - OPTIMIZED
        async function refreshUserDataWithAnimation() {
            if (!currentUser) return;
            
            // Show loading animation
            const refreshBtn = document.querySelector('.btn[onclick*="refreshUserData"]');
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                refreshBtn.disabled = true;
                
                try {
                    // Use requestAnimationFrame for smoother UI updates
                    await new Promise(resolve => {
                        requestAnimationFrame(async () => {
                            await loadUserData();
                            resolve();
                        });
                    });
                    showEnhancedNotification('âœ… Data refreshed successfully!', 'success');
                } catch (error) {
                    showEnhancedNotification('âŒ Failed to refresh data', 'error');
                } finally {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        // Global refresh function
        window.refreshUserData = refreshUserDataWithAnimation;
        
        // Get appropriate icon for a job; default to briefcase (no project type taxonomy)
        function getJobIcon() {
            return 'briefcase';
        }

        // Track selected job
        let selectedJobIndex = 0;
        
        // Select a job and update context
        function selectJob(jobIndex, jobId) {
            selectedJobIndex = jobIndex;
            
            const jobOptions = document.querySelectorAll('.job-option');
            jobOptions.forEach((option, index) => {
                if (index === jobIndex) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            console.log('Selected job:', jobIndex, jobId);
            
            // Update the jobs tab to show the selected job's timeline
            displayUserJobs();
            
            // Refresh timeline data from JSON files
            refreshTimelineData();
        }

        // Refresh timeline data from all JSON sources
        function refreshTimelineData() {
            console.log('ðŸ”„ Refreshing timeline data from JSON files...');
            
            // Reload data from all JSON files
            Promise.all([
                loadUploadedContracts(),
                loadUsersData(),
                loadJobsData(),
                loadPerformanceReviews()
            ]).then(() => {
                console.log('âœ… Timeline data refreshed from all JSON sources');
                
                // Update timeline display
                if (currentUser) {
                    displayUserJobs();
                }
            }).catch(error => {
                console.error('âŒ Error refreshing timeline data:', error);
            });
        }

        // Get the currently selected job
        function getSelectedJob() {
            if (!currentUser || !currentUser.jobs) {
                return null;
            }
            
            const userJobs = Object.values(currentUser.jobs);
            if (userJobs.length === 0) {
                return null;
            }
            
            // Return the selected job or the primary job
            const selectedJob = userJobs[selectedJobIndex] || userJobs[0];
            return selectedJob;
        }
        // Compute effective project start date favoring the job listing's own date
        function getEffectiveProjectStartDate() {
            if (!currentUser) return '';
            const selectedJob = getSelectedJob();
            const userJob = selectedJob ? (currentUser.jobs && currentUser.jobs[selectedJob.id]) : null;
            // Prefer Firestore job listing date if we can match by id or title
            let listingDate = '';
            try {
                if (Array.isArray(jobsData) && jobsData.length) {
                    const byId = jobsData.find(j => j && selectedJob && (j.id === selectedJob.id));
                    const byTitle = !byId && selectedJob ? jobsData.find(j => String(j.title||j.role||'').toLowerCase() === String(selectedJob.title||selectedJob.role||'').toLowerCase()) : null;
                    const listing = byId || byTitle;
                    listingDate = listing?.date || listing?.projectStart || '';
                }
            } catch(_) {}
            return (
                listingDate ||
                (userJob && (userJob.projectStart || userJob.date)) ||
                (selectedJob && (selectedJob.projectStart || selectedJob.date)) ||
                currentUser.profile?.projectDate ||
                currentUser.profile?.projectStart ||
                currentUser.application?.eventDate ||
                ''
            );
        }
        // Parse various date shapes without timezone drift (treat YYYY-MM-DD as local date)
        function parseDateFlexible(value){
            try {
                if (!value) return null;
                if (typeof value === 'number') return new Date(value);
                if (value && typeof value.toDate === 'function') return value.toDate(); // Firestore Timestamp
                if (typeof value === 'string'){
                    const cleaned = value.replace(/(\d+)(st|nd|rd|th)/gi, '$1').trim();
                    const ymd = cleaned.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                    if (ymd){
                        const y = parseInt(ymd[1],10), m = parseInt(ymd[2],10)-1, d = parseInt(ymd[3],10);
                        // Noon local avoids DST midnight edge cases
                        return new Date(y, m, d, 12, 0, 0, 0);
                    }
                    return new Date(cleaned);
                }
                return new Date(value);
            } catch(_) { return null; }
        }
        function formatDisplayDate(dateStr) {
            const d = parseDateFlexible(dateStr);
            return (d && !isNaN(d.getTime())) ? d.toLocaleDateString() : 'TBD';
        }
        // Fix timezone issues with date strings
        function fixTimezone(dateString) {
            if (!dateString) return null;
            
            try {
                // If it's already a valid date, return as is
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return dateString;
                }
                
                // Handle various date formats
                let fixedDate = dateString;
                
                // If it's a date without time, add default time
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    fixedDate = dateString + 'T00:00:00';
                }
                
                // If it's a date with time but no timezone, assume local
                if (dateString.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/)) {
                    fixedDate = dateString + 'Z';
                }
                
                // Test if the fixed date is valid
                const testDate = new Date(fixedDate);
                if (!isNaN(testDate.getTime())) {
                    return fixedDate;
                }
                
                return dateString; // Return original if all fixes fail
            } catch (error) {
                console.warn('âš ï¸ Error fixing timezone for date:', dateString, error);
                return dateString;
            }
        }

        // Get job status based on project start date
        function getJobStatus(projectStart) {
            if (!projectStart) return 'upcoming';
            
            try {
                const startDate = parseDateFlexible(projectStart);
                const now = new Date();
                
                if (isNaN(startDate.getTime())) {
                    return 'upcoming';
                }
                
                if (startDate > now) {
                    return 'upcoming';
                } else if (startDate <= now && startDate >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)) {
                    return 'in-progress';
                } else {
                    return 'completed';
                }
            } catch (error) {
                console.warn('âš ï¸ Error determining job status:', error);
                return 'upcoming';
            }
        }

        // Get contract signed status
        function getContractSignedStatus() {
            if (!currentUser) return 'No contract found';
            
            const contract = currentUser.contract;
            if (!contract) return 'No contract found';
            
            if (contract.contractStatus === 'signed') {
                return 'Contract signed';
            } else if (contract.contractStatus === 'pending') {
                return 'Contract pending';
            } else {
                return 'Contract not found';
            }
        }

        // Get project timeline
        function getProjectTimeline() {
            const selectedJob = getSelectedJob();
            if (!selectedJob) return [];
            const listingStart = getListingStartDateFor(selectedJob) || selectedJob.projectStart || selectedJob.date || getEffectiveProjectStartDate();
            const listingStartDate = parseDateFlexible(listingStart);
            
            const timeline = [
                {
                    id: 'contract',
                    title: 'Contract Review',
                    description: 'Review and sign your freelance contract',
                    icon: 'fas fa-file-contract',
                    status: currentUser.contract?.contractStatus === 'signed' ? 'completed' : 'pending',
                    date: currentUser.contract?.contractSignedDate,
                    details: 'Your contract has been prepared and is ready for review.',
                    action: 'Sign contract to proceed'
                },
                {
                    id: 'payment',
                    title: 'Payment Setup',
                    description: 'Configure your preferred payment method',
                    icon: 'fas fa-credit-card',
                    status: currentUser.paymentMethod ? 'completed' : 'pending',
                    date: null,
                    details: 'Set up your preferred payment method for project payments.',
                    action: { onclick: 'showPaymentModal()', text: 'Configure', icon: 'fas fa-credit-card' }
                },
                {
                    id: 'project',
                    title: 'Project Start',
                    description: 'Begin your assigned project',
                    icon: 'fas fa-play-circle',
                    status: getJobStatus(listingStartDate),
                    date: listingStartDate,
                    details: 'Your project is ready to begin. Review project details and start working.',
                    action: 'View project details'
                },
                {
                    id: 'completion',
                    title: 'Project Completion',
                    description: 'Submit final deliverables',
                    icon: 'fas fa-check-circle',
                    status: 'upcoming',
                    date: null,
                    details: 'Submit your final deliverables and project documentation.',
                    action: 'Submit deliverables'
                }
            ];
            
            return timeline;
        }

        // Get current timeline step
        function getCurrentTimelineStep() {
            const timeline = getProjectTimeline();
            const currentStep = timeline.find(step => step.status === 'pending' || step.status === 'in-progress');
            
            if (currentStep) {
                return {
                    title: currentStep.title,
                    description: currentStep.description,
                    icon: currentStep.icon,
                    details: currentStep.details
                };
            }
            
            // Default to first step if no current step found
            return {
                title: 'Getting Started',
                description: 'Welcome to your project!',
                icon: 'fas fa-rocket',
                details: 'Your project is being set up. Please review your contract and configure payment.'
            };
        }
        // Get project progress percentage
        function getProjectProgress() {
            const timeline = getProjectTimeline();
            const completedSteps = timeline.filter(step => step.status === 'completed').length;
            const totalSteps = timeline.length;
            
            return Math.round((completedSteps / totalSteps) * 100);
        }

        // Contact support function
        function contactSupport() {
            const supportEmail = 'support@cochranfilms.com';
            const supportPhone = '(555) 123-4567';
            
            showNotification(`Contact support at ${supportEmail} or call ${supportPhone}`, 'info');
        }

        // Check for automatic project status updates
        async function checkAutomaticProjectStatusUpdates() {
            if (!currentUser || !currentUser.jobs) return;
            
            const userJobs = Object.values(currentUser.jobs);
            for (const job of userJobs) {
                const currentStatus = job.projectStatus || 'upcoming';
                const calculatedStatus = getJobStatus(job.projectStart);
                
                if (currentStatus !== calculatedStatus) {
                    console.log(`ðŸ”„ Auto-updating job status to ${calculatedStatus}: ${job.id}`);
                    
                    // Update the job status
                    job.projectStatus = calculatedStatus;
                    
                    // Log status change to console (removed popup notification)
                    if (calculatedStatus === 'in-progress') {
                        console.log('âœ… [SUCCESS] Your project has started and is now in progress.');
                    } else if (calculatedStatus === 'completed') {
                        console.log('âœ… [SUCCESS] Your project has been completed!');
                    }
                    
                    console.log(`âœ… Updated job status: ${job.id} to ${calculatedStatus}`);
                }
            }
        }

        // Display user contracts (integrated with Firestore contracts)
        function displayUserContracts() {
            const container = document.getElementById('contractsContent');
            if (!container) {
                console.warn('âš ï¸ contractsContent container not found in DOM');
                return;
            }
            
            if (!currentUser) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ User Data Missing</h3>
                        <p>Unable to load contract information.</p>
                    </div>
                `;
                return;
            }

            // Get contract status from centralized data (job-specific if available)
            const currentJobId = getSelectedJob() ? getSelectedJob().id : Object.keys(currentUser.jobs || {})[0];
            const userContract = getUserContractStatus(currentUser.email, currentJobId);
            const contractStatus = userContract ? 'uploaded' : currentUser.contractStatus || 'pending';
            
            // Contract status based UI
            if (contractStatus === 'pending') {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="status-icon" style="font-size: 3rem; color: #FFB200; margin-bottom: 1rem;">
                            <i class="fas fa-pen-fancy"></i>
                        </div>
                        <h3>ðŸ“‹ Contract Ready for Signature</h3>
                        <p>Your contract is ready for digital signature. Please sign to proceed with your project.</p>
                        <a href="https://collaborate.cochranfilms.com/contract" class="btn" style="margin-top: 1rem;">
                            <i class="fas fa-signature"></i> Sign Contract Now
                        </a>
                    </div>
                `;
                return;
            }
            
            if (contractStatus === 'signed') {
                let signedDate = 'Processing...';
                if (userContract && userContract.signedDate) {
                    signedDate = formatContractSignedDate(userContract.signedDate);
                } else if (currentUser.contractSignedDate) {
                    signedDate = formatContractSignedDate(currentUser.contractSignedDate);
                }
                const contractId = userContract ? userContract.contractId : currentUser.contractId || 'Generating...';
                
                container.innerHTML = `
                    <div class="pending-state">
                        <div class="status-icon" style="font-size: 3rem; color: #FFB200; margin-bottom: 1rem;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3>â³ Contract Processing</h3>
                        <p>Thank you! Your contract has been digitally signed and is being processed by our admin team.</p>
                        <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; border: 1px solid rgba(255,178,0,0.3);">
                            <h4 style="color: #FFB200; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Status Details</h4>
                            <div style="color: rgba(255,255,255,0.9);">
                                <div><strong>Signed Date:</strong> ${signedDate}</div>
                                <div><strong>Contract ID:</strong> ${contractId}</div>
                                <div><strong>Status:</strong> Awaiting admin processing</div>
                            </div>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                            <i class="fas fa-clock"></i> You'll be able to download your contract once it's been uploaded by our admin team.
                        </p>
                    </div>
                `;
                return;
            }
            
            if (contractStatus === 'uploaded') {
                let signedDate = 'Processing...';
                if (userContract && userContract.signedDate) {
                    signedDate = formatContractSignedDate(userContract.signedDate);
                } else if (currentUser.contractSignedDate) {
                    signedDate = formatContractSignedDate(currentUser.contractSignedDate);
                }
                const contractId = userContract ? userContract.contractId : currentUser.contractId || 'Generating...';
                
                container.innerHTML = `
                    <div class="contract-card">
                        <div class="contract-header">
                            <h4><i class="fas fa-file-contract"></i> ${getSelectedJob()?.title || getSelectedJob()?.role || currentUser.profile?.role || 'Assistant Position'}</h4>
                            <span class="status-badge signed">âœ… CONTRACT COMPLETE</span>
                        </div>
                        <div class="contract-details">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div><strong>Contract ID:</strong> ${contractId}</div>
                                <div><strong>Signed Date:</strong> ${signedDate}</div>
                                <div><strong>Uploaded Date:</strong> ${userContract && userContract.signedDate ? formatContractSignedDate(userContract.signedDate) : 'N/A'}</div>
                                <div><strong>Rate:</strong> ${currentUser.jobs ? Object.values(currentUser.jobs)[0]?.pay || Object.values(currentUser.jobs)[0]?.rate || '$75/hour' : currentUser.rate || '$75/hour'}</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                                <p style="color: #22c55e; margin: 0; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Your contract is fully executed and available for download.
                                </p>
                            </div>
                        </div>
                        <div class="contract-actions" style="margin-top: 1rem;">
                                                    <button class="btn btn-small btn-success" onclick="downloadUserContract('${currentJobId}')" style="cursor: pointer; z-index: 10; position: relative;">
                            <i class="fas fa-download"></i> Download Contract PDF
                        </button>
                            <button class="btn btn-small" onclick="viewContractDetails()" style="cursor: pointer; z-index: 10; position: relative;">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            

        }

        // Display user performance reviews
        function displayUserPerformanceReviews() {
            const container = document.getElementById('performanceContent');
            if (!container) {
                console.warn('âš ï¸ performanceContent container not found in DOM');
                return;
            }
            
            if (!currentUser) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ User Data Missing</h3>
                        <p>Unable to load performance review information.</p>
                    </div>
                `;
                return;
            }

            // Load performance reviews from API
            loadUserPerformanceReviews(currentUser.email);
        }
        // Load and display user's performance reviews (Firestore only)
        async function loadUserPerformanceReviews(userEmail) {
            const container = document.getElementById('performanceContent');
            if (!container) {
                console.warn('âš ï¸ performanceContent container not found in DOM');
                return;
            }
            
            try {
                console.log('ðŸ” Loading performance reviews for:', userEmail);
                // Load from Firestore users collection
                let userReview = null;
                let currentUserData = null;
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const fsUsersObj = await window.FirestoreDataManager.getUsers();
                    for (const [userName, userData] of Object.entries(fsUsersObj || {})) {
                        if (userData?.profile?.email && userData.profile.email.toLowerCase() === String(userEmail).toLowerCase()) {
                            currentUserData = userData;
                            userReview = userData.performance;
                            break;
                        }
                    }
                }
                
                if (!userReview) {
                    const userName = currentUser?.profile?.name || currentUser?.profile?.email?.split('@')[0] || 'Team Member';
                    const userJob = getSelectedJob();
                    const jobTitle = userJob ? userJob.title : 'your position';
                    
                    container.innerHTML = `
                        <div class="empty-state" style="background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(20,20,20,0.9) 100%); border: 1px solid rgba(255,178,0,0.3); border-radius: 16px; padding: 2rem; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                            
                            <!-- Personalized Welcome Header -->
                            <div style="margin-bottom: 2rem;">
                                <div style="font-size: 3rem; color: #FFB200; margin-bottom: 1rem;">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <h2 style="color: #FFB200; margin-bottom: 0.5rem; font-family: 'Cinzel', serif; font-size: 1.8rem;">
                                    Welcome, ${userName}! 
                                </h2>
                                <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 1rem;">
                                    We're excited to have you on the Cochran Films team
                                </p>
                            </div>
                            
                            <!-- Status Icon and Message -->
                            <div style="margin-bottom: 2rem;">
                                <div class="status-icon" style="font-size: 4rem; color: #FFB200; margin-bottom: 1rem;">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 style="color: #FFB200; margin-bottom: 1rem; font-size: 1.4rem;">
                                    â³ Performance Review Coming Soon
                                </h3>
                                <p style="color: rgba(255,255,255,0.9); line-height: 1.6; margin-bottom: 1.5rem;">
                                    Your performance review for <strong style="color: #FFB200;">${jobTitle}</strong> hasn't been completed yet. 
                                    We're committed to providing you with detailed, constructive feedback to support your growth.
                                </p>
                            </div>
                            
                            <!-- Information Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                                <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,178,0,0.2);">
                                    <div style="font-size: 2rem; color: #FFB200; margin-bottom: 0.5rem;">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <h4 style="color: #FFB200; margin-bottom: 0.5rem;">Review Timeline</h4>
                                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">
                                        Reviews typically completed within 1-2 weeks of project completion
                                    </p>
                                </div>
                                
                                <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,178,0,0.2);">
                                    <div style="font-size: 2rem; color: #FFB200; margin-bottom: 0.5rem;">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <h4 style="color: #FFB200; margin-bottom: 0.5rem;">Review Categories</h4>
                                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">
                                        Professionalism, Quality, Communication, Reliability, Overall Performance
                                    </p>
                                </div>
                                
                                <div style="background: rgba(255,178,0,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,178,0,0.2);">
                                    <div style="font-size: 2rem; color: #FFB200; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h4 style="color: #FFB200; margin-bottom: 0.5rem;">Review Process</h4>
                                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">
                                        Completed by admin after project milestones and key deliverables
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Encouragement Section -->
                            <div style="background: linear-gradient(135deg, rgba(255,178,0,0.1) 0%, rgba(255,178,0,0.05) 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,178,0,0.2);">
                                <h4 style="color: #FFB200; margin-bottom: 1rem; font-size: 1.2rem;">
                                    <i class="fas fa-seedling"></i> Your Growth Journey
                                </h4>
                                <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem; line-height: 1.6;">
                                    At Cochran Films, we believe in continuous improvement and are committed to supporting your professional development. 
                                    Your performance review will provide valuable insights to help you excel in your role.
                                </p>
                                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                    <div style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem;">
                                        <i class="fas fa-lightbulb"></i> Learning Focus
                                    </div>
                                    <div style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem;">
                                        <i class="fas fa-rocket"></i> Growth Mindset
                                    </div>
                                    <div style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem;">
                                        <i class="fas fa-handshake"></i> Team Support
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Get user's job information for personalized header
                const userJob = getSelectedJob();
                const jobTitle = userJob ? userJob.title : 'Your Position';
                const userName = currentUser?.profile?.name || currentUser?.profile?.email?.split('@')[0] || 'Team Member';
                
                // Display the performance review
                let reviewDate = 'N/A';
                if (userReview.reviewDate) {
                    try {
                        const date = new Date(userReview.reviewDate);
                        if (!isNaN(date.getTime())) {
                            reviewDate = date.toLocaleDateString();
                        } else {
                            console.warn('âš ï¸ Invalid performance review date:', userReview.reviewDate);
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Error formatting performance review date:', error);
                    }
                }
                const overallRating = userReview.overallRating || 'Not rated';
                const categories = {
                    Professionalism: userReview.professionalism || (userReview.categories && userReview.categories.Professionalism),
                    Communication: userReview.communication || (userReview.categories && userReview.categories.Communication),
                    Timeliness: userReview.timeliness || (userReview.categories && userReview.categories.Timeliness),
                    Quality: userReview.quality || (userReview.categories && userReview.categories.Quality),
                    Reliability: userReview.reliability || (userReview.categories && userReview.categories.Reliability)
                };
                const strengths = Array.isArray(userReview.strengths) ? userReview.strengths : (userReview.strengths ? String(userReview.strengths).split(',').map(s=>s.trim()).filter(Boolean) : []);
                const improvements = Array.isArray(userReview.areasForImprovement) ? userReview.areasForImprovement : (userReview.areasForImprovement ? String(userReview.areasForImprovement).split(',').map(s=>s.trim()).filter(Boolean) : []);
                const goals = Array.isArray(userReview.goals) ? userReview.goals : (userReview.goals ? String(userReview.goals).split(',').map(s=>s.trim()).filter(Boolean) : []);
                
                container.innerHTML = `
                    <div class="performance-review-card" style="background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(20,20,20,0.9) 100%); border: 1px solid rgba(255,178,0,0.3); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        
                        <!-- Personalized Welcome Header -->
                        <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(255,178,0,0.2);">
                            <div style="font-size: 2.5rem; color: #FFB200; margin-bottom: 0.5rem;">
                                <i class="fas fa-heart"></i>
                            </div>
                            <h2 style="color: #FFB200; margin-bottom: 0.5rem; font-family: 'Cinzel', serif; font-size: 1.8rem;">
                                Welcome back, ${userName}! 
                            </h2>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 1rem;">
                                We're committed to your growth and success at Cochran Films
                            </p>
                            <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255,178,0,0.2);">
                                <p style="color: rgba(255,255,255,0.9); margin: 0; font-style: italic;">
                                    <i class="fas fa-quote-left" style="color: #FFB200; margin-right: 0.5rem;"></i>
                                    Your performance review helps us understand how we can better support your professional development and ensure your continued success with our team.
                                    <i class="fas fa-quote-right" style="color: #FFB200; margin-left: 0.5rem;"></i>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Job-Specific Review Card -->
                        <div style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid rgba(255,178,0,0.2);">
                            <div class="review-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="color: #FFB200; margin: 0; font-size: 1.4rem;">
                                    <i class="fas fa-star"></i> ${jobTitle} Performance Review
                                </h3>
                                <span class="review-date" style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600;">
                                    ${reviewDate}
                                </span>
                            </div>
                            
                            <div class="review-summary" style="margin-bottom: 2rem;">
                                <div class="overall-rating">
                                    <h4 style="color: #FFB200; margin-bottom: 1rem; font-size: 1.2rem;">
                                        <i class="fas fa-trophy"></i> Overall Performance Rating
                                    </h4>
                                    <div class="rating-display" style="display: flex; align-items: center; gap: 1rem; background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; box-shadow: 0 6px 20px rgba(255,178,0,0.08) inset;">
                                        <span class="rating-number" style="font-size: 2rem; font-weight: bold; color: #FFB200;">${overallRating}/5</span>
                                        <div class="rating-stars" style="font-size: 1.5rem;">
                                            ${generateStarRating(overallRating)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="review-categories">
                                <h4 style="color: #FFB200; margin-bottom: 1rem; font-size: 1.2rem;">
                                    <i class="fas fa-chart-bar"></i> Detailed Category Ratings
                                </h4>
                                <div style="display: grid; gap: 1rem;">
                                    ${Object.entries(categories).filter(([_,rating])=>rating!=null && rating!=='').map(([category, rating]) => `
                                        <div class="category-item" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255,178,0,0.1);">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div class="category-name" style="color: rgba(255,255,255,0.9); font-weight: 600;">${category}</div>
                                                <div class="category-rating" style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span class="rating-number" style="color: #FFB200; font-weight: bold;">${rating}/5</span>
                                                    <div class="rating-stars" style="font-size: 1rem;">
                                                        ${generateStarRating(rating)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        ${(strengths.length || improvements.length || goals.length) ? `
                            <div class="review-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                ${strengths.length ? `
                                    <div style=\"background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1rem; border: 1px solid rgba(255,178,0,0.2);\">
                                        <h4 style=\"color: #FFB200; margin-bottom: .75rem; font-size: 1.05rem;\"><i class=\"fas fa-thumbs-up\"></i> Strengths</h4>
                                        <ul style=\"margin:0;padding-left:1rem;color:rgba(255,255,255,.9);\">
                                            ${strengths.map(s=>`<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>`: ''}
                                ${improvements.length ? `
                                    <div style=\"background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1rem; border: 1px solid rgba(255,178,0,0.2);\">
                                        <h4 style=\"color: #FFB200; margin-bottom: .75rem; font-size: 1.05rem;\"><i class=\"fas fa-wrench\"></i> Areas for Improvement</h4>
                                        <ul style=\"margin:0;padding-left:1rem;color:rgba(255,255,255,.9);\">
                                            ${improvements.map(s=>`<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>`: ''}
                                ${goals.length ? `
                                    <div style=\"background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1rem; border: 1px solid rgba(255,178,0,0.2);\">
                                        <h4 style=\"color: #FFB200; margin-bottom: .75rem; font-size: 1.05rem;\"><i class=\"fas fa-bullseye\"></i> Goals</h4>
                                        <ul style=\"margin:0;padding-left:1rem;color:rgba(255,255,255,.9);\">
                                            ${goals.map(s=>`<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>`: ''}
                            </div>
                        ` : ''}

                        ${userReview.notes || userReview.comments ? `
                            <div class="review-comments" style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid rgba(255,178,0,0.2);">
                                <h4 style="color: #FFB200; margin-bottom: 1rem; font-size: 1.2rem;">
                                    <i class="fas fa-comments"></i> Feedback & Comments
                                </h4>
                                <div class="comments-text" style="color: rgba(255,255,255,0.9); line-height: 1.6; font-style: italic; background: rgba(255,178,0,0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid #FFB200;">
                                    ${userReview.comments ? `"${userReview.comments}"` : ''}
                                    ${userReview.notes ? `<div style='font-style:normal;opacity:.9;margin-top:.5rem;'>${userReview.notes}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="review-footer" style="text-align: center; padding-top: 1.5rem; border-top: 2px solid rgba(255,178,0,0.2);">
                            <div class="review-status" style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(34,197,94,0.2); color: #22c55e; padding: 0.75rem 1.5rem; border-radius: 8px; border: 1px solid rgba(34,197,94,0.3);">
                                <i class="fas fa-check-circle"></i>
                                <span style="font-weight: 600;">Review Completed</span>
                            </div>
                        </div>
                        
                        <!-- Growth Encouragement Section -->
                        <div style="background: linear-gradient(135deg, rgba(255,178,0,0.1) 0%, rgba(255,178,0,0.05) 100%); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; border: 1px solid rgba(255,178,0,0.2); text-align: center;">
                            <h4 style="color: #FFB200; margin-bottom: 1rem; font-size: 1.2rem;">
                                <i class="fas fa-seedling"></i> Your Growth Journey
                            </h4>
                            <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem; line-height: 1.6;">
                                We believe in continuous improvement and are here to support your professional development. 
                                Use this feedback to identify areas for growth and celebrate your strengths!
                            </p>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                <div style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem;">
                                    <i class="fas fa-lightbulb"></i> Learning Opportunity
                                </div>
                                <div style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem;">
                                    <i class="fas fa-rocket"></i> Growth Focus
                                </div>
                                <div style="background: rgba(255,178,0,0.2); color: #FFB200; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem;">
                                    <i class="fas fa-handshake"></i> Team Support
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('âŒ Error loading performance reviews:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ Error Loading Reviews</h3>
                        <p>Unable to load performance review data. Please try again later.</p>
                    </div>
                `;
            }
        }
        // Generate star rating display
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let stars = '';
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star" style="color: #FFB200;"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt" style="color: #FFB200;"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star" style="color: #FFB200;"></i>';
            }
            return stars;
        }

        // Display user jobs
        function displayUserJobs() {
            const container = document.getElementById('jobsContent');
            
            if (!currentUser) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ User Data Missing</h3>
                        <p>Unable to load job information.</p>
                    </div>
                `;
                return;
            }

            // Render all job timelines for this user
            try {
                displayCurrentJobs();
            } catch (error) {
                console.warn('âš ï¸ Error displaying current jobs:', error);
            }
        }
        // Normalize project status strings into canonical values
        function normalizeProjectStatus(status) {
            const s = String(status || '').toLowerCase();
            if (s === 'in progress') return 'in-progress';
            if (s === 'active') return 'in-progress';
            if (s === 'complete') return 'completed';
            if (s === 'pending') return 'upcoming';
            if (['upcoming','in-progress','completed','cancelled','canceled','on-hold','on hold'].includes(s)) {
                return s === 'canceled' ? 'cancelled' : (s === 'on hold' ? 'on-hold' : s);
            }
            return 'upcoming';
        }
        // Display jobs with project status
        async function displayJobsWithStatus() {
            const container = document.getElementById('jobsContent');
            if (!container) {
                console.warn('âš ï¸ jobsContent container not found in DOM');
                return;
            }
            
            // Reduced logging - only log once per session
            if (!sessionStorage.getItem('displayJobsDebugLogged')) {
                console.log('ðŸ” Debugging displayJobsWithStatus:');
                console.log('Current user:', currentUser);
                console.log('Current user jobs:', currentUser?.jobs);
                console.log('Selected job index:', selectedJobIndex);
                sessionStorage.setItem('displayJobsDebugLogged', 'true');
            }
            
            // Ensure performance reviews are loaded before displaying timeline
            if (Object.keys(performanceReviews).length === 0) {
                console.log('ðŸ”„ Loading performance reviews before displaying timeline...');
                await loadPerformanceReviews();
            }
            
            // Ensure a primary job exists for fallback
            if (!currentUser.primaryJob && currentUser.jobs && Object.keys(currentUser.jobs).length) {
                try { currentUser.primaryJob = Object.keys(currentUser.jobs)[0]; } catch (_) {}
            }

            // Get the selected job or fall back to primary job
            const selectedJob = getSelectedJob();
            console.log('Selected job:', selectedJob);
            
            if (!selectedJob) {
                console.log('âŒ No selected job found');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ðŸ“‹ No Jobs Available</h3>
                        <p>No job assignments found for your account.</p>
                    </div>
                `;
                return;
            }

            // Get project status for this job from users data with robust fallbacks
            const userJob = currentUser.jobs[selectedJob.id] || currentUser.jobs[currentUser.primaryJob] || null;
            const rawStatus = (userJob && (userJob.projectStatus || userJob.status)) || (currentUser.profile && currentUser.profile.projectStatus) || 'upcoming';
            const jobProjectStatus = userJob ? {
                projectStatus: normalizeProjectStatus(rawStatus),
                paymentStatus: userJob.paymentStatus || 'pending'
            } : {
                projectStatus: normalizeProjectStatus(rawStatus),
                paymentStatus: 'pending'
            };

            // If no explicit status exists, default to upcoming until event date
            if ((!userJob || !userJob.projectStatus) && (!rawStatus || rawStatus === 'upcoming')) {
                const start = (userJob && (userJob.projectStart || userJob.date)) || (currentUser.profile && currentUser.profile.projectDate) || selectedJob.projectStart || selectedJob.date;
                if (start) {
                    try {
                        const startDate = new Date(start);
                        const now = new Date();
                        if (startDate > now) {
                            jobProjectStatus.projectStatus = 'upcoming';
                        } else if (startDate <= now && jobProjectStatus.projectStatus !== 'completed' && jobProjectStatus.projectStatus !== 'cancelled' && jobProjectStatus.projectStatus !== 'on-hold') {
                            jobProjectStatus.projectStatus = 'in-progress';
                        }
                    } catch (_) {}
                }
            }

            // Display the selected job's information
            const profileProjectDate = (currentUser.profile && currentUser.profile.projectDate) || '';
            const effectiveProjectStart = getEffectiveProjectStartDate() || profileProjectDate;
            const effectiveProjectStatus = jobProjectStatus.projectStatus || 'upcoming';

            const jobInfo = {
                role: selectedJob.title || selectedJob.role || 'Current Position',
                location: selectedJob.location || 'Location TBD',
                projectStart: formatDisplayDate(effectiveProjectStart) || 'Start Date TBD',
                rate: selectedJob.rate || 'Rate TBD',
                status: effectiveProjectStatus || getJobStatus(effectiveProjectStart),
                paymentStatus: jobProjectStatus.paymentStatus || 'pending',
                description: selectedJob.description || 'Project details to be provided.'
            };

            // Add job selector if user has multiple jobs
            const userJobsArray = Object.values(currentUser.jobs || {}).map((j, idx) => ({
                ...j,
                id: j.id || j.jobId || Object.keys(currentUser.jobs)[idx],
                projectStart: j.projectStart || j.date || (currentUser.profile && currentUser.profile.projectDate) || ''
            }));
            const jobSelectorHTML = userJobsArray.length > 1 ? `
                <div class="job-selector-header">
                    <h3>Your Jobs:</h3>
                    <div class="job-tabs">
                        ${userJobsArray.map((job, index) => `
                            <button class="job-tab ${index === selectedJobIndex ? 'active' : ''}" 
                                    onclick="selectJob(${index}, '${job.id}')">
                                <i class="fas fa-${getJobIcon()}"></i>
                                ${job.title || job.role}
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            container.innerHTML = `
                ${jobSelectorHTML}
                <div class="job-card">
                    <div class="job-header">
                        <div>
                            <h3>${jobInfo.role}</h3>
                            <p class="job-location"><i class="fas fa-map-marker-alt"></i> ${jobInfo.location}</p>
                        </div>
                        <div class="status-container">
                            <span class="job-status ${jobInfo.status.toLowerCase().replace(/\s+/g,'-')}">${jobInfo.status}</span>
                            <span class="payment-status ${jobInfo.paymentStatus.toLowerCase()}">${jobInfo.paymentStatus}</span>
                        </div>
                    </div>
                    
                    <div class="job-details">
                        <div class="job-detail-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>Project Start</strong>
                                <span>${formatDisplayDate(jobInfo.projectStart || getEffectiveProjectStartDate())}</span>
                            </div>
                        </div>
                        <div class="job-detail-item">
                            <i class="fas fa-dollar-sign"></i>
                            <div>
                                <strong>Rate</strong>
                                <span>${jobInfo.rate}</span>
                            </div>
                        </div>

                    </div>
                    
                    <div class="job-actions">
                        <button class="btn job-action-btn secondary" onclick="viewJobDetails()">
                            <i class="fas fa-info-circle"></i> Job Details
                        </button>
                    </div>
                </div>
                
                <div class="job-timeline">
                    <div class="timeline-header">
                        <h4><i class="fas fa-history"></i> Project Timeline</h4>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="progress-indicator">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${getProjectProgress()}%"></div>
                                </div>
                                <span class="progress-text">${getProjectProgress()}% Complete</span>
                            </div>
                            <button onclick="refreshTimelineData()" style="
                                background: rgba(34, 197, 94, 0.1);
                                color: #22c55e;
                                border: 1px solid rgba(34, 197, 94, 0.3);
                                padding: 0.5rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.9rem;
                                transition: all 0.3s ease;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            " title="Refresh timeline data">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="current-status">
                        <div class="status-card">
                            <div class="status-icon">
                                <i class="${getCurrentTimelineStep().icon}"></i>
                            </div>
                            <div class="status-content">
                                <h5>Current Step: ${getCurrentTimelineStep().title}</h5>
                                <p>${getCurrentTimelineStep().description}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline">
                        ${getProjectTimeline().map(step => `
                            <div class="timeline-item ${step.status}" data-step="${step.id}">
                                <div class="timeline-icon">
                                    <i class="${step.icon}"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-main">
                                        <strong>${step.title}</strong>
                                        <span>${step.description}</span>
                                        ${step.date ? `<small class="timeline-date">${(() => {
                                            try {
                                                if (step.date instanceof Date) {
                                                    return !isNaN(step.date.getTime()) ? step.date.toLocaleDateString() : 'Invalid Date';
                                                } else {
                                                    const date = new Date(step.date);
                                                    return !isNaN(date.getTime()) ? date.toLocaleDateString() : 'Invalid Date';
                                                }
                                            } catch (error) {
                                                console.warn('âš ï¸ Error formatting timeline date:', error);
                                                return 'Invalid Date';
                                            }
                                        })()}</small>` : ''}
                                    </div>
                                    
                                    ${step.status === 'current' ? `
                                        <div class="timeline-details">
                                            <p>${step.details}</p>
                                            ${step.action ? `
                                                ${step.action.url ? 
                                                    `<a href="${step.action.url}" class="timeline-action">
                                                        <i class="${step.action.icon}"></i> ${step.action.text}
                                                    </a>` :
                                                    `<button onclick="${step.action.onclick}" class="timeline-action" style="border: none; background: linear-gradient(135deg, #FFB200, #FFD700); color: #000; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                                                        <i class="${step.action.icon}"></i> ${step.action.text}
                                                    </button>`
                                                }
                                            ` : ''}
                                            ${step.checklist ? `
                                                <div class="timeline-checklist">
                                                    <h6>ðŸ“‹ Preparation Checklist:</h6>
                                                    <ul>
                                                        ${step.checklist.map(item => `<li>${item}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            ${step.requirements ? `
                                                <div class="timeline-requirements">
                                                    <h6>ðŸ“ Requirements:</h6>
                                                    <ul>
                                                        ${step.requirements.map(item => `<li>${item}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    
                                    <button class="timeline-expand" onclick="toggleTimelineDetails('${step.id}')">
                                        <i class="fas fa-chevron-down"></i> ${step.status === 'current' ? 'Hide' : 'Show'} Details
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Helper function to determine job status (canonical: 'upcoming' | 'in-progress' | 'completed')
        function getJobStatus(projectStart) {
            try {
                if (!projectStart || projectStart === 'TBD') return 'upcoming';
                const startDate = parseDateFlexible(projectStart);
                const now = new Date();
                if (!startDate || isNaN(startDate.getTime())) return 'upcoming';
                if (startDate > now) return 'upcoming';
                if (startDate <= now && startDate >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)) return 'in-progress';
                return 'completed';
            } catch (_) {
                return 'upcoming';
            }
        }
        // Helper function to check if contract is signed (centralized)
        function getContractSignedStatus() {
            if (!currentUser) {
                console.log('ðŸ“‹ No current user for contract status check');
                return 'current';
            }
            
            // Check centralized contract structure first
            const userContract = getUserContractStatus(currentUser.email);
            if (userContract) {
                console.log('ðŸ“‹ Contract found in uploaded-contracts.json:', userContract);
                return 'completed';
            }
            
            // Fallback to freelancers.json contract status
            const contractStatus = currentUser.contractStatus || 'pending';
            
            console.log('ðŸ“‹ Contract status check for', currentUser.name, ':', {
                userContract: userContract,
                contractStatus: contractStatus,
                contractId: currentUser.contractId,
                signedDate: currentUser.contractSignedDate,
                uploadedDate: currentUser.contractUploadedDate
            });
            
            // Return 'completed' if contract is uploaded or signed
            const hasSignedContract = contractStatus === 'uploaded' || contractStatus === 'signed';
            
            console.log('ðŸ“‹ Final contract status result:', {
                hasSignedContract: hasSignedContract,
                returning: hasSignedContract ? 'completed' : 'current'
            });
            
            return hasSignedContract ? 'completed' : 'current';
        }
        // Get detailed project timeline with current status - Firestore-first
        function getProjectTimeline() {
            if (!currentUser) return [];
            
            // Performance reviews should be loaded before this function is called
            // Don't load them here to avoid infinite loops
            
            // Get contract status
            const userContract = getUserContractStatus(currentUser.email);
            const contractSigned = userContract ? true : (currentUser.contractStatus === 'uploaded');
            
            // Get project status from users data (normalized, with fallbacks)
            const selectedJob = getSelectedJob();
            const userJob = selectedJob ? currentUser.jobs[selectedJob.id] : null;
            const rawProj = userJob ? (userJob.projectStatus || userJob.status || currentUser.profile?.projectStatus) : (currentUser.profile?.projectStatus || 'upcoming');
            const projectStatus = (typeof normalizeProjectStatus === 'function') ? normalizeProjectStatus(rawProj) : (rawProj || 'upcoming');
            const paymentStatus = userJob ? (userJob.paymentStatus || 'pending') : (currentUser.paymentStatus || 'pending');
            
            // Reduced timeline logging - only log once per session
            if (!sessionStorage.getItem('timelineDataLogged')) {
                console.log('ðŸ” User portal timeline data:', {
                    selectedJob: selectedJob,
                    userJob: userJob,
                    projectStatus: projectStatus,
                    paymentStatus: paymentStatus,
                    currentUserPaymentStatus: currentUser.paymentStatus
                });
                sessionStorage.setItem('timelineDataLogged', 'true');
            }
            
            // Job data from Firestore-loaded jobsData
            const jobData = jobsData.find(job => job.id === selectedJob?.id);
            
            // Parse project start date from selected job
            let projectStartDate = null;
            try {
                if (selectedJob?.projectStart && selectedJob.projectStart !== 'TBD') {
                    const dateStr = selectedJob.projectStart.replace(/(\d+)(st|nd|rd|th)/, '$1');
                    projectStartDate = new Date(dateStr);
                }
            } catch (e) {
                console.warn('Could not parse project start date:', selectedJob?.projectStart);
            }
            
            // Get approved date from freelancers.json
            const approvedDate = currentUser.approvedDate ? new Date(currentUser.approvedDate) : null;
            
            // Reduced timeline sources logging - only log once per session
            if (!sessionStorage.getItem('timelineSourcesLogged')) {
                console.log('ðŸ“Š Timeline Data Sources:', {
                    userContract: userContract,
                    contractSigned: contractSigned,
                    userJob: userJob,
                    projectStatus: projectStatus,
                    paymentStatus: paymentStatus,
                    jobData: jobData,
                    selectedJob: selectedJob,
                    approvedDate: approvedDate
                });
                sessionStorage.setItem('timelineSourcesLogged', 'true');
            }
            const timeline = [
                {
                    id: 'application',
                    title: 'Application Approved',
                    description: 'You\'ve been accepted for this role',
                    icon: 'fas fa-check',
                    status: 'completed',
                    date: approvedDate,
                    details: `Congratulations! You were selected for the ${selectedJob?.role || currentUser.profile?.role} position.`
                },
                {
                    id: 'contract',
                    title: 'Contract & Payment Setup',
                    description: (() => {
                        const contractComplete = contractSigned;
                        const paymentComplete = currentUser.paymentStatus === 'configured' || (currentUser.paymentMethod && currentUser.paymentMethod !== 'pending');
                        
                        if (contractComplete && paymentComplete) return 'Contract & payment setup complete âœ…';
                        if (contractComplete) return 'Contract signed, payment method pending â³';
                        return 'Setup contract and payment method';
                    })(),
                    icon: 'fas fa-file-contract',
                    status: (() => {
                        const contractComplete = contractSigned;
                        const paymentComplete = currentUser.paymentStatus === 'configured' || (currentUser.paymentMethod && currentUser.paymentMethod !== 'pending');
                        
                        if (contractComplete && paymentComplete) return 'completed';
                        if (contractComplete) return 'current';
                        return 'current';
                    })(),
                    date: userContract ? new Date(userContract.signedDate) : (currentUser.contractSignedDate ? new Date(currentUser.contractSignedDate) : null),
                    details: (() => {
                        const contractComplete = contractSigned;
                        const paymentComplete = currentUser.paymentStatus === 'configured' || (currentUser.paymentMethod && currentUser.paymentMethod !== 'pending');
                        
                        if (contractComplete && paymentComplete) {
                            return 'âœ… Your contract has been signed and payment method configured. All terms are now in effect.';
                        } else if (contractComplete) {
                            return 'ðŸ“„ Contract signed successfully! Please configure your payment method in the portal to complete setup.';
                        } else {
                            return 'Please review and sign your freelance contract and configure your payment method.';
                        }
                    })(),
                    action: (() => {
                        const contractComplete = contractSigned;
                        const paymentComplete = currentUser.paymentStatus === 'configured' || (currentUser.paymentMethod && currentUser.paymentMethod !== 'pending');
                        
                        if (contractComplete && paymentComplete) return null;
                        if (contractComplete) {
                            return {
                                text: 'Configure Payment Method',
                                onclick: 'showPaymentModal()',
                                icon: 'fas fa-credit-card',
                                hasDropdown: true
                            };
                        } else {
                            return {
                                text: 'View Contract Status',
                                onclick: 'switchPortalTab("jobs")',
                                icon: 'fas fa-file-contract'
                            };
                        }
                    })()
                },
                {
                    id: 'project-status',
                    title: 'Project Status',
                    description: (() => {
                        switch (projectStatus) {
                            case 'upcoming': return 'Project scheduled â³';
                            case 'in-progress': return 'Project in progress ðŸ”„';
                            case 'completed': return 'Project completed âœ…';
                            case 'on-hold': return 'Project on hold â¸ï¸';
                            case 'cancelled': return 'Project cancelled âŒ';
                            default: return 'Project status pending';
                        }
                    })(),
                    icon: 'fas fa-tasks',
                    status: (() => {
                        switch (projectStatus) {
                            case 'upcoming': return 'current';
                            case 'in-progress': return 'current';
                            case 'completed': return 'completed';
                            case 'on-hold': return 'current';
                            case 'cancelled': return 'cancelled';
                            default: return 'pending';
                        }
                    })(),
                    date: (() => {
                        // Use project start date if available
                        if (selectedJob?.projectStart && selectedJob.projectStart !== 'TBD') {
                            try {
                                return new Date(selectedJob.projectStart);
                            } catch (e) {
                                console.warn('Could not parse project start date:', selectedJob.projectStart);
                            }
                        }
                        return null;
                    })(),
                    details: (() => {
                        switch (projectStatus) {
                            case 'upcoming': 
                                return `ðŸ“… Your project is scheduled to begin on ${selectedJob?.projectStart ? new Date(selectedJob.projectStart).toLocaleDateString() : 'the scheduled date'}. Please prepare for your assignment.`;
                            case 'in-progress': 
                                return `ðŸ”„ Your project is currently in progress. Please check in regularly for updates and complete all assigned tasks.`;
                            case 'completed': 
                                return `âœ… Your project has been completed successfully! Payment will be processed within 24 hours.`;
                            case 'on-hold': 
                                return `â¸ï¸ This project is currently on hold while we await client updates. We'll notify you as soon as it resumes.`;
                            case 'cancelled': 
                                return `âŒ This project has been cancelled. Please contact Cochran Films for more information about this cancellation.`;
                            default: 
                                return `Your project status is being determined. Please check back for updates.`;
                        }
                    })(),
                    action: (() => {
                        if (projectStatus === 'cancelled') {
                            return {
                                text: 'Contact Support',
                                onclick: 'contactSupport()',
                                icon: 'fas fa-headset'
                            };
                        }
                        return null;
                    })()
                },
                {
                    id: 'payment',
                    title: 'Payment Processing',
                    description: (() => {
                        switch (paymentStatus) {
                            case 'pending': return 'Payment pending â³';
                            case 'processing': return 'Payment processing ðŸ”„';
                            case 'paid': return 'Payment completed âœ…';
                            case 'overdue': return 'Payment overdue âš ï¸';
                            default: return 'Payment processing after completion';
                        }
                    })(),
                    icon: 'fas fa-credit-card',
                    status: (() => {
                        switch (paymentStatus) {
                            case 'pending': return 'current';
                            case 'processing': return 'current';
                            case 'paid': return 'completed';
                            case 'overdue': return 'current';
                            default: return 'pending';
                        }
                    })(),
                    date: (() => {
                        if (userJob?.paymentDate) {
                            return new Date(userJob.paymentDate);
                        }
                        return null;
                    })(),
                    details: (() => {
                        const paymentAmount = selectedJob?.pay || selectedJob?.rate || currentUser.rate || '$75/hour';
                        switch (paymentStatus) {
                            case 'pending': 
                                return `â³ Payment of ${paymentAmount} is pending. Payment will be processed within 24 hours of project completion.`;
                            case 'processing': 
                                return `ðŸ”„ Payment of ${paymentAmount} is being processed. You will receive payment within 24 hours.`;
                            case 'paid': 
                                return `âœ… Payment of ${paymentAmount} has been processed successfully on ${userJob?.paymentDate ? new Date(userJob.paymentDate).toLocaleDateString() : 'recent date'}.`;
                            case 'overdue': 
                                return `âš ï¸ Payment of ${paymentAmount} is overdue. Please contact admin for assistance.`;
                            default: 
                                return `You will receive payment of ${paymentAmount} within 24 hours of project completion.`;
                        }
                    })()
                },
                {
                    id: 'performance',
                    title: 'Performance Review',
                    description: (() => {
                        // Check if payment is completed (either 'paid' or project is completed)
                        const paymentCompleted = paymentStatus === 'paid' || projectStatus === 'completed';
                        if (!paymentCompleted) return 'Review available after payment';
                        console.log('ðŸ” Timeline: Getting performance review for user:', currentUser.email);
                        console.log('ðŸ” Timeline: Current user object:', currentUser);
                        console.log('ðŸ” Timeline: Performance reviews loaded:', Object.keys(performanceReviews));
                        const userReview = getUserPerformanceReview(currentUser.email);
                        console.log('ðŸ” Timeline: Review result:', userReview);
                        return userReview ? 'Performance review available âœ…' : 'Performance review pending â³';
                    })(),
                    icon: 'fas fa-star',
                    status: (() => {
                        // Check if payment is completed (either 'paid' or project is completed)
                        const paymentCompleted = paymentStatus === 'paid' || projectStatus === 'completed';
                        if (!paymentCompleted) return 'pending';
                        const userReview = getUserPerformanceReview(currentUser.email);
                        return userReview ? 'completed' : 'current';
                    })(),
                    date: (() => {
                        const userReview = getUserPerformanceReview(currentUser.email);
                        return userReview?.reviewDate ? new Date(userReview.reviewDate) : null;
                    })(),
                    details: (() => {
                        // Check if payment is completed (either 'paid' or project is completed)
                        const paymentCompleted = paymentStatus === 'paid' || projectStatus === 'completed';
                        if (!paymentCompleted) {
                            return 'Performance review will be available after payment processing is complete.';
                        }
                        const userReview = getUserPerformanceReview(currentUser.email);
                        return userReview ? 
                            'âœ… Your performance review has been completed. This helps us improve our collaboration and your future opportunities.' :
                            'Your performance review is now available. This helps us improve our collaboration and your future opportunities.';
                    })(),
                    action: (() => {
                        // Check if payment is completed (either 'paid' or project is completed)
                        const paymentCompleted = paymentStatus === 'paid' || projectStatus === 'completed';
                        if (!paymentCompleted) return null;
                        const userReview = getUserPerformanceReview(currentUser.email);
                        return userReview ? {
                            text: 'View Performance Review',
                            onclick: 'viewPerformanceReview()',
                            icon: 'fas fa-star'
                        } : null; // No action needed when waiting on admin
                    })()
                }
            ];
            
            return timeline;
        }

        // Get current step in timeline
        function getCurrentTimelineStep() {
            const timeline = getProjectTimeline();
            const currentStep = timeline.find(step => step.status === 'current');
            return currentStep || timeline[timeline.length - 1];
        }

        // Calculate overall progress percentage (0%, 20%, 40%, 60%, 80%, 100%)
        function getProjectProgress() {
            const timeline = getProjectTimeline();
            const completedSteps = timeline.filter(step => step.status === 'completed').length;

            // Each step is worth 20% (5 total steps: Application=20%, Contract=40%, Project Status=60%, Payment=80%, Performance=100%)
            const baseProgress = completedSteps * 20;

            // Determine normalized project status to decide partial behavior
            let normalizedProjectStatus = 'upcoming';
            try {
                const selectedJob = getSelectedJob();
                const userJob = selectedJob ? (currentUser?.jobs?.[selectedJob.id] || null) : null;
                const rawProj = userJob ? (userJob.projectStatus || userJob.status || currentUser?.profile?.projectStatus) : (currentUser?.profile?.projectStatus || 'upcoming');
                normalizedProjectStatus = normalizeProjectStatus(rawProj);
            } catch (_) {}

            // Upcoming/On-hold â†’ reflect completed steps (base). Cancelled â†’ freeze at base. In-progress â†’ small partial boost. Completed â†’ base already reflects progress.
            if (normalizedProjectStatus === 'upcoming' || normalizedProjectStatus === 'on-hold') {
                return Math.min(100, baseProgress);
            }
            if (normalizedProjectStatus === 'cancelled') {
                return Math.min(100, baseProgress);
            }
            const partialProgress = (normalizedProjectStatus === 'in-progress') ? 10 : 0;
            return Math.min(100, baseProgress + partialProgress);
        }

        // Contact support function
        function contactSupport() {
            showNotification('Please contact Cochran Films at support@cochranfilms.com or call (555) 123-4567 for assistance.', 'info');
        }

        // Check for automatic project status updates
        async function checkAutomaticProjectStatusUpdates() {
            if (!currentUser || !currentUser.jobs) return;
            
            try {
                // Get contract status
                const userContract = getUserContractStatus(currentUser.email);
                const contractSigned = userContract ? true : (currentUser.contractStatus === 'uploaded');
                const paymentComplete = currentUser.paymentStatus === 'configured' || (currentUser.paymentMethod && currentUser.paymentMethod !== 'pending');
                
                // Check each job for automatic status updates
                for (const [jobId, job] of Object.entries(currentUser.jobs)) {
                    let needsUpdate = false;
                    let newStatus = job.projectStatus;
                    
                    // Auto-set to 'upcoming' if contract is signed and payment is configured
                    if (contractSigned && paymentComplete && job.projectStatus === 'pending') {
                        newStatus = 'upcoming';
                        needsUpdate = true;
                        console.log('ðŸ”„ Auto-updating job status to upcoming:', jobId);
                    }
                    
                    // Auto-set to 'in-progress' if project start date has passed
                    if (job.projectStatus === 'upcoming' && job.projectStart) {
                        try {
                            const projectStartDate = new Date(job.projectStart);
                            const now = new Date();
                            
                            if (projectStartDate <= now) {
                                newStatus = 'in-progress';
                                needsUpdate = true;
                                console.log('ðŸ”„ Auto-updating job status to in-progress:', jobId);
                            }
                        } catch (e) {
                            console.warn('Could not parse project start date for auto-update:', job.projectStart);
                        }
                    }
                    
                    // Block progression when cancelled or on-hold
                    if (job.projectStatus === 'cancelled' || job.projectStatus === 'on-hold') {
                        continue; // do not auto-advance
                    }
                    // Update the job status if needed
                    if (needsUpdate) {
                        job.projectStatus = newStatus;
                        console.log('âœ… Updated job status:', jobId, 'to', newStatus);
                        
                        // Show notification for status change
                        const statusMessages = {
                            'upcoming': 'Your project has been scheduled and is now in the upcoming phase.',
                            'in-progress': 'Your project has started and is now in progress.'
                        };
                        
                        if (statusMessages[newStatus]) {
                            console.log('âœ… [SUCCESS]', statusMessages[newStatus]);
                        }
                        
                        // Trigger notification system to check for new notifications
                        setTimeout(() => {
                            checkJobStatusNotifications();
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('âŒ Error checking automatic project status updates:', error);
            }
        }

        // View performance review
        function viewPerformanceReview() {
            const userReview = getUserPerformanceReview(currentUser.email);
            
            if (!userReview) {
                showNotification('No performance review available yet. Please check back later.', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            let reviewDate = 'N/A';
            if (userReview.reviewDate) {
                try {
                    const date = new Date(userReview.reviewDate);
                    if (!isNaN(date.getTime())) {
                        reviewDate = date.toLocaleDateString();
                    } else {
                        console.warn('âš ï¸ Invalid performance review date:', userReview.reviewDate);
                    }
                } catch (error) {
                    console.warn('âš ï¸ Error formatting performance review date:', error);
                }
            }
            const overallRating = userReview.overallRating || 'N/A';
            
            modal.innerHTML = `
                <div style="background: #1a1a1a; padding: 2rem; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,178,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #FFB200; margin: 0;"><i class="fas fa-star"></i> Performance Review</h2>
                        <button onclick="closeModal(this)" 
                                style="background: none; border: none; color: #FFB200; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,178,0,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="color: #FFB200; margin-bottom: 0.5rem;">Review Details</h4>
                            <div style="color: rgba(255,255,255,0.9);">
                                <div><strong>Review Date:</strong> ${reviewDate}</div>
                                <div><strong>Overall Rating:</strong> ${overallRating}/5</div>
                                <div><strong>Status:</strong> ${userReview.status || 'completed'}</div>
                            </div>
                        </div>
                        
                        ${userReview.comments ? `
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="color: #FFB200; margin-bottom: 0.5rem;">Admin Comments</h4>
                            <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">${userReview.comments}</p>
                        </div>
                        ` : ''}
                        
                        ${userReview.categories ? `
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <h4 style="color: #FFB200; margin-bottom: 0.5rem;">Category Ratings</h4>
                            ${Object.entries(userReview.categories).map(([category, rating]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="color: rgba(255,255,255,0.9);">${category}:</span>
                                    <span style="color: #FFB200; font-weight: bold;">${rating}/5</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,178,0,0.2);">
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; text-align: center;">
                            <i class="fas fa-info-circle"></i> This review helps us improve our collaboration and your future opportunities.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        // Toggle timeline details
        function toggleTimelineDetails(stepId) {
            const timelineItem = document.querySelector(`[data-step="${stepId}"]`);
            const detailsSection = timelineItem.querySelector('.timeline-details');
            const expandButton = timelineItem.querySelector('.timeline-expand');
            const icon = expandButton.querySelector('i');
            
            if (detailsSection) {
                // Toggle existing details
                if (detailsSection.style.display === 'none' || !detailsSection.style.display) {
                    detailsSection.style.display = 'block';
                    expandButton.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
                } else {
                    detailsSection.style.display = 'none';
                    expandButton.innerHTML = '<i class="fas fa-chevron-down"></i> Show Details';
                }
            } else {
                // Create and show details for non-current steps
                const timeline = getProjectTimeline();
                const step = timeline.find(s => s.id === stepId);
                
                if (step) {
                    const timelineContent = timelineItem.querySelector('.timeline-content');
                    const newDetails = document.createElement('div');
                    newDetails.className = 'timeline-details';
                    newDetails.innerHTML = `
                        <p>${step.details}</p>
                        ${step.checklist ? `
                            <div class="timeline-checklist">
                                <h6>ðŸ“‹ Preparation Checklist:</h6>
                                <ul>
                                    ${step.checklist.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${step.requirements ? `
                            <div class="timeline-requirements">
                                <h6>ðŸ“ Requirements:</h6>
                                <ul>
                                    ${step.requirements.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `;
                    
                    timelineContent.insertBefore(newDetails, expandButton);
                    expandButton.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
                }
            }
        }
        // Update payment method
        async function updatePaymentMethod() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                showNotification('Please select a payment method', 'warning');
                return;
            }
            
            const paymentMethod = selectedMethod.value;
            
            // Update current user's payment method
            if (currentUser) {
                currentUser.paymentMethod = paymentMethod;
                
                // Save to session storage
                sessionStorage.setItem('userPortalAuthenticated', JSON.stringify(currentUser));
                
                // Persist update to Firestore, then update UI
                try {
                    await updateUserPaymentMethod(currentUser.email, paymentMethod);
                    try { sessionStorage.setItem('userPortalAuthenticated', JSON.stringify(currentUser)); } catch(_) {}
                    updatePaymentStatusDisplay();
                    updateTimelineDisplay();
                    console.log(`âœ… Payment method updated to: ${paymentMethod.toUpperCase()}`);
                    await addNotification(
                        'Payment Method Updated',
                        `Your payment method has been updated to ${paymentMethod.toUpperCase()}`,
                        'payment_method_updated',
                        { userEmail: currentUser.email, paymentMethod, actionRequired: false, priority: 'normal' }
                    );
                } catch (error) {
                    console.error('âŒ Error updating payment method:', error);
                    showNotification('âš ï¸ Unable to update server. Your choice was saved locally.', 'warning');
                }
                
                // Targeted refresh only; avoid full reload to prevent visual flicker
                displayUserInfo();
                displayCurrentJobs();
            }
        }

        // Update user payment method directly in Firestore (no JSON/GitHub dependency)
        async function updateUserPaymentMethod(email, paymentMethod) {
            if (!email) throw new Error('Missing user email');
            if (!window.FirestoreDataManager || !window.FirestoreDataManager.isAvailable()) {
                throw new Error('Firestore unavailable');
            }
            console.log('ðŸ’³ Updating payment method in Firestore:', email, paymentMethod);
            // Resolve canonical doc id by email first; fallback to currentUser.name
            const emailLower = String(email).toLowerCase();
            let userId = null;
            try {
                userId = await window.FirestoreDataManager.findUserIdByEmail(emailLower);
            } catch (_) { userId = null; }
            if (!userId && currentUser && currentUser.name) {
                userId = currentUser.name;
            }
            if (!userId) {
                userId = emailLower;
            }
            await window.FirestoreDataManager.setUser(userId, {
                profile: { email: emailLower },
                paymentMethod: paymentMethod,
                paymentStatus: 'configured'
            });
            // Refresh local model
            await loadUsersData();
            if (currentUser && currentUser.email && currentUser.email.toLowerCase() === email.toLowerCase()) {
                const updated = users.find(u => (u.email || '').toLowerCase() === email.toLowerCase());
                if (updated) currentUser = updated;
                displayUserInfo();
                displayCurrentJobs();
            }
            try { sessionStorage.setItem('userPortalAuthenticated', JSON.stringify(currentUser)); } catch(_) {}
            console.log('âœ… Payment method updated in Firestore for', email);
        }

        // Force refresh cache function
        async function forceRefreshCache() {
            console.log('ðŸ”„ Force refreshing cache...');
            sessionStorage.removeItem('cachedUsersData');
            sessionStorage.removeItem('cachedUsersDataTimestamp');
            await loadUsersData();
            console.log('âœ… Cache refreshed');
        }



        function createPaymentDropdown() {
            // Use the same encrypted payment modal from Profile tab
            showPaymentModal();
        }

        // Refresh user data (reload from JSON file)
        async function refreshUserData() {
            console.log('ðŸ”„ Refreshing user data...');
            await loadUploadedContracts();
            await loadUsersData();
            await loadJobsData();
            await loadPerformanceReviews();
            
            if (currentUser) {
                // Validate session first
                const userStillExists = await validateUserSession(currentUser);
                if (!userStillExists) {
                    sessionStorage.removeItem('userPortalAuthenticated');
                    currentUser = null;
                    showNotification('Your account has been removed. Please contact the administrator.', 'error');
                    showLoginScreen();
                    return;
                }
                
                // Find updated user data
                const updatedUser = users.find(u => 
                    u.email?.toLowerCase() === currentUser.email.toLowerCase()
                );
                if (updatedUser) {
                    currentUser = updatedUser;
                    console.log('âœ… User data refreshed:', currentUser);
                    loadUserData(); // Refresh displays
                    console.log('Data refreshed successfully!');
                } else {
                    console.warn('âš ï¸ User not found after refresh');
                    showNotification('Unable to refresh user data', 'error');
                }
            }
        }
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize sophisticated notification system
            await initializeNotificationSystem();
            
            // Initialize Phase 3 advanced payment system
            await initializeAdvancedPaymentSystem();
            
            // Initialize Phase 3 advanced analytics system
            await initializeAdvancedAnalytics();
            
            // Initialize Phase 3 team collaboration system - now integrated into Community section
            
            // Initialize creative powerhouse features
            initializeCreativeFeatures();
            
            // Close notification dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const container = document.querySelector('.notification-container');
                const dropdown = document.getElementById('notificationDropdown');
                
                if (container && dropdown && !container.contains(event.target) && dropdown.style.display !== 'none') {
                    dropdown.style.display = 'none';
                }
            });
            
            // Ensure Firebase + Firestore are fully ready before first data loads
            try { if (window.FirebaseConfig) { await window.FirebaseConfig.waitForInit(); } } catch(_) {}
            try { if (window.FirestoreDataManager) { await window.FirestoreDataManager.init(); } } catch(_) {}
            await loadUploadedContracts();
            await loadUsersData();
            await loadJobsData();
            await loadPerformanceReviews();
            await checkAuth();
            
            // Set up periodic session validation (check every 30 seconds)
            setInterval(async () => {
                if (currentUser) {
                    const userStillExists = await validateUserSession(currentUser);
                    if (!userStillExists) {
                        sessionStorage.removeItem('userPortalAuthenticated');
                        currentUser = null;
                        showNotification('Your account has been removed. Please contact the administrator.', 'error');
                        showLoginScreen();
                    }
                }
            }, 30000); // 30 seconds
            
            // Add login form handler with OPTIMIZED input handling
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                
                // OPTIMIZED input handling - single event listener per input
                const emailInput = document.getElementById('email');
                const passwordInput = document.getElementById('password');
                
                if (emailInput) {
                    // Single input event listener with immediate feedback
                    emailInput.addEventListener('input', function() {
                        // Clear error message immediately when typing
                        const errorElement = document.getElementById('loginError');
                        if (errorElement && errorElement.style.display !== 'none') {
                            errorElement.style.display = 'none';
                        }
                    });
                    
                    // Add focus styling for better UX
                    emailInput.addEventListener('focus', function() {
                        this.style.borderColor = '#FFB200';
                        this.style.boxShadow = '0 0 0 3px rgba(255, 178, 0, 0.2)';
                    });
                    
                    emailInput.addEventListener('blur', function() {
                        this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        this.style.boxShadow = 'none';
                    });
                }
                
                if (passwordInput) {
                    // Single input event listener with immediate feedback
                    passwordInput.addEventListener('input', function() {
                        // Clear error message immediately when typing
                        const errorElement = document.getElementById('loginError');
                        if (errorElement && errorElement.style.display !== 'none') {
                            errorElement.style.display = 'none';
                        }
                    });
                    
                    // Add focus styling for better UX
                    passwordInput.addEventListener('focus', function() {
                        this.style.borderColor = '#FFB200';
                        this.style.boxShadow = '0 0 0 3px rgba(255, 178, 0, 0.2)';
                    });
                    
                    passwordInput.addEventListener('blur', function() {
                        this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        this.style.boxShadow = 'none';
                    });
                }
            }
            
            // Add refresh button functionality
            window.refreshUserData = refreshUserData;
        
            // Immediate update functions for real-time UI updates
            function updateTimelineDisplay() {
                if (currentUser && document.getElementById('jobsContent')) {
                    try { displayCurrentJobs(); } catch (error) {
                        console.warn('âš ï¸ Error updating timeline display:', error);
                    }
                }
            }
            
            function updateJobStatusDisplay() {
                if (currentUser && document.getElementById('currentJobsContainer')) {
                    displayCurrentJobs();
                }
            }
            
            function updatePerformanceReviewDisplay() {
                if (currentUser && document.getElementById('performanceContent')) {
                    displayPerformanceReviews();
                }
            }
            
            function updatePaymentStatusDisplay() {
                if (currentUser && document.getElementById('paymentStatusContainer')) {
                    // Update payment status indicators
                    const paymentElements = document.querySelectorAll('[data-payment-status]');
                    paymentElements.forEach(element => {
                        const status = element.getAttribute('data-payment-status');
                        element.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    });
                }
            }
            
            function updateContractStatusDisplay() {
                if (currentUser && document.getElementById('contractStatusContainer')) {
                    // Update contract status indicators
                    const contractElements = document.querySelectorAll('[data-contract-status]');
                    contractElements.forEach(element => {
                        const status = element.getAttribute('data-contract-status');
                        element.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    });
                }
            }
            
            function updateNotificationCount(count) {
                // Update notification badge count
                const notificationBadge = document.querySelector('.notification-badge');
                if (notificationBadge) {
                    if (count > 0) {
                        notificationBadge.textContent = count;
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
            }

            function checkForNewUserNotifications() {
                // Legacy API disabled; rely on local/Firestore notification system
                try {
                    if (currentUser) {
                        const notifications = (window.localStorage && localStorage.getItem('userNotifications'))
                            ? JSON.parse(localStorage.getItem('userNotifications')) : [];
                        const userNotifications = notifications.filter(n => 
                            n.userEmail === currentUser.email || n.userEmail === currentUser.profile?.email
                        );
                        updateNotificationCount(userNotifications.length);
                    }
                } catch (e) {
                    // no-op
                }
            }
            
            // Set up real-time data updates (every 30 seconds to reduce performance impact)
            setInterval(() => {
                if (currentUser) {
                    // Reduced logging - only log refresh activity occasionally
                    if (!sessionStorage.getItem('refreshLogged') || Date.now() - parseInt(sessionStorage.getItem('lastRefreshLog') || '0') > 60000) {
                        console.log('âš¡ User portal refresh...');
                        sessionStorage.setItem('refreshLogged', 'true');
                        sessionStorage.setItem('lastRefreshLog', Date.now().toString());
                    }
                    
                    // Load data and update UI
                    loadUsersData().then(() => {
                        loadUserData();
                        updateTimelineDisplay();
                        updateJobStatusDisplay();
                    }).catch(error => {
                        console.warn('âš ï¸ User portal refresh failed:', error);
                    });
                    
                    // Load performance reviews
                    loadPerformanceReviews().then(() => {
                        updatePerformanceReviewDisplay();
                    }).catch(error => {
                        console.warn('âš ï¸ Performance reviews refresh failed:', error);
                    });
                    
                    // Quick checks
                    checkForNewUserNotifications();
                    updatePaymentStatusDisplay();
                    updateContractStatusDisplay();
                }
            }, 30000); // 30 seconds to reduce performance impact
        });

        // Missing functions from backup file - UPDATED FOR CENTRALIZED SYSTEM
        function getUserContractStatus(userEmail, jobId = null) {
            console.log('ðŸ” Getting contract status for user:', currentUser?.name);
            console.log('ðŸ“„ Current user structure:', currentUser);
            
            // Check if current user has contract data in centralized system
            if (!currentUser) {
                console.log('âŒ No current user found');
                return null;
            }
            
            // The contract data is flattened on currentUser (not nested)
            // Based on the data loading process, contract data is flattened like this:
            // contractStatus, contractSignedDate, contractUploadedDate, contractId
            if (currentUser.contractStatus) {
                const userContract = {
                    contractStatus: currentUser.contractStatus,
                    contractSignedDate: currentUser.contractSignedDate,
                    contractId: currentUser.contractId || currentUser.name,
                    contractUploadedDate: currentUser.contractUploadedDate
                };
                console.log('âœ… Found flattened contract data on currentUser:', userContract);
                
                // Get job data for the specific job
                const jobData = currentUser.jobs && currentUser.jobs[jobId || Object.keys(currentUser.jobs || {})[0]];
                
                // Return contract data in the expected format
                return {
                    status: userContract.contractStatus,
                    contractId: userContract.contractId,
                    signedDate: userContract.contractSignedDate,
                    fileName: `${currentUser.name}.pdf`,
                    notes: null,
                    githubUrl: null,
                    role: jobData?.title || jobData?.role || currentUser.profile?.role,
                    rate: jobData?.pay || jobData?.rate || currentUser.profile?.rate,
                    location: jobData?.location || currentUser.profile?.location,
                    jobId: jobId || Object.keys(currentUser.jobs || {})[0] || 'legacy-job',
                    jobRole: jobData?.title || jobData?.role || currentUser.profile?.role,
                    jobDescription: jobData?.description || currentUser.profile?.description
                };
            } else {
                if (!sessionStorage.getItem('noContractDataLogged')) {
                    console.log('âŒ No contract data found for user in centralized system');
                    sessionStorage.setItem('noContractDataLogged', 'true');
                }
                return null;
            }
        }
        function viewJobDetails() {
            const selectedJob = getSelectedJob();
            if (!selectedJob) {
                showNotification('No job details available', 'warning');
                return;
            }
            
            showJobDetailsModal(selectedJob);
        }

        function showJobDetailsModal(data) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                backdrop-filter: blur(10px);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #1a1a2e;
                    border-radius: 20px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 1px solid rgba(255,255,255,0.1);
                    position: relative;
                ">
                    <button onclick="closeJobDetailsModal()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: none;
                        border: none;
                        color: rgba(255,255,255,0.7);
                        font-size: 1.5rem;
                        cursor: pointer;
                        padding: 0.5rem;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                        Ã—
                    </button>
                    
                    <h2 style="color: #FFB200; margin-bottom: 1.5rem; font-family: 'Cinzel', serif;">
                        <i class="fas fa-briefcase"></i> Job Details
                    </h2>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <div>
                            <h3 style="color: #FFB200; margin-bottom: 0.5rem;">Position</h3>
                            <p style="color: rgba(255,255,255,0.9);">${data.title || data.role || 'Assistant Position'}</p>
                        </div>
                        
                        <div>
                            <h3 style="color: #FFB200; margin-bottom: 0.5rem;">Location</h3>
                            <p style="color: rgba(255,255,255,0.9);">${data.location || 'N/A'}</p>
                        </div>
                        
                        <div>
                            <h3 style="color: #FFB200; margin-bottom: 0.5rem;">Project Start</h3>
                            <p style="color: rgba(255,255,255,0.9);">${formatDisplayDate(data.projectStart || data.date || getEffectiveProjectStartDate())}</p>
                        </div>
                        
                        <div>
                            <h3 style="color: #FFB200; margin-bottom: 0.5rem;">Rate</h3>
                            <p style="color: rgba(255,255,255,0.9);">${data.pay || data.rate || '$75/hour'}</p>
                        </div>
                        
                        <div>
                            <h3 style="color: #FFB200; margin-bottom: 0.5rem;">Description</h3>
                            <p style="color: rgba(255,255,255,0.9);">${data.description || 'Professional position with detailed responsibilities to be provided.'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeJobDetailsModal();
                }
            });
        }

        function closeJobDetailsModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
            if (modal) {
                modal.remove();
            }
        }

        // ==================== PHASE 3: ADVANCED PAYMENT SYSTEM ====================
        
        // Enhanced payment options configuration with validation
        const PAYMENT_OPTIONS = {
            paypal: {
                name: 'PayPal',
                icon: 'fab fa-paypal',
                gradient: 'linear-gradient(135deg, #0070ba, #1546a0)',
                description: 'PayPal transfer',
                requiresEmail: true,
                processingTime: '1-3 business days',
                fees: '2.9% + $0.30',
                minAmount: 1.00,
                maxAmount: 10000.00,
                supported: true
            },
            bank: {
                name: 'Bank Transfer',
                icon: 'fas fa-university',
                gradient: 'linear-gradient(135deg, #22c55e, #16a34a)',
                description: 'Direct bank transfer',
                requiresAccount: true,
                processingTime: '1-2 business days',
                fees: 'Free',
                minAmount: 1.00,
                maxAmount: 50000.00,
                supported: true
            },
            stripe: {
                name: 'Stripe',
                icon: 'fab fa-stripe',
                gradient: 'linear-gradient(135deg, #6772e5, #5469d4)',
                description: 'Stripe payment processing',
                requiresCard: true,
                processingTime: '2-5 business days',
                fees: '2.9% + $0.30',
                minAmount: 0.50,
                maxAmount: 999999.99,
                supported: true
            },
            zelle: {
                name: 'Zelle',
                icon: 'fas fa-mobile-alt',
                gradient: 'linear-gradient(135deg, #6b46c1, #553c9a)',
                description: 'Zelle transfer',
                requiresPhone: true,
                processingTime: 'Instant',
                fees: 'Free',
                minAmount: 1.00,
                maxAmount: 2500.00,
                supported: true
            },
            cash: {
                name: 'Cash',
                icon: 'fas fa-money-bill-wave',
                gradient: 'linear-gradient(135deg, #f59e0b, #d97706)',
                description: 'Cash payment',
                requiresMeeting: true,
                processingTime: 'On delivery',
                fees: 'Free',
                minAmount: 1.00,
                maxAmount: 10000.00,
                supported: true
            },
            invoice: {
                name: 'Invoice',
                icon: 'fas fa-file-invoice-dollar',
                gradient: 'linear-gradient(135deg, #10b981, #059669)',
                description: 'Invoice payment',
                requiresDetails: true,
                processingTime: 'Net 30 days',
                fees: 'Free',
                minAmount: 1.00,
                maxAmount: 100000.00,
                supported: true
            },
            venmo: {
                name: 'Venmo',
                icon: 'fab fa-vimeo',
                gradient: 'linear-gradient(135deg, #3d95ce, #2e7d32)',
                description: 'Venmo transfer',
                requiresUsername: true,
                processingTime: '1-3 business days',
                fees: '3%',
                minAmount: 1.00,
                maxAmount: 5000.00,
                supported: true
            }
        };

        // Payment processing system
        let paymentProcessing = {
            isProcessing: false,
            currentPayment: null,
            paymentQueue: [],
            retryAttempts: 3,
            processingTimeout: 30000 // 30 seconds
        };

        // Payment analytics tracking
        let paymentAnalytics = {
            totalProcessed: 0,
            totalAmount: 0,
            averageAmount: 0,
            successRate: 0,
            failureRate: 0,
            methodBreakdown: {},
            monthlyTrends: [],
            lastUpdated: null
        };

        // Initialize advanced payment system
        async function initializeAdvancedPaymentSystem() {
            console.log('ðŸ’³ Initializing Phase 3 Advanced Payment System...');
            
            // Wait for Firebase to be ready
            if (!window.FirebaseConfig || !window.FirebaseConfig.isInitialized) {
                console.log('â³ Waiting for Firebase initialization...');
                await new Promise((resolve) => {
                    window.addEventListener('firebase:initialized', resolve, { once: true });
                });
            }
            
            // Load payment analytics from Firebase
            await loadPaymentAnalyticsFromFirebase();
            
            // Initialize payment processing queue
            await initializePaymentQueue();
            
            // Start payment monitoring
            startPaymentMonitoring();
            
            console.log('âœ… Phase 3 Advanced Payment System initialized with Firebase');
        }

        // Load payment analytics from Firebase
        async function loadPaymentAnalyticsFromFirebase() {
            try {
                console.log('ðŸ”¥ Loading payment analytics from Firebase...');
                
                // Get Firestore instance
                const db = window.FirebaseConfig.getFirestore();
                
                // Get current user data from Firebase
                const currentUserEmail = currentUser?.email;
                if (!currentUserEmail) {
                    console.warn('âš ï¸ No current user email available for payment analytics');
                    return;
                }
                
                // Find user document in Firebase
                const usersSnapshot = await db.collection('users').get();
                let userData = null;
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.profile && data.profile.email === currentUserEmail) {
                        userData = data;
                    }
                });
                
                if (!userData) {
                    console.warn('âš ï¸ User data not found in Firebase');
                    return;
                }
                
                // Initialize payment analytics with real data
                paymentAnalytics = {
                    totalProcessed: userData.payment?.totalProcessed || 0,
                    totalAmount: userData.payment?.totalAmount || 0,
                    successRate: userData.payment?.successRate || 0,
                    methodBreakdown: userData.payment?.methodBreakdown || {},
                    monthlyTrends: userData.payment?.monthlyTrends || [],
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('âœ… Payment analytics loaded from Firebase:', paymentAnalytics);
                
            } catch (error) {
                console.error('âŒ Error loading payment analytics from Firebase:', error);
                // Set default values
                paymentAnalytics = {
                    totalProcessed: 0,
                    totalAmount: 0,
                    successRate: 0,
                    methodBreakdown: {},
                    monthlyTrends: [],
                    lastUpdated: new Date().toISOString()
                };
            }
        }

        // Save payment analytics to storage
        async function savePaymentAnalytics() {
            try {
                paymentAnalytics.lastUpdated = new Date().toISOString();
                localStorage.setItem('paymentAnalytics', JSON.stringify(paymentAnalytics));
            } catch (error) {
                console.error('âŒ Error saving payment analytics:', error);
            }
        }

        // Initialize payment processing queue
        async function initializePaymentQueue() {
            try {
                const saved = localStorage.getItem('paymentQueue');
                if (saved) {
                    paymentProcessing.paymentQueue = JSON.parse(saved);
                }
            } catch (error) {
                console.error('âŒ Error loading payment queue:', error);
            }
        }

        // Save payment queue to storage
        async function savePaymentQueue() {
            try {
                localStorage.setItem('paymentQueue', JSON.stringify(paymentProcessing.paymentQueue));
            } catch (error) {
                console.error('âŒ Error saving payment queue:', error);
            }
        }

        // Start payment monitoring
        function startPaymentMonitoring() {
            // Monitor payment status every 30 seconds
            setInterval(async () => {
                if (paymentProcessing.paymentQueue.length > 0 && !paymentProcessing.isProcessing) {
                    await processNextPayment();
                }
            }, 30000);

            // Update analytics every 5 minutes
            setInterval(async () => {
                await updatePaymentAnalytics();
            }, 300000);
        }
        // Add payment to processing queue
        async function addPaymentToQueue(amount, method, description = '') {
            const payment = {
                id: `payment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                amount: parseFloat(amount),
                method: method,
                description: description,
                status: 'pending',
                createdAt: new Date().toISOString(),
                retryCount: 0
            };
            
            paymentProcessing.paymentQueue.push(payment);
            await savePaymentQueue();
            
            console.log('ðŸ’³ Payment added to queue:', payment);
            
            // Process immediately if not currently processing
            if (!paymentProcessing.isProcessing) {
                await processNextPayment();
            }
        }

        // Process next payment in queue
        async function processNextPayment() {
            if (paymentProcessing.isProcessing || paymentProcessing.paymentQueue.length === 0) {
                return;
            }

            paymentProcessing.isProcessing = true;
            const payment = paymentProcessing.paymentQueue.shift();
            paymentProcessing.currentPayment = payment;

            try {
                console.log('ðŸ”„ Processing payment:', payment);
                
                // Show processing notification
                showNotification(`Processing ${payment.method} payment of $${payment.amount}...`, 'info', {
                    category: 'payment',
                    persistent: true,
                    actions: [
                        {
                            id: 'cancel',
                            title: 'Cancel',
                            icon: 'fas fa-times',
                            handler: 'cancelPayment()'
                        }
                    ]
                });

                // Simulate payment processing (replace with actual payment gateway integration)
                const result = await simulatePaymentProcessing(payment);
                
                if (result.success) {
                    await handlePaymentSuccess(payment, result);
                } else {
                    await handlePaymentFailure(payment, result.error);
                }

            } catch (error) {
                console.error('âŒ Payment processing error:', error);
                await handlePaymentFailure(payment, error.message);
            } finally {
                paymentProcessing.isProcessing = false;
                paymentProcessing.currentPayment = null;
                await savePaymentQueue();
            }
        }

        // Simulate payment processing (replace with actual payment gateway)
        async function simulatePaymentProcessing(payment) {
            return new Promise((resolve) => {
                // Simulate processing delay
                setTimeout(() => {
                    // Simulate 95% success rate
                    const success = Math.random() > 0.05;
                    resolve({
                        success,
                        transactionId: success ? `txn_${Date.now()}` : null,
                        error: success ? null : 'Payment gateway timeout'
                    });
                }, 2000 + Math.random() * 3000); // 2-5 seconds
            });
        }

        // Handle successful payment
        async function handlePaymentSuccess(payment, result) {
            console.log('âœ… Payment successful:', result);
            
            // Update payment status
            payment.status = 'completed';
            payment.processedAt = new Date().toISOString();
            payment.transactionId = result.transactionId;
            
            // Update user data
            if (currentUser) {
                if (!currentUser.paymentHistory) {
                    currentUser.paymentHistory = [];
                }
                currentUser.paymentHistory.push(payment);
                
                // Update total earnings
                if (!currentUser.totalEarnings) {
                    currentUser.totalEarnings = 0;
                }
                currentUser.totalEarnings += payment.amount;
                
                // Save to Firestore
                await saveUserData();
            }
            
            // Update analytics
            paymentAnalytics.totalProcessed++;
            paymentAnalytics.totalAmount += payment.amount;
            paymentAnalytics.averageAmount = paymentAnalytics.totalAmount / paymentAnalytics.totalProcessed;
            
            if (!paymentAnalytics.methodBreakdown[payment.method]) {
                paymentAnalytics.methodBreakdown[payment.method] = { count: 0, amount: 0 };
            }
            paymentAnalytics.methodBreakdown[payment.method].count++;
            paymentAnalytics.methodBreakdown[payment.method].amount += payment.amount;
            
            await savePaymentAnalytics();
            
            // Show success notification
            showNotification(`Payment of $${payment.amount} completed successfully!`, 'success', {
                category: 'payment',
                duration: 5000,
                actions: [
                    {
                        id: 'view',
                        title: 'View Details',
                        icon: 'fas fa-eye',
                        handler: `viewPaymentDetails('${payment.id}')`
                    }
                ]
            });
            
            // Update UI
            updatePaymentDisplay();
        }

        // Handle failed payment
        async function handlePaymentFailure(payment, error) {
            console.log('âŒ Payment failed:', error);
            
            // Update payment status
            payment.status = 'failed';
            payment.failureReason = error;
            payment.retryCount = (payment.retryCount || 0) + 1;
            
            // Retry if under limit
            if (payment.retryCount < paymentProcessing.retryAttempts) {
                console.log(`ðŸ”„ Retrying payment (attempt ${payment.retryCount + 1})`);
                paymentProcessing.paymentQueue.push(payment);
                await savePaymentQueue();
                
                showNotification(`Payment failed, retrying... (${payment.retryCount}/${paymentProcessing.retryAttempts})`, 'warning', {
                    category: 'payment',
                    duration: 3000
                });
            } else {
                // Final failure
                payment.status = 'failed_final';
                payment.finalFailureAt = new Date().toISOString();
                
                // Update analytics
                paymentAnalytics.failureRate = (paymentAnalytics.failureRate || 0) + 1;
                await savePaymentAnalytics();
                
                showNotification(`Payment failed after ${paymentProcessing.retryAttempts} attempts: ${error}`, 'error', {
                    category: 'payment',
                    duration: 8000,
                    actions: [
                        {
                            id: 'retry',
                            title: 'Retry Manually',
                            icon: 'fas fa-redo',
                            handler: `retryPayment('${payment.id}')`
                        }
                    ]
                });
            }
            
            // Update UI
            updatePaymentDisplay();
        }

        // Update payment analytics
        async function updatePaymentAnalytics() {
            try {
                if (currentUser && currentUser.paymentHistory) {
                    const payments = currentUser.paymentHistory;
                    const completedPayments = payments.filter(p => p.status === 'completed');
                    
                    paymentAnalytics.totalProcessed = completedPayments.length;
                    paymentAnalytics.totalAmount = completedPayments.reduce((sum, p) => sum + p.amount, 0);
                    paymentAnalytics.averageAmount = paymentAnalytics.totalProcessed > 0 ? 
                        paymentAnalytics.totalAmount / paymentAnalytics.totalProcessed : 0;
                    
                    const failedPayments = payments.filter(p => p.status === 'failed_final');
                    const totalPayments = payments.length;
                    paymentAnalytics.successRate = totalPayments > 0 ? 
                        (completedPayments.length / totalPayments) * 100 : 0;
                    paymentAnalytics.failureRate = totalPayments > 0 ? 
                        (failedPayments.length / totalPayments) * 100 : 0;
                    
                    await savePaymentAnalytics();
                }
            } catch (error) {
                console.error('âŒ Error updating payment analytics:', error);
            }
        }

        // View payment details
        function viewPaymentDetails(paymentId) {
            if (!currentUser || !currentUser.paymentHistory) return;
            
            const payment = currentUser.paymentHistory.find(p => p.id === paymentId);
            if (!payment) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a2e; border: 1px solid #FFB200; border-radius: 12px;
                           padding: 2rem; max-width: 500px; width: 100%; color: white;">
                    <h3 style="color: #FFB200; margin: 0 0 1rem 0; font-family: 'Cinzel', serif;">
                        <i class="fas fa-credit-card"></i> Payment Details
                    </h3>
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>Amount:</strong> $${payment.amount}</div>
                        <div><strong>Method:</strong> ${PAYMENT_OPTIONS[payment.method]?.name || payment.method}</div>
                        <div><strong>Status:</strong> <span style="color: ${payment.status === 'completed' ? '#22c55e' : '#ef4444'}">${payment.status}</span></div>
                        <div><strong>Created:</strong> ${new Date(payment.createdAt).toLocaleString()}</div>
                        ${payment.processedAt ? `<div><strong>Processed:</strong> ${new Date(payment.processedAt).toLocaleString()}</div>` : ''}
                        ${payment.transactionId ? `<div><strong>Transaction ID:</strong> ${payment.transactionId}</div>` : ''}
                        ${payment.failureReason ? `<div><strong>Failure Reason:</strong> ${payment.failureReason}</div>` : ''}
                        ${payment.description ? `<div><strong>Description:</strong> ${payment.description}</div>` : ''}
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; 
                                       border-radius: 6px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Retry payment manually
        async function retryPayment(paymentId) {
            if (!currentUser || !currentUser.paymentHistory) return;
            
            const payment = currentUser.paymentHistory.find(p => p.id === paymentId);
            if (!payment) return;
            
            // Reset payment for retry
            payment.status = 'pending';
            payment.retryCount = 0;
            payment.failureReason = null;
            
            // Add to queue
            paymentProcessing.paymentQueue.push(payment);
            await savePaymentQueue();
            
            showNotification('Payment retry initiated...', 'info', {
                category: 'payment',
                duration: 3000
            });
            
            // Process immediately if not currently processing
            if (!paymentProcessing.isProcessing) {
                await processNextPayment();
            }
        }

        // Cancel current payment
        function cancelPayment() {
            if (paymentProcessing.currentPayment) {
                paymentProcessing.currentPayment.status = 'cancelled';
                paymentProcessing.isProcessing = false;
                paymentProcessing.currentPayment = null;
                
                showNotification('Payment cancelled', 'info', {
                    category: 'payment',
                    duration: 3000
                });
            }
        }

        // Update payment display in UI
        function updatePaymentDisplay() {
            // This would update the payment section in the UI
            // Implementation depends on the specific UI structure
            console.log('ðŸ’³ Updating payment display...');
        }

        // ==================== PHASE 3: ADVANCED REPORTING & ANALYTICS ====================
        
        // Advanced analytics system
        let analyticsData = {
            userMetrics: {
                totalEarnings: 0,
                totalJobs: 0,
                successRate: 0,
                averageRating: 0,
                totalHours: 0,
                completionRate: 0
            },
            performanceMetrics: {
                monthlyEarnings: [],
                jobCompletionTrends: [],
                ratingHistory: [],
                paymentMethodBreakdown: {},
                timeTracking: {},
                skillDevelopment: {}
            },
            businessIntelligence: {
                marketInsights: {},
                competitorAnalysis: {},
                growthProjections: {},
                riskAssessment: {}
            },
            lastUpdated: null
        };

        // Initialize advanced analytics system
        async function initializeAdvancedAnalytics() {
            console.log('ðŸ“Š Initializing Phase 3 Advanced Analytics System...');
            
            // Wait for Firebase to be ready
            if (!window.FirebaseConfig || !window.FirebaseConfig.isInitialized) {
                console.log('â³ Waiting for Firebase initialization...');
                await new Promise((resolve) => {
                    window.addEventListener('firebase:initialized', resolve, { once: true });
                });
            }
            
            // Load analytics data from Firebase
            await loadAnalyticsDataFromFirebase();
            
            // Calculate user metrics from real data
            await calculateUserMetricsFromFirebase();
            
            // Generate performance insights from real data
            await generatePerformanceInsightsFromFirebase();
            
            // Start real-time analytics updates
            startAnalyticsMonitoring();
            
            console.log('âœ… Phase 3 Advanced Analytics System initialized with Firebase');
        }

        // Load analytics data from Firebase
        async function loadAnalyticsDataFromFirebase() {
            try {
                console.log('ðŸ”¥ Loading analytics data from Firebase...');
                
                // Get Firestore instance
                const db = window.FirebaseConfig.getFirestore();
                
                // Initialize analytics data structure
                analyticsData = {
                    userMetrics: {
                        totalEarnings: 0,
                        totalJobs: 0,
                        successRate: 0,
                        averageRating: 0,
                        totalHours: 0,
                        completionRate: 0
                    },
                    performanceMetrics: {
                        monthlyEarnings: [],
                        jobCompletionTrends: [],
                        ratingHistory: [],
                        paymentMethodBreakdown: {},
                        timeTracking: {},
                        skillDevelopment: {}
                    },
                    businessIntelligence: {
                        insights: [],
                        recommendations: [],
                        riskAssessment: {}
                    },
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('âœ… Analytics data structure initialized from Firebase');
                
            } catch (error) {
                console.error('âŒ Error loading analytics data from Firebase:', error);
                // Fallback to empty structure
                analyticsData = {
                    userMetrics: { totalEarnings: 0, totalJobs: 0, successRate: 0, averageRating: 0, totalHours: 0, completionRate: 0 },
                    performanceMetrics: { monthlyEarnings: [], jobCompletionTrends: [], ratingHistory: [], paymentMethodBreakdown: {}, timeTracking: {}, skillDevelopment: {} },
                    businessIntelligence: { insights: [], recommendations: [], riskAssessment: {} },
                    lastUpdated: new Date().toISOString()
                };
            }
        }

        // Save analytics data to storage
        async function saveAnalyticsData() {
            try {
                analyticsData.lastUpdated = new Date().toISOString();
                localStorage.setItem('analyticsData', JSON.stringify(analyticsData));
            } catch (error) {
                console.error('âŒ Error saving analytics data:', error);
            }
        }

        // Calculate comprehensive user metrics
        async function calculateUserMetricsFromFirebase() {
            try {
                console.log('ðŸ”¥ Calculating user metrics from Firebase...');
                
                // Get Firestore instance
                const db = window.FirebaseConfig.getFirestore();
                
                // Get current user data from Firebase
                const currentUserEmail = currentUser?.email;
                if (!currentUserEmail) {
                    console.warn('âš ï¸ No current user email available for metrics calculation');
                    return;
                }
                
                // Find user document in Firebase
                const usersSnapshot = await db.collection('users').get();
                let userData = null;
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.profile && data.profile.email === currentUserEmail) {
                        userData = data;
                    }
                });
                
                if (!userData) {
                    console.warn('âš ï¸ User data not found in Firebase');
                    return;
                }
                
                // Calculate metrics from Firebase user data
                const totalEarnings = userData.performance?.totalEarnings || 0;
                const totalJobs = userData.performance?.totalJobs || 0;
                const completedJobs = userData.performance?.completedJobs || 0;
                const successRate = totalJobs > 0 ? (completedJobs / totalJobs) * 100 : 0;
                const averageRating = userData.performance?.averageRating || 0;
                const totalHours = userData.performance?.totalHours || 0;
                const completionRate = userData.performance?.completionRate || 0;
                
                // Update analytics data
                analyticsData.userMetrics = {
                    totalEarnings,
                    totalJobs,
                    successRate,
                    averageRating,
                    totalHours,
                    completionRate
                };
                
                console.log('âœ… User metrics calculated from Firebase:', analyticsData.userMetrics);
                
            } catch (error) {
                console.error('âŒ Error calculating user metrics from Firebase:', error);
                // Set default values
                analyticsData.userMetrics = {
                    totalEarnings: 0,
                    totalJobs: 0,
                    successRate: 0,
                    averageRating: 0,
                    totalHours: 0,
                    completionRate: 0
                };
            }
        }

        // Get estimated hours for job type
        function getEstimatedHoursForJob(jobType) {
            const hourEstimates = {
                'photography': 8,
                'videography': 12,
                'editing': 16,
                'consulting': 4,
                'standard': 6,
                'premium': 10,
                'rush': 4
            };
            return hourEstimates[jobType] || 6;
        }

        // Generate performance insights from Firebase data
        async function generatePerformanceInsightsFromFirebase() {
            try {
                console.log('ðŸ”¥ Generating performance insights from Firebase...');
                
                // Get Firestore instance
                const db = window.FirebaseConfig.getFirestore();
                
                // Get current user data from Firebase
                const currentUserEmail = currentUser?.email;
                if (!currentUserEmail) {
                    console.warn('âš ï¸ No current user email available for insights generation');
                    return;
                }
                
                // Find user document in Firebase
                const usersSnapshot = await db.collection('users').get();
                let userData = null;
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.profile && data.profile.email === currentUserEmail) {
                        userData = data;
                    }
                });
                
                if (!userData) {
                    console.warn('âš ï¸ User data not found in Firebase');
                    return;
                }
                
                // Initialize performance metrics with real data
                analyticsData.performanceMetrics = {
                    monthlyEarnings: userData.performance?.monthlyEarnings || [],
                    jobCompletionTrends: userData.performance?.jobCompletionTrends || [],
                    ratingHistory: userData.performance?.ratingHistory || [],
                    paymentMethodBreakdown: userData.performance?.paymentMethodBreakdown || {},
                    timeTracking: userData.performance?.timeTracking || {},
                    skillDevelopment: userData.performance?.skillDevelopment || {}
                };
                
                // Generate business intelligence insights
                const insights = (typeof generateBusinessIntelligenceInsights === 'function')
                    ? generateBusinessIntelligenceInsights()
                    : (function fallbackInsights(){
                        try {
                            const perf = analyticsData.performanceMetrics || {};
                            const monthly = Array.isArray(perf.monthlyEarnings) ? perf.monthlyEarnings : [];
                            const last3 = monthly.slice(-3).map(m => m.amount || 0);
                            const trend = last3.length >= 2 ? (last3[last3.length-1] - last3[0]) : 0;
                            const trendLabel = trend > 0 ? 'upward' : trend < 0 ? 'downward' : 'flat';
                            const avgRating = Array.isArray(perf.ratingHistory) && perf.ratingHistory.length
                                ? perf.ratingHistory.reduce((s,r)=>s+(r.value||0),0)/perf.ratingHistory.length
                                : 0;
                            return [
                                { type: 'trend', title: 'Revenue trend', detail: trendLabel, delta: trend },
                                { type: 'quality', title: 'Average rating', value: Number(avgRating.toFixed(2)) }
                            ];
                        } catch(_) { return []; }
                    })();
                analyticsData.businessIntelligence.insights = insights;
                
                console.log('âœ… Performance insights generated from Firebase:', analyticsData.performanceMetrics);
                
            } catch (error) {
                console.error('âŒ Error generating performance insights from Firebase:', error);
                // Set default values
                analyticsData.performanceMetrics = {
                    monthlyEarnings: [],
                    jobCompletionTrends: [],
                    ratingHistory: [],
                    paymentMethodBreakdown: {},
                    timeTracking: {},
                    skillDevelopment: {}
                };
            }
        }

        // Calculate monthly earnings
        function calculateMonthlyEarnings() {
            const payments = currentUser.paymentHistory || [];
            const monthlyData = {};
            
            payments.forEach(payment => {
                if (payment.status === 'completed') {
                    const month = new Date(payment.processedAt || payment.createdAt).toISOString().substr(0, 7);
                    monthlyData[month] = (monthlyData[month] || 0) + payment.amount;
                }
            });
            
            return Object.entries(monthlyData).map(([month, amount]) => ({
                month,
                amount,
                formatted: new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' })
            })).sort((a, b) => a.month.localeCompare(b.month));
        }

        // Calculate job completion trends
        function calculateJobCompletionTrends() {
            const jobs = currentUser.jobs || [];
            const monthlyData = {};
            
            jobs.forEach(job => {
                const month = new Date(job.assignedDate || job.createdAt).toISOString().substr(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { total: 0, completed: 0 };
                }
                monthlyData[month].total++;
                if (job.status === 'completed') {
                    monthlyData[month].completed++;
                }
            });
            
            return Object.entries(monthlyData).map(([month, data]) => ({
                month,
                total: data.total,
                completed: data.completed,
                completionRate: data.total > 0 ? (data.completed / data.total) * 100 : 0,
                formatted: new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' })
            })).sort((a, b) => a.month.localeCompare(b.month));
        }

        // Calculate rating history
        function calculateRatingHistory() {
            const reviews = currentUser.performanceReviews || [];
            const monthlyData = {};
            
            reviews.forEach(review => {
                const month = new Date(review.date || review.createdAt).toISOString().substr(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { ratings: [], count: 0 };
                }
                monthlyData[month].ratings.push(review.rating || 0);
                monthlyData[month].count++;
            });
            
            return Object.entries(monthlyData).map(([month, data]) => ({
                month,
                averageRating: data.ratings.reduce((sum, rating) => sum + rating, 0) / data.ratings.length,
                count: data.count,
                formatted: new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' })
            })).sort((a, b) => a.month.localeCompare(b.month));
        }

        // Calculate payment method breakdown
        function calculatePaymentMethodBreakdown() {
            const payments = currentUser.paymentHistory || [];
            const breakdown = {};
            
            payments.forEach(payment => {
                if (payment.status === 'completed') {
                    const method = payment.method || 'unknown';
                    if (!breakdown[method]) {
                        breakdown[method] = { count: 0, amount: 0 };
                    }
                    breakdown[method].count++;
                    breakdown[method].amount += payment.amount;
                }
            });
            
            return breakdown;
        }

        // Calculate time tracking
        function calculateTimeTracking() {
            const jobs = currentUser.jobs || [];
            const timeData = {
                totalHours: 0,
                averageHoursPerJob: 0,
                mostProductiveHours: [],
                timeDistribution: {}
            };
            
            jobs.forEach(job => {
                if (job.status === 'completed') {
                    const hours = getEstimatedHoursForJob(job.type || 'standard');
                    timeData.totalHours += hours;
                    
                    // Track by job type
                    const jobType = job.type || 'standard';
                    timeData.timeDistribution[jobType] = (timeData.timeDistribution[jobType] || 0) + hours;
                }
            });
            
            timeData.averageHoursPerJob = jobs.length > 0 ? timeData.totalHours / jobs.length : 0;
            
            return timeData;
        }

        // Calculate skill development
        function calculateSkillDevelopment() {
            const reviews = currentUser.performanceReviews || [];
            const skills = {};
            
            reviews.forEach(review => {
                if (review.skills) {
                    review.skills.forEach(skill => {
                        if (!skills[skill]) {
                            skills[skill] = { count: 0, totalRating: 0 };
                        }
                        skills[skill].count++;
                        skills[skill].totalRating += review.rating || 0;
                    });
                }
            });
            
            return Object.entries(skills).map(([skill, data]) => ({
                skill,
                count: data.count,
                averageRating: data.totalRating / data.count,
                proficiency: Math.min(100, (data.count * 10) + (data.totalRating * 5))
            })).sort((a, b) => b.proficiency - a.proficiency);
        }

        // Start analytics monitoring
        function startAnalyticsMonitoring() {
            // Update analytics every 5 minutes
            setInterval(async () => {
                await calculateUserMetricsFromFirebase();
                await generatePerformanceInsightsFromFirebase();
            }, 300000);
        }
        // Show advanced analytics dashboard
        function showAdvancedAnalyticsDashboard() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a2e; border: 1px solid #FFB200; border-radius: 16px;
                           padding: 2rem; max-width: 1200px; width: 100%; color: white;
                           max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: #FFB200; margin: 0; font-family: 'Cinzel', serif;">
                            <i class="fas fa-chart-line"></i> Advanced Analytics Dashboard
                        </h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; 
                                       border-radius: 6px; cursor: pointer; font-size: 1.2rem;">
                            Ã—
                        </button>
                    </div>
                    
                    <!-- Key Metrics Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; color: #22c55e; margin-bottom: 0.5rem;">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">
                                $${analyticsData.userMetrics.totalEarnings.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9rem;">Total Earnings</div>
                        </div>
                        
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">
                                ${analyticsData.userMetrics.totalJobs}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9rem;">Total Jobs</div>
                        </div>
                        
                        <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid #a855f7; border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; color: #a855f7; margin-bottom: 0.5rem;">
                                <i class="fas fa-star"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #a855f7;">
                                ${analyticsData.userMetrics.averageRating.toFixed(1)}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9rem;">Average Rating</div>
                        </div>
                        
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; color: #f59e0b; margin-bottom: 0.5rem;">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">
                                ${analyticsData.userMetrics.successRate.toFixed(1)}%
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9rem;">Success Rate</div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <!-- Monthly Earnings Chart -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem;">
                            <h3 style="color: #FFB200; margin: 0 0 1rem 0; font-family: 'Cinzel', serif;">
                                <i class="fas fa-chart-bar"></i> Monthly Earnings
                            </h3>
                            <div id="earningsChart" style="height: 200px; display: flex; align-items: end; gap: 4px;">
                                ${generateEarningsChart()}
                            </div>
                        </div>
                        
                        <!-- Job Completion Chart -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem;">
                            <h3 style="color: #FFB200; margin: 0 0 1rem 0; font-family: 'Cinzel', serif;">
                                <i class="fas fa-chart-pie"></i> Job Completion Rate
                            </h3>
                            <div id="completionChart" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                <div style="text-align: center;">
                                    <div style="font-size: 3rem; color: #22c55e; margin-bottom: 0.5rem;">
                                        ${analyticsData.userMetrics.completionRate.toFixed(1)}%
                                    </div>
                                    <div style="color: #9ca3af;">Completion Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Analytics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Payment Methods Breakdown -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem;">
                            <h3 style="color: #FFB200; margin: 0 0 1rem 0; font-family: 'Cinzel', serif;">
                                <i class="fas fa-credit-card"></i> Payment Methods
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${generatePaymentMethodBreakdown()}
                            </div>
                        </div>
                        
                        <!-- Skill Development -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem;">
                            <h3 style="color: #FFB200; margin: 0 0 1rem 0; font-family: 'Cinzel', serif;">
                                <i class="fas fa-graduation-cap"></i> Skill Development
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${generateSkillDevelopment()}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 178, 0, 0.2);">
                        <h3 style="color: #FFB200; margin: 0 0 1rem 0; font-family: 'Cinzel', serif;">
                            <i class="fas fa-download"></i> Export Analytics
                        </h3>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button onclick="exportAnalytics('pdf')" 
                                    style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; 
                                           border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button onclick="exportAnalytics('csv')" 
                                    style="background: #22c55e; color: white; border: none; padding: 0.75rem 1.5rem; 
                                           border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button onclick="exportAnalytics('json')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; 
                                           border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-code"></i> Export JSON
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Generate earnings chart
        function generateEarningsChart() {
            const data = analyticsData.performanceMetrics.monthlyEarnings;
            if (data.length === 0) {
                return '<div style="color: #9ca3af; text-align: center; width: 100%;">No earnings data available</div>';
            }
            
            const maxAmount = Math.max(...data.map(d => d.amount));
            
            return data.map(item => {
                const height = (item.amount / maxAmount) * 150;
                return `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="background: linear-gradient(to top, #FFB200, #f59e0b); width: 20px; height: ${height}px; 
                                    border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                        <div style="font-size: 0.7rem; color: #9ca3af; transform: rotate(-45deg); white-space: nowrap;">
                            ${item.formatted}
                        </div>
                        <div style="font-size: 0.6rem; color: #FFB200; margin-top: 0.25rem;">
                            $${item.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generate payment method breakdown
        function generatePaymentMethodBreakdown() {
            const breakdown = analyticsData.performanceMetrics.paymentMethodBreakdown;
            const totalAmount = Object.values(breakdown).reduce((sum, method) => sum + method.amount, 0);
            
            if (totalAmount === 0) {
                return '<div style="color: #9ca3af; text-align: center;">No payment data available</div>';
            }
            
            return Object.entries(breakdown).map(([method, data]) => {
                const percentage = (data.amount / totalAmount) * 100;
                const methodInfo = PAYMENT_OPTIONS[method] || { name: method, icon: 'fas fa-credit-card' };
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; 
                                background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="${methodInfo.icon}" style="color: #FFB200;"></i>
                            <span>${methodInfo.name}</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #e5e7eb; font-weight: bold;">$${data.amount.toLocaleString()}</div>
                            <div style="color: #9ca3af; font-size: 0.8rem;">${percentage.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generate skill development
        function generateSkillDevelopment() {
            const skills = analyticsData.performanceMetrics.skillDevelopment;
            
            if (skills.length === 0) {
                return '<div style="color: #9ca3af; text-align: center;">No skill data available</div>';
            }
            
            return skills.slice(0, 5).map(skill => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; 
                            background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div style="color: #e5e7eb;">${skill.skill}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 60px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden;">
                            <div style="width: ${skill.proficiency}%; height: 100%; background: linear-gradient(90deg, #FFB200, #f59e0b);"></div>
                        </div>
                        <span style="color: #FFB200; font-size: 0.8rem; font-weight: bold;">${skill.proficiency}%</span>
                    </div>
                </div>
            `).join('');
        }

        // Export analytics data
        function exportAnalytics(format) {
            const data = {
                userMetrics: analyticsData.userMetrics,
                performanceMetrics: analyticsData.performanceMetrics,
                exportDate: new Date().toISOString(),
                format: format
            };
            
            let content, filename, mimeType;
            
            switch (format) {
                case 'csv':
                    content = convertToCSV(data);
                    filename = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
                case 'json':
                    content = JSON.stringify(data, null, 2);
                    filename = `analytics_${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                case 'pdf':
                    // For PDF, we'd need a PDF library like jsPDF
                    showNotification('PDF export requires additional setup', 'info', {
                        category: 'system',
                        duration: 3000
                    });
                    return;
                default:
                    return;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Analytics exported as ${format.toUpperCase()}`, 'success', {
                category: 'system',
                duration: 3000
            });
        }

        // Convert data to CSV format
        function convertToCSV(data) {
            const lines = [];
            lines.push('Metric,Value');
            lines.push(`Total Earnings,${data.userMetrics.totalEarnings}`);
            lines.push(`Total Jobs,${data.userMetrics.totalJobs}`);
            lines.push(`Success Rate,${data.userMetrics.successRate}%`);
            lines.push(`Average Rating,${data.userMetrics.averageRating}`);
            lines.push(`Completion Rate,${data.userMetrics.completionRate}%`);
            lines.push(`Total Hours,${data.userMetrics.totalHours}`);
            lines.push('');
            lines.push('Payment Methods,Count,Amount');
            
            Object.entries(data.performanceMetrics.paymentMethodBreakdown).forEach(([method, info]) => {
                lines.push(`${method},${info.count},${info.amount}`);
            });
            
            return lines.join('\n');
        }

        // ==================== PHASE 3: TEAM COLLABORATION TOOLS ====================
        // Note: Team collaboration features have been integrated into the Community section
        // for better user experience and to avoid confusion between multiple messaging systems.





        // Payment modal functionality
        function showPaymentModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                backdrop-filter: blur(10px);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #1a1a2e;
                    border-radius: 20px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 1px solid rgba(255,255,255,0.1);
                    position: relative;
                ">
                    <button onclick="closePaymentModal()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: none;
                        border: none;
                        color: rgba(255,255,255,0.7);
                        font-size: 1.5rem;
                        cursor: pointer;
                        padding: 0.5rem;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                        Ã—
                    </button>
                    
                    <h2 style="color: #FFB200; margin-bottom: 1.5rem; font-family: 'Cinzel', serif;">
                        <i class="fas fa-credit-card"></i> Set Payment Method
                    </h2>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem;">
                            Please select your preferred payment method for receiving payments.
                        </p>
                        
                        <div style="display: grid; gap: 1rem;">
                            ${Object.entries(PAYMENT_OPTIONS).map(([key, option]) => `
                                <button onclick="setPaymentMethod('${key}')" style="
                                    background: ${option.gradient};
                                    color: white;
                                    border: none;
                                    padding: 1rem;
                                    border-radius: 10px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="${option.icon}"></i>
                                    ${option.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin: 0;">
                            <i class="fas fa-info-circle"></i>
                            Your payment method will be securely stored and used for all future payments.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePaymentModal();
                }
            });
        }

        function closePaymentModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
            if (modal) {
                modal.remove();
            }
        }
        function setPaymentMethod(method) {
            if (!currentUser) return;
            
            // Special handling for bank transfer
            if (method === 'bank') {
                closePaymentModal();
                const bankModal = new SecureBankModal();
                bankModal.showBankDetailsModal();
                return;
            }
            
            // Update user's payment method locally
            currentUser.paymentMethod = method;
            
            // Show user-specific notification
            showUserNotification(
                'Payment Method Updated',
                `âœ… Payment method set to ${method.charAt(0).toUpperCase() + method.slice(1)}`,
                'success',
                { action: 'payment_method_update', method: method }
            );
            
            // Close modal
            closePaymentModal();
            
            // Save to backend (Firestore)
            updateUserPaymentMethod(currentUser.email, method).then(() => {
                console.log('âœ… Payment method saved to backend successfully');
                showUserNotification(
                    'Payment Method Saved',
                    'âœ… Payment method saved to server successfully',
                    'success',
                    { action: 'payment_method_saved', method: method }
                );
            }).catch((error) => {
                console.error('âŒ Error saving payment method to backend:', error);
                showUserNotification(
                    'Payment Method Warning',
                    'âš ï¸ Payment method saved locally but server update failed',
                    'warning',
                    { action: 'payment_method_warning', method: method }
                );
            });
            
            // Refresh the payment display
            displayUserInfo();
            
            // Also refresh the jobs display to show updated payment method
            displayCurrentJobs();
        }

        function switchPortalTab(tabName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Show selected section
            const selectedSection = document.getElementById(`${tabName}-section`);
            if (selectedSection) {
                selectedSection.classList.add('active');
            }
            
            // Update navigation
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            const activeLink = document.querySelector(`[onclick="showSection('${tabName}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            console.log('ðŸ“‘ Switched to section:', tabName);
            
            // Refresh profile pictures when switching tabs
            if (currentUser && currentUser.profilePicture) {
                displayProfilePicture(currentUser.profilePicture);
            }

            // Initialize avatar upload handlers when landing on profile or community sections
            if (tabName === 'profile' || tabName === 'community') {
                try { initializeProfilePicture(); } catch(_) {}
            }
            
            // Initialize equipment center when switching to equipment section
            if (tabName === 'equipment') {
                setTimeout(() => {
                    try { initializeEquipmentCenter(); } catch(e) { console.warn('equipment init skipped', e); }
                }, 100);
            }
        }

        function showSection(sectionName) {
            switchPortalTab(sectionName);
        }

        // Equipment Center scripts
        async function initializeEquipmentCenter() {
            try {
                await ensureFirestoreReady();
                await Promise.all([
                    loadEquipment(),
                    loadResources(),
                    loadEquipmentRequests(),
                    loadRentedEquipment(),
                    loadMaintenance()
                ]);
                renderEquipmentList();
                renderResourceList();
                renderEquipmentRequests();
                renderRentedEquipment();
                renderMaintenanceList();
            } catch (e) {
                console.warn('âš ï¸ initializeEquipmentCenter error:', e?.message || e);
            }
        }

        async function ensureFirestoreReady() {
            if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                try { await window.FirestoreDataManager.init(); } catch(_) {}
            }
        }

        // Data caches
        let _equipment = [];
        let _resources = [];
        let _equipmentRequests = [];
        let _rentedEquipment = [];
        let _maintenance = [];

        async function loadEquipment() {
            if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                _equipment = await window.FirestoreDataManager.getEquipment();
            }
        }
        async function loadResources() {
            if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                _resources = await window.FirestoreDataManager.getResources();
            }
        }
        async function loadEquipmentRequests() {
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const email = (currentUser && currentUser.email) ? currentUser.email : (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : '';
                    console.log('ðŸ”„ Loading equipment requests for user:', email);
                    _equipmentRequests = await window.FirestoreDataManager.getEquipmentRequests({ userEmail: email });
                    console.log('âœ… Loaded equipment requests:', _equipmentRequests);
                } else {
                    console.warn('âš ï¸ FirestoreDataManager not available for loading equipment requests');
                    _equipmentRequests = [];
                }
            } catch (e) {
                console.error('âŒ Error loading equipment requests:', e);
                _equipmentRequests = [];
            }
        }
        async function loadMaintenance() {
            if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                _maintenance = await window.FirestoreDataManager.getMaintenance();
            }
        }
        
        async function loadRentedEquipment() {
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const email = (currentUser && currentUser.email) ? currentUser.email : (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : '';
                    console.log('ðŸ”„ Loading rented equipment for user:', email);
                    const allEquipment = await window.FirestoreDataManager.getEquipment();
                    _rentedEquipment = allEquipment.filter(item => 
                        item.rental && 
                        item.rental.userEmail && 
                        item.rental.userEmail.toLowerCase() === email.toLowerCase()
                    );
                    console.log('âœ… Loaded rented equipment:', _rentedEquipment);
                    renderRentedEquipment();
                } else {
                    console.warn('âš ï¸ FirestoreDataManager not available for loading rented equipment');
                    _rentedEquipment = [];
                }
            } catch (e) {
                console.error('âŒ Error loading rented equipment:', e);
                _rentedEquipment = [];
            }
        }
        
        function renderRentedEquipment() {
            const container = document.getElementById('rentedEquipmentList');
            if (!container) {
                console.warn('âš ï¸ rentedEquipmentList container not found');
                return;
            }
            
            console.log('ðŸ”„ Rendering rented equipment:', _rentedEquipment);
            
            if (!_rentedEquipment || _rentedEquipment.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                        <i class="fas fa-hand-holding" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>No rented equipment found</p>
                        <small>Your approved equipment requests will appear here</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = _rentedEquipment.map(item => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                        <div style="flex: 1;">
                            <div style="font-weight:700; color:#FFB200;">${item.name || 'Unnamed'}</div>
                            <div class="equipment-meta">
                                <span>${item.category || 'General'}</span>
                                <span class="status-${item.status || 'checked_out'}">${item.status || 'checked_out'}</span>
                                ${item.serialNumber ? `<span>SN: ${item.serialNumber}</span>` : ''}
                            </div>
                            
                            ${item.rental ? `
                                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px;">
                                    <div style="color: #22c55e; font-weight: 600; font-size: 0.85rem; margin-bottom: 4px;">
                                        <i class="fas fa-check-circle"></i> RENTED TO YOU
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.8rem;">
                                        <div><strong>Checked out:</strong> ${new Date(item.rental.checkedOutAt).toLocaleString()}</div>
                                        <div><strong>Due back:</strong> ${new Date(item.rental.dueBackAt).toLocaleString()}</div>
                                        ${item.rental.notes ? `<div><strong>Notes:</strong> ${item.rental.notes}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            console.log('âœ… Rented equipment rendered successfully');
        }

        function switchEquipmentTab(tabName) {
            const tabs = ['library','resources','requests','rented','maintenance'];
            // Hide all tab contents and remove active class
            tabs.forEach(name => {
                const el = document.getElementById(`equipment-${name}-tab`);
                if (el) {
                    el.classList.remove('active');
                    el.style.display = 'none';
                }
            });

            // Show the selected tab content (ensure inline style doesn't override)
            const activeEl = document.getElementById(`equipment-${tabName}-tab`);
            if (activeEl) {
                activeEl.classList.add('active');
                activeEl.style.display = '';
            }

            // Update active state on buttons
            document.querySelectorAll('.performance-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`.performance-tabs .tab-btn[onclick="switchEquipmentTab('${tabName}')"]`);
            if (btn) btn.classList.add('active');
            
            // Refresh data for specific tabs when opened
            if (tabName === 'rented') {
                loadRentedEquipment();
            }
            if (tabName === 'requests') {
                // Ensure equipment list is loaded to populate dropdown
                Promise.resolve(loadEquipment()).then(() => {
                    renderRequestItemOptions();
                });
                loadEquipmentRequests().then(() => renderEquipmentRequests());
            }
        }

        function renderEquipmentList() {
            const container = document.getElementById('equipmentList');
            if (!container) return;
            const q = (document.getElementById('equipmentSearch')?.value || '').toLowerCase();
            const status = document.getElementById('equipmentStatusFilter')?.value || '';
            const filtered = _equipment.filter(item => {
                const matchesText = !q || [item.name, item.category, ...(item.tags||[])].filter(Boolean).join(' ').toLowerCase().includes(q);
                const matchesStatus = !status || (item.status === status);
                return matchesText && matchesStatus;
            });
            container.innerHTML = filtered.map(item => {
                const tags = (item.tags||[]).map(t => `<span class="chip">${t}</span>`).join(' ');
                return `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#FFB200;">${item.name || 'Unnamed'}</div>
                            <div class="equipment-meta">
                                <span>${item.category || 'General'}</span>
                                <span class="status-${item.status||'available'}">${item.status || 'available'}</span>
                                ${item.serialNumber ? `<span>SN: ${item.serialNumber}</span>` : ''}
                                ${tags}
                            </div>
                        </div>
                        <div>
                            ${item.status === 'available' ? `<button class="btn btn-secondary" onclick="prefillRequest('${item.id}','${(item.name||'').replace(/'/g, "\'")}')">Request</button>` : ''}
                        </div>
                    </div>
                </div>`
            }).join('');
        }

        function renderResourceList() {
            const container = document.getElementById('resourceList');
            if (!container) return;
            container.innerHTML = _resources.map(r => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#FFB200;">${r.title || 'Untitled'}</div>
                            <div class="equipment-meta">
                                <span>${r.type || 'document'}</span>
                                ${r.version ? `<span>v${r.version}</span>` : ''}
                                ${(r.tags||[]).map(t => `<span class='chip'>${t}</span>`).join(' ')}
                            </div>
                        </div>
                        <div>
                            ${r.url ? `<a class="btn btn-secondary" href="${r.url}" target="_blank" rel="noopener">Download</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRequestItemOptions() {
            try {
                const select = document.getElementById('requestItemsSelect');
                if (!select) return;
                // Build options from available equipment only
                const available = (_equipment||[]).filter(item => (item.status||'available') === 'available');
                const currentSelections = new Set(Array.from(select.selectedOptions||[]).map(o => o.value));
                select.innerHTML = available
                    .sort((a,b) => (a.name||'').localeCompare(b.name||''))
                    .map(item => `<option value="${(item.name||'Unnamed').replace(/"/g,'&quot;')}">${item.name||'Unnamed'}${item.serialNumber?` â€” ${item.serialNumber}`:''}</option>`)
                    .join('');
                // Re-apply previous selections if still available
                Array.from(select.options).forEach(opt => { if (currentSelections.has(opt.value)) opt.selected = true; });
            } catch(_) {}
        }

        async function prefillRequest(equipmentId, equipmentName) {
            try {
                // First switch to the requests tab
                switchEquipmentTab('requests');
                // Ensure the dropdown is populated and select the item
                renderRequestItemOptions();
                const select = document.getElementById('requestItemsSelect');
                if (select) {
                    // Try to find matching option by name (case-insensitive)
                    const nameLower = String(equipmentName||'').toLowerCase();
                    Array.from(select.options).forEach(opt => {
                        if (opt.value.toLowerCase() === nameLower) opt.selected = true;
                    });
                    select.focus();
                }
            } catch(e) {
                console.error('Error in prefillRequest:', e);
                showNotification('Failed to create request', 'error');
            }
        }
        
        async function createQuickEquipmentRequest(equipmentId, equipmentName) {
            try {
                const email = (currentUser && currentUser.email) ? currentUser.email : (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : '';
                const name = currentUser?.name || currentUser?.profile?.name || '';
                
                if (!email) {
                    showNotification('Please log in to request equipment', 'error');
                    return;
                }
                
                await ensureFirestoreReady();
                
                const requestData = {
                    equipmentId: equipmentId,
                    equipmentName: equipmentName,
                    items: [equipmentName],
                    neededFrom: null,
                    neededTo: null,
                    notes: `Quick request for ${equipmentName}`,
                    status: 'pending',
                    userEmail: email,
                    userName: name,
                    requestedBy: email,
                    requestedByName: name,
                    createdAt: new Date().toISOString()
                };
                
                await window.FirestoreDataManager.createEquipmentRequest(requestData);
                showNotification(`Request created for ${equipmentName}`, 'success');
                
                // Reload and display the requests
                await loadEquipmentRequests();
                renderEquipmentRequests();
                
            } catch(e) {
                console.error('Error creating quick equipment request:', e);
                showNotification('Failed to create request', 'error');
            }
        }
        async function loadEquipmentRequests() {
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const list = await window.FirestoreDataManager.getEquipmentRequestsByEmail(currentUser.email);
                    window._equipmentRequests = list || [];
                } else {
                    window._equipmentRequests = [];
                }
            } catch (e) {
                console.error('Failed to load equipment requests', e);
                window._equipmentRequests = [];
            }
        }

        function switchEquipmentTab(tabName) {
            const tabs = ['library','resources','requests','rented','maintenance'];
            // Hide all tab contents and remove active class
            document.querySelectorAll('.performance-tab-content').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); });
            // Show selected tab
            const target = document.getElementById(`equipment-${tabName}-tab`);
            if (target) { target.style.display = 'block'; target.classList.add('active'); }

            // Update active state on buttons
            document.querySelectorAll('.performance-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`.performance-tabs .tab-btn[onclick="switchEquipmentTab('${tabName}')"]`);
            if (btn) btn.classList.add('active');
            
            if (tabName === 'library') {
                // Ensure filters and list are rendered
                renderEquipmentList();
            } else if (tabName === 'resources') {
                renderResources();
            } else if (tabName === 'requests') {
                // Only load and render existing requests; no manual form
                loadEquipmentRequests().then(() => renderEquipmentRequests());
            } else if (tabName === 'rented') {
                loadRentedEquipment();
            } else if (tabName === 'maintenance') {
                loadMaintenance();
            }
        }

        // Removed submitEquipmentRequest form handler; requests are created via Gear Library Request button

        function renderEquipmentRequests() {
            const container = document.getElementById('equipmentRequestList');
            if (!container) {
                console.warn('âš ï¸ equipmentRequestList container not found');
                return;
            }
            
            console.log('ðŸ”„ Rendering equipment requests:', _equipmentRequests);
            
            if (!_equipmentRequests || _equipmentRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                        <i class="fas fa-list" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>No equipment requests found</p>
                        <small>Click "Request" on any equipment to create a request</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = _equipmentRequests.map(req => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#FFB200;">${(req.items||[]).join(', ')}</div>
                            <div class="equipment-meta">
                                <span class="status-${req.status || 'pending'}">${req.status || 'pending'}</span>
                                ${req.neededFrom ? `<span>From: ${req.neededFrom}</span>` : ''}
                                ${req.neededTo ? `<span>To: ${req.neededTo}</span>` : ''}
                            </div>
                            ${req.notes ? `<div style="color:#9ca3af; font-size:0.85rem; margin-top:4px;">${req.notes}</div>` : ''}
                        </div>
                        <div style="color:#9ca3af; font-size:0.85rem;">${new Date(req.createdAt||Date.now()).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            
            console.log('âœ… Equipment requests rendered successfully');
        }

        function renderMaintenanceList() {
            const container = document.getElementById('maintenanceList');
            if (!container) return;
            container.innerHTML = _maintenance.map(m => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                        <div>
                            <div style="font-weight:700; color:#FFB200;">${m.title || 'Maintenance'}</div>
                            <div class="equipment-meta">
                                ${m.scheduledDate ? `<span>${new Date(m.scheduledDate).toLocaleDateString()}</span>` : ''}
                                ${m.status ? `<span>${m.status}</span>` : ''}
                            </div>
                        </div>
                        <div style="color:#9ca3af; font-size:0.85rem;">${m.equipmentId ? `Item: ${m.equipmentId}` : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // View contract details
        function viewContractDetails() {
            console.log('ðŸ‘ï¸ View details button clicked');
            console.log('ðŸ‘¤ Current user:', currentUser);
            console.log('ðŸ“‹ Uploaded contracts:', uploadedContracts);
            
            // Check if user has uploaded contract
            const userContract = uploadedContracts.find(contract => 
                contract.freelancerEmail.toLowerCase() === currentUser.email.toLowerCase()
            );
            
            console.log('ðŸ“„ Found user contract:', userContract);
            
            if (!userContract) {
                // If no uploaded contract, check if contract is signed but not uploaded
                if (currentUser.contractStatus === 'signed') {
                    showContractDetailsModal({
                        title: 'Contract Processing',
                        message: 'Your contract has been signed and is being processed by admin. You will be able to view details once it\'s uploaded.',
                        type: 'processing'
                    });
                } else {
                    showContractDetailsModal({
                        title: 'No Contract Found',
                        message: 'No contract found for your account. Please sign your contract first.',
                        type: 'error'
                    });
                }
                return;
            }
            
            // Show custom modal with contract details
            showContractDetailsModal({
                title: 'Contract Details',
                contract: userContract,
                type: 'details'
            });
        }

        // Custom contract details modal
        function showContractDetailsModal(data) {
            // Remove existing modal if any
            const existingModal = document.getElementById('contractDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'contractDetailsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease-out;
            `;

            let modalContent = '';
            
            if (data.type === 'details' && data.contract) {
                const contract = data.contract;
                modalContent = `
                    <div class="contract-modal-content">
                        <div class="contract-modal-header">
                            <div class="contract-modal-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <h2>COCHRAN FILMS - CONTRACT DETAILS</h2>
                            <button class="contract-modal-close" onclick="closeContractModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="contract-modal-body">
                            <div class="contract-section">
                                <h3><i class="fas fa-clipboard-list"></i> BASIC INFO</h3>
                                <div class="contract-info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Contract ID:</span>
                                        <span class="info-value">${contract.contractId || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Freelancer:</span>
                                        <span class="info-value">${contract.freelancerEmail || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Role:</span>
                                        <span class="info-value">${contract.role || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Rate:</span>
                                        <span class="info-value">${contract.rate || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Location:</span>
                                        <span class="info-value">${contract.location || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Contract Date:</span>
                                        <span class="info-value">${contract.contractDate || 'Not specified'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="contract-section">
                                <h3><i class="fas fa-file"></i> FILE INFO</h3>
                                <div class="contract-info-grid">
                                    <div class="info-item">
                                        <span class="info-label">File Name:</span>
                                        <span class="info-value">${contract.fileName || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">File Size:</span>
                                        <span class="info-value">${contract.fileSize ? (contract.fileSize / 1024).toFixed(1) + ' KB' : 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Upload Date:</span>
                                        <span class="info-value">${contract.uploadDate ? new Date(contract.uploadDate).toLocaleString() : 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Status:</span>
                                        <span class="info-value status-${contract.status || 'unknown'}">${contract.status || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${contract.notes ? `
                            <div class="contract-section">
                                <h3><i class="fas fa-sticky-note"></i> NOTES</h3>
                                <div class="contract-notes">
                                    ${contract.notes}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="contract-modal-footer">
                            <button class="btn btn-primary" onclick="downloadUserContract()">
                                <i class="fas fa-download"></i>
                                Download PDF
                            </button>
                            <button class="btn btn-secondary" onclick="closeContractModal()">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Error or processing message
                const iconClass = data.type === 'error' ? 'fa-exclamation-triangle' : 'fa-clock';
                const iconColor = data.type === 'error' ? '#ff6b6b' : '#FFB200';
                
                modalContent = `
                    <div class="contract-modal-content">
                        <div class="contract-modal-header">
                            <div class="contract-modal-icon" style="color: ${iconColor};">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <h2>${data.title}</h2>
                            <button class="contract-modal-close" onclick="closeContractModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="contract-modal-body">
                            <div class="contract-message">
                                <p>${data.message}</p>
                            </div>
                        </div>
                        
                        <div class="contract-modal-footer">
                            <button class="btn btn-primary" onclick="closeContractModal()">
                                OK
                            </button>
                        </div>
                    </div>
                `;
            }

            modal.innerHTML = modalContent;
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeContractModal();
                }
            });

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeContractModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Close contract modal
        function closeContractModal() {
            const modal = document.getElementById('contractDetailsModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Download user contract with robust fallbacks (Firestore â†’ local file â†’ API stream)
        function downloadUserContract(jobId = null) {
            console.log('ðŸ“¥ Download contract button clicked');
            console.log('ðŸ‘¤ Current user:', currentUser);
            console.log('ðŸ“‹ Uploaded contracts:', uploadedContracts);

            try {
                const userEmailLower = (currentUser && currentUser.email) ? currentUser.email.toLowerCase() : '';
                if (!userEmailLower) {
                    showNotification('Unable to determine your account email for download.', 'error');
                    return;
                }

                // Find the latest uploaded contract for the current user
                const matchingContracts = (uploadedContracts || []).filter(contract => {
                    const cEmail = (contract && (contract.freelancerEmail || contract.userEmail))
                        ? String(contract.freelancerEmail || contract.userEmail).toLowerCase() : '';
                    return cEmail && cEmail === userEmailLower;
                });

                const userContract = matchingContracts.length > 0 ? matchingContracts[0] : null;
                console.log('ðŸ“„ Found user contract:', userContract);

                if (!userContract) {
                    if (currentUser.contractStatus === 'signed') {
                        showNotification("Your contract is signed and being processed. You'll be able to download it once uploaded.", 'info');
                    } else {
                        showNotification('No contract found. Please sign your contract first.', 'warning');
                    }
                    return;
                }

                const fileName = userContract.fileName || `${currentUser.name}.pdf`;
                const candidates = [];
                if (userContract.fileUrl) candidates.push(userContract.fileUrl);
                candidates.push(`/contracts/${encodeURIComponent(fileName)}`);
                candidates.push(`/api/contracts?filename=${encodeURIComponent(fileName)}`);

                const testHead = async (url) => {
                    try {
                        const resp = await fetch(url, { method: 'HEAD' });
                        return resp.ok;
                    } catch (_) {
                        return false;
                    }
                };

                (async () => {
                    for (const url of candidates) {
                        const ok = await testHead(url);
                        if (ok) {
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            link.target = '_blank';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            console.log('âœ… Contract download initiated:', fileName);
                            return;
                        }
                    }
                    console.warn('âŒ Contract file not available via known sources:', fileName);
                    showNotification('Contract file is not available yet. Please try again later or contact support.', 'error');
                })();
            } catch (err) {
                console.error('âŒ Error during contract download:', err);
                showNotification('Unable to download your contract due to an unexpected error.', 'error');
            }
        }

        // ==================== PRIORITY JOBS FUNCTIONALITY ====================
        
        // Priority Jobs Data Management
        let priorityJobsData = [];
        let filteredPriorityJobs = [];
        let quickApplyCount = 0;

        // Load Priority Jobs from Firestore
        async function loadPriorityJobs() {
            try {
                console.log('ðŸ”„ Loading priority jobs...');
                
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const jobs = await window.FirestoreDataManager.getJobListings();
                    if (Array.isArray(jobs) && jobs.length > 0) {
                        // Filter out inactive jobs and applicant submissions
                        priorityJobsData = jobs.filter(job => {
                            const cleanStatus = String(job.status || '').toLowerCase().trim();
                            const isActive = cleanStatus === 'active';
                            
                            // Derive title from multiple fields
                            const derivedTitle = (
                                job.title || job.Title || job.jobTitle || 
                                job.position || job['Job Title'] || 
                                job['Applying For Which Job'] || 
                                job['applying_for_which_job'] || ''
                            );
                            
                            // Check for applicant info
                            const hasApplicantInfo = job.email || job.Email || job.phone || 
                                                   job.Phone || job['Full Name'] || 
                                                   job.full_name || job.name;
                            
                            return isActive && derivedTitle.trim().length > 0 && !hasApplicantInfo;
                        });
                        
                        console.log('âœ… Priority jobs loaded:', priorityJobsData.length);
                        filteredPriorityJobs = [...priorityJobsData];
                        renderPriorityJobs();
                        updatePriorityStats();
                    } else {
                        console.log('ðŸ“ No jobs found in Firestore');
                        priorityJobsData = [];
                        filteredPriorityJobs = [];
                        renderPriorityJobs();
                    }
                } else {
                    console.log('âŒ Firestore not available');
                    priorityJobsData = [];
                    filteredPriorityJobs = [];
                    renderPriorityJobs();
                }
            } catch (error) {
                console.error('âŒ Error loading priority jobs:', error);
                priorityJobsData = [];
                filteredPriorityJobs = [];
                renderPriorityJobs();
            }
        }

        // Render Priority Jobs
        function renderPriorityJobs() {
            const container = document.getElementById('priorityJobsContent');
            if (!container) return;

            if (filteredPriorityJobs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“‹</div>
                        <h3>No Priority Jobs Available</h3>
                        <p>Check back soon for new opportunities or contact admin for exclusive access.</p>
                    </div>
                `;
                return;
            }

            const jobsHTML = filteredPriorityJobs.map(job => createPriorityJobCard(job)).join('');
            container.innerHTML = jobsHTML;
        }

        // Create Priority Job Card
        function createPriorityJobCard(job) {
            const jobTitle = job.title || job.Title || job.jobTitle || 'Position';
            const eventDate = job.date || job.Date || job['Date of Event'] || '';
            const jobLocation = job.location || job.Location || 'Atlanta Area';
            const jobPay = job.pay || job.Pay || job.salary || 'Competitive Pay';
            const jobDescription = job.description || job.Description || 'Full details will be provided upon application.';
            
            // Determine if this is an exclusive job (future feature)
            const isExclusive = job.exclusive || false;
            const badgeClass = isExclusive ? 'exclusive-badge' : 'priority-badge';
            const badgeText = isExclusive ? 'Exclusive' : 'Priority';
            
            // Format date (use local-safe parser to avoid UTC shifting YYYY-MM-DD)
            const _d = eventDate ? parseDateFlexible(eventDate) : null;
            const formattedDate = (_d && !isNaN(_d.getTime())) ? _d.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Date TBD';
            
            // Format pay
            const formattedPay = jobPay && jobPay !== 'Competitive Pay' ? 
                (jobPay.startsWith('$') ? jobPay : `$${jobPay}`) : 'Competitive Pay';

            // Escape values for safe inline attribute usage
            const _safe = (v) => String(v == null ? '' : v)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/[\n\r\t]/g, ' ');
            const sTitle = _safe(jobTitle);
            const sDate = _safe(eventDate);
            const sLoc = _safe(jobLocation);
            const sPay = _safe(jobPay);
            const sDesc = _safe(jobDescription);

            return `
                <div class="priority-job-card" data-job-id="${job.id || jobTitle.replace(/\s+/g, '-').toLowerCase()}">
                    <div class="${badgeClass}">${badgeText}</div>
                    
                    <div class="job-card-header">
                        <h3 class="job-title">${jobTitle}</h3>
                        <div class="job-meta">
                            <div class="job-meta-item">
                                <span class="job-meta-icon">ðŸ“…</span>
                                <span>${formattedDate}</span>
                            </div>
                            <div class="job-meta-item">
                                <span class="job-meta-icon">ðŸ“</span>
                                <span>${jobLocation}</span>
                            </div>
                            <div class="job-pay">${formattedPay}</div>
                        </div>
                    </div>
                    
                    <div class="job-description">
                        <p>${jobDescription}</p>
                    </div>
                    
                    <div class="job-actions">
                        <button class="btn-quick-apply" onclick="quickApplyToJob('${sTitle}', '${sDate}', '${sLoc}', '${sPay}', '${sDesc}')">
                            <i class="fas fa-bolt"></i>
                            Quick Apply
                        </button>
                        <button class="btn-details" onclick="showJobDetails('${sTitle}', '${sDate}', '${sLoc}', '${sPay}', '${sDesc}')">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                    </div>
                </div>
            `;
        }

        // Quick Apply to Job
        async function quickApplyToJob(jobTitle, eventDate, location, pay, description) {
            try {
                if (!currentUser) {
                    showNotification('Please log in to apply for jobs', 'error');
                    return;
                }

                // Find matching job in current priority jobs (prefer Firestore id)
                let matchedJob = null;
                try {
                    matchedJob = (filteredPriorityJobs || []).find(j => {
                        const jt = (j.title || j.Title || j.jobTitle || '').trim();
                        return jt === jobTitle;
                    }) || null;
                } catch (_) {}

                const jobId = matchedJob?.id || `slug-${jobTitle.replace(/\s+/g,'-').toLowerCase()}`;

                // Compose applicant data
                const applicant = {
                    uid: currentUser?.id || currentUser?.uid || null,
                    name: currentUser?.name || currentUser?.profile?.name || '',
                    email: (currentUser?.email || currentUser?.profile?.email || '').toLowerCase(),
                    phone: currentUser?.profile?.phone || '',
                    portfolio: currentUser?.profile?.portfolio || '',
                    avatarUrl: currentUser?.profile?.avatarUrl || null
                };

                // Ensure Firestore manager is ready
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    try {
                        const appId = await window.FirestoreDataManager.addQuickApplication({
                            source: 'quick_apply',
                            status: 'new',
                            jobId: jobId,
                            jobTitle: jobTitle,
                            jobDate: eventDate || null,
                            location: location || '',
                            payDisplay: pay || '',
                            priority: true,
                            applicant
                        });

                        // Optimistic local performance log (if structure exists)
                        try {
                            if (window.performanceData) {
                                window.performanceData.applications = window.performanceData.applications || [];
                                const exists = window.performanceData.applications.some(a => a.id === appId);
                                if (!exists) {
                                    window.performanceData.applications.unshift({ id: appId, jobTitle, status: 'pending', date: new Date().toISOString() });
                                }
                            }
                        } catch (_) {}

                        // Show toast and optionally notify admin (webhook/email placeholder)
                        showNotification('Application sent! Admin will review shortly.', 'success', { priority: 'high' });
                        try {
                            // Optional webhook: replace URL with actual automation endpoint if available
                            const webhookUrl = (window.CONFIG && window.CONFIG.webhooks && window.CONFIG.webhooks.applicationCreated) || null;
                            if (webhookUrl) {
                                fetch(webhookUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ type: 'application_created', appId, jobId, jobTitle, applicant: { email: applicant.email, name: applicant.name } })
                                }).catch(() => {});
                            }
                        } catch (_) {}
                    } catch (e) {
                        console.error('âŒ addApplication failed, falling back to prefill URL:', e);
                        // Fallback to prefilled form
                        const applyUrl = generateQuickApplyUrl(jobTitle, eventDate, location, pay, description);
                        window.open(applyUrl, '_blank');
                        showNotification('Opened apply form. If issues persist, contact admin.', 'warning');
                    }
                } else {
                    // Firestore not available: fallback to prefilled form
                    const applyUrl = generateQuickApplyUrl(jobTitle, eventDate, location, pay, description);
                    window.open(applyUrl, '_blank');
                    showNotification('Opened apply form (offline mode).', 'info');
                }

                // Track quick apply
                quickApplyCount++;
                updatePriorityStats();
            } catch (err) {
                console.error('âŒ Quick Apply error:', err);
                showNotification('Could not submit application. Please try again.', 'error');
            }
        }

        // Generate Quick Apply URL
        function generateQuickApplyUrl(jobTitle, eventDate, location, pay, description) {
            const params = new URLSearchParams();
            params.append('applyingFor', jobTitle);
            params.append('eventDate', eventDate);
            params.append('location', location);
            params.append('pay', pay);
            params.append('description', description);
            
            // Add user data for pre-filling
            if (currentUser) {
                if (currentUser.profile?.email) params.append('email', currentUser.profile.email);
                if (currentUser.profile?.location) params.append('location', currentUser.profile.location);
                if (currentUser.profile?.phone) params.append('phone', currentUser.profile.phone);
            }
            
            return `/apply.html?${params.toString()}`;
        }

        // Show Job Details Modal
        function showJobDetails(jobTitle, eventDate, location, pay, description) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            // Escape for inline attribute usage in this modal block
            const _safe = (v) => String(v == null ? '' : v)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/[\n\r\t]/g, ' ');
            const sTitle = _safe(jobTitle);
            const sDate = _safe(eventDate);
            const sLoc = _safe(location);
            const sPay = _safe(pay);
            const sDesc = _safe(description);

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border: 1px solid rgba(255, 178, 0, 0.3); border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #FFB200; margin: 0; font-family: 'Cinzel', serif;">Job Details</h2>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h3 style="color: white; margin-bottom: 0.5rem;">${jobTitle}</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: rgba(255, 255, 255, 0.8);">
                                <span style="color: #FFB200;">ðŸ“…</span>
                                <span>${(parseDateFlexible(eventDate) && !isNaN(parseDateFlexible(eventDate).getTime())) ? parseDateFlexible(eventDate).toLocaleDateString() : 'Date TBD'}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: rgba(255, 255, 255, 0.8);">
                                <span style="color: #FFB200;">ðŸ“</span>
                                <span>${location}</span>
                            </div>
                            <div style="background: linear-gradient(135deg, #FFB200, #FFD700); color: #1a1a1a; padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
                                ${pay.startsWith('$') ? pay : `$${pay}`}
                            </div>
                        </div>
                        <p style="color: rgba(255, 255, 255, 0.8); line-height: 1.6;">${description}</p>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="quickApplyToJob('${sTitle}', '${sDate}', '${sLoc}', '${sPay}', '${sDesc}'); this.closest('div').parentElement.remove();" 
                                style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; flex: 1;">
                            <i class="fas fa-bolt"></i> Quick Apply
                        </button>
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="background: transparent; color: #FFB200; border: 1px solid #FFB200; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Filter Priority Jobs
        function filterPriorityJobs() {
            const typeFilter = document.getElementById('jobTypeFilter')?.value || '';
            const locationFilter = document.getElementById('locationFilter')?.value || '';

            filteredPriorityJobs = priorityJobsData.filter(job => {
                const jobTitle = (job.title || job.Title || '').toLowerCase();
                const jobLocation = (job.location || job.Location || '').toLowerCase();
                
                let typeMatch = true;
                let locationMatch = true;

                if (typeFilter) {
                    typeMatch = jobTitle.includes(typeFilter.toLowerCase());
                }

                if (locationFilter) {
                    if (locationFilter === 'atlanta') {
                        locationMatch = jobLocation.includes('atlanta') || jobLocation.includes('georgia');
                    } else if (locationFilter === 'remote') {
                        locationMatch = jobLocation.includes('remote') || jobLocation.includes('virtual');
                    } else if (locationFilter === 'travel') {
                        locationMatch = jobLocation.includes('travel') || jobLocation.includes('multiple');
                    }
                }

                return typeMatch && locationMatch;
            });

            renderPriorityJobs();
            updatePriorityStats();
        }

        // Refresh Priority Jobs
        function refreshPriorityJobs() {
            loadPriorityJobs();
            showNotification('Priority jobs refreshed!', 'success');
        }

        // Update Priority Stats
        function updatePriorityStats() {
            const priorityJobCountEl = document.getElementById('priorityJobCount');
            const quickApplyCountEl = document.getElementById('quickApplyCount');
            const exclusiveJobCountEl = document.getElementById('exclusiveJobCount');

            if (priorityJobCountEl) {
                priorityJobCountEl.textContent = filteredPriorityJobs.length;
            }
            if (quickApplyCountEl) {
                quickApplyCountEl.textContent = quickApplyCount;
            }
            if (exclusiveJobCountEl) {
                const exclusiveCount = filteredPriorityJobs.filter(job => job.exclusive).length;
                exclusiveJobCountEl.textContent = exclusiveCount;
            }
        }

        // ==================== PERFORMANCE ANALYTICS FUNCTIONALITY ====================
        
        // Performance Analytics Data Management
        let performanceData = {
            earnings: [],
            applications: [],
            reviews: [],
            activities: []
        };

        // Switch Performance Tab
        function switchPerformanceTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.performance-tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            const selectedTab = document.getElementById(`performance-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const clickedButton = document.querySelector(`[onclick="switchPerformanceTab('${tabName}')"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // Load tab-specific data
            switch(tabName) {
                case 'overview':
                    loadPerformanceOverview();
                    break;
                case 'earnings':
                    loadEarningsData();
                    break;
                case 'applications':
                    loadApplicationsData();
                    break;
                case 'reviews':
                    loadPerformanceReviews();
                    break;
            }
        }

        // Load Performance Overview
        function loadPerformanceOverview() {
            updatePerformanceStats();
            loadRecentActivity();
            // Note: Charts would be implemented with a charting library like Chart.js
            // For now, we'll show placeholder content
        }

        // Update Performance Stats
        function updatePerformanceStats() {
            if (!currentUser) return;

            // Calculate total earnings
            const totalEarnings = calculateTotalEarnings();
            const earningsElement = document.getElementById('totalEarnings');
            if (earningsElement) {
                earningsElement.textContent = `$${totalEarnings.toLocaleString()}`;
            }

            // Calculate success rate
            const successRate = calculateSuccessRate();
            const successElement = document.getElementById('successRate');
            if (successElement) {
                successElement.textContent = `${successRate}%`;
            }

            // Calculate average rating
            const avgRating = calculateAverageRating();
            const ratingElement = document.getElementById('averageRating');
            if (ratingElement) {
                ratingElement.textContent = avgRating.toFixed(1);
            }

            // Calculate jobs completed this month
            const jobsCompleted = calculateJobsCompletedThisMonth();
            const jobsElement = document.getElementById('jobsCompleted');
            if (jobsElement) {
                jobsElement.textContent = jobsCompleted;
            }
        }

        // Calculate Total Earnings
        function calculateTotalEarnings() {
            if (!currentUser || !currentUser.jobs) return 0;
            
            let total = 0;
            Object.values(currentUser.jobs).forEach(job => {
                if (job.status === 'completed' && job.pay) {
                    const payAmount = parseFloat(job.pay.replace(/[^0-9.-]/g, '')) || 0;
                    total += payAmount;
                }
            });
            return total;
        }

        // Calculate Success Rate
        function calculateSuccessRate() {
            if (!currentUser || !currentUser.jobs) return 0;
            
            const jobs = Object.values(currentUser.jobs);
            if (jobs.length === 0) return 0;
            
            const completedJobs = jobs.filter(job => job.status === 'completed').length;
            return Math.round((completedJobs / jobs.length) * 100);
        }
        // Calculate Average Rating
        function calculateAverageRating() {
            if (!currentUser || !currentUser.performanceReviews) return 0;
            
            const reviews = currentUser.performanceReviews;
            if (!Array.isArray(reviews) || reviews.length === 0) return 0;
            
            const totalRating = reviews.reduce((sum, review) => {
                return sum + (parseFloat(review.rating) || 0);
            }, 0);
            
            return totalRating / reviews.length;
        }

        // Calculate Jobs Completed This Month
        function calculateJobsCompletedThisMonth() {
            if (!currentUser || !currentUser.jobs) return 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return Object.values(currentUser.jobs).filter(job => {
                if (job.status !== 'completed' || !job.completedDate) return false;
                
                const jobDate = new Date(job.completedDate);
                return jobDate.getMonth() === currentMonth && jobDate.getFullYear() === currentYear;
            }).length;
        }

        // Load Recent Activity
        function loadRecentActivity() {
            const timeline = document.getElementById('activityTimeline');
            if (!timeline) return;

            const activities = generateRecentActivities();
            timeline.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-description">${activity.description}</div>
                    </div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `).join('');
        }

        // Generate Recent Activities
        function generateRecentActivities() {
            const activities = [];
            
            if (currentUser && currentUser.jobs) {
                Object.values(currentUser.jobs).forEach(job => {
                    if (job.status === 'completed') {
                        activities.push({
                            icon: 'âœ…',
                            title: 'Job Completed',
                            description: `${job.title || 'Untitled Job'} - ${job.location || 'Location TBD'}`,
                            time: formatTimeAgo(job.completedDate || new Date())
                        });
                    }
                });
            }

            // Add application activities
            if (performanceData.applications.length > 0) {
                performanceData.applications.slice(0, 3).forEach(app => {
                    activities.push({
                        icon: 'ðŸ“',
                        title: 'Application Submitted',
                        description: `Applied for ${app.jobTitle}`,
                        time: formatTimeAgo(app.date)
                    });
                });
            }

            // Sort by date (most recent first)
            return activities.sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 5);
        }

        // Load Earnings Data
        function loadEarningsData() {
            loadEarningsTable();
            // Note: Earnings chart would be implemented with Chart.js
        }

        // Load Earnings Table
        function loadEarningsTable() {
            const tbody = document.getElementById('earningsTableBody');
            if (!tbody) return;

            const earnings = generateEarningsData();
            tbody.innerHTML = earnings.map(earning => `
                <tr>
                    <td>${earning.date}</td>
                    <td>${earning.job}</td>
                    <td>$${earning.amount.toLocaleString()}</td>
                    <td><span class="status-${earning.status.toLowerCase()}">${earning.status}</span></td>
                    <td>${earning.method}</td>
                </tr>
            `).join('');
        }

        // Generate Earnings Data
        function generateEarningsData() {
            const earnings = [];
            
            if (currentUser && currentUser.jobs) {
                Object.values(currentUser.jobs).forEach(job => {
                    if (job.status === 'completed' && job.pay) {
                        const payAmount = parseFloat(job.pay.replace(/[^0-9.-]/g, '')) || 0;
                        earnings.push({
                            date: formatDate(job.completedDate || new Date()),
                            job: job.title || 'Untitled Job',
                            amount: payAmount,
                            status: 'Paid',
                            method: 'Direct Deposit'
                        });
                    }
                });
            }

            return earnings.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Load Applications Data
        function loadApplicationsData() {
            updateApplicationsStats();
            loadApplicationsList();
        }

        // Update Applications Stats
        function updateApplicationsStats() {
            const stats = calculateApplicationStats();
            
            const totalEl = document.getElementById('totalApplications');
            const pendingEl = document.getElementById('pendingApplications');
            const acceptedEl = document.getElementById('acceptedApplications');
            const rejectedEl = document.getElementById('rejectedApplications');

            if (totalEl) totalEl.textContent = stats.total;
            if (pendingEl) pendingEl.textContent = stats.pending;
            if (acceptedEl) acceptedEl.textContent = stats.accepted;
            if (rejectedEl) rejectedEl.textContent = stats.rejected;
        }

        // Calculate Application Stats
        function calculateApplicationStats() {
            const applications = performanceData.applications;
            return {
                total: applications.length,
                pending: applications.filter(app => app.status === 'pending').length,
                accepted: applications.filter(app => app.status === 'accepted').length,
                rejected: applications.filter(app => app.status === 'rejected').length
            };
        }

        // Load Applications List
        function loadApplicationsList() {
            const container = document.getElementById('applicationsList');
            if (!container) return;

            const applications = performanceData.applications;
            container.innerHTML = applications.map(app => `
                <div class="application-item">
                    <div class="application-info">
                        <h4>${app.jobTitle}</h4>
                        <p>Applied on ${formatDate(app.date)}</p>
                    </div>
                    <div class="application-status status-${app.status}">
                        ${app.status}
                    </div>
                </div>
            `).join('');
        }

        // Load Performance Reviews (existing function)
        async function loadPerformanceReviews() {
            // Ensure callers using .then() receive a Promise
            displayUserPerformanceReviews();
        }

        // Utility Functions
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - new Date(date);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            return `${Math.floor(days / 30)} months ago`;
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Initialize Performance Analytics
        function initializePerformanceAnalytics() {
            // Load sample data for demonstration
            performanceData.applications = [
                {
                    jobTitle: 'Wedding Photography',
                    date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                    status: 'pending'
                },
                {
                    jobTitle: 'Corporate Event',
                    date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
                    status: 'accepted'
                },
                {
                    jobTitle: 'Portrait Session',
                    date: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
                    status: 'rejected'
                }
            ];

            // Load performance analytics when user data is loaded
            if (currentUser) {
                loadPerformanceOverview();
            }
        }

        // Make functions globally accessible
        window.downloadUserContract = downloadUserContract;
        window.viewContractDetails = viewContractDetails;
        window.showContractDetailsModal = showContractDetailsModal;
        window.closeContractModal = closeContractModal;
        window.loadPriorityJobs = loadPriorityJobs;
        window.filterPriorityJobs = filterPriorityJobs;
        window.refreshPriorityJobs = refreshPriorityJobs;
        window.quickApplyToJob = quickApplyToJob;
        window.showJobDetails = showJobDetails;
        window.switchPerformanceTab = switchPerformanceTab;
        window.initializePerformanceAnalytics = initializePerformanceAnalytics;

        // ==================== COMMUNITY FEATURES FUNCTIONS ====================
        
        // Profile Picture Management
        let profilePictureData = null;
        let avatarRealtimeWired = false;
        
        // Expose a global picker opener so inline onclick handlers work even before init
        try {
            window.openProfilePicker = function() {
                const inputId = 'profilePictureInput';
                let el = document.getElementById(inputId);
                if (!el) {
                    try { if (typeof initializeProfilePicture === 'function') { initializeProfilePicture(); } } catch(_) {}
                    el = document.getElementById(inputId);
                }
                if (el) { el.click(); }
            };
        } catch(_) {}

        // Initialize profile picture functionality
        function initializeProfilePicture() {
            const input = document.getElementById('profilePictureInput');
            if (input) {
                input.addEventListener('change', handleProfilePictureUpload);
            }
            
            // Load existing profile picture
            loadProfilePicture();

            // Wire real-time updates for current user's avatar once
            if (!avatarRealtimeWired && window.FirestoreDataManager && window.FirestoreDataManager.db) {
                avatarRealtimeWired = true;
                window.addEventListener('firestore:dataChange', function(event) {
                    try {
                        if (event.detail.collection !== 'users') return;
                        const data = event.detail.data || {};
                        const eventEmail = (data.profile && data.profile.email) || data.email || '';
                        if (!currentUser || !currentUser.email) return;
                        if (!eventEmail || String(eventEmail).toLowerCase() !== String(currentUser.email).toLowerCase()) return;

                        // Update current user avatar and refresh UI targets
                        const newAvatar = (data.profilePicture !== undefined && data.profilePicture !== null)
                            ? data.profilePicture
                            : (data.profile && data.profile.profilePicture) ? data.profile.profilePicture : null;
                        if (newAvatar !== undefined) {
                            currentUser.profilePicture = newAvatar;
                            displayProfilePicture(newAvatar);
                            if (document.getElementById('community-section')?.classList.contains('active')) {
                                displayContractorDirectory();
                            }
                        }
                    } catch (_) {}
                });
            }
        }
        
        // Handle profile picture upload
        async function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size must be less than 5MB', 'error');
                return;
            }
            
            try {
                const ownerEmail = currentUser && currentUser.email ? currentUser.email : '';
                const result = await window.StorageUtils.uploadFile(file, {
                    ownerEmail,
                    folder: 'avatars',
                    filename: file.name,
                    bucketURL: (window && window.FIREBASE_BUCKET_URL) || undefined,
                    onProgress: ({ percent }) => {
                        try { document.getElementById('profileUploadProgress')?.style?.setProperty('--pct', percent + '%'); } catch(_) {}
                    }
                });
                const downloadURL = result && result.downloadURL ? result.downloadURL : null;
                if (downloadURL) {
                    displayProfilePicture(downloadURL);
                    await saveProfilePicture(downloadURL);
                    showNotification('Profile photo uploaded!', 'success');
                } else {
                    showNotification('Upload failed to return a URL', 'error');
                }
            } catch (err) {
                console.error('Avatar upload failed', err);
                showNotification('Failed to upload profile photo', 'error');
            }
        }
        
        // Display profile picture
        function displayProfilePicture(imageData) {
            const img = document.getElementById('profileImage');
            const placeholder = document.getElementById('profilePicturePlaceholder');
            const removeBtn = document.getElementById('removePictureBtn');
            const headerAvatar = document.getElementById('profileHeaderAvatar');
            const headerIcon = document.getElementById('profileHeaderIcon');
            
            if (imageData) {
                if (img) {
                    img.src = imageData;
                    img.style.display = 'block';
                }
                if (placeholder) placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'inline-flex';
                if (headerAvatar) { headerAvatar.src = imageData; headerAvatar.style.display = 'block'; }
                if (headerIcon) { headerIcon.style.display = 'none'; }
                
                // Update other avatar targets across the page
                try {
                    // Update contractor directory avatars
                    document.querySelectorAll('.contractor-avatar img').forEach(el => {
                        const card = el.closest('.contractor-card');
                        const name = card?.dataset?.name || '';
                        if (currentUser && (currentUser.name === name)) {
                            el.src = imageData;
                            el.style.display = 'block';
                            const placeholder = el.parentElement.querySelector('.placeholder');
                            if (placeholder) placeholder.style.display = 'none';
                        }
                    });
                    
                    // Update showcase author avatars
                    document.querySelectorAll('.showcase-author-avatar img').forEach(el => {
                        if (currentUser && el.alt && (el.alt === currentUser.name)) {
                            el.src = imageData;
                            el.style.display = 'block';
                            const placeholder = el.parentElement.querySelector('.placeholder');
                            if (placeholder) placeholder.style.display = 'none';
                        }
                    });
                    
                    // Update message avatars
                    document.querySelectorAll('.message-avatar img').forEach(el => {
                        if (currentUser && el.alt && (el.alt === currentUser.name)) {
                            el.src = imageData;
                            el.style.display = 'block';
                            const placeholder = el.parentElement.querySelector('.placeholder');
                            if (placeholder) placeholder.style.display = 'none';
                        }
                    });
                    
                    // Update success story avatars
                    document.querySelectorAll('.success-story-avatar img').forEach(el => {
                        if (currentUser && el.alt && (el.alt === currentUser.name)) {
                            el.src = imageData;
                            el.style.display = 'block';
                            const placeholder = el.parentElement.querySelector('.placeholder');
                            if (placeholder) placeholder.style.display = 'none';
                        }
                    });
                    
                    // Update any other profile picture placeholders
                    document.querySelectorAll('.profile-picture-placeholder, .placeholder').forEach(placeholder => {
                        const parent = placeholder.parentElement;
                        const img = parent.querySelector('img');
                        if (img && currentUser && (img.alt === currentUser.name || parent.dataset.name === currentUser.name)) {
                            img.src = imageData;
                            img.style.display = 'block';
                            placeholder.style.display = 'none';
                        }
                    });
                } catch (_) {}
            } else {
                if (img) img.style.display = 'none';
                if (placeholder) placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
                if (headerAvatar) headerAvatar.style.display = 'none';
                if (headerIcon) headerIcon.style.display = 'inline-block';
                
                // Hide all user's avatars and show placeholders
                try {
                    document.querySelectorAll('.contractor-avatar img, .showcase-author-avatar img, .message-avatar img, .success-story-avatar img').forEach(el => {
                        if (currentUser && (el.alt === currentUser.name || el.closest('.contractor-card')?.dataset?.name === currentUser.name)) {
                            el.style.display = 'none';
                            const placeholder = el.parentElement.querySelector('.placeholder');
                            if (placeholder) placeholder.style.display = 'flex';
                        }
                    });
                    
                    // Show placeholders for current user
                    document.querySelectorAll('.profile-picture-placeholder, .placeholder').forEach(placeholder => {
                        const parent = placeholder.parentElement;
                        const img = parent.querySelector('img');
                        if (img && currentUser && (img.alt === currentUser.name || parent.dataset.name === currentUser.name)) {
                            img.style.display = 'none';
                            placeholder.style.display = 'flex';
                        }
                    });
                } catch (_) {}
            }
        }
        
        // Save profile picture to user data
        async function saveProfilePicture(imageData) {
            if (!currentUser || !currentUser.email) return;
            try {
                const userDocId = currentUser.email.replace(/[^a-zA-Z0-9]/g, '');
                // Persist minimal update with top-level email and profilePicture
                await window.FirestoreDataManager.setUser(userDocId, {
                    email: currentUser.email,
                    name: currentUser.name || '',
                    profile: { ...(currentUser.profile || {}), email: currentUser.email, profilePicture: imageData },
                    profilePicture: imageData
                });
                currentUser.profilePicture = imageData;
                if (document.getElementById('community-section').classList.contains('active')) {
                    displayContractorDirectory();
                }
            } catch (error) {
                console.error('Error saving profile picture:', error);
                showNotification('Failed to save profile picture', 'error');
            }
        }
        
        // Load existing profile picture
        function loadProfilePicture() {
            try {
                if (currentUser && currentUser.profilePicture) {
                    displayProfilePicture(currentUser.profilePicture);
                    return;
                }
                // Fallback: read from Firestore snapshot by email to recover avatar after hard refresh
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable() && currentUser && currentUser.email) {
                    window.FirestoreDataManager.findUserIdByEmail(currentUser.email).then(async (id) => {
                        if (!id) return;
                        try {
                            const doc = await window.FirebaseConfig.getFirestore().collection('users').doc(id).get();
                            const data = doc.exists ? (doc.data() || {}) : {};
                            const avatar = (data.profilePicture !== undefined && data.profilePicture !== null)
                                ? data.profilePicture
                                : (data.profile && data.profile.profilePicture) ? data.profile.profilePicture : null;
                            if (avatar) {
                                currentUser.profilePicture = avatar;
                                displayProfilePicture(avatar);
                            }
                        } catch(_) {}
                    }).catch(()=>{});
                }
            } catch(_) {}
        }
        
        // Remove profile picture
        function removeProfilePicture() {
            profilePictureData = null;
            displayProfilePicture(null);
            saveProfilePicture(null);
            showNotification('Profile picture removed', 'info');
        }
        
        // Contractor Directory Management
        function initializeContractorDirectory() {
            const searchInput = document.getElementById('directorySearch');
            const roleFilter = document.getElementById('roleFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterContractors);
            }
            
            if (roleFilter) {
                roleFilter.addEventListener('change', filterContractors);
            }
            
            displayContractorDirectory();
        }
        
        // Messaging Board Management
        let messages = [];
        
        function initializeMessagingBoard() {
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        communitySendMessage();
                    }
                });
            }
            
            // Set up real-time listener for messages
            if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                // Listen for Firestore data changes
                window.addEventListener('firestore:dataChange', function(event) {
                    if (event.detail.collection === 'messages') {
                        communityLoadMessages();
                    } else if (event.detail.collection === 'replies') {
                        // Merge new replies into messages in memory for rendering
                        const data = event.detail.data || {};
                        const msg = messages.find(m => String(m.id) === String(data.messageId));
                        if (msg) {
                            msg._replies = Array.isArray(msg._replies) ? msg._replies : [];
                            const exists = msg._replies.some(r => r.id === event.detail.docId);
                            if (!exists) {
                                msg._replies.push({ id: event.detail.docId, ...data });
                                communityDisplayMessages();
                            }
                        } else {
                            // If message not loaded yet, reload all
                            communityLoadMessages();
                        }
                    }
                });
            }
            
            communityLoadMessages();
        }
        
        // Load messages from localStorage (community board)
        async function communityLoadMessages() {
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                    messages = await window.FirestoreDataManager.getMessages();
                    // Load replies per message for inline display
                    try {
                        const enriched = await Promise.all(messages.map(async (m) => {
                            const replies = await window.FirestoreDataManager.getRepliesByMessageId(String(m.id));
                            return { ...m, _replies: replies };
                        }));
                        messages = enriched;
                    } catch(_) {}
                    if (messages.length === 0) {
                        // Add sample messages if none exist
                        await addSampleMessages();
                    }
                } else {
                    // Fallback to localStorage
                    const saved = localStorage.getItem('cochranMessages');
                    if (saved) {
                        messages = JSON.parse(saved);
                    } else {
                        messages = [];
                        await addSampleMessages();
                    }
                }
                communityDisplayMessages();
            } catch (error) {
                console.error('Error loading messages:', error);
                messages = [];
            }
        }

        // Add sample messages
        async function addSampleMessages() {
            const sampleMessages = [
                {
                    author: 'Cody Cochran',
                    authorEmail: 'codylcochran87@gmail.com',
                    authorAvatar: null,
                    text: 'Welcome to the team messaging board! This is where we can share updates, ask questions, and collaborate.',
                    likes: 3,
                    replies: []
                },
                {
                    author: 'Erica Jackson',
                    authorEmail: 'dedejackson727@gmail.com',
                    authorAvatar: null,
                    text: 'Great to be part of the team! Looking forward to working on some amazing projects together.',
                    likes: 1,
                    replies: []
                }
            ];

            for (const message of sampleMessages) {
                if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                    await window.FirestoreDataManager.addMessage(message);
                } else {
                    messages.push({ ...message, id: Date.now().toString(), timestamp: new Date().toISOString() });
                }
            }
            
            if (!window.FirestoreDataManager || !window.FirestoreDataManager.db) {
                saveMessages();
            }
        }
        
        // Live avatar cache + listeners (by email)
        const _liveAvatarCache = Object.create(null);
        const _liveAvatarUnsubs = Object.create(null);
        async function ensureLiveAvatarListener(email) {
            try {
                const e = String(email || '').toLowerCase();
                if (!e) return;
                if (_liveAvatarUnsubs[e]) return; // already listening
                if (!(window.FirestoreDataManager && window.FirestoreDataManager.isAvailable())) return;
                const id = await window.FirestoreDataManager.findUserIdByEmail(e);
                if (!id) return;
                const db = window.FirebaseConfig && window.FirebaseConfig.getFirestore ? window.FirebaseConfig.getFirestore() : null;
                if (!db) return;
                const ref = db.collection('users').doc(id);
                _liveAvatarUnsubs[e] = ref.onSnapshot((snap) => {
                    const data = (snap && snap.exists) ? (snap.data() || {}) : {};
                    const url = (data.profilePicture !== undefined && data.profilePicture !== null)
                        ? data.profilePicture
                        : (data.profile && data.profile.profilePicture) ? data.profile.profilePicture : null;
                    _liveAvatarCache[e] = url || null;
                    try {
                        document.querySelectorAll(`.avatar[data-email="${e}"] img`).forEach((img) => {
                            if (url) {
                                img.src = url;
                                img.style.display = 'block';
                                const ph = img.parentElement && img.parentElement.querySelector('.placeholder');
                                if (ph) ph.style.display = 'none';
                            }
                        });
                    } catch(_) {}
                });
            } catch(_) {}
        }

        // Display messages (with replies) - community board
        function communityDisplayMessages() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
                return;
            }
            
            const sortedMessages = messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const emailsToListen = new Set();
            
            container.innerHTML = sortedMessages.map(message => {
                const repliesHtml = Array.isArray(message._replies)
                    ? message._replies.map(r => {
                        const rEmail = String(r.authorEmail || '').toLowerCase();
                        if (rEmail) emailsToListen.add(rEmail);
                        const cached = _liveAvatarCache[rEmail] || r.authorAvatar || '';
                        return `
                        <div class="reply-item">
                            <div class="reply-avatar avatar" data-email="${rEmail}">${cached ? `<img src="${cached}" alt="${r.author}">` : `<div class=\"placeholder\"><i class=\"fas fa-user\"></i></div>`}</div>
                            <div class="reply-content">
                                <div class="reply-header">
                                    <div class="reply-author">${r.author}</div>
                                    <div class="reply-time">${formatMessageTime(r.timestamp)}</div>
                                </div>
                                <div class="reply-text">${r.text}</div>
                            </div>
                        </div>`;
                    }).join('') : '';
                const mEmail = String(message.authorEmail || '').toLowerCase();
                if (mEmail) emailsToListen.add(mEmail);
                const mCached = _liveAvatarCache[mEmail] || message.authorAvatar || '';
                return `
                <div class="message-item" data-message-id="${message.id}">
                    <div class="message-avatar avatar" data-email="${mEmail}">
                        ${mCached ? 
                            `<img src="${mCached}" alt="${message.author}">` : 
                            `<div class="placeholder"><i class="fas fa-user"></i></div>`
                        }
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <div class="message-author">${message.author}</div>
                            <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                        </div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-actions">
                            <button class="message-like-btn" onclick="toggleMessageLike('${String(message.id).replace(/'/g, "&#39;")}')">
                                <i class="fas fa-heart"></i>
                                <span>${message.likes}</span>
                            </button>
                            <button class="message-reply-btn" onclick="openReplyComposer('${String(message.id).replace(/'/g, "&#39;")}', '${(message.authorEmail||'').toLowerCase()}', '${(message.author||'').replace(/'/g, "&#39;")}')">
                                <i class="fas fa-reply"></i>
                                <span>Reply</span>
                            </button>
                        </div>
                        <div class="replies-container">${repliesHtml}</div>
                    </div>
                </div>`;
            }).join('');
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
            // After initial render, ensure listeners are attached for all emails seen
            try { emailsToListen.forEach((e) => { ensureLiveAvatarListener(e); }); } catch(_) {}
        }
        
        // Format message time
        function formatMessageTime(timestamp) {
            const now = new Date();
            const messageTime = new Date(timestamp);
            const diffInMinutes = Math.floor((now - messageTime) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return messageTime.toLocaleDateString();
        }
        
        // Send message (community board)
        async function communitySendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const message = {
                author: (currentUser && (currentUser.name || (currentUser.email && currentUser.email.split('@')[0]))) || 'Unknown',
                authorEmail: (currentUser && currentUser.email) || '',
                authorAvatar: (currentUser && currentUser.profilePicture) || null,
                text: text,
                likes: 0,
                replies: []
            };
            
            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                    await window.FirestoreDataManager.addMessage(message);
                    // The real-time listener will update the UI automatically
                } else {
                    // Fallback to localStorage
                    message.id = Date.now();
                    message.timestamp = new Date().toISOString();
                    messages.unshift(message);
                    communitySaveMessages();
                    communityDisplayMessages();
                }
                
                input.value = '';
                showNotification('Message sent!', 'success');
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message. Please try again.', 'error');
            }
        }
        
        // Toggle message like
        async function toggleMessageLike(messageId) {
            const targetId = String(messageId);
            const message = messages.find(m => String(m.id) === targetId);
            if (!message) return;

            const likerEmail = (currentUser && currentUser.email) ? currentUser.email.toLowerCase() : '';
            const likedBy = Array.isArray(message.likedBy) ? message.likedBy.map(e => String(e).toLowerCase()) : [];
            if (likerEmail && likedBy.includes(likerEmail)) {
                showNotification('You already liked this message.', 'info');
                return;
            }

            const newLikes = (Number(message.likes) || 0) + 1;
            const newLikedBy = likerEmail ? Array.from(new Set([...likedBy, likerEmail])) : likedBy;

            // Optimistic UI
            message.likes = newLikes;
            message.likedBy = newLikedBy;
            communityDisplayMessages();

            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                    await window.FirestoreDataManager.updateMessage(targetId, { likes: newLikes, likedBy: newLikedBy });
                    const toEmail = (message.authorEmail || '').toLowerCase();
                    if (toEmail && likerEmail && toEmail !== likerEmail) {
                        try {
                            await window.FirestoreDataManager.sendUserNotification({
                                toEmail,
                                title: 'New like on your message',
                                message: `${(currentUser && (currentUser.name || likerEmail.split('@')[0])) || 'Someone'} liked your message: "${String(message.text || '').slice(0, 80)}${String(message.text || '').length > 80 ? 'â€¦' : ''}"`,
                                type: 'info',
                                data: { messageId: targetId }
                            });
                        } catch (_) {}
                    }
                } else {
                    // Fallback persistence
                    communitySaveMessages();
                }
            } catch (err) {
                console.error('Failed to persist message like:', err);
                // Revert optimistic update on error (optional)
                // message.likes = newLikes - 1; displayMessages();
            }
        }
        
        // Open reply composer modal
        function openReplyComposer(messageId, toEmail, toAuthor) {
            const modal = document.createElement('div');
            modal.className = 'new-message-modal';
            modal.innerHTML = `
                <div class="new-message-content">
                    <div class="new-message-header">
                        <h3>Reply to ${toAuthor || 'message'}</h3>
                        <button class="close-modal" onclick="closeNewMessageModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <form class="new-message-form" onsubmit="handleReplySubmit(event, '${messageId}', '${(toEmail||'').toLowerCase()}', '${(toAuthor||'').replace(/'/g, "&#39;")}')">
                        <textarea id="newReplyText" placeholder="Write your reply..." required></textarea>
                        <div class="new-message-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeNewMessageModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Send Reply</button>
                        </div>
                    </form>
                </div>`;
            document.body.appendChild(modal);
            document.getElementById('newReplyText').focus();
        }

        async function handleReplySubmit(event, messageId, toEmail, toAuthor) {
            event.preventDefault();
            const textarea = document.getElementById('newReplyText');
            const text = (textarea && textarea.value ? textarea.value.trim() : '');
            if (!text) return;

            const reply = {
                messageId: String(messageId),
                author: (currentUser && (currentUser.name || (currentUser.email && currentUser.email.split('@')[0]))) || 'Unknown',
                authorEmail: (currentUser && currentUser.email) || '',
                authorAvatar: (currentUser && currentUser.profilePicture) || null,
                text: text,
                toEmail: toEmail || '',
                toAuthor: toAuthor || ''
            };

            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                    await window.FirestoreDataManager.addReply(reply);
                    if (toEmail) {
                        try {
                            await window.FirestoreDataManager.sendUserNotification({
                                toEmail,
                                title: 'New Reply to Your Message',
                                message: `${reply.author} replied: ${text.substring(0, 120)}${text.length > 120 ? 'â€¦' : ''}`,
                                type: 'info',
                                data: { messageId }
                            });
                        } catch(_) {}
                    }
                } else {
                    // Local fallback: attach to in-memory message
                    const msg = messages.find(m => String(m.id) === String(messageId));
                    if (msg) {
                        msg._replies = Array.isArray(msg._replies) ? msg._replies : [];
                        msg._replies.push({ ...reply, id: Date.now(), timestamp: new Date().toISOString() });
                        communitySaveMessages();
                        communityDisplayMessages();
                    }
                }
                closeNewMessageModal();
                showNotification('Reply sent!', 'success');
            } catch (e) {
                console.error('Error sending reply:', e);
                showNotification('Error sending reply. Please try again.', 'error');
            }
        }
        
        // Show new message modal
        function showNewMessageModal() {
            const modal = document.createElement('div');
            modal.className = 'new-message-modal';
            modal.innerHTML = `
                <div class="new-message-content">
                    <div class="new-message-header">
                        <h3>New Message</h3>
                        <button class="close-modal" onclick="closeNewMessageModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form class="new-message-form" onsubmit="handleNewMessage(event)">
                        <textarea id="newMessageText" placeholder="What's on your mind?" required></textarea>
                        <div class="new-message-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeNewMessageModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Send Message</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('newMessageText').focus();
        }
        
        // Close new message modal
        function closeNewMessageModal() {
            const modal = document.querySelector('.new-message-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Handle new message form submission
        function handleNewMessage(event) {
            event.preventDefault();
            
            const text = document.getElementById('newMessageText').value.trim();
            if (!text) return;
            
            const message = {
                id: Date.now(),
                author: currentUser.name || currentUser.email.split('@')[0],
                authorEmail: currentUser.email,
                authorAvatar: currentUser.profilePicture || null,
                text: text,
                timestamp: new Date().toISOString(),
                likes: 0,
                replies: []
            };
            
            messages.unshift(message);
            communitySaveMessages();
            communityDisplayMessages();
            
            closeNewMessageModal();
            showNotification('Message posted!', 'success');
        }
        
        // Save messages to localStorage (community board)
        function communitySaveMessages() {
            try {
                localStorage.setItem('cochranMessages', JSON.stringify(messages));
            } catch (error) {
                console.error('Error saving messages:', error);
            }
        }
        
        // Success Stories Management (Firestore-backed)
        let successStories = [];

        function initializeSuccessStories() {
            const filterSelect = document.getElementById('successFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', filterSuccessStories);
            }

            // Prefer Firestore live data; fall back to any locally cached data if Firestore unavailable
            loadSuccessStoriesFromFirestore();
            // Also listen for live updates dispatched by FirestoreDataManager
            try {
                window.addEventListener('firestore:dataChange', (evt) => {
                    const d = evt && evt.detail;
                    if (!d || d.collection !== 'successStories') return;
                    // Reload from Firestore to keep ordering consistent
                    loadSuccessStoriesFromFirestore();
                });
            } catch (_) {}
        }
        async function loadSuccessStoriesFromFirestore() {
            try {
                // Ensure Firestore is ready
                if (window.FirestoreDataManager && !window.FirestoreDataManager.isAvailable()) {
                    try { await window.FirestoreDataManager.init(); } catch(_) {}
                }

                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const stories = await window.FirestoreDataManager.getSuccessStories();
                    // Normalize expected fields and compute derived stats where needed
                    successStories = (stories || []).map((s) => ({
                        id: s.id || Date.now(),
                        author: s.author || s.authorName || 'Team Member',
                        authorEmail: s.authorEmail || '',
                        authorAvatar: s.authorAvatar || s.avatar || null,
                        role: s.role || s.authorRole || 'Team Member',
                        achievement: s.achievement || s.badge || '',
                        title: s.title || '',
                        description: s.description || '',
                        stats: s.stats || {
                            projectsCompleted: s.projectsCompleted || 0,
                            clientRating: s.clientRating || 0,
                            earnings: s.earnings || '$0'
                        },
                        timestamp: s.timestamp || s.createdAt || new Date().toISOString(),
                        congratulations: typeof s.congratulations === 'number' ? s.congratulations : (s.kudos || 0)
                    }));
                    // Cache for offline fallback
                    try { localStorage.setItem('cochranSuccessStories', JSON.stringify(successStories)); } catch(_) {}
                } else {
                    // Fallback to local cache
                    successStories = JSON.parse(localStorage.getItem('cochranSuccessStories') || '[]');
                }
            } catch (error) {
                console.error('Error loading success stories from Firestore:', error);
                // Keep UI usable with any cached data
                try { successStories = JSON.parse(localStorage.getItem('cochranSuccessStories') || '[]'); } catch(_) { successStories = []; }
            }
            displaySuccessStories();
        }

        // Display success stories
        function displaySuccessStories() {
            const grid = document.getElementById('successStoriesGrid');
            if (!grid) return;
            
            if (successStories.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>No success stories yet. Keep up the great work!</p></div>';
                return;
            }
            
            const sortedStories = successStories.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            grid.innerHTML = sortedStories.map(story => `
                <div class="success-story-card" data-achievement="${story.achievement}">
                    <div class="success-story-header">
                        <div class="success-story-avatar">
                            ${story.authorAvatar ? 
                                `<img src="${story.authorAvatar}" alt="${story.author}">` : 
                                `<div class="placeholder"><i class="fas fa-user"></i></div>`
                            }
                        </div>
                        <div class="success-story-info">
                            <h4>${story.author}</h4>
                            <div class="success-story-role">${story.role}</div>
                        </div>
                    </div>
                    <div class="success-story-achievement">${story.achievement}</div>
                    <h3 class="success-story-title">${story.title}</h3>
                    <p class="success-story-description">${story.description}</p>
                    <div class="success-story-stats">
                        <div class="success-stat">
                            <span class="success-stat-number">${story.stats.projectsCompleted}</span>
                            <span class="success-stat-label">Projects</span>
                        </div>
                        <div class="success-stat">
                            <span class="success-stat-number">${story.stats.clientRating}</span>
                            <span class="success-stat-label">Rating</span>
                        </div>
                        <div class="success-stat">
                            <span class="success-stat-number">${story.stats.earnings}</span>
                            <span class="success-stat-label">Earnings</span>
                        </div>
                    </div>
                    <div class="success-story-actions">
                        <button class="success-congratulate-btn" onclick="congratulateSuccess(${story.id})">
                            <i class="fas fa-hands-clapping"></i>
                            <span>${story.congratulations} Congratulations</span>
                        </button>
                        <button class="success-share-btn" onclick="shareSuccess(${story.id})">
                            <i class="fas fa-share"></i>
                            <span>Share</span>
                        </button>
                    </div>
                    <div class="success-story-date">${new Date(story.timestamp).toLocaleDateString()}</div>
                </div>
            `).join('');
        }
        
        // Filter success stories
        function filterSuccessStories() {
            const filter = document.getElementById('successFilter').value;
            const cards = document.querySelectorAll('.success-story-card');
            
            cards.forEach(card => {
                const achievement = card.dataset.achievement;
                card.style.display = (!filter || achievement === filter) ? 'block' : 'none';
            });
        }
        
        // Congratulate success story
        function congratulateSuccess(storyId) {
            const story = successStories.find(s => s.id === storyId);
            if (story) {
                story.congratulations += 1;
                saveSuccessStories();
                displaySuccessStories();
                showNotification('Congratulations sent!', 'success');
            }
        }
        
        // Share success story (placeholder)
        function shareSuccess(storyId) {
            showNotification('Share feature coming soon!', 'info');
        }
        
        // Save success stories to localStorage (used only as offline cache)
        function saveSuccessStories() {
            try {
                localStorage.setItem('cochranSuccessStories', JSON.stringify(successStories));
            } catch (error) {
                console.error('Error saving success stories:', error);
            }
        }
        
        // Display contractor directory
        async function displayContractorDirectory() {
            const grid = document.getElementById('contractorGrid');
            if (!grid) return;
            
            try {
                const fsUsersObj = await window.FirestoreDataManager.getUsers();
                const contractors = Object.entries(fsUsersObj || {}).map(([name, userData]) => ({
                    name: name,
                    email: userData.profile?.email || '',
                    role: userData.profile?.role || 'Team Member',
                    location: userData.profile?.location || 'Not specified',
                    profilePicture: userData.profilePicture || null,
                    rate: userData.profile?.rate || 'N/A'
                }));
                
                grid.innerHTML = contractors.map(contractor => `
                    <div class="contractor-card" data-name="${contractor.name}" data-role="${contractor.role}">
                        <div class="contractor-header">
                            <div class="contractor-avatar">
                                ${contractor.profilePicture ? 
                                    `<img src="${contractor.profilePicture}" alt="${contractor.name}">` : 
                                    `<div class="placeholder"><i class="fas fa-user"></i></div>`
                                }
                            </div>
                            <div class="contractor-info">
                                <h4>${contractor.name}</h4>
                                <div class="contractor-role">${contractor.role}</div>
                            </div>
                        </div>
                        <div class="contractor-details">
                            <div class="contractor-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${contractor.location}</span>
                            </div>
                            <div style="margin-top: 0.5rem; color: var(--primary); font-weight: 500;">
                                Rate: ${contractor.rate}
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading contractor directory:', error);
                grid.innerHTML = '<div class="empty-state"><p>Failed to load team directory</p></div>';
            }
        }
        
        // Filter contractors
        function filterContractors() {
            const searchTerm = document.getElementById('directorySearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const cards = document.querySelectorAll('.contractor-card');
            
            cards.forEach(card => {
                const name = card.dataset.name.toLowerCase();
                const role = card.dataset.role;
                
                const matchesSearch = name.includes(searchTerm);
                const matchesRole = !roleFilter || role === roleFilter;
                
                card.style.display = (matchesSearch && matchesRole) ? 'block' : 'none';
            });
        }
        
        // Project Showcases Management
        let showcases = [];
        
        function initializeShowcases() {
            const form = document.getElementById('showcaseForm');
            const imageInput = document.getElementById('showcaseImages');
            const filterSelect = document.getElementById('showcaseFilter');
            
            if (form) {
                form.addEventListener('submit', handleShowcaseSubmit);
            }
            
            if (imageInput) {
                imageInput.addEventListener('change', handleImagePreview);
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', filterShowcases);
            }
            
            loadShowcases();
        }
        
        // Handle showcase form submission
        async function handleShowcaseSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const title = formData.get('title');
            const description = formData.get('description');
            const category = formData.get('category');
            const files = Array.from(document.getElementById('showcaseImages').files);
            
            if (!title.trim()) {
                showNotification('Please enter a project title', 'error');
                return;
            }
            
            if (files.length === 0) {
                showNotification('Please upload at least one image', 'error');
                return;
            }
            
            try {
                const ownerEmail = currentUser && currentUser.email ? currentUser.email : '';
                const results = await window.StorageUtils.uploadFiles(files, {
                    ownerEmail,
                    folder: 'community-showcases',
                    bucketURL: (window && window.FIREBASE_BUCKET_URL) || undefined,
                    onProgress: ({ index, percent }) => {
                        try { document.getElementById('showcaseUploadStatus').textContent = `Uploading ${index + 1}/${files.length} â€“ ${percent}%`; } catch(_) {}
                    }
                });
                const imageURLs = results.map(r => r.downloadURL).filter(Boolean);
                const showcase = {
                    id: Date.now(),
                    title: title.trim(),
                    description: description.trim(),
                    category: category,
                    images: imageURLs,
                    author: currentUser.name || currentUser.email.split('@')[0],
                    authorEmail: currentUser.email,
                    authorAvatar: currentUser.profilePicture || null,
                    createdAt: new Date().toISOString(),
                    likes: 0,
                    comments: []
                };
                showcases.unshift(showcase);
                saveShowcases();
                displayShowcases();
                if (document.getElementById('showcaseUploadStatus')) document.getElementById('showcaseUploadStatus').textContent = '';
                
                // Reset form
                event.target.reset();
                const previewContainer = document.getElementById('imagePreviewContainer');
                if (previewContainer) previewContainer.innerHTML = '';
                showNotification('Showcase shared successfully!', 'success');
            } catch (err) {
                console.error('Showcase upload failed', err);
                showNotification('Failed to upload showcase images', 'error');
            }
        }
        
        // Handle image preview
        function handleImagePreview(event) {
            const files = Array.from(event.target.files);
            const container = document.getElementById('imagePreviewContainer');
            
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'image-preview';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removeImagePreview(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Remove image preview
        function removeImagePreview(index) {
            const input = document.getElementById('showcaseImages');
            const dt = new DataTransfer();
            const files = Array.from(input.files);
            
            files.splice(index, 1);
            files.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            handleImagePreview({ target: input });
        }
        
        // Display showcases
        function displayShowcases() {
            const grid = document.getElementById('showcasesGrid');
            if (!grid) return;
            
            if (showcases.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>No showcases yet. Be the first to share your work!</p></div>';
                return;
            }
            
            grid.innerHTML = showcases.map(showcase => `
                <div class="showcase-card" data-category="${showcase.category}">
                    <div class="showcase-images">
                        ${showcase.images.slice(0, 4).map(img => `
                            <div class="showcase-image">
                                <img src="${img}" alt="${showcase.title}">
                            </div>
                        `).join('')}
                    </div>
                    <div class="showcase-content">
                        <div class="showcase-header">
                            <div>
                                <h3 class="showcase-title">${showcase.title}</h3>
                                <span class="showcase-category">${showcase.category}</span>
                            </div>
                        </div>
                        <p class="showcase-description">${showcase.description}</p>
                        <div class="showcase-author">
                            <div class="showcase-author-avatar">
                                ${showcase.authorAvatar ? 
                                    `<img src="${showcase.authorAvatar}" alt="${showcase.author}">` : 
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                            <div class="showcase-author-info">
                                <h5>${showcase.author}</h5>
                                <p>${new Date(showcase.createdAt).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="showcase-actions">
                            <button class="showcase-like-btn" onclick="toggleLike('${String(showcase.id).replace(/'/g, "&#39;")}')">
                                <i class="fas fa-heart"></i>
                                <span>${showcase.likes}</span>
                            </button>
                            <button class="showcase-comment-btn" onclick="showComments('${String(showcase.id).replace(/'/g, "&#39;")}')">
                                <i class="fas fa-comment"></i>
                                <span>${showcase.comments.length}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Filter showcases
        function filterShowcases() {
            const filter = document.getElementById('showcaseFilter').value;
            const cards = document.querySelectorAll('.showcase-card');
            
            cards.forEach(card => {
                const category = card.dataset.category;
                card.style.display = (!filter || category === filter) ? 'block' : 'none';
            });
        }
        
        // Toggle like
        async function toggleLike(showcaseId) {
            const targetId = String(showcaseId);
            const showcase = showcases.find(s => String(s.id) === targetId);
            if (!showcase) return;

            const likerEmail = (currentUser && currentUser.email) ? currentUser.email.toLowerCase() : '';
            const likedBy = Array.isArray(showcase.likedBy) ? showcase.likedBy.map(e => String(e).toLowerCase()) : [];
            if (likerEmail && likedBy.includes(likerEmail)) {
                showNotification('You already liked this project.', 'info');
                return;
            }

            const newLikes = (Number(showcase.likes) || 0) + 1;
            const newLikedBy = likerEmail ? Array.from(new Set([...likedBy, likerEmail])) : likedBy;

            // Optimistic UI
            showcase.likes = newLikes;
            showcase.likedBy = newLikedBy;
            displayShowcases();

            try {
                if (window.FirestoreDataManager && window.FirestoreDataManager.db) {
                    await window.FirestoreDataManager.updateShowcase(targetId, { likes: newLikes, likedBy: newLikedBy });
                    const toEmail = (showcase.authorEmail || '').toLowerCase();
                    if (toEmail && likerEmail && toEmail !== likerEmail) {
                        try {
                            await window.FirestoreDataManager.sendUserNotification({
                                toEmail,
                                title: 'New like on your showcase',
                                message: `${(currentUser && (currentUser.name || likerEmail.split('@')[0])) || 'Someone'} liked your project: "${String(showcase.title || '').slice(0, 80)}${String(showcase.title || '').length > 80 ? 'â€¦' : ''}"`,
                                type: 'info',
                                data: { showcaseId: targetId }
                            });
                        } catch (_) {}
                    }
                } else {
                    // Fallback persistence
                    saveShowcases();
                }
            } catch (err) {
                console.error('Failed to persist showcase like:', err);
            }
        }
        
        // Show comments (placeholder)
        function showComments(showcaseId) {
            showNotification('Comments feature coming soon!', 'info');
        }
        
        // Save showcases to localStorage (in a real app, this would be saved to a database)
        function saveShowcases() {
            try {
                localStorage.setItem('cochranShowcases', JSON.stringify(showcases));
            } catch (error) {
                console.error('Error saving showcases:', error);
            }
        }
        
        // Load showcases from localStorage
        function loadShowcases() {
            try {
                const saved = localStorage.getItem('cochranShowcases');
                if (saved) {
                    showcases = JSON.parse(saved);
                }
                displayShowcases();
            } catch (error) {
                console.error('Error loading showcases:', error);
                showcases = [];
            }
        }
        
        // Events Calendar Management
        let currentDate = new Date();
        let events = [];
        
        async function initializeCalendar() {
            await loadEvents();
            renderCalendar();
            displayEventsList();
        }
        
        // Render calendar
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            if (!container) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month/year display
            const monthYear = document.getElementById('currentMonthYear');
            if (monthYear) {
                monthYear.textContent = currentDate.toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const days = [];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Add day headers
            days.push(`<div class="calendar-header">${dayNames.join('</div><div class="calendar-header">')}</div>`);
            
            // Add calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === new Date().toDateString();
                const dayEvents = events.filter(event => 
                    new Date(event.date).toDateString() === date.toDateString()
                );
                
                const dayClass = [
                    'calendar-day',
                    isCurrentMonth ? '' : 'other-month',
                    isToday ? 'today' : '',
                    dayEvents.length > 0 ? 'has-event' : ''
                ].filter(Boolean).join(' ');
                
                const dayEventsHTML = dayEvents.map(event => 
                    `<div class="calendar-event" onclick="openEventDetails('${event.id}')" title="${event.title}">
                        <div class="event-card-header">
                            <div class="event-title">${event.title}</div>
                            <div class="event-status ${(event.status || event.type || 'Event').toLowerCase().replace(/\s+/g, '-')}">${event.status || event.type || 'Event'}</div>
                        </div>
                        ${event.location ? `<div class="event-location"><i class="fas fa-map-marker-alt"></i> ${event.location}</div>` : ''}
                    </div>`
                ).join('');
                
                days.push(`
                    <div class="${dayClass}">
                        <div class="calendar-day-number">${date.getDate()}</div>
                        ${dayEventsHTML}
                    </div>
                `);
            }
            
            container.innerHTML = `<div class="calendar-grid">${days.join('')}</div>`;
        }
        
        // Display events list
        function displayEventsList() {
            const container = document.getElementById('eventsList');
            if (!container) return;
            
            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No events scheduled</p></div>';
                return;
            }
            
            const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedEvents.map(event => `
                <div class="event-item" onclick="openEventDetails('${event.id}')" style="cursor: pointer;">
                    <div class="event-header">
                        <div>
                            <h4 class="event-title">${event.title}</h4>
                            <div class="event-date">${new Date(event.date).toLocaleDateString()}</div>
                        </div>
                        <span class="event-type">${event.status || event.type || 'Event'}</span>
                    </div>
                    <p class="event-description">${event.description}</p>
                    ${event.location ? `
                        <div class="event-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${event.location}</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Load events from Firestore
        async function loadEvents() {
            try {
                await ensureFirestoreReady();
                
                if (window.FirestoreDataManager && window.FirestoreDataManager.isAvailable()) {
                    const firestoreEvents = await window.FirestoreDataManager.getEvents();
                    events = firestoreEvents.map(event => ({
                        id: event.id,
                        title: event.title,
                        description: event.description || '',
                        date: event.date,
                        status: event.status || 'scheduled',
                        type: event.status || 'Event',
                        location: event.location || ''
                    }));
                    console.log('âœ… Loaded events from Firestore:', events.length);
                } else {
                    console.warn('âš ï¸ FirestoreDataManager not available, using empty events list');
                    events = [];
                }
            } catch (error) {
                console.error('Error loading events from Firestore:', error);
                events = [];
            }
        }
        
        // Events are now managed through Firestore - no local saving needed
        
        // Calendar navigation
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        // Event Details Modal Functions
        function openEventDetails(id) {
            const modal = document.getElementById('eventDetailsModal');
            if (!modal) return;
            
            // Find the event by id from the in-memory events array
            const event = (events || []).find(e => String(e.id) === String(id));
            if (!event) {
                console.warn('Event not found for id:', id);
                return;
            }
            
            // Safely extract fields
            const title = event.title || 'No title provided';
            const date = event.date || '';
            const status = event.status || event.type || 'Event';
            const location = event.location || 'No location provided';
            const description = event.description || 'No description provided';
            
            // Populate modal with event data
            document.getElementById('eventDetailsTitle').textContent = title;
            document.getElementById('eventDetailsDate').textContent = formatEventDate(date) || 'No date provided';
            document.getElementById('eventDetailsLocation').textContent = location;
            document.getElementById('eventDetailsDescription').textContent = description;
            
            // Set status badge
            const statusElement = document.getElementById('eventDetailsStatus');
            statusElement.textContent = status;
            statusElement.className = `status-badge ${status.toLowerCase().replace(/\s+/g, '-')}`;
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Add escape key listener
            document.addEventListener('keydown', handleEscapeKey);
            
            console.log('ðŸ“… Event details opened:', { id, title, date, status, location });
        }
        
        function closeEventDetails() {
            const modal = document.getElementById('eventDetailsModal');
            if (!modal) return;
            
            modal.style.display = 'none';
            document.body.style.overflow = '';
            
            // Remove escape key listener
            document.removeEventListener('keydown', handleEscapeKey);
            
            console.log('ðŸ“… Event details closed');
        }
        
        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                closeEventDetails();
            }
        }
        
        function formatEventDate(dateString) {
            if (!dateString) return 'No date provided';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString; // Return original if invalid
                
                return date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                console.warn('Error formatting date:', error);
                return dateString;
            }
        }
        
        // Initialize all community features when section is shown
        async function initializeCommunityFeatures() {
            if (document.getElementById('community-section').classList.contains('active')) {
                initializeProfilePicture();
                initializeContractorDirectory();
                initializeMessagingBoard();
                initializeSuccessStories();
            }
            if (document.getElementById('showcases-section').classList.contains('active')) {
                initializeShowcases();
            }
            if (document.getElementById('calendar-section').classList.contains('active')) {
                await initializeCalendar();
            }
            // Ensure messaging service exists for chat subsystem when user opens messaging section later
            try { if (!messagingService) { messagingService = new MessagingService(); } } catch(_) {}
        }
        
        // Override the existing switchPortalTab function to initialize community features
        const originalSwitchPortalTab = switchPortalTab;
        switchPortalTab = function(tabName) {
            originalSwitchPortalTab(tabName);
            
            // Initialize community features when switching to those sections
            setTimeout(async () => {
                await initializeCommunityFeatures();
                // Initialize equipment center when needed
                if (document.getElementById('equipment-section') && document.getElementById('equipment-section').classList.contains('active')) {
                    try { initializeEquipmentCenter(); } catch(e) { console.warn('equipment init skipped', e); }
                }
            }, 100);
        };

    </script>
    <style>
        /* Equipment Center lightweight styles reuse existing classes */
        #equipmentList .card,
        #resourceList .card,
        #equipmentRequestList .card,
        #maintenanceList .card {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,178,0,0.25);
            border-radius: 12px;
            padding: 1rem;
        }
        .equipment-meta {
            display: flex; gap: 8px; flex-wrap: wrap; color: #9ca3af; font-size: 0.9rem;
        }
        .chip { border: 1px solid rgba(255,178,0,0.35); border-radius: 999px; padding: 2px 10px; color: #FFB200; }
        .status-available { color: #22c55e; }
        .status-checked_out { color: #f59e0b; }
        .status-maintenance { color: #ef4444; }
        .status-retired { color: #6b7280; }
        /* ==================== ELEGANT DESIGN SYSTEM ==================== */
        :root {
            /* Premium Color Palette */
            --primary: #FFB200;
            --primary-light: #FFD700;
            --primary-dark: #E6A000;
            --secondary: #1a1a2e;
            --accent: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            /* Sophisticated Gradients */
            --gradient-primary: linear-gradient(135deg, #FFB200 0%, #FFD700 100%);
            --gradient-dark: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            --gradient-success: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --gradient-premium: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'Cinzel', Georgia, serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            
            /* Spacing System */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            --space-2xl: 4rem;
            
            /* Shadows & Depth */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 8px 32px rgba(0,0,0,0.15);
            --shadow-lg: 0 16px 64px rgba(0,0,0,0.2);
            --shadow-xl: 0 24px 96px rgba(0,0,0,0.3);
            --shadow-glow: 0 0 32px rgba(255,178,0,0.3);
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(26, 26, 46, 0.8);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-primary);
            opacity: 0.8;
        }
        
        body {
            font-family: var(--font-primary);
            background: var(--gradient-dark);
            color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ==================== QUANTUM NEURAL LOGIN SCREEN 2025 ==================== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow: hidden;
            min-height: 100vh;
        }
        
        /* Ensure JavaScript can control display */
        #loginScreen.login-screen[style*="display: none"] {
            display: none !important;
        }

        /* Neural Network Background */
        .neural-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .neural-node {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
            border-radius: 50%;
            animation: neural-pulse 4s ease-in-out infinite;
            box-shadow: 0 0 20px currentColor;
        }

        .neural-node:nth-child(1) { top: 15%; left: 10%; animation-delay: 0s; }
        .neural-node:nth-child(2) { top: 25%; left: 85%; animation-delay: 0.5s; }
        .neural-node:nth-child(3) { top: 45%; left: 20%; animation-delay: 1s; }
        .neural-node:nth-child(4) { top: 65%; left: 80%; animation-delay: 1.5s; }
        .neural-node:nth-child(5) { top: 85%; left: 15%; animation-delay: 2s; }
        .neural-node:nth-child(6) { top: 35%; left: 90%; animation-delay: 2.5s; }
        .neural-node:nth-child(7) { top: 75%; left: 25%; animation-delay: 3s; }
        .neural-node:nth-child(8) { top: 55%; left: 75%; animation-delay: 3.5s; }
        .neural-node:nth-child(9) { top: 95%; left: 60%; animation-delay: 4s; }
        .neural-node:nth-child(10) { top: 5%; left: 50%; animation-delay: 4.5s; }

        @keyframes neural-pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.6;
                filter: hue-rotate(0deg);
            }
            50% { 
                transform: scale(1.5);
                opacity: 1;
                filter: hue-rotate(180deg);
            }
        }

        /* Holographic Particles */
        .holographic-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #00ffff;
            border-radius: 50%;
            animation: particle-float 8s linear infinite;
            box-shadow: 0 0 10px #00ffff;
        }

        .particle:nth-child(1) { top: 10%; left: 5%; animation-delay: 0s; }
        .particle:nth-child(2) { top: 20%; left: 90%; animation-delay: 1s; }
        .particle:nth-child(3) { top: 40%; left: 15%; animation-delay: 2s; }
        .particle:nth-child(4) { top: 60%; left: 85%; animation-delay: 3s; }
        .particle:nth-child(5) { top: 80%; left: 10%; animation-delay: 4s; }
        .particle:nth-child(6) { top: 30%; left: 95%; animation-delay: 5s; }
        .particle:nth-child(7) { top: 70%; left: 20%; animation-delay: 6s; }
        .particle:nth-child(8) { top: 90%; left: 70%; animation-delay: 7s; }

        @keyframes particle-float {
            0% { 
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* Quantum Portal */
        .quantum-portal {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }

        .portal-rings {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .ring {
            position: absolute;
            border: 2px solid transparent;
            border-radius: 50%;
            animation: portal-rotate 20s linear infinite;
        }

        .ring-1 {
            width: 400px;
            height: 400px;
            top: -100px;
            left: -100px;
            border-color: rgba(0, 255, 255, 0.3);
            animation-duration: 20s;
        }

        .ring-2 {
            width: 500px;
            height: 500px;
            top: -150px;
            left: -150px;
            border-color: rgba(255, 0, 255, 0.2);
            animation-duration: 30s;
            animation-direction: reverse;
        }

        .ring-3 {
            width: 600px;
            height: 600px;
            top: -200px;
            left: -200px;
            border-color: rgba(255, 255, 0, 0.1);
            animation-duration: 40s;
        }

        @keyframes portal-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Login Container */
        .login-container {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(50px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 30px;
            padding: 60px 50px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 0 100px rgba(0, 255, 255, 0.2),
                0 0 200px rgba(255, 0, 255, 0.1),
                inset 0 0 100px rgba(0, 0, 0, 0.5);
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0, 255, 255, 0.1), transparent, rgba(255, 0, 255, 0.1), transparent);
            animation: container-rotate 10s linear infinite;
            pointer-events: none;
        }

        @keyframes container-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Holographic Logo */
        .holographic-logo {
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .logo-hologram {
            position: relative;
            display: inline-block;
        }

        .real-logo {
            width: 120px;
            height: auto;
            max-height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.8));
            animation: logo-glow 3s ease-in-out infinite;
        }

        .logo-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: glow-pulse 2s ease-in-out infinite;
        }

        .logo-scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: scan-line 2s ease-in-out infinite;
        }

        @keyframes logo-glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.8)); }
            50% { filter: drop-shadow(0 0 40px rgba(0, 255, 255, 1)); }
        }

        @keyframes glow-pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        @keyframes scan-line {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        .logo-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .logo-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #00ffff;
            border-radius: 50%;
            animation: logo-particle-float 4s ease-in-out infinite;
        }

        .logo-particle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .logo-particle:nth-child(2) { top: 80%; left: 80%; animation-delay: 1s; }
        .logo-particle:nth-child(3) { top: 50%; left: 50%; animation-delay: 2s; }

        @keyframes logo-particle-float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.5; }
            50% { transform: translateY(-10px) translateX(10px); opacity: 1; }
        }

        /* Portal Identity */
        .portal-identity {
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .identity-icon {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .icon-core {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: #00ffff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: core-pulse 2s ease-in-out infinite;
            box-shadow: 0 0 20px #00ffff;
        }

        .icon-rings {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .icon-ring {
            position: absolute;
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            animation: icon-ring-rotate 4s linear infinite;
        }

        .icon-ring:nth-child(1) {
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            animation-duration: 4s;
        }

        .icon-ring:nth-child(2) {
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            animation-duration: 6s;
            animation-direction: reverse;
        }

        .icon-ring:nth-child(3) {
            top: 30%;
            left: 30%;
            width: 40%;
            height: 40%;
            animation-duration: 8s;
        }
        @keyframes core-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
        }

        @keyframes icon-ring-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-title {
            position: relative;
            font-family: 'Cinzel', serif;
            font-size: 2.8rem;
            font-weight: 700;
            color: #00ffff;
            margin-bottom: 15px;
            letter-spacing: 0.15em;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        .title-text {
            position: relative;
            z-index: 1;
        }

        .title-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 255, 0.3), transparent);
            animation: title-glow-sweep 3s ease-in-out infinite;
        }

        .title-scan {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: title-scan 4s ease-in-out infinite;
        }

        @keyframes title-glow-sweep {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        @keyframes title-scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        .login-subtitle {
            position: relative;
            color: #E8E8E8;
            font-size: 1.2rem;
            margin-bottom: 40px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 20px;
            border-radius: 15px;
            display: inline-block;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .subtitle-text {
            position: relative;
            z-index: 1;
        }

        .subtitle-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 15px;
            animation: subtitle-pulse 2s ease-in-out infinite;
        }

        @keyframes subtitle-pulse {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.05); }
        }
        
        .login-form-container {
            position: relative;
            z-index: 1;
            width: 100%;
        }
        
        /* Quantum Form Container */
        .quantum-form-container {
            position: relative;
            z-index: 1;
            width: 100%;
        }

        .form-group {
            margin-bottom: 32px;
            width: 100%;
        }

        .quantum-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .input-field {
            position: relative;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            overflow: hidden;
            min-height: 70px;
            display: flex;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-field:focus-within {
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.3),
                0 0 60px rgba(0, 255, 255, 0.1);
        }

        .input-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .border-line {
            position: absolute;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            transition: all 0.3s ease;
        }

        .border-top {
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            transform: scaleX(0);
            transform-origin: left;
        }

        .border-right {
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            transform: scaleY(0);
            transform-origin: top;
        }

        .border-bottom {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            transform: scaleX(0);
            transform-origin: right;
        }
        .border-left {
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            transform: scaleY(0);
            transform-origin: bottom;
        }

        .input-field:focus-within .border-top,
        .input-field:focus-within .border-right,
        .input-field:focus-within .border-bottom,
        .input-field:focus-within .border-left {
            transform: scale(1);
        }

        .input-field input {
            width: 100%;
            padding: 22px 26px;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 1.15rem;
            outline: none;
            font-weight: 500;
            height: 72px;
            min-height: 72px;
            line-height: 1.3;
            text-indent: 0;
            caret-color: #00ffff;
            z-index: 1;
            position: relative;
        }

        .input-field input::placeholder {
            color: rgba(0, 255, 255, 0.6);
            font-weight: 400;
            opacity: 1;
            text-indent: 0;
            transition: all 0.3s ease;
        }

        .input-field:focus-within input::placeholder {
            color: rgba(0, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .input-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .input-field:focus-within .input-glow {
            opacity: 1;
        }

        .input-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .input-particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #00ffff;
            border-radius: 50%;
            animation: input-particle-float 3s ease-in-out infinite;
        }

        .input-particle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .input-particle:nth-child(2) { top: 80%; left: 80%; animation-delay: 1.5s; }

        @keyframes input-particle-float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
            50% { transform: translateY(-5px) translateX(5px); opacity: 1; }
        }
        /* Quantum Login Button */
        .quantum-login-btn {
            width: 100%;
            height: 72px;
            position: relative;
            border: none;
            background: transparent;
            cursor: pointer;
            margin-top: 32px;
            overflow: visible;
        }
        .btn-core {
            position: relative;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #00ffff, #0080ff, #8000ff);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: #000;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.4),
                0 0 60px rgba(0, 255, 255, 0.2);
        }
        .btn-core:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 0 50px rgba(0, 255, 255, 0.6),
                0 0 100px rgba(0, 255, 255, 0.3);
        }

        .btn-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .btn-core:hover .btn-glow {
            opacity: 1;
        }

        .btn-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .btn-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #ffffff;
            border-radius: 50%;
            animation: btn-particle-float 2s ease-in-out infinite;
        }

        .btn-particle:nth-child(1) { top: 30%; left: 20%; animation-delay: 0s; }
        .btn-particle:nth-child(2) { top: 70%; left: 80%; animation-delay: 0.5s; }
        .btn-particle:nth-child(3) { top: 50%; left: 50%; animation-delay: 1s; }

        @keyframes btn-particle-float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.5; }
            50% { transform: translateY(-8px) translateX(8px); opacity: 1; }
        }

        .btn-border {
            position: absolute;
            top: -2px;
            left: -2px;
            width: calc(100% + 4px);
            height: calc(100% + 4px);
            pointer-events: none;
        }

        .btn-border-line {
            position: absolute;
            background: linear-gradient(90deg, #00ffff, #ff00ff, #ffff00, #00ffff);
            background-size: 300% 100%;
            animation: border-flow 3s linear infinite;
        }

        .btn-border-line:nth-child(1) {
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
        }

        .btn-border-line:nth-child(2) {
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
        }

        .btn-border-line:nth-child(3) {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
        }

        .btn-border-line:nth-child(4) {
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
        }

        @keyframes border-flow {
            0% { background-position: 0% 0%; }
            100% { background-position: 300% 0%; }
        }

        /* Enhanced Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 15px;
            padding: 16px 20px;
            margin-bottom: 24px;
            color: #ff6b6b;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .error-icon {
            color: #ff6b6b;
            font-size: 1.1rem;
            animation: error-pulse 2s ease-in-out infinite;
        }

        .error-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
            animation: error-pulse-animation 2s ease-in-out infinite;
        }

        @keyframes error-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes error-pulse-animation {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.05); }
        }

        /* Ambient Light Effects */
        .ambient-lights {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }

        .light-source {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            animation: ambient-pulse 6s ease-in-out infinite;
        }

        .light-1 {
            top: 20%;
            left: 15%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            animation-delay: 0s;
        }

        .light-2 {
            top: 70%;
            right: 20%;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255, 0, 255, 0.08) 0%, transparent 70%);
            animation-delay: 2s;
        }

        .light-3 {
            bottom: 30%;
            left: 60%;
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.06) 0%, transparent 70%);
            animation-delay: 4s;
        }

        @keyframes ambient-pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Data Streams */
        .data-streams {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
        }
        .data-stream {
            position: absolute;
            background: linear-gradient(180deg, transparent, rgba(0, 255, 255, 0.3), transparent);
            animation: data-flow 8s linear infinite;
        }

        .stream-1 {
            top: 0;
            left: 25%;
            width: 1px;
            height: 100vh;
            animation-delay: 0s;
        }

        .stream-2 {
            top: 0;
            left: 75%;
            width: 1px;
            height: 100vh;
            animation-delay: 3s;
        }

        .stream-3 {
            top: 0;
            left: 50%;
            width: 1px;
            height: 100vh;
            animation-delay: 6s;
        }

        @keyframes data-flow {
            0% { 
                transform: translateY(-100vh);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(100vh);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .quantum-portal {
                max-width: 90%;
                padding: 0 20px;
            }

            .login-container {
                padding: 40px 30px;
            }

            .login-title {
                font-size: 2.2rem;
            }

            .portal-rings .ring-1 {
                width: 300px;
                height: 300px;
                top: -50px;
                left: -50px;
            }

            .portal-rings .ring-2 {
                width: 400px;
                height: 400px;
                top: -100px;
                left: -100px;
            }

            .portal-rings .ring-3 {
                width: 500px;
                height: 500px;
                top: -150px;
                left: -150px;
            }
        }

        @media (max-width: 480px) {
            .quantum-portal {
                max-width: 95%;
                padding: 0 15px;
            }

            .login-container {
                padding: 30px 20px;
            }

            .login-title {
                font-size: 1.8rem;
            }

            .real-logo {
                width: 100px;
            }
        }
        

        
        /* ==================== PREMIUM USER PORTAL ==================== */
        .app-container {
            display: none;
            min-height: 100vh;
            background: var(--gradient-dark);
        }
        
        /* Ensure JavaScript can control display */
        #userPortal.app-container {
            display: none;
        }
        
        #userPortal.app-container[style*="display: block"] {
            display: block !important;
        }
        
        /* ==================== SOPHISTICATED SIDEBAR ==================== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: var(--transition-normal);
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,178,0,0.05) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo img {
            width: 180px;
            height: auto;
            border-radius: var(--radius-md);
            object-fit: contain;
        }
        
        .logo span { display: none; }
        
        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px; /* add spacing between items so icon bubbles don't touch */
        }
        
        .nav-item {
            position: relative;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px 12px 22px; /* extra left padding so icon bubble has breathing room */
            color: rgba(235,238,245,0.96) !important;
            text-decoration: none;
            border-radius: 10px; /* less bubbly */
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
            font-weight: 600;
            letter-spacing: .2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.25);
            border: 1px solid transparent; /* crisp hover ring */
        }
        .nav-link:visited { color: rgba(255,255,255,0.96) !important; }
        
        .nav-link::before {
            content: '';
            position: absolute;
            inset: 0; /* ensure perfect fit */
            border-radius: inherit; /* match corners exactly */
            background: linear-gradient(90deg, rgba(255,178,0,0.18) 0%, rgba(255,178,0,0.12) 40%, rgba(255,178,0,0.08) 100%);
            box-shadow: inset 0 0 0 1px rgba(255,178,0,0.25);
            opacity: 0;
            transition: var(--transition-normal);
            z-index: -1;
        }
        
        .nav-link:hover::before,
        .nav-link.active::before {
            opacity: 1;
        }
        
        .nav-link:hover,
        .nav-link.active {
            color: #0b0b10 !important; /* dark text on light hover */
            transform: translateX(3px); /* subtle shift */
            font-weight: 700;
            text-shadow: none;
            border-color: rgba(255,178,0,0.35);
        }
        
        .nav-link i {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.05rem;
            width: 36px; /* larger bubble */
            height: 36px;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            color: var(--primary);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
            flex-shrink: 0;
        }
        .nav-link:hover i,
        .nav-link.active i {
            background: rgba(255,255,255,0.18);
            color: #0b0b10;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
        }
        .nav-link:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255,178,0,0.45), 0 0 0 4px rgba(255,178,0,0.18);
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: var(--space-lg);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .notification-container {
            margin-bottom: var(--space-md);
        }
        
        .notification-bell {
            width: 100%;
            padding: var(--space-md);
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }
        
        .notification-bell:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: var(--radius-full);
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        
        .dashboard-header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
        }
        
        .dashboard-header h1 {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-sm);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-header p {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.7);
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* ==================== PREMIUM CARDS ==================== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
        }
        
        .card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: var(--transition-normal);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(255,178,0,0.3);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.85rem 1.25rem; /* consistent inner padding for header background */
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }
        
        .card-header i {
            font-size: 2rem;
            color: rgba(255,178,0,0.5);
        }
        
        /* ==================== NOTIFICATION SYSTEM ==================== */
        .notification-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-height: 500px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            overflow: hidden;
            animation: slideInDown 0.3s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            background: rgba(255,178,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .notification-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .clear-all-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 0.9rem;
        }
        
        .clear-all-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
            padding: var(--space-md);
        }
        
        .no-notifications {
            text-align: center;
            padding: var(--space-xl);
            color: rgba(255,255,255,0.5);
        }
        
        .no-notifications i {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.3;
        }
        
        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .login-screen {
                padding: 80px 20px;
            }
            
            .login-container {
                padding: 40px 30px;
                margin: 20px;
                max-width: 100%;
            }
            
            .real-logo {
                width: 100px;
                max-height: 60px;
            }
            
            .login-title {
                font-size: 2rem;
            }
            
            .dashboard-header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: var(--space-lg);
            }
        }
        @media (max-width: 480px) {
            .login-screen {
                padding: 60px 15px;
            }
            
            .login-container {
                padding: 30px 20px;
                margin: 15px;
            }
            
            .real-logo {
                width: 80px;
                max-height: 50px;
            }
            
            .login-title {
                font-size: 1.8rem;
            }
            
            .login-subtitle {
                font-size: 1rem;
                padding: 6px 12px;
            }
        }
        
        /* BULLETPROOF LOGIN SCREEN STYLES - NO EXTERNAL OVERRIDES */
        #loginScreen.login-screen {
            /* Force full viewport coverage with proper breathing room */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            
            /* Beautiful dark gradient background */
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 30%, #0f3460 70%, #16213e 100%);
            
            /* CRITICAL: MAJOR SPACING FIX - Add substantial top and bottom margins */
            padding: 0;
            margin: 0;
            
            /* Perfect centering with proper spacing */
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* Ensure it's above everything */
            z-index: 999999;
            
            /* Prevent any scrolling issues */
            overflow: hidden;
        }
        #loginScreen .login-container {
            /* Dark, elegant container */
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 178, 0, 0.4);
            border-radius: 20px;
            
            /* Proper internal spacing */
            padding: 48px 40px;
            
            /* Perfect width constraints */
            max-width: 560px;
            width: 92%;
            
            /* Beautiful shadow effects */
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 178, 0, 0.1);
            
            /* CRITICAL: MAJOR SPACING FIX - Add substantial top and bottom margins */
            margin: 6vh auto;
            
            /* Prevent any external interference */
            position: relative;
            transform: none;
        }
        #loginScreen .real-logo {
            width: 120px;
            height: auto;
            max-height: 80px;
        }
        #loginScreen .login-title {
            color: #FFB200;
        }
        
        #loginScreen .login-subtitle {
            color: #E8E8E8;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* CRITICAL: ADDITIONAL SPACING ENFORCEMENT */
        #loginScreen {
            /* Force minimum spacing from viewport edges */
            min-height: calc(100vh - 160px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #loginScreen .login-container {
            /* Dark, elegant container */
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 178, 0, 0.4);
            border-radius: 20px;
            
            /* Proper internal spacing */
            padding: 48px 40px;
            
            /* Perfect width constraints */
            max-width: 560px;
            width: 92%;
            
            /* Beautiful shadow effects */
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 178, 0, 0.1);
            
            /* CRITICAL: MAJOR SPACING FIX - Add substantial top and bottom margins */
            margin: 6vh auto;
            
            /* Prevent any external interference */
            position: relative;
            transform: none;
        }
        
        /* BULLETPROOF INPUT FIELD STYLES - PERFECT READABILITY */
        #loginScreen .input-container {
            /* Dark, readable background */
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            margin-bottom: 24px;
            
            /* Ensure proper layout and spacing */
            position: relative;
            overflow: hidden;
            min-height: 60px;
            display: flex;
            align-items: center;
        }
        
        #loginScreen .input-container:focus-within {
            /* Enhanced focus state */
            background: rgba(0, 0, 0, 0.9) !important;
            border-color: #FFB200 !important;
            box-shadow: 0 0 0 4px rgba(255, 178, 0, 0.3) !important;
            transform: translateY(-1px) !important;
        }
        
        #loginScreen .input-container input {
            /* Perfect text visibility */
            color: #FFFFFF !important;
            background: rgba(0, 0, 0, 0.8) !important;
            padding: 20px 24px !important;
            font-size: 16px !important;
            font-weight: 500 !important;
            
            /* Ensure full width and height */
            width: 100% !important;
            height: 60px !important;
            min-height: 60px !important;
            border: none !important;
            outline: none !important;
            
            /* Smooth transitions */
            transition: all 0.3s ease !important;
            
            /* Ensure input is visible and interactive */
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #loginScreen .input-container input::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
            font-weight: 400 !important;
        }
        
        /* Hover effect for better UX */
        #loginScreen .input-container:hover {
            background: rgba(0, 0, 0, 0.8) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
        }
        
        /* Additional input field fixes */
        #loginScreen .input-container input:focus {
            background: rgba(0, 0, 0, 0.9) !important;
            border: 2px solid #FFB200 !important;
            box-shadow: 0 0 0 4px rgba(255, 178, 0, 0.3) !important;
        }
        
        /* Ensure input fields are not hidden or collapsed */
        #loginScreen .form-group {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Fix any potential CSS conflicts */
        #loginScreen input[type="email"],
        #loginScreen input[type="password"] {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            box-sizing: border-box !important;
            /* Force input field visibility */
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            /* Ensure proper dimensions */
            height: 60px !important;
            min-height: 60px !important;
            line-height: 1.2 !important;
            /* Prevent text from being hidden */
            text-indent: 0 !important;
            /* Ensure cursor is visible */
            caret-color: #FFB200 !important;
        }
        
        /* Fix login button */
        #loginScreen .login-btn {
            background: linear-gradient(135deg, #FFB200, #FFD700) !important;
            color: #000000 !important;
            padding: 18px 24px !important;
            border-radius: 16px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            border: none !important;
            margin-top: 30px !important;
        }
        
        /* ==================== ANIMATIONS & EFFECTS ==================== */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .bounce-in {
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* ==================== ADDITIONAL COMPONENTS ==================== */
        .jobs-grid,
        .contracts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
        }
        
        .profile-info,
        .project-info,
        .payment-info {
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-item .label {
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }
        
        .info-item .value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .highlight {
            color: var(--primary-light) !important;
            font-weight: 700;
        }
        
        /* ==================== STATUS BADGES ==================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-upcoming {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-in-progress {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-completed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-on-hold {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* ==================== BUTTONS ==================== */
        .btn-primary {
            background: var(--gradient-primary);
            color: #000;
            border: none;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            text-decoration: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }
        
        /* ==================== LOADING STATES ==================== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-2xl);
            color: rgba(255,255,255,0.5);
        }
        
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,178,0,0.3);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: var(--space-sm);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== EMPTY STATES ==================== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: rgba(255,255,255,0.5);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.3;
        }
        
        .empty-state h3 {
            color: var(--primary);
            margin-bottom: var(--space-sm);
            font-family: var(--font-display);
        }
        
        .empty-state p {
            color: rgba(255,255,255,0.7);
            line-height: 1.6;
        }

        .main-content {
            margin-left: 300px;
            padding: 2.5rem;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
        }
        
        /* ==================== HEADER & NAVIGATION ==================== */
        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--spacing-2xl);
        }

        .logo img {
            width: 180px;
            height: auto;
            border-radius: var(--radius-sm);
            object-fit: contain;
        }

        .logo span { display: none; }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: var(--spacing-sm);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: var(--transition-normal);
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--gradient-glass);
            color: var(--primary);
            transform: translateX(4px);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* ==================== CARDS & COMPONENTS ==================== */
        .card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        /* Ensure readability in key dashboard cards */
        .card.profile-card,
        .card.project-card,
        .card.payment-card {
            background: rgba(0,0,0,0.45);
            border-color: rgba(255,255,255,0.12);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,178,0,0.3), transparent);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-color: rgba(255,178,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: var(--spacing-lg);
        }

        .card-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        /* ==================== STATUS INDICATORS ==================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-upcoming {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-in-progress {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-completed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* ==================== PROGRESS BARS ==================== */
        .progress-container {
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
            height: 8px;
            overflow: hidden;
            margin: var(--spacing-md) 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-sm);
            transition: var(--transition-slow);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ==================== TIMELINE ==================== */
        .timeline {
            position: relative;
            padding-left: var(--spacing-xl);
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gradient-primary);
        }

        .timeline-item {
            position: relative;
            margin-bottom: var(--spacing-lg);
            padding-left: var(--spacing-lg);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid var(--secondary);
        }

        .timeline-item.completed::before {
            background: var(--accent);
        }

        .timeline-item.active::before {
            background: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 178, 0, 0.3);
        }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .modal-content {
            background: var(--secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* ==================== NOTIFICATIONS ==================== */
        .notification-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 1001;
            max-width: 400px;
        }

        .notification {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transform: translateX(100%);
            animation: slideIn 0.3s ease forwards;
            box-shadow: var(--shadow-lg);
        }

        @keyframes slideIn {
            to { transform: translateX(0); }
        }
        .notification.success {
            border-left: 4px solid var(--accent);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                left: -280px;
                transition: var(--transition-normal);
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }

        /* ==================== ANIMATIONS ==================== */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== MODERN LOGIN SCREEN ==================== */
        /* REMOVED DUPLICATE .login-screen definition to prevent conflicts */

        /* FINAL LOGIN LAYOUT OVERRIDES (spacing + sizing) */
        #loginScreen { 
            padding-block: 6vh !important; 
            box-sizing: border-box !important;
        }
        #loginScreen .quantum-portal { 
            margin-block: 2vh !important; 
        }
        #loginScreen .login-container { 
            margin: 8vh auto !important; 
            max-width: 680px !important; 
            width: 95% !important;
        }
        #loginScreen .login-form { 
            max-width: 560px !important; 
            margin: 0 auto !important;
        }
        /* Wider, taller inputs for better readability */
        #loginScreen .login-form .input-field input { 
            width: 100% !important; 
            min-height: 60px !important; 
            padding: 18px 22px !important; 
            font-size: 18px !important; 
            border-radius: 14px !important;
        }
        /* Full-width, larger Sign In button */
        #loginScreen .quantum-login-btn { 
            width: 100% !important; 
            min-height: 64px !important; 
            padding: 18px 28px !important; 
            font-size: 18px !important; 
            border-radius: 14px !important;
        }

        .login-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        .floating-elements {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .floating-icon {
            position: absolute;
            font-size: 2.5rem;
            opacity: 0.08;
            animation: float 8s ease-in-out infinite;
            animation-delay: var(--delay);
            filter: blur(0.5px);
        }
        .floating-icon:nth-child(1) { top: 15%; left: 8%; animation-duration: 10s; }
        .floating-icon:nth-child(2) { top: 65%; left: 85%; animation-duration: 12s; }
        .floating-icon:nth-child(3) { top: 85%; left: 15%; animation-duration: 9s; }
        .floating-icon:nth-child(4) { top: 25%; left: 75%; animation-duration: 11s; }
        .floating-icon:nth-child(5) { top: 75%; left: 45%; animation-duration: 13s; }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg) scale(1); 
                opacity: 0.08;
            }
            50% { 
                transform: translateY(-30px) rotate(180deg) scale(1.1); 
                opacity: 0.12;
            }
        }

        .login-container {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            width: 100%;
            padding: 2rem;
            gap: 4rem;
            transform-style: preserve-3d;
        }

        .login-brand {
            flex: 1;
            text-align: center;
            color: white;
            transform: translateZ(50px);
            animation: brandFloat 6s ease-in-out infinite;
        }

        @keyframes brandFloat {
            0%, 100% { transform: translateZ(50px) translateY(0px); }
            50% { transform: translateZ(50px) translateY(-10px); }
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            transform: translateZ(30px);
        }

        .logo-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFB200, #FF8C00, #FF6B00);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 8px 32px rgba(255, 178, 0, 0.4),
                0 0 0 1px rgba(255, 178, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: pulse 3s ease-in-out infinite;
            position: relative;
        }
        .logo-circle::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #FFB200, #FF8C00);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.5;
            filter: blur(8px);
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg); 
                box-shadow: 
                    0 8px 32px rgba(255, 178, 0, 0.4),
                    0 0 0 1px rgba(255, 178, 0, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                transform: scale(1.08) rotate(5deg); 
                box-shadow: 
                    0 12px 40px rgba(255, 178, 0, 0.6),
                    0 0 0 2px rgba(255, 178, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }
        }

        .logo-text {
            font-size: 2.8rem;
            font-weight: bold;
            color: #000;
            font-family: 'Cinzel', serif;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .brand-text {
            text-align: left;
        }

        .brand-title {
            font-size: 3.2rem;
            font-weight: bold;
            color: #FFB200;
            margin: 0;
            font-family: 'Cinzel', serif;
            text-shadow: 
                0 0 20px rgba(255, 178, 0, 0.6),
                0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
        }

        .brand-subtitle {
            font-size: 1.6rem;
            color: #FFB200;
            margin: 0;
            font-family: 'Cinzel', serif;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        .portal-icon {
            font-size: 4.5rem;
            margin: 1.5rem 0;
            animation: bounce 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.05); }
        }
        .login-title {
            font-size: 2.8rem;
            font-weight: bold;
            color: #FFB200;
            margin: 1.5rem 0;
            font-family: 'Cinzel', serif;
            text-shadow: 
                0 0 25px rgba(255, 178, 0, 0.7),
                0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .login-subtitle {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }

        .login-form-container {
            flex: 1;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 3.5rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateZ(100px) rotateX(5deg);
            animation: formFloat 8s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .login-form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 178, 0, 0.1), rgba(255, 140, 0, 0.05));
            border-radius: 25px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .login-form-container:hover::before {
            opacity: 1;
        }

        @keyframes formFloat {
            0%, 100% { 
                transform: translateZ(100px) rotateX(5deg) translateY(0px); 
                box-shadow: 
                    0 20px 60px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(255, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
            50% { 
                transform: translateZ(100px) rotateX(5deg) translateY(-8px); 
                box-shadow: 
                    0 25px 70px rgba(0, 0, 0, 0.5),
                    0 0 0 2px rgba(255, 255, 255, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            position: relative;
            z-index: 2;
        }

        .form-group {
            position: relative;
            transform: translateZ(20px);
        }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.3rem;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .input-container input {
            width: 100%;
            padding: 1.2rem 1.2rem 1.2rem 3.5rem;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .input-container input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 300;
        }

        .input-container input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.18);
            border-color: #FFB200;
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.3),
                0 0 0 3px rgba(255, 178, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            caret-color: #FFB200;
        }

        .input-container input:focus + .input-icon {
            color: #FFB200;
            transform: scale(1.1);
        }

        .input-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFB200, #FF8C00, #FF6B00);
            transform: scaleX(0);
            transition: transform 0.4s ease;
            border-radius: 0 0 15px 15px;
        }

        .input-container input:focus + .input-line {
            transform: scaleX(1);
        }

        .login-btn {
            background: linear-gradient(135deg, #FFB200, #FF8C00, #FF6B00);
            color: #000;
            border: none;
            padding: 1.3rem 2.5rem;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 
                0 8px 24px rgba(255, 178, 0, 0.4),
                0 0 0 1px rgba(255, 178, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transform: translateZ(30px);
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .login-btn:hover {
            transform: translateZ(30px) translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 32px rgba(255, 178, 0, 0.6),
                0 0 0 2px rgba(255, 178, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:active {
            transform: translateZ(30px) translateY(-1px) scale(0.98);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 15px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            color: #ef4444;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-family: 'Inter', sans-serif;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
        }

        /* ==================== LOADING STATES ==================== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== SCROLLBAR STYLING ==================== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ==================== ADDITIONAL COMPONENTS ==================== */
        .dashboard-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        
        /* Enhanced text contrast for better readability */
        .dashboard-header h1 {
            color: #FFB200 !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;
            font-weight: 700 !important;
        }
        
        .dashboard-header p {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
        }
        
        /* Improved card title contrast */
        .card-title {
            color: #FFB200 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
            font-weight: 700 !important;
        }

        .dashboard-header h1 {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
            line-height: 1.2;
            padding: 0.35rem 0.75rem;
        }

        .dashboard-header p {
            color: rgba(255,255,255,0.7);
            font-size: 1.2rem;
            line-height: 1.6;
            max-width: 600px;
            padding: 0 0.75rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2.5rem;
            margin-top: 2rem;
        }

        .profile-info,
        .project-info,
        .payment-info,
        .job-info,
        .contract-info,
        .performance-info {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 200px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            transition: all 0.2s ease;
        }

        .info-item:hover {
            background: rgba(255,255,255,0.02);
            margin: 0 -1rem;
            padding: 1rem;
            border-radius: 8px;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .label {
            color: rgba(255,255,255,0.7) !important;
            font-weight: 500;
            font-size: 0.95rem;
            letter-spacing: 0.02em;
        }

        .value {
            color: white !important;
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.01em;
        }

        .value.highlight {
            color: var(--primary) !important;
        }

        /* Ensure profile information text is always visible */
        .profile-info .info-item .label,
        .profile-info .info-item .value {
            color: rgba(255,255,255,0.7) !important;
        }

        .profile-info .info-item .value {
            color: white !important;
        }

        .profile-info .info-item .value.highlight {
            color: var(--primary) !important;
        }

        /* Force dark theme for profile information */
        .profile-card .profile-info,
        .profile-card .info-item,
        .profile-card .label,
        .profile-card .value {
            background: transparent !important;
            color: inherit !important;
        }

        /* Override any conflicting white backgrounds */
        .profile-card {
            background: rgba(0,0,0,0.45) !important;
            color: white !important;
        }

        .profile-card * {
            color: inherit !important;
        }

        .profile-card .label {
            color: rgba(255,255,255,0.7) !important;
        }

        .profile-card .value {
            color: white !important;
        }

        .profile-card .value.highlight {
            color: var(--primary) !important;
        }

        /* Additional contrast improvements */
        .profile-info .info-item {
            background: rgba(255,255,255,0.02) !important;
            border-radius: 8px !important;
            padding: 0.75rem 1rem !important;
            margin-bottom: 0.5rem !important;
        }

        .profile-info .info-item:hover {
            background: rgba(255,255,255,0.05) !important;
            transform: translateX(4px) !important;
        }

        /* Ensure text is always readable */
        .profile-info .label {
            color: rgba(255,255,255,0.8) !important;
            font-weight: 600 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
        }

        .profile-info .value {
            color: #ffffff !important;
            font-weight: 700 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
        }

        .profile-info .value.highlight {
            color: #FFB200 !important;
            font-weight: 800 !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7) !important;
        }

        .project-progress {
            margin-top: var(--spacing-md);
        }

        .progress-text {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            margin-top: var(--spacing-xs);
        }

        .payment-method,
        .no-payment,
        .no-project,
        .no-jobs-content,
        .no-contract-content,
        .no-performance-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1.5rem;
            padding: 3rem 2rem;
            min-height: 300px;
            justify-content: center;
        }

        .payment-method i,
        .no-payment i,
        .no-project i,
        .no-jobs-content i,
        .no-contract-content i,
        .no-performance-content i {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .payment-method:hover i,
        .no-payment:hover i,
        .no-project:hover i,
        .no-jobs-content:hover i,
        .no-contract-content:hover i,
        .no-performance-content:hover i {
            transform: scale(1.1);
            opacity: 1;
        }

        .no-payment i,
        .no-project i,
        .no-jobs-content i,
        .no-contract-content i,
        .no-performance-content i {
            color: rgba(255,255,255,0.3);
        }

        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 2.5rem;
            margin-top: 2rem;
        }
        .job-card {
            position: relative;
        }

        .job-timeline {
            margin-top: var(--spacing-md);
            overflow: visible; /* ensure stepper glow/line isn't clipped */
            padding: 1rem; /* slightly tighter */
        }

        .job-timeline h4 {
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }

        .job-payment-section {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .job-payment-section h4 {
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }

        .job-payment-section .payment-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .job-payment-section .payment-method {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--success);
            font-weight: 600;
        }

        .job-payment-section .no-payment {
            text-align: center;
            color: rgba(255,255,255,0.7);
        }

        .job-payment-section .no-payment i {
            font-size: 2rem;
            color: var(--warning);
            margin-bottom: var(--spacing-sm);
        }

        .job-payment-section .no-payment p {
            margin-bottom: var(--spacing-md);
        }

        .timeline-content h4 {
            color: white;
            margin-bottom: var(--spacing-xs);
        }

        .timeline-content p {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        .contract-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .performance-rating {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .performance-rating h3 {
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }
        .rating-stars {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .rating-text {
            color: rgba(255,255,255,0.7);
            font-weight: 600;
        }

        .performance-comments {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .performance-comments h4 {
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }

        .performance-comments p {
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: var(--spacing-lg);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-dark);
            padding: var(--spacing-lg);
        }
        .login-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-header {
            margin-bottom: var(--spacing-2xl);
        }

        .login-header h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }
        .login-header p {
            color: rgba(255,255,255,0.7);
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .form-group {
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
            transition: var(--transition-normal);
        }

        .form-group input:focus {
            outline: none;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
            caret-color: #FFB200;
            background: rgba(255, 255, 255, 0.15);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            color: #ef4444;
            margin-top: var(--spacing-md);
        }
        /* Access Denied Screen */
        .access-denied-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-dark);
            padding: var(--spacing-lg);
        }

        .access-denied-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .access-denied-icon {
            font-size: 4rem;
            color: var(--danger);
            margin-bottom: var(--spacing-lg);
        }

        .access-denied-card h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--danger);
            margin-bottom: var(--spacing-md);
        }

        .access-denied-card p {
            color: rgba(255,255,255,0.7);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }
        
        .login-logo {
            width: 140px;
            height: auto;
            margin-bottom: 2rem;
            filter: drop-shadow(0 0 3px #FFB200) drop-shadow(0 0 6px #FFB200) drop-shadow(2px 2px 0px #000000);
        }
        
        .login-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #FFB200;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(255,178,0,0.3);
        }
        
        .login-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #FFB200;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            color: #fff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-group input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.6);
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
        }
        
        .btn {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            display: inline-block;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,178,0,0.4), 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,178,0,0.4);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            margin-right: 0.5rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4), 0 4px 12px rgba(0,0,0,0.3);
        }
        /* Horizontal stepper for job timeline */
        .timeline-horizontal { position:relative; display:flex; gap:16px; align-items:center; padding:12px 16px; overflow: visible; justify-content: space-between; width: 100%; }
        .job-timeline .timeline-horizontal { min-width: 520px; }
        .job-timeline { overflow-x: auto; overscroll-behavior-x: contain; }
        .job-timeline::-webkit-scrollbar { height: 8px; }
        .job-timeline::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 8px; }
        .timeline-horizontal::before { content:''; position:absolute; left:16px; right:16px; height:3px; background: linear-gradient(90deg, rgba(255,178,0,0.2), rgba(255,215,0,0.4)); top:22px; border-radius:4px; }
        .timeline-horizontal .step { position:relative; display:flex; flex-direction:column; align-items:center; z-index:1; text-align:center; flex: 1 1 0; min-width: 0; }
        .timeline-horizontal .step .dot { width:16px; height:16px; border-radius:50%; background:#2a2a2a; border:2px solid #4a4a4a; box-shadow:0 0 0 3px rgba(255,178,0,0); transition:.25s all ease; }
        .timeline-horizontal .step .label { margin-top:8px; font-size:12px; color:#d8d8d8; max-width:120px; }
        .timeline-horizontal .step.current .dot { background:#FFB200; border-color:#FFD700; box-shadow:0 0 0 6px rgba(255,178,0,.22); }
        .timeline-horizontal .step.completed .dot { background:#18b26a; border-color:#19c67a; }
        .timeline-horizontal .step.upcoming .dot { background:#2a2a2a; }
        @media (max-width: 980px) { .timeline-horizontal { gap:12px; padding:12px 14px; } .timeline-horizontal::before { left:14px; right:14px; } .timeline-horizontal .step .label { font-size:11px; max-width:100px; } }
        @media (max-width: 720px) { .timeline-horizontal { flex-direction:column; align-items:flex-start; padding:12px 8px; } .timeline-horizontal::before{ display:none; } }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        /* User Portal */
        .user-portal {
            display: none;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            padding: 2rem;
            position: relative;
        }
        
        .user-portal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(255,178,0,0.05) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .portal-header {
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255,178,0,0.2);
            backdrop-filter: blur(10px);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 2rem;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header-left h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: #FFB200;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(255,178,0,0.3);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 2px 10px rgba(255,178,0,0.3); }
            100% { text-shadow: 0 2px 15px rgba(255,178,0,0.5); }
        }
        
        .header-left p {
            color: rgba(255,255,255,0.8);
            font-size: 1.1rem;
            margin: 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }
            
            .header-left h1 {
                font-size: 2rem;
            }
            
            .header-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .action-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .action-btn span {
                display: none;
            }
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-decoration: none;
        }
        
        .action-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: #FFB200;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,178,0,0.2);
        }
        
        .refresh-btn {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }
        
        .refresh-btn:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        
        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        /* Notification System Styles */
        .notification-container {
            position: relative;
            display: inline-block;
        }

        .notification-bell {
            background: rgba(255, 178, 0, 0.1);
            border: 1px solid rgba(255, 178, 0, 0.3);
            color: #FFB200;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 178, 0, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,178,0,0.2);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: fixed;
            top: 120px;
            right: 2rem;
            width: 350px;
            max-height: 400px;
            background: #1a1a1a;
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 9999999;
            pointer-events: auto;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.2);
        }

        .notification-header h3 {
            color: #FFB200;
            margin: 0;
            font-size: 1rem;
        }

        .clear-all-btn {
            background: none;
            border: none;
            color: #FFB200;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .clear-all-btn:hover {
            background: rgba(255, 178, 0, 0.1);
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.1);
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255, 178, 0, 0.05);
        }
        
        .notification-item.unread {
            background: rgba(255, 178, 0, 0.05);
            border-left: 3px solid #FFB200;
        }
        
        .notification-item.read {
            opacity: 0.7;
        }
        
        .notification-item.high {
            border-left: 3px solid #ff4444;
        }

        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #FFB200;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .action-required {
            background: #ff4444;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .notification-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .notification-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .notification-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .notification-actions .action-btn {
            background: rgba(255, 178, 0, 0.2);
            color: #FFB200;
            border: 1px solid rgba(255, 178, 0, 0.3);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .notification-actions .action-btn:hover {
            background: rgba(255, 178, 0, 0.3);
            border-color: #FFB200;
        }
        
        .notification-actions .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .notification-actions .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .no-notifications {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .no-notifications i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #FFB200;
        }
        
        .no-notifications small {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .no-notifications {
            padding: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .no-notifications i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: rgba(255, 178, 0, 0.3);
        }

        .refresh-btn {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            transform: rotate(180deg);
        }
        
        .portal-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .info-card, .contract-card {
            background: rgba(0,0,0,0.4);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,178,0,0.2);
            margin-bottom: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .info-card::before, .contract-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,178,0,0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-card:hover, .contract-card:hover {
            border-color: #FFB200;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(255,178,0,0.15);
        }
        
        .info-card:hover::before, .contract-card:hover::before {
            opacity: 1;
        }
        
        .info-card h3, .contract-card h4 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
            position: relative;
            z-index: 2;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Improved contract text contrast */
        .contract-card .contract-details {
            color: rgba(255,255,255,0.95) !important;
        }
        
        .contract-card .contract-details strong {
            color: #FFB200 !important;
            font-weight: 600 !important;
        }
        
        .contract-card .contract-details div {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500 !important;
        }
        
        .contract-card .contract-details span {
            color: rgba(255,255,255,0.95) !important;
            font-weight: 500 !important;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            font-size: 0.9rem;
            position: relative;
            z-index: 2;
        }
        
        .info-grid > div {
            background: rgba(255,178,0,0.05);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255,178,0,0.1);
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.95);
        }
        
        .info-grid > div strong {
            color: #FFB200;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .info-grid > div span {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }
        
        .info-grid > div:hover {
            background: rgba(255,178,0,0.1);
            border-color: rgba(255,178,0,0.2);
            transform: scale(1.02);
        }
        
        .contract-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .status-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-badge.signed {
            background: rgba(34, 197, 94, 0.25);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.4);
        }
        .status-badge.completed {
            background: rgba(34, 197, 94, 0.25);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .contract-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .contract-actions {
            margin-top: 1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255,255,255,0.9);
        }
        
        .empty-state h3 {
            color: #FFB200;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            margin-bottom: 1rem;
        }
        
                .empty-state p {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            line-height: 1.6;
        }
        
        .empty-state h3 {
            color: rgba(255,255,255,0.9);
            margin-bottom: 1rem;
        }
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.3);
            padding-bottom: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            background: rgba(255, 178, 0, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 178, 0, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,178,0,0.3), transparent);
            transition: left 0.6s ease;
        }
        .tab-btn:hover::before {
            left: 100%;
        }
        .tab-btn:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,178,0,0.2);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
            transform: translateY(-1px);
        }
        
        .portal-tab {
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .portal-tab.active {
            display: block; /* Show when active */
            opacity: 1;
            transform: translateY(0);
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Job Card Styles */
        .job-card {
            background: rgba(0,0,0,0.4);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,178,0,0.2);
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.65rem 1rem;
        }

        .job-header h3 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin-bottom: 0.25rem;
        }

        .job-location {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .status-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: flex-end;
        }

        .job-status {
            background: rgba(255, 178, 0, 0.1);
            color: #FFB200;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .payment-status {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .payment-status.pending {
            background: rgba(255, 178, 0, 0.1);
            color: #FFB200;
        }

        .payment-status.processing {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .payment-status.paid {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .payment-status.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .job-status.upcoming {
            background: rgba(255, 178, 0, 0.05);
            color: #FFB200;
        }

        .job-status.in-progress {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .job-status.completed {
            background: rgba(34, 197, 94, 0.05);
            color: #22c55e;
        }

        .job-status.on-hold {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
        }

        .job-status.cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .job-status.pending {
            background: rgba(255, 178, 0, 0.05);
            color: #FFB200;
        }

        .job-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        /* Wider screens: place timeline and info side-by-side */
        @media (min-width: 1280px) {
            .job-details.two-col { grid-template-columns: 1.2fr 0.8fr; align-items: start; gap: 1.25rem; }
        }

        .job-detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .job-detail-item i {
            color: #FFB200;
            font-size: 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-detail-item strong {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .job-detail-item span {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .contract-status.signed {
            color: #22c55e !important;
            font-weight: 600;
        }

        .contract-status.pending {
            color: #FFB200 !important;
            font-weight: 600;
        }

        /* Contract status display styles */
        .pending-state {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .job-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .job-action-btn {
            flex: 1;
            text-align: center;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .job-action-btn.secondary {
            background: rgba(255, 178, 0, 0.05);
            color: #FFB200;
            border: 1px solid rgba(255, 178, 0, 0.2);
        }

        .job-action-btn.secondary:hover {
            background: rgba(255, 178, 0, 0.1);
            border-color: rgba(255, 178, 0, 0.3);
        }

        /* Job Timeline Styles */
        .job-timeline {
            background: rgba(17, 24, 39, 0.65);
            padding: 2rem;
            border-radius: 16px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(99,102,241,0.25);
            margin-top: 1.5rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0.65rem 1rem;
        }

        .timeline-header h4 {
            color: var(--primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            text-shadow: none;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 200px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(99,102,241,0.18);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22d3ee, #a78bfa);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .current-status {
            margin-bottom: 2rem;
        }

        .status-card {
            background: rgba(99,102,241,0.10);
            border: 1px solid rgba(99,102,241,0.30);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: statusPulse 3s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.35); }
            50% { box-shadow: 0 0 0 10px rgba(99,102,241,0); }
        }

        .status-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #22d3ee, #a78bfa);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #0b1020;
            flex-shrink: 0;
        }

        .status-content h5 {
            color: var(--primary);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .status-content p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(99,102,241,0.28);
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .timeline-icon {
            position: absolute;
            left: -1rem;
            top: 0.5rem;
            width: 2rem;
            height: 2rem;
            background: rgba(99,102,241,0.12);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid rgba(99,102,241,0.45);
            z-index: 2;
        }

        .timeline-item.completed .timeline-icon {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .timeline-item.current .timeline-icon {
            background: rgba(99,102,241,0.20);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99,102,241,0.20);
        }

        .timeline-item.pending .timeline-icon {
            background: rgba(255, 178, 0, 0.05);
            border-color: rgba(255, 178, 0, 0.5);
        }

        .timeline-icon i {
            font-size: 1rem;
            color: var(--primary);
        }

        .timeline-item.completed .timeline-icon i {
            color: #22c55e;
        }

        .timeline-item.current .timeline-icon i {
            color: #FFB200;
        }

        .timeline-item.pending .timeline-icon i {
            color: rgba(255, 178, 0, 0.6);
        }

        .timeline-item.cancelled .timeline-icon i {
            color: #ef4444;
        }

        .timeline-item.cancelled .timeline-content {
            background: rgba(239, 68, 68, 0.05);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .timeline-content {
            background: rgba(0, 0, 0, 0.6);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255, 178, 0, 0.1);
            transition: all 0.3s ease;
        }

        .timeline-item.current .timeline-content {
            background: rgba(99,102,241,0.10);
            border-color: rgba(99,102,241,0.35);
        }

        .timeline-main {
            margin-bottom: 1rem;
        }

        .timeline-content strong {
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 700;
            text-shadow: none;
        }

        .timeline-content span {
            color: rgba(255,255,255,0.7);
            display: block;
        }

        .timeline-date {
            color: #c7d2fe;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }

        .timeline-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 178, 0, 0.2);
        }

        .timeline-details p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .timeline-action {
            display: inline-block;
            background: linear-gradient(135deg, #22d3ee, #a78bfa);
            color: #0b1020;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .timeline-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99,102,241,0.35);
        }

        .timeline-checklist, .timeline-requirements {
            background: rgba(17,24,39,0.45);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid rgba(99,102,241,0.45);
        }

        .timeline-checklist h6, .timeline-requirements h6 {
            color: var(--primary);
            margin: 0 0 0.75rem 0;
            font-size: 0.9rem;
        }

        .timeline-checklist ul, .timeline-requirements ul {
            margin: 0;
            padding-left: 1.25rem;
            list-style: none;
        }

        .timeline-checklist li, .timeline-requirements li {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
            position: relative;
            line-height: 1.4;
        }

        .timeline-checklist li::before {
            content: 'âœ“';
            color: #22c55e;
            font-weight: bold;
            position: absolute;
            left: -1.25rem;
        }
        .timeline-requirements li::before {
            content: 'â€¢';
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: -1.25rem;
        }

        .timeline-expand {
            background: rgba(99,102,241,0.12);
            color: #c7d2fe;
            border: 1px solid rgba(99,102,241,0.35);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .timeline-expand:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
        }

        /* Job Details Modal */
        .job-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .job-details-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .job-details-modal.hide {
            opacity: 0;
            visibility: hidden;
        }

        /* Duplicate modal-overlay definition removed - using the first one with position: fixed */

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 26, 26, 0.95));
            border-radius: 20px;
            border: 1px solid rgba(255, 178, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
        }

        .modal-header {
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: #FFB200;
        }

        .modal-body {
            padding: 2rem;
        }

        .job-progress-section {
            background: rgba(255, 178, 0, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 178, 0, 0.2);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-header h3 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .progress-percentage {
            color: #FFB200;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .modal-progress-bar {
            height: 12px;
            background: rgba(255, 178, 0, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFB200, #FFD700);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .current-phase {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .job-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .job-info-card {
            background: rgba(0, 0, 0, 0.6);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 178, 0, 0.1);
        }

        .job-info-card h4 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .info-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-item .label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .info-item .value {
            color: white;
            font-weight: 600;
        }

        .info-item .value.highlight {
            color: #FFB200;
        }

        .requirements-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .requirements-list li {
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
        }
        .requirements-list li i {
            color: #FFB200;
            width: 16px;
            flex-shrink: 0;
        }
        .current-step-section {
            background: rgba(0, 0, 0, 0.6);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 178, 0, 0.1);
        }

        .current-step-section h4 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .step-details p {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .action-required {
            background: rgba(255, 178, 0, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 178, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .action-required i {
            color: #FFB200;
        }
        .modal-action-btn {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-left: auto;
            transition: all 0.3s ease;
        }

        .modal-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 178, 0, 0.4);
        }

        .contact-section {
            background: rgba(0, 0, 0, 0.6);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 178, 0, 0.1);
            text-align: center;
        }
        .contact-section h4 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .contact-section p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
        }

        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 178, 0, 0.1);
            color: #FFB200;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            border: 1px solid rgba(255, 178, 0, 0.3);
            transition: all 0.3s ease;
        }
        .contact-link:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
        }

        /* Profile Tab Styles */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        .contact-info-card, .current-job-card {
            background: rgba(0, 0, 0, 0.8);
            padding: 2rem;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,178,0,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .contact-info-card::before, .current-job-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,178,0,0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .contact-info-card:hover, .current-job-card:hover {
            border-color: #FFB200;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(255,178,0,0.15);
        }

        .contact-info-card:hover::before, .current-job-card:hover::before {
            opacity: 1;
        }

        .contact-info-card h3, .current-job-card h3 {
            color: #FFB200;
            margin-bottom: 1.5rem;
            font-family: 'Cinzel', serif;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .contact-details {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,178,0,0.05);
            border-radius: 12px;
            border: 1px solid rgba(255,178,0,0.1);
            transition: all 0.3s ease;
        }

        .contact-item:hover {
            background: rgba(255,178,0,0.1);
            border-color: rgba(255,178,0,0.2);
            transform: scale(1.02);
        }

        .contact-item i {
            color: #FFB200;
            font-size: 1.2rem;
            width: 24px;
            flex-shrink: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .contact-item div {
            flex: 1;
        }

        .contact-item strong {
            display: block;
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .contact-item span {
            color: rgba(255,255,255,0.95);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .job-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .job-count {
            background: rgba(255, 178, 0, 0.2);
            color: #FFB200;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid rgba(255, 178, 0, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-selector {
            margin-bottom: 2rem;
            position: relative;
            z-index: 2;
        }

        .job-option {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: rgba(255,255,255,0.9);
        }

        .job-option:hover {
            border-color: rgba(255, 178, 0, 0.5);
            background: rgba(255, 178, 0, 0.05);
            transform: translateY(-2px);
            color: rgba(255,255,255,0.95);
        }

        .job-option.active {
            border-color: #FFB200;
            background: rgba(255, 178, 0, 0.1);
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
            color: rgba(255,255,255,0.95);
        }

        .job-info {
            flex: 1;
        }

        .job-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .job-title i {
            color: #FFB200;
            font-size: 1.2rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-title strong {
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .job-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .job-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .job-detail i {
            color: #FFB200;
            width: 16px;
            flex-shrink: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-detail span {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .job-status-indicator {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .job-status-indicator.upcoming {
            background: rgba(255, 178, 0, 0.2);
            color: #FFB200;
            border: 1px solid rgba(255, 178, 0, 0.4);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-status-indicator.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-status-indicator.completed {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-status-indicator.pending {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.4);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-actions-section {
            display: flex;
            gap: 1rem;
            position: relative;
            z-index: 2;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 178, 0, 0.1);
            color: #FFB200;
            border: 1px solid rgba(255, 178, 0, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
        }

        /* Multiple Jobs UI */
        .primary-badge {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-type {
            margin-bottom: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .job-type i {
            color: #FFB200;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-description {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255, 178, 0, 0.05);
            border-radius: 8px;
            border-left: 3px solid #FFB200;
        }

        .job-description p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            font-style: italic;
            line-height: 1.4;
            font-weight: 500;
        }

        .job-selector-header {
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.6);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 178, 0, 0.2);
        }

        .job-selector-header h3 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .job-tabs {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .job-tab {
            background: rgba(255, 178, 0, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 178, 0, 0.3);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-tab:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
        }

        .job-tab.active {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border-color: #FFB200;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .primary-dot {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            border: 2px solid #000;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .job-type-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .job-type-info i {
            color: #FFB200;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .portal-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid, .contract-details, .job-details {
                grid-template-columns: 1fr;
            }
            
            .job-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .timeline-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .progress-indicator {
                min-width: auto;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .status-card {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .timeline {
                padding-left: 1.5rem;
            }
            
            .timeline-icon {
                left: -1.25rem;
                width: 1.5rem;
                height: 1.5rem;
            }
            
            .timeline-icon i {
                font-size: 0.8rem;
            }
            
            .timeline-checklist, .timeline-requirements {
                padding: 0.75rem;
                margin: 0.75rem 0;
            }
            
            .tab-navigation {
                justify-content: stretch;
            }
            
            .tab-btn {
                flex: 1;
                text-align: center;
                justify-content: center;
            }
            
            /* Modal responsive */
            .modal-content {
                width: 95vw;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 1.5rem 1.5rem 1rem 1.5rem;
            }
            
            .modal-header h2 {
                font-size: 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .job-info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .action-required {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .modal-action-btn {
                margin-left: 0;
                text-align: center;
            }
            
            /* Profile responsive */
            .profile-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .contact-info-card, .current-job-card {
                padding: 1.5rem;
            }
            
            .job-details-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .job-actions-section {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .job-option {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
                padding: 1.25rem;
            }
            
            .job-status-indicator {
                align-self: flex-start;
            }
            
            .job-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .job-tab {
                justify-content: center;
                text-align: center;
            }
        }

        /* Performance Review Styles */
        .performance-review-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Enhanced performance review text contrast */
        .performance-review-card h2,
        .performance-review-card h3,
        .performance-review-card h4 {
            color: #FFB200 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
            font-weight: 700 !important;
        }
        
        .performance-review-card p {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500 !important;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.2);
        }

        .review-header h3 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            margin: 0;
        }

        .review-date {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            background: rgba(255, 178, 0, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 178, 0, 0.3);
        }

        .review-summary {
            margin-bottom: 2rem;
        }

        .overall-rating {
            background: rgba(255, 178, 0, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 178, 0, 0.2);
        }

        .overall-rating h4 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rating-number {
            font-size: 2rem;
            font-weight: bold;
            color: #FFB200;
        }

        .rating-stars {
            display: flex;
            gap: 0.25rem;
        }

        .rating-stars i {
            font-size: 1.5rem;
        }

        .review-categories {
            margin-bottom: 2rem;
        }

        .review-categories h4 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-name {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .category-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-rating .rating-number {
            font-size: 1rem;
            color: #FFB200;
        }

        .category-rating .rating-stars i {
            font-size: 1rem;
        }
        .review-comments {
            margin-bottom: 2rem;
        }
        .review-comments h4 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .comments-text {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .review-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 178, 0, 0.2);
        }

        .review-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #22c55e;
            font-weight: 500;
        }

        .review-status i {
            font-size: 1.2rem;
        }
        @media (max-width: 768px) {
            .performance-review-card {
                padding: 1.5rem;
            }

            .review-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .rating-display {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .category-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* ==================== NOTIFICATION SYSTEM STYLES ==================== */
        
        .notification-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .notification-bell {
            position: relative;
            background: rgba(255, 178, 0, 0.08);
            border: 1px solid rgba(255, 178, 0, 0.2);
            color: #FFB200;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        .notification-bell:hover {
            background: rgba(255, 178, 0, 0.15);
            border-color: rgba(255, 178, 0, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 178, 0, 0.2);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #1a1a1a;
        }
        .notification-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 450px;
            max-height: 600px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1000;
            overflow: hidden;
            backdrop-filter: blur(25px);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.2);
            background: rgba(255, 178, 0, 0.05);
        }
        .notification-header h3 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .clear-all-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .clear-all-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* ==================== NOTIFICATION SETTINGS PANEL ==================== */
        .notification-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .settings-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        .notification-settings-panel {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 178, 0, 0.2);
            background: rgba(0, 0, 0, 0.2);
        }

        .notification-settings-panel h4 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-group h5 {
            color: #e5e7eb;
            font-size: 0.9rem;
            margin: 0 0 0.75rem 0;
            font-weight: 600;
        }

        .setting-label {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .setting-label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .setting-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 178, 0, 0.3);
            border-radius: 4px;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .setting-label input[type="checkbox"]:checked + .checkmark {
            background: #FFB200;
            border-color: #FFB200;
        }

        .setting-label input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            font-size: 12px;
        }

        .setting-info {
            flex: 1;
        }

        .setting-info strong {
            color: #e5e7eb;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .setting-info small {
            color: #9ca3af;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .quiet-hours-controls {
            margin-top: 0.75rem;
            padding-left: 2rem;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .time-inputs input[type="time"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.3);
            color: #e5e7eb;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .time-inputs span {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .category-settings {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .category-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .category-label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .category-label i {
            color: #FFB200;
            width: 16px;
            text-align: center;
        }

        .category-label span {
            color: #e5e7eb;
            font-size: 0.85rem;
        }

        .settings-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 178, 0, 0.2);
        }

        .save-settings-btn, .reset-settings-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .save-settings-btn {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .save-settings-btn:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
            transform: translateY(-1px);
        }

        .reset-settings-btn {
            background: rgba(156, 163, 175, 0.1);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .reset-settings-btn:hover {
            background: rgba(156, 163, 175, 0.2);
            border-color: rgba(156, 163, 175, 0.5);
            transform: translateY(-1px);
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255, 178, 0, 0.05);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-icon {
            color: #FFB200;
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notification-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .notification-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .notification-action {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .notification-action:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .no-notifications {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .no-notifications i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .no-notifications p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* ==================== CONTRACT DETAILS MODAL ==================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        .contract-modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 16px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .contract-modal-header {
            background: linear-gradient(135deg, #FFB200 0%, #FFD700 100%);
            color: #1a1a1a;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .contract-modal-icon {
            font-size: 24px;
            color: #1a1a1a;
        }

        .contract-modal-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            flex: 1;
            font-family: 'Cinzel', serif;
        }

        .contract-modal-close {
            background: rgba(26, 26, 26, 0.2);
            border: none;
            color: #1a1a1a;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .contract-modal-close:hover {
            background: rgba(26, 26, 26, 0.3);
            transform: scale(1.1);
        }

        .contract-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            color: #ffffff;
        }

        .contract-section {
            margin-bottom: 24px;
        }

        .contract-section:last-child {
            margin-bottom: 0;
        }

        .contract-section h3 {
            color: #FFB200;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Cinzel', serif;
        }

        .contract-section h3 i {
            font-size: 14px;
        }

        .contract-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            color: #FFB200;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            word-break: break-word;
        }

        .status-signed {
            color: #22c55e !important;
            font-weight: 600;
        }

        .status-pending {
            color: #f59e0b !important;
            font-weight: 600;
        }

        .status-uploaded {
            color: #3b82f6 !important;
            font-weight: 600;
        }

        .status-unknown {
            color: #6b7280 !important;
            font-weight: 600;
        }

        .contract-notes {
            background: rgba(255, 178, 0, 0.1);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
        }

        .contract-message {
            text-align: center;
            padding: 20px;
        }

        .contract-message p {
            margin: 0;
            font-size: 16px;
            line-height: 1.5;
            color: #ffffff;
        }

        .contract-modal-footer {
            background: rgba(26, 26, 26, 0.5);
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid rgba(255, 178, 0, 0.2);
        }

        .contract-modal-footer .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .contract-modal-footer .btn-primary {
            background: linear-gradient(135deg, #FFB200 0%, #FFD700 100%);
            color: #1a1a1a;
        }

        .contract-modal-footer .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 178, 0, 0.3);
        }

        .contract-modal-footer .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .contract-modal-footer .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Responsive design for mobile */
        @media (max-width: 768px) {
            .contract-modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }

            .contract-info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .contract-modal-header {
                padding: 16px 20px;
            }

            .contract-modal-header h2 {
                font-size: 16px;
            }

            .contract-modal-body {
                padding: 20px;
            }

            .contract-modal-footer {
                padding: 12px 20px;
                flex-direction: column;
            }

            .contract-modal-footer .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ==================== PRIORITY JOBS SECTION ==================== */
        .priority-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 178, 0, 0.1), rgba(255, 178, 0, 0.05));
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 178, 0, 0.15);
            border-color: rgba(255, 178, 0, 0.3);
        }

        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #FFB200;
            font-family: 'Cinzel', serif;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .job-filters {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 150px;
        }

        .filter-group label {
            color: #FFB200;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-group select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 8px;
            color: white;
            padding: 0.75rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
        }

        .priority-jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .priority-job-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .priority-job-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFB200, #FFD700);
        }

        .priority-job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
        }

        .priority-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #1a1a1a;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .exclusive-badge {
            background: linear-gradient(135deg, #8B5CF6, #A855F7);
            color: white;
        }

        .job-card-header {
            margin-bottom: 1rem;
            padding: 0.65rem 1rem; /* inner padding for job card title bar */
        }

        .job-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
            font-family: 'Cinzel', serif;
        }

        .job-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .job-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .job-meta-icon {
            color: #FFB200;
            font-size: 1rem;
        }
        .job-pay {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #1a1a1a;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .job-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .job-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-quick-apply {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }

        .btn-quick-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .btn-details {
            background: transparent;
            color: #FFB200;
            border: 1px solid #FFB200;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-details:hover {
            background: #FFB200;
            color: #1a1a1a;
        }

        .exclusive-jobs-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 178, 0, 0.2);
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-header h2 {
            color: #FFB200;
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .section-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
        }

        .exclusive-jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        /* Mobile Responsive for Priority Jobs */
        @media (max-width: 768px) {
            .priority-stats {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-icon {
                font-size: 1.5rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .job-filters {
                flex-direction: column;
                gap: 1rem;
            }

            .filter-group {
                min-width: 100%;
            }

            .priority-jobs-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .priority-job-card {
                padding: 1rem;
            }

            .job-actions {
                flex-direction: column;
            }

            .btn-quick-apply,
            .btn-details {
                width: 100%;
                justify-content: center;
            }
        }

        /* ==================== PERFORMANCE ANALYTICS SECTION ==================== */
        .performance-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-stat {
            background: linear-gradient(135deg, rgba(255, 178, 0, 0.1), rgba(255, 178, 0, 0.05));
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .performance-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFB200, #FFD700);
        }

        .performance-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.4);
        }

        .stat-change {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.25rem;
        }

        .performance-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 0.5rem;
            border: 1px solid rgba(255, 178, 0, 0.2);
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            flex: 1;
            justify-content: center;
        }

        .tab-btn:hover {
            background: rgba(255, 178, 0, 0.1);
            color: #FFB200;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #1a1a1a;
            font-weight: 600;
        }

        /* Jobs tab styles */
        .jobs-tabs-standalone {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        /* Compact job info layout */
        .job-info-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: rgba(17, 24, 39, 0.4);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .job-info-compact .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .job-info-compact .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .job-info-compact .value {
            font-size: 0.95rem;
            color: #fff;
            font-weight: 600;
        }

        .job-info-compact .value.highlight {
            color: #FFB200;
        }

        .job-info-compact .value.warning {
            color: #f59e0b;
        }

        /* Full-width timeline */
        .job-timeline-fullwidth {
            background: rgba(17, 24, 39, 0.65);
            padding: 1.5rem;
            border-radius: 16px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(99,102,241,0.25);
        }

        .timeline-header-fullwidth {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .timeline-title h4 {
            margin: 0;
            color: #fff;
            font-size: 1.1rem;
        }

        .timeline-actions {
            display: flex;
            gap: 0.5rem;
        }

        .timeline-horizontal-fullwidth {
            position: relative;
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem 0;
            justify-content: space-between;
            width: 100%;
            overflow: visible;
        }

        .timeline-horizontal-fullwidth::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(255,178,0,0.2), rgba(255,215,0,0.4));
            top: 50%;
            transform: translateY(-50%);
            border-radius: 4px;
        }

        .timeline-horizontal-fullwidth .step {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            text-align: center;
            flex: 1 1 0;
            min-width: 0;
        }

        .timeline-horizontal-fullwidth .step .dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2a2a2a;
            border: 2px solid #4a4a4a;
            box-shadow: 0 0 0 3px rgba(255,178,0,0);
            transition: .25s all ease;
        }

        .timeline-horizontal-fullwidth .step.completed .dot {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.3);
        }

        .timeline-horizontal-fullwidth .step.current .dot {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            border-color: #FFB200;
            box-shadow: 0 0 0 3px rgba(255,178,0,0.4);
            animation: pulse-glow 2s infinite;
        }

        .timeline-horizontal-fullwidth .step .label {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #d8d8d8;
            font-weight: 500;
            max-width: 120px;
            line-height: 1.2;
        }

        .btn-payment {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border-color: #10b981 !important;
        }

        .btn-payment:hover {
            background: linear-gradient(135deg, #059669, #047857) !important;
        }

        .tab-button {
            background: rgba(255, 178, 0, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 178, 0, 0.3);
            padding: 0.28rem 0.6rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            position: relative;
            overflow: hidden;
            min-width: auto;
            flex: 0 0 auto;
            height: 32px;
            line-height: 1;
            white-space: nowrap;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,178,0,0.3), transparent);
            transition: left 0.6s ease;
        }

        .tab-button:hover::before {
            left: 100%;
        }

        .tab-button:hover {
            background: rgba(255, 178, 0, 0.2);
            border-color: rgba(255, 178, 0, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,178,0,0.2);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #FFB200, #FFD700);
            color: #000;
            border-color: #FFB200;
            box-shadow: 0 0 0 2px rgba(255, 178, 0, 0.2);
            transform: translateY(-1px);
            /* Ensure consistent sizing */
            padding: 0.28rem 0.6rem;
            font-size: 0.8rem;
            font-weight: 500;
            height: 32px;
        }

        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none;
        }

        /* All Jobs section styling */
        .all-jobs-container {
            padding: 0;
        }

        .job-section {
            margin-bottom: 2rem;
        }

        .section-title {
            color: #FFB200;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            font-size: 1rem;
        }

        .performance-tab-content {
            display: none;
        }

        .performance-tab-content.active {
            display: block;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .chart-container h3 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 2px dashed rgba(255, 178, 0, 0.3);
        }

        .chart-loading {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .recent-activity {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .recent-activity h3 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #FFB200;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFB200, #FFD700);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            font-weight: 600;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            color: white;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .activity-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        .earnings-breakdown {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .earnings-breakdown h3 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .earnings-chart {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 2px dashed rgba(255, 178, 0, 0.3);
        }

        .earnings-table {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .earnings-table h3 {
            color: #FFB200;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .earnings-table-content {
            width: 100%;
            border-collapse: collapse;
            color: white;
        }

        .earnings-table-content th {
            background: rgba(255, 178, 0, 0.2);
            color: #FFB200;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 178, 0, 0.3);
        }

        .earnings-table-content td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .earnings-table-content tr:hover {
            background: rgba(255, 178, 0, 0.05);
        }

        .applications-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-mini {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-mini-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFB200;
            font-family: 'Cinzel', serif;
        }

        .stat-mini-label {
            display: block;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.25rem;
        }

        .applications-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .application-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 178, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .application-info h4 {
            color: white;
            margin-bottom: 0.25rem;
        }

        .application-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .application-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-approved {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-denied {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-conflict {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .status-accepted {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Mobile Responsive for Performance Analytics */
        @media (max-width: 768px) {
            .performance-stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .performance-stat {
                padding: 1rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .chart-placeholder {
                height: 150px;
            }

            .performance-tabs {
                flex-direction: column;
                gap: 0.25rem;
            }

            .tab-btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .applications-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .application-item {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .table-container {
                font-size: 0.8rem;
            }

            .earnings-table-content th,
            .earnings-table-content td {
                padding: 0.5rem;
            }
        }
    </style>
    <!-- New premium theme stylesheet (loaded last to override older visuals) -->
    <!-- Removed legacy light theme to prevent white flash and enforce dark theme -->
    <style>
        /* ==================== FINAL AI LOGIN THEME (2025) ==================== */
        :root {
            --brand-indigo: #6366f1;
            --brand-emerald: #10b981;
            --brand-amber: #f59e0b;
            --brand-gold: #FFB200;
            --brand-blue: #0066CC;
            --brand-red: #ef4444;
            --dark-900: #0f172a;
            --dark-950: #020617;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --card-bg: rgba(15, 23, 42, 0.75);
            --card-border-color: rgba(99,102,241,0.20);
            --backdrop: blur(20px);
            --radius-lg: 18px;
            --radius-md: 12px;
            --radius-sm: 10px;
            --shadow-lg: 0 30px 80px rgba(0,0,0,0.45);
            --shadow-md: 0 18px 40px rgba(0,0,0,0.35);
            --shadow-sm: 0 10px 24px rgba(0,0,0,0.25);
            --glow-gold: 0 0 40px rgba(255,178,0,0.35);
            --transition: all 300ms cubic-bezier(.4,0,.2,1);
            --transition-fast: all 180ms cubic-bezier(.4,0,.2,1);
        }

        /* Background + layout */
        #loginScreen.login-screen {
            position: fixed; inset: 0; display: grid; place-items: center;
            padding: 40px 20px;
            background:
                radial-gradient(1200px 600px at 10% 0%, rgba(99,102,241,0.10), transparent 60%),
                radial-gradient(1000px 600px at 100% 20%, rgba(255,178,0,0.08), transparent 60%),
                linear-gradient(135deg, rgba(15,23,42,0.9) 0%, rgba(2,6,23,0.95) 100%);
            z-index: 99999 !important;
            visibility: visible !important; opacity: 1 !important;
        }

        /* Hide legacy decorative layers that fight the new design */
        #loginScreen .holographic-particles,
        #loginScreen .portal-rings,
        #loginScreen .holographic-logo,
        #loginScreen .portal-identity,
        #loginScreen .ambient-lights,
        #loginScreen .data-streams,
        #loginScreen .data-stream { display: none !important; }

        /* Ensure neural background sits behind */
        #loginScreen .neural-background { z-index: 0 !important; }

        /* Card */
        #loginScreen .ai-login-card {
            width: 100%; max-width: 460px;
            background: var(--card-bg);
            border: 1px solid var(--card-border-color);
            border-radius: var(--radius-lg);
            backdrop-filter: var(--backdrop);
            box-shadow: var(--shadow-lg);
            padding: 36px 28px;
            position: relative; z-index: 10005;
            /* Centering overrides */
            display: block !important;
            margin: 0 auto !important;
        }

        /* Header */
        .ai-login-header { text-align: center; margin-bottom: 24px; }
        .ai-login-logo { height: 120px; width: auto; margin: 0 auto 16px; display: block; filter: drop-shadow(0 8px 18px rgba(0,0,0,.4)); }
        .ai-login-title {
            margin: 0 0 8px; font-weight: 900; letter-spacing: -0.02em;
            font-size: clamp(24px, 4.8vw, 32px);
            background: linear-gradient(135deg, #fff, #dbeafe 40%, #fde68a 85%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .ai-login-subtitle { margin: 0; color: var(--text-secondary); font-size: 14px; }

        /* Form */
        .ai-form { display: grid; gap: 14px; }
        .ai-field { display: grid; gap: 8px; }
        .ai-label { color: var(--text-primary); font-weight: 600; font-size: 13px; }
        .ai-input {
            width: 100%; padding: 14px 16px; border-radius: 12px;
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(99,102,241,0.3);
            color: var(--text-primary); font-size: 16px; transition: var(--transition-fast);
        }
        .ai-input::placeholder { color: var(--text-secondary); opacity: .7; }
        .ai-input:focus {
            outline: none; border-color: var(--brand-gold);
            box-shadow: 0 0 0 3px rgba(255,178,0,0.18);
        }

        .ai-login-button {
            width: 100%; margin-top: 6px; cursor: pointer;
            background: linear-gradient(135deg, var(--brand-gold), #ffd166);
            color: #0a0a0a; border: 0; padding: 14px 18px; border-radius: 14px;
            font-weight: 800; font-size: 16px; letter-spacing: .02em;
            box-shadow: var(--glow-gold); transition: var(--transition-fast);
            display: inline-flex; align-items: center; justify-content: center; gap: 10px;
        }
        .ai-login-button:hover { transform: translateY(-2px); filter: brightness(1.05); }

        /* Error */
        .ai-error { display: none; border-radius: 10px; padding: 12px 14px; font-weight: 600; font-size: 13px;
            background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff;
            border: 1px solid rgba(239,68,68,.35); box-shadow: 0 6px 18px rgba(239,68,68,.25);
        }

        @media (max-width: 480px) {
            #loginScreen .ai-login-card { padding: 26px 20px; }
        }

        /* AI site-wide background inspired by index2.html */
        .ai-background { position: fixed; inset: 0; z-index: -1; overflow: hidden; }
        #neuralBg { width: 100%; height: 100%; display: block; }

        /* Parity styles from index2 (buttons, typography, glass cards) */
        :root {
            --brand-indigo: #6366f1;
            --brand-emerald: #10b981;
            --brand-amber: #f59e0b;
            --brand-gold: #FFB200;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --card-bg: rgba(15, 23, 42, 0.7);
            --card-border: 1px solid rgba(99,102,241,0.20);
            --radius-lg: 18px;
            --radius-md: 12px;
            --shadow-md: 0 18px 40px rgba(0,0,0,0.35);
            --shadow-lg: 0 30px 80px rgba(0,0,0,0.45);
            --backdrop: blur(12px);
        }
        body { color: var(--text-primary); }
        h1, h2, h3 { font-family: 'Cinzel', serif; letter-spacing: -0.01em; }

        /* Glass card utility that existing cards can adopt */
        .glass-card { background: var(--card-bg); border: var(--card-border); border-radius: var(--radius-lg); backdrop-filter: var(--backdrop); box-shadow: var(--shadow-md); }
        .card, .item-card, .profile-card, .payment-card { background: var(--card-bg) !important; border: var(--card-border) !important; border-radius: var(--radius-lg) !important; backdrop-filter: var(--backdrop) !important; box-shadow: var(--shadow-md) !important; }
        .dashboard-header { border-bottom: 1px solid rgba(99,102,241,0.2) !important; }

        /* Buttons */
        .btn, .login-btn, .btn-small { border-radius: 14px !important; font-weight: 800 !important; letter-spacing: .02em; }
        /* Compact icon buttons in timeline header */
        .timeline-header .btn-small {
            padding: 6px 8px !important;
            font-size: 12px !important;
            line-height: 1 !important;
            height: 36px !important;
            min-height: 36px !important;
            width: 42px !important;
            min-width: 42px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 10px !important;
            box-shadow: none !important;
        }
        .btn { background: linear-gradient(135deg, var(--brand-gold), #ffd166) !important; color: #0a0a0a !important; box-shadow: 0 0 40px rgba(255,178,0,0.25) !important; border: 0 !important; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .btn-secondary { background: rgba(15,23,42,0.55) !important; border: 1px solid rgba(99,102,241,0.22) !important; color: var(--text-secondary) !important; }
        .btn-secondary:hover { border-color: rgba(99,102,241,0.45) !important; color: #e2e8f0 !important; }

        /* Inputs */
        input, select, textarea { background: rgba(15,23,42,0.6) !important; border: 1px solid rgba(99,102,241,0.3) !important; color: var(--text-primary) !important; border-radius: 12px !important; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--brand-gold) !important; box-shadow: 0 0 0 3px rgba(255,178,0,0.2) !important; }

        /* Status badges */
        .status-badge, .job-status { border-radius: 12px !important; }

        /* Notification dropdown parity */
        #notificationPanel, #notificationDropdown { background: rgba(15,23,42,0.95) !important; border: 1px solid rgba(99,102,241,0.2) !important; backdrop-filter: blur(20px) !important; }
        .notification-item { background: rgba(15,23,42,0.7); border: 1px solid rgba(99,102,241,0.2); border-radius: 12px; }

        /* Lists */
        .item-list { background: transparent !important; }
        
        /* ==================== COMMUNITY FEATURES STYLES ==================== */
        
        /* Profile Picture Upload */
        .profile-picture-card {
            margin-bottom: 2rem;
        }
        
        .profile-picture-container {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary);
            position: relative;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-picture-placeholder {
            font-size: 3rem;
            color: rgba(255,255,255,0.5);
        }
        
        .profile-picture-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Contractor Directory */
        .contractor-directory-card {
            margin-bottom: 2rem;
        }
        
        .directory-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-input, .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
        }
        
        .search-input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .contractor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .contractor-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .contractor-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(255,178,0,0.2);
        }
        
        .contractor-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .contractor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--primary);
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .contractor-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contractor-avatar .placeholder {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.5);
        }
        
        .contractor-info h4 {
            margin: 0 0 0.25rem 0;
            color: white;
            font-size: 1.1rem;
        }
        
        .contractor-role {
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .contractor-details {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .contractor-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Messaging Board */
        .messaging-board-card {
            margin-bottom: 2rem;
        }
        
        .messaging-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .messages-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .message-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .message-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--primary);
            flex-shrink: 0;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-avatar .placeholder {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-author {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .message-time {
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
        }
        
        .message-text {
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }
        
        .message-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .message-like-btn,
        .message-reply-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        
        .message-like-btn:hover,
        .message-reply-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .message-like-btn.liked {
            background: var(--primary);
            color: #0b0b10;
            border-color: var(--primary);
        }
        
        .message-input-container {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .message-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .message-input input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .message-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,178,0,0.2);
        }
        
        .message-input input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .message-input button {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
        }
        
        /* New Message Modal */
        .new-message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .new-message-content {
            background: rgba(15,23,42,0.95);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255,178,0,0.2);
        }
        
        .new-message-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .new-message-header h3 {
            color: white;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .new-message-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .new-message-form textarea {
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 120px;
        }
        
        .new-message-form textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,178,0,0.2);
        }
        
        .new-message-form textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .new-message-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* Success Stories */
        .success-stories-card {
            margin-bottom: 2rem;
        }
        
        .success-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .success-stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .success-story-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .success-story-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(255,178,0,0.2);
        }
        
        .success-story-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .success-story-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .success-story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary);
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .success-story-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .success-story-avatar .placeholder {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.5);
        }
        
        .success-story-info h4 {
            margin: 0 0 0.25rem 0;
            color: white;
            font-size: 1.1rem;
        }
        
        .success-story-role {
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .success-story-achievement {
            background: rgba(255,178,0,0.2);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 1rem;
        }
        
        .success-story-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .success-story-description {
            color: rgba(255,255,255,0.8);
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        
        .success-story-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .success-stat {
            text-align: center;
        }
        
        .success-stat-number {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        
        .success-stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .success-story-date {
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
            text-align: right;
        }
        
        .success-story-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
        }
        
        .success-congratulate-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary);
            border-radius: 20px;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .success-congratulate-btn:hover {
            background: var(--primary);
            color: #0b0b10;
        }
        
        .success-share-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .success-share-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Project Showcases */
        .showcase-upload-card {
            margin-bottom: 2rem;
        }
        
        .showcase-form {
            display: grid;
            gap: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,178,0,0.2);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .showcase-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .showcases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .showcase-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .showcase-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(255,178,0,0.2);
        }
        
        .showcase-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            padding: 1rem;
        }
        
        .showcase-image {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .showcase-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .showcase-content {
            padding: 1.5rem;
        }
        
        .showcase-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .showcase-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
        }
        
        .showcase-category {
            background: var(--primary);
            color: #0b0b10;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .showcase-description {
            color: rgba(255,255,255,0.8);
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        
        .showcase-author {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .showcase-author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--primary);
        }
        
        .showcase-author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .showcase-author-info h5 {
            margin: 0;
            color: white;
            font-size: 0.9rem;
        }
        
        .showcase-author-info p {
            margin: 0;
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
        }
        
        .showcase-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .showcase-like-btn,
        .showcase-comment-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .showcase-like-btn:hover,
        .showcase-comment-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .showcase-like-btn.liked {
            background: var(--primary);
            color: #0b0b10;
            border-color: var(--primary);
        }
        
        /* Events Calendar */
        .calendar-card {
            margin-bottom: 2rem;
        }
        
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .calendar-controls span {
            color: white;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }
        
        .calendar-container {
            margin-top: 1.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-header {
            background: var(--primary);
            color: #0b0b10;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-day {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            min-height: 80px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }
        
        .calendar-day:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .calendar-day.today {
            background: rgba(255,178,0,0.2);
            border-color: var(--primary);
        }
        
        .calendar-day.has-event {
            background: rgba(255,178,0,0.1);
        }
        
        .calendar-day-number {
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .calendar-event {
            background: linear-gradient(135deg, rgba(255, 178, 0, 0.95) 0%, rgba(255, 200, 50, 0.95) 100%);
            color: #0b0b10;
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
            border: 1px solid rgba(255, 178, 0, 0.3);
            box-shadow: 0 2px 8px rgba(255, 178, 0, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .calendar-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 178, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 178, 0, 1) 0%, rgba(255, 200, 50, 1) 100%);
        }
        
        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.25rem;
        }
        
        .event-title {
            font-weight: 600;
            font-size: 0.8rem;
            line-height: 1.2;
            flex: 1;
            margin-right: 0.5rem;
        }
        
        .event-status {
            font-size: 0.65rem;
            padding: 0.15rem 0.3rem;
            border-radius: 12px;
            font-weight: 500;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .event-status.scheduled {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .event-status.completed {
            background: rgba(59, 130, 246, 0.2);
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .event-status.cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .event-status.event {
            background: rgba(168, 85, 247, 0.2);
            color: #9333ea;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        
        .event-location {
            display: flex;
            align-items: center;
            font-size: 0.65rem;
            color: rgba(11, 11, 16, 0.7);
            margin-top: 0.25rem;
        }
        
        .event-location i {
            margin-right: 0.25rem;
            font-size: 0.6rem;
        }
        
        /* Event Details Modal Styles */
        .event-details-modal {
            background: linear-gradient(135deg, rgba(15, 15, 25, 0.95) 0%, rgba(25, 25, 35, 0.95) 100%);
            border: 1px solid rgba(255, 178, 0, 0.3);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
            margin: auto;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .event-details-modal .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, rgba(255, 200, 50, 0.8) 100%);
            color: #0b0b10;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 178, 0, 0.3);
        }
        
        .event-details-modal .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .event-details-modal .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #0b0b10;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }
        
        .event-details-modal .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .event-details-modal .modal-content {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
            min-height: 300px;
            /* Override global .modal-content absolute centering used elsewhere */
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            right: auto;
            bottom: auto;
            width: auto;
        }
        
        .event-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .detail-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .detail-section.full-width {
            grid-column: 1 / -1;
        }
        
        .detail-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-label i {
            font-size: 0.8rem;
            width: 16px;
        }
        
        .detail-value {
            font-size: 1rem;
            color: white;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 2.5rem;
            display: flex;
            align-items: center;
        }
        
        .detail-section.full-width .detail-value {
            min-height: 4rem;
            align-items: flex-start;
        }
        
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .status-badge.scheduled {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-badge.completed {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-badge.cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-badge.event {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        
        .event-details-modal .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: auto; /* Push footer to bottom within flex column */
        }
        
        @media (max-width: 768px) {
            .event-details-modal {
                width: 95%;
                margin: 1rem;
            }
            
            .event-details-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .event-details-modal .modal-content {
                padding: 1.5rem;
            }
            
            .event-details-modal .modal-header {
                padding: 1rem;
            }
            
            .event-details-modal .modal-header h2 {
                font-size: 1.25rem;
            }
        }
        
        .events-list-card {
            margin-bottom: 2rem;
        }
        
        .events-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .event-item {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .event-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .event-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .event-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
        }
        
        .event-date {
            color: var(--primary);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .event-type {
            background: rgba(255,178,0,0.2);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .event-description {
            color: rgba(255,255,255,0.8);
            line-height: 1.5;
        }
        
        .event-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }
        
        /* Responsive Design for Community Features */
        @media (max-width: 768px) {
            .profile-picture-container {
                flex-direction: column;
                text-align: center;
            }
            
            .directory-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .contractor-grid {
                grid-template-columns: 1fr;
            }
            
            .showcases-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                font-size: 0.8rem;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 0.5rem;
            }
        }
        /* Replies styling */
        .replies-container { margin-top: 8px; padding-left: 56px; }
        .reply-item { display: flex; gap: 12px; margin: 10px 0; }
        .reply-avatar { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; background: var(--bg-2); display: flex; align-items: center; justify-content: center; }
        .reply-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .reply-content { background: var(--bg-2); padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); width: 100%; }
        .reply-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .reply-author { font-weight: 600; }
        .reply-time { font-size: 12px; color: var(--muted-2); }

        /* ==================== MESSAGING SYSTEM STYLES ==================== */
        .messaging-container {
            display: flex;
            height: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .conversations-panel {
            width: 350px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .conversations-header h3 {
            margin: 0;
            color: var(--white);
            font-size: 1.1rem;
        }

        .conversations-header .btn.btn-primary {
            padding: 0.6rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            box-shadow: 0 10px 24px rgba(34,211,238,0.12), 0 4px 10px rgba(167,139,250,0.12);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .conversation-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,178,0,0.3);
        }

        .conversation-item.active {
            background: rgba(255,178,0,0.1);
            border-color: var(--primary);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .conversation-participant {
            font-weight: 600;
            color: var(--white);
            font-size: 0.9rem;
        }

        .conversation-time {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .conversation-preview {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-job {
            font-size: 0.75rem;
            color: var(--primary);
            background: rgba(255,178,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .unread-badge {
            background: var(--primary);
            color: var(--black);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.2);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
        }

        .chat-participant-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--black);
            font-size: 1.1rem;
        }

        .participant-details h4 {
            margin: 0;
            color: var(--white);
            font-size: 1rem;
        }

        .status-online {
            font-size: 0.8rem;
            color: #4ade80;
        }

        .status-offline {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255,255,255,0.5);
            text-align: center;
        }

        .empty-chat i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: messageSlideIn 0.3s ease;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: var(--primary);
            color: var(--black);
            border-bottom-right-radius: 4px;
        }

        .message.received .message-content {
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .message-text {
            line-height: 1.4;
        }

        .message-attachments {
            margin-top: 0.5rem;
        }

        .attachment-item {
            display: inline-block;
            margin: 0.25rem 0.25rem 0 0;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .attachment-item img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
        }

        .attachment-item a {
            color: var(--primary);
            text-decoration: none;
        }

        .message-status {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.25rem;
            font-size: 0.7rem;
        }

        .status-sent { color: rgba(255,255,255,0.5); }
        .status-delivered { color: rgba(255,255,255,0.7); }
        .status-read { color: var(--primary); }

        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            position: relative;
        }

        .attachment-btn {
            padding: 0.75rem;
            border-radius: 50%;
            min-width: auto;
        }

        .attachment-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .attachment-menu button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--white);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .attachment-menu button:hover {
            background: rgba(255,255,255,0.1);
        }

        .message-input-container {
            flex: 1;
            display: flex;
            align-items: flex-end;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 0.5rem;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--white);
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 120px;
        }

        #messageInput::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .send-btn {
            padding: 0.75rem;
            border-radius: 50%;
            min-width: auto;
            margin-left: 0.5rem;
        }

        .attachments-preview {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .attachment-preview {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .attachment-preview img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .attachment-preview button {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 0.25rem;
        }

        .message-badge {
            background: var(--primary);
            color: var(--black);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        /* Animations */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .messaging-container {
                height: 500px;
            }
            
            .conversations-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            
            .chat-panel {
                display: none;
            }
            
            .chat-panel.active {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- AI Neural Network Background (site-wide) -->
    <div class="ai-background"><canvas id="neuralBg"></canvas></div>

    <!-- Premium Login Screen -->
    <div id="loginScreen" class="login-screen">
        <!-- Neural Network Background -->
        <div class="neural-background">
            <div class="neural-node" data-speed="0.5"></div>
            <div class="neural-node" data-speed="0.8"></div>
            <div class="neural-node" data-speed="1.2"></div>
            <div class="neural-node" data-speed="0.6"></div>
            <div class="neural-node" data-speed="1.0"></div>
            <div class="neural-node" data-speed="0.7"></div>
            <div class="neural-node" data-speed="0.9"></div>
            <div class="neural-node" data-speed="1.1"></div>
            <div class="neural-node" data-speed="0.4"></div>
            <div class="neural-node" data-speed="0.8"></div>
        </div>
        
        <!-- Holographic Particles -->
        <div class="holographic-particles">
            <div class="particle" data-speed="0.3"></div>
            <div class="particle" data-speed="0.6"></div>
            <div class="particle" data-speed="0.9"></div>
            <div class="particle" data-speed="0.4"></div>
            <div class="particle" data-speed="0.7"></div>
            <div class="particle" data-speed="1.0"></div>
            <div class="particle" data-speed="0.5"></div>
            <div class="particle" data-speed="0.8"></div>
        </div>
        
        <!-- Quantum Portal Container -->
        <div class="quantum-portal">
            <div class="portal-rings">
                <div class="ring ring-1"></div>
                <div class="ring ring-2"></div>
                <div class="ring ring-3"></div>
            </div>
            
            <!-- Main Login Container (AI Theme) -->
            <div class="login-container ai-login-card">
                <div class="ai-login-header">
                    <img class="ai-login-logo" src="Logo.png" alt="Cochran Films" width="140" height="140" decoding="async" onerror="this.style.display='none'">
                    <h1 class="ai-login-title">Creator Portal</h1>
                    <p class="ai-login-subtitle">Access your contracts and project information</p>
                </div>
                <div id="loginError" class="ai-error"></div>
                <form id="loginForm" class="ai-form" onsubmit="handleLogin(event); return false;">
                    <div class="ai-field">
                        <label for="email" class="ai-label">Email</label>
                        <input type="email" id="email" name="email" class="ai-input" placeholder="you@example.com" required autocomplete="email" inputmode="email">
                    </div>
                    <div class="ai-field">
                        <label for="password" class="ai-label">Password</label>
                        <input type="password" id="password" name="password" class="ai-input" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                    <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
                    <button type="submit" class="ai-login-button">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Sign In</span>
                    </button>
                    <button type="button" class="ai-login-button" style="background:#2b2b2b;" onclick="
                        (async function(){
                            try {
                                const emailEl = document.getElementById('email');
                                const email = emailEl && emailEl.value ? emailEl.value.trim() : '';
                                if (!email) { alert('Enter your email first to receive a reset link.'); return; }
                                if (!window.FirebaseConfig || !window.FirebaseConfig.auth) { alert('Please try again in a moment.'); return; }
                                await window.FirebaseConfig.auth.sendPasswordResetEmail(email);
                                alert('Password reset email sent. Please check your inbox.');
                            } catch(e){
                                alert('Could not send reset email: ' + (e && (e.message || e.code) || 'error'));
                            }
                        })();
                    ">
                        <i class="fas fa-unlock"></i>
                        <span>Forgot password?</span>
                    </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Ambient Light Effects -->
        <div class="ambient-lights">
            <div class="light-source light-1"></div>
            <div class="light-source light-2"></div>
            <div class="light-source light-3"></div>
        </div>
        
        <!-- Data Streams -->
        <div class="data-streams">
            <div class="data-stream stream-1"></div>
            <div class="data-stream stream-2"></div>
            <div class="data-stream stream-3"></div>
        </div>
    </div>
    <!-- Elegant User Portal -->
    <div id="userPortal" class="app-container">
        <!-- Sophisticated Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="Logo.png" alt="Cochran Films" width="140" height="140" loading="lazy" decoding="async">
                <span></span>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="#profile" class="nav-link active" onclick="showSection('profile')">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#jobs" class="nav-link" onclick="showSection('jobs')">
                        <i class="fas fa-briefcase"></i>
                        <span>Current Jobs</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#priority-jobs" class="nav-link" onclick="showSection('priority-jobs')">
                        <i class="fas fa-star"></i>
                        <span>Priority Jobs</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#contracts" class="nav-link" onclick="showSection('contracts')">
                        <i class="fas fa-file-signature"></i>
                        <span>Contracts</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#performance" class="nav-link" onclick="showSection('performance')">
                        <i class="fas fa-award"></i>
                        <span>Performance Reviews</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#community" class="nav-link" onclick="showSection('community')">
                        <i class="fas fa-users"></i>
                        <span>Community</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#showcases" class="nav-link" onclick="showSection('showcases')">
                        <i class="fas fa-images"></i>
                        <span>Project Showcases</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#equipment" class="nav-link" onclick="showSection('equipment')">
                        <i class="fas fa-toolbox"></i>
                        <span>Equipment Center</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#calendar" class="nav-link" onclick="showSection('calendar')">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Events</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#messaging" class="nav-link" onclick="showSection('messaging')">
                        <i class="fas fa-comments"></i>
                        <span>Messages</span>
                        <span class="message-badge" id="messageBadge" style="display: none;">0</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="notification-container">
                    <button class="notification-bell" onclick="toggleNotifications()" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                </div>
                <button type="button" onclick="logout()" class="btn btn-secondary">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign Out
                </button>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <div id="profile-section" class="content-section active">
                <div class="dashboard-header">
                    <h1>Welcome back, <span id="userName">User</span>!</h1>
                    <p>Here's your project overview and latest updates</p>
                </div>
                
                <div class="dashboard-grid">
                    <!-- Profile Card -->
                    <div class="card profile-card">
                        <div class="card-header">
                            <h2 class="card-title">Profile Information</h2>
                            <div class="profile-header-avatar" style="display:flex;align-items:center;gap:0.5rem;">
                                <img id="profileHeaderAvatar" src="" alt="Profile" style="display:none;width:36px;height:36px;border-radius:50%;object-fit:cover;">
                                <i id="profileHeaderIcon" class="fas fa-user-circle"></i>
                            </div>
                        </div>
                        <div class="profile-info" id="userInfo">
                            <!-- User info will be populated here -->
                        </div>
                        <div class="card-content" style="padding-top:0.75rem">
                            <div class="profile-picture-container">
                                <div class="profile-picture-preview" id="profilePicturePreview">
                                    <img id="profileImage" src="" alt="Profile Picture" style="display: none;">
                                    <div class="profile-picture-placeholder" id="profilePicturePlaceholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div class="profile-picture-actions">
                                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                                        <button class="btn btn-primary" onclick="openProfilePicker()">
                                            <i class="fas fa-upload"></i> Upload Photo
                                        </button>
                                        <button class="btn btn-secondary" onclick="openProfilePicker()">
                                            <i class="fas fa-sync"></i> Change
                                        </button>
                                        <button class="btn btn-secondary" onclick="removeProfilePicture()" id="removePictureBtn" style="display: none;">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Project -->
                    <div class="card project-card">
                        <div class="card-header">
                            <h2 class="card-title">Current Project</h2>
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="project-info" id="projectInfo">
                            <!-- Project info will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="card payment-card">
                        <div class="card-header">
                            <h2 class="card-title">Payment Method</h2>
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-info" id="paymentMethodSection">
                            <!-- Payment method will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Community Hub -->
                    <div class="card collaboration-card">
                        <div class="card-header">
                            <h2 class="card-title">Community Hub</h2>
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="collaboration-info">
                            <div class="info-item">
                                <div class="info-label">Team Members</div>
                                <div class="info-value" id="teamMemberCount">Loading...</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Active Projects</div>
                                <div class="info-value" id="activeProjectCount">Loading...</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Messages</div>
                                <div class="info-value" id="unreadMessageCount">0 Messages</div>
                            </div>
                            <button onclick="showSection('community')" 
                                    style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; border: none; 
                                           padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 600; 
                                           transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3); 
                                           width: 100%; margin-top: 1rem;">
                                <i class="fas fa-users"></i> Open Community Hub
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="jobs-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Your Current Jobs</h1>
                    <p>Track your project progress and upcoming assignments</p>
                </div>
                
                <div class="jobs-grid" id="jobsContent">
                    <!-- Jobs will be populated here -->
                </div>
            </div>
            
            <div id="priority-jobs-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-star"></i> Priority Jobs</h1>
                    <p>Exclusive access to current job opportunities - apply quickly with your saved profile</p>
                </div>
                
                <!-- Priority Jobs Stats -->
                <div class="priority-stats" id="priorityStats">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ†</div>
                        <div class="stat-content">
                            <div class="stat-number" id="priorityJobCount">0</div>
                            <div class="stat-label">Priority Jobs Available</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âš¡</div>
                        <div class="stat-content">
                            <div class="stat-number" id="quickApplyCount">0</div>
                            <div class="stat-label">Quick Applications</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ”’</div>
                        <div class="stat-content">
                            <div class="stat-number" id="exclusiveJobCount">0</div>
                            <div class="stat-label">Exclusive Jobs</div>
                        </div>
                    </div>
                </div>
                
                <!-- Job Filter Controls -->
                <div class="job-filters">
                    <div class="filter-group">
                        <label for="jobTypeFilter">Job Type:</label>
                        <select id="jobTypeFilter" onchange="filterPriorityJobs()">
                            <option value="">All Types</option>
                            <option value="photography">Photography</option>
                            <option value="videography">Videography</option>
                            <option value="editing">Editing</option>
                            <option value="event">Event Coverage</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="locationFilter">Location:</label>
                        <select id="locationFilter" onchange="filterPriorityJobs()">
                            <option value="">All Locations</option>
                            <option value="atlanta">Atlanta Area</option>
                            <option value="remote">Remote</option>
                            <option value="travel">Travel Required</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="refreshPriorityJobs()">
                            <i class="fas fa-sync-alt"></i> Refresh Jobs
                        </button>
                    </div>
                </div>
                
                <!-- Priority Jobs Grid -->
                <div class="priority-jobs-grid" id="priorityJobsContent">
                    <!-- Priority jobs will be populated here -->
                </div>
                
                <!-- Exclusive Jobs Section (Future Feature) -->
                <div class="exclusive-jobs-section" id="exclusiveJobsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-crown"></i> Exclusive Jobs</h2>
                        <p>Special opportunities available only to priority contractors</p>
                    </div>
                    <div class="exclusive-jobs-grid" id="exclusiveJobsContent">
                        <!-- Exclusive jobs will be populated here -->
                    </div>
                </div>
            </div>
            
            <div id="contracts-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Your Contracts</h1>
                    <p>Access and manage your signed contracts</p>
                </div>
                
                <div class="contracts-container" id="contractsContent">
                    <!-- Contracts will be populated here -->
                </div>
            </div>
            
            <div id="performance-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-chart-line"></i> Performance Analytics</h1>
                    <p>Track your performance, earnings, and career growth</p>
                </div>
                
                <!-- Performance Overview Stats -->
                <div class="performance-stats-grid" id="performanceStatsGrid">
                    <div class="stat-card performance-stat">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalEarnings">$0</div>
                            <div class="stat-label">Total Earnings</div>
                            <div class="stat-change" id="earningsChange">+0% this month</div>
                        </div>
                    </div>
                    <div class="stat-card performance-stat">
                        <div class="stat-icon">ðŸŽ¯</div>
                        <div class="stat-content">
                            <div class="stat-number" id="successRate">0%</div>
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-change" id="successChange">Based on completed jobs</div>
                        </div>
                    </div>
                    <div class="stat-card performance-stat">
                        <div class="stat-icon">â­</div>
                        <div class="stat-content">
                            <div class="stat-number" id="averageRating">0.0</div>
                            <div class="stat-label">Average Rating</div>
                            <div class="stat-change" id="ratingChange">Out of 5.0</div>
                        </div>
                    </div>
                    <div class="stat-card performance-stat">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="jobsCompleted">0</div>
                            <div class="stat-label">Jobs Completed</div>
                            <div class="stat-change" id="jobsChange">This month</div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tabs -->
                <div class="performance-tabs">
                    <button class="tab-btn active" onclick="switchPerformanceTab('overview')">
                        <i class="fas fa-chart-pie"></i> Overview
                    </button>
                    <button class="tab-btn" onclick="switchPerformanceTab('earnings')">
                        <i class="fas fa-dollar-sign"></i> Earnings
                    </button>
                    <button class="tab-btn" onclick="switchPerformanceTab('applications')">
                        <i class="fas fa-paper-plane"></i> Applications
                    </button>
                    <button class="tab-btn" onclick="switchPerformanceTab('reviews')">
                        <i class="fas fa-star"></i> Reviews
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="performance-overview" class="performance-tab-content active">
                    <div class="analytics-grid">
                        <div class="chart-container">
                            <h3>Earnings Trend</h3>
                            <div class="chart-placeholder" id="earningsChart">
                                <div class="chart-loading">Loading earnings data...</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Job Completion Rate</h3>
                            <div class="chart-placeholder" id="completionChart">
                                <div class="chart-loading">Loading completion data...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recent-activity">
                        <h3>Recent Activity</h3>
                        <div class="activity-timeline" id="activityTimeline">
                            <!-- Activity items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Earnings Tab -->
                <div id="performance-earnings" class="performance-tab-content">
                    <div class="earnings-breakdown">
                        <h3>Earnings Breakdown</h3>
                        <div class="earnings-chart" id="earningsBreakdownChart">
                            <div class="chart-loading">Loading earnings breakdown...</div>
                        </div>
                    </div>
                    
                    <div class="earnings-table">
                        <h3>Payment History</h3>
                        <div class="table-container">
                            <table class="earnings-table-content">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Job</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody id="earningsTableBody">
                                    <!-- Earnings rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Applications Tab -->
                <div id="performance-applications" class="performance-tab-content">
                    <div class="applications-stats">
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="totalApplications">0</span>
                            <span class="stat-mini-label">Total Applications</span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="pendingApplications">0</span>
                            <span class="stat-mini-label">Pending</span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="acceptedApplications">0</span>
                            <span class="stat-mini-label">Accepted</span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="rejectedApplications">0</span>
                            <span class="stat-mini-label">Rejected</span>
                        </div>
                    </div>
                    
                    <div class="applications-list" id="applicationsList">
                        <!-- Application items will be populated here -->
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div id="performance-reviews" class="performance-tab-content">
                    <div id="performanceContent">
                        <!-- Performance reviews will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Community Section -->
            <div id="community-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-users"></i> Community</h1>
                    <p>Connect with your team members and build professional relationships</p>
                </div>
                
                <!-- Profile Picture card moved to Profile tab -->
                
                <!-- Contractor Directory -->
                <div class="card contractor-directory-card">
                    <div class="card-header">
                        <h3><i class="fas fa-address-book"></i> Team Directory</h3>
                        <div class="directory-controls">
                            <input type="text" id="directorySearch" placeholder="Search team members..." class="search-input">
                            <select id="roleFilter" class="filter-select">
                                <option value="">All Roles</option>
                                <option value="Photographer">Photographer</option>
                                <option value="Videographer">Videographer</option>
                                <option value="Editor">Editor</option>
                                <option value="Assistant">Assistant</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="contractor-grid" id="contractorGrid">
                            <!-- Contractor cards will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Messaging Board -->
                <div class="card messaging-board-card">
                    <div class="card-header">
                        <h3><i class="fas fa-comments"></i> Team Messaging</h3>
                    </div>
                    <div class="card-content">
                        <div class="messages-container" id="messagesContainer">
                            <!-- Messages will be populated here -->
                        </div>
                        <div class="message-input-container">
                            <div class="message-input">
                                <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
                                <button class="btn btn-primary" onclick="communitySendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Success Stories -->
                <div class="card success-stories-card">
                    <div class="card-header">
                        <h3><i class="fas fa-trophy"></i> Success Stories</h3>
                        <div class="success-controls">
                            <select id="successFilter" class="filter-select">
                                <option value="">All Achievements</option>
                                <option value="Top Performer">Top Performer</option>
                                <option value="Project Excellence">Project Excellence</option>
                                <option value="Team Player">Team Player</option>
                                <option value="Innovation">Innovation</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="success-stories-grid" id="successStoriesGrid">
                            <!-- Success stories will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Project Showcases Section -->
            <div id="showcases-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-images"></i> Project Showcases</h1>
                    <p>Share your completed work and get feedback from the community</p>
                </div>
                
                <!-- Add New Showcase -->
                <div class="card showcase-upload-card">
                    <div class="card-header">
                        <h3><i class="fas fa-plus-circle"></i> Share Your Work</h3>
                    </div>
                    <div class="card-content">
                        <form id="showcaseForm" class="showcase-form">
                            <div class="form-group">
                                <label for="showcaseTitle">Project Title</label>
                                <input type="text" id="showcaseTitle" name="title" placeholder="Enter project title..." required>
                            </div>
                            <div class="form-group">
                                <label for="showcaseDescription">Description</label>
                                <textarea id="showcaseDescription" name="description" placeholder="Describe your project, techniques used, challenges overcome..." rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="showcaseImages">Upload Images</label>
                                <input type="file" id="showcaseImages" name="images" accept="image/*" multiple>
                                <div class="image-preview-container" id="imagePreviewContainer"></div>
                            </div>
                            <div class="form-group">
                                <label for="showcaseCategory">Category</label>
                                <select id="showcaseCategory" name="category">
                                    <option value="Photography">Photography</option>
                                    <option value="Videography">Videography</option>
                                    <option value="Event Coverage">Event Coverage</option>
                                    <option value="Commercial">Commercial</option>
                                    <option value="Portrait">Portrait</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-share"></i> Share Showcase
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Showcases Feed -->
                <div class="card showcases-feed-card">
                    <div class="card-header">
                        <h3><i class="fas fa-images"></i> Community Showcases</h3>
                        <div class="showcase-filters">
                            <select id="showcaseFilter" class="filter-select">
                                <option value="">All Categories</option>
                                <option value="Photography">Photography</option>
                                <option value="Videography">Videography</option>
                                <option value="Event Coverage">Event Coverage</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Portrait">Portrait</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="showcases-grid" id="showcasesGrid">
                            <!-- Showcase cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Equipment & Resource Center Section -->
            <div id="equipment-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-toolbox"></i> Equipment & Resource Center</h1>
                    <p>Browse gear, download resources, request equipment, and track maintenance</p>
                </div>

                <div class="performance-tabs" style="margin-top: 1rem;">
                    <button class="tab-btn active" onclick="switchEquipmentTab('library')">Gear Library</button>
                    <button class="tab-btn" onclick="switchEquipmentTab('resources')">Resource Downloads</button>
                    <button class="tab-btn" onclick="switchEquipmentTab('requests')">Equipment Requests</button>
                    <button class="tab-btn" onclick="switchEquipmentTab('rented')">My Rented Equipment</button>
                    <button class="tab-btn" onclick="switchEquipmentTab('maintenance')">Maintenance Tracking</button>
                </div>

                <!-- Gear Library Tab -->
                <div id="equipment-library-tab" class="performance-tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-camera"></i> Gear Library</h3>
                            <div class="filters">
                                <input type="text" id="equipmentSearch" placeholder="Search gear by name, tag, or category..." oninput="renderEquipmentList()">
                                <select id="equipmentStatusFilter" onchange="renderEquipmentList()">
                                    <option value="">All Statuses</option>
                                    <option value="available">Available</option>
                                    <option value="checked_out">Checked Out</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="retired">Retired</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="equipmentList" class="showcases-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Resource Downloads Tab -->
                <div id="equipment-resources-tab" class="performance-tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-download"></i> Resource Downloads</h3>
                        </div>
                        <div class="card-content">
                            <div id="resourceList" class="showcases-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Equipment Requests Tab (no manual form; uses Gear Library "Request" CTA) -->
                <div id="equipment-requests-tab" class="performance-tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-inbox"></i> Your Requests</h3>
                        </div>
                        <div class="card-content">
                            <div class="empty-state" style="margin-bottom:1rem;">
                                <p>Start a request from the <strong>Gear Library</strong> using the "Request" button on any available item. Your pending requests will appear here.</p>
                                <button class="btn btn-secondary" onclick="switchEquipmentTab('library')"><i class="fas fa-arrow-left"></i> Go to Gear Library</button>
                            </div>
                            <div id="equipmentRequestList" class="showcases-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- My Rented Equipment Tab -->
                <div id="equipment-rented-tab" class="performance-tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-hand-holding"></i> My Rented Equipment</h3>
                        </div>
                        <div class="card-content">
                            <div id="rentedEquipmentList" class="showcases-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Tracking Tab -->
                <div id="equipment-maintenance-tab" class="performance-tab-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-tools"></i> Maintenance Tracking</h3>
                        </div>
                        <div class="card-content">
                            <div id="maintenanceList" class="showcases-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Events Calendar Section -->
            <div id="calendar-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-calendar-alt"></i> Events & Calendar</h1>
                    <p>Stay updated with company events, training sessions, and meetups</p>
                </div>
                
                <!-- Calendar View -->
                <div class="card calendar-card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar"></i> Upcoming Events</h3>
                        <div class="calendar-controls">
                            <button class="btn btn-secondary" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="currentMonthYear">January 2024</span>
                            <button class="btn btn-secondary" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="calendar-container" id="calendarContainer">
                            <!-- Calendar will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Event List -->
                <div class="card events-list-card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> All Events</h3>
                    </div>
                    <div class="card-content">
                        <div class="events-list" id="eventsList">
                            <!-- Events will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Event Details Modal -->
            <div id="eventDetailsModal" class="modal-overlay" style="display: none;" onclick="closeEventDetails()">
                <div class="event-details-modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2><i class="fas fa-calendar-check"></i> Event Details</h2>
                        <button class="close-btn" onclick="closeEventDetails()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="event-details-grid">
                            <div class="detail-section">
                                <div class="detail-label">
                                    <i class="fas fa-heading"></i>
                                    Title
                                </div>
                                <div class="detail-value" id="eventDetailsTitle">-</div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="detail-label">
                                    <i class="fas fa-calendar"></i>
                                    Date
                                </div>
                                <div class="detail-value" id="eventDetailsDate">-</div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="detail-label">
                                    <i class="fas fa-flag"></i>
                                    Status
                                </div>
                                <div class="detail-value">
                                    <span class="status-badge" id="eventDetailsStatus">-</span>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="detail-label">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Location
                                </div>
                                <div class="detail-value" id="eventDetailsLocation">-</div>
                            </div>
                            
                            <div class="detail-section full-width">
                                <div class="detail-label">
                                    <i class="fas fa-align-left"></i>
                                    Description
                                </div>
                                <div class="detail-value" id="eventDetailsDescription">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeEventDetails()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messaging Section -->
            <div id="messaging-section" class="content-section">
                <div class="dashboard-header">
                    <h1><i class="fas fa-comments"></i> Messages</h1>
                    <p>Communicate with the admin team and other users</p>
                </div>
                
                <!-- Messaging Interface -->
                <div class="messaging-container">
                    <!-- Conversations List -->
                    <div class="conversations-panel">
                        <div class="conversations-header">
                            <h3><i class="fas fa-inbox"></i> Conversations</h3>
                            <button class="btn btn-primary" onclick="startNewConversation()">
                                <i class="fas fa-plus"></i> New Message
                            </button>
                        </div>
                        <div class="conversations-list" id="conversationsList">
                            <!-- Conversations will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Chat Panel -->
                    <div class="chat-panel">
                        <div class="chat-header" id="chatHeader" style="display: none;">
                            <div class="chat-participant-info">
                                <div class="participant-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="participant-details">
                                    <h4 id="chatParticipantName">Admin</h4>
                                    <span id="chatParticipantStatus" class="status-online">Online</span>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button class="btn btn-secondary" onclick="searchMessages()">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-secondary" onclick="toggleChatSettings()">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div class="empty-chat">
                                <i class="fas fa-comments"></i>
                                <h3>Select a conversation</h3>
                                <p>Choose a conversation from the list to start messaging</p>
                            </div>
                        </div>
                        
                        <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                            <div class="chat-input-wrapper">
                                <button class="btn btn-secondary attachment-btn" onclick="toggleAttachmentMenu()">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <div class="attachment-menu" id="attachmentMenu" style="display: none;">
                                    <button onclick="selectFile('image')">
                                        <i class="fas fa-image"></i> Image
                                    </button>
                                    <button onclick="selectFile('document')">
                                        <i class="fas fa-file"></i> Document
                                    </button>
                                </div>
                                <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,.pdf,.doc,.docx">
                                <div class="message-input-container">
                                    <textarea 
                                        id="messageInput" 
                                        placeholder="Type your message..." 
                                        rows="1"
                                        onkeydown="handleMessageKeydown(event)"
                                        oninput="autoResizeTextarea(this)"
                                    ></textarea>
                                    <button class="btn btn-primary send-btn" onclick="communitySendMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="attachments-preview" id="attachmentsPreview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Notification Dropdown (Moved outside containers to avoid stacking context issues) -->
    <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
        <div class="notification-header">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <div class="notification-actions">
                <button onclick="toggleNotificationSettings()" class="settings-btn" title="Notification Settings">
                    <i class="fas fa-cog"></i>
                </button>
            <button onclick="clearAllNotifications()" class="clear-all-btn">
                <i class="fas fa-trash"></i> Clear All
            </button>
        </div>
        </div>
        
        <!-- Notification Settings Panel -->
        <div class="notification-settings-panel" id="notificationSettingsPanel" style="display: none;">
            <h4><i class="fas fa-cog"></i> Notification Settings</h4>
            
            <!-- Push Notifications -->
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="pushNotifications" onchange="togglePushNotifications()">
                    <span class="checkmark"></span>
                    <div class="setting-info">
                        <strong>Push Notifications</strong>
                        <small>Receive notifications even when the page is not active</small>
                    </div>
                </label>
            </div>
            
            <!-- Sound Notifications -->
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="soundNotifications" onchange="toggleSoundNotifications()">
                    <span class="checkmark"></span>
                    <div class="setting-info">
                        <strong>Sound Notifications</strong>
                        <small>Play sound when notifications arrive</small>
                    </div>
                </label>
            </div>
            
            <!-- Quiet Hours -->
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="quietHours" onchange="toggleQuietHours()">
                    <span class="checkmark"></span>
                    <div class="setting-info">
                        <strong>Quiet Hours</strong>
                        <small>Suppress notifications during specified hours</small>
                    </div>
                </label>
                <div class="quiet-hours-controls" id="quietHoursControls" style="display: none;">
                    <div class="time-inputs">
                        <input type="time" id="quietStart" value="22:00" onchange="updateQuietHours()">
                        <span>to</span>
                        <input type="time" id="quietEnd" value="08:00" onchange="updateQuietHours()">
                    </div>
                </div>
            </div>
            
            <!-- Notification Categories -->
            <div class="setting-group">
                <h5>Notification Categories</h5>
                <div class="category-settings">
                    <label class="category-label">
                        <input type="checkbox" id="catPayment" onchange="updateNotificationCategories()">
                        <span class="checkmark"></span>
                        <i class="fas fa-dollar-sign"></i> Payment Updates
                    </label>
                    <label class="category-label">
                        <input type="checkbox" id="catContract" onchange="updateNotificationCategories()">
                        <span class="checkmark"></span>
                        <i class="fas fa-file-contract"></i> Contract Updates
                    </label>
                    <label class="category-label">
                        <input type="checkbox" id="catJob" onchange="updateNotificationCategories()">
                        <span class="checkmark"></span>
                        <i class="fas fa-briefcase"></i> Job Updates
                    </label>
                    <label class="category-label">
                        <input type="checkbox" id="catPerformance" onchange="updateNotificationCategories()">
                        <span class="checkmark"></span>
                        <i class="fas fa-chart-line"></i> Performance Updates
                    </label>
                    <label class="category-label">
                        <input type="checkbox" id="catSystem" onchange="updateNotificationCategories()">
                        <span class="checkmark"></span>
                        <i class="fas fa-cog"></i> System Updates
                    </label>
                </div>
            </div>
            
            <div class="settings-actions">
                <button onclick="saveNotificationSettings()" class="save-settings-btn">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                <button onclick="resetNotificationSettings()" class="reset-settings-btn">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
        
        <div class="notification-list" id="notificationList">
            <div class="no-notifications">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
            </div>
        </div>
    </div>

    <!-- Quantum Neural Network JavaScript -->
    <script>
        // Neural Network Connection Lines
        function createNeuralConnections() {
            const canvas = document.createElement('canvas');
            canvas.id = 'neuralCanvas';
            canvas.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 2;
            `;
            document.querySelector('.neural-background').appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const nodes = document.querySelectorAll('.neural-node');
            const nodePositions = [];
            
            nodes.forEach(node => {
                const rect = node.getBoundingClientRect();
                nodePositions.push({
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2,
                    speed: parseFloat(node.dataset.speed)
                });
            });
            
            function animateConnections() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw connections between nearby nodes
                for (let i = 0; i < nodePositions.length; i++) {
                    for (let j = i + 1; j < nodePositions.length; j++) {
                        const dx = nodePositions[i].x - nodePositions[j].x;
                        const dy = nodePositions[i].y - nodePositions[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 200) {
                            const opacity = Math.max(0, 1 - distance / 200);
                            ctx.strokeStyle = `rgba(0, 255, 255, ${opacity * 0.3})`;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(nodePositions[i].x, nodePositions[i].y);
                            ctx.lineTo(nodePositions[j].x, nodePositions[j].y);
                            ctx.stroke();
                        }
                    }
                }
                
                requestAnimationFrame(animateConnections);
            }
            
            animateConnections();
        }
        
        // Interactive Particle System
        function initParticleSystem() {
            const particles = document.querySelectorAll('.particle');
            
            particles.forEach(particle => {
                particle.addEventListener('mouseenter', () => {
                    particle.style.transform = 'scale(2)';
                    particle.style.boxShadow = '0 0 20px #00ffff';
                });
                
                particle.addEventListener('mouseleave', () => {
                    particle.style.transform = 'scale(1)';
                    particle.style.boxShadow = '0 0 10px #00ffff';
                });
            });
        }
        
        // Quantum Portal Interactions
        function initQuantumPortal() {
            const portal = document.querySelector('.quantum-portal');
            const rings = document.querySelectorAll('.ring');
            
            portal.addEventListener('mousemove', (e) => {
                const rect = portal.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                rings.forEach((ring, index) => {
                    const speed = (index + 1) * 0.5;
                    ring.style.transform = `rotate(${x * speed}deg)`;
                });
            });
            
            // Add hover effects to input fields
            const inputFields = document.querySelectorAll('.input-field');
            inputFields.forEach(field => {
                field.addEventListener('mouseenter', () => {
                    field.style.transform = 'scale(1.02)';
                });
                
                field.addEventListener('mouseleave', () => {
                    field.style.transform = 'scale(1)';
                });
            });
        }
        
        // Initialize all effects when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                createNeuralConnections();
                initParticleSystem();
                initQuantumPortal();
            }, 100);
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('neuralCanvas');
            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
        });
    </script>

    <!-- Lightweight AI neural background (inspired by index2.html) -->
    <script>
        (function initAINeuralBg(){
            const c = document.getElementById('neuralBg');
            if (!c) return;
            const ctx = c.getContext('2d');
            const DPR = Math.min(window.devicePixelRatio || 1, 2);
            let W, H, particles = [], links = [];
            function resize(){
                W = c.width = Math.floor(window.innerWidth * DPR);
                H = c.height = Math.floor(window.innerHeight * DPR);
            }
            function rand(a,b){ return a + Math.random()*(b-a); }
            function setup(){
                particles = []; links = [];
                const count = Math.min(120, Math.floor((W*H)/(14000*DPR)));
                for (let i=0;i<count;i++){
                    particles.push({
                        x: rand(0,W), y: rand(0,H),
                        vx: rand(-0.25,0.25)*DPR, vy: rand(-0.25,0.25)*DPR,
                        r: rand(1,2)*DPR,
                        col: ['rgba(6,182,212,.6)','rgba(20,184,166,.6)','rgba(124,58,237,.6)','rgba(99,102,241,.6)','rgba(255,178,0,.6)'][Math.floor(Math.random()*5)]
                    });
                }
            }
            function step(){
                ctx.fillStyle = 'rgba(2,6,23,0.12)';
                ctx.fillRect(0,0,W,H);
                // links
                const maxD = 140*DPR;
                for (let i=0;i<particles.length;i++){
                    const p = particles[i];
                    p.x += p.vx; p.y += p.vy;
                    if (p.x<0||p.x>W) p.vx*=-1;
                    if (p.y<0||p.y>H) p.vy*=-1;
                    for (let j=i+1;j<particles.length;j++){
                        const q = particles[j];
                        const dx=p.x-q.x, dy=p.y-q.y; const d=Math.hypot(dx,dy);
                        if (d<maxD){
                            const a = (1 - d/maxD) * 0.35;
                            ctx.strokeStyle = `rgba(99,102,241,${a})`;
                            ctx.lineWidth = 1*DPR*a;
                            ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke();
                        }
                    }
                    ctx.fillStyle = p.col;
                    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
                }
                requestAnimationFrame(step);
            }
            function init(){ resize(); setup(); step(); }
            window.addEventListener('resize', ()=>{ resize(); setup(); });
            init();
        })();
    </script>
<style>
    /* AI THEME OVERRIDES (reference: index2.html). Applied non-destructively via .ai-theme */
    .ai-theme {
        /* Override legacy gold palette */
        --primary: #22d3ee;
        --primary-light: #a78bfa;
        --primary-dark: #0891b2;
        --accent: #a78bfa;
        --info: #6366f1;
    }
    /* Buttons */
    .ai-theme .btn {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: #0b1020;
        border: none;
        box-shadow: 0 12px 30px rgba(99,102,241,0.25);
        transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .ai-theme .btn:hover { transform: translateY(-1px) scale(1.01); box-shadow: 0 16px 36px rgba(99,102,241,0.35); }
    .ai-theme .btn-primary { background: linear-gradient(135deg, #22d3ee, #a78bfa); color: #0b1020; }
    .ai-theme .btn-secondary { background: rgba(99,102,241,0.14); color: #c7d2fe; border: 1px solid rgba(99,102,241,0.35); }
    .ai-theme .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
    .ai-theme .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; }
    .ai-theme .btn-small { padding: 0.5rem 1rem; font-size: 0.9rem; }
    /* Replace legacy inline gold styles without touching markup */
    .ai-theme [style*="#FFB200"],
    .ai-theme [style*="#FFD700"],
    .ai-theme [style*="#FF8C00"],
    .ai-theme [style*="#FF6B00"] { color: var(--primary) !important; text-shadow: none !important; }
    /* Borders and left accents */
    .ai-theme [style*="border-color: #FFB200"],
    .ai-theme [style*="border-color:#FFB200"],
    .ai-theme [style*="border-left: 3px solid #FFB200"],
    .ai-theme [style*="border-left:#FFB200"] {
        border-color: rgba(99,102,241,0.35) !important;
        border-left-color: rgba(99,102,241,0.55) !important;
    }
    /* Legacy gold backgrounds and ribbons */
    .ai-theme [style*="rgba(255,178,0"] {
        background: rgba(99,102,241,0.12) !important;
        border-color: rgba(99,102,241,0.30) !important;
        color: #c7d2fe !important;
    }
    /* Linear gradients using old gold palette */
    .ai-theme [style*="linear-gradient"][style*="#FFB200"],
    .ai-theme [style*="linear-gradient"][style*="#FFD700"],
    .ai-theme [style*="linear-gradient"][style*="#FF8C00"],
    .ai-theme [style*="linear-gradient"][style*="#FF6B00"] {
        background: linear-gradient(135deg, #22d3ee, #a78bfa) !important;
        color: #0b1020 !important;
    }
    /* Gold drop-shadows and glow */
    .ai-theme [style*="drop-shadow"][style*="#FFB200"],
    .ai-theme [style*="filter: drop-shadow"][style*="#FFB200"] {
        filter: drop-shadow(0 0 12px rgba(99,102,241,0.35)) !important;
    }
    /* Tone down legacy dark overlays so the AI background is visible */
    .ai-theme [style*="background: rgba(0, 0, 0"] { background: rgba(15,23,42,0.45) !important; }
    /* Accents previously using gold badges */
    .ai-theme .status-icon,
    .ai-theme .rating-number { color: var(--primary) !important; }
    /* Inputs focus border */
    .ai-theme input:focus, .ai-theme textarea:focus, .ai-theme select:focus {
        border-color: var(--info) !important; box-shadow: 0 0 0 2px rgba(99,102,241,0.25) !important;
    }
    /* Overlapping decorative corner badges on cards â†’ neutralize */
    .ai-theme .card [class*="corner"],
    .ai-theme .timeline-card [class*="corner"],
    .ai-theme .timeline-card [class*="badge"] {
        position: static !important;
    }

    /* ===== AI THEME HARD RESET & REBRAND (visual only; no JS changed) ===== */
    /* Ensure the main containers are always visible above decorative layers */
    .ai-theme html, .ai-theme body, .ai-theme #loginScreen, .ai-theme #userPortal {
        opacity: 1 !important;
        visibility: visible !important;
    }
    .ai-theme #loginScreen, .ai-theme #userPortal {
        position: relative;
        z-index: 10;
    }
    /* Push canvases/overlays behind content */
    .ai-theme canvas,
    .ai-theme [class*="overlay"],
    .ai-theme [class*="bg"],
    .ai-theme [style*="position: absolute"][style*="z-index: 1000"] {
        z-index: 0 !important;
    }
    /* Global typography and background */
    .ai-theme body {
        background: radial-gradient(1200px 800px at 10% 10%, rgba(34,211,238,0.08), transparent 40%),
                    radial-gradient(900px 700px at 90% 20%, rgba(167,139,250,0.10), transparent 45%),
                    linear-gradient(180deg, #0b1020 0%, #0a0f1e 100%);
        color: #e5e7eb;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    .ai-theme h1, .ai-theme h2, .ai-theme h3, .ai-theme h4 { color: #e6eaff; letter-spacing: 0.2px; }
    .ai-theme h1 { font-size: 2rem; font-weight: 800; }
    .ai-theme h2 { font-size: 1.5rem; font-weight: 700; }
    .ai-theme h3 { font-size: 1.125rem; font-weight: 700; }
    .ai-theme h4 { font-size: 1rem; font-weight: 700; }

    /* Card system */
    .ai-theme .card, .ai-theme .job-card, .ai-theme .profile-card, .ai-theme .payment-card, .ai-theme .timeline-card {
        background: rgba(17, 24, 39, 0.65) !important;
        border: 1px solid rgba(99,102,241,0.25) !important;
        border-radius: 16px !important;
        box-shadow: 0 12px 40px rgba(0,0,0,0.35), 0 0 0 1px rgba(99,102,241,0.10) inset !important;
        backdrop-filter: blur(10px) !important;
    }
    .ai-theme .card-header, .ai-theme .job-header, .ai-theme .timeline-header {
        background: linear-gradient(180deg, rgba(99,102,241,0.16), rgba(0,0,0,0)) !important;
        border-bottom: 1px solid rgba(99,102,241,0.25) !important;
    }
    .ai-theme .status-badge, .ai-theme .payment-status {
        background: rgba(99,102,241,0.16) !important;
        color: #c7d2fe !important;
        border: 1px solid rgba(99,102,241,0.35) !important;
        border-radius: 999px !important;
        padding: .25rem .6rem !important;
        font-weight: 700 !important;
    }

    /* Timeline progress */
    .ai-theme .progress-bar { background: rgba(99,102,241,0.18) !important; }
    .ai-theme .progress-fill { background: linear-gradient(90deg, #22d3ee, #a78bfa) !important; }

    /* Forms */
    .ai-theme input, .ai-theme select, .ai-theme textarea {
        background: rgba(17, 24, 39, 0.75) !important;
        border: 1px solid rgba(99,102,241,0.25) !important;
        color: #e5e7eb !important;
        border-radius: 10px !important;
    }
    .ai-theme input::placeholder, .ai-theme textarea::placeholder { color: rgba(226,232,240,0.45) !important; }

    /* Links and subtle accents */
    .ai-theme a { color: #22d3ee; }
    .ai-theme a:hover { color: #a78bfa; }

    /* Modal surfaces */
    .ai-theme .modal, .ai-theme [role="dialog"], .ai-theme .job-details-modal {
        background: rgba(17, 24, 39, 0.88) !important;
        border: 1px solid rgba(99,102,241,0.30) !important;
        border-radius: 16px !important;
    }

    /* Utility: neutralize extreme opacity/pointer-events from legacy theme for core containers */
    .ai-theme #userPortal *, .ai-theme #loginScreen * {
        visibility: visible !important;
    }
    .ai-theme #userPortal, .ai-theme #loginScreen {
        pointer-events: auto !important;
    }

    /* ===== Login Card: Proportional horizontal rectangle + centered layout ===== */
    .ai-theme #loginScreen {
        display: grid !important;
        place-items: center !important;
        min-height: 100vh !important;
        padding: 4vh 4vw !important;
    }
    .ai-theme .login-container,
    .ai-theme #loginScreen .login-container {
        width: min(920px, 92vw) !important;
        min-height: 420px !important;
        padding: 48px !important;
        border-radius: 20px !important;
        background: rgba(17,24,39,0.78) !important;
        border: 1px solid rgba(99,102,241,0.28) !important;
        box-shadow: 0 30px 80px rgba(0,0,0,0.45), 0 0 0 1px rgba(99,102,241,0.10) inset !important;
        display: grid !important;
        grid-template-columns: 1.2fr 1fr !important;
        gap: 36px !important;
        align-items: center !important;
    }
    /* Left content (title/description) */
    .ai-theme #loginScreen .login-meta {
        color: #eaf0ff !important;
    }
    .ai-theme #loginScreen .login-meta h1 { font-size: 2.2rem !important; margin: 0 0 .5rem 0 !important; }
    .ai-theme #loginScreen .login-meta p { opacity: .85 !important; }

    /* Right column form */
    .ai-theme #loginScreen form.login-form {
        background: rgba(12, 18, 32, 0.55) !important;
        border: 1px solid rgba(99,102,241,0.25) !important;
        border-radius: 14px !important;
        padding: 24px !important;
    }
    .ai-theme #loginScreen .form-group label { color: #c7d2fe !important; }
    .ai-theme #loginScreen .form-group input { height: 48px !important; }
    .ai-theme #loginScreen .login-btn {
        height: 48px !important;
        border-radius: 10px !important;
        background: linear-gradient(135deg, #22d3ee, #a78bfa) !important;
        color: #0b1020 !important;
        font-weight: 800 !important;
    }
</style>
<script>
    // Enable AI theme
    (function(){
        if (!document.documentElement.classList.contains('ai-theme')) {
            document.documentElement.classList.add('ai-theme');
        }
        if (!document.body.classList.contains('ai-theme')) {
            document.body.classList.add('ai-theme');
        }
    })();
    // Ensure late-inserted elements with inline gold styles are visually harmonized
    new MutationObserver(() => {
        document.documentElement.classList.add('ai-theme');
        document.body.classList.add('ai-theme');
    }).observe(document.documentElement, { childList: true, subtree: true });

    // ==================== MESSAGING SYSTEM FUNCTIONS ====================
    let currentConversationId = null;
    let messagingService = null;
    let selectedFiles = [];

    // Initialize messaging when section is shown
    async function initializeMessaging() {
        if (!messagingService) {
            messagingService = new MessagingService();
        }
        // wait for service readiness and attach live listener so the left panel fills without clicking
        try { await messagingService.readyPromise; } catch(_) {}
        // initial load
        await loadConversations();
        // realtime conversations panel
        try {
            messagingService.listenToConversations((list) => {
                const conversationsList = document.getElementById('conversationsList');
                if (!conversationsList) return;
                if (!Array.isArray(list) || list.length === 0) {
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Use the New Message button to start a conversation</p>
                        </div>
                    `;
                    return;
                }
                conversationsList.innerHTML = list.map(conv => `
                    <div class=\"conversation-item\" data-conversation-id=\"${conv.id}\" onclick=\"selectConversation('${conv.id}', event)\">
                        <div class=\"conversation-header\">
                            <span class=\"conversation-participant\">${getParticipantName(conv)}</span>
                            <span class=\"conversation-time\">${messagingService.formatTimestamp(conv.lastMessageTime)}</span>
                        </div>
                        <div class=\"conversation-preview\">${conv.lastMessage || 'No messages yet'}</div>
                        <div class=\"conversation-meta\">
                            ${conv.jobId ? `<span class=\\\"conversation-job\\\">Job: ${conv.jobId}</span>` : ''}
                            ${conv.unreadCount > 0 ? `<span class=\\\"unread-badge\\\">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            });
        } catch(e) { console.error('âŒ Conversations listener failed:', e); }
    }

    // Load conversations for the current user
    async function loadConversations() {
        try {
            if (!messagingService) return;
            
            const conversations = await messagingService.loadUserConversations() || [];
            const conversationsList = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>No conversations yet</h3>
                        <p>Use the New Message button to start a conversation</p>
                    </div>
                `;
                return;
            }

            conversationsList.innerHTML = conversations.map(conv => `
                <div class="conversation-item" data-conversation-id="${conv.id}" onclick="selectConversation('${conv.id}', event)">
                    <div class="conversation-header">
                        <span class="conversation-participant">${getParticipantName(conv)}</span>
                        <span class="conversation-time">${messagingService.formatTimestamp(conv.lastMessageTime)}</span>
                    </div>
                    <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                    <div class="conversation-meta">
                        ${conv.jobId ? `<span class="conversation-job">Job: ${conv.jobId}</span>` : ''}
                        ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                    </div>
                </div>
            `).join('');

            // Update message badge
            updateMessageBadge(conversations);

        } catch (error) {
            console.error('âŒ Failed to load conversations:', error);
        }
    }

    // Get participant name for display
    function getParticipantName(conversation) {
        const currentUserEmail = messagingService?.currentUser?.email;
        if (!currentUserEmail) return 'Unknown';
        
        const otherParticipants = conversation.participants.filter(email => email !== currentUserEmail);
        if (otherParticipants.length === 0) return 'You';
        
        // Check if it's an admin
        if (otherParticipants.length === 1 && String(otherParticipants[0]).toLowerCase() === 'broadcasts') {
            return 'Creator Broadcast';
        }
        const adminEmails = window.FirebaseConfig?.getAdminUsers() || [];
        if (otherParticipants.some(email => adminEmails.includes(email))) {
            return 'Admin Team';
        }
        
        return otherParticipants[0].split('@')[0]; // Show username part
    }

    // Update message badge in sidebar
    function updateMessageBadge(conversations) {
        const badge = document.getElementById('messageBadge');
        const totalUnread = conversations.reduce((sum, conv) => sum + conv.unreadCount, 0);
        
        if (totalUnread > 0) {
            badge.textContent = totalUnread;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    // Select a conversation
    async function selectConversation(conversationId, ev) {
        try {
            if (!messagingService) { messagingService = new MessagingService(); try { await messagingService.readyPromise; } catch(_) {} }
            currentConversationId = conversationId;
            
            // Update UI
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            if (ev && ev.currentTarget) {
                ev.currentTarget.classList.add('active');
            } else {
                const el = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
                if (el) el.classList.add('active');
            }
            
            // Show chat panel
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatInputContainer').style.display = 'block';
            
            // Load messages
            await loadMessages(conversationId);
            
            // Set up real-time listener
            messagingService.listenToMessages(conversationId, (messages) => {
                displayMessages(messages);
            });
            
        } catch (error) {
            console.error('âŒ Failed to select conversation:', error);
        }
    }

    // Load messages for a conversation
    async function loadMessages(conversationId) {
        try {
            if (!messagingService) { messagingService = new MessagingService(); try { await messagingService.readyPromise; } catch(_) {} }
            const messages = await messagingService.loadMessages(conversationId);
            displayMessages(messages);
        } catch (error) {
            console.error('âŒ Failed to load messages:', error);
        }
    }

    // Display messages in the chat
    function displayMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');
        const currentUserEmail = messagingService?.currentUser?.email;
        // Determine if the selected conversation is the broadcast thread
        let isBroadcastThread = false;
        try {
            const meta = messagingService && messagingService.conversations && messagingService.conversations.get
                ? messagingService.conversations.get(currentConversationId)
                : null;
            isBroadcastThread = !!(meta && Array.isArray(meta.participants) && meta.participants.some(e => String(e).toLowerCase() === 'broadcasts'));
        } catch(_) {}
        
        if (messages.length === 0) {
            chatMessages.innerHTML = `
                <div class="empty-chat">
                    <i class="fas fa-comments"></i>
                    <h3>No messages yet</h3>
                    <p>Start the conversation by sending a message</p>
                </div>
            `;
            return;
        }

        chatMessages.innerHTML = messages.map(message => {
            const isSent = message.senderId === currentUserEmail;
            const timestamp = messagingService.formatTimestamp(message.timestamp);
            
            return `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${isSent ? 'You' : getParticipantName({participants: [message.senderId]})}</span>
                            <span class="message-time">${timestamp}</span>
                        </div>
                        <div class="message-text">${message.content}</div>
                        ${message.attachments && message.attachments.length > 0 ? `
                            <div class="message-attachments">
                                ${message.attachments.map(attachment => `
                                    <div class="attachment-item">
                                        ${attachment.type && attachment.type.startsWith('image/') ? 
                                            `<img src="${attachment.url}" alt="${attachment.name}" onclick="openImageModal('${attachment.url}')">` :
                                            `<a href="${attachment.url}" target="_blank">${attachment.name}</a>`
                                        }
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${isSent ? `
                            <div class="message-status">
                                <span class="status-${message.status || 'sent'}">
                                    ${message.status === 'read' ? 'âœ“âœ“' : message.status === 'delivered' ? 'âœ“' : 'â—‹'}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    ${isSent && !isBroadcastThread ? `<button class="btn btn-secondary" style="margin-top:6px" onclick="deleteUserMessage('${message.id}')">Delete</button>` : ''}
                </div>
            `;
        }).join('');

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Delete (archive) a single message authored by current user
    async function deleteUserMessage(messageId) {
        try {
            if (!currentConversationId || !messagingService) return;
            const msgs = await messagingService.loadMessages(currentConversationId, 50);
            const target = (msgs || []).find(m => m.id === messageId);
            if (!target) return;
            await messagingService.archiveAndDeleteMessage(currentConversationId, target);
            await loadMessages(currentConversationId);
            loadConversations();
        } catch (e) {
            console.error('âŒ deleteUserMessage failed:', e);
            alert('Could not delete message.');
        }
    }

    // Start a new conversation (inline recipient picker)
    async function startNewConversation() {
        try {
            if (!messagingService) {
                messagingService = new MessagingService();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            const panelHost = document.querySelector('.conversations-panel');
            if (!panelHost) return;
            const existing = panelHost.querySelector('[data-portal-picker]');
            if (existing) existing.remove();
            const wrapper = document.createElement('div');
            wrapper.setAttribute('data-portal-picker','');
            wrapper.style.position = 'absolute';
            wrapper.style.left = '16px';
            wrapper.style.top = '72px';
            wrapper.style.width = '340px';
            wrapper.style.maxHeight = '420px';
            wrapper.style.overflow = 'auto';
            wrapper.style.background = 'rgba(17,24,39,0.92)';
            wrapper.style.border = '1px solid rgba(99,102,241,0.30)';
            wrapper.style.borderRadius = '14px';
            wrapper.style.boxShadow = '0 30px 80px rgba(0,0,0,0.45), 0 0 0 1px rgba(99,102,241,0.10) inset';
            wrapper.style.zIndex = '12000';
            wrapper.style.padding = '12px';
            wrapper.innerHTML = `
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <input id="portalPickerSearch" placeholder="Search users" style="flex:1; height:40px; border-radius:12px; border:1px solid rgba(99,102,241,.25); background:rgba(12,18,32,.65); color:#e5e7eb; padding:0 12px;" />
                    <button class="btn btn-secondary" onclick="this.closest('[data-portal-picker]').remove()">Close</button>
                </div>
                <div id="portalPickerList"></div>
            `;
            panelHost.appendChild(wrapper);

            const usersMap = await (window.FirestoreDataManager && window.FirestoreDataManager.getUsers ? window.FirestoreDataManager.getUsers() : {});
            const admins = window.FirebaseConfig?.getAdminUsers() || [];
            const current = messagingService?.currentUser?.email || '';
            const listEl = wrapper.querySelector('#portalPickerList');
            const makeRow = (name, email) => `<div class="up-item" style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer;" data-email="${email}" onclick="pickPortalRecipient('${email.replace(/'/g,"&#39;")}')"><div class="up-avatar" style="width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#22d3ee,#a78bfa);color:#0b1020;font-weight:800;font-size:.85rem;">${(name||email).slice(0,2).toUpperCase()}</div><div class="up-meta"><div class="name" style="color:#eef2ff;font-weight:700;font-size:.92rem;">${name||email}</div><div class="email" style="color:#c7d2fe;opacity:.85;font-size:.82rem;">${email}</div></div></div>`;
            let html = makeRow('Admin Team', admins[0] || 'info@cochranfilms.com');
            Object.values(usersMap || {}).forEach(u => {
                const email = u?.profile?.email;
                if (!email || email === current) return;
                html += makeRow(u?.profile?.fullName || u?.profile?.name || email.split('@')[0], email);
            });
            listEl.innerHTML = html;
            const search = wrapper.querySelector('#portalPickerSearch');
            search.addEventListener('input', () => {
                const q = search.value.toLowerCase();
                Array.from(listEl.children).forEach(child => {
                    const name = (child.querySelector('.name')?.textContent||'').toLowerCase();
                    const email = (child.querySelector('.email')?.textContent||'').toLowerCase();
                    child.style.display = (!q || name.includes(q) || email.includes(q)) ? 'flex' : 'none';
                });
            });
        } catch (error) {
            console.error('âŒ Failed to open recipient picker:', error);
            alert('Failed to open recipient picker.');
        }
    }

    window.pickPortalRecipient = async function(email){
        try {
            if (!messagingService) { messagingService = new MessagingService(); await new Promise(r=>setTimeout(r,300)); }
            const admins = window.FirebaseConfig?.getAdminUsers() || [];
            const conversationId = admins.includes(email) ? await messagingService.getOrCreateAdminConversation() : await messagingService.getOrCreateDirectConversation(email);
            const wrapper = document.querySelector('[data-portal-picker]'); if (wrapper) wrapper.remove();
            await selectConversation(conversationId);
            document.getElementById('messageInput').focus();
        } catch (e) { console.error(e); alert('Could not start conversation.'); }
    }

    // Send a message
    async function sendMessage() {
        try {
            if (!messagingService) { messagingService = new MessagingService(); try { await messagingService.readyPromise; } catch(_) {} }
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content && selectedFiles.length === 0) return;
            // Ensure a conversation exists/selected
            if (!currentConversationId) {
                const conversationId = await messagingService.getOrCreateAdminConversation();
                await selectConversation(conversationId);
            }
            
            // Upload attachments if any
            let attachments = [];
            if (selectedFiles.length > 0) {
                for (const file of selectedFiles) {
                    const attachment = await messagingService.uploadAttachment(currentConversationId, 'temp', file);
                    attachments.push(attachment);
                }
                selectedFiles = [];
                updateAttachmentsPreview();
            }
            
            // Send message
            const sentId = await messagingService.sendMessage(currentConversationId, content, attachments);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Optimistically refresh messages and conversation list
            await loadMessages(currentConversationId);
            loadConversations();
            
        } catch (error) {
            console.error('âŒ Failed to send message:', error);
            alert('Failed to send message. Please try again.');
        }
    }

    // Handle message input keydown
    function handleMessageKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            communitySendMessage();
        }
    }

    // Auto-resize textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Toggle attachment menu
    function toggleAttachmentMenu() {
        const menu = document.getElementById('attachmentMenu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    // Select file for attachment
    function selectFile(type) {
        const fileInput = document.getElementById('fileInput');
        fileInput.accept = type === 'image' ? 'image/*' : '.pdf,.doc,.docx,.txt';
        fileInput.click();
        
        fileInput.onchange = function(event) {
            const files = Array.from(event.target.files);
            selectedFiles = [...selectedFiles, ...files];
            updateAttachmentsPreview();
            toggleAttachmentMenu();
        };
    }

    // Update attachments preview
    function updateAttachmentsPreview() {
        const preview = document.getElementById('attachmentsPreview');
        
        if (selectedFiles.length === 0) {
            preview.innerHTML = '';
            return;
        }
        
        preview.innerHTML = selectedFiles.map((file, index) => `
            <div class="attachment-preview">
                ${file.type.startsWith('image/') ? 
                    `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` :
                    `<i class="fas fa-file"></i>`
                }
                <span>${file.name}</span>
                <button onclick="removeAttachment(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    // Remove attachment
    function removeAttachment(index) {
        selectedFiles.splice(index, 1);
        updateAttachmentsPreview();
    }

    // Search messages
    function searchMessages() {
        const query = prompt('Search messages:');
        if (query) {
            // Implement search functionality
            console.log('Searching for:', query);
        }
    }

    // Toggle chat settings
    function toggleChatSettings() {
        // Implement chat settings
        console.log('Toggle chat settings');
    }

    // Open image modal
    function openImageModal(imageUrl) {
        // Implement image modal
        window.open(imageUrl, '_blank');
    }

    // Override showSection to initialize messaging
    const originalShowSection = showSection;
    showSection = function(sectionName) {
        originalShowSection(sectionName);
        if (sectionName === 'messaging') {
            initializeMessaging();
        }
    };
</script>
</body>
</html>